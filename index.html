<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20rx%3D%226%22%20fill%3D%22%231d4ed8%22%2F%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%2211%22%20fill%3D%22%23ffffff%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%221%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%227.5%22%20x2%3D%2216%22%20y2%3D%225.5%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%222.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2224.5%22%20y1%3D%2216%22%20x2%3D%2226.5%22%20y2%3D%2216%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2224.5%22%20x2%3D%2216%22%20y2%3D%2226.5%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%227.5%22%20y1%3D%2216%22%20x2%3D%225.5%22%20y2%3D%2216%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2216%22%20x2%3D%2211.2%22%20y2%3D%2213.2%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%222.4%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2216%22%20x2%3D%2222.9%22%20y2%3D%2212.0%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%221.8%22%20stroke-linecap%3D%22round%22%2F%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%221.8%22%20fill%3D%22%231e3a8a%22%2F%3E%3C%2Fsvg%3E">
<title>SixMinuteLog.com</title>
<style>
:root{
  --bg:#f8fafc;--white:#fff;--border:#e2e8f0;--border-l:#f1f5f9;
  --ink:#0f172a;--ink2:#475569;--ink3:#94a3b8;
  --green:#16a34a;--blue:#2563eb;--red:#dc2626;--amber:#d97706;--purple:#7c3aed;
  --r:10px;--sh:0 1px 3px rgba(0,0,0,.1);--sh-lg:0 10px 30px rgba(0,0,0,.18);
  /* Layout sizing */
  --space-sm:14px;--space-md:20px;--space-lg:24px;
  --card-pad:18px;--fbox-pad:22px;--field-pad:9px 13px;
  /* Shorthand aliases */
  --brd:#e2e8f0;--bg2:#f1f5f9;--blue-pale:#eff6ff;
}

/* == Dark Mode == */
body.dark{
  --bg:#0f172a;--white:#1e293b;--border:#334155;--border-l:#1e293b;
  --ink:#f1f5f9;--ink2:#94a3b8;--ink3:#475569;
  --green:#22c55e;--blue:#3b82f6;--red:#ef4444;--amber:#f59e0b;--purple:#a78bfa;
  --sh:0 1px 3px rgba(0,0,0,.4);--sh-lg:0 10px 30px rgba(0,0,0,.6);
  --brd:#334155;--bg2:#1e293b;--blue-pale:#172554;
}
body.dark .header{background:#1e293b}
body.dark .fbox{background:#1e2d40}
body.dark .fl input,body.dark .fl select,body.dark .fl textarea{background:#0f172a;color:var(--ink)}
body.dark .fl input.err,body.dark .fl select.err{background:#300}
body.dark .btn-gh{background:var(--white);color:var(--ink)}
body.dark .btn-gh:hover{background:#2d3f55}
body.dark .btn-ic{background:#263347;color:var(--ink);border-color:#3d5068}
body.dark .btn-ic:hover{background:#2d3f55}
body.dark .btn-dk{background:#3b82f6;color:#fff;border-color:#3b82f6}
body.dark .btn-dk:hover{background:#2563eb;border-color:#2563eb}
body.dark .btn-gr{background:#16a34a;color:#fff;border-color:#16a34a}
body.dark .btn-rd{background:#dc2626;color:#fff;border-color:#dc2626}
body.dark #fab{background:#3b82f6;color:#fff}
body.dark .sc{background:var(--white)}
body.dark .twrap{background:var(--white)}
body.dark thead tr{background:#162032}
body.dark tr:hover td{background:#1a2b3f}
body.dark .card{background:var(--white)}
body.dark .preset-btn{background:var(--white)}
body.dark .crow{background:var(--white)}
body.dark .up-box{background:#1e293b}
body.dark .exp-name-preview{background:#162032;color:var(--blue);border-color:#2563eb44}
body.dark .danger{background:#300a0a;border-color:#7f1d1d}
body.dark .note{background:#422006;border-color:#78350f;color:#fcd34d}
body.dark .good{background:#052e16;border-color:#14532d;color:#4ade80}
body.dark .role-notice{background:#1e2d4f;border-color:#2563eb44;color:#93c5fd}
body.dark .total-pill{background:#052e16;border-color:#14532d;color:#4ade80}
body.dark .appr-panel{background:var(--white)}
body.dark .help-body{color:var(--ink)}
body.dark .help-nav button{color:var(--ink2)}
body.dark .help-nav button.on{background:#162032;color:var(--ink)}
body.dark #loading{background:#0f172a;color:var(--ink2)}
body.dark .desc-chip{background:#162032;border-color:#334155;color:var(--ink2)}
body.dark .desc-chip:hover{background:#1e3a5f;color:var(--ink)}
body.dark .mail-preset-card{background:var(--white);border-color:var(--border)}
body.dark select{background:#1e293b;color:var(--ink);border-color:var(--border)}
body.dark .fab-tog{background:#334155}

/* == Layout Sizes == */
body.layout-compact{--space-sm:10px;--space-md:14px;--space-lg:16px;--card-pad:12px;--fbox-pad:16px;--field-pad:7px 11px;font-size:13px}
body.layout-compact .main{padding:16px 14px}
body.layout-compact .card{padding:var(--card-pad)}
body.layout-compact .fbox{padding:var(--fbox-pad)}
body.layout-compact .fl input,.layout-compact .fl select,.layout-compact .fl textarea{padding:var(--field-pad);font-size:12px}
body.layout-compact th,body.layout-compact td{padding:7px 10px;font-size:12px}
body.layout-compact .btn{padding:7px 12px;font-size:12px}
body.layout-compact .sc{padding:10px 14px}
body.layout-compact .sc-val{font-size:1.2rem}
body.layout-compact .srow{gap:8px;margin-bottom:14px}
body.layout-compact .modal-bd{padding:16px 18px}

body.layout-spacious{--space-sm:18px;--space-md:28px;--space-lg:32px;--card-pad:26px;--fbox-pad:30px;--field-pad:12px 16px;font-size:15px}
body.layout-spacious .main{padding:32px 28px}
body.layout-spacious .card{padding:var(--card-pad)}
body.layout-spacious .fbox{padding:var(--fbox-pad)}
body.layout-spacious .fl input,.layout-spacious .fl select,.layout-spacious .fl textarea{padding:var(--field-pad);font-size:14px}
body.layout-spacious th,body.layout-spacious td{padding:13px 18px;font-size:14px}
body.layout-spacious .btn{padding:11px 20px;font-size:14px}
body.layout-spacious .sc{padding:18px 24px}
body.layout-spacious .sc-val{font-size:1.6rem}
body.layout-spacious .srow{gap:16px;margin-bottom:26px}

/* == Rate History Tables == */
.rate-hist-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
.rate-hist-table th{text-align:left;padding:5px 8px;background:var(--bg2);color:var(--ink3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.04em}
.rate-hist-table td{padding:6px 8px;border-bottom:1px solid var(--border-l);vertical-align:middle}
.rate-hist-table tr:last-child td{border-bottom:none}
.rate-hist-table input[type=date],.rate-hist-table input[type=number],.rate-hist-table input[type=text]{padding:4px 7px;border:1px solid var(--border);border-radius:5px;font-size:12px;background:var(--white);color:var(--ink);width:100%}
.rate-hist-add{display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:6px;align-items:end;margin-top:8px}
.rate-hist-add select{padding:4px 7px;border:1px solid var(--border);border-radius:5px;font-size:12px;background:var(--white);color:var(--ink)}
.rate-section-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.rate-section-hd h4{font-size:12px;font-weight:600;color:var(--ink2);margin:0}
.rate-section-hd small{font-size:11px;color:var(--ink3)}
.rate-cur-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(22,163,74,.1);color:var(--green);border:1px solid rgba(22,163,74,.25)}
body.dark .rate-hist-table th{background:var(--bg2)}
body.dark .rate-hist-table input[type=date],body.dark .rate-hist-table input[type=number],body.dark .rate-hist-table input[type=text]{background:#0f172a;color:var(--ink)}

.desc-chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:7px;margin-bottom:2px}
.desc-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:#f1f5f9;border:1px solid var(--border);border-radius:16px;font-size:11px;color:var(--ink2);cursor:pointer;transition:all .15s}
.desc-chip:hover{background:#e2e8f0;color:var(--ink);border-color:var(--ink3)}
.desc-chip svg{opacity:.6}

/* == Mail Preset Cards == */
.mail-preset-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;position:relative}
.mail-preset-card h4{font-size:13px;font-weight:500;margin-bottom:6px;color:var(--ink)}
.mail-preset-card p{font-size:11px;color:var(--ink3);margin-bottom:2px}
.mail-preset-card .mp-acts{position:absolute;top:10px;right:10px;display:flex;gap:4px}

/* == Preset List Items == */
.preset-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:7px;font-size:13px}
.preset-item span{flex:1;color:var(--ink)}
.preset-item button{padding:4px 6px;border:none;background:transparent;color:var(--ink3);border-radius:4px;cursor:pointer}
.preset-item button:hover{color:var(--red);background:#fef2f2}

/* == Settings Tab Nav == */
.set-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg);padding:4px;border-radius:10px;flex-wrap:wrap}
.set-tab{padding:7px 14px;border:none;background:transparent;border-radius:7px;font-size:12px;font-weight:500;color:var(--ink3);cursor:pointer;transition:all .15s;white-space:nowrap}
.set-tab:hover{color:var(--ink)}
.set-tab.on{background:var(--white);color:var(--ink);box-shadow:var(--sh)}
body.dark .set-tabs{background:#162032}
body.dark .set-tab.on{background:#1e293b}
body.dark .avatar-dark{background:#3b82f6;color:#fff;font-size:1rem}
body.dark .nav-btn{color:var(--ink3)}
body.dark .nav-btn:hover{color:var(--ink)}
body.dark .nav-btn.on{color:var(--ink);border-bottom-color:var(--blue)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--ink);font-size:14px}
input,select,textarea,button{font-family:inherit;font-size:14px}
button{cursor:pointer}

/* Layout */
.header{background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.header-inner{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:8px}
.logo h1{font-size:1.15rem;font-weight:300;color:var(--ink)}
.logo-sub{font-size:11px;color:var(--ink3);margin-top:1px}
.header-btns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.nav{max-width:1200px;margin:0 auto;padding:0 12px;overflow-x:auto;display:flex}
.nav::-webkit-scrollbar{display:none}
.nav-btn{display:flex;align-items:center;gap:6px;padding:10px 14px;border:none;background:transparent;color:var(--ink3);border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;font-size:13px;transition:all .15s}
.nav-btn:hover{color:var(--ink)}.nav-btn.on{color:var(--ink);border-bottom-color:var(--ink);font-weight:500}
.main{max-width:1200px;margin:0 auto;padding:24px 20px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 16px;border-radius:8px;border:1px solid transparent;font-size:13px;font-weight:400;transition:opacity .15s,transform .1s;white-space:nowrap}
.btn:active{transform:scale(.98)}
.btn-dk{background:var(--ink);color:#fff;border-color:var(--ink)}.btn-dk:hover{opacity:.85}
.btn-gr{background:var(--green);color:#fff;border-color:var(--green)}.btn-gr:hover{opacity:.85}
.btn-bl{background:var(--blue);color:#fff;border-color:var(--blue)}.btn-bl:hover{opacity:.85}
.btn-rd{background:var(--red);color:#fff;border-color:var(--red)}.btn-rd:hover{opacity:.85}
.btn-gh{background:var(--white);color:var(--ink2);border-color:var(--border)}.btn-gh:hover{background:var(--bg)}
.btn-ic{padding:8px;border-radius:8px;background:var(--white);border:1px solid var(--border);color:var(--ink2)}.btn-ic:hover{background:var(--bg)}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* Forms */
.fbox{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:18px}
.fbox h3{font-weight:400;font-size:1rem;margin-bottom:18px;color:var(--ink)}
.frow{display:grid;gap:14px;margin-bottom:14px}
.frow.c2{grid-template-columns:1fr 1fr}
.frow.c3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:580px){.frow.c2,.frow.c3{grid-template-columns:1fr}}
.fl label{display:block;font-size:12px;color:var(--ink2);margin-bottom:5px}
.fl label .req{color:var(--red);margin-left:2px}
.fl input,.fl select,.fl textarea{width:100%;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink);outline:none;transition:border .15s}
.fl input:focus,.fl select:focus,.fl textarea:focus{border-color:#94a3b8}
.fl input.err,.fl select.err{border-color:var(--red);background:#fef2f2}
.fl .hint{font-size:11px;color:var(--ink3);margin-top:4px}
.fl .emsg{font-size:11px;color:var(--red);margin-top:4px}
.fl .pw{position:relative}
.fl .pw .pfx{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--ink3);pointer-events:none}
.fl .pw .sfx{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--ink3);pointer-events:none;font-size:12px}
.fl .pw input{padding-left:26px}
.fl .pw input.has-sfx{padding-right:32px}
.fa{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}

/* Cards */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px}
.card-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.avatar{width:42px;height:42px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:1.1rem;border:1px solid var(--border)}
.card-act button{padding:5px;border:none;background:transparent;color:var(--ink3);border-radius:5px}
.card-act button:hover{color:var(--ink);background:var(--bg)}
.card h3{font-weight:500;font-size:.93rem;margin-bottom:3px}
.card p{font-size:12px;color:var(--ink2);margin-bottom:2px;line-height:1.5}
.card-rate{margin-top:10px;padding-top:10px;border-top:1px solid var(--border-l);font-size:12px;color:var(--ink3)}
.card-rate strong{color:var(--ink)}
.chip{display:inline-block;font-size:11px;background:var(--bg);color:var(--ink2);padding:3px 9px;border-radius:20px;border:1px solid var(--border);margin-bottom:8px}
.split-pill{display:inline-flex;gap:5px;font-size:11px;margin-top:6px}
.split-pill .own{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0;padding:2px 8px;border-radius:12px}
.split-pill .firm{background:#fef3c7;color:#92400e;border:1px solid #fde68a;padding:2px 8px;border-radius:12px}

/* Roles & Approval Status */
.status-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:12px;font-size:11px;font-weight:500;white-space:nowrap}
.s-pending{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
.s-approved{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0}
.s-review{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
.s-neutral{background:var(--bg);color:var(--ink3);border:1px solid var(--border)}
.s-rejected{background:#fef2f2;color:#dc2626;border:1px solid #fee2e2}
.role-lbl{display:inline-flex;align-items:center;font-size:11px;padding:2px 9px;border-radius:12px;font-weight:500;border:1px solid}
.rl-partner{background:#f5f3ff;color:#6d28d9;border-color:#ddd6fe}
.rl-attorney{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
.rl-billing{background:#f0fdf4;color:#166534;border-color:#bbf7d0}
.appr-panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:18px}
.appr-panel h3{font-weight:500;font-size:.93rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.role-notice{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:#1e40af;display:flex;align-items:center;gap:10px}

/* Stats */
.srow{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px}
.sc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 18px}
.sc-lbl{font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
.sc-val{font-size:1.4rem;font-weight:300;color:var(--ink)}
.sc.highlight{border-color:#bbf7d0;background:#f0fdf4}.sc.highlight .sc-val{color:#166534}
.sc.highlight2{border-color:#fde68a;background:#fffbeb}.sc.highlight2 .sc-val{color:#92400e}

/* Table */
.twrap{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.tscroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{background:var(--bg);border-bottom:1px solid var(--border)}
th{padding:9px 13px;text-align:left;font-weight:500;color:var(--ink2);font-size:11px;white-space:nowrap;text-transform:uppercase;letter-spacing:.03em}
td{padding:9px 13px;border-bottom:1px solid var(--border-l);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#fafafa}
.tda{display:flex;gap:4px}
.tda button{padding:5px;border:none;background:transparent;color:var(--ink3);border-radius:4px}
.tda button:hover{color:var(--ink);background:var(--bg)}
.badge{width:26px;height:26px;border-radius:50%;background:var(--bg);border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:var(--ink2)}

/* Modals */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:500;padding:16px}
.modal{background:var(--white);border-radius:14px;width:100%;box-shadow:var(--sh-lg);display:flex;flex-direction:column;max-height:90vh}
.modal-sm{max-width:480px}.modal-md{max-width:580px}.modal-lg{max-width:760px}.modal-xl{max-width:1040px}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-hd h2{font-size:1.05rem;font-weight:400}
.modal-bd{overflow-y:auto;padding:22px;flex:1;min-height:0}
.modal-ft{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;flex-shrink:0;flex-wrap:wrap}

/* Toast */
#toasts{position:fixed;top:16px;right:16px;z-index:9000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:11px 18px;border-radius:9px;color:#fff;font-size:13px;box-shadow:var(--sh-lg);animation:tin .25s ease;pointer-events:auto}
.t-ok{background:var(--green)}.t-warn{background:var(--amber)}.t-err{background:var(--red)}
@keyframes tin{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Quick Log */
.ql-timer{background:var(--bg);border-bottom:1px solid var(--border);padding:16px 22px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.timer-num{font-size:2.1rem;font-weight:200;font-family:'Courier New',monospace;letter-spacing:.04em;min-width:115px}
.timer-on{color:var(--ink)}.timer-off{color:var(--ink3)}
.total-pill{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:8px 14px;font-size:13px;color:#15803d;margin-bottom:14px}
/* Row timer */
.row-tmr-live{font-family:'Courier New',monospace;font-size:11px;color:var(--red);font-weight:600;letter-spacing:.02em;vertical-align:middle;margin-right:2px}
.row-tmr-stop{color:var(--red)!important;animation:tmr-pulse 1.2s ease-in-out infinite}
@keyframes tmr-pulse{0%,100%{opacity:1}50%{opacity:.45}}
/* Active timer banner */
.active-tmr-banner{background:var(--white);border:2px solid var(--red);border-radius:12px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;gap:20px;flex-wrap:wrap;box-shadow:0 0 0 4px rgba(220,38,38,.07)}
body.dark .active-tmr-banner{background:#1e1010;border-color:#ef4444;box-shadow:0 0 0 4px rgba(239,68,68,.1)}
.active-tmr-banner .atb-info{flex:1;min-width:0}
.active-tmr-banner .atb-tracking{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--red);display:flex;align-items:center;gap:5px;margin-bottom:6px}
.active-tmr-banner .atb-dot{width:7px;height:7px;border-radius:50%;background:var(--red);animation:tmr-pulse 1.2s ease-in-out infinite;flex-shrink:0}
.active-tmr-banner .atb-who{font-size:1.05rem;font-weight:600;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.active-tmr-banner .atb-desc{font-size:12px;color:var(--ink2);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-style:italic}
.active-tmr-banner .atb-clock{font-family:'Courier New',monospace;font-size:2.4rem;font-weight:200;color:var(--red);letter-spacing:.03em;flex-shrink:0;min-width:130px;text-align:right}
.active-tmr-banner .atb-stop{flex-shrink:0;padding:10px 20px;background:var(--red);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap}
.active-tmr-banner .atb-stop:hover{background:#b91c1c}
/* Table row states when timer running */
tr.tr-active-tmr td{background:#fff5f5!important;border-top:1px solid #fecaca;border-bottom:1px solid #fecaca}
tr.tr-active-tmr:first-child td{border-top-color:#fecaca}
body.dark tr.tr-active-tmr td{background:#2d1010!important}
tr.tr-dimmed td{opacity:.45}
/* QL inline new client/matter */
.ql-new-row{display:flex;gap:6px;align-items:center;margin-top:0}
.ql-new-row input{flex:1;padding:7px 10px;border:1.5px solid var(--blue);border-radius:6px;font-size:13px;background:var(--white);color:var(--ink);outline:none}
.ql-new-row .btn-confirm{padding:6px 11px;border-radius:6px;background:var(--blue);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;line-height:1}
.ql-new-row .btn-cancel{padding:6px 10px;border-radius:6px;background:transparent;color:var(--ink3);border:1px solid var(--border);cursor:pointer;font-size:13px;line-height:1}
.ql-new-row .btn-confirm:hover{background:#1d4ed8}.ql-new-row .btn-cancel:hover{color:var(--ink)}

/* Help */
.help-lay{display:flex;flex:1;overflow:hidden;min-height:0}
.help-nav{width:162px;flex-shrink:0;border-right:1px solid var(--border-l);padding:10px;overflow-y:auto}
.help-nav button{display:block;width:100%;text-align:left;padding:9px 11px;border:none;background:transparent;border-radius:7px;font-size:13px;color:var(--ink2);cursor:pointer;margin-bottom:2px}
.help-nav button:hover{background:var(--bg);color:var(--ink)}
.help-nav button.on{background:var(--bg);color:var(--ink);font-weight:500}
.help-body{flex:1;overflow-y:auto;padding:22px}
.help-body h3{font-weight:500;margin-bottom:12px}
.help-body h4{font-weight:500;color:var(--ink2);margin:18px 0 7px;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
.help-body p,.help-body li{color:var(--ink2);line-height:1.7;font-size:13px}
.help-body ol,.help-body ul{padding-left:18px}
.help-body li{margin-bottom:4px}
.note{background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:10px 14px;margin-top:14px;font-size:12px;color:#92400e}
.good{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 14px;margin-top:14px;font-size:12px;color:#166534}
.faq-item{border-bottom:1px solid var(--border-l);padding-bottom:14px;margin-bottom:14px}
.faq-item:last-child{border-bottom:none;margin-bottom:0}
.faq-item strong{display:block;color:var(--ink);margin-bottom:4px;font-size:13px}

/* Settings */
.set-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border-l)}
.set-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.set-section h3{font-weight:500;margin-bottom:12px;font-size:.93rem}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.preset-btn{padding:10px 12px;border:2px solid var(--border);border-radius:8px;background:var(--white);cursor:pointer;text-align:left;font-size:12px;transition:border .15s}
.preset-btn:hover{border-color:var(--ink3)}
.preset-btn strong{display:block;color:var(--ink);font-size:13px;margin-bottom:1px}
.crow{display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;margin-bottom:7px}
.crow input[type=checkbox]{width:14px;height:14px;cursor:pointer;flex-shrink:0;margin-top:1px}
.crow strong{display:block;font-size:13px;color:var(--ink)}
.crow span{font-size:11px;color:var(--ink3)}
.sub-checks{padding-left:20px;margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:4px}
.sub-check{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--ink2);cursor:pointer}
.sub-check input{width:13px;height:13px;cursor:pointer}
.danger{background:#fef2f2;border:1px solid #fee2e2;border-radius:8px;padding:14px 16px}
.danger h3{color:var(--red);margin-bottom:7px}
.danger p{color:#ef4444;font-size:12px;line-height:1.5;margin-bottom:12px}
.exp-name-preview{font-size:11px;color:var(--blue);background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:5px 10px;margin-bottom:14px;font-family:monospace}

/* Analytics split table */
.split-table{width:100%;font-size:13px;margin-top:8px}
.split-table th{text-align:left;font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;padding:6px 10px;border-bottom:1px solid var(--border)}
.split-table td{padding:8px 10px;border-bottom:1px solid var(--border-l)}
.split-table tr:last-child td{border-bottom:none;font-weight:500}
.own-amt{color:#166534}.firm-amt{color:#92400e}
.btn-link{background:none;border:none;padding:0;cursor:pointer;color:var(--blue);text-decoration:underline;font-size:inherit;font-family:inherit;}

/* Analytics */
.bar-row{margin-bottom:14px}
.bar-lbl{display:flex;justify-content:space-between;margin-bottom:5px;font-size:13px}
.bar-track{background:var(--bg);border-radius:4px;height:6px}
.bar-fill{background:var(--ink);border-radius:4px;height:6px;transition:width .4s ease}

/* ========== SPLASH SCREEN ========== */
.splash-ov{position:fixed;inset:0;z-index:900;display:flex;align-items:stretch;background:#0f172a;animation:splashIn .25s ease}
@keyframes splashIn{from{opacity:0}to{opacity:1}}

/* Left hero panel */
.splash-hero{width:340px;flex-shrink:0;background:linear-gradient(155deg,#1e3a5f 0%,#0f2040 50%,#0a1628 100%);display:flex;flex-direction:column;justify-content:space-between;padding:44px 40px;position:relative;overflow:hidden}
.splash-hero::before{content:'';position:absolute;top:-80px;right:-80px;width:280px;height:280px;border-radius:50%;background:rgba(59,130,246,.08);pointer-events:none}
.splash-hero::after{content:'';position:absolute;bottom:-60px;left:-60px;width:200px;height:200px;border-radius:50%;background:rgba(37,99,235,.07);pointer-events:none}
.splash-logo{display:flex;align-items:center;gap:12px}
.splash-logo-mark{width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 14px rgba(59,130,246,.4)}
.splash-logo-mark svg{color:#fff}
.splash-logo-name{font-size:1.05rem;font-weight:600;color:#f1f5f9;letter-spacing:-.01em}
.splash-tagline{margin-top:auto;padding-top:60px}
.splash-tagline h1{font-size:1.85rem;font-weight:300;color:#f1f5f9;line-height:1.25;margin-bottom:14px;letter-spacing:-.02em}
.splash-tagline h1 strong{font-weight:600;color:#fff}
.splash-tagline p{font-size:13px;color:#94a3b8;line-height:1.65}
.splash-steps{margin-top:40px;display:flex;flex-direction:column;gap:8px}
.splash-step{display:flex;align-items:center;gap:10px;font-size:12px;color:#475569;transition:color .2s}
.splash-step.active{color:#93c5fd}
.splash-step.done{color:#34d399}
.splash-step-dot{width:6px;height:6px;border-radius:50%;background:#334155;flex-shrink:0;transition:background .2s}
.splash-step.active .splash-step-dot{background:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
.splash-step.done .splash-step-dot{background:#10b981}

/* Right form panel */
.splash-form{flex:1;background:var(--white);display:flex;flex-direction:column;overflow-y:auto}
.splash-form-inner{flex:1;padding:52px 52px 36px;max-width:520px}
.splash-form-inner h2{font-size:1.5rem;font-weight:300;color:var(--ink);margin-bottom:6px;letter-spacing:-.02em}
.splash-form-inner h2 strong{font-weight:600}
.splash-form-inner .sub{font-size:13px;color:var(--ink2);line-height:1.6;margin-bottom:28px}
.splash-footer{padding:20px 52px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--white)}
.splash-footer-note{font-size:11px;color:var(--ink3)}

/* Profile option cards */
.splash-opt{display:flex;align-items:center;gap:16px;padding:18px 20px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s,background .15s;margin-bottom:12px;background:var(--white)}
.splash-opt:hover{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--blue-pale)}
.splash-opt-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.splash-opt-icon.blue{background:#eff6ff;color:var(--blue)}
.splash-opt-icon.slate{background:var(--bg);color:var(--ink2)}
.splash-opt-body{flex:1}
.splash-opt-body strong{display:block;font-size:14px;font-weight:600;color:var(--ink);margin-bottom:3px}
.splash-opt-body span{font-size:12px;color:var(--ink2);line-height:1.5}
.splash-opt-arrow{color:var(--ink3);flex-shrink:0}

/* Feature list */
.splash-features{background:var(--bg);border-radius:10px;padding:16px 18px;margin-bottom:22px}
.splash-features-title{font-size:11px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}
.splash-feature{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--ink2);padding:5px 0;border-bottom:1px solid var(--border-l)}
.splash-feature:last-child{border-bottom:none}
.splash-feature-dot{width:6px;height:6px;border-radius:50%;background:var(--blue);flex-shrink:0}

/* User select cards */
.splash-user-card{display:flex;align-items:center;gap:14px;padding:14px 18px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s,background .15s;margin-bottom:10px;background:var(--white)}
.splash-user-card:hover{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--blue-pale)}
.splash-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;letter-spacing:.01em}
.splash-user-info strong{display:block;font-size:13px;font-weight:600;color:var(--ink)}
.splash-user-info span{font-size:11px;color:var(--ink3)}

/* Role selector */
.splash-roles{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
.splash-role{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:1.5px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s;background:var(--white)}
.splash-role:hover{border-color:var(--blue);background:var(--blue-pale)}
.splash-role.sel{border-color:var(--blue);background:var(--blue-pale);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.splash-role-radio{width:16px;height:16px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;margin-top:2px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.splash-role.sel .splash-role-radio{border-color:var(--blue);background:var(--blue)}
.splash-role.sel .splash-role-radio::after{content:'';width:6px;height:6px;border-radius:50%;background:#fff;display:block}
.splash-role-body strong{display:block;font-size:13px;font-weight:600;color:var(--ink);margin-bottom:2px}
.splash-role-body span{font-size:11px;color:var(--ink2);line-height:1.5}

/* Dark mode overrides */
body.dark .splash-form,body.dark .splash-footer{background:#1e293b}
body.dark .splash-opt,body.dark .splash-user-card,body.dark .splash-role{background:#1e293b;border-color:#334155}
body.dark .splash-opt:hover,body.dark .splash-user-card:hover,body.dark .splash-role:hover{background:#172554;border-color:#3b82f6}
body.dark .splash-role.sel{background:#172554;border-color:#3b82f6}
body.dark .splash-opt-icon.slate{background:#263347}
body.dark .splash-features{background:#263347}

/* Legacy up-wrap kept for chgUser (non-first-run profile edit) */
.up-wrap{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:900;padding:16px}
.up-box{background:var(--white);border-radius:16px;padding:38px;max-width:460px;width:100%;box-shadow:var(--sh-lg);max-height:90vh;overflow-y:auto}
.up-icon{width:52px;height:52px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:22px}
.up-box h2{font-size:1.6rem;font-weight:300;margin-bottom:8px}
.up-box p{font-size:13px;color:var(--ink2);margin-bottom:24px;line-height:1.6}

/* Responsive splash */
@media(max-width:720px){
  .splash-ov{flex-direction:column}
  .splash-hero{width:auto;padding:28px 24px 24px;flex-direction:row;align-items:center;gap:20px}
  .splash-tagline,.splash-steps{display:none}
  .splash-form-inner{padding:28px 22px 20px}
  .splash-footer{padding:16px 22px}
}

/* FAB */
#fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:var(--ink);color:#fff;border:none;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:200;cursor:pointer;transition:transform .15s}
#fab:hover{transform:scale(1.1)}

/* Empty */
.empty{text-align:center;padding:60px 20px;color:var(--ink3)}
.empty-ico{font-size:2.5rem;margin-bottom:12px}
.empty p{font-weight:300;font-size:.95rem}
.empty small{font-size:12px;margin-top:4px;display:block}

/* Loading */
#loading{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);flex-direction:column;gap:12px;color:var(--ink3);font-size:1rem;font-weight:300}

/* ── Mobile responsive ────────────────────────────────────────────────── */
/* Prevent page-level horizontal overflow; tables scroll within .tscroll */
html,body{overflow-x:hidden;max-width:100vw}
.main{min-width:0;overflow-x:hidden}
.twrap{min-width:0}
/* Ensure tscroll is a proper isolated scroll container */
.tscroll{overflow-x:auto;-webkit-overflow-scrolling:touch;max-width:100%}
/* Prevent any direct child of main from busting out of viewport */
#app>*{min-width:0}

@media(max-width:640px){
  /* Layout */
  .main{padding:14px 10px}
  .header-inner{padding:10px 12px;gap:8px}
  .logo h1{font-size:1rem}
  .logo-sub{display:none}
  .header-btns{gap:6px}
  .header-btns .btn{padding:7px 11px;font-size:12px}
  /* Nav tabs: compact, icon+label both retained but smaller */
  .nav{padding:0 4px}
  .nav-btn{padding:8px 10px;font-size:12px;gap:4px}
  .nav-btn svg{width:14px;height:14px}
  /* Stats: 2-up minimum */
  .srow{grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;margin-bottom:14px}
  .sc{padding:10px 12px}
  .sc-val{font-size:1.2rem}
  /* Cards: single column */
  .cgrid{grid-template-columns:1fr}
  /* Form rows: stack */
  .frow.c2,.frow.c3{grid-template-columns:1fr}
  /* Action footer */
  .fa{flex-wrap:wrap}
  .fa .btn{flex:1;min-width:0;justify-content:center}
  /* Modals: bottom-sheet */
  .ov{padding:8px 0 0;align-items:flex-end}
  .modal{border-radius:16px 16px 0 0;max-height:92vh;width:100%}
  .modal-sm,.modal-md,.modal-lg,.modal-xl{max-width:100%}
  .modal-hd{padding:14px 16px}
  .modal-bd{padding:16px}
  .modal-ft{padding:12px 16px;flex-wrap:wrap}
  .modal-ft .btn{flex:1;justify-content:center}
  /* Filter bars: wrap and stretch */
  .ts-filters{flex-wrap:wrap}
  .ts-filters select,.ts-filters input{flex:1;min-width:110px;max-width:100%}
  /* Active timer banner: stack */
  .active-tmr-banner{flex-direction:column;align-items:flex-start;gap:6px;padding:12px 14px}
  .active-tmr-banner .atb-clock{font-size:1.8rem;min-width:0}
  .atb-stop{align-self:stretch;text-align:center;padding:8px 0}
  /* FAB */
  #fab{width:46px;height:46px;font-size:19px;bottom:18px;right:16px}
  /* Tables: compact cell padding + smaller font so more fits before scrolling */
  th{padding:7px 9px;font-size:10px}
  td{padding:7px 9px;font-size:12px}
  /* Tighten action buttons inside table cells */
  .tda{gap:2px}
  .tda button{padding:4px}
}
/* Invoice */
@media print{
  .header,.nav,.header-btns,button,.modal-hd,.modal-ft,.tda,.fab{display:none!important}
  .modal,.ov{position:static!important;background:transparent!important;padding:0!important}
  #inv-print-wrap{margin:0!important;box-shadow:none!important;max-width:100%!important}
  body{background:#fff!important;color:#000!important}
}
</style>
</head>
<body>
<script>
// Anti-FOUC: apply dark mode and layout before first paint
(function(){
  try{
    var p=JSON.parse(localStorage.getItem('bl-prefs')||'{}');
    var dm=p.darkMode===undefined?null:p.darkMode;
    var sysDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(dm===true||(dm===null&&sysDark)) document.body.classList.add('dark');
    if(p.layout&&p.layout!=='comfortable') document.body.classList.add('layout-'+p.layout);
    if(p.appName){
      document.title=p.appName;
      // Update loading text too
      document.addEventListener('DOMContentLoaded',function(){
        var ldiv=document.getElementById('loading');
        if(ldiv&&p.appName){ var t=ldiv.querySelector('div:last-child'); if(t) t.textContent='Loading '+p.appName+'...'; }
      });
    }
  }catch(e){}
})();
</script>
<div id="loading"><div style="font-size:2rem">&#9878;&#65039;</div><div>Loading SixMinuteLog.com...</div></div>
<div id="toasts"></div>
<button id="fab" onclick="A.openQL()" title="Quick Log"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></button>
<div id="app" style="display:none"></div>

<script>
// +============================================================+
// |  SixMinuteLog.com -- CLAUDE MANIFEST                         |
// |  AI: read CLAUDE_BILLING.md first, then view line ranges.  |
// +------------------------------------------------------------+
// |  SECTION MAP (Ctrl+F these strings):                       |
// |  "// === STORAGE"       Store.get/set/del                  |
// |  "// === STATE"         ST object                          |
// |  "// === HELPERS"       uid,today,$m,$h,H,autoRate,syncForm|
// |  "// === SAVE"          save() persist                     |
// |  "// === TOAST"         toast(msg,type)                    |
// |  "// === ICONS"         IC object SVG strings              |
// |  "// === FIELD BUILDER" field(), stats()                   |
// |  "// === VIEWS"         tab view functions                 |
// |  "// === MODALS"        modal builder functions            |
// |  "// === MAIN RENDER"   TABS[], views{}, render()          |
// |  "// === ACTIONS"       A object user actions              |
// |  "// === CHANGE DELEGATION" onchange handler               |
// |  "// === INIT"          startup loading                    |
// +------------------------------------------------------------+
// |  ADD TAB:   IC + TABS[] + view fn + views{} in render()   |
// |  ADD MODAL: build fn + else-if render() + open action     |
// |  ADD DATA:  ST + save() + INIT Promise.all load           |
// |  ALWAYS: syncForm() before render() / H() on user data    |
// +============================================================+

// === STORAGE  (IndexedDB — proper per-collection object stores)
//
// Schema (v3):
//   clients, matters, entries, contacts, invoices  →  keyPath:'id'  (one record per item)
//   meta                                           →  keyPath:'k'   (singletons: user,prefs,…)
//
// Public API:
//   Store.getAll(name)              → Promise<array>   read all records in a collection
//   Store.putRecord(name, rec)      → Promise          upsert one record (SAFE — no clear)
//   Store.deleteRecord(name, id)    → Promise          delete one record by id
//   Store.putBatch(name, arr)       → Promise          upsert many records (NO clear — safe)
//   Store.syncCollection(name,arr)  → Promise          upsert batch + delete IDs not in arr
//   Store.getMeta(key)              → Promise<any|null>
//   Store.setMeta(key, val)         → Promise
//   Store.clearData()               → Promise          wipe all stores (reset only)
//
// NOTE: saveAll (clear+putAll) has been REMOVED. All writes are additive upserts.
//       Deletions must be explicit via deleteRecord or syncCollection.
//
// bl-prefs is ALSO mirrored to localStorage so the synchronous anti-FOUC block (above)
// can read it before IndexedDB resolves.  No other data touches localStorage.
const Store=(function(){
  var _db=null;
  var DB_NAME='SixMinuteLog';
  var DB_VER=4;
  var COLLECTIONS=['clients','matters','entries','contacts','invoices'];
  var COLL_SET={clients:1,matters:1,entries:1,contacts:1,invoices:1};
  var META_KEYS=['user','prefs','descpresets','mailpresets','mailplaceholders','itmode'];

  function _open(){
    if(_db) return Promise.resolve(_db);
    return new Promise(function(resolve,reject){
      var req=indexedDB.open(DB_NAME,DB_VER);

      req.onupgradeneeded=function(e){
        var db=e.target.result;
        var tx=e.target.transaction;
        var oldV=e.oldVersion;

        // ── Create object stores (idempotent) ──
        COLLECTIONS.forEach(function(name){
          if(!db.objectStoreNames.contains(name))
            db.createObjectStore(name,{keyPath:'id'});
        });
        if(!db.objectStoreNames.contains('meta'))
          db.createObjectStore('meta',{keyPath:'k'});

        // ── v4: Add date index on entries for efficient range queries ──
        var entriesOS = tx.objectStore('entries');
        if(!entriesOS.indexNames.contains('dateIdx'))
          entriesOS.createIndex('dateIdx','date',{unique:false});

        // ── Migrate from v1 kv-blob store ──
        if(oldV===1 && db.objectStoreNames.contains('kv')){
          var kvReq=tx.objectStore('kv').getAll();
          kvReq.onsuccess=function(){
            var metaOS=tx.objectStore('meta');
            (kvReq.result||[]).forEach(function(item){
              var rawKey=item.k.replace(/^bl-/,'');
              var parsed;
              try{parsed=JSON.parse(item.v);}catch(e2){return;}
              if(COLL_SET[rawKey]&&Array.isArray(parsed)){
                var os2=tx.objectStore(rawKey);
                parsed.forEach(function(rec){if(rec&&rec.id!=null)os2.put(rec);});
              } else {
                metaOS.put({k:rawKey,v:parsed});
              }
            });
            tx.objectStore('kv').clear();
          };
        } else if(oldV===0){
          // Fresh install: migrate from localStorage
          var metaOS2=tx.objectStore('meta');
          META_KEYS.forEach(function(k){
            var v=localStorage.getItem('bl-'+k);
            if(v){try{metaOS2.put({k:k,v:JSON.parse(v)});}catch(e2){}}
          });
          COLLECTIONS.forEach(function(name){
            var v=localStorage.getItem('bl-'+name);
            if(v){
              try{
                var arr=JSON.parse(v);
                var os3=tx.objectStore(name);
                if(Array.isArray(arr))arr.forEach(function(r){if(r&&r.id!=null)os3.put(r);});
              }catch(e2){}
            }
          });
          try{localStorage.setItem('bl-idb-migrated','1');}catch(e2){}
          ['bl-user','bl-clients','bl-matters','bl-entries','bl-contacts',
           'bl-descpresets','bl-mailpresets','bl-itmode','bl-invoices']
            .forEach(function(k){try{localStorage.removeItem(k);}catch(e2){}});
        }
      };

      req.onsuccess=function(e){_db=e.target.result;resolve(_db);};
      req.onerror=function(e){reject(e.target.error);};
      req.onblocked=function(){console.warn('IDB open blocked — close other tabs');};
    });
  }

  // Internal: run a readwrite transaction and resolve when complete
  function _tx(stores, fn){
    return _open().then(function(db){
      return new Promise(function(resolve,reject){
        var storeList=Array.isArray(stores)?stores:[stores];
        var tx=db.transaction(storeList,'readwrite');
        tx.oncomplete=function(){resolve();};
        tx.onerror=function(e){console.warn('Store tx error',e);resolve();};
        tx.onabort=function(e){console.warn('Store tx abort',e);resolve();};
        try{ fn(tx); }catch(err){console.warn('Store tx fn error',err);resolve();}
      });
    }).catch(function(e){console.warn('Store._tx catch',e);});
  }

  return{
    // ── Read ──
    getAll:function(name){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction(name,'readonly').objectStore(name).getAll();
          req.onsuccess=function(){resolve(req.result||[]);};
          req.onerror=function(){resolve([]);};
        });
      }).catch(function(){return[];});
    },

    // ── Single-record upsert (safe: no clear, atomic) ──
    putRecord:function(name,rec){
      if(!rec||rec.id==null){console.warn('Store.putRecord: invalid record',name,rec);return Promise.resolve();}
      return _tx(name,function(tx){tx.objectStore(name).put(rec);});
    },

    // ── Single-record delete (safe, atomic) ──
    deleteRecord:function(name,id){
      if(id==null){return Promise.resolve();}
      return _tx(name,function(tx){tx.objectStore(name).delete(id);});
    },

    // ── Batch upsert WITHOUT clearing — safe even if interrupted ──
    putBatch:function(name,arr){
      if(!arr||!arr.length)return Promise.resolve();
      return _tx(name,function(tx){
        var os=tx.objectStore(name);
        arr.forEach(function(rec){if(rec&&rec.id!=null)os.put(rec);});
      });
    },

    // ── Full sync: upsert all records, delete IDs no longer in arr ──
    // Use this for imports or bulk replace — never in normal edit flows.
    syncCollection:function(name,arr){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var tx=db.transaction(name,'readwrite');
          var os=tx.objectStore(name);
          // Build set of incoming IDs
          var incoming={};
          (arr||[]).forEach(function(r){if(r&&r.id!=null)incoming[r.id]=r;});
          // Read existing IDs, delete ones not in incoming
          var getAllReq=os.getAll();
          getAllReq.onsuccess=function(){
            (getAllReq.result||[]).forEach(function(existing){
              if(!incoming[existing.id]) os.delete(existing.id);
            });
            // Put all incoming
            Object.values(incoming).forEach(function(r){os.put(r);});
          };
          tx.oncomplete=function(){resolve();};
          tx.onerror=function(e){console.warn('Store.syncCollection',name,e);resolve();};
        });
      }).catch(function(){});
    },

    // ── Legacy alias (now uses syncCollection — safe upsert+prune) ──
    // Kept so any external code referencing saveAll still works.
    saveAll:function(name,arr){return this.syncCollection(name,arr);},

    // ── Efficient date-range query on entries (uses IDB dateIdx index) ──
    // from / to are 'YYYY-MM-DD' strings (inclusive). Pass '' / '' for all.
    getEntriesInRange:function(from, to){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var tx=db.transaction('entries','readonly');
          var idx=tx.objectStore('entries').index('dateIdx');
          var range;
          if(from && to)      range=IDBKeyRange.bound(from, to);
          else if(from)        range=IDBKeyRange.lowerBound(from);
          else if(to)          range=IDBKeyRange.upperBound(to);
          var req=range ? idx.getAll(range) : idx.getAll();
          req.onsuccess=function(){resolve(req.result||[]);};
          req.onerror=function(){resolve([]);};
        });
      }).catch(function(){return[];});
    },

    // ── Total entries count (no data transfer) ──
    countEntries:function(){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction('entries','readonly').objectStore('entries').count();
          req.onsuccess=function(){resolve(req.result||0);};
          req.onerror=function(){resolve(0);};
        });
      }).catch(function(){return 0;});
    },

    // ── Explicit full entries load (analytics, export, invoice) ──
    getAllEntries:function(){return this.getAll('entries');},

    // ── Singleton metadata ──
    getMeta:function(key){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction('meta','readonly').objectStore('meta').get(key);
          req.onsuccess=function(){resolve(req.result?req.result.v:null);};
          req.onerror=function(){resolve(null);};
        });
      }).catch(function(){return null;});
    },
    setMeta:function(key,val){
      if(key==='prefs'){try{localStorage.setItem('bl-prefs',JSON.stringify(val));}catch(e){}}
      return _tx('meta',function(tx){tx.objectStore('meta').put({k:key,v:val});});
    },

    // ── Wipe everything (reset only) ──
    clearData:function(){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var all=COLLECTIONS.concat(['meta']);
          var tx=db.transaction(all,'readwrite');
          all.forEach(function(name){tx.objectStore(name).clear();});
          tx.oncomplete=function(){resolve();};
          tx.onerror=function(){resolve();};
        });
      }).catch(function(){});
    }
  };
})();

// === STATE
var ST={
  tab:'timesheet',
  clients:[],matters:[],entries:[],contacts:[],
  invoices:[],
  user:null,
  settings:{
    // sections
    te:true,cl:true,ma:true,co:true,su:true,split:false,
    // time entry columns
    tc_date:true,tc_client:true,tc_matter:true,tc_team:true,
    tc_desc:true,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false,
    // date range for export (empty = all)
    expFrom:'',expTo:'',
    // per-client grouping
    te_group:false
  },
  // Appearance & customization preferences (persisted in bl-prefs)
  prefs:{
    appName:'SixMinuteLog.com',
    darkMode:null,
    layout:'comfortable',
    revenueSplit:false,
    analyticsEnabled:false,
    // Quick-export preset — drives the header CSV button
    csvQuick:{
      dataset:'entries',
      datePreset:'month',
      cols:{date:true,client:true,matter:true,contact:false,hours:true,rate:true,amount:true,desc:true,by:false,entryId:false,abaCode:false},
      clCols:{name:true,email:true,phone:true,rate:true,contact:false},
      maCols:{name:true,client:true,desc:true,rate:true,contact:false},
      ctCols:{name:true,role:true,email:true,phone:true,rate:false,ownPct:false},
      groupBy:'none',
      includeTotals:true,
      includeGrandTotal:true,
      dateFormat:'iso',
      currencySymbol:true,
      filenamePrefix:''
    }
  },
  // User-defined description suggestions shown as chips in entry forms (bl-descpresets)
  descPresets:[
    'Legal research and analysis',
    'Drafted correspondence',
    'Client consultation',
    'Court appearance / hearing',
    'Document review',
    'Contract drafting / review',
    'Phone conference with client',
    'Filed documents with court',
    'Deposition preparation',
    'Settlement negotiation'
  ],
  // Mail presets for emailing exported CSV (bl-mailpresets)
  mailPresets:[],
  // Custom/editable email placeholders
  mailPlaceholders:[],
  modal:null,editId:null,helpTab:'start',settingsTab:'export',
  tsFilter:'all',anFilter:'month',
  // Timesheet extra filters/sort
  tsClientFilter:'',tsMatterFilter:'',tsSort:'date-desc',
  // Clients sort
  clSort:'alpha',clSearch:'',
  // Matters group/filter/sort
  maGroup:false,maClientFilter:'',maSort:'alpha',maSearch:'',
  // Contacts sort/search
  ctSort:'alpha',ctSearch:'',
  tmrOn:false,tmrStart:0,tmrMs:0,tmrIv:null,
  rowTmr:null, // {entId, startMs, accMs, iv} — per-row stopwatch
  ef:{},cf:{},mf:{},ctf:{},ql:{},
  mpf:{},
  // Pagination (timesheet)
  tsPage:0,
  TS_PAGE_SIZE:50,
  // Entries loading tier:
  //   'partial' = only loaded YEAR_START … today (default, fast startup)
  //   'full'    = all entries loaded (triggered by "All Time" or analytics)
  _entriesMode:'partial',
  _totalEntryCount:0,  // from IDB count() — used to show "X of Y entries"
  // Invoice form and review state
  invf:{},invRev:{invoiceId:null,cuts:{},mergeGroup:{},comments:{},pendingMerge:[]},
  invFilter:'all',invPrintId:null,
  // IT Mode - admin profile management
  itMode:false,
  firmProfile:{
    firmName:'',
    appName:'SixMinuteLog.com',
    clients:[],
    matters:[],
    contacts:[],
    descPresets:[],
    users:[],   // pre-configured user profiles for new installs
    settings:{}
  },
  itf:{},  // IT admin form state
  firstRun:false,  // true if no user set on init
  pref:{},   // partner review entry form state
  // === CSV EXPORT WIZARD STATE (transient, not persisted) ===
  csvX:{
    dataset:'entries',        // entries | clients | matters | contacts
    // ── Date range ──
    dateFrom:'', dateTo:'',
    // ── Entry filters ──
    allClients:true, clientIds:{},
    allMatters:true, matterIds:{},
    // ── Entry columns ──
    cols:{date:true,client:true,matter:true,contact:false,hours:true,rate:true,amount:true,desc:true,by:false,entryId:false,abaCode:false},
    // ── Client columns ──
    clCols:{name:true,email:true,phone:true,rate:true,contact:false},
    // ── Matter columns ──
    maCols:{name:true,client:true,desc:true,rate:true,contact:false},
    // ── Contact columns ──
    ctCols:{name:true,role:true,email:true,phone:true,rate:false,ownPct:false},
    // ── Structure ──
    groupBy:'none',           // none | client | matter | date-month | date-week
    includeTotals:true,
    includeGrandTotal:true,
    // ── Output ──
    dateFormat:'iso',         // iso | us | uk | long
    currencySymbol:true,
    filenamePrefix:''
  }
};

// === HELPERS
var _uid=1;
function uid(){return Date.now()*1000+(_uid++);}
function today(){return new Date().toISOString().split('T')[0];}

// ABA/UTBMS Uniform Task-Based Management System codes
var ABA_TASK_CODES=[
  {v:'',l:'-- No ABA Task Code --'},
  // Case Assessment, Development and Administration
  {v:'L110',l:'L110 – Fact Investigation/Development'},
  {v:'L120',l:'L120 – Analysis/Strategy'},
  {v:'L130',l:'L130 – Experts/Consultants'},
  {v:'L140',l:'L140 – Document/File Management'},
  {v:'L150',l:'L150 – Budgeting'},
  {v:'L160',l:'L160 – Settlement/Non-Binding ADR'},
  {v:'L190',l:'L190 – Other Case Assessment'},
  // Pre-Trial Pleadings
  {v:'L210',l:'L210 – Pleadings'},
  {v:'L220',l:'L220 – Preliminary Injunctions/Provisional Remedies'},
  {v:'L230',l:'L230 – Court Mandated Conferences'},
  {v:'L240',l:'L240 – Dispositive Motions'},
  {v:'L250',l:'L250 – Other Written Motions/Submissions'},
  {v:'L260',l:'L260 – Class Action Certification'},
  // Discovery
  {v:'L310',l:'L310 – Written Discovery'},
  {v:'L320',l:'L320 – Document Production'},
  {v:'L330',l:'L330 – Depositions'},
  {v:'L340',l:'L340 – Expert Discovery'},
  {v:'L350',l:'L350 – Discovery Motions'},
  {v:'L360',l:'L360 – Other Discovery'},
  // Trial Preparation and Trial
  {v:'L410',l:'L410 – Fact Witnesses at Trial'},
  {v:'L420',l:'L420 – Expert Witnesses'},
  {v:'L430',l:'L430 – Jury Issues'},
  {v:'L440',l:'L440 – Preparing Trial Exhibits'},
  {v:'L450',l:'L450 – Trial/Hearing Attendance'},
  {v:'L460',l:'L460 – Post-Trial Motions/Submissions'},
  // Appeals
  {v:'L510',l:'L510 – Appellate Motions/Submissions'},
  {v:'L520',l:'L520 – Appellate Briefs'},
  {v:'L530',l:'L530 – Oral Argument'},
  // Transactional / Counseling
  {v:'A101',l:'A101 – Plan and Prepare For'},
  {v:'A102',l:'A102 – Research'},
  {v:'A103',l:'A103 – Draft/Revise'},
  {v:'A104',l:'A104 – Review/Analyze'},
  {v:'A105',l:'A105 – Communicate (internal)'},
  {v:'A106',l:'A106 – Communicate (with client)'},
  {v:'A107',l:'A107 – Communicate (other outside counsel)'},
  {v:'A108',l:'A108 – Manage Data/Files'},
  {v:'A109',l:'A109 – Appear For/Attend'}
];
function $m(n){return '$'+Number(n||0).toFixed(2);}
function $h(n){return Number(n||0).toFixed(1)+'h';}
// msToHMS: convert milliseconds to "H:MM:SS" string for raw-time tooltips
function msToHMS(ms){
  var s=Math.floor((ms||0)/1000);
  var hh=Math.floor(s/3600);
  var mm=Math.floor((s%3600)/60);
  var ss=s%60;
  return hh+':'+String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0');
}
function $d(s){if(!s)return '';var d=new Date(s+'T00:00:00');return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function H(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
// Interactive contact link helpers — use in all display-side email/phone output
function mailLink(email,style){if(!email)return '';return '<a href="mailto:'+H(email)+'" style="'+(style||'')+'color:inherit;text-decoration:none" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">'+H(email)+'</a>';}
function telLink(phone,style){if(!phone)return '';var stripped=phone.replace(/[^\d+]/g,'');return '<a href="tel:'+H(stripped)+'" style="'+(style||'')+'color:inherit;text-decoration:none" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">'+H(phone)+'</a>';}
function pad2(n){return String(n).padStart(2,'0');}

// Phone: format live as user types
function fmtPhone(v){
  var d=v.replace(/\D/g,'');
  if(d.length<=3) return d;
  if(d.length<=6) return '('+d.slice(0,3)+') '+d.slice(3);
  return '('+d.slice(0,3)+') '+d.slice(3,6)+'-'+d.slice(6,10);
}

function fmtCur(v){
  var c=v.replace(/[^\d.]/g,''),p=c.split('.');
  if(p.length>2) return p[0]+'.'+p.slice(1).join('');
  if(p[1]&&p[1].length>2) return p[0]+'.'+p[1].slice(0,2);
  return c;
}

function myRole(){ return ST.user&&ST.user.role||'attorney'; }
function isPartner(){ return myRole()==='partner'; }
function isBilling(){ return myRole()==='billing_staff'; }

function statusBadge(st){
  var s=st||'approved';
  var map={pending:'s-pending',approved:'s-approved',rejected:'s-rejected'};
  var icon={pending:'\u23f3',approved:'\u2713',rejected:'\u2717'};
  return '<span class="status-badge '+map[s]+'">'+icon[s]+' '+s.charAt(0).toUpperCase()+s.slice(1)+'</span>';
}

function roleBadge(role){
  var r=role||'attorney';
  var cls={partner:'rl-partner',attorney:'rl-attorney',billing_staff:'rl-billing'};
  var lbl={partner:'Partner',attorney:'Attorney',billing_staff:'Billing Staff'};
  return '<span class="role-lbl '+(cls[r]||'rl-attorney')+'">'+(lbl[r]||r)+'</span>';
}

// Return the most recent rate from a rateHistory array that is effective on or before `forDate`.
// Each entry in history must have { effectiveDate:'YYYY-MM-DD', rate:Number }.
function _rateOnDate(history, forDate){
  if(!history||!history.length) return null;
  var valid=history.filter(function(r){return r.effectiveDate&&r.effectiveDate<=forDate&&Number(r.rate)>0;});
  if(!valid.length) return null;
  // Sort descending by date → first entry is the latest applicable
  valid=valid.slice().sort(function(a,b){return a.effectiveDate<b.effectiveDate?1:-1;});
  return Number(valid[0].rate)||null;
}

// Rate precedence (most-specific wins):
//   1. Matter  + attorney rate history (entry date)
//   2. Client  + attorney rate history (entry date)
//   3. Attorney's own rate history (entry date), then attorney's current .rate
//   4. If no attorney selected: user's own .rate
//   5. Matter default rate
//   6. Client default rate
function autoRate(cid,mid,ctid,date){
  var d=date||today();
  if(ctid){
    // 1. Matter-specific attorney rate
    var m=ST.matters.find(function(x){return x.id==mid;});
    if(m&&m.attorneyRates){
      var mar=m.attorneyRates.filter(function(r){return r.contactId==ctid;});
      var mRate=_rateOnDate(mar,d);
      if(mRate) return mRate;
    }
    // 2. Client-specific attorney rate
    var cl=ST.clients.find(function(x){return x.id==cid;});
    if(cl&&cl.attorneyRates){
      var car=cl.attorneyRates.filter(function(r){return r.contactId==ctid;});
      var cRate=_rateOnDate(car,d);
      if(cRate) return cRate;
    }
    // 3. Attorney's own rate history, then current rate
    var ct=ST.contacts.find(function(x){return x.id==ctid;});
    if(ct){
      var ctRate=_rateOnDate(ct.rateHistory,d)||(ct.rate?Number(ct.rate):null);
      if(ctRate) return ctRate;
    }
  } else {
    // 4. No attorney selected — use logged-in user's rate
    if(ST.user&&ST.user.rate) return ST.user.rate;
  }
  return '';
}

function filterEnt(arr,f){
  var now=new Date(),t=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  function ago(d,n){d.setDate(d.getDate()-n);return d;}
  function agoM(d,n){d.setMonth(d.getMonth()-n);return d;}
  function agoY(d,n){d.setFullYear(d.getFullYear()-n);return d;}
  var cut, cutEnd;
  if(f==='today') cut=t;
  else if(f==='week')  cut=ago(new Date(t),7);
  else if(f==='month') cut=agoM(new Date(t),1);
  else if(f==='quarter') cut=ago(new Date(t),91);
  else if(f==='year')  cut=agoY(new Date(t),1);
  else if(f==='this_month'){
    cut=new Date(now.getFullYear(),now.getMonth(),1);
  } else if(f==='this_quarter'){
    var qStart=Math.floor(now.getMonth()/3)*3;
    cut=new Date(now.getFullYear(),qStart,1);
  } else if(f==='this_year'){
    cut=new Date(now.getFullYear(),0,1);
  } else return arr; // 'all'
  return arr.filter(function(e){return new Date(e.date)>=cut;});
}

// Returns the fraction of annual salary that maps to the given filter period.
// Used to prorate salary for bonus/shortfall comparisons.
// Returns null if the period is indeterminate ('all').
function salaryForPeriod(annual, f){
  if(annual==null||annual==='') return null;
  var a=Number(annual);
  var now=new Date();
  if(f==='week')        return a/52;
  if(f==='month')       return a/12;
  if(f==='quarter')     return a/4;
  if(f==='year')        return a;
  if(f==='this_month'){
    // Days elapsed in this calendar month / days in month
    var daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
    var dayOfMonth=now.getDate();
    return (a/12)*(dayOfMonth/daysInMonth);
  }
  if(f==='this_quarter'){
    var qStartM=Math.floor(now.getMonth()/3)*3;
    var qStart=new Date(now.getFullYear(),qStartM,1);
    var qEnd=new Date(now.getFullYear(),qStartM+3,0);
    var qDays=(qEnd-qStart)/86400000+1;
    var elapsed=Math.floor((now-qStart)/86400000)+1;
    return (a/4)*(elapsed/qDays);
  }
  if(f==='this_year'){
    var isLeap=(now.getFullYear()%4===0&&now.getFullYear()%100!==0)||(now.getFullYear()%400===0);
    var yearDays=isLeap?366:365;
    var jan1=new Date(now.getFullYear(),0,1);
    var elapsed2=Math.floor((now-jan1)/86400000)+1;
    return a*(elapsed2/yearDays);
  }
  return null; // 'all' — no meaningful proration
}

// Human-readable salary period label for display
function salaryPeriodLabel(f){
  return {
    week:'weekly (÷52)', month:'monthly (÷12)', quarter:'quarterly (÷4)',
    year:'annual', this_month:'month-to-date', this_quarter:'quarter-to-date',
    this_year:'year-to-date', all:null
  }[f]||null;
}

// Sync form field values to state before any re-render triggered by dropdown changes
// This prevents typed text from being lost when a select triggers a re-render
function syncForm(){
  if(ST.modal==='ef'){
    var d=g('ef-d'),h=g('ef-h'),r=g('ef-r'),desc=g('ef-desc'),by=g('ef-by');
    if(d) ST.ef.date=d;
    ST.ef.hours=h; // always sync so partial typing is preserved
    ST.ef.rate=r;
    ST.ef.description=desc;
    if(by!==undefined) ST.ef.byContactId=by;
  }
  if(ST.modal==='cf'){
    var n=g('cf-n'),e=g('cf-e'),p=g('cf-p'),op=g('cf-op');
    ST.cf.name=n; ST.cf.email=e; ST.cf.phone=p;
    if(op!==undefined) ST.cf.ownPct=op;
    // Preserve new-person draft
    var pn=g('cf-pn'),pro=g('cf-pro'),pe=g('cf-pe'),pp=g('cf-pp');
    if(pn!==undefined) ST.cf.newPerson=ST.cf.newPerson||{};
    if(pn!==undefined) ST.cf.newPerson.name=pn;
    if(pro!==undefined) ST.cf.newPerson.role=pro;
    if(pe!==undefined) ST.cf.newPerson.email=pe;
    if(pp!==undefined) ST.cf.newPerson.phone=pp;
  }
  if(ST.modal==='mf'){
    var n=g('mf-n'),desc=g('mf-desc');
    ST.mf.name=n; ST.mf.description=desc;
  }
  if(ST.modal==='ctf'){
    var n=g('ctf-n'),ro=g('ctf-ro'),e=g('ctf-e'),p=g('ctf-p'),r=g('ctf-rate'),op=g('ctf-op');
    ST.ctf.name=n; ST.ctf.role=ro; ST.ctf.email=e; ST.ctf.phone=p; ST.ctf.rate=r;
    if(op!==undefined) ST.ctf.ownPct=op;
  }
  if(ST.modal==='ql'){
    var h=g('ql-h'),r=g('ql-r'),desc=g('ql-d');
    if(h) ST.ql.hours=h;
    if(r) ST.ql.rate=r;
    if(desc) ST.ql.description=desc;
    var ncn=g('ql-ncn'),nmn=g('ql-nmn');
    if(ncn!==undefined) ST.ql.newClName=ncn;
    if(nmn!==undefined) ST.ql.newMaName=nmn;
  }
  if(ST.modal==='settings'){
    var ef=g('exp-from'),et=g('exp-to');
    if(ef!==undefined) ST.settings.expFrom=ef;
    if(et!==undefined) ST.settings.expTo=et;
  }
  if(ST.modal==='pref'){
    var h=g('pref-h'),r=g('pref-r'),d=g('pref-desc'),c=g('pref-cmt'),inv=document.getElementById('pref-inv');
    if(h!==undefined) ST.pref.hours=h;
    if(r!==undefined) ST.pref.rate=r;
    if(d!==undefined) ST.pref.description=d;
    if(c!==undefined) ST.pref.comment=c;
    if(inv) ST.pref.showOnInvoice=inv.checked;
  }
}

// === SAVE
//
// Strategy:
//   saveOne(coll, rec)  — immediate single-record upsert (for form saves, no data-loss risk)
//   delOne(coll, id)    — immediate single-record delete
//   save()              — debounced full-state sync (for bulk/meta; 200ms debounce)
//   _flushSave()        — immediate (no debounce) full sync — called on tab hide
//
// Collections use putRecord/deleteRecord (safe, atomic, no clear).
// Bulk import uses syncCollection (upsert + prune orphans in one tx).
//
var _saveTimer=null;
var _dirty={};     // tracks which collections have pending changes

// Mark a collection dirty so the next save() includes it
function _markDirty(coll){ _dirty[coll]=true; }

// Flush all dirty state to IDB immediately (no debounce).
// Returns a Promise that resolves when all writes complete.
function _flushSave(){
  clearTimeout(_saveTimer);
  _saveTimer=null;
  var ops=[];
  // Collections — use syncCollection so orphaned deletes are pruned if we ever
  // fall back to this path from a dirty-tracking gap.
  if(_dirty.clients||_dirty._all)   ops.push(Store.syncCollection('clients',  ST.clients));
  if(_dirty.matters||_dirty._all)   ops.push(Store.syncCollection('matters',  ST.matters));
  if(_dirty.entries||_dirty._all)   ops.push(Store.syncCollection('entries',  ST.entries));
  if(_dirty.contacts||_dirty._all)  ops.push(Store.syncCollection('contacts', ST.contacts));
  if(_dirty.invoices||_dirty._all)  ops.push(Store.syncCollection('invoices', ST.invoices));
  // Meta — always write (cheap single-record puts)
  ops.push(Store.setMeta('prefs',ST.prefs));
  ops.push(Store.setMeta('descpresets',ST.descPresets));
  ops.push(Store.setMeta('mailpresets',ST.mailPresets));
  ops.push(Store.setMeta('mailplaceholders',ST.mailPlaceholders));
  ops.push(Store.setMeta('itmode',{itMode:ST.itMode,firmProfile:ST.firmProfile}));
  _dirty={};
  return Promise.all(ops);
}

// Debounced save — used for rapid-fire changes (e.g. settings toggles, imports).
// For single-record mutations prefer saveOne/delOne instead.
function save(){
  _dirty._all=true;  // full sync on next flush
  markLuDirty();     // bulk changes always invalidate lookup cache
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(_flushSave, 200);
}

// Immediate single-record upsert — use after saving a form (no data-loss window).
function saveOne(coll, rec){
  if(!rec||rec.id==null) return;
  _dirty[coll]=true;
  markLuDirty(); // lookup maps must be rebuilt after any record mutation
  Store.putRecord(coll, rec);
  // Also sync meta on the debounced path so prefs etc. stay consistent
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(function(){
    Store.setMeta('prefs',ST.prefs);
    Store.setMeta('descpresets',ST.descPresets);
    Store.setMeta('mailpresets',ST.mailPresets);
    Store.setMeta('mailplaceholders',ST.mailPlaceholders);
    Store.setMeta('itmode',{itMode:ST.itMode,firmProfile:ST.firmProfile});
    _dirty={};
  }, 200);
}

// Immediate single-record delete — use after confirming a delete action.
function delOne(coll, id){
  if(id==null) return;
  _dirty[coll]=true;
  markLuDirty(); // lookup maps must be rebuilt after any record deletion
  Store.deleteRecord(coll, id);
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(function(){ _dirty={}; }, 200);
}

// ── Flush immediately when tab is hidden (before browser may suspend) ──
document.addEventListener('visibilitychange', function(){
  if(document.visibilityState==='hidden' && Object.keys(_dirty).length){
    _flushSave();
  }
});

function savePrefs(){
  Store.setMeta('prefs',ST.prefs);
  applyPrefs();
}
function applyPrefs(){
  var b=document.body;
  // Dark mode: null=auto (follow system), true=always dark, false=always light
  var dm=ST.prefs.darkMode;
  var sysDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(dm===true||(dm===null&&sysDark)) b.classList.add('dark'); else b.classList.remove('dark');
  // Layout
  b.classList.remove('layout-compact','layout-comfortable','layout-spacious');
  if(ST.prefs.layout&&ST.prefs.layout!=='comfortable') b.classList.add('layout-'+ST.prefs.layout);
  // Title bar
  document.title=ST.prefs.appName||'SixMinuteLog.com';
}
// Re-apply when OS theme changes (only affects users in auto mode)
if(window.matchMedia){
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(){
    applyPrefs();
  });
}

// === TOAST
function toast(msg,type){
  type=type||'ok';
  var el=document.createElement('div');
  el.className='toast t-'+type;
  el.textContent=msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(function(){el.remove();},3000);
}

// === ICONS
var IC={
  plus:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  x:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  save:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
  edit:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
  trash:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  clock:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  users:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  brief:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
  chart:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
  doc:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  gear:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
  help:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><circle cx="12" cy="17" r="1" fill="currentColor" stroke="none"/></svg>',
  dl:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  ul:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
  rst:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>',
  usr:'<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  flash:'<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  pie:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>',
  check:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  checkLg:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
  shield:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
  xsm:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  moon:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
  sun:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
  mail:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
  list:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
  paint:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 13.5V20h6.5"/><path d="M22 13.5C22 6 17 2 12 2S2 6 2 13.5"/><circle cx="16.5" cy="20.5" r="2.5"/><path d="M16.5 18v-5"/></svg>',
  invoice:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',
  print:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>',
  scissors:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>',
  merge:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6v6m0 0v6m0-6h8m0 0l-4-4m4 4l-4 4"/></svg>',
  comment:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
  eye:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
  send:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
  copy:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>'
};

// === FIELD BUILDER
function field(label,id,o){
  o=o||{};
  var req=o.req?'<span class="req">*</span>':'';
  var ec=o.err?'err':'';
  var oninput=o.oninput?' oninput="'+o.oninput+'"':'';
  var ctrl='';
  if(o.type==='select'){
    var opts=(o.opts||[]).map(function(op){
      return '<option value="'+H(op.v)+'"'+(String(op.v)===String(o.val||'')?'selected':'')+'>'+H(op.l)+'</option>';
    }).join('');
    ctrl='<select id="'+id+'" class="'+ec+'"'+(o.dis?' disabled':'')+oninput+'>'+opts+'</select>';
  } else if(o.type==='textarea'){
    ctrl='<textarea id="'+id+'" rows="'+(o.rows||3)+'" class="'+ec+'" placeholder="'+H(o.ph||'')+'">'+H(o.val||'')+'</textarea>';
  } else if(o.pfx||o.sfx){
    var sfxHtml=o.sfx?'<span class="sfx">'+o.sfx+'</span>':'';
    var hasSfxCls=o.sfx?' has-sfx':'';
    ctrl='<div class="pw">'+(o.pfx?'<span class="pfx">'+o.pfx+'</span>':'')+sfxHtml+'<input type="'+(o.type||'text')+'" id="'+id+'" class="'+ec+hasSfxCls+'" placeholder="'+H(o.ph||'')+'" value="'+H(o.val||'')+'"'+(o.dis?' disabled':'')+oninput+' /></div>';
  } else {
    ctrl='<input type="'+(o.type||'text')+'" id="'+id+'" class="'+ec+'" placeholder="'+H(o.ph||'')+'" value="'+H(o.val||'')+'"'+(o.dis?' disabled':'')+oninput+(o.step?' step="'+o.step+'"':'')+(o.min!==undefined?' min="'+o.min+'"':'')+(o.max!==undefined?' max="'+o.max+'"':'')+' />';
  }
  return '<div class="fl"><label for="'+id+'">'+H(label)+req+'</label>'+ctrl
    +(o.err?'<div class="emsg">'+H(o.err)+'</div>':'')
    +(o.hint&&!o.err?'<div class="hint">'+o.hint+'</div>':'')
    +'</div>';
}

function stats(arr){
  return '<div class="srow">'+arr.map(function(s){
    return '<div class="sc'+(s[2]?' '+s[2]:'')+'"><div class="sc-lbl">'+H(s[0])+'</div><div class="sc-val">'+H(String(s[1]))+'</div></div>';
  }).join('')+'</div>';
}

// === VIEWS

// == Timesheet ==
function vTimesheet(){
  var role=myRole();
  var me=ST.user?ST.user.name:'';

  // Attorneys and partners see ONLY their own entries in this tab.
  // Billing staff see all entries (that's their job as hub).
  var baseEntries=(role==='billing_staff')
    ? ST.entries
    : ST.entries.filter(function(e){return e.createdBy===me;});

  var fe=filterEnt(baseEntries,ST.tsFilter);
  if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
  if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});

  var sorted=[].concat(fe).sort(function(a,b){
    if(ST.tsSort==='date-asc') return new Date(a.date)-new Date(b.date);
    if(ST.tsSort==='client'){
      var ca=_lu.cl[a.clientId],cb=_lu.cl[b.clientId];
      return ((ca&&ca.name)||'').localeCompare((cb&&cb.name)||'');
    }
    if(ST.tsSort==='hours') return Number(b.hours)-Number(a.hours);
    if(ST.tsSort==='amount') return (Number(b.hours)*Number(b.rate))-(Number(a.hours)*Number(a.rate));
    return new Date(b.date)-new Date(a.date);
  });

  var hrs=fe.reduce(function(s,e){return s+Number(e.hours);},0);
  var bill=fe.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);

  var fopts=['all','today','week','month','year'].map(function(v){
    var l={all:'All Time',today:'Today',week:'This Week',month:'This Month',year:'This Year'}[v];
    return '<option value="'+v+'"'+(ST.tsFilter===v?' selected':'')+'>'+l+'</option>';
  }).join('');

  var formH=ST.modal==='ef'?entryForm():'';

  // ── Role-specific notice bar ──────────────────────────────────────────────
  var noticeH='';
  if(role==='billing_staff'){
    noticeH='<div class="role-notice">'+IC.shield
      +' <span><strong>Billing mode:</strong> Add entries on behalf of attorneys, assign ABA codes &amp; matter numbers, then use <strong>📤 Send to Partner</strong> to export a review package for the partner\'s instance.</span></div>';
  }

  // ── Table ─────────────────────────────────────────────────────────────────
  var tableH='';
  if(sorted.length===0){
    tableH='<div class="empty"><div class="empty-ico">&#9201;</div><p>No entries yet</p>'
      +'<small>'+(role==='billing_staff'?'No entries in this time range. Use \'+ New Entry\' to add entries on behalf of an attorney.':'Click "+ New Entry" or tap ⚡ to log time.')+'</small></div>';
  } else {
    var PAGE_SIZE=ST.TS_PAGE_SIZE||50;
    var totalFiltered=sorted.length;
    var totalPages=Math.max(1,Math.ceil(totalFiltered/PAGE_SIZE));
    if(ST.tsPage>=totalPages) ST.tsPage=totalPages-1;
    if(ST.tsPage<0) ST.tsPage=0;
    var pageStart=ST.tsPage*PAGE_SIZE;
    var pageEnd=Math.min(pageStart+PAGE_SIZE,totalFiltered);
    var paginated=sorted.slice(pageStart,pageEnd);

    var rows=paginated.map(function(e){
      var cl=_lu.cl[e.clientId];
      var mt=_lu.ma[e.matterId];
      var ct=_lu.ct[e.contactId];
      var amt=Number(e.hours)*Number(e.rate);
      var est=e.status||'pending';
      var rt=ST.rowTmr;
      var isActive=rt&&String(rt.entId)===String(e.id);
      var isOther=rt&&!isActive;

      // Actions
      var canEdit=false,canDelete=false;
      if(role==='partner'){canEdit=true;canDelete=true;}
      else if(role==='attorney'){canEdit=(est==='pending');canDelete=(est==='pending');}

      var actionsH='<div class="tda">';
      if(canEdit)   actionsH+='<button onclick="A.editEnt('+e.id+')" title="Edit">'+IC.edit+'</button>';
      if(canDelete) actionsH+='<button onclick="A.delEnt('+e.id+')" title="Delete">'+IC.trash+'</button>';
      if(role==='billing_staff') actionsH+='<button onclick="A.billingEditEntry('+e.id+')" title="Add ABA code / matter number" style="color:var(--blue)">🧾</button>';
      if(role!=='billing_staff'){
        if(isActive){
          // Stop button only — the big banner handles the main UI
          actionsH+='<button onclick="A.rowTmrStop()" title="Stop timer" class="btn-ic row-tmr-stop" style="font-size:14px;padding:3px 6px;color:var(--red)">■</button>';
        } else {
          var tmrTitle=rt?'Switch timer to this entry':'Start timer for this entry';
          actionsH+='<button onclick="A.rowTmrStart('+e.id+')" title="'+tmrTitle+'" class="btn-ic" style="font-size:13px;opacity:'+(rt?'0.25':'0.65')+';padding:3px 6px">⏱</button>';
        }
      }
      actionsH+='</div>';

      var abaDisplay=e.abaCode
        ?'<span style="font-family:monospace;font-size:10px;color:var(--blue);display:block">'+H(e.abaCode)+'</span>':'';
      var mnDisplay=(mt&&mt.matterNumber)
        ?'<span style="font-family:monospace;font-size:10px;color:var(--ink3);display:block">#'+H(mt.matterNumber)+'</span>':'';
      var byCell=role==='billing_staff'
        ?'<td><span class="badge" title="'+H(e.createdBy||'')+'">'+H(e.createdByIni||'?')+'</span></td>':'';

      var trClass=isActive?'tr-active-tmr':(isOther?'tr-dimmed':'');
      return '<tr'+(trClass?' class="'+trClass+'"':'')+'>'
        +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
        +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
        +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+mnDisplay+'</td>'
        +'<td style="color:var(--ink2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+H(e.description||'')+'">'+H(e.description||'\u2014')+abaDisplay
          +(e.partnerComment?'<span title="Partner note: '+H(e.partnerComment)+'" style="margin-left:4px;font-size:11px;color:var(--amber);cursor:help">&#128172;</span>':'')
          +(e.partnerEdited?'<span title="Partner adjusted this entry" style="margin-left:2px;font-size:10px;color:var(--amber);cursor:help">✎</span>':'')
        +'</td>'
        +'<td>'+(e.rawMs!=null
          ?'<span title="Timer: '+msToHMS(e.rawMs)+'" style="cursor:help;border-bottom:1px dotted var(--ink3)">'+$h(e.hours)+'</span>'
          :$h(e.hours))
        +'</td>'
        +'<td style="color:var(--ink2)">'+$m(e.rate)+'</td>'
        +'<td style="color:var(--green);font-weight:500">'+$m(amt)+'</td>'
        +byCell
        +'<td>'+actionsH+'</td>'
        +'</tr>';
    }).join('');

    var pagCtrl='';
    if(totalPages>1){
      var btnStyle='padding:5px 12px;border:1px solid var(--border);border-radius:6px;background:var(--white);color:var(--ink);cursor:pointer;font-size:12px';
      var pagInfo='Page '+(ST.tsPage+1)+' of '+totalPages+' ('+(pageStart+1)+'–'+pageEnd+' of '+totalFiltered+')';
      pagCtrl='<div style="display:flex;align-items:center;gap:8px;padding:10px 0;justify-content:center;flex-wrap:wrap">'
        +'<button style="'+btnStyle+'" '+(ST.tsPage===0?'disabled':'')+' onclick="A.tsFirstPage()">&#8676; First</button>'
        +'<button style="'+btnStyle+'" '+(ST.tsPage===0?'disabled':'')+' onclick="A.tsPrevPage()">&#8249; Prev</button>'
        +'<span style="font-size:12px;color:var(--ink2)">'+pagInfo+'</span>'
        +'<button style="'+btnStyle+'" '+(ST.tsPage>=totalPages-1?'disabled':'')+' onclick="A.tsNextPage()">Next &#8250;</button>'
        +'<button style="'+btnStyle+'" '+(ST.tsPage>=totalPages-1?'disabled':'')+' onclick="A.tsLastPage('+(totalPages-1)+')">Last &#8677;</button>'
        +'</div>';
    }

    var thBy=role==='billing_staff'?'<th>By</th>':'';

    // Active timer banner — shown above table when a row timer is live
    var activeBanner='';
    if(ST.rowTmr){
      var rtEnt=ST.entries.find(function(x){return String(x.id)===String(ST.rowTmr.entId);});
      if(rtEnt){
        var rtCl=_lu.cl[rtEnt.clientId];
        var rtMt=_lu.ma[rtEnt.matterId];
        var whoStr=H(rtCl?rtCl.name:'Unknown client')+(rtMt?' <span style="font-weight:400;color:var(--ink2)">&#8250; '+H(rtMt.name)+'</span>':'');
        var ms0=ST.rowTmr.accMs+(Date.now()-ST.rowTmr.startMs);
        var h0=Math.floor(ms0/3600000),m0=Math.floor((ms0%3600000)/60000),s0=Math.floor((ms0%60000)/1000);
        var clockStr=String(h0).padStart(2,'0')+':'+String(m0).padStart(2,'0')+':'+String(s0).padStart(2,'0');
        activeBanner='<div class="active-tmr-banner">'
          +'<div class="atb-info">'
          +'<div class="atb-tracking"><span class="atb-dot"></span>Tracking time</div>'
          +'<div class="atb-who">'+whoStr+'</div>'
          +(rtEnt.description?'<div class="atb-desc">'+H(rtEnt.description)+'</div>':'')
          +'</div>'
          +'<div id="row-tmr-'+rtEnt.id+'" class="atb-clock">'+clockStr+'</div>'
          +'<button class="atb-stop" onclick="A.rowTmrStop()">&#9632; Stop &amp; Save</button>'
          +'</div>';
      }
    }

    tableH=activeBanner+'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Description</th><th>Hours</th><th>Rate</th><th>Amount</th>'+thBy+'<th></th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
      +pagCtrl;
  }

  var statRows=[['Total Hours',$h(hrs),''],['Total Billing',$m(bill),''],['Avg Rate',hrs>0?$m(bill/hrs):'\u2014',''],['Entries',String(fe.length),'']];
  var clFilterOpts='<option value="">All Clients</option>'+ST.clients.map(function(c){
    return '<option value="'+c.id+'"'+(ST.tsClientFilter==c.id?' selected':'')+'>'+H(c.name)+'</option>';
  }).join('');
  var availMa=ST.matters.filter(function(m){return !ST.tsClientFilter||m.clientId==ST.tsClientFilter;});
  var maFilterOpts='<option value="">All Matters</option>'+availMa.map(function(m){
    return '<option value="'+m.id+'"'+(ST.tsMatterFilter==m.id?' selected':'')+'>'+H(m.name)+'</option>';
  }).join('');
  var sortOpts=[['date-desc','Date ↓'],['date-asc','Date ↑'],['client','Client A–Z'],['hours','Hours ↓'],['amount','Amount ↓']].map(function(x){
    return '<option value="'+x[0]+'"'+(ST.tsSort===x[0]?' selected':'')+'>'+x[1]+'</option>';
  }).join('');
  var selectStyle='padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)';
  var hasExtra=(ST.tsClientFilter||ST.tsMatterFilter||ST.tsSort!=='date-desc');

  // ── Header action buttons ─────────────────────────────────────────────────
  // One clear primary action per role; no redundant alternatives in this toolbar.
  var actionBtns='';
  if(role==='attorney'){
    actionBtns+='<button class="btn btn-dk" onclick="A.openEF()">'+IC.plus+' New Entry</button>';
    if(fe.length>0)
      actionBtns+='<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Review, export, and email your timesheet to billing">📤 Submit Timesheet</button>';
  } else if(role==='partner'){
    actionBtns+='<button class="btn btn-dk" onclick="A.openEF()">'+IC.plus+' New Entry</button>';
    if(fe.length>0)
      actionBtns+='<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Send your own entries to billing">📤 Submit My Time</button>';
  } else if(role==='billing_staff'){
    actionBtns+='<button class="btn btn-dk" onclick="A.openEF()">'+IC.plus+' New Entry</button>';
    actionBtns+='<button class="btn btn-gh" onclick="A.openReceivePackage()" title="Import a timesheet submission received from an attorney">📥 Receive Submission</button>';
    if(fe.length>0)
      actionBtns+='<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Send all visible entries to partner for approval">📤 Send to Partner</button>';
  }

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">'
    +(role==='billing_staff'?'All Entries':'My Timesheet')+'</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+fe.length+' entr'+(fe.length===1?'y':'ies')
    +(ST._entriesMode==='partial'&&ST._totalEntryCount>ST.entries.length
      ?' <span title="Showing this year. Select All Time to load full history." style="color:var(--amber);cursor:help">('+ST._totalEntryCount+' total — partial)</span>':'')
    +'</p></div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap">'+actionBtns+'</div></div>'
    +'<div class="ts-filters" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<select onchange="A.setTsF(this.value)" style="'+selectStyle+'">'+fopts+'</select>'
    +(ST.clients.length>0?'<select onchange="A.setTsClF(this.value)" style="'+selectStyle+'">'+clFilterOpts+'</select>':'')
    +(ST.matters.length>0?'<select onchange="A.setTsMaF(this.value)" style="'+selectStyle+'">'+maFilterOpts+'</select>':'')
    +'<select onchange="A.setTsSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(hasExtra?'<button class="btn btn-gh" onclick="A.clearTsFilters()" style="font-size:12px;padding:7px 12px">✕ Clear</button>':'')
    +'</div>'
    +noticeH
    +stats(statRows)
    +formH+tableH+'</div>';
}

function entryForm(){
  var role=myRole();
  var f=ST.ef;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var avMat=ST.matters.filter(function(m){return m.clientId==f.clientId;});
  var maOpts=[{v:'',l:'General work'}].concat(avMat.map(function(m){return{v:m.id,l:m.name};}));
  var ctOpts=[{v:'',l:'Select team member...'}].concat(ST.contacts.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  var matHint=!f.clientId?'Select a client first':(avMat.length===0?'No matters for this client':'');
  var existingStatus=ST.editId?(ST.entries.find(function(e){return e.id==ST.editId;})||{}).status||'pending':null;
  var statusNotice='';
  if(existingStatus==='approved'){
    statusNotice='<div class="good" style="margin-bottom:14px">'+IC.check+' This entry has been <strong>approved</strong> (imported from a review package). Edits will reset it to pending.</div>';
  } else if(existingStatus==='rejected'){
    statusNotice='<div class="danger" style="margin-bottom:14px">This entry was <strong>rejected</strong>. Edit the entry and export an updated package for review.</div>';
  }
  // Billing staff: "Logged By" attorney/timekeeper selector
  // Attorney/partner: no such field — entry always attributed to themselves
  var byRow='';
  if(role==='billing_staff'){
    var tkOpts=[{v:'',l:'Select attorney / timekeeper...'}].concat(
      ST.contacts
        .filter(function(c){
          var r=(c.role||'').toLowerCase();
          return r.indexOf('attorney')!==-1||r.indexOf('partner')!==-1||r.indexOf('associate')!==-1||r.indexOf('counsel')!==-1;
        })
        .map(function(c){return{v:c.id,l:c.name+(c.role?' \u2013 '+c.role:'')};})
    );
    byRow='<div class="frow c2">'+field('Attorney / Timekeeper','ef-by',{type:'select',opts:tkOpts,val:String(f.byContactId||''),req:true,err:f.errs&&f.errs.by,hint:'Entry will be attributed to this timekeeper'})+'<div></div></div>';
  }
  return '<div class="fbox" id="ef">'
    +'<h3>'+(ST.editId?'Edit Entry':'New Time Entry')+(role==='billing_staff'?' <span class="badge" style="font-size:10px;background:var(--amber);color:#fff;font-weight:500;margin-left:6px;vertical-align:middle">Billing Entry</span>':'')+'</h3>'
    +statusNotice
    +byRow
    +'<div class="frow c2">'+field('Date','ef-d',{type:'date',val:f.date||today(),req:true,err:f.errs&&f.errs.d})+field('Hours','ef-h',{type:'number',ph:'1.0',val:f.hours||'',req:true,err:f.errs&&f.errs.h,hint:'e.g. 1.5 or 0.25',step:'0.01',min:'0.01'})+'</div>'
    +'<div class="frow c2">'+field('Client','ef-cl',{type:'select',opts:clOpts,val:f.clientId||'',req:true,err:f.errs&&f.errs.cl})+field('Matter','ef-ma',{type:'select',opts:maOpts,val:f.matterId||'',hint:matHint})+'</div>'
    +(role==='billing_staff'
      ?'<div class="frow">'+field('Rate ($/hr)','ef-r',{pfx:'$',ph:'Auto from attorney schedule',val:f.rate||'',err:f.errs&&f.errs.r,hint:total?'Total: '+total+'. Auto-filled from attorney rate schedule on entry date':'Auto-filled from attorney rate schedule on entry date'})+'</div>'
      :'<div class="frow c2">'+field('Team Member','ef-ct',{type:'select',opts:ctOpts,val:f.contactId||''})+field('Rate ($/hr)','ef-r',{pfx:'$',ph:'Auto from attorney schedule',val:f.rate||'',err:f.errs&&f.errs.r,hint:total?'Total: '+total+'. Priority: Matter-attorney > Client-attorney > Attorney schedule':'Priority: Matter-attorney > Client-attorney > Attorney schedule'})+'</div>')
    +'<div class="frow c2">'+field('ABA/UTBMS Code','ef-aba',{type:'select',opts:ABA_TASK_CODES,val:f.abaCode||'',hint:'Optional task code for billing compliance'})+'<div></div></div>'
    +'<div class="frow">'+field('Description','ef-desc',{type:'textarea',rows:2,ph:'Describe the work performed...',val:f.description||''})+'</div>'
    +(ST.descPresets.length>0?'<div class="desc-chips"><span style="font-size:11px;color:var(--ink3);margin-right:4px">Suggestions:</span>'+ST.descPresets.map(function(p,i){return '<button type="button" class="desc-chip" onclick="A.pickDesc(\'ef-desc\','+i+')">'+ H(p)+'</button>';}).join('')+'</div>':'')
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveEnt()">'+IC.save+' Save Entry</button></div>'
    +'</div>';
}


// == Clients ==
function vClients(){
  var formH=ST.modal==='cf'?clientForm():'';
  var cardsH='';
  var list=ST.clients;
  // Search
  if(ST.clSearch) list=list.filter(function(c){var s=ST.clSearch.toLowerCase();return c.name.toLowerCase().indexOf(s)!==-1||(c.email&&c.email.toLowerCase().indexOf(s)!==-1);});
  // Sort
  list=[].concat(list).sort(function(a,b){
    if(ST.clSort==='matters'){
      var mc=function(c){return ST.matters.filter(function(m){return m.clientId==c.id;}).length;};
      return mc(b)-mc(a);
    }
    if(ST.clSort==='rate') return 0;
    return a.name.localeCompare(b.name); // alpha
  });
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var sortOpts=[['alpha','Name A\u2013Z'],['matters','Most Matters']].map(function(x){return '<option value="'+x[0]+'"'+(ST.clSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  if(ST.clients.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128188;</div><p>No clients yet</p><small>Add your first client to get started</small></div>';
  } else if(list.length===0){
    cardsH='<div class="empty"><p>No clients match your search</p></div>';
  } else {
    cardsH='<div class="cgrid">'+list.map(function(c){
      // Support both legacy contactId and new contactIds[]
      var ctIds=c.contactIds&&c.contactIds.length?c.contactIds:(c.contactId?[c.contactId]:[]);
      var linkedCts=ctIds.map(function(id){return _lu.ct[id];}).filter(Boolean);
      var cppl=c.clientPeople&&c.clientPeople.length?c.clientPeople:[];
      // Find most recent approved invoice for this client
      var clientInvs=(ST.invoices||[]).filter(function(i){return i.clientId==c.id&&i.status==='approved';});
      clientInvs.sort(function(a,b){return b.id-a.id;});
      var latestApproved=clientInvs[0]||null;
      return '<div class="card">'
        +'<div class="card-hd"><div class="avatar">'+H(c.name.charAt(0).toUpperCase())+'</div>'
        +'<div class="card-act">'
        +(latestApproved?'<button onclick="A.emailInvoice('+latestApproved.id+')" title="Email latest invoice to client" style="color:var(--blue)">'+IC.mail+'</button>':'')
        +'<button onclick="A.editCl('+c.id+')" title="Edit">'+IC.edit+'</button><button onclick="A.delCl('+c.id+')" title="Delete">'+IC.trash+'</button></div></div>'
        +'<h3>'+H(c.name)+'</h3>'
        +(c.email?'<p style="font-size:12px">'+mailLink(c.email)+'</p>':'')
        +(c.phone?'<p style="font-size:12px">'+telLink(c.phone)+'</p>':'')
        +(cppl.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Client Contacts</div>'
          +cppl.map(function(p){return '<div style="font-size:12px;padding:2px 0"><strong>'+H(p.name)+'</strong>'+(p.role?' <span style="color:var(--ink3)">&middot; '+H(p.role)+'</span>':'')+(p.email?'<br>'+mailLink(p.email,'color:var(--ink2);'):'')+(p.phone?'<span style="color:var(--ink3);font-size:11px"> '+telLink(p.phone)+'</span>':'')+'</div>';}).join('')+'</div>':'')
        +(linkedCts.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Firm Team</div>'
          +linkedCts.map(function(ct){return '<p style="font-size:12px;margin:2px 0">&#128203; '+H(ct.name)+(ct.role?' <span style="color:var(--ink3)">&middot; '+H(ct.role)+'</span>':'')+(ct.email?'<br><span style="padding-left:18px">'+mailLink(ct.email,'color:var(--ink2);font-size:11px;')+'</span>':'')+(ct.phone?' '+telLink(ct.phone,'color:var(--ink3);font-size:11px;'):'')+'</p>';}).join('')+'</div>':'')
        +((c.attorneyRates&&c.attorneyRates.length)?'<div class="card-rate" style="color:var(--blue)">'+c.attorneyRates.length+' negotiated attorney rate'+(c.attorneyRates.length!==1?'s':'')+'</div>':'')
        +'<div class="card-rate" style="border-top:none;padding-top:0;margin-top:6px">'
        +(function(){var mc=ST.matters.filter(function(m){return m.clientId==c.id;}).length;return '<span style="color:var(--ink3)">'+mc+' matter'+(mc!==1?'s':'')+'</span>';})()
        +'</div>'
        +'</div>';
    }).join('')+'</div>';
  }
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Clients</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+list.length+' of '+ST.clients.length+' client'+(ST.clients.length!==1?'s':'')+'</p></div>'
    +'<button class="btn btn-dk" onclick="A.openCF()">'+IC.plus+' Add Client</button>'
    +'</div>'
    +(ST.clients.length>1?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="cl-search" type="text" value="'+H(ST.clSearch||'')+'" oninput="A.setClSearch(this.value)" placeholder="Search clients..." style="'+selectStyle+';min-width:160px">'
    +'<select onchange="A.setClSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(ST.clSearch?'<button class="btn btn-gh" onclick="A.setClSearch(\'\')" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function clientForm(){
  var f=ST.cf;
  var selIds=f.contactIds||((f.contactId&&f.contactId!='')?[Number(f.contactId)]:[]);
  // Firm contacts not yet added
  var available=ST.contacts.filter(function(c){return !selIds.some(function(id){return id==c.id;});});
  var ctOpts=[{v:'',l:'Add team member...'}].concat(available.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  // Firm contact chips
  var chipsH=selIds.length===0?''
    :selIds.map(function(id){
        var c=_lu.ct[id];
        if(!c) return '';
        return '<span style="display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px 3px 8px;font-size:12px;margin:2px">'
          +'<span class="avatar" style="width:18px;height:18px;font-size:9px;flex-shrink:0">'+H(c.name.charAt(0).toUpperCase())+'</span>'
          +H(c.name)+(c.role?'<span style="color:var(--ink3)"> &middot; '+H(c.role)+'</span>':'')
          +(c.isUser?'<span style="font-size:10px;font-weight:600;color:var(--blue)">You</span>':'')
          +'<button type="button" onclick="A.cfRemCt('+id+')" style="background:none;border:none;cursor:pointer;padding:0;line-height:1;color:var(--ink3);font-size:14px;margin-left:2px" title="Remove">&times;</button>'
          +'</span>';
      }).join('');
  var chipsRow=selIds.length>0?'<div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:4px">'+chipsH+'</div>':'';
  // Client-side people chips
  var cppl=f.clientPeople||[];
  var ppChips=cppl.length===0?''
    :'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">'+cppl.map(function(p,i){
        return '<span style="display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px 3px 8px;font-size:12px">'
          +'<span class="avatar" style="width:18px;height:18px;font-size:9px;background:#7c3aed;color:#fff;flex-shrink:0">'+H(p.name.charAt(0).toUpperCase())+'</span>'
          +H(p.name)+(p.role?'<span style="color:var(--ink3)"> &middot; '+H(p.role)+'</span>':'')
          +(p.email?'<span style="color:var(--ink2);font-size:11px"> '+mailLink(p.email)+'</span>':'')
          +'<button type="button" onclick="A.cfRemPerson('+i+')" style="background:none;border:none;cursor:pointer;padding:0;line-height:1;color:var(--ink3);font-size:14px;margin-left:2px" title="Remove">&times;</button>'
          +'</span>';
      }).join('')+'</div>';
  var np=f.newPerson||{};
  return '<div class="fbox" id="cf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Client</h3>'
    +'<div class="frow">'+field('Client Name','cf-n',{ph:'Acme Corp',val:f.name||'',req:true,err:f.errs&&f.errs.n})+'</div>'
    +'<div class="frow c2">'+field('Email','cf-e',{type:'email',ph:'billing@acme.com',val:f.email||'',err:f.errs&&f.errs.e})+field('Phone','cf-p',{type:'tel',ph:'(555) 123-4567',val:f.phone||'',oninput:"A.livePhone('cf-p')"})+'</div>'
    +'<div class="frow">'+field('Firm Team','cf-ct',{type:'select',opts:ctOpts,val:'',hint:'Assign firm contacts to this client'})+'</div>'
    +(chipsRow?'<div class="frow" style="padding-top:0;margin-top:-8px"><div>'+chipsRow+'</div></div>':'')
    // Client-side contacts section
    +'<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
    +'<div style="font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:10px">Client-Side Contacts <span style="font-size:11px;font-weight:400;color:var(--ink3)">(owner, HR, billing, etc.)</span></div>'
    +ppChips
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px">'
    +'<div class="fl"><label style="font-size:11px">Name</label><input type="text" id="cf-pn" placeholder="Jane Smith" value="'+H(np.name||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Role / Title</label><input type="text" id="cf-pro" placeholder="Head of HR" value="'+H(np.role||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Email</label><input type="email" id="cf-pe" placeholder="jane@acme.com" value="'+H(np.email||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Phone</label><input type="tel" id="cf-pp" placeholder="(555) 123-4567" value="'+H(np.phone||'')+'" oninput="A.livePhone(\'cf-pp\')" style="width:100%"></div>'
    +'</div>'
    +'<button type="button" class="btn btn-gh" style="font-size:12px;padding:6px 14px" onclick="A.cfAddPerson()">+ Add Contact</button>'
    +'</div></div>'
    // Per-attorney negotiated rates section
    +(function(){
      var ar=f.attorneyRates||[];
      var atOpts='<option value="">Select attorney…</option>'+ST.contacts.map(function(c){return '<option value="'+c.id+'">'+H(c.name)+(c.role?' – '+H(c.role):'')+'</option>';}).join('');
      var arRows=ar.length===0
        ?'<tr><td colspan="5" style="text-align:center;padding:8px;color:var(--ink3);font-size:11px">No per-attorney rates yet. Attorneys default to their own rate schedule.</td></tr>'
        :ar.map(function(r,i){
            var ct=ST.contacts.find(function(c){return c.id==r.contactId;});
            return '<tr>'
              +'<td style="font-weight:500">'+H(ct?ct.name:'?')+'</td>'
              +'<td><strong>'+$m(r.rate)+'/hr</strong></td>'
              +'<td>'+r.effectiveDate+'</td>'
              +'<td style="color:var(--ink3)">'+H(r.note||'')+'</td>'
              +'<td style="text-align:right"><button type="button" class="btn-ic" style="padding:2px 6px;font-size:11px" onclick="A.cfRemAtRate('+i+')" title="Remove">&#10005;</button></td>'
              +'</tr>';
          }).join('');
      return '<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
        +'<div class="rate-section-hd"><h4>Negotiated Attorney Rates</h4><small>Override default attorney rates for this client</small></div>'
        +'<p style="font-size:11px;color:var(--ink3);margin-bottom:8px">When this client is selected, the rate below takes precedence over the attorney\'s own rate schedule. A more specific matter-level rate overrides this.</p>'
        +'<table class="rate-hist-table"><thead><tr><th>Attorney</th><th>Rate</th><th>Effective Date</th><th>Note</th><th></th></tr></thead><tbody>'+arRows+'</tbody></table>'
        +'<div style="margin-top:10px"><div style="font-size:11px;font-weight:600;color:var(--ink3);margin-bottom:5px">Add negotiated rate:</div>'
        +'<div style="display:grid;grid-template-columns:2fr 1fr 1fr 2fr auto;gap:6px;align-items:end">'
        +'<div class="fl"><label style="font-size:11px">Attorney</label><select id="cf-ar-ct" style="width:100%;padding:4px 7px;border:1px solid var(--border);border-radius:5px;font-size:12px;background:var(--white);color:var(--ink)">'+atOpts+'</select></div>'
        +'<div class="fl"><label style="font-size:11px">Rate ($/hr)</label><input type="number" id="cf-ar-rate" placeholder="200.00" min="0" step="0.01" style="width:100%"></div>'
        +'<div class="fl"><label style="font-size:11px">Effective Date</label><input type="date" id="cf-ar-date" value="'+today()+'" style="width:100%"></div>'
        +'<div class="fl"><label style="font-size:11px">Note</label><input type="text" id="cf-ar-note" placeholder="Insurance cap, negotiated…" style="width:100%"></div>'
        +'<button type="button" class="btn btn-gh" style="padding:6px 12px;font-size:12px;white-space:nowrap" onclick="A.cfAddAtRate()">+ Add</button>'
        +'</div></div>'
        +'</div></div>';
    })()
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveCl()">'+IC.save+' Save Client</button></div>'
    +'</div>';
}

// == Matters ==
function vMatters(){
  var formH=ST.modal==='mf'?matterForm():'';
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var clFilterOpts='<option value="">All Clients</option>'+ST.clients.map(function(c){return '<option value="'+c.id+'"'+(ST.maClientFilter==c.id?' selected':'')+'>'+H(c.name)+'</option>';}).join('');
  var sortOpts=[['alpha','Name A\u2013Z'],['client','Client A\u2013Z']].map(function(x){return '<option value="'+x[0]+'"'+(ST.maSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  var cardsH='';
  if(ST.matters.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128193;</div><p>No matters yet</p><small>'+(ST.clients.length===0?'Add a client first, then create matters':'Add your first matter')+'</small></div>';
  } else {
    // Apply filters
    var list=ST.matters;
    if(ST.maClientFilter) list=list.filter(function(m){return m.clientId==ST.maClientFilter;});
    if(ST.maSearch) list=list.filter(function(m){var s=ST.maSearch.toLowerCase();return m.name.toLowerCase().indexOf(s)!==-1||(m.description&&m.description.toLowerCase().indexOf(s)!==-1);});
    // Sort
    list=[].concat(list).sort(function(a,b){
      if(ST.maSort==='client'){
        var ca=_lu.cl[a.clientId];
        var cb=_lu.cl[b.clientId];
        var cn=((ca&&ca.name)||'').localeCompare((cb&&cb.name)||'');
        if(cn!==0) return cn;
        return a.name.localeCompare(b.name);
      }
      if(ST.maSort==='rate') return 0;
      return a.name.localeCompare(b.name);
    });
    if(list.length===0){
      cardsH='<div class="empty"><p>No matters match your filters</p></div>';
    } else if(ST.maGroup){
      // Grouped by client
      var groups={};var gOrder=[];
      list.forEach(function(m){
        var key=m.clientId||'__none__';
        if(!groups[key]){groups[key]=[];gOrder.push(key);}
        groups[key].push(m);
      });
      cardsH=gOrder.map(function(key){
        var cl=_lu.cl[key];
        var gName=cl?H(cl.name):'<em>No Client</em>';
        var cards=groups[key].map(function(m){return matterCard(m);}).join('');
        return '<div style="margin-bottom:18px">'
          +'<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:8px;display:flex;align-items:center;gap:8px">'
          +'<span style="flex:1;height:1px;background:var(--border-l)"></span>'
          +'<span>'+gName+'</span>'
          +'<span style="flex:1;height:1px;background:var(--border-l)"></span>'
          +'</div>'
          +'<div class="cgrid">'+cards+'</div>'
          +'</div>';
      }).join('');
    } else {
      cardsH='<div class="cgrid">'+list.map(function(m){return matterCard(m);}).join('')+'</div>';
    }
  }
  var addBtn=ST.clients.length>0
    ?'<button class="btn btn-dk" onclick="A.openMF()">'+IC.plus+' Add Matter</button>'
    :'<span style="font-size:13px;color:var(--amber);background:#fffbeb;padding:8px 14px;border-radius:8px;border:1px solid #fde68a">Add a client first</span>';
  var hasFilters=(ST.maClientFilter||ST.maSearch||ST.maSort!=='alpha'||ST.maGroup);
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Matters</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+ST.matters.length+' matter'+(ST.matters.length!==1?'s':'')+'</p></div>'
    +addBtn+'</div>'
    +(ST.matters.length>0?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="ma-search" type="text" value="'+H(ST.maSearch||'')+'" oninput="A.setMaSearch(this.value)" placeholder="Search matters..." style="'+selectStyle+';min-width:160px">'
    +(ST.clients.length>1?'<select onchange="A.setMaClF(this.value)" style="'+selectStyle+'">'+clFilterOpts+'</select>':'')
    +'<select onchange="A.setMaSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +'<label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;padding:7px 11px;border:1px solid var(--border);border-radius:8px;background:'+(ST.maGroup?'var(--bg)':'var(--white)')+'"><input type="checkbox" '+(ST.maGroup?'checked':'')+' onchange="A.toggleMaGroup()" style="margin:0"> Group by Client</label>'
    +(hasFilters?'<button class="btn btn-gh" onclick="A.clearMaFilters()" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function matterCard(m){
  var cl=_lu.cl[m.clientId];
  var ct=_lu.ct[m.contactId];
  // Resolve linked client-side people (with full detail including phone)
  var linkedPeople=[];
  if(m.linkedClientPeopleIds&&m.linkedClientPeopleIds.length&&cl&&cl.clientPeople){
    linkedPeople=m.linkedClientPeopleIds.map(function(pid){
      return cl.clientPeople.find(function(p){return p.id==pid;});
    }).filter(Boolean);
  }
  // Resolve all firm team contacts (support contactIds[] array + legacy contactId)
  var ctIds=m.contactIds&&m.contactIds.length?m.contactIds:(m.contactId?[m.contactId]:[]);
  var linkedCts=ctIds.map(function(id){return _lu.ct[id];}).filter(Boolean);
  return '<div class="card">'
    +'<div class="card-hd"><span class="chip">'+H(cl?cl.name:'Unknown')+'</span>'
    +'<div class="card-act"><button onclick="A.editMa('+m.id+')" title="Edit">'+IC.edit+'</button><button onclick="A.delMa('+m.id+')" title="Delete">'+IC.trash+'</button></div></div>'
    +'<h3>'+H(m.name)+(m.matterNumber?' <span style="font-size:11px;font-weight:400;color:var(--blue);background:var(--blue-pale);padding:2px 7px;border-radius:10px;font-family:monospace">#'+H(m.matterNumber)+'</span>':'')+'</h3>'
    +(m.description?'<p style="color:var(--ink3);font-size:12px;margin-bottom:4px">'+H(m.description)+'</p>':'')
    +(linkedPeople.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Client Contacts</div>'
      +linkedPeople.map(function(p){return '<div style="font-size:12px;padding:2px 0"><strong>'+H(p.name)+'</strong>'+(p.role?' <span style="color:var(--ink3)">&middot; '+H(p.role)+'</span>':'')+(p.email?'<br>'+mailLink(p.email,'color:var(--ink2);'):'')+(p.phone?'<span style="color:var(--ink3);font-size:11px"> '+telLink(p.phone)+'</span>':'')+'</div>';}).join('')
      +'</div>':'')
    +(linkedCts.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Firm Team</div>'
      +linkedCts.map(function(fct){return '<p style="font-size:12px;margin:2px 0">&#128203; '+H(fct.name)+(fct.role?'<span style="color:var(--ink3)"> &middot; '+H(fct.role)+'</span>':'')+(fct.email?'<br><span style="padding-left:18px">'+mailLink(fct.email,'color:var(--ink2);font-size:11px;')+'</span>':'')+(fct.phone?' '+telLink(fct.phone,'color:var(--ink3);font-size:11px;'):'')+'</p>';}).join('')
      +'</div>':(!ct?'':'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Lead Attorney</div><p style="font-size:12px;margin:2px 0">&#128203; '+H(ct.name)+(ct.role?'<span style="color:var(--ink3)"> &middot; '+H(ct.role)+'</span>':'')+(ct.email?'<br><span style="padding-left:18px">'+mailLink(ct.email,'color:var(--ink2);font-size:11px;')+'</span>':'')+(ct.phone?' '+telLink(ct.phone,'color:var(--ink3);font-size:11px;'):'')+'</p></div>'))
    +((m.attorneyRates&&m.attorneyRates.length)?'<div class="card-rate" style="color:var(--blue)">'+m.attorneyRates.length+' attorney-specific rate'+(m.attorneyRates.length!==1?'s':'')+'</div>':'')
    +'</div>';
}

function matterForm(){
  var f=ST.mf;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var ctOpts=[{v:'',l:'None'}].concat(ST.contacts.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  var selCl=ST.clients.find(function(c){return c.id==f.clientId;});
  // Client-side people for the selected client
  var cppl=selCl&&selCl.clientPeople&&selCl.clientPeople.length?selCl.clientPeople:[];
  var linkedIds=f.linkedClientPeopleIds||[];
  var cpSection='';
  if(f.clientId&&cppl.length){
    var pChips=cppl.map(function(p){
      var pid=p.id;
      var sel=linkedIds.some(function(x){return x==pid;});
      return '<button type="button" onclick="A.mfToggleClientPerson('+pid+')" style="display:inline-flex;align-items:center;gap:5px;border-radius:20px;padding:4px 11px 4px 8px;font-size:12px;cursor:pointer;border:1px solid '+(sel?'var(--blue)':'var(--border)')+';background:'+(sel?'rgba(37,99,235,.09)':'var(--white)')+';color:'+(sel?'var(--blue)':'var(--ink)')+';transition:all .15s">'
        +'<span style="width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:'+(sel?'var(--blue)':'#7c3aed')+';color:#fff;flex-shrink:0">'+H(p.name.charAt(0).toUpperCase())+'</span>'
        +H(p.name)+(p.role?'<span style="color:var(--ink3)"> &middot; '+H(p.role)+'</span>':'')
        +(sel?'<span style="font-size:14px;line-height:1;margin-left:2px;color:var(--blue)">&#10003;</span>':'')
        +'</button>';
    }).join('');
    cpSection='<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
      +'<div style="font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:8px">Client-Side Contacts <span style="font-size:11px;font-weight:400;color:var(--ink3)">linked to this matter</span></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:6px">'+pChips+'</div>'
      +(linkedIds.length?'<p style="font-size:11px;color:var(--ink3);margin-top:6px">'+linkedIds.length+' contact'+(linkedIds.length!==1?'s':'')+' linked</p>':'<p style="font-size:11px;color:var(--ink3);margin-top:6px">Click to link contacts from this client</p>')
      +'</div></div>';
  } else if(f.clientId&&!cppl.length){
    cpSection='<div class="frow"><p class="note" style="font-size:12px;width:100%;margin:0">No client-side contacts on this client yet. <a onclick="A.editCl('+f.clientId+');return false;" href="#" style="color:var(--blue)">Edit the client</a> to add contacts first.</p></div>';
  }
  return '<div class="fbox" id="mf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Matter</h3>'
    +'<div class="frow c2">'+field('Matter Name','mf-n',{ph:'Contract Review',val:f.name||'',req:true,err:f.errs&&f.errs.n})+field('Client','mf-cl',{type:'select',opts:clOpts,val:f.clientId||'',req:true,err:f.errs&&f.errs.cl})+'</div>'
    +'<div class="frow c2">'+field('Matter Number','mf-num',{ph:'e.g. 2024-001 or 12345',val:f.matterNumber||'',hint:'Firm-assigned matter number for billing/invoice reference'})+field('Lead Attorney','mf-ct',{type:'select',opts:ctOpts,val:f.contactId||''})+'</div>'
    +'<div class="frow">'+field('Description','mf-desc',{type:'textarea',rows:2,ph:'Brief description of this matter...',val:f.description||''})+'</div>'
    +cpSection
    // Per-attorney rates for this matter
    +(function(){
      var ar=f.attorneyRates||[];
      var atOpts='<option value="">Select attorney…</option>'+ST.contacts.map(function(c){return '<option value="'+c.id+'">'+H(c.name)+(c.role?' – '+H(c.role):'')+'</option>';}).join('');
      var arRows=ar.length===0
        ?'<tr><td colspan="5" style="text-align:center;padding:8px;color:var(--ink3);font-size:11px">No matter-specific attorney rates. Add a rate to override the client-level rate for a specific attorney on this matter.</td></tr>'
        :ar.map(function(r,i){
            var ct=ST.contacts.find(function(c){return c.id==r.contactId;});
            return '<tr>'
              +'<td style="font-weight:500">'+H(ct?ct.name:'?')+'</td>'
              +'<td><strong>'+$m(r.rate)+'/hr</strong></td>'
              +'<td>'+r.effectiveDate+'</td>'
              +'<td style="color:var(--ink3)">'+H(r.note||'')+'</td>'
              +'<td style="text-align:right"><button type="button" class="btn-ic" style="padding:2px 6px;font-size:11px" onclick="A.mfRemAtRate('+i+')" title="Remove">&#10005;</button></td>'
              +'</tr>';
          }).join('');
      return '<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
        +'<div class="rate-section-hd"><h4>Matter-Specific Attorney Rates</h4><small>Highest priority — overrides client &amp; attorney schedule</small></div>'
        +'<p style="font-size:11px;color:var(--ink3);margin-bottom:8px">E.g. insurance defense matters cap attorney rates at a specific amount.</p>'
        +'<table class="rate-hist-table"><thead><tr><th>Attorney</th><th>Rate</th><th>Effective Date</th><th>Note</th><th></th></tr></thead><tbody>'+arRows+'</tbody></table>'
        +'<div style="margin-top:10px"><div style="font-size:11px;font-weight:600;color:var(--ink3);margin-bottom:5px">Add matter-specific rate:</div>'
        +'<div style="display:grid;grid-template-columns:2fr 1fr 1fr 2fr auto;gap:6px;align-items:end">'
        +'<div class="fl"><label style="font-size:11px">Attorney</label><select id="mf-ar-ct" style="width:100%;padding:4px 7px;border:1px solid var(--border);border-radius:5px;font-size:12px;background:var(--white);color:var(--ink)">'+atOpts+'</select></div>'
        +'<div class="fl"><label style="font-size:11px">Rate ($/hr)</label><input type="number" id="mf-ar-rate" placeholder="150.00" min="0" step="0.01" style="width:100%"></div>'
        +'<div class="fl"><label style="font-size:11px">Effective Date</label><input type="date" id="mf-ar-date" value="'+today()+'" style="width:100%"></div>'
        +'<div class="fl"><label style="font-size:11px">Note</label><input type="text" id="mf-ar-note" placeholder="Insurance cap, agreement…" style="width:100%"></div>'
        +'<button type="button" class="btn btn-gh" style="padding:6px 12px;font-size:12px;white-space:nowrap" onclick="A.mfAddAtRate()">+ Add</button>'
        +'</div></div>'
        +'</div></div>';
    })()
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveMa()">'+IC.save+' Save Matter</button></div>'
    +'</div>';
}

// == Contacts ==
function vContacts(){
  var formH=ST.modal==='ctf'?contactForm():'';
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var sortOpts=[['alpha','Name A\u2013Z'],['role','Role A\u2013Z'],['rate','Rate \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.ctSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  var cardsH='';
  if(ST.contacts.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128100;</div><p>No contacts yet</p><small>Add team members to track who worked on what</small></div>';
  } else {
    var list=ST.contacts;
    if(ST.ctSearch) list=list.filter(function(c){var s=ST.ctSearch.toLowerCase();return c.name.toLowerCase().indexOf(s)!==-1||(c.role&&c.role.toLowerCase().indexOf(s)!==-1)||(c.email&&c.email.toLowerCase().indexOf(s)!==-1);});
    list=[].concat(list).sort(function(a,b){
      if(ST.ctSort==='role') return ((a.role||'')).localeCompare((b.role||''));
      if(ST.ctSort==='rate') return Number(b.rate||0)-Number(a.rate||0);
      return a.name.localeCompare(b.name);
    });
    if(list.length===0){
      cardsH='<div class="empty"><p>No contacts match your search</p></div>';
    } else {
      cardsH='<div class="cgrid">'+list.map(function(c){
        var pct=c.ownPct!=null?Number(c.ownPct):100;
        var firmPct=100-pct;
        var isMe=!!c.isUser;
        return '<div class="card">'
          +'<div class="card-hd"><div class="avatar avatar-dark">'+H(c.name.charAt(0).toUpperCase())+'</div>'
          +'<div class="card-act">'+(isMe?'<span style="font-size:11px;font-weight:600;color:var(--blue);background:rgba(37,99,235,.1);padding:2px 8px;border-radius:10px;margin-right:4px">You</span>':'')+'<button onclick="A.editCt('+c.id+')" title="Edit">'+IC.edit+'</button>'+(isMe?'':'<button onclick="A.delCt('+c.id+')" title="Delete">'+IC.trash+'</button>')+'</div></div>'
          +'<h3>'+H(c.name)+'</h3>'
          +(c.role?'<p style="color:var(--ink2)">'+H(c.role)+'</p>':'')
          +(c.email?'<p>'+mailLink(c.email,'font-size:13px;')+'</p>':'')
          +(c.phone?'<p>'+telLink(c.phone,'font-size:13px;')+'</p>':'')
          +(ST.prefs.revenueSplit?'<div class="split-pill"><span class="own">Own '+pct+'%</span><span class="firm">Firm '+firmPct+'%</span></div>':'')
          +(ST.prefs.revenueSplit&&c.salary!=null&&c.salary!==''?'<div class="card-rate">Salary <strong>'+$m(c.salary)+'/yr</strong></div>':'')
          +(c.rate?'<div class="card-rate">Rate <strong>'+$m(c.rate)+'/hr</strong></div>':'')
          +((c.rateHistory&&c.rateHistory.length)?'<div class="card-rate" style="color:var(--blue)">'+c.rateHistory.length+' rate schedule entr'+(c.rateHistory.length!==1?'ies':'y')+'</div>':'')
          +'</div>';
      }).join('')+'</div>';
    }
  }
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Team Contacts</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+ST.contacts.length+' contact'+(ST.contacts.length!==1?'s':'')+'</p></div>'
    +'<button class="btn btn-dk" onclick="A.openCTF()">'+IC.plus+' Add Contact</button>'
    +'</div>'
    +(ST.contacts.length>1?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="ct-search" type="text" value="'+H(ST.ctSearch||'')+'" oninput="A.setCtSearch(this.value)" placeholder="Search contacts..." style="'+selectStyle+';min-width:160px">'
    +'<select onchange="A.setCtSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(ST.ctSearch?'<button class="btn btn-gh" onclick="A.setCtSearch(\'\')" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function contactForm(){
  var f=ST.ctf;
  var pct=f.ownPct!=null?f.ownPct:100;
  var rh=f.rateHistory||[];
  // Current rate: derived from rate history (latest effective) or from .rate field
  var latestHistRate=_rateOnDate(rh,today());

  // Rate history table rows
  var rhRows=rh.length===0
    ?'<tr><td colspan="4" style="text-align:center;padding:10px;color:var(--ink3);font-size:11px">No rate history entries. Add entries to track rate changes over time, or use the Default Rate field for a simple single rate.</td></tr>'
    :rh.slice().sort(function(a,b){return a.effectiveDate<b.effectiveDate?1:-1;}).map(function(r,i){
        var isCur=latestHistRate&&Number(r.rate)===latestHistRate&&r.effectiveDate===rh.slice().sort(function(a,b){return a.effectiveDate<b.effectiveDate?1:-1;})[0].effectiveDate;
        return '<tr>'
          +'<td><strong>'+$m(r.rate)+'</strong>'+(isCur?'&nbsp;<span class="rate-cur-badge">current</span>':'')+'</td>'
          +'<td>'+r.effectiveDate+'</td>'
          +'<td style="color:var(--ink3)">'+H(r.note||'')+'</td>'
          +'<td style="text-align:right"><button type="button" class="btn-ic" style="padding:2px 6px;font-size:11px" onclick="A.ctfRemRate('+i+')" title="Remove">&#10005;</button></td>'
          +'</tr>';
      }).join('');

  var rateSection='<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
    +'<div class="rate-section-hd"><h4>Rate History</h4><small>Most-recent-on-entry-date wins</small></div>'
    +(latestHistRate?'<p style="font-size:12px;margin-bottom:8px;color:var(--ink2)">Current rate: <strong>'+$m(latestHistRate)+'/hr</strong> &mdash; overrides the Default Rate above when a time entry uses this attorney.</p>':'')
    +'<table class="rate-hist-table"><thead><tr><th>Rate</th><th>Effective Date</th><th>Note</th><th></th></tr></thead><tbody>'+rhRows+'</tbody></table>'
    +'<div style="margin-top:10px"><div style="font-size:11px;font-weight:600;color:var(--ink3);margin-bottom:5px">Add rate entry:</div>'
    +'<div class="rate-hist-add">'
    +'<div class="fl"><label style="font-size:11px">Rate ($/hr)</label><input type="number" id="ctf-rh-rate" placeholder="175.00" min="0" step="0.01"></div>'
    +'<div class="fl"><label style="font-size:11px">Effective Date</label><input type="date" id="ctf-rh-date" value="'+today()+'"></div>'
    +'<div class="fl"><label style="font-size:11px">Note (optional)</label><input type="text" id="ctf-rh-note" placeholder="Rate increase, insurance adj…"></div>'
    +'<button type="button" class="btn btn-gh" style="padding:6px 12px;font-size:12px;white-space:nowrap" onclick="A.ctfAddRate()">+ Add</button>'
    +'</div></div>'
    +'</div></div>';

  return '<div class="fbox" id="ctf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Contact</h3>'
    +'<div class="frow c2">'+field('Name','ctf-n',{ph:'Jane Smith',val:f.name||'',req:true,err:f.errs&&f.errs.n})+field('Role / Title','ctf-ro',{ph:'Associate Attorney',val:f.role||''})+'</div>'
    +'<div class="frow c2">'+field('Email','ctf-e',{type:'email',ph:'jane@firm.com',val:f.email||'',err:f.errs&&f.errs.e})+field('Phone','ctf-p',{type:'tel',ph:'(555) 123-4567',val:f.phone||'',oninput:"A.livePhone('ctf-p')"})+'</div>'
    +'<div class="frow c2">'+field('Default Rate ($/hr)','ctf-rate',{pfx:'$',ph:'175.00',val:f.rate||'',hint:'Used when no rate history entry matches the entry date'})+(ST.prefs.revenueSplit?field('Personal Cut %','ctf-op',{type:'number',sfx:'%',ph:'100',val:String(pct),hint:'% of billed amount this person keeps (firm gets the rest)'}):'')+'</div>'
    +(ST.prefs.revenueSplit?'<div class="frow c2">'+field('Annual Salary','ctf-sal',{pfx:'$',ph:'120,000',val:f.salary!=null&&f.salary!==''?String(f.salary):'',hint:'Used to calculate net income and bonus/deficit vs. billed earnings'})+'<div></div>'+'</div>':'')
    +rateSection
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveCt()">'+IC.save+' Save Contact</button></div>'
    +'</div>';
}

// == Analytics ==
function vAnalytics(){
  var fe=filterEnt(ST.entries,ST.anFilter);
  var hrs=fe.reduce(function(s,e){return s+Number(e.hours);},0);
  var bill=fe.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);

  // Salary prorated to current filter period
  var salPeriodFn=function(annual){ return salaryForPeriod(annual,ST.anFilter); };
  var salLbl=salaryPeriodLabel(ST.anFilter); // e.g. "monthly (÷12)"

  // Revenue split: per team member (includes salary & prorated income calc)
  var contactSplit=ST.contacts.map(function(c){
    var ces=fe.filter(function(e){return e.contactId==c.id;});
    var chrs=ces.reduce(function(s,e){return s+Number(e.hours);},0);
    var cbill=ces.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
    var pct=c.ownPct!=null?Number(c.ownPct):100;
    var own=cbill*pct/100;
    var annualSal=c.salary!=null&&c.salary!==''?Number(c.salary):null;
    var periodSal=salPeriodFn(annualSal);
    var net=periodSal!=null?own-periodSal:null;
    return {id:c.id,name:c.name,hrs:chrs,bill:cbill,ownPct:pct,own:own,firm:cbill*(100-pct)/100,
            annualSalary:annualSal,periodSalary:periodSal,net:net};
  }).filter(function(c){return c.hrs>0;});

  // Unassigned entries
  var unassignedEntries=fe.filter(function(e){
    if(!e.contactId) return true;
    return !ST.contacts.find(function(c){return c.id==e.contactId;});
  });
  var uHrs=unassignedEntries.reduce(function(s,e){return s+Number(e.hours);},0);
  var uBill=unassignedEntries.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
  var userPct=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
  var userAnnualSalary=ST.user&&ST.user.salary!=null&&ST.user.salary!==''?Number(ST.user.salary):null;
  if(uHrs>0){
    var uOwn=uBill*userPct/100;
    contactSplit.push({id:'__unassigned',name:'(Unassigned)',hrs:uHrs,bill:uBill,ownPct:userPct,
      own:uOwn,firm:uBill*(100-userPct)/100,annualSalary:null,periodSalary:null,net:null});
  }

  var totalOwn=contactSplit.reduce(function(s,c){return s+c.own;},0);
  var totalFirm=contactSplit.reduce(function(s,c){return s+c.firm;},0);

  var byClient=ST.clients.map(function(c){
    var es=fe.filter(function(e){return e.clientId==c.id;});
    return {name:c.name,hrs:es.reduce(function(s,e){return s+Number(e.hours);},0),
            bill:es.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0)};
  }).filter(function(c){return c.hrs>0;}).sort(function(a,b){return b.bill-a.bill;});
  var maxB=byClient.length?byClient[0].bill:1;

  // Filter options — rolling + calendar periods
  var filterGroups=[
    {label:'Rolling',opts:[
      {v:'week',l:'Past Week'},{v:'month',l:'Past Month'},
      {v:'quarter',l:'Past Quarter'},{v:'year',l:'Past Year'},{v:'all',l:'All Time'}
    ]},
    {label:'Calendar',opts:[
      {v:'this_month',l:'This Month'},{v:'this_quarter',l:'This Quarter'},{v:'this_year',l:'This Year'}
    ]}
  ];
  var fopts=filterGroups.map(function(g){
    return '<optgroup label="'+g.label+'">'+g.opts.map(function(o){
      return '<option value="'+o.v+'"'+(ST.anFilter===o.v?' selected':'')+'>'+o.l+'</option>';
    }).join('')+'</optgroup>';
  }).join('');

  var periodLblMap={week:'Past Week',month:'Past Month',quarter:'Past Quarter',year:'Past Year',
    all:'All Time',this_month:'This Month',this_quarter:'This Quarter',this_year:'This Year'};
  var periodLbl=periodLblMap[ST.anFilter]||'All Time';

  var barsH=byClient.length?'<div class="card" style="margin-top:20px">'
    +'<h3 style="font-weight:500;margin-bottom:16px;font-size:.93rem">Revenue by Client</h3>'
    +byClient.map(function(c){
      return '<div class="bar-row"><div class="bar-lbl"><span>'+H(c.name)+'</span>'
        +'<span><strong>'+$m(c.bill)+'</strong> <span style="color:var(--ink3);font-size:12px">'+$h(c.hrs)+'</span></span></div>'
        +'<div class="bar-track"><div class="bar-fill" style="width:'+((c.bill/maxB)*100).toFixed(1)+'%"></div></div></div>';
    }).join('')+'</div>':'';

  // ---- Revenue Split card ----
  var splitH='';
  if(ST.prefs.revenueSplit && contactSplit.length>0){
    var userPctDisplay=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
    var anySalary=ST.contacts.some(function(c){return c.salary!=null&&c.salary!=='';}) || (userAnnualSalary!=null);
    var hasSalLbl=anySalary&&salLbl; // only show salary cols if period is prorateable
    // Column header note
    var salColHdr=hasSalLbl?'Salary <span style="font-weight:400;font-size:10px;color:var(--ink3)">('+salLbl+')</span>':'Salary';
    splitH='<div class="card" style="margin-top:20px">'
      +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">'+IC.pie+'<h3 style="font-weight:500;font-size:.93rem;margin:0">Revenue Split (Own vs. Firm)</h3></div>'
      +'<div style="margin-bottom:14px">'
      +'<label class="fl" style="display:flex;align-items:center;gap:12px">'
      +'<span style="font-size:12px;color:var(--ink2);white-space:nowrap">Your personal cut %</span>'
      +'<input type="number" id="an-upct" min="0" max="100" step="1" value="'+H(String(userPctDisplay))+'" oninput="A.setUserPct(this.value)" style="width:80px;padding:6px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px">'
      +'<span style="font-size:12px;color:var(--ink3)">applies to unassigned entries</span>'
      +'</label></div>'
      +'<div class="tscroll"><table class="split-table">'
      +'<thead><tr><th>Team Member</th><th>Cut</th><th>Hours</th><th>Billed</th><th class="own-amt">Own</th><th class="firm-amt">Firm</th>'
      +(anySalary?'<th>'+salColHdr+'</th><th>Net Income</th><th>Status</th>':'')
      +'</tr></thead>'
      +'<tbody>'
      +contactSplit.map(function(c){
        var statusCell='';
        if(anySalary){
          if(c.annualSalary!=null&&c.periodSalary!=null&&salLbl){
            var isBonus=c.net>=0;
            var statusLabel=isBonus?'+'+$m(c.net)+' bonus':$m(Math.abs(c.net))+' short';
            var statusCls=isBonus?'good':'danger';
            statusCell='<td>'+$m(c.periodSalary)+'</td>'
              +'<td><strong>'+$m(c.own - c.periodSalary)+'</strong></td>'
              +'<td><span class="'+statusCls+'" style="font-size:11px;padding:2px 7px;border-radius:10px;display:inline-block;white-space:nowrap">'+statusLabel+'</span></td>';
          } else if(c.annualSalary!=null&&!salLbl){
            // "All time" - can't prorate, show annual for reference only
            statusCell='<td style="color:var(--ink3);font-size:11px">'+$m(c.annualSalary)+'/yr</td>'
              +'<td style="color:var(--ink3);font-size:11px">\u2014</td>'
              +'<td style="color:var(--ink3);font-size:11px">Select a period</td>';
          } else {
            statusCell='<td style="color:var(--ink3);font-size:11px">\u2014</td><td style="color:var(--ink3);font-size:11px">\u2014</td><td style="color:var(--ink3);font-size:11px">No salary set</td>';
          }
        }
        return '<tr>'
          +'<td>'+H(c.name)+'</td>'
          +'<td><span class="split-pill"><span class="own">'+c.ownPct+'%</span></span></td>'
          +'<td>'+$h(c.hrs)+'</td>'
          +'<td>'+$m(c.bill)+'</td>'
          +'<td class="own-amt"><strong>'+$m(c.own)+'</strong></td>'
          +'<td class="firm-amt"><strong>'+$m(c.firm)+'</strong></td>'
          +statusCell
          +'</tr>';
      }).join('')
      +'<tr style="background:var(--bg)">'
      +'<td><strong>Total</strong></td><td></td>'
      +'<td><strong>'+$h(hrs)+'</strong></td>'
      +'<td><strong>'+$m(bill)+'</strong></td>'
      +'<td class="own-amt"><strong>'+$m(totalOwn)+'</strong></td>'
      +'<td class="firm-amt"><strong>'+$m(totalFirm)+'</strong></td>'
      +(anySalary?'<td></td><td></td><td></td>':'')
      +'</tr>'
      +'</tbody></table></div></div>';
  }

  // ---- My Earnings card (current user only) ----
  var myEarningsH='';
  if(ST.prefs.revenueSplit){
    var me=ST.contacts.find(function(c){return c.isUser;});
    if(me){
      var myEntry=contactSplit.find(function(c){return c.id==me.id;});
      var myOwn=myEntry?myEntry.own:0;
      var myHrs=myEntry?myEntry.hrs:0;
      var myBill=myEntry?myEntry.bill:0;
      var myAnnualSal=me.salary!=null&&me.salary!==''?Number(me.salary):null;
      var myPeriodSal=salPeriodFn(myAnnualSal);
      var myCut=me.ownPct!=null?Number(me.ownPct):100;

      var myRows=[
        ['Billed ('+periodLbl+')', $m(myBill),''],
        ['Your Cut ('+myCut+'%)', $m(myOwn),'highlight']
      ];
      var myDetail='';
      if(myAnnualSal!=null){
        if(myPeriodSal!=null&&salLbl){
          var myNet=myOwn-myPeriodSal;
          var bonusLbl=myNet>=0?'Bonus':'Shortfall';
          var bonusCls=myNet>=0?'highlight':'highlight2';
          myRows.push(['Salary ('+salLbl+')', $m(myPeriodSal),'']);
          myRows.push([bonusLbl+' vs Salary', (myNet>=0?'+':'')+$m(myNet), bonusCls]);

          // Annualized projection
          var annFracs={week:52,month:12,quarter:4,year:1,this_month:12,this_quarter:4,this_year:1};
          var annFac=annFracs[ST.anFilter];
          var projAnnOwn=annFac?myOwn*annFac:null;

          myDetail='<div style="margin-top:14px;display:grid;gap:8px">'
            // Period summary bar
            +'<div style="padding:12px 16px;border-radius:8px;background:var(--bg);font-size:12px;line-height:1.8">'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Period billed</span><strong>'+$m(myBill)+'</strong></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Your cut ('+myCut+'%)</span><strong style="color:#166534">'+$m(myOwn)+'</strong></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Salary ('+salLbl+')</span><strong>'+$m(myPeriodSal)+'</strong></div>'
            +'<div style="height:1px;background:var(--border);margin:6px 0"></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Net (cut − salary)</span><strong class="'+(myNet>=0?'good':'danger')+'">'+(myNet>=0?'+':'')+$m(myNet)+'</strong></div>'
            +'</div>'
            // Annualised projection (only for rolling periods with clean multipliers)
            +(projAnnOwn&&annFac&&annFac!==1?'<div style="padding:10px 16px;border-radius:8px;background:var(--bg);border-left:3px solid var(--border);font-size:12px">'
              +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px">Annualised Projection</div>'
              +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--ink2)">Projected annual cut</span><strong>'+$m(projAnnOwn)+'</strong></div>'
              +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink2)">vs Annual salary ('+$m(myAnnualSal)+')</span>'
              +'<strong class="'+(projAnnOwn-myAnnualSal>=0?'good':'danger')+'">'+(projAnnOwn-myAnnualSal>=0?'+':'')+$m(projAnnOwn-myAnnualSal)+'</strong></div>'
              +'</div>':'')
            +'</div>';
        } else if(!salLbl){
          // "All time" - show annual salary for reference
          myRows.push(['Annual Salary', $m(myAnnualSal),'']);
          myDetail='<div style="margin-top:10px;padding:10px 14px;border-radius:8px;background:var(--bg);font-size:12px;color:var(--ink3)">'
            +'Select a specific period (month, quarter, year) to compare earnings against salary.</div>';
        }
      }

      myEarningsH='<div class="card" style="margin-top:20px">'
        +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">'+IC.usr
        +'<h3 style="font-weight:500;font-size:.93rem;margin:0">My Earnings \u2014 '+H(me.name)+'</h3>'
        +(myAnnualSal==null?'<button class="btn-link" onclick="A.chgUser()" style="font-size:11px;margin-left:6px">Set salary</button>':'')
        +'</div>'
        +stats(myRows)
        +myDetail
        +'</div>';
    }
  }

  var emptyH=fe.length===0?'<div class="empty"><div class="empty-ico">&#128202;</div><p>No data for this period</p><small>Log some time entries first</small></div>':'';
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Analytics</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+fe.length+' entries \u00b7 '+periodLbl+'</p></div>'
    +'<select onchange="A.setAnF(this.value)" style="padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)">'+fopts+'</select>'
    +'</div>'
    +(ST.prefs.revenueSplit?stats([['Total Billing',$m(bill),''],['Total Hours',$h(hrs),''],['Own Portion',$m(totalOwn),'highlight'],['Firm Portion',$m(totalFirm),'highlight2']]):stats([['Total Billing',$m(bill),''],['Total Hours',$h(hrs),'']]))
    +barsH+myEarningsH+splitH+emptyH+'</div>';
}


// == Approvals (partner-only full view, attorney status view) ==
function vApprovals(){
  var role=myRole();
  var pending=ST.entries.filter(function(e){return (e.status||'approved')==='pending';});
  var approved=ST.entries.filter(function(e){return (e.status||'approved')==='approved';});
  var rejected=ST.entries.filter(function(e){return e.status==='rejected';});

  if(role!=='partner'){
    // Attorneys and billing staff see their own entry statuses
    var me=ST.user?ST.user.name:'';
    var mine=ST.entries.filter(function(e){return e.createdBy===me;}).sort(function(a,b){return new Date(b.date)-new Date(a.date);});
    var rows=mine.map(function(e){
      var cl=_lu.cl[e.clientId];
      var mt=_lu.ma[e.matterId];
      var st=e.status||'approved';
      return '<tr>'
        +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
        +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
        +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+'</td>'
        +'<td>'+$h(e.hours)+'</td>'
        +'<td style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</td>'
        +'<td>'+statusBadge(st)+'</td>'
        +'<td style="font-size:12px;color:var(--ink3)">'+H(e.approvedBy?'by '+e.approvedBy:'')+'</td>'
        +'<td style="font-size:12px;max-width:180px">'+(e.partnerComment?'<span style="color:var(--amber);font-style:italic">'+IC.comment+' '+H(e.partnerComment)+'</span>':'')+
          (e.partnerEdited?'<span class="badge" style="font-size:10px;background:var(--amber);color:#fff;margin-left:4px" title="Partner adjusted hours/rate/description">edited</span>':'')+'</td>'
        +'</tr>';
    }).join('');
    var tableH=mine.length?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Hours</th><th>Amount</th><th>Status</th><th>Reviewed By</th><th>Partner Notes</th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
      :'<div class="empty"><div class="empty-ico">&#128203;</div><p>No entries yet</p><small>Start logging time entries to see their approval status here</small></div>';
    return '<div>'
      +'<div style="margin-bottom:18px"><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">My Entry Status</h2>'
      +'<p style="font-size:12px;color:var(--ink3)">'+mine.length+' entr'+(mine.length===1?'y':'ies')+' total</p></div>'
      +stats([['Pending',String(mine.filter(function(e){return (e.status||'approved')==='pending';}).length),'highlight2'],['Approved',String(mine.filter(function(e){return (e.status||'approved')==='approved';}).length),'highlight'],['Rejected',String(mine.filter(function(e){return e.status==='rejected';}).length),'']])
      +(role==='billing_staff'?'<div class="role-notice">'+IC.shield+' Billing staff view: use the Timesheet tab to add or edit entries on behalf of attorneys.</div>':'')
      +tableH+'</div>';
  }

  // Partner view
  var pendingRows=pending.sort(function(a,b){return new Date(a.date)-new Date(b.date);}).map(function(e){
    var cl=_lu.cl[e.clientId];
    var mt=_lu.ma[e.matterId];
    var mnDisplay=(mt&&mt.matterNumber)?'<span style="font-family:monospace;font-size:10px;color:var(--blue);display:block">#'+H(mt.matterNumber)+'</span>':'';
    var abaDisplay=e.abaCode?'<span style="font-family:monospace;font-size:10px;color:var(--ink3)">'+H(e.abaCode)+'</span>':'<span style="font-size:10px;color:var(--amber)" title="No ABA code set">⚠ no code</span>';
    return '<tr>'
      +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
      +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+mnDisplay+'</td>'
      +'<td>'+$h(e.hours)+'</td>'
      +'<td style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</td>'
      +'<td style="color:var(--ink2);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+H(e.description||'')+'">'+H(e.description||'-')+'</td>'
      +'<td>'+abaDisplay+'</td>'
      +'<td><span class="badge" title="'+H(e.createdBy||'')+'">'+H(e.createdByIni||'?')+'</span></td>'
      +'<td><div class="tda">'
        +'<button class="btn btn-gr" onclick="A.approveEnt('+e.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.check+' Approve</button>'
        +'<button class="btn btn-gh" onclick="A.openPartnerReview('+e.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.edit+' Review</button>'
        +'<button class="btn btn-rd" onclick="A.rejectEnt('+e.id+')" style="padding:5px 10px;font-size:12px">Reject</button>'
      +'</div></td>'
      +'</tr>';
  }).join('');

  var pendingTableH=pending.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Hours</th><th>Amount</th><th>Description</th><th>ABA Code</th><th>By</th><th>Action</th></tr></thead>'
      +'<tbody>'+pendingRows+'</tbody></table></div></div>'
    :'<div class="empty"><div class="empty-ico">&#10003;</div><p>No pending entries</p><small>All caught up!</small></div>';

  var approveAllBtn=pending.length>1?'<button class="btn btn-gr" onclick="A.approveAll()" style="margin-left:auto">'+IC.check+' Approve All ('+pending.length+')</button>':'';
  var returnToBillingBtn=approved.length>0?'<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Send approved entries back to billing staff for invoicing" style="gap:5px">📤 Return to Billing ('+approved.length+')</button>':'';
  var receivePackageBtn='<button class="btn btn-gh" onclick="A.openReceivePackage()" title="Import a billing review package from billing staff" style="gap:5px">📥 Receive Package</button>';

  // Invoices pending review
  var invsPending=(ST.invoices||[]).filter(function(i){return i.status==='review';});
  var invReviewRows=invsPending.map(function(inv){
    var cl=_lu.cl[inv.clientId]||{name:'?'};
    var mt=inv.matterId?_lu.ma[inv.matterId]:null;
    var total=invTotal(inv);
    return '<tr>'
      +'<td style="font-weight:600;color:var(--blue)">#'+H(inv.number||inv.id)+'</td>'
      +'<td style="font-weight:500">'+H(cl.name)+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'All Matters')+'</td>'
      +'<td>'+(inv.entryIds?inv.entryIds.length:0)+' entries</td>'
      +'<td style="color:var(--green);font-weight:600">'+$m(total)+'</td>'
      +'<td style="color:var(--ink3);font-size:12px">'+$d(inv.invoiceDate)+'</td>'
      +'<td><div class="tda">'
        +'<button class="btn btn-dk" onclick="A.invOpenReview('+inv.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.shield+' Review</button>'
        +'<button class="btn-ic" title="Email Invoice to Client" onclick="A.emailInvoice('+inv.id+')">'+IC.mail+'</button>'
        +'<button class="btn-ic" title="Preview" onclick="A.invPrint('+inv.id+')">'+IC.print+'</button>'
      +'</div></td>'
      +'</tr>';
  }).join('');
  var invReviewTableH=invsPending.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>#</th><th>Client</th><th>Matter</th><th>Entries</th><th>Total</th><th>Date</th><th>Action</th></tr></thead>'
      +'<tbody>'+invReviewRows+'</tbody></table></div></div>'
    :'<div class="empty" style="padding:20px"><div class="empty-ico" style="font-size:1.8rem">&#10003;</div><p>No invoices pending review</p></div>';

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Approvals</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">Review time entries and invoices</p></div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap">'+receivePackageBtn+returnToBillingBtn+approveAllBtn+'</div></div>'
    +stats([['Pending Entries',String(pending.length),'highlight2'],['Invoices to Review',String(invsPending.length),invsPending.length>0?'highlight2':''],['Approved Entries',String(approved.length),'highlight'],['Rejected',String(rejected.length),'']])
    +'<div class="appr-panel" style="margin-bottom:16px">'
    +'<h3>'+IC.invoice+' Invoices Pending Review'+(invsPending.length>0?' <span style="background:var(--amber);color:#fff;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:6px">'+invsPending.length+'</span>':'')+'</h3>'
    +invReviewTableH+'</div>'
    +'<div class="appr-panel">'
    +'<h3>'+IC.clock+' Pending Time Entries</h3>'
    +pendingTableH+'</div>'
    +'</div>';
}

// == Invoices ==
function vInvoices(){
  var role=myRole();
  var invs=ST.invoices||[];
  // Filter
  var fil=ST.invFilter||'all';
  var shown=fil==='all'?invs:invs.filter(function(i){return i.status===fil;});
  shown=shown.slice().sort(function(a,b){return b.id-a.id;});

  var fOpts=['all','draft','review','approved','sent'].map(function(v){
    var l={all:'All',draft:'Draft',review:'In Review',approved:'Approved',sent:'Sent'}[v];
    var cnt=v==='all'?invs.length:invs.filter(function(i){return i.status===v;}).length;
    return '<option value="'+v+'"'+(fil===v?' selected':'')+'>'+l+' ('+cnt+')</option>';
  }).join('');

  var rows=shown.map(function(inv){
    var cl=_lu.cl[inv.clientId];
    var mt=inv.matterId?_lu.ma[inv.matterId]:null;
    var total=invTotal(inv);
    var stCls={draft:'s-pending',review:'s-pending',approved:'s-approved',sent:'s-approved'}[inv.status]||'s-pending';
    var stLbl={draft:'Draft',review:'In Review',approved:'Approved',sent:'Sent'}[inv.status]||inv.status;
    var btns='<div class="tda">'
      +'<button class="btn-ic" title="Email Invoice to Client" onclick="A.emailInvoice('+inv.id+')">'+IC.mail+'</button>'
      +'<button class="btn-ic" title="Preview/Print" onclick="A.invPrint('+inv.id+')">'+IC.print+'</button>'
      // Partners can review any non-sent invoice
      +(role==='partner'&&inv.status!=='sent'?'<button class="btn btn-dk" style="padding:4px 10px;font-size:12px" onclick="A.invOpenReview('+inv.id+')">'+IC.shield+' Review</button>':'')
      // Non-partners can send draft invoices for review
      +(role!=='partner'&&inv.status==='draft'?'<button class="btn btn-bl" style="padding:4px 10px;font-size:12px" onclick="A.invSendForReview('+inv.id+')">'+IC.send+' Send for Review</button>':'')
      +(role!=='partner'&&(inv.status==='draft'||inv.status==='review')?'<button class="btn btn-gh" style="padding:4px 10px;font-size:12px" onclick="A.emailEntries(\'partner_approval\')" title="Email billing entries to a partner for approval">'+IC.mail+' Email for Approval</button>':'')
      +(inv.status==='approved'&&role!=='partner'?'<button class="btn btn-gr" style="padding:4px 10px;font-size:12px" onclick="A.invMarkSent('+inv.id+')">'+IC.send+' Mark Sent</button>':'')
      +'<button class="btn-ic" title="Edit" onclick="A.invEdit('+inv.id+')">'+IC.edit+'</button>'
      +'<button class="btn-ic" title="Delete" onclick="A.invDel('+inv.id+')" style="color:var(--red)">'+IC.trash+'</button>'
      +'</div>';
    return '<tr>'
      +'<td style="font-weight:600;color:var(--blue)">#'+H(inv.number||inv.id)+'</td>'
      +'<td style="font-weight:500">'+H(cl?cl.name:'—')+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'All Matters')+'</td>'
      +'<td style="color:var(--ink2)">'+$d(inv.invoiceDate)+'</td>'
      +'<td style="color:var(--ink3)">'+H(inv.entryIds?inv.entryIds.length+' entries':'—')+'</td>'
      +'<td style="color:var(--green);font-weight:600">'+$m(total)+'</td>'
      +'<td><span class="status-badge '+stCls+'">'+H(stLbl)+'</span></td>'
      +'<td>'+btns+'</td>'
      +'</tr>';
  }).join('');

  var totalBilled=shown.reduce(function(s,i){return s+invTotal(i);},0);
  var draftCnt=invs.filter(function(i){return i.status==='draft';}).length;
  var reviewCnt=invs.filter(function(i){return i.status==='review';}).length;
  var sentCnt=invs.filter(function(i){return i.status==='sent';}).length;

  var tableH=shown.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>#</th><th>Client</th><th>Matter</th><th>Date</th><th>Entries</th><th>Total</th><th>Status</th><th></th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
    :'<div class="empty"><div class="empty-ico">&#128196;</div><p>No invoices yet</p><small>Create an invoice from approved time entries</small></div>';

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">'+IC.invoice+' Invoices</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">Create, review, and send client invoices</p></div>'
    +'<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">'
    +'<select onchange="A.invSetFilter(this.value)" style="font-size:13px;padding:5px 8px;border:1px solid var(--brd);border-radius:6px;background:var(--bg)">'+fOpts+'</select>'
    +'<button class="btn btn-dk" onclick="A.invNew()">'+IC.plus+' New Invoice</button>'
    +'</div></div>'
    +stats([['Drafts',String(draftCnt),''],['In Review',String(reviewCnt),'highlight2'],['Sent',String(sentCnt),'highlight'],['Total Billed',$m(totalBilled),'']])
    +tableH+'</div>';
}

// Invoice total calculator (applies cuts)
function invTotal(inv){
  if(!inv||!inv.entryIds) return 0;
  buildEntryLookup(); // ensure _lu.en is populated
  var cuts=inv.cuts||{};
  var merged=inv.mergedEntries||[];
  var mergedEntryIds={};
  merged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedEntryIds[eid]=true;});});
  var t=0;
  inv.entryIds.forEach(function(eid){
    if(mergedEntryIds[eid]) return;
    var e=_lu.en[eid];
    if(!e) return;
    var h=cuts[eid]!=null?Number(cuts[eid]):Number(e.hours);
    t+=h*Number(e.rate||0);
  });
  merged.forEach(function(mg){t+=Number(mg.hours||0)*Number(mg.rate||0);});
  return t;
}

// Invoice form modal (create / edit)
function buildInvoiceForm(){
  var f=ST.invf||{};
  var isEdit=!!ST.editId;
  var clOpts=[{v:'',l:'— Select Client —'}].concat(ST.clients.map(function(c){return {v:c.id,l:c.name};}));
  var mtOpts=[{v:'',l:'All Matters'}].concat(
    (f.clientId?ST.matters.filter(function(m){return m.clientId==f.clientId;}):ST.matters)
    .map(function(m){return {v:m.id,l:m.name};})
  );
  var statusOpts=[{v:'draft',l:'Draft'},{v:'review',l:'Send for Review'},{v:'approved',l:'Approved'},{v:'sent',l:'Sent'}];

  // Entry picker: approved entries for selected client/matter not already invoiced
  var invoicedIds={};
  (ST.invoices||[]).forEach(function(inv){
    if(isEdit&&inv.id==ST.editId) return; // exclude self when editing
    (inv.entryIds||[]).forEach(function(eid){invoicedIds[eid]=inv.number||inv.id;});
  });
  var candidateEnts=ST.entries.filter(function(e){
    if(e.status!==undefined&&e.status!=='approved') return false; // only approved
    if(f.clientId&&e.clientId!=f.clientId) return false;
    if(f.matterId&&e.matterId!=f.matterId) return false;
    return true;
  }).sort(function(a,b){return new Date(a.date)-new Date(b.date);});
  var selIds=f.entryIds||[];
  var selSet={};
  selIds.forEach(function(id){selSet[id]=true;});

  var entryRows=candidateEnts.map(function(e){
    var cl2=_lu.cl[e.clientId];
    var mt2=_lu.ma[e.matterId];
    var alreadyInv=invoicedIds[e.id];
    var dis=!!alreadyInv;
    var chk=selSet[e.id]?'checked':'';
    return '<label style="display:flex;align-items:flex-start;gap:8px;padding:6px 8px;border-radius:6px;cursor:'+(dis?'default':'pointer')+';background:'+(selSet[e.id]?'var(--blue-pale)':'transparent')+';border:1px solid '+(selSet[e.id]?'var(--blue)':'transparent')+';margin-bottom:3px;opacity:'+(dis?0.45:1)+'">'
      +'<input type="checkbox" '+(dis?'disabled':'')+' '+chk+' onchange="A.invTogEnt('+e.id+')" style="margin-top:2px;flex-shrink:0">'
      +'<div style="flex:1;min-width:0">'
      +'<div style="display:flex;justify-content:space-between;gap:8px"><span style="font-size:13px;font-weight:500">'+$d(e.date)+'</span><span style="font-size:12px;color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</span></div>'
      +'<div style="font-size:12px;color:var(--ink2)">'+H(cl2?cl2.name:'')+' · '+H(mt2?mt2.name:'General')+' · '+$h(e.hours)+' @ '+$m(e.rate)+'/hr</div>'
      +(e.description?'<div style="font-size:11px;color:var(--ink3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+H(e.description)+'</div>':'')
      +(alreadyInv?'<div style="font-size:11px;color:var(--amber)">Already on invoice #'+H(alreadyInv)+'</div>':'')
      +'</div></label>';
  }).join('');

  var selAmt=selIds.reduce(function(s,eid){
    var e=_lu.en[eid]; return e?s+Number(e.hours)*Number(e.rate):s;
  },0);

  var firmName=f.firmName!=null?f.firmName:(ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'');

  return '<div class="ov"><div class="modal modal-lg" style="max-height:90vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+(isEdit?IC.edit+' Edit Invoice':''+IC.invoice+' New Invoice')+'</h2>'
    +'<button class="btn-ic" onclick="A.closeF()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Invoice #','inv-num',{val:H(f.number||''),ph:'Auto-assigned if blank'})
    +field('Invoice Date','inv-date',{type:'date',val:f.invoiceDate||today()})
    +field('Due Date','inv-due',{type:'date',val:f.dueDate||''})
    +field('Status','inv-status',{type:'select',val:f.status||'draft',opts:statusOpts})
    +'</div>'

    +'<div style="background:var(--bg2);border-radius:8px;padding:14px;margin:8px 0">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:10px">Firm / From</h4>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Firm Name','inv-firm',{val:H(firmName),ph:'Your firm name'})
    +field('Phone','inv-fphone',{val:H(f.firmPhone||''),ph:'Firm phone'})
    +field('Address','inv-faddr',{val:H(f.firmAddress||''),ph:'Firm address',type:'textarea',rows:2})
    +field('Email','inv-femail',{type:'email',val:H(f.firmEmail||''),ph:'billing@yourfirm.com'})
    +'</div></div>'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Client','inv-cl',{type:'select',val:f.clientId||'',opts:clOpts,req:true,err:f.errs&&f.errs.clientId})
    +field('Matter (optional)','inv-mt',{type:'select',val:f.matterId||'',opts:mtOpts})
    +'</div>'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Payment Terms','inv-terms',{val:H(f.paymentTerms||'Net 30'),ph:'Net 30'})
    +field('Tax Rate %','inv-tax',{val:H(f.taxPct||''),ph:'0',type:'number',sfx:'%'})
    +'</div>'

    +field('Notes / Work Description','inv-notes',{val:H(f.notes||''),type:'textarea',rows:3,ph:'Summary of services rendered...'})
    +field('Footer Note','inv-footer',{val:H(f.footerNote||''),ph:'e.g. Thank you for your business'})

    +'<div style="margin-top:14px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3)">Time Entries</h4>'
    +'<div style="font-size:12px;color:var(--ink2)"><strong>'+selIds.length+' selected</strong> · '+$m(selAmt)+'</div></div>'
    +(f.clientId
      ?'<div style="max-height:240px;overflow-y:auto;border:1px solid var(--brd);border-radius:8px;padding:8px">'
        +(candidateEnts.length?entryRows:'<div style="text-align:center;padding:20px;color:var(--ink3);font-size:13px">No approved entries for this selection</div>')
        +'</div>'
      :'<div style="text-align:center;padding:20px;background:var(--bg2);border-radius:8px;color:var(--ink3);font-size:13px">Select a client to load time entries</div>')
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeF()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.invSave()">'+IC.save+' '+(isEdit?'Update Invoice':'Create Invoice')+'</button>'
    +'</div></div></div>';
}

// Invoice review modal (partner cuts/merges/comments)
function buildInvoiceReview(){
  buildEntryLookup(); // invoice review needs _lu.en — build it lazily here
  var rev=ST.invRev||{};
  var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
  if(!inv) return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2>Review</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div><div class="modal-bd"><p>Invoice not found</p></div></div></div>';
  var cl=_lu.cl[inv.clientId]||{name:'?'};
  var mt=inv.matterId?_lu.ma[inv.matterId]:null;

  var cuts=rev.cuts||{};
  var comments=rev.comments||{};
  var pendingMerge=rev.pendingMerge||[];
  var pmSet={};
  pendingMerge.forEach(function(id){pmSet[id]=true;});

  // Merged entries already in invoice
  var existingMerged=inv.mergedEntries||[];
  var mergedIds={};
  existingMerged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedIds[eid]=mg.id;});});

  var entryRows=(inv.entryIds||[]).map(function(eid){
    var e=_lu.en[eid];
    if(!e) return '';
    if(mergedIds[eid]) return ''; // skip already-merged
    var origH=Number(e.hours);
    var cutH=cuts[eid]!=null?Number(cuts[eid]):origH;
    var amt=cutH*Number(e.rate||0);
    var hasCut=cutH<origH;
    var cmtVal=H(comments[eid]||'');
    var inMerge=pmSet[eid];
    return '<div style="border:1px solid '+(inMerge?'var(--blue)':hasCut?'var(--amber)':'var(--brd)')+';border-radius:8px;padding:10px 12px;margin-bottom:8px;background:'+(inMerge?'var(--blue-pale)':hasCut?'rgba(251,191,36,.06)':'var(--bg)')+'">'
      +'<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">'
      +'<div style="flex:1;min-width:200px">'
      +'<div style="font-size:13px;font-weight:500;margin-bottom:3px">'+$d(e.date)+' — <span style="color:var(--ink2)">'+H(e.description||'No description')+'</span></div>'
      +'<div style="font-size:12px;color:var(--ink3)">'+$h(origH)+' @ '+$m(e.rate)+'/hr &nbsp;·&nbsp; '+H(e.createdBy||'')+'</div>'
      +'</div>'
      +'<div style="display:flex;align-items:center;gap:8px;flex-shrink:0">'
      +'<label style="font-size:12px;color:var(--ink3)">Hours:</label>'
      +'<div style="display:flex;align-items:center;gap:4px">'
      +(hasCut?'<span style="font-size:11px;text-decoration:line-through;color:var(--red)">'+origH+'</span>':'')
      +'<input type="number" value="'+cutH+'" min="0" max="'+origH+'" step="0.01" style="width:68px;padding:4px 6px;border:1px solid var(--brd);border-radius:5px;font-size:13px;background:var(--bg)" onchange="A.invRevCut('+eid+',this.value)">'
      +'</div>'
      +'<span style="font-size:13px;font-weight:600;color:var(--green);min-width:60px;text-align:right">'+$m(amt)+'</span>'
      +'</div></div>'
      +'<div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">'
      +'<input type="text" placeholder="Reviewer comment (optional)..." value="'+cmtVal+'" style="flex:1;min-width:160px;font-size:12px;padding:5px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg)" onchange="A.invRevComment('+eid+',this.value)">'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 8px;gap:3px" onclick="A.invRevTogMerge('+eid+')" title="'+(inMerge?'Remove from merge group':'Add to merge group')+'">'
        +IC.merge+(inMerge?' ✓ In Merge':'Merge')+'</button>'
      +(hasCut?'<button class="btn btn-gh" style="font-size:11px;padding:4px 8px" onclick="A.invRevCut('+eid+','+origH+')">Restore</button>':'')
      +'</div>'
      +'</div>';
  }).join('');

  // Merged entry groups
  var mergedRows=existingMerged.map(function(mg,mi){
    return '<div style="border:1px solid var(--blue);border-radius:8px;padding:10px 12px;margin-bottom:8px;background:var(--blue-pale)">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
      +'<span style="font-size:12px;font-weight:600;color:var(--blue)">'+IC.merge+' Merged Entry ('+mg.entryIds.length+' combined)</span>'
      +'<button class="btn btn-rd" style="font-size:11px;padding:3px 8px" onclick="A.invRevUnmerge('+mi+')">Unmerge</button>'
      +'</div>'
      +'<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">'
      +'<div style="flex:1"><input type="text" value="'+H(mg.description||'')+'" placeholder="Merged entry description" style="width:100%;font-size:13px;padding:5px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg)" onchange="A.invRevMergeDesc('+mi+',this.value)"></div>'
      +'<div style="display:flex;gap:6px;align-items:center">'
      +'<input type="number" value="'+mg.hours+'" min="0" step="0.01" style="width:68px;padding:4px 6px;border:1px solid var(--brd);border-radius:5px;font-size:13px;background:var(--bg)" onchange="A.invRevMergeHours('+mi+',this.value)">'
      +'<span style="font-size:12px;color:var(--ink3)">hrs @ '+$m(mg.rate)+'</span>'
      +'<span style="font-size:13px;font-weight:600;color:var(--green)">'+$m(Number(mg.hours)*Number(mg.rate))+'</span>'
      +'</div></div>'
      +'<div style="margin-top:4px;font-size:11px;color:var(--ink3)">Includes: '+mg.entryIds.map(function(eid){var e=_lu.en[eid];return e?$d(e.date)+' '+$h(e.hours):'?';}).join(', ')+'</div>'
      +'</div>';
  }).join('');

  var pendingMergeTotal=pendingMerge.reduce(function(s,eid){
    var e=_lu.en[eid];
    var h=cuts[eid]!=null?Number(cuts[eid]):e?Number(e.hours):0;
    return s+h;
  },0);
  var pendingMergeRate=pendingMerge.length>0?(function(){
    var e=_lu.en[pendingMerge[0]];return e?Number(e.rate||0):0;
  })():0;

  var mergePanel=pendingMerge.length>0
    ?'<div style="background:var(--blue-pale);border:1px solid var(--blue);border-radius:8px;padding:10px 12px;margin-bottom:12px">'
      +'<div style="font-size:12px;font-weight:600;color:var(--blue);margin-bottom:8px">'+IC.merge+' Merge '+pendingMerge.length+' selected entries → single line item</div>'
      +'<input type="text" id="merge-desc" placeholder="Combined description..." style="width:100%;font-size:13px;padding:6px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg);margin-bottom:6px">'
      +'<div style="display:flex;gap:8px;align-items:center">'
      +'<span style="font-size:12px;color:var(--ink3)">Total hrs: '+pendingMergeTotal.toFixed(2)+' @ '+$m(pendingMergeRate)+'/hr</span>'
      +'<button class="btn btn-dk" style="font-size:12px;padding:4px 12px;margin-left:auto" onclick="A.invRevCommitMerge()">'+IC.merge+' Commit Merge</button>'
      +'<button class="btn btn-gh" style="font-size:12px;padding:4px 8px" onclick="A.invRevClearMerge()">Clear</button>'
      +'</div></div>'
    :'';

  // Invoice-level comments
  var invComments=rev.invoiceComment||'';
  var savedComments=(inv.comments||[]).map(function(c){
    return '<div style="padding:6px 10px;background:var(--bg2);border-radius:6px;margin-bottom:4px;font-size:12px">'
      +'<strong>'+H(c.by)+'</strong> <span style="color:var(--ink3)">'+$d(c.at)+'</span>'
      +'<div style="margin-top:3px;color:var(--ink2)">'+H(c.text)+'</div>'
      +'</div>';
  }).join('');

  var newTotal=invTotal(Object.assign({},inv,{cuts:cuts,mergedEntries:inv.mergedEntries||[]}));

  return '<div class="ov"><div class="modal modal-lg" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.shield+' Review Invoice #'+H(inv.number||inv.id)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'
    +'<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">'
    +'<div style="flex:1;min-width:200px;background:var(--bg2);padding:10px 14px;border-radius:8px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Client</div>'
    +'<div style="font-weight:600">'+H(cl.name)+'</div>'
    +(mt?'<div style="font-size:12px;color:var(--ink2)">'+H(mt.name)+'</div>':'')+'</div>'
    +'<div style="flex:1;min-width:180px;background:var(--bg2);padding:10px 14px;border-radius:8px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Invoice Total</div>'
    +'<div style="font-weight:700;font-size:1.4rem;color:var(--green)">'+$m(newTotal)+'</div>'
    +'<div style="font-size:11px;color:var(--ink3)">'+(inv.entryIds||[]).length+' entries</div></div>'
    +'</div>'

    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:8px">Time Entries — Cut / Comment / Merge</h4>'
    +mergePanel
    +(existingMerged.length?'<div style="margin-bottom:8px">'+mergedRows+'</div>':'')
    +entryRows

    +'<div style="margin-top:16px;border-top:1px solid var(--brd);padding-top:14px">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:8px">'+IC.comment+' Invoice Comments</h4>'
    +(savedComments||'')
    +'<div style="display:flex;gap:8px;margin-top:8px">'
    +'<input type="text" id="inv-comment-inp" placeholder="Add a review comment..." style="flex:1;font-size:13px;padding:6px 8px;border:1px solid var(--brd);border-radius:6px;background:var(--bg)">'
    +'<button class="btn btn-gh" onclick="A.invRevAddComment()">'+IC.comment+' Add</button>'
    +'</div></div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-gh" style="gap:5px" onclick="A.emailEntries(\'billing_staff\')" title="Email review summary to the billing attorney">'+IC.mail+' Email Summary</button>'
    +'<button class="btn btn-rd" onclick="A.invRevReject()">Reject</button>'
    +'<button class="btn btn-dk" onclick="A.invRevSave()">'+IC.save+' Save &amp; Close</button>'
    +'<button class="btn btn-gr" onclick="A.invRevApprove()">'+IC.check+' Approve Invoice</button>'
    +'</div></div></div>';
}

// Invoice print preview
function buildInvoicePrint(){
  var inv=ST.invoices.find(function(i){return i.id==ST.invPrintId;});
  if(!inv) return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2>Print</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div><div class="modal-bd"><p>Invoice not found</p></div></div></div>';
  var cl=_lu.cl[inv.clientId]||{name:'?',email:'',phone:''};
  var mt=inv.matterId?_lu.ma[inv.matterId]:null;

  var cuts=inv.cuts||{};
  var merged=inv.mergedEntries||[];
  var mergedEntryIds={};
  merged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedEntryIds[eid]=true;});});

  // Build line items
  var lineItems=[];
  (inv.entryIds||[]).forEach(function(eid){
    if(mergedEntryIds[eid]) return;
    var e=_lu.en[eid];
    if(!e) return;
    var origH=Number(e.hours);
    var h=cuts[eid]!=null?Number(cuts[eid]):origH;
    if(h<=0) return;
    // Show strikethrough if: hours were cut via invoice review, OR partner edited them directly
    var displayOrigH=null;
    if(cuts[eid]!=null&&Number(cuts[eid])<(e.submittedHours!=null?Number(e.submittedHours):origH)){
      displayOrigH=e.submittedHours!=null?Number(e.submittedHours):origH;
    } else if(e.submittedHours!=null&&Number(e.submittedHours)!==h){
      displayOrigH=Number(e.submittedHours);
    }
    var wasCut=displayOrigH!=null;
    var mt2=_lu.ma[e.matterId];
    var ct2=_lu.ct[e.contactId];
    var cmt=(inv.comments||[]).filter(function(c){return c.entryId==eid;}).map(function(c){return c.text;}).join('; ');
    lineItems.push({date:e.date,desc:e.description||'Legal services',matter:mt2?mt2.name:'',by:ct2?ct2.name:(e.createdBy||''),hours:h,origHours:wasCut?displayOrigH:null,rate:Number(e.rate||0),amount:h*Number(e.rate||0),partnerComment:(e.showCommentOnInvoice&&e.partnerComment)?e.partnerComment:''});
  });
  merged.forEach(function(mg){
    if(Number(mg.hours||0)<=0) return;
    lineItems.push({date:'',desc:mg.description||'Legal services',matter:'',by:'',hours:Number(mg.hours||0),rate:Number(mg.rate||0),amount:Number(mg.hours||0)*Number(mg.rate||0)});
  });
  lineItems.sort(function(a,b){return a.date<b.date?-1:a.date>b.date?1:0;});

  var subtotal=lineItems.reduce(function(s,l){return s+l.amount;},0);
  var taxPct=Number(inv.taxPct||0);
  var taxAmt=subtotal*taxPct/100;
  var total=subtotal+taxAmt;

  var lineRows=lineItems.map(function(l){
    return '<tr>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;color:#555">'+(l.date?$d(l.date):'')+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee">'+H(l.desc)+(l.matter?'<br><span style="font-size:11px;color:#888">'+H(l.matter)+'</span>':'')+''+(l.by?'<br><span style="font-size:11px;color:#aaa">'+H(l.by)+'</span>':'')+(l.partnerComment?'<br><span style="font-size:11px;color:#555;font-style:italic">Note: '+H(l.partnerComment)+'</span>':'')+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right">'+(l.origHours!=null?'<span style="text-decoration:line-through;color:#bbb;font-size:11px;margin-right:5px">'+l.origHours.toFixed(1)+'</span>':'')+l.hours.toFixed(1)+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right">'+$m(l.rate)+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right;font-weight:600">'+$m(l.amount)+'</td>'
      +'</tr>';
  }).join('');

  var firmName=H(inv.firmName||ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'');
  var firmAddr=H(inv.firmAddress||'');
  var firmPhone=inv.firmPhone?telLink(inv.firmPhone):'';
  var firmEmail=inv.firmEmail?mailLink(inv.firmEmail):'';
  var invNum=H(inv.number||String(inv.id));

  var html='<div id="inv-print-wrap" style="background:#fff;color:#222;font-family:Georgia,serif;padding:0">'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:32px 40px 24px;border-bottom:3px solid #111">'
    +'<div><div style="font-size:22px;font-weight:700;color:#111;letter-spacing:-.02em">'+firmName+'</div>'
    +(firmAddr?'<div style="font-size:12px;color:#666;margin-top:4px">'+firmAddr.replace(/\n/g,'<br>')+'</div>':'')
    +(firmPhone?'<div style="font-size:12px;color:#666">'+firmPhone+'</div>':'')
    +(firmEmail?'<div style="font-size:12px;color:#666">'+firmEmail+'</div>':'')
    +'</div>'
    +'<div style="text-align:right"><div style="font-size:30px;font-weight:300;color:#111;letter-spacing:-.02em">INVOICE</div>'
    +'<div style="font-size:14px;color:#555;margin-top:4px"># '+invNum+'</div>'
    +'<div style="font-size:12px;color:#888">Date: '+$d(inv.invoiceDate||today())+'</div>'
    +(inv.dueDate?'<div style="font-size:12px;color:#888">Due: '+$d(inv.dueDate)+'</div>':'')
    +'</div></div>'
    +'<div style="display:flex;justify-content:space-between;padding:20px 40px;background:#f8f8f8;border-bottom:1px solid #ddd">'
    +'<div><div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:#999;margin-bottom:4px">Bill To</div>'
    +'<div style="font-weight:700;font-size:15px">'+H(cl.name)+'</div>'
    +(cl.email?'<div style="font-size:12px;color:#666">'+mailLink(cl.email)+'</div>':'')
    +(cl.phone?'<div style="font-size:12px;color:#666">'+telLink(cl.phone)+'</div>':'')
    +'</div>'
    +'<div style="text-align:right">'
    +(mt?'<div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:#999;margin-bottom:2px">Matter</div><div style="font-weight:600">'+H(mt.name)+'</div>':'')
    +(inv.paymentTerms?'<div style="font-size:12px;color:#666;margin-top:4px">Terms: '+H(inv.paymentTerms)+'</div>':'')
    +'</div></div>'
    +(inv.notes?'<div style="padding:16px 40px;border-bottom:1px solid #eee;font-size:13px;color:#444">'+H(inv.notes)+'</div>':'')
    +'<table style="width:100%;border-collapse:collapse">'
    +'<thead><tr style="background:#f0f0f0"><th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #ddd">Date</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #ddd">Description</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Hours</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Rate</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Amount</th>'
    +'</tr></thead>'
    +'<tbody>'+lineRows+'</tbody>'
    +'</table>'
    +'<div style="display:flex;justify-content:flex-end;padding:16px 40px">'
    +'<div style="min-width:220px">'
    +'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#555"><span>Subtotal</span><span>'+$m(subtotal)+'</span></div>'
    +(taxPct>0?'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#555"><span>Tax ('+taxPct+'%)</span><span>'+$m(taxAmt)+'</span></div>':'')
    +'<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:16px;font-weight:700;border-top:2px solid #111;margin-top:4px"><span>Total</span><span>'+$m(total)+'</span></div>'
    +'</div></div>'
    +(inv.footerNote?'<div style="padding:16px 40px;border-top:1px solid #eee;font-size:12px;color:#888;font-style:italic">'+H(inv.footerNote)+'</div>':'')
    +'</div>';

  return '<div class="ov"><div class="modal modal-lg" style="max-height:95vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.print+' Invoice Preview #'+invNum+'</h2>'
    +'<div style="display:flex;gap:8px">'
    +'<button class="btn btn-dk" onclick="A.invDoPrint()" style="gap:6px">'+IC.print+' Print</button>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button>'
    +'</div></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1;padding:0;background:#e8e8e8">'
    +'<div style="max-width:820px;margin:20px auto;box-shadow:0 4px 24px rgba(0,0,0,.15)">'+html+'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +(inv.status!=='sent'&&myRole()==='partner'?'<button class="btn btn-dk" onclick="A.invOpenReview('+inv.id+'); A.closeM()">'+IC.shield+' Review</button>':'')
    +(myRole()!=='partner'&&(inv.status==='draft'||inv.status==='review')?'<button class="btn btn-gh" onclick="A.emailEntries(\'partner_approval\')" style="gap:5px">'+IC.mail+' Email for Approval</button>':'')
    +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
    +'<button class="btn btn-gh" onclick="A.emailInvoice('+inv.id+')" style="gap:5px">'+IC.mail+' Email to Client</button>'
    +'<button class="btn btn-gr" onclick="A.invDoPrint()">'+IC.print+' Print / Save PDF</button>'
    +'</div></div></div>';
}

// === MODALS
// == Partner Review Entry Modal ==
function buildPartnerReview(){
  var f=ST.pref||{};
  var e=ST.entries.find(function(x){return x.id==f.entryId;});
  if(!e) return '';
  var cl=ST.clients.find(function(c){return c.id==e.clientId;})||{name:'?'};
  var mt=ST.matters.find(function(m){return m.id==e.matterId;});
  var orig={hours:e.hours,rate:e.rate,description:e.description||''};
  var hoursChanged=String(f.hours)!==String(orig.hours);
  var rateChanged=String(f.rate)!==String(orig.rate);
  var descChanged=(f.description||'')!==(orig.description||'');
  var anyEdited=hoursChanged||rateChanged||descChanged;
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.edit+' Partner Review: Time Entry</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1;min-height:0">'

    // Original entry summary
    +'<div style="background:var(--bg2);border-radius:8px;padding:12px 14px;margin-bottom:16px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:6px">Original Submission</div>'
    +'<div style="font-size:13px;font-weight:500">'+$d(e.date)+' — '+H(cl.name)+(mt?' / '+H(mt.name):'')+'</div>'
    +'<div style="font-size:12px;color:var(--ink2);margin-top:3px">'+H(orig.description||'No description')+'</div>'
    +'<div style="font-size:12px;color:var(--ink3);margin-top:3px">'+$h(orig.hours)+' @ '+$m(orig.rate)+'/hr &nbsp;·&nbsp; <strong style="color:var(--green)">'+$m(Number(orig.hours)*Number(orig.rate))+'</strong>'
    +(e.createdBy?' &nbsp;·&nbsp; by '+H(e.createdBy):'')+'</div>'
    +'</div>'

    // Editable fields — partner adjustments
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:10px">Partner Adjustments <span style="font-weight:400;text-transform:none;font-size:12px;color:var(--ink2)">(leave unchanged to keep originals)</span></div>'
    +'<div class="frow c2">'
    +field('Hours','pref-h',{type:'number',val:f.hours,ph:orig.hours,step:'0.1',min:'0.1',hint:hoursChanged?'<span style="color:var(--amber)">Changed from '+orig.hours+'</span>':''})
    +field('Rate ($/hr)','pref-r',{pfx:'$',val:f.rate,ph:orig.rate,hint:(rateChanged?'<span style="color:var(--amber)">Changed from '+$m(orig.rate)+'</span>':(total?'Total: '+total:''))})
    +'</div>'
    +field('Description','pref-desc',{type:'textarea',rows:2,val:f.description,ph:orig.description||'Describe the work performed...',hint:descChanged?'<span style="color:var(--amber)">Modified from original</span>':''})
    +(anyEdited?'<div class="note" style="margin-bottom:12px">'+IC.edit+' You have pending edits. These will be saved to the entry when you approve or save.</div>':'')

    // Comment section
    +'<div style="border-top:1px solid var(--brd);margin-top:4px;padding-top:14px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:10px">'+IC.comment+' Partner Comment</div>'
    +field('Comment','pref-cmt',{type:'textarea',rows:2,val:f.comment||'',ph:'Add a note for the attorney or billing reference...'})
    +'<label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-top:6px;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:'+(f.showOnInvoice?'var(--blue-pale)':'var(--bg)')+';">'
    +'<input type="checkbox" id="pref-inv" style="width:15px;height:15px;cursor:pointer;"'+(f.showOnInvoice?' checked':'')+'>'
    +'<span><strong>Show comment on invoice</strong> <span style="color:var(--ink3);font-size:12px">— visible to client</span></span>'
    +'</label>'
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-rd" onclick="A.partnerReviewReject()">Reject Entry</button>'
    +'<button class="btn btn-dk" onclick="A.partnerReviewSave(false)" style="gap:4px">'+IC.save+' Save Draft</button>'
    +'<button class="btn btn-gr" onclick="A.partnerReviewSave(true)" style="gap:4px">'+IC.check+' Save &amp; Approve</button>'
    +'</div></div></div>';
}

function buildUP(){
  var pct=ST.user&&ST.user.ownPct!=null?String(ST.user.ownPct):'100';
  var rate=ST.user&&ST.user.rate!=null?String(ST.user.rate):'';
  var curRole=ST.user&&ST.user.role||'attorney';
  var isFirstRun=!ST.user||ST._splashMode;
  var STEPS=['Firm Setup','Your Profile'];

  // Role cards for splash
  var roles=[
    {v:'attorney',  label:'Attorney',      desc:'Track and submit time entries for review'},
    {v:'partner',   label:'Partner',        desc:'Full access \u2014 add entries, approve timesheets, manage everything'},
    {v:'billing_staff', label:'Billing Staff', desc:'Can add/edit entries on behalf of attorneys, review all entries and export reports'}
  ];
  var roleCardsH=roles.map(function(r){
    var sel=curRole===r.v?' sel':'';
    return '<div class="splash-role'+sel+'" onclick="A.upSelRole(\''+r.v+'\')">'
      +'<div class="splash-role-radio"></div>'
      +'<div class="splash-role-body"><strong>'+r.label+'</strong><span>'+r.desc+'</span></div>'
      +'</div>';
  }).join('');

  if(isFirstRun){
    var splitFields='';
    if(ST.prefs.revenueSplit){
      splitFields='<div class="frow c2" style="margin-bottom:16px">'
        +'<div class="fl"><label for="up-pct">Personal Cut % <span style="font-size:11px;color:var(--ink3);font-weight:300">of billed revenue</span></label>'
        +'<div class="pw"><input type="number" id="up-pct" min="0" max="100" step="1" placeholder="100" value="'+H(pct)+'"/><span class="sfx">%</span></div>'
        +'<div class="hint">100 = you keep all; 0 = all to firm</div></div>'
        +'<div class="fl"><label for="up-sal">Annual Salary <span style="font-size:11px;color:var(--ink3);font-weight:300">(optional)</span></label>'
        +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-sal" placeholder="120,000" value="'+H(ST.user&&ST.user.salary!=null&&ST.user.salary!==''?String(ST.user.salary):'')+'" /></div>'
        +'<div class="hint">Shown in analytics as net vs. billed</div></div>'
        +'</div>';
    }
    return '<div class="splash-ov">'
      +splashHero(STEPS,1)
      +'<div class="splash-form">'
      +'<div class="splash-form-inner">'
      +'<h2>Set up <strong>your profile</strong></h2>'
      +'<p class="sub">This is stored only on your device. It identifies who created each time entry and controls what you can do in the app.</p>'
      +'<div class="frow c2" style="margin-bottom:16px">'
      +'<div class="fl"><label for="up-n">Full name <span class="req">*</span></label><input type="text" id="up-n" placeholder="e.g. Sarah Johnson" value="'+H(ST.user?ST.user.name:'')+'" autofocus/></div>'
      +'<div class="fl"><label for="up-i">Initials</label><input type="text" id="up-i" placeholder="SJ" maxlength="4" value="'+H(ST.user?ST.user.initials:'')+'"/><div class="hint">Auto-generated if blank</div></div>'
      +'</div>'
      +'<div class="frow c2" style="margin-bottom:16px">'
      +'<div class="fl"><label for="up-e">Email</label><input type="email" id="up-e" placeholder="sarah@firm.com" value="'+H(ST.user&&ST.user.email||'')+'"/></div>'
      +'<div class="fl"><label for="up-p">Phone</label><input type="tel" id="up-p" placeholder="(555) 123-4567" value="'+H(ST.user&&ST.user.phone||'')+'" oninput="A.livePhone(\'up-p\')"/></div>'
      +'</div>'
      +'<div class="fl" style="margin-bottom:16px"><label for="up-rate">Default Rate ($/hr)</label>'
      +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-rate" placeholder="150.00" value="'+H(rate)+'"/></div>'
      +'<div class="hint">Your billing rate. Leave blank to use client/matter rates.</div></div>'
      +splitFields
      +'<div style="margin-bottom:8px;font-size:13px;font-weight:600;color:var(--ink)">Your role</div>'
      +'<div class="splash-roles">'+roleCardsH+'</div>'
      +'<input type="hidden" id="up-role" value="'+H(curRole)+'">'
      +'</div>'
      +'<div class="splash-footer">'
      +'<span class="splash-footer-note">\ud83d\udd12 Stored only on this device</span>'
      +'<button class="btn btn-dk" onclick="A.saveUser()" style="padding:10px 28px">Continue \u2192</button>'
      +'</div>'
      +'</div></div>';
  }

  // Non-first-run: compact modal (chgUser)
  var roleOpts=roles.map(function(o){return '<option value="'+o.v+'"'+(curRole===o.v?' selected':'')+'>'+H(o.label+' \u2014 '+o.desc)+'</option>';}).join('');
  return '<div class="up-wrap">'
    +'<div class="up-box">'
    +'<div class="up-icon">'+IC.usr+'</div>'
    +'<h2>Edit Profile</h2>'
    +'<p>Changes apply to new entries from this point forward.</p>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-n">Your name <span class="req">*</span></label><input type="text" id="up-n" placeholder="e.g. Sarah Johnson" value="'+H(ST.user?ST.user.name:'')+'"/></div>'
    +'<div class="fl"><label for="up-i">Initials</label><input type="text" id="up-i" placeholder="SJ" maxlength="4" value="'+H(ST.user?ST.user.initials:'')+'"/><div class="hint">Auto-generated from name if left blank</div></div>'
    +'</div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-e">Email</label><input type="email" id="up-e" placeholder="you@firm.com" value="'+H(ST.user&&ST.user.email||'')+'"/></div>'
    +'<div class="fl"><label for="up-p">Phone</label><input type="tel" id="up-p" placeholder="(555) 123-4567" value="'+H(ST.user&&ST.user.phone||'')+'" oninput="A.livePhone(\'up-p\')"/></div>'
    +'</div>'
    +'<div class="fl" style="margin-bottom:14px"><label for="up-role">Role</label><select id="up-role">'+roleOpts+'</select></div>'
    +'<div class="fl" style="margin-bottom:14px"><label for="up-rate">Default Rate ($/hr)</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-rate" placeholder="150.00" value="'+H(rate)+'"/></div></div>'
    +(ST.prefs.revenueSplit?'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-pct">Personal Cut %</label>'
    +'<div class="pw"><input type="number" id="up-pct" min="0" max="100" step="1" value="'+H(pct)+'"/><span class="sfx">%</span></div></div>'
    +'<div class="fl"><label for="up-sal">Annual Salary</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-sal" value="'+H(ST.user&&ST.user.salary!=null&&ST.user.salary!==''?String(ST.user.salary):'')+'" /></div></div>'
    +'</div>':'')
    +'<div style="display:flex;gap:10px;margin-top:4px">'
    +'<button class="btn btn-gh" style="flex:1;justify-content:center" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-dk" style="flex:1;justify-content:center" onclick="A.saveUser()">Save Profile</button>'
    +'</div>'
    +'</div></div>';
}


function buildQL(){
  var f=ST.ql;
  var ms=ST.tmrOn?(Date.now()-ST.tmrStart+ST.tmrMs):ST.tmrMs;
  var hh=String(Math.floor(ms/3600000)).padStart(2,'0');
  var mm=String(Math.floor((ms%3600000)/60000)).padStart(2,'0');
  var ss=String(Math.floor((ms%60000)/1000)).padStart(2,'0');
  var rnd=ms/3600000;
  var avMat=ST.matters.filter(function(m){return m.clientId==f.clientId;});
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  var todayStr=today();
  var todayEntries=ST.entries.filter(function(e){return e.date===todayStr;}).sort(function(a,b){return b.id-a.id;});
  var continueH='';
  if(todayEntries.length>0){
    var addToId=f.addToId||'';
    var entOpts='<option value="">&#43; New entry</option>'
      +todayEntries.map(function(e){
        var cl=_lu.cl[e.clientId];var mt=_lu.ma[e.matterId];
        var label=(cl?cl.name:'?')+(mt?' \u2022 '+mt.name:'')+' ('+$h(e.hours)+')'+(e.description?' \u2013 '+e.description.substring(0,28)+(e.description.length>28?'\u2026':''):'');
        return '<option value="'+e.id+'"'+(String(e.id)===String(addToId)?' selected':'')+'>'+H(label)+'</option>';
      }).join('');
    continueH='<div style="background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 20px">'
      +'<label style="font-size:12px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:6px">Continue existing entry today</label>'
      +'<select style="width:100%;font-size:13px" onchange="A.qlPickEntry(this.value)">'+entOpts+'</select>'
      +(addToId?'<div style="margin-top:6px;font-size:12px;color:var(--green)">&#10010; Hours you log will be added to this entry</div>':'')
      +'</div>';
  }
  var headingLabel=f.addToId?IC.flash+' Add Hours to Entry':IC.flash+' Quick Log';

  // Client field: dropdown or inline-create
  var clientField;
  if(f.newCl){
    clientField='<div class="fl"><label>Client <span class="req">*</span></label>'
      +'<div class="ql-new-row">'
      +'<input id="ql-ncn" value="'+H(f.newClName||'')+'" placeholder="New client name" oninput="A.qlSet(\'newClName\',this.value)" onkeydown="if(event.key===\'Enter\')A.qlCreateClient();if(event.key===\'Escape\')A.qlCancelNew(\'cl\')" autofocus>'
      +'<button class="btn-confirm" onclick="A.qlCreateClient()" title="Create client">✓</button>'
      +'<button class="btn-cancel" onclick="A.qlCancelNew(\'cl\')" title="Cancel">✕</button>'
      +'</div></div>';
  } else {
    var clOpts='<option value="">Select client...</option>'
      +ST.clients.map(function(c){return '<option value="'+c.id+'"'+(String(c.id)===String(f.clientId)?' selected':'')+'>'+H(c.name)+'</option>';}).join('')
      +'<option value="__new__" style="color:var(--blue)">+ Add new client\u2026</option>';
    clientField='<div class="fl"><label>Client <span class="req">*</span></label>'
      +'<select id="ql-cl" onchange="A.qlCl(this.value)">'+clOpts+'</select></div>';
  }

  // Matter field: dropdown or inline-create
  var matterField;
  if(f.newMa){
    matterField='<div class="fl"><label>Matter</label>'
      +'<div class="ql-new-row">'
      +'<input id="ql-nmn" value="'+H(f.newMaName||'')+'" placeholder="New matter name" oninput="A.qlSet(\'newMaName\',this.value)" onkeydown="if(event.key===\'Enter\')A.qlCreateMatter();if(event.key===\'Escape\')A.qlCancelNew(\'ma\')" autofocus>'
      +'<button class="btn-confirm" onclick="A.qlCreateMatter()" title="Create matter">✓</button>'
      +'<button class="btn-cancel" onclick="A.qlCancelNew(\'ma\')" title="Cancel">✕</button>'
      +'</div></div>';
  } else {
    var maOpts='<option value="">General</option>'
      +(f.clientId?avMat.map(function(m){return '<option value="'+m.id+'"'+(String(m.id)===String(f.matterId)?' selected':'')+'>'+H(m.name)+'</option>';}).join(''):'')
      +(f.clientId?'<option value="__new__" style="color:var(--blue)">+ Add new matter\u2026</option>':'');
    matterField='<div class="fl"><label>Matter</label>'
      +'<select id="ql-ma" onchange="A.qlMa(this.value)"'+(f.clientId?'':' disabled')+'>'+maOpts+'</select></div>';
  }

  // Continue mode read-only display
  var clientMatterH;
  if(f.addToId){
    var cl2=ST.clients.find(function(c){return String(c.id)===String(f.clientId);});
    var mt2=ST.matters.find(function(m){return String(m.id)===String(f.matterId);});
    clientMatterH='<div class="frow c2" style="margin-bottom:12px">'
      +'<div class="fl"><label>Client</label><div style="padding:7px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;font-size:13px;color:var(--ink)">'+H(cl2?cl2.name:'\u2014')+'</div></div>'
      +'<div class="fl"><label>Matter</label><div style="padding:7px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;font-size:13px;color:var(--ink2)">'+H(mt2?mt2.name:'General')+'</div></div>'
      +'</div>';
  } else {
    clientMatterH='<div class="frow c2" style="margin-bottom:12px">'+clientField+matterField+'</div>';
  }

  return '<div class="ov"><div class="modal modal-sm">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+headingLabel+'</h2>'
    +'<button class="btn-ic" onclick="A.closeQL()">'+IC.x+'</button></div>'
    +continueH
    +'<div class="ql-timer">'
    +'<div class="timer-num '+(ST.tmrOn?'timer-on':'timer-off')+'" id="ql-t">'+hh+':'+mm+':'+ss+'</div>'
    +'<div style="display:flex;gap:8px;align-items:center">'
    +'<button class="btn '+(ST.tmrOn?'btn-rd':'btn-dk')+'" onclick="A.togTmr()" style="padding:8px 14px;font-size:13px">'+(ST.tmrOn?'Stop':(ST.tmrMs>0?'Resume':'Start'))+'</button>'
    +(ST.tmrMs>0?'<button class="btn btn-gh" onclick="A.rstTmr()" style="padding:8px 12px;font-size:13px">Reset</button>':'')
    +'</div>'
    +(ST.tmrMs>0&&!ST.tmrOn?'<span style="font-size:12px;color:var(--ink3)" title="Exact measured time">'+msToHMS(ST.tmrMs)+' ('+rnd.toFixed(4)+'h exact)</span>':'')
    +'</div>'
    +'<div class="modal-bd" style="padding:18px 20px">'
    +clientMatterH
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>'+(f.addToId?'Hours to Add':'Hours')+' <span class="req">*</span></label><input type="number" id="ql-h" step="0.01" min="0.01" value="'+H(f.hours||'')+'" placeholder="1.0" oninput="A.qlSet(\'hours\',this.value)"'+(f.rawMs!=null?' title="Timer-measured: '+msToHMS(f.rawMs)+' exact"':'')+'></div>'
    +'<div class="fl"><label>Rate ($/hr)</label><div class="pw"><span class="pfx">$</span><input type="text" id="ql-r" value="'+H(f.rate||'')+'" placeholder="Auto" oninput="A.qlSet(\'rate\',fmtCur(this.value))"></div></div></div>'
    +'<div class="fl" style="margin-bottom:14px"><label>Description</label>'
    +'<input type="text" id="ql-d" value="'+H(f.description||'')+'" placeholder="What did you work on?" oninput="A.qlSet(\'description\',this.value)" onkeydown="if(event.key===\'Enter\')A.saveQL()"></div>'
    +(total?'<div class="total-pill">Total: <strong>'+total+'</strong></div>':'')
    +(ST.descPresets.length>0?'<div class="desc-chips"><span style="font-size:11px;color:var(--ink3);margin-right:4px">Suggestions:</span>'+ST.descPresets.map(function(p,i){return '<button type="button" class="desc-chip" onclick="A.pickDesc(\'ql-d\','+i+')">'+ H(p)+'</button>';}).join('')+'</div>':'')
    +'<div class="fa" style="margin-top:0">'
    +'<button class="btn btn-gh" onclick="A.closeQL()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveQL()"'+((!f.clientId||!f.hours)?' disabled':'')+'>'
    +IC.save+' '+(f.addToId?'Add Hours':'Save Entry')
    +'</button>'
    +'</div></div></div></div>';
}

function buildHelp(){
  var tabs=[['start','Getting Started'],['time','Time Entries'],['clients','Clients & Matters'],['contacts','Contacts & Rates'],['invoices','Invoices'],['roles','Roles & Workflow'],['settings','Settings'],['backup','Backup'],['faq','FAQ']];
  var content={
    start:'<h3>Welcome to SixMinuteLog.com!</h3>'
      +'<p>A private legal billing and time-tracking app. All data stays on your device — no accounts, no cloud, no fees. Zero external dependencies.</p>'
      +'<h4>Recommended Setup Order</h4>'
      +'<ol>'
      +'<li>Open <strong>⚙️ Settings → Advanced</strong> and choose your role (Attorney, Partner, or Billing Staff)</li>'
      +'<li>Go to <strong>Contacts</strong> — add yourself and any team members with hourly rates'+(ST.prefs.revenueSplit?' and personal cut %':'')+'</li>'
      +'<li>Go to <strong>Clients</strong> — add your clients with default billing rates</li>'
      +'<li>Go to <strong>Matters</strong> — create matters/cases per client</li>'
      +'<li>Go to <strong>Timesheet</strong> — start logging time!</li>'
      +'</ol>'
      +'<h4>Rate Priority</h4>'
      +'<p>Rates auto-fill in this order: <strong>Matter-level attorney rate → Client-level attorney rate → Contact rate history → Contact default rate → Client default rate</strong>. Always manually overrideable.</p>'
      +(ST.prefs.revenueSplit?'<h4>Revenue Split</h4><p>Each contact has a "Personal Cut %" field. Analytics shows the full breakdown of who keeps what vs. what goes to the firm.</p>':'')
      +'<h4>Quick Log ⚡</h4>'
      +'<p>The ⚡ floating button opens a quick-log panel with a built-in stopwatch. Start, stop — the measured time is pre-filled (no forced rounding). Adjust the billed hours before saving if needed.</p>',

    time:'<h3>Time Entries (Timesheet Tab)</h3>'
      +'<h4>New Entry</h4>'
      +'<p>Click <strong>+ New Entry</strong>. Required fields: Date, Client, Hours, Rate. Matter, Description, Team Member, and ABA/UTBMS code are optional but recommended for billing compliance.</p>'
      +'<h4>Quick Log ⚡</h4>'
      +'<p>Tap ⚡, press Start, press Stop when done. The exact elapsed time is pre-filled. Hover the hours value in the timesheet row to see the raw measured time.</p>'
      +'<h4>Row Timers</h4>'
      +'<p>Each existing entry in the timesheet also has a per-row stopwatch button. Tap it to accumulate time against an existing entry.</p>'
      +'<h4>Field Preservation</h4>'
      +'<p>Changing a dropdown (client, matter, team member) never clears your typed fields — hours, rate, description are always preserved.</p>'
      +'<h4>ABA / UTBMS Codes</h4>'
      +'<p>Each entry can have an ABA Uniform Task-Based Management System code. Billing Staff can set these in bulk using the 🧾 button on each row.</p>'
      +'<h4>Hours Precision</h4>'
      +'<p>Stored at full precision (up to 4 decimal places); timer entries also store raw milliseconds. Billing views display 1 decimal place.</p>'
      +'<h4>Filters</h4>'
      +'<p>Filter by Today, This Week, This Month, This Year, or All Time using the dropdown above the table.</p>'
      +'<h4>Entry Status</h4>'
      +'<p>Entries progress through statuses: <strong>Pending → Submitted → Approved</strong>. Partners can approve or cut individual entries. Approved entries flow into Invoices.</p>',

    clients:'<h3>Clients &amp; Matters</h3>'
      +'<h4>Clients</h4>'
      +'<p>Each client has a name, contact info, default billing rate, linked contacts, linked client people (non-team contacts at the client), and optional attorney-specific negotiated rates.</p>'
      +'<h4>Attorney-Specific Rates (Clients)</h4>'
      +'<p>Inside a client record you can add per-attorney negotiated rates. These override the client\'s default rate for that attorney on any entry linked to this client.</p>'
      +'<h4>Matters</h4>'
      +'<p>Matters are cases/projects linked to a client. Each matter can have its own default rate, description, linked contacts, and per-attorney rates that override all other rates.</p>'
      +'<h4>Rate Cascade in Entries</h4>'
      +'<ol><li>Select a <strong>Client</strong> — rate auto-fills from the client\'s rate for that attorney</li>'
      +'<li>Select a <strong>Matter</strong> — rate updates to the matter\'s rate for that attorney if set</li>'
      +'<li>Rate is always manually editable</li></ol>'
      +'<h4>Invoices on Client Cards</h4>'
      +'<p>Approved invoices appear summarised on each client card. Use the 📧 icon to email the latest invoice directly to the client.</p>',

    contacts:'<h3>Contacts &amp; Rate History</h3>'
      +'<h4>Contacts</h4>'
      +'<p>Contacts represent your team members (attorneys, partners, billing staff). Each has a name, role/title, email, phone, default hourly rate'+(ST.prefs.revenueSplit?', personal cut %, and optional annual salary (for bonus/deficit analytics)':'')+'.</p>'
      +'<h4>Rate History</h4>'
      +'<p>Each contact can have a full rate history with effective dates. When an entry is logged, the system finds the most recent rate effective on or before the entry date. This ensures historical entries always bill at the correct rate even after rate changes.</p>'
      +'<p>Add a new rate history row with an effective date to schedule a rate change. The <strong>Default Rate</strong> field is the fallback when no history row matches.</p>'
      +'<h4>isUser Flag</h4>'
      +'<p>One contact is marked as the current user. Their rate history is used for your own entries when no client/matter-specific rate applies.</p>',

    invoices:'<h3>Invoices</h3>'
      +'<p>The Invoices tab (visible to Partners and Billing Staff) lets you create, review, print, and email invoices built from approved time entries.</p>'
      +'<h4>Creating an Invoice</h4>'
      +'<ol><li>Approved entries for a client accumulate in the Invoices tab</li>'
      +'<li>Click <strong>+ New Invoice</strong>, select the client and date range, fill firm details</li>'
      +'<li>Review the line items — you can add notes and override the invoice number</li>'
      +'<li>Set status to <strong>Approved</strong> to finalise</li></ol>'
      +'<h4>Partner Review</h4>'
      +'<p>In the <strong>Approvals</strong> tab (Partners only), each submitted entry can be approved as-is, have its hours reduced, or have its description edited. Approved entries unlock for invoicing.</p>'
      +'<h4>Print &amp; Email</h4>'
      +'<p>Use the 🖨 icon to open a printable invoice preview. Use the 📧 icon to send via your default email client with the invoice details pre-filled.</p>'
      +'<h4>Email Presets</h4>'
      +'<p>Configure reusable email templates in <strong>⚙️ Settings → Email</strong>. Templates support placeholders like <code>{client_name}</code>, <code>{invoice_number}</code>, <code>{amount_due}</code>, and more.</p>',

    roles:'<h3>Roles &amp; Workflow</h3>'
      +'<p>The app has three roles that determine what each user sees and can do.</p>'
      +'<h4>Attorney</h4>'
      +'<p>Logs and edits their own time entries (pending entries only). Can submit entries to a partner for approval via <strong>📤 Submit to Partner</strong>, which exports a transfer package (.json). Cannot access Invoices or Approvals tabs.</p>'
      +'<h4>Partner</h4>'
      +'<p>Full access. Sees all entries across the firm. Can approve, cut, or edit entries in the <strong>Approvals</strong> tab. Can create and manage invoices. Can import submission packages from attorneys.</p>'
      +'<h4>Billing Staff</h4>'
      +'<p>Can add and edit entries on behalf of any attorney. Assigns ABA codes and matter numbers. Can export review packages scoped to a specific partner\'s clients. Sees all entries, does not access Approvals or Invoices directly.</p>'
      +'<h4>Submission Workflow</h4>'
      +'<ol><li><strong>Attorney</strong> logs entries → marks as ready → uses <em>Submit to Partner</em> to download a package</li>'
      +'<li><strong>Partner</strong> imports the package → reviews in Approvals → approves/adjusts</li>'
      +'<li>Approved entries appear in Invoices for billing</li></ol>'
      +'<h4>Firm Profile</h4>'
      +'<p>Partners can build and export a <strong>Firm Profile</strong> (.json) from Settings → Advanced. This pre-configures a new attorney\'s app with clients, matters, contacts, description presets, and user profiles in one import.</p>',

    settings:'<h3>Settings Overview</h3>'
      +'<h4>Backup tab</h4><p>Download a full JSON backup, export a self-contained copy of the app HTML, or restore from a previous backup. Also export/import Firm Profiles here.</p>'
      +'<h4>Appearance tab</h4><p>Toggle dark mode, choose layout density (Comfortable / Compact / Spacious), and set the app name shown in the header and on printed invoices.</p>'
      +'<h4>Descriptions tab</h4><p>Manage a list of description presets (chip suggestions) that appear below the description field when logging time. Reorder by drag, edit in place, delete individually.</p>'
      +'<h4>Email tab</h4><p>Create and manage reusable email presets with subject lines and body templates. Presets appear in the Send Email modal when emailing invoices or approval requests. Supports dynamic placeholders.</p>'
      +'<h4>Advanced tab</h4><p>Set your role (Attorney / Partner / Billing Staff), enable/disable the Analytics tab, toggle Revenue Split mode, and access the Firm Profile builder. Also shows the "Download Claude Guide" button for regenerating the AI architecture reference file.</p>',

    backup:'<h3>Backup &amp; Restore</h3>'
      +'<h4>Full JSON Backup</h4>'
      +'<p>Go to <strong>⚙️ Settings → Backup</strong> and click <em>Download Full Backup (.json)</em>. The file includes all clients, matters, entries, contacts, invoices, settings, and presets. The filename includes the date and time.</p>'
      +'<h4>Save a Copy of the App</h4>'
      +'<p>Use <em>Save App as HTML</em> to download a fresh standalone copy of the app itself (no data included). Useful for updating to a new version without losing your data.</p>'
      +'<h4>Restoring</h4>'
      +'<p>Use <strong>Restore / Import Data</strong> to load a previously saved JSON backup. This replaces all current data — make sure to back up first.</p>'
      +'<h4>Firm Profile Import</h4>'
      +'<p>A Firm Profile is a configuration-only export (no time entries). Import one to pre-populate clients, matters, contacts, and presets on a fresh install.</p>'
      +'<div class="note">⚠️ Your data lives in this browser\'s IndexedDB. Clearing browser data, switching browsers, or using a different device will not carry your data over. Download a JSON backup regularly and keep it safe.</div>',

    faq:'<h3>FAQ</h3>'+[
      ['Where is my data stored?','In your browser\'s IndexedDB — a local database built into every modern browser. Nothing is ever uploaded or sent anywhere. App preferences are also cached in localStorage for instant startup.'],
      ['Can I use this on multiple devices or browsers?','Not automatically. Export a JSON backup on one device and Restore it on another. Each browser instance keeps its own independent database.'],
      ['Why doesn\'t changing a dropdown clear my typed fields?','By design. The app snapshots all form values before every re-render, so switching the client or matter dropdown never loses your typed hours, rate, or description.'],
      ...(ST.prefs.revenueSplit?[['How does the revenue split work?','Set a "Personal Cut %" on each contact (e.g. 65 means they keep 65%, the firm gets 35%). Analytics shows the full breakdown per person and in total.']]:[] ),
      ['What are ABA / UTBMS codes?','Uniform Task-Based Management System codes are standard codes for legal billing compliance. Set them per entry in the New Entry form, or in bulk via the 🧾 button (Billing Staff).'],
      ['How do attorney rate histories work?','Each contact can have rate history rows with effective dates. The system picks the most recent rate effective on or before the entry date. This ensures past entries always reflect the rate that was in effect at the time.'],
      ['What is a Firm Profile?','A Firm Profile is a configuration snapshot (clients, matters, contacts, presets, user templates) that a partner can export and distribute so attorneys can onboard instantly with a single import.'],
      ['Hours precision — what is stored vs. displayed?','Hours are stored at full precision (up to 4 decimal places). Timer entries also store exact raw milliseconds. Billing views display 1 decimal place. Hover a timer-sourced hours value in the timesheet to see the raw measured time.'],
      ['How do I download a backup?','Go to ⚙️ Settings → Backup → Download Full Backup (.json). You can also use the Backup & Export button in the header area.'],
      ['What browsers work best?','Chrome is most reliable for IndexedDB stability. Firefox, Edge, and Safari all work. Always use the same browser profile for consistent data access.'],
      ['Can I use this offline?','Yes — the file has zero external dependencies, no CDN, no internet required. Download the HTML file and double-click it to open.'],
    ].map(function(q){return '<div class="faq-item"><strong>'+H(q[0])+'</strong><p>'+q[1]+'</p></div>';}).join('')
  };
  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.help+' Help & Guide</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="help-lay"><div class="help-nav">'+tabs.map(function(t){return '<button class="'+(ST.helpTab===t[0]?'on':'')+'" onclick="A.setHT(\''+t[0]+'\')">'+H(t[1])+'</button>';}).join('')+'</div>'
    +'<div class="help-body">'+(content[ST.helpTab]||'')+'</div></div></div></div>';
}

function buildExportModal(){
  var x=ST.csvX;
  var ds=x.dataset;

  // ── Dataset selector buttons ──
  var dsBtns=['entries','clients','matters','contacts'].map(function(d){
    var lbls={entries:'Time Entries',clients:'Clients',matters:'Matters',contacts:'Contacts'};
    var on=ds===d;
    return '<button class="btn'+(on?' btn-dk':' btn-gh')+'" style="flex:1;justify-content:center;font-size:12px;padding:8px 6px" onclick="A.csvXDataset(\''+d+'\')">'+lbls[d]+'</button>';
  }).join('');

  // ── Helpers ──
  function chkBox(id,checked,onchange,label,hint){
    return '<label style="display:flex;align-items:flex-start;gap:8px;font-size:12px;cursor:pointer;padding:5px 0;line-height:1.4">'
      +'<input type="checkbox" '+(checked?'checked':'')+' onchange="'+onchange+'" style="margin-top:1px;flex-shrink:0;width:13px;height:13px;cursor:pointer">'
      +'<span><strong>'+label+'</strong>'+(hint?'<br><span style="color:var(--ink3);font-size:11px">'+hint+'</span>':'')+'</span></label>';
  }
  function colGrid(cols){
    return '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 12px">'+cols+'</div>';
  }
  function section(title,body,noBorder){
    return '<div class="set-section"'+(noBorder?' style="border-bottom:none;margin-bottom:0;padding-bottom:0"':'')+'>'
      +'<h3 style="margin-bottom:10px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink2)">'+title+'</h3>'
      +body+'</div>';
  }

  var body='';

  // ── TIME ENTRIES ──
  if(ds==='entries'){
    // Date range
    body+=section('Date Range',
      '<div class="frow c2">'
      +'<div class="fl"><label>From</label><input type="date" id="csvx-dfrom" value="'+H(x.dateFrom||'')+'" onchange="A.csvXOpt(\'dateFrom\',this.value)"></div>'
      +'<div class="fl"><label>To</label><input type="date" id="csvx-dto" value="'+H(x.dateTo||'')+'" onchange="A.csvXOpt(\'dateTo\',this.value)"></div>'
      +'</div>'
      +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">'
      +['today','week','month','quarter','year','all'].map(function(p){
        var lbl={today:'Today',week:'This Week',month:'This Month',quarter:'This Quarter',year:'This Year',all:'All Time'}[p];
        return '<button class="btn btn-gh" style="font-size:11px;padding:4px 10px" onclick="A.csvXPreset(\''+p+'\')">'+lbl+'</button>';
      }).join('')+'</div>'
    );

    // Client filter
    var clOpts=ST.clients.slice().sort(function(a,b){return a.name.localeCompare(b.name);});
    var clBody=chkBox('csvx-allcl',x.allClients,'A.csvXAllClients(this.checked)','All clients','');
    if(!x.allClients){
      clBody+='<div style="max-height:120px;overflow-y:auto;border:1px solid var(--border);border-radius:7px;padding:4px 8px;margin-top:6px;background:var(--bg)">';
      if(clOpts.length===0) clBody+='<p style="font-size:11px;color:var(--ink3);padding:4px 0">No clients yet</p>';
      clOpts.forEach(function(c){
        clBody+=chkBox('','!!x.clientIds["'+c.id+'"]','',(x.clientIds[c.id]?'checked':'')+'  — actually use inline','')+' ';
        // rebuild properly:
      });
      clBody='<div style="max-height:120px;overflow-y:auto;border:1px solid var(--border);border-radius:7px;padding:4px 8px;margin-top:6px;background:var(--bg)">';
      clOpts.forEach(function(c){
        var ck=x.clientIds[c.id]?'checked':'';
        clBody+='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:3px 0">'
          +'<input type="checkbox" '+ck+' onchange="A.csvXTogClient('+c.id+',this.checked)" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'
          +H(c.name)+'</label>';
      });
      clBody+='</div>';
    }
    body+=section('Clients', clBody);

    // Matter filter
    var maOpts=ST.matters.slice().sort(function(a,b){return a.name.localeCompare(b.name);});
    var maBody=chkBox('csvx-allma',x.allMatters,'A.csvXAllMatters(this.checked)','All matters','');
    if(!x.allMatters){
      maBody+='<div style="max-height:120px;overflow-y:auto;border:1px solid var(--border);border-radius:7px;padding:4px 8px;margin-top:6px;background:var(--bg)">';
      maOpts.forEach(function(m){
        var cl=_lu.cl[m.clientId];
        var ck=x.matterIds[m.id]?'checked':'';
        maBody+='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:3px 0">'
          +'<input type="checkbox" '+ck+' onchange="A.csvXTogMatter('+m.id+',this.checked)" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'
          +H(m.name)+(cl?' <span style="color:var(--ink3);font-size:11px">'+H(cl.name)+'</span>':'')+'</label>';
      });
      maBody+='</div>';
    }
    body+=section('Matters', maBody);

    // Columns
    var c=x.cols;
    body+=section('Columns',colGrid(
      chkBox('','c.date','A.csvXTogCol(\'date\')','Date',''+(c.date?'checked':''))
      +chkBox('','c.client','A.csvXTogCol(\'client\')','Client',''+(c.client?'checked':''))
      +chkBox('','c.matter','A.csvXTogCol(\'matter\')','Matter',''+(c.matter?'checked':''))
      +chkBox('','c.contact','A.csvXTogCol(\'contact\')','Billing Contact',''+(c.contact?'checked':''))
      +chkBox('','c.hours','A.csvXTogCol(\'hours\')','Hours',''+(c.hours?'checked':''))
      +chkBox('','c.rate','A.csvXTogCol(\'rate\')','Rate',''+(c.rate?'checked':''))
      +chkBox('','c.amount','A.csvXTogCol(\'amount\')','Amount',''+(c.amount?'checked':''))
      +chkBox('','c.desc','A.csvXTogCol(\'desc\')','Description',''+(c.desc?'checked':''))
      +chkBox('','c.by','A.csvXTogCol(\'by\')','Created By',''+(c.by?'checked':''))
      +chkBox('','c.abaCode','A.csvXTogCol(\'abaCode\')','ABA Task Code',''+(c.abaCode?'checked':''))
      +chkBox('','c.entryId','A.csvXTogCol(\'entryId\')','Entry ID',''+(c.entryId?'checked':''))
    ));
    // Rebuild columns section with correct checked state
    var c2=x.cols;
    function cRow(colKey,label){
      return '<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:4px 0">'
        +'<input type="checkbox" '+(c2[colKey]?'checked':'')+' onchange="A.csvXTogCol(\''+colKey+'\')" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'
        +label+'</label>';
    }
    // Redo body properly (clear the above attempt at columns)
    // I'll redo the whole entries body cleanly below.
  }

  // ─── Rebuild entries body cleanly ───
  body='';

  if(ds==='entries'){
    // Date range
    var drBody='<div class="frow c2">'
      +'<div class="fl"><label>From</label><input type="date" id="csvx-dfrom" value="'+H(x.dateFrom||'')+'" onchange="A.csvXOpt(\'dateFrom\',this.value)"></div>'
      +'<div class="fl"><label>To</label><input type="date" id="csvx-dto" value="'+H(x.dateTo||'')+'" onchange="A.csvXOpt(\'dateTo\',this.value)"></div>'
      +'</div>'
      +'<div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:7px">'
      +['today','week','month','quarter','year','all'].map(function(p){
        var lbl={today:'Today',week:'This Week',month:'This Month',quarter:'This Quarter',year:'This Year',all:'All Time'}[p];
        return '<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXPreset(\''+p+'\')">'+lbl+'</button>';
      }).join('')+'</div>';
    body+=section('Date Range',drBody);

    // Client filter
    var clOpts2=ST.clients.slice().sort(function(a,b){return a.name.localeCompare(b.name);});
    var clBd='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:3px 0">'
      +'<input type="checkbox" '+(x.allClients?'checked':'')+' onchange="A.csvXAllClients(this.checked)" style="width:13px;height:13px;cursor:pointer">'
      +'<strong>All clients</strong></label>';
    if(!x.allClients && clOpts2.length>0){
      clBd+='<div style="max-height:110px;overflow-y:auto;border:1px solid var(--border);border-radius:7px;padding:4px 8px;margin-top:6px;background:var(--bg)">';
      clOpts2.forEach(function(c){
        clBd+='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:2px 0">'
          +'<input type="checkbox" '+(x.clientIds[c.id]?'checked':'')+' onchange="A.csvXTogClient('+c.id+',this.checked)" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'
          +H(c.name)+'</label>';
      });
      clBd+='</div>';
    } else if(!x.allClients){
      clBd+='<p style="font-size:11px;color:var(--ink3);margin-top:6px">No clients in database.</p>';
    }
    body+=section('Filter by Client',clBd);

    // Matter filter
    var maOpts2=ST.matters.slice().sort(function(a,b){return a.name.localeCompare(b.name);});
    var maBd='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:3px 0">'
      +'<input type="checkbox" '+(x.allMatters?'checked':'')+' onchange="A.csvXAllMatters(this.checked)" style="width:13px;height:13px;cursor:pointer">'
      +'<strong>All matters</strong></label>';
    if(!x.allMatters && maOpts2.length>0){
      maBd+='<div style="max-height:110px;overflow-y:auto;border:1px solid var(--border);border-radius:7px;padding:4px 8px;margin-top:6px;background:var(--bg)">';
      maOpts2.forEach(function(m){
        var cl=_lu.cl[m.clientId];
        maBd+='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:2px 0">'
          +'<input type="checkbox" '+(x.matterIds[m.id]?'checked':'')+' onchange="A.csvXTogMatter('+m.id+',this.checked)" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'
          +H(m.name)+(cl?' <span style="color:var(--ink3);font-size:11px">— '+H(cl.name)+'</span>':'')+'</label>';
      });
      maBd+='</div>';
    } else if(!x.allMatters){
      maBd+='<p style="font-size:11px;color:var(--ink3);margin-top:6px">No matters in database.</p>';
    }
    body+=section('Filter by Matter',maBd);

    // Columns
    function eCol(k,lbl){ return '<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:4px 0"><input type="checkbox" '+(x.cols[k]?'checked':'')+' onchange="A.csvXTogCol(\''+k+'\')" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'+lbl+'</label>'; }
    body+=section('Columns',
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 20px">'
      +eCol('date','Date')
      +eCol('client','Client')
      +eCol('matter','Matter')
      +eCol('contact','Billing Contact')
      +eCol('hours','Hours')
      +eCol('rate','Rate')
      +eCol('amount','Amount')
      +eCol('desc','Description')
      +eCol('by','Created By')
      +eCol('abaCode','ABA Task Code')
      +eCol('entryId','Entry ID')
      +'</div>'
      +'<div style="display:flex;gap:6px;margin-top:8px">'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllCols(true)">Select All</button>'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllCols(false)">Clear</button>'
      +'</div>'
    );

    // Grouping & structure
    var grpOpts=[
      {v:'none',l:'Flat list (no grouping)'},
      {v:'client',l:'Group by Client'},
      {v:'matter',l:'Group by Matter'},
      {v:'date-month',l:'Group by Month'},
      {v:'date-week',l:'Group by Week'}
    ].map(function(o){
      return '<option value="'+o.v+'"'+(x.groupBy===o.v?' selected':'')+'>'+o.l+'</option>';
    }).join('');
    var strBd='<div class="fl" style="margin-bottom:10px"><label>Group by</label>'
      +'<select onchange="A.csvXOpt(\'groupBy\',this.value)">'+grpOpts+'</select></div>';
    if(x.groupBy!=='none'){
      strBd+='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;margin-bottom:6px">'
        +'<input type="checkbox" '+(x.includeTotals?'checked':'')+' onchange="A.csvXOpt(\'includeTotals\',this.checked)" style="width:13px;height:13px;cursor:pointer">Include subtotal rows per group</label>'
        +'<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer">'
        +'<input type="checkbox" '+(x.includeGrandTotal?'checked':'')+' onchange="A.csvXOpt(\'includeGrandTotal\',this.checked)" style="width:13px;height:13px;cursor:pointer">Include grand total row</label>';
    } else {
      strBd+='<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer">'
        +'<input type="checkbox" '+(x.includeGrandTotal?'checked':'')+' onchange="A.csvXOpt(\'includeGrandTotal\',this.checked)" style="width:13px;height:13px;cursor:pointer">Include grand total row at end</label>';
    }
    body+=section('Structure', strBd);
  }

  // ── CLIENTS ──
  if(ds==='clients'){
    function clCol(k,lbl){ return '<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:4px 0"><input type="checkbox" '+(x.clCols[k]?'checked':'')+' onchange="A.csvXTogClCol(\''+k+'\')" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'+lbl+'</label>'; }
    body+=section('Columns',
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 20px">'
      +clCol('name','Name')
      +clCol('email','Email')
      +clCol('phone','Phone')
      +clCol('rate','Default Rate')
      +clCol('contact','Primary Contact')
      +'</div>'
      +'<div style="display:flex;gap:6px;margin-top:8px">'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllClCols(true)">Select All</button>'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllClCols(false)">Clear</button>'
      +'</div>',true
    );
  }

  // ── MATTERS ──
  if(ds==='matters'){
    function maCol(k,lbl){ return '<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:4px 0"><input type="checkbox" '+(x.maCols[k]?'checked':'')+' onchange="A.csvXTogMaCol(\''+k+'\')" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'+lbl+'</label>'; }
    body+=section('Columns',
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 20px">'
      +maCol('name','Name')
      +maCol('client','Client')
      +maCol('desc','Description')
      +maCol('rate','Default Rate')
      +maCol('contact','Billing Contact')
      +'</div>'
      +'<div style="display:flex;gap:6px;margin-top:8px">'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllMaCols(true)">Select All</button>'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllMaCols(false)">Clear</button>'
      +'</div>',true
    );
  }

  // ── CONTACTS ──
  if(ds==='contacts'){
    function ctCol(k,lbl){ return '<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:4px 0"><input type="checkbox" '+(x.ctCols[k]?'checked':'')+' onchange="A.csvXTogCtCol(\''+k+'\')" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'+lbl+'</label>'; }
    body+=section('Columns',
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 20px">'
      +ctCol('name','Name')
      +ctCol('role','Role')
      +ctCol('email','Email')
      +ctCol('phone','Phone')
      +ctCol('rate','Rate')
      +ctCol('ownPct','Ownership %')
      +'</div>'
      +'<div style="display:flex;gap:6px;margin-top:8px">'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllCtCols(true)">Select All</button>'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="A.csvXAllCtCols(false)">Clear</button>'
      +'</div>',true
    );
  }

  // ── OUTPUT FORMAT (shared) ──
  var dfOpts=[
    {v:'iso',l:'ISO (2025-01-31)'},
    {v:'us',l:'US (01/31/2025)'},
    {v:'uk',l:'UK (31/01/2025)'},
    {v:'long',l:'Long (January 31, 2025)'}
  ].map(function(o){return '<option value="'+o.v+'"'+(x.dateFormat===o.v?' selected':'')+'>'+o.l+'</option>';}).join('');
  var outBd='<div class="frow c2">'
    +'<div class="fl"><label>Date format</label><select onchange="A.csvXOpt(\'dateFormat\',this.value)">'+dfOpts+'</select></div>'
    +'<div class="fl"><label>Filename prefix <span style="font-size:10px;color:var(--ink3)">(optional)</span></label>'
    +'<input type="text" placeholder="e.g. acme_" value="'+H(x.filenamePrefix||'')+'" onchange="A.csvXOpt(\'filenamePrefix\',this.value)"></div>'
    +'</div>'
    +(ds==='entries'?'<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;margin-top:6px">'
      +'<input type="checkbox" '+(x.currencySymbol?'checked':'')+' onchange="A.csvXOpt(\'currencySymbol\',this.checked)" style="width:13px;height:13px;cursor:pointer">Include $ symbol in currency fields (uncheck for numeric-only)</label>':'');
  body+=section('Output Format', outBd, true);

  // ── Row count preview ──
  var rowCount=A._csvXCount();
  var preview='<div style="background:var(--bg2);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;margin-bottom:0">'
    +'<span>'+IC.list+' <strong style="color:var(--ink)">'+rowCount+'</strong> row'+(rowCount!==1?'s':'')+' will be exported'
    +(ds==='entries'&&(x.dateFrom||x.dateTo)?'&ensp;<span style="color:var(--ink3)">'+(x.dateFrom?'from '+H(x.dateFrom):'')+(x.dateTo?' to '+H(x.dateTo):'')+'</span>':'')
    +'</span></div>';

  return '<div class="ov"><div class="modal" style="max-width:680px;width:96vw;max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.dl+' Export to CSV</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div style="padding:14px 20px 0;border-bottom:1px solid var(--border)">'
    +'<div style="display:flex;gap:6px;margin-bottom:14px">'+dsBtns+'</div>'
    +'</div>'
    +'<div class="modal-bd" style="flex:1;overflow-y:auto;padding-top:16px">'+body+'</div>'
    +'<div style="padding:12px 20px;border-top:1px solid var(--border);background:var(--white);display:flex;flex-direction:column;gap:10px">'
    +preview
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.csvExport()"'+(rowCount===0?' disabled title="No data to export"':'')+'>'+IC.dl+' Export CSV</button>'
    +'</div>'
    +'</div>'
    +'</div></div>';
}

function buildImportModal(){
  return '<div class="ov"><div class="modal modal-md"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.ul+' Restore / Import Data</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
  +'<div class="modal-bd">'

  +'<div class="note" style="margin-bottom:16px">These options import <strong>your own data</strong> — JSON backups and firm profiles. To receive a submission from a colleague, use the <strong>📥 Receive Submission</strong> button on the Timesheet or Approvals tab.</div>'

  // Firm Profile
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">🏢 Firm Profile</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Import a firm profile distributed by your IT administrator. Applies branding, pre-configured clients, contacts, description presets, and user profiles.</p>'
  +'<input type="file" id="imp-profile" accept=".json" style="display:none" onchange="A.importFirmProfile(this)">'
  +'<button class="btn btn-dk" onclick="document.getElementById(\'imp-profile\').click()">'+IC.ul+' Import Firm Profile (.json)</button>'
  +'</div>'

  // Full JSON backup restore
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">'+IC.save+' Full Backup Restore</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Restore a complete JSON backup of your own data. <strong style="color:var(--red)">Replaces all current data.</strong></p>'
  +'<input type="file" id="imp-json" accept=".json" style="display:none" onchange="A.importJSON(this)">'
  +'<button class="btn btn-dk" onclick="document.getElementById(\'imp-json\').click()">'+IC.ul+' Choose Backup File (.json)</button>'
  +'</div>'

  +'</div>'
  +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Close</button></div>'
  +'</div></div>';
}
function buildSettings(){
  var s=ST.settings;
  var stab=ST.settingsTab||'export';
  var settingsTabs=[['export','Backup'],['appearance','Appearance'],['descriptions','Descriptions'],['email','Email'],['advanced','Advanced']];
  var tabNav='<div class="set-tabs">'+settingsTabs.map(function(t){return '<button class="set-tab'+(stab===t[0]?' on':'')+'" onclick="A.setStab(\''+t[0]+'\')">'+H(t[1])+'</button>';}).join('')+'</div>';
  var body='';

  if(stab==='export'){
    var q=ST.prefs.csvQuick;
    var qds=q.dataset;

    // ── Dataset selector ──
    var qDsBtns=['entries','clients','matters','contacts'].map(function(d){
      var lbls={entries:'Time Entries',clients:'Clients',matters:'Matters',contacts:'Contacts'};
      return '<button class="btn'+(qds===d?' btn-dk':' btn-gh')+'" style="flex:1;justify-content:center;font-size:12px;padding:7px 4px" onclick="A.csvQPref(\'dataset\',\''+d+'\')">'+lbls[d]+'</button>';
    }).join('');

    // ── Column checkbox helper ──
    function qCB(colKey,label,colObj,onchangeFn){
      return '<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:4px 0">'
        +'<input type="checkbox" '+(colObj[colKey]?'checked':'')+' onchange="'+onchangeFn+'(\''+colKey+'\')" style="width:13px;height:13px;cursor:pointer;flex-shrink:0">'
        +label+'</label>';
    }
    function qColGrid(cols){ return '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 20px">'+cols+'</div>'; }
    function qSelectAll(onAll,onClear){
      return '<div style="display:flex;gap:6px;margin-top:7px">'
        +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="'+onAll+'">All</button>'
        +'<button class="btn btn-gh" style="font-size:11px;padding:4px 9px" onclick="'+onClear+'">Clear</button>'
        +'</div>';
    }

    // ── Date preset (entries only) ──
    var qDatePresets=['today','week','month','quarter','year','all'];
    var qDateLabels={today:'Today',week:'This Week',month:'This Month',quarter:'This Quarter',year:'This Year',all:'All Time'};
    var qDateBtns=qDatePresets.map(function(p){
      return '<button class="btn'+(q.datePreset===p?' btn-dk':' btn-gh')+'" style="font-size:11px;padding:5px 10px" onclick="A.csvQPref(\'datePreset\',\''+p+'\')">'+qDateLabels[p]+'</button>';
    }).join('');

    // ── Grouping options (entries only) ──
    var qGrpOpts=[
      {v:'none',l:'No grouping'},
      {v:'client',l:'By Client'},
      {v:'matter',l:'By Matter'},
      {v:'date-month',l:'By Month'},
      {v:'date-week',l:'By Week'}
    ].map(function(o){
      return '<option value="'+o.v+'"'+(q.groupBy===o.v?' selected':'')+'>'+o.l+'</option>';
    }).join('');

    // ── Date format ──
    var qDfOpts=[
      {v:'iso',l:'ISO  2025-01-31'},
      {v:'us', l:'US   01/31/2025'},
      {v:'uk', l:'UK   31/01/2025'},
      {v:'long',l:'Long  January 31, 2025'}
    ].map(function(o){
      return '<option value="'+o.v+'"'+(q.dateFormat===o.v?' selected':'')+'>'+o.l+'</option>';
    }).join('');

    body+='<div class="set-section">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<h3 style="margin:0">Quick CSV Export</h3>'
      +'<button class="btn btn-dk" style="gap:6px;padding:7px 14px" onclick="A.csvQuickExport()">'+IC.dl+' Download CSV now</button>'
      +'</div>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.5">Configure what the <strong>CSV</strong> button in the header downloads. Settings are saved automatically. For a one-off custom export use the <button class="btn btn-gh" style="font-size:11px;padding:3px 9px;display:inline-flex" onclick="A.openExportModal()">Export wizard…</button>.</p>'

      // Dataset
      +'<div style="margin-bottom:16px">'
      +'<div style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Dataset</div>'
      +'<div style="display:flex;gap:6px">'+qDsBtns+'</div>'
      +'</div>'

      // Date range (entries only)
      +(qds==='entries'
        ?'<div style="margin-bottom:16px">'
          +'<div style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Date Range</div>'
          +'<div style="display:flex;gap:5px;flex-wrap:wrap">'+qDateBtns+'</div>'
          +'</div>'
        :'')

      // Columns
      +'<div style="margin-bottom:16px">'
      +'<div style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Columns</div>'
      +(qds==='entries'
        ?qColGrid(
           qCB('date','Date',q.cols,'A.csvQTogCol')
          +qCB('client','Client',q.cols,'A.csvQTogCol')
          +qCB('matter','Matter',q.cols,'A.csvQTogCol')
          +qCB('contact','Billing Contact',q.cols,'A.csvQTogCol')
          +qCB('hours','Hours',q.cols,'A.csvQTogCol')
          +qCB('rate','Rate',q.cols,'A.csvQTogCol')
          +qCB('amount','Amount',q.cols,'A.csvQTogCol')
          +qCB('desc','Description',q.cols,'A.csvQTogCol')
          +qCB('by','Created By',q.cols,'A.csvQTogCol')
          +qCB('abaCode','ABA Task Code',q.cols,'A.csvQTogCol')
          +qCB('entryId','Entry ID',q.cols,'A.csvQTogCol')
        )
        +qSelectAll('A.csvQAllCols(true)','A.csvQAllCols(false)')
        :'')
      +(qds==='clients'
        ?qColGrid(
           qCB('name','Name',q.clCols,'A.csvQTogClCol')
          +qCB('email','Email',q.clCols,'A.csvQTogClCol')
          +qCB('phone','Phone',q.clCols,'A.csvQTogClCol')
          +qCB('rate','Default Rate',q.clCols,'A.csvQTogClCol')
          +qCB('contact','Primary Contact',q.clCols,'A.csvQTogClCol')
        )
        +qSelectAll('A.csvQAllClCols(true)','A.csvQAllClCols(false)')
        :'')
      +(qds==='matters'
        ?qColGrid(
           qCB('name','Name',q.maCols,'A.csvQTogMaCol')
          +qCB('client','Client',q.maCols,'A.csvQTogMaCol')
          +qCB('desc','Description',q.maCols,'A.csvQTogMaCol')
          +qCB('rate','Default Rate',q.maCols,'A.csvQTogMaCol')
          +qCB('contact','Billing Contact',q.maCols,'A.csvQTogMaCol')
        )
        +qSelectAll('A.csvQAllMaCols(true)','A.csvQAllMaCols(false)')
        :'')
      +(qds==='contacts'
        ?qColGrid(
           qCB('name','Name',q.ctCols,'A.csvQTogCtCol')
          +qCB('role','Role',q.ctCols,'A.csvQTogCtCol')
          +qCB('email','Email',q.ctCols,'A.csvQTogCtCol')
          +qCB('phone','Phone',q.ctCols,'A.csvQTogCtCol')
          +qCB('rate','Rate',q.ctCols,'A.csvQTogCtCol')
          +qCB('ownPct','Ownership %',q.ctCols,'A.csvQTogCtCol')
        )
        +qSelectAll('A.csvQAllCtCols(true)','A.csvQAllCtCols(false)')
        :'')
      +'</div>'

      // Grouping & structure (entries only)
      +(qds==='entries'
        ?'<div style="margin-bottom:16px">'
          +'<div style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Structure</div>'
          +'<div class="frow c2">'
          +'<div class="fl"><label style="font-size:12px">Group by</label><select onchange="A.csvQPref(\'groupBy\',this.value)">'+qGrpOpts+'</select></div>'
          +'</div>'
          +(q.groupBy!=='none'
            ?'<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;margin-top:7px"><input type="checkbox" '+(q.includeTotals?'checked':'')+' onchange="A.csvQPref(\'includeTotals\',this.checked)" style="width:13px;height:13px;cursor:pointer">Subtotal rows per group</label>'
            :'')
          +'<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;margin-top:6px"><input type="checkbox" '+(q.includeGrandTotal?'checked':'')+' onchange="A.csvQPref(\'includeGrandTotal\',this.checked)" style="width:13px;height:13px;cursor:pointer">'+(q.groupBy!=='none'?'Grand total row':'Total row at end')+'</label>'
          +'</div>'
        :'')

      // Output format
      +'<div style="margin-bottom:0">'
      +'<div style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Output Format</div>'
      +'<div class="frow c2">'
      +'<div class="fl"><label style="font-size:12px">Date format</label><select onchange="A.csvQPref(\'dateFormat\',this.value)">'+qDfOpts+'</select></div>'
      +'<div class="fl"><label style="font-size:12px">Filename prefix <span style="font-size:10px;color:var(--ink3)">(optional)</span></label>'
      +'<input type="text" placeholder="e.g. acme_" value="'+H(q.filenamePrefix||'')+'" onchange="A.csvQPref(\'filenamePrefix\',this.value)"></div>'
      +'</div>'
      +(qds==='entries'
        ?'<label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;margin-top:7px"><input type="checkbox" '+(q.currencySymbol?'checked':'')+' onchange="A.csvQPref(\'currencySymbol\',this.checked)" style="width:13px;height:13px;cursor:pointer">Include $ symbol in currency fields</label>'
        :'')
      +'</div>'

      +'</div>'

      +'<div class="set-section">'
      +'<h3 style="margin-bottom:8px">Full Backup</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px;line-height:1.5">Export everything (clients, matters, entries, contacts, settings, preferences) as a single JSON file. Perfect for complete backups before browser changes.</p>'
      +'<div style="display:flex;gap:8px;flex-wrap:wrap">'
      +'<button class="btn btn-dk" onclick="A.exportJSON()">'+IC.dl+' Download Full Backup (.json)</button>'
      +'</div></div>'
      +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3 style="margin-bottom:8px">Restore</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px;line-height:1.5">Restore a previously downloaded JSON backup file.</p>'
      +'<div style="display:flex;gap:8px;flex-wrap:wrap">'
      +'<button class="btn btn-gh" onclick="ST.modal=\'importData\';render()">'+IC.ul+' Restore / Import…</button>'
      +'</div></div>'

    // ── Firm Profile Builder ─────────────────────────────────────────────────────────────────────────────────────
    var fp=ST.firmProfile||{};
    var itUsers=fp.users||[];
    body+='<div class="set-section" style="margin-top:8px">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<h3 style="margin:0">Firm Profile Builder</h3>'
      +'<label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">'
      +'<input type="checkbox" '+(ST.itMode?'checked':'')+' onchange="A.togITMode(this.checked)">'
      +'<span>'+(ST.itMode?'<strong style="color:var(--blue)">Enabled</strong>':'Disabled')+'</span></label>'
      +'</div>'
      +'<p style="font-size:12px;color:var(--ink3);line-height:1.6;margin-bottom:0">Build a shareable firm profile — pre-configured clients, contacts, users, and description presets — that team members can import on first setup or via Restore / Import.</p>'
      +'</div>'
      +(ST.itMode?
        '<div class="set-section">'
        +'<h3>Pre-configured Users</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:12px;line-height:1.5">Users defined here appear as selectable profiles when a new user imports the firm profile. Each gets their own name, initials, role, rate, and ownership %.</p>'
        +(itUsers.length>0
          ? itUsers.map(function(u,i){
              return '<div class="crow" style="margin-bottom:8px;background:var(--bg);border-radius:8px;padding:10px 14px">'
                +'<div style="flex:1"><strong style="font-size:13px">'+H(u.name)+'</strong>'
                +'<div style="font-size:11px;color:var(--ink3)">'+H(u.initials||'')+(u.role?' | '+H(u.role):'')+(u.rate?' | $'+H(u.rate)+'/hr':'')+(u.ownPct!=null?' | '+H(String(u.ownPct))+'% cut':'')+'</div></div>'
                +'<button class="btn-ic" onclick="A.editITUser('+i+')" title="Edit">'+IC.edit+'</button>'
                +'<button class="btn-ic" onclick="A.delITUser('+i+')" title="Delete">'+IC.trash+'</button>'
                +'</div>';
            }).join('')
          : '<div class="empty" style="padding:16px"><p>No users configured</p></div>'
        )
        +'<button class="btn btn-dk" style="margin-top:10px" onclick="A.openITUser(null)">'+IC.plus+' Add User</button>'
        +'</div>'
        +'<div class="set-section">'
        +'<h3>Data to Bundle into Profile</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:12px;line-height:1.5">Choose which current app data to bundle into the exported profile. New users who import the profile will receive this data as a starting point.</p>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-clients" '+(fp.includeClients?'checked':'')+' onchange="A.togITInclude(\'includeClients\',this.checked)"><div><strong>Clients</strong><span>'+ST.clients.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-matters" '+(fp.includeMatters?'checked':'')+' onchange="A.togITInclude(\'includeMatters\',this.checked)"><div><strong>Matters</strong><span>'+ST.matters.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-contacts" '+(fp.includeContacts?'checked':'')+' onchange="A.togITInclude(\'includeContacts\',this.checked)"><div><strong>Contacts</strong><span>'+ST.contacts.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-presets" '+(fp.includePresets?'checked':'')+' onchange="A.togITInclude(\'includePresets\',this.checked)"><div><strong>Description Presets</strong><span>'+ST.descPresets.length+' in app</span></div></label>'
        +'</div>'
        +'</div>'
        +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
        +'<h3>Export &amp; Share</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.5">Download the firm profile as a <code style="font-size:11px;background:var(--bg);padding:1px 5px;border-radius:4px">.json</code> file. Share it with your team — they import it via Backup → Restore / Import.</p>'
        +'<button class="btn btn-gr" onclick="A.exportFirmProfile()">'+IC.dl+' Download Firm Profile (.json)</button>'
        +'</div>'
      : '')
    ;
  }

  if(stab==='appearance'){
    var p=ST.prefs;
    var layouts=[['comfortable','Comfortable','Default balanced spacing'],['compact','Compact','Dense UI for more data'],['spacious','Spacious','Relaxed layout, larger text']];
    var fp2=ST.firmProfile||{};
    body+='<div class="set-section">'
      +'<h3>Firm Identity</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.5">Set your firm name and the name that appears in the app header and exports.</p>'
      +'<div class="frow c2" style="margin-bottom:12px">'
      +'<div class="fl"><label>Firm Name</label><input type="text" id="it-firmname" value="'+H(fp2.firmName||'')+'" placeholder="e.g. Smith &amp; Associates LLP" style="padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink);width:100%;box-sizing:border-box" /></div>'
      +'<div class="fl"><label>App Name</label><input type="text" id="pref-name" value="'+H(p.appName||'SixMinuteLog.com')+'" placeholder="SixMinuteLog.com" style="padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink);width:100%;box-sizing:border-box" /></div>'
      +'</div>'
      +'<button class="btn btn-dk" onclick="A.saveAppName()">Save Firm Identity</button>'
      +'</div>'
      +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>Dark Mode</h3>'
      +'<div class="preset-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:18px">'
      +[['null','Auto','Follows your browser or OS setting'],['false','Light','Always use light theme'],['true','Dark','Always use dark theme']].map(function(opt){
        var active=String(p.darkMode)===opt[0];
        return '<button class="preset-btn'+(active?' on':'')+'" style="'+(active?'border-color:var(--ink);background:var(--bg)':'')+'" onclick="A.setDarkMode('+opt[0]+')"><strong>'+opt[1]+'</strong><span style="font-size:11px;color:var(--ink3);display:block;margin-top:2px">'+opt[2]+'</span></button>';
      }).join('')
      +'</div>'
      +'<h3>Layout Density</h3>'
      +'<div class="preset-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:0">'
      +layouts.map(function(l){return '<button class="preset-btn'+(p.layout===l[0]?' on':'')+'" style="'+(p.layout===l[0]?'border-color:var(--ink);background:var(--bg)':'')+'" onclick="A.setLayout(\''+l[0]+'\')"><strong>'+H(l[1])+'</strong><span style="font-size:11px;color:var(--ink3);display:block;margin-top:2px">'+H(l[2])+'</span></button>';}).join('')
      +'</div></div>';
  }

  if(stab==='descriptions'){
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>Default Description Suggestions</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.6">These appear as clickable chips below description fields in the time entry form and Quick Log, letting you quickly select common descriptions.</p>'
      +(ST.descPresets.length>0
        ? ST.descPresets.map(function(p,i){
          return '<div class="preset-item"><span>'+H(p)+'</span>'
            +'<button title="Move up" onclick="A.moveDesc('+i+',-1)">'
              +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg>'
            +'</button>'
            +'<button title="Move down" onclick="A.moveDesc('+i+',1)">'
              +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>'
            +'</button>'
            +'<button title="Edit" onclick="A.editDescPreset('+i+')" style="color:var(--blue)">'+IC.edit+'</button>'
            +'<button title="Delete" onclick="A.delDesc('+i+')">'+IC.trash+'</button>'
            +'</div>';
        }).join('')
        : '<div class="empty" style="padding:24px"><p>No descriptions yet</p></div>'
      )
      +'<div style="display:flex;gap:8px;margin-top:12px">'
      +'<input type="text" id="desc-new" placeholder="Add a description suggestion..." style="flex:1;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)" onkeydown="if(event.key===\'Enter\')A.addDesc()">'
      +'<button class="btn btn-dk" onclick="A.addDesc()">'+IC.plus+' Add</button>'
      +'</div></div>';
  }

  if(stab==='email'){
    var PRIO_STYLE={high:'color:var(--red)',normal:'color:var(--ink3)',low:'color:var(--ink3)'};
    var PRIO_LABEL={high:'\u25b2 High',normal:'Normal',low:'\u25bc Low'};
    var TYPE_LABELS={invClient:'Invoice → Client',invApproval:'Partner Approval',invDecision:'Review Decision',tsApproval:'Submit for Approval',tsSummary:'Billing Summary',all:'All types'};
    // ── Mail / CSV Presets ─────────────────────────────────────────────────────
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>Email Presets</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.6">Reusable email compositions — define recipient, subject, body, and signature. Selecting a preset opens your default mail client with everything pre-filled.</p>'
      +(ST.mailPresets.length>0
        ? ST.mailPresets.map(function(mp,i){
          var pri=mp.priority||'normal';
          return '<div class="mail-preset-card">'
            +'<div class="mp-acts">'
            +'<button class="btn-ic" onclick="A.dupMailPreset('+i+')" title="Duplicate">'+IC.copy+'</button>'
            +'<button class="btn-ic" onclick="A.editMailPreset('+i+')" title="Edit">'+IC.edit+'</button>'
            +'<button class="btn-ic" onclick="A.delMailPreset('+i+')" title="Delete">'+IC.trash+'</button>'
            +'</div>'
            +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">'
            +'<h4 style="margin:0">'+H(mp.name||'Preset '+(i+1))+'</h4>'
            +'<span class="status-badge '+(({general:'s-neutral',invoice_client:'s-approved',billing_staff:'s-review',partner_approval:'s-pending'}[mp.purpose||'general']||'s-neutral')+'" style="font-size:10px;padding:2px 7px">'+purposeLabel(mp.purpose||'general')+'</span>')
            +(pri!=='normal'?'<span style="font-size:10px;font-weight:600;'+PRIO_STYLE[pri]+'">'+PRIO_LABEL[pri]+'</span>':'')
            +'</div>'
            +(mp.to?'<p>To: '+H(mp.to)+'</p>':'<p style="color:var(--ink3);font-size:11px">To: auto-filled from context</p>')
            +(mp.cc?'<p style="font-size:11px">CC: '+H(mp.cc)+'</p>':'')
            +(mp.bcc?'<p style="font-size:11px">BCC: '+H(mp.bcc)+'</p>':'')
            +(mp.replyTo?'<p style="font-size:11px">Reply-To: '+H(mp.replyTo)+'</p>':'')
            +(mp.subject?'<p>Subject: '+H(mp.subject)+'</p>':'')
            +(mp.body?'<p style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:400px;font-size:11px;color:var(--ink3)">'+H(mp.body)+'</p>':'')
            +(mp.signature?'<p style="font-size:10px;color:var(--ink3);font-style:italic">\u2014 Signature attached</p>':'')
            +'<button class="btn btn-bl" style="margin-top:10px;font-size:12px" onclick="A.sendMailPreset('+i+')">'+IC.mail+' Send via Email</button>'
            +'</div>';
        }).join('')
        : '<div class="empty" style="padding:20px"><p>No email presets yet</p></div>'
      )
      +'<button class="btn btn-dk" style="margin-top:12px" onclick="A.openMailPreset(null)">'+IC.plus+' New Email Preset</button>'
      +'</div>'
    // ── Placeholder editor ─────────────────────────────────────────────────
    +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<div><h3 style="margin:0">Email Placeholders</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin:4px 0 0;line-height:1.5">Custom tokens like <code style="font-size:11px;background:var(--bg);padding:1px 5px;border-radius:4px">{my_token}</code> you can insert into subject and body fields. Built-in placeholders are filled automatically; custom ones use the value you set here.</p></div>'
      +'<button class="btn btn-dk" onclick="A.openMailPH(null)">'+IC.plus+' New Placeholder</button>'
      +'</div>'
      // Built-in placeholders table
      +'<div style="margin-bottom:14px">'
      +'<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:6px">Built-in (auto-filled)</div>'
      +'<div style="display:grid;grid-template-columns:auto 1fr auto;gap:0;border:1px solid var(--brd);border-radius:8px;overflow:hidden">'
      +BUILTIN_PH.map(function(p,i){
        var bg=i%2===0?'background:var(--bg)':'background:var(--white)';
        return '<div style="'+bg+';padding:5px 10px;font-family:monospace;font-size:11px;color:var(--blue);border-bottom:1px solid var(--brd)">'+H(p[0])+'</div>'
          +'<div style="'+bg+';padding:5px 10px;font-size:11px;color:var(--ink2);border-bottom:1px solid var(--brd)">'+H(p[1])+'<span style="color:var(--ink3);margin-left:6px;font-size:10px">'+H(p[3])+'</span></div>'
          +'<div style="'+bg+';padding:5px 10px;font-size:10px;color:var(--ink3);border-bottom:1px solid var(--brd);white-space:nowrap">e.g. '+H(p[2])+'</div>';
      }).join('')
      +'</div>'
      +'</div>'
      // Custom placeholders
      +(ST.mailPlaceholders.length>0
        ? '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:6px">Custom</div>'
          +'<div style="border:1px solid var(--brd);border-radius:8px;overflow:hidden">'
          +ST.mailPlaceholders.map(function(p,i){
            var bg=i%2===0?'background:var(--bg)':'background:var(--white)';
            var valueDisplay=p.source==='linked'&&p.linkedField
              ? '<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;background:rgba(59,130,246,.1);color:var(--blue);border-radius:4px;padding:1px 7px;font-weight:500">\uD83D\uDD17 '+H(_lfLabel(p.linkedField))+'</span>'
              : '<span style="font-size:11px;color:var(--ink3)">Value: '+H(p.value||'(empty)')+'</span>';
            return '<div style="'+bg+';display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--brd)">'
              +'<code style="font-size:12px;color:var(--blue);flex-shrink:0">{'+H(p.key)+'}</code>'
              +'<div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:500">'+H(p.label)+'</div>'
              +'<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:1px">'+valueDisplay+'</div></div>'
              +'<button class="btn-ic" onclick="A.openMailPH('+i+')" title="Edit">'+IC.edit+'</button>'
              +'<button class="btn-ic" onclick="A.delMailPH('+i+')" title="Delete" style="color:var(--red)">'+IC.trash+'</button>'
              +'</div>';
          }).join('')
          +'</div>'
        : '<div class="empty" style="padding:14px"><p>No custom placeholders yet</p><small>Add one to create reusable tokens like {my_firm_address} or {partner_name}</small></div>'
      )
      +'</div>';
  }

  if(stab==='advanced'){
    body+='<div class="set-section"><h3>Current User</h3>'
      +'<div style="display:flex;justify-content:space-between;align-items:center;background:var(--bg);border-radius:8px;padding:12px 16px;margin-bottom:10px">'
      +'<div><div style="font-weight:500;font-size:13px">'+H(ST.user?ST.user.name:'Not set')+'</div>'
      +'<div style="font-size:12px;color:var(--ink3)">'+(ST.user&&ST.user.initials?ST.user.initials+' \u00b7 ':'')+( ST.prefs.revenueSplit&&ST.user&&ST.user.ownPct!=null?ST.user.ownPct+'% personal cut\u00b7 ':'')+(ST.user?roleBadge(ST.user.role):'')+' '+'</div></div>'
      +'<button class="btn btn-gh" onclick="A.chgUser()" style="font-size:13px">Edit Profile</button>'
      +'</div></div>'
      +'<div class="set-section"><h3>Analytics &amp; Reporting</h3>'
      +'<label class="crow"><input type="checkbox" '+(ST.prefs.analyticsEnabled?'checked':'')+' onchange="A.togAnalytics(this.checked)"><div><strong>Enable Analytics Tab</strong><span>Show the Analytics tab in the navigation. Includes billing summaries, client breakdowns, revenue split, and per-person earnings.</span></div></label>'
      +'</div>'
      +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<div class="danger"><h3>Danger Zone</h3><p>Permanently delete all data. Export a backup first!</p>'
      +'<button class="btn btn-rd" onclick="A.resetAll()">'+IC.rst+' Reset All Data</button></div>'
      +'</div>';
  }

  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.gear+' Settings</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'+tabNav+body+'</div>'
    +'<div class="modal-ft" style="flex-wrap:wrap;gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
    +'<button class="btn btn-gh" onclick="A.dlManifest()" title="Regenerate CLAUDE_BILLING.md" style="color:var(--purple);border-color:var(--purple)">'+IC.dl+' Claude Guide</button>'
    +'<button class="btn btn-gh" onclick="A.downloadApp()" title="Download app as .html for offline use" style="color:var(--ink2)">&#128190; Save App</button>'
    +'</div></div></div>';
}

function buildITUserModal(){
  var f=ST.itf||{};
  var isEdit=(f.editIdx!=null);
  var roleOpts=[
    {v:'attorney',l:'Attorney'},
    {v:'partner',l:'Partner'},
    {v:'billing_staff',l:'Billing Staff'}
  ].map(function(o){return '<option value="'+o.v+'"'+(f.role===o.v?' selected':'')+'>'+H(o.l)+'</option>';}).join('');
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.usr+' '+(isEdit?'Edit':'Add')+' Profile User</h2>'
    +'<button class="btn-ic" onclick="A.closeITUser()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div class="fl" style="margin-bottom:14px"><label>Name <span class="req">*</span></label>'
    +'<input type="text" id="itu-name" value="'+H(f.name||'')+'" placeholder="e.g. Sarah Johnson" /></div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label>Initials</label><input type="text" id="itu-ini" value="'+H(f.initials||'')+'" maxlength="4" placeholder="SJ" />'
    +'<div class="hint">Auto-generated if blank</div></div>'
    +'<div class="fl"><label>Role</label><select id="itu-role">'+roleOpts+'</select></div>'
    +'</div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label>Default Rate ($/hr)</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="itu-rate" value="'+H(f.rate||'')+'" placeholder="150.00" /></div></div>'
    +(ST.prefs.revenueSplit?'<div class="fl"><label>Personal Cut %</label>'
    +'<div class="pw"><input type="number" id="itu-pct" min="0" max="100" step="1" value="'+H(f.ownPct!=null?String(f.ownPct):'100')+'" placeholder="100" /><span class="sfx">%</span></div></div>':'')
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeITUser()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveITUser()">'+IC.save+' '+(isEdit?'Update':'Add')+' User</button>'
    +'</div></div></div>';
}

// Shared: splash left-panel hero HTML
function splashHero(steps,activeIdx){
  var appName=H(ST.prefs.appName||'SixMinuteLog.com');
  var stepsH=steps.map(function(s,i){
    var cls='splash-step'+(i<activeIdx?' done':i===activeIdx?' active':'');
    return '<div class="'+cls+'"><div class="splash-step-dot"></div><span>'+s+'</span></div>';
  }).join('');
  return '<div class="splash-hero">'
    +'<div class="splash-logo">'
    +'<div class="splash-logo-mark"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>'
    +'<span class="splash-logo-name">'+appName+'</span>'
    +'</div>'
    +'<div class="splash-tagline"><h1>Legal billing,<br><strong>without the friction.</strong></h1>'
    +'<p>Track time, manage clients, and generate invoices \u2014 all in one place, fully offline.</p></div>'
    +'<div class="splash-steps">'+stepsH+'</div>'
    +'</div>';
}

function buildProfileImport(){
  var STEPS=['Firm Setup','Your Profile'];
  var arrowSvg='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
  return '<div class="splash-ov">'
    +splashHero(STEPS,0)
    +'<div class="splash-form">'
    +'<div class="splash-form-inner">'
    +'<h2>Welcome to <strong>'+H(ST.prefs.appName||'SixMinuteLog.com')+'</strong></h2>'
    +'<p class="sub">Get started in seconds. If your firm administrator shared a profile file, import it to pre-load your clients, contacts, and settings. Otherwise, set up manually.</p>'

    +'<div class="splash-opt" onclick="document.getElementById(\'spl-prof-inp\').click()">'
    +'<div class="splash-opt-icon blue">'+IC.ul+'</div>'
    +'<div class="splash-opt-body"><strong>Import Firm Profile</strong><span>Load pre-configured clients, matters, contacts, and user profiles from a .json file provided by your administrator.</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div>'
    +'<input type="file" id="spl-prof-inp" accept=".json" style="display:none" onchange="A.importFirmProfile(this)">'

    +'<div class="splash-opt" onclick="A.skipProfileImport()">'
    +'<div class="splash-opt-icon slate"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>'
    +'<div class="splash-opt-body"><strong>Set Up Manually</strong><span>Enter your name and role now. You can add clients, matters, and team members any time from the app.</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div>'

    +'<div class="splash-features">'
    +'<div class="splash-features-title">What a firm profile includes</div>'
    +['Firm name &amp; app branding','Pre-configured clients &amp; matters','Team contacts &amp; roles','Description presets','Pre-defined user profiles'].map(function(t){
      return '<div class="splash-feature"><div class="splash-feature-dot"></div><span>'+t+'</span></div>';
    }).join('')
    +'</div>'
    +'</div>'
    +'<div class="splash-footer"><span class="splash-footer-note">\ud83d\udd12 All data stays on this device only</span></div>'
    +'</div></div>';
}

function buildITUserSelect(){
  var STEPS=['Firm Setup','Your Profile'];
  var fp=ST._importedProfile||{};
  var users=fp.users||[];
  var arrowSvg='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
  var firmName=H(fp.firmName||fp.appName||ST.prefs.appName||'Your Firm');
  var userCards=users.map(function(u,i){
    var ini=u.initials||(u.name?u.name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,3):'?');
    var roleLabel={attorney:'Attorney',partner:'Partner',billing_staff:'Billing Staff'}[u.role]||H(u.role||'');
    return '<div class="splash-user-card" onclick="A.pickITUser('+i+')">'
      +'<div class="splash-avatar">'+H(ini)+'</div>'
      +'<div class="splash-user-info"><strong>'+H(u.name)+'</strong><span>'+roleLabel+(u.rate?' \u00b7 $'+H(String(u.rate))+'/hr':'')+'</span></div>'
      +'<div class="splash-opt-arrow" style="margin-left:auto">'+arrowSvg+'</div>'
      +'</div>';
  }).join('');
  return '<div class="splash-ov">'
    +splashHero(STEPS,1)
    +'<div class="splash-form">'
    +'<div class="splash-form-inner">'
    +'<h2>Select <strong>your profile</strong></h2>'
    +'<p class="sub">'+firmName+' has pre-configured user profiles. Select yours to get started with the right permissions and billing rate.</p>'
    +userCards
    +'<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">'
    +'<div class="splash-opt" onclick="A.skipProfileImport()" style="margin-bottom:0;padding:14px 16px">'
    +'<div class="splash-opt-icon slate"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M6 20v-2a6 6 0 0 1 12 0v2"/></svg></div>'
    +'<div class="splash-opt-body"><strong>Custom profile</strong><span>My name isn\'t listed \u2014 set up manually</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div></div>'
    +'</div>'
    +'<div class="splash-footer"><span class="splash-footer-note">\ud83c\udfe2 '+firmName+' profile loaded</span></div>'
    +'</div></div>';
}


// ── Email Preset Builder helpers ────────────────────────────────────────
// Quick-template definitions: [label, purpose, subject, body, signature]
// ── Shared placeholder helpers ───────────────────────────────────────────────

// Built-in placeholders: [token, label, sampleValue, description]
var BUILTIN_PH=[
  ['{client}',      'Client name',         'Acme Corporation',       'Auto-filled from the active record'],
  ['{matter}',      'Matter name',         'Contract Review',        'Auto-filled from the active record'],
  ['{firm}',        'Firm name',           'Smith & Associates LLP', 'Set in Settings → Advanced → Firm Name'],
  ['{user}',        'Your full name',      'Sarah Johnson',          'Your profile name'],
  ['{initials}',    'Your initials',       'SJ',                     'Your profile initials'],
  ['{date}',        'Current month/year',  'January 2026',           'Resolved at send time'],
  ['{due_date}',    'Due date (+30 days)', 'February 15, 2026',      'Resolved at send time'],
  ['{invoice_num}', 'Invoice number',      'INV-0042',               'Auto-filled when sending an invoice email'],
  ['{amount}',      'Invoice total',       '$3,250.00',              'Auto-filled when sending an invoice email'],
  ['{entries_count}','Number of entries',  '8',                      'Auto-filled from visible timesheet'],
  ['{hours_total}', 'Total hours',         '12.5',                   'Auto-filled from visible timesheet'],
  ['{filename}',    'Backup filename',     'billing-backup_2026-01-24_1430.json', 'Generated at backup time'],
  ['{cc_list}',     'CC recipients list',  '',                       'Taken from the preset CC field']
];

// Linkable record fields: [fieldKey, displayLabel, groupLabel]
var LINKED_FIELDS=[
  ['client_name',              'Name',                         'Client'],
  ['client_email',             'Email',                        'Client'],
  ['client_phone',             'Phone',                        'Client'],
  ['client_rate',              'Default Rate',                 'Client'],
  // Client People = client-side contacts (the actual "representatives")
  // These are stored in client.clientPeople[]
  ['client_people_names',      'All Names (comma-separated)',  'Client People (Client-Side Contacts)'],
  ['client_people_emails',     'All Emails',                   'Client People (Client-Side Contacts)'],
  ['client_people_phones',     'All Phones',                   'Client People (Client-Side Contacts)'],
  ['client_person1_name',      'Person 1 — Name',              'Client People (Client-Side Contacts)'],
  ['client_person1_role',      'Person 1 — Role',              'Client People (Client-Side Contacts)'],
  ['client_person1_email',     'Person 1 — Email',             'Client People (Client-Side Contacts)'],
  ['client_person1_phone',     'Person 1 — Phone',             'Client People (Client-Side Contacts)'],
  ['client_person2_name',      'Person 2 — Name',              'Client People (Client-Side Contacts)'],
  ['client_person2_role',      'Person 2 — Role',              'Client People (Client-Side Contacts)'],
  ['client_person2_email',     'Person 2 — Email',             'Client People (Client-Side Contacts)'],
  ['client_person2_phone',     'Person 2 — Phone',             'Client People (Client-Side Contacts)'],
  // Firm contacts assigned to client (contactIds[]) — primary is first in list
  ['client_contact_name',      'Primary Contact Name',         'Client Firm Contacts (Primary)'],
  ['client_contact_role',      'Primary Contact Role',         'Client Firm Contacts (Primary)'],
  ['client_contact_email',     'Primary Contact Email',        'Client Firm Contacts (Primary)'],
  ['client_contact_phone',     'Primary Contact Phone',        'Client Firm Contacts (Primary)'],
  ['client_contacts_names',    'All Names (comma-separated)',  'Client Firm Contacts (All)'],
  ['client_contacts_emails',   'All Emails',                   'Client Firm Contacts (All)'],
  ['matter_name',              'Name',                         'Matter'],
  ['matter_contact_name',      'Lead Attorney Name',           'Matter Contact'],
  ['matter_contact_role',      'Lead Attorney Role',           'Matter Contact'],
  ['matter_contact_email',     'Lead Attorney Email',          'Matter Contact'],
  ['matter_contact_phone',     'Lead Attorney Phone',          'Matter Contact'],
  ['user_name',                'Full Name',                    'My Profile'],
  ['user_initials',            'Initials',                     'My Profile'],
  ['user_email',               'Email',                        'My Profile'],
  ['user_phone',               'Phone',                        'My Profile'],
];
// Descriptions shown as hints in the linked-field picker
var LINKED_FIELD_HINTS={
  'client_people_names':   'Client-side contacts (people at the client org) — all names joined',
  'client_people_emails':  'All emails from client-side contacts',
  'client_people_phones':  'All phones from client-side contacts',
  'client_person1_name':   'First client-side contact. Add contacts in the Client form.',
  'client_person1_role':   'Role/title of first client-side contact',
  'client_person1_email':  'Email of first client-side contact',
  'client_person1_phone':  'Phone of first client-side contact',
  'client_person2_name':   'Second client-side contact (if any)',
  'client_person2_role':   'Role/title of second client-side contact',
  'client_person2_email':  'Email of second client-side contact',
  'client_person2_phone':  'Phone of second client-side contact',
  'client_contact_name':   'First firm team member assigned to this client. "Primary" = first listed.',
  'client_contact_role':   'Role of the primary firm contact on this client',
  'client_contact_email':  'Email of the primary firm contact on this client',
  'client_contact_phone':  'Phone of the primary firm contact on this client',
  'client_contacts_names': 'All firm team members assigned to this client, comma-separated',
  'client_contacts_emails':'All firm team member emails, comma-separated',
};
function _lfLabel(key){
  var f=LINKED_FIELDS.find(function(x){return x[0]===key;});
  return f ? f[2]+' \u2192 '+f[1] : key;
}

// Returns merged list of [token, label] for UI display
function _allPH(){
  var list=BUILTIN_PH.map(function(p){return [p[0],p[1]];});
  (ST.mailPlaceholders||[]).forEach(function(p){
    list.push(['{'+p.key+'}', p.label]);
  });
  return list;
}

// Build the full token→value map used by replacePlaceholders
// ctx: optional object with {clientName, matterName, invNum, invAmount, entriesCount, hoursTotal}
function _phMap(ctx, mp){
  ctx=ctx||{};
  mp=mp||{};
  var now=new Date();
  var dateStr=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  var due=new Date(now); due.setDate(due.getDate()+30);
  var dueStr=due.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  var map={
    '{filename}': (function(){var n=new Date();return 'billing-backup_'+n.getFullYear()+'-'+pad2(n.getMonth()+1)+'-'+pad2(n.getDate())+'_'+pad2(n.getHours())+pad2(n.getMinutes())+'.json';})(),
    '{date}':     dateStr,
    '{due_date}': dueStr,
    '{client}':   ctx.clientName||'',
    '{matter}':   ctx.matterName||'',
    '{firm}':     ST.prefs.firmName||(ST.firmProfile&&ST.firmProfile.firmName)||'',
    '{invoice_num}': ctx.invNum||'',
    '{amount}':   ctx.invAmount||'',
    '{entries_count}': ctx.entriesCount!=null?String(ctx.entriesCount):'',
    '{hours_total}':   ctx.hoursTotal||'',
    '{user}':     (ST.user&&ST.user.name)||'',
    '{initials}': (ST.user&&ST.user.initials)||'',
    '{cc_list}':  mp.cc||''
  };
  var _cl=null,_clCt=null,_clCts=null,_clPeople=null,_ma=null,_maCt=null;
  function _getClient(){
    if(_cl===null){
      _cl=ST.clients.find(function(c){return c.id==ctx.clientId;})||{};
      // Resolve primary firm contact: prefer contactIds[0], fall back to legacy contactId
      var primaryCtId=(_cl.contactIds&&_cl.contactIds.length)?_cl.contactIds[0]:(_cl.contactId||null);
      _clCt=primaryCtId?ST.contacts.find(function(c){return c.id==primaryCtId;})||{}:{};
      // All firm contacts linked to client
      var allCtIds=(_cl.contactIds&&_cl.contactIds.length)?_cl.contactIds:(_cl.contactId?[_cl.contactId]:[]);
      _clCts=allCtIds.map(function(id){return ST.contacts.find(function(c){return c.id==id;});}).filter(Boolean);
      // Client-side people (client.clientPeople[])
      _clPeople=(_cl.clientPeople&&_cl.clientPeople.length)?_cl.clientPeople:[];
    }
    return _cl;}
  function _getMatter(){
    if(_ma===null){_ma=ST.matters.find(function(m){return m.id==ctx.matterId;})||{};
      _maCt=_ma.contactId?ST.contacts.find(function(c){return c.id==_ma.contactId;})||{}:{};}
    return _ma;}
  function _resolveLinkedField(key){
    switch(key){
      case 'client_name':          return _getClient().name||'';
      case 'client_email':         return _getClient().email||'';
      case 'client_phone':         return _getClient().phone||'';
      case 'client_rate':          return _getClient().rate?'$'+_getClient().rate+'/hr':'';
      // Primary firm contact (first in contactIds[], fallback to legacy contactId)
      case 'client_contact_name':  _getClient(); return (_clCt&&_clCt.name)||'';
      case 'client_contact_role':  _getClient(); return (_clCt&&_clCt.role)||'';
      case 'client_contact_email': _getClient(); return (_clCt&&_clCt.email)||'';
      case 'client_contact_phone': _getClient(); return (_clCt&&_clCt.phone)||'';
      // All firm contacts joined
      case 'client_contacts_names':  _getClient(); return _clCts.map(function(c){return c.name;}).join(', ');
      case 'client_contacts_emails': _getClient(); return _clCts.map(function(c){return c.email;}).filter(Boolean).join(', ');
      // Client-side people (client.clientPeople[]) — list fields
      case 'client_people_names':  _getClient(); return _clPeople.map(function(p){return p.name;}).join(', ');
      case 'client_people_emails': _getClient(); return _clPeople.map(function(p){return p.email;}).filter(Boolean).join(', ');
      case 'client_people_phones': _getClient(); return _clPeople.map(function(p){return p.phone;}).filter(Boolean).join(', ');
      // Client-side person 1 (index 0)
      case 'client_person1_name':  _getClient(); return (_clPeople[0]&&_clPeople[0].name)||'';
      case 'client_person1_role':  _getClient(); return (_clPeople[0]&&_clPeople[0].role)||'';
      case 'client_person1_email': _getClient(); return (_clPeople[0]&&_clPeople[0].email)||'';
      case 'client_person1_phone': _getClient(); return (_clPeople[0]&&_clPeople[0].phone)||'';
      // Client-side person 2 (index 1)
      case 'client_person2_name':  _getClient(); return (_clPeople[1]&&_clPeople[1].name)||'';
      case 'client_person2_role':  _getClient(); return (_clPeople[1]&&_clPeople[1].role)||'';
      case 'client_person2_email': _getClient(); return (_clPeople[1]&&_clPeople[1].email)||'';
      case 'client_person2_phone': _getClient(); return (_clPeople[1]&&_clPeople[1].phone)||'';
      case 'matter_name':          return _getMatter().name||'';
      case 'matter_contact_name':  _getMatter(); return (_maCt&&_maCt.name)||'';
      case 'matter_contact_role':  _getMatter(); return (_maCt&&_maCt.role)||'';
      case 'matter_contact_email': _getMatter(); return (_maCt&&_maCt.email)||'';
      case 'matter_contact_phone': _getMatter(); return (_maCt&&_maCt.phone)||'';
      case 'user_name':            return (ST.user&&ST.user.name)||'';
      case 'user_initials':        return (ST.user&&ST.user.initials)||'';
      case 'user_email':           return (ST.user&&ST.user.email)||'';
      case 'user_phone':           return (ST.user&&ST.user.phone)||'';
      default:                     return '';
    }
  }
  (ST.mailPlaceholders||[]).forEach(function(p){
    if(p.source==='linked'&&p.linkedField){
      map['{'+p.key+'}'] = _resolveLinkedField(p.linkedField);
    } else {
      map['{'+p.key+'}'] = p.value||'';
    }
  });
  return map;
}

// Apply a token→value map to a string
function _applyPH(s, map){
  s=s||'';
  Object.keys(map).forEach(function(k){ s=s.split(k).join(map[k]); });
  return s;
}

// ── End shared placeholder helpers ───────────────────────────────────────────

var MAIL_QUICK_TEMPLATES=[
  ['Invoice to Client','invoice_client',
   'Invoice #{invoice_num} \u2014 {client} \u2014 {date}',
   'Dear {client},\n\nPlease find your invoice #{invoice_num} totalling {amount}, covering the period through {date}.\n\nKindly arrange payment at your earliest convenience. Do not hesitate to reach out with any questions.',
   'Warm regards,\n{user}\n{firm}'],
  ['Approval Request','partner_approval',
   'Approval Required: {entries_count} Entries \u2014 {hours_total}h \u2014 {date}',
   'Hi,\n\nI am submitting {entries_count} billing entries ({hours_total}h) for your review and approval.\n\nPlease find the attached CSV for details. Let me know if any adjustments are needed.',
   'Thank you,\n{initials}\n{user}'],
  ['Billing Staff Report','billing_staff',
   'Billing Report \u2014 {hours_total}h \u2014 {date}',
   'Hi team,\n\nAttached is this period\u2019s billing report covering {entries_count} entries and {hours_total}h across {client}.\n\nPlease process at your earliest convenience.',
   'Best,\n{user}'],
  ['General / Custom','general',
   'Billing Report \u2014 {filename}',
   'Please find the attached billing backup for your records.\n\nFile: {filename}\nDate: {date}',
   '{user}']
];

// Insert a placeholder token at cursor in the focused textarea/input, else append
function _mpInsert(token){
  var el=document.getElementById('mp-body')||document.getElementById('mp-subj');
  // try to detect which field was last focused
  var focused=document.activeElement;
  if(focused&&(focused.id==='mp-body'||focused.id==='mp-subj'||focused.id==='mp-sig')){
    el=focused;
  }
  if(!el) return;
  var s=el.selectionStart||0, e2=el.selectionEnd||0;
  var v=el.value;
  el.value=v.substring(0,s)+token+v.substring(e2);
  el.selectionStart=el.selectionEnd=s+token.length;
  el.focus();
  _mpPreview();
}

// Live preview renderer — reads all fields, replaces placeholders with sample data
function _mpPreview(){
  var pv=document.getElementById('mp-preview');
  if(!pv) return;
  var subj=(document.getElementById('mp-subj')||{value:''}).value;
  var body=(document.getElementById('mp-body')||{value:''}).value;
  var sig=(document.getElementById('mp-sig')||{value:''}).value;
  var full=body+(sig?'\n\n'+sig:'');
  // Build sample map: use real user data + built-in samples + custom placeholder values
  var sampleCtx={clientName:'Acme Corporation',matterName:'Contract Review',invNum:'INV-0042',invAmount:'$3,250.00',entriesCount:'8',hoursTotal:'12.5'};
  var sampleMp={cc:(document.getElementById('mp-cc')||{value:''}).value};
  var map=_phMap(sampleCtx, sampleMp);
  // Override built-ins with richer samples where real data isn't meaningful
  map['{date}']='January 2026';
  map['{due_date}']='February 15, 2026';
  map['{filename}']='billing-backup_2026-01-24_1430.json';
  if(!map['{firm}']) map['{firm}']='Smith & Associates LLP';
  if(!map['{user}']) map['{user}']='Sarah Johnson';
  if(!map['{initials}']) map['{initials}']='SJ';
  // Custom placeholders show their configured value in preview
  var rSubj=H(_applyPH(subj||'(no subject)', map));
  var rBody=H(_applyPH(full||'(no body)', map)).replace(/\n/g,'<br>');
  var to=(document.getElementById('mp-to')||{value:''}).value||'client@example.com';
  var cc=(document.getElementById('mp-cc')||{value:''}).value;
  var bcc=(document.getElementById('mp-bcc')||{value:''}).value;
  var rt=(document.getElementById('mp-replyto')||{value:''}).value;
  pv.innerHTML='<div style="font-size:11px;color:var(--ink3);font-family:monospace;line-height:1.8">'
    +'<div><strong style="color:var(--ink2)">To:</strong> '+H(to)+'</div>'
    +(cc?'<div><strong style="color:var(--ink2)">CC:</strong> '+H(cc)+'</div>':'')
    +(bcc?'<div><strong style="color:var(--ink2)">BCC:</strong> '+H(bcc)+'</div>':'')
    +(rt?'<div><strong style="color:var(--ink2)">Reply-To:</strong> '+H(rt)+'</div>':'')
    +'<div><strong style="color:var(--ink2)">Subject:</strong> '+rSubj+'</div>'
    +'</div>'
    +'<hr style="border:none;border-top:1px solid var(--border);margin:8px 0">'
    +'<div style="font-size:12px;color:var(--ink);line-height:1.7;white-space:pre-wrap">'+rBody+'</div>';
}

// Apply a quick-template to the form fields
function _mpApplyTemplate(idx){
  var t=MAIL_QUICK_TEMPLATES[idx];
  if(!t) return;
  var purpEl=document.getElementById('mp-purpose');
  var subjEl=document.getElementById('mp-subj');
  var bodyEl=document.getElementById('mp-body');
  var sigEl=document.getElementById('mp-sig');
  if(purpEl) purpEl.value=t[1];
  if(subjEl) subjEl.value=t[2];
  if(bodyEl) bodyEl.value=t[3];
  if(sigEl) sigEl.value=t[4]||'';
  _mpPreview();
}
// ── End helpers ─────────────────────────────────────────────────────────

function buildMailPreset(){
  var f=ST.mpf||{};
  var isEdit=(f.editIdx!=null);
  var purp=f.purpose||'general';
  var ALL_PH=_allPH();
  var priorityOpts=[['normal','Normal'],['high','High \u2014 flag as urgent'],['low','Low \u2014 FYI only']];
  var pri=f.priority||'normal';
  return '<div class="ov"><div class="modal" style="max-width:820px;width:96vw"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(isEdit?'Edit':'New')+' Email Preset</h2><button class="btn-ic" onclick="A.closeMailPreset()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="display:grid;grid-template-columns:1fr 1fr;gap:0;padding:0">'

    // ── LEFT COLUMN: form ──
    +'<div style="padding:20px 18px;overflow-y:auto;max-height:72vh;border-right:1px solid var(--border)">'

    // Quick templates row
    +'<div style="margin-bottom:16px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Quick templates</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:5px">'
    +MAIL_QUICK_TEMPLATES.map(function(t,i){
      return '<button type="button" class="btn btn-gh" style="font-size:11px;padding:4px 10px" onclick="_mpApplyTemplate('+i+')">'+H(t[0])+'</button>';
    }).join('')
    +'</div></div>'

    // Name + Purpose
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>Preset Name <span class="req">*</span></label><input type="text" id="mp-name" value="'+H(f.name||'')+'" placeholder="e.g. Invoice to Acme Corp" oninput="_mpPreview()" /></div>'
    +'<div class="fl"><label>Purpose</label>'
    +'<select id="mp-purpose" onchange="_mpPreview()">'
    +'<option value="general"'+(purp==='general'?' selected':'')+'>General</option>'
    +'<option value="invoice_client"'+(purp==='invoice_client'?' selected':'')+'>Invoice to Client</option>'
    +'<option value="billing_staff"'+(purp==='billing_staff'?' selected':'')+'>Entries to Billing Staff</option>'
    +'<option value="partner_approval"'+(purp==='partner_approval'?' selected':'')+'>Entries for Partner Approval</option>'
    +'</select></div></div>'

    // Priority + Reply-To
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>Priority</label>'
    +'<select id="mp-priority" onchange="_mpPreview()">'
    +priorityOpts.map(function(o){return '<option value="'+o[0]+'"'+(pri===o[0]?' selected':'')+'>'+H(o[1])+'</option>';}).join('')
    +'</select></div>'
    +'<div class="fl"><label>Reply-To <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="email" id="mp-replyto" value="'+H(f.replyTo||'')+'" placeholder="billing@firm.com" oninput="_mpPreview()" /></div></div>'

    // To
    +'<div class="fl" style="margin-bottom:12px"><label>To <span style="font-size:11px;color:var(--ink3)">&mdash; leave blank to auto-fill from record</span></label>'
    +'<input type="text" id="mp-to" value="'+H(f.to||'')+'" placeholder="client@example.com, partner@firm.com" oninput="_mpPreview()" />'
    +'<div class="hint">Separate multiple addresses with commas.</div></div>'

    // CC + BCC
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>CC <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="text" id="mp-cc" value="'+H(f.cc||'')+'" placeholder="manager@firm.com" oninput="_mpPreview()" /></div>'
    +'<div class="fl"><label>BCC <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="text" id="mp-bcc" value="'+H(f.bcc||'')+'" placeholder="archive@firm.com" oninput="_mpPreview()" /></div></div>'

    // Subject
    +'<div class="fl" style="margin-bottom:12px"><label>Subject Line</label><input type="text" id="mp-subj" value="'+H(f.subject||'')+'" placeholder="Invoice #{invoice_num} \u2014 {client}" oninput="_mpPreview()" /></div>'

    // Body
    +'<div class="fl" style="margin-bottom:12px"><label>Message Body</label><textarea id="mp-body" rows="6" oninput="_mpPreview()" placeholder="Dear {client},\n\nPlease find attached...">'+H(f.body||'')+'</textarea></div>'

    // Signature
    +'<div class="fl" style="margin-bottom:16px">'
    +'<label>Signature <span style="font-size:11px;color:var(--ink3)">&mdash; auto-appended after double line-break</span></label>'
    +'<textarea id="mp-sig" rows="3" oninput="_mpPreview()" placeholder="Best regards,\n{user}\n{firm}">'+H(f.signature||'')+'</textarea></div>'

    // Placeholder insert bar
    +'<div style="background:var(--bg);border-radius:8px;padding:10px 12px;margin-bottom:4px">'
    +'<div style="font-size:10px;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px">Click to insert placeholder at cursor</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:4px">'
    +ALL_PH.map(function(ph){
      return '<button type="button" title="'+H(ph[1])+'" onclick="_mpInsert(\''+ph[0]+'\')" style="font-size:11px;font-family:monospace;padding:3px 8px;background:var(--white);border:1px solid var(--border);border-radius:5px;cursor:pointer;color:var(--blue)">'+H(ph[0])+'</button>';
    }).join('')
    +'</div></div>'
    +'</div>'

    // ── RIGHT COLUMN: live preview ──
    +'<div style="padding:20px 18px;overflow-y:auto;max-height:72vh;background:var(--bg2)">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Live preview <span style="opacity:.6">(sample data)</span></div>'
    +'<div id="mp-preview" style="background:var(--white);border:1px solid var(--border);border-radius:8px;padding:14px 16px;min-height:200px;word-break:break-word"></div>'
    +'<div style="margin-top:14px;font-size:11px;color:var(--ink3);line-height:1.7">'
    +'<strong style="display:block;margin-bottom:6px;color:var(--ink2)">Placeholder guide</strong>'
    +ALL_PH.map(function(ph){return '<div><code style="font-size:10px;color:var(--blue)">'+H(ph[0])+'</code> &mdash; '+H(ph[1])+'</div>';}).join('')
    +'</div>'
    +'</div>'

    +'</div>'// end grid

    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeMailPreset()">Cancel</button>'
    +'<button class="btn btn-bl" onclick="A.saveMailPreset()">'+IC.save+' Save Preset</button>'
    +'</div></div></div>';
}

function buildMailPH(){
  var f=ST.mphf||{};
  var isEdit=(f.editIdx!=null);
  var src=f.source||'static';
  var keyErr=f.errs&&f.errs.key;
  var labelErr=f.errs&&f.errs.label;
  var lfGroups={};
  LINKED_FIELDS.forEach(function(x){if(!lfGroups[x[2]])lfGroups[x[2]]=[];lfGroups[x[2]].push(x);});
  var lfOpts='<option value="">— choose a field —</option>';
  Object.keys(lfGroups).forEach(function(grp){
    lfOpts+='<optgroup label="'+H(grp)+'">';
    lfGroups[grp].forEach(function(x){lfOpts+='<option value="'+H(x[0])+'"'+(f.linkedField===x[0]?' selected':'')+'>'+H(x[1])+'</option>';});
    lfOpts+='</optgroup>';
  });
  // Hint text for the currently selected linked field
  var lfHint=(f.linkedField&&LINKED_FIELD_HINTS[f.linkedField])
    ? '<div style="font-size:11px;color:var(--blue);background:rgba(59,130,246,.07);border-radius:5px;padding:4px 8px;margin-top:4px">ℹ '+H(LINKED_FIELD_HINTS[f.linkedField])+'</div>'
    : '';
  var sourceToggle='<div class="fl" style="margin-bottom:14px"><label>Value source</label>'
    +'<div style="display:flex;gap:6px">'
    +'<button type="button" class="btn '+(src==='static'?'btn-bl':'btn-gh')+'" style="flex:1;font-size:12px" onclick="A.mphSetSource(\'static\')">Static text</button>'
    +'<button type="button" class="btn '+(src==='linked'?'btn-bl':'btn-gh')+'" style="flex:1;font-size:12px" onclick="A.mphSetSource(\'linked\')">Linked field</button>'
    +'</div><div style="font-size:11px;color:var(--ink3);margin-top:4px">'
    +(src==='linked'?'Value is pulled from the active client/matter record each time the placeholder is resolved.':'Value is a fixed text string you set here.')
    +'</div></div>';
  var valueSection=src==='linked'
    ? '<div class="fl" style="margin-bottom:4px"><label>Linked field <span class="req">*</span></label>'
      +'<select id="mph-lf" style="width:100%" onchange="A.mphPreviewLF(this.value)">'+lfOpts+'</select>'
      +(f.errs&&f.errs.linkedField?'<div class="note" style="margin-top:4px">'+H(f.errs.linkedField)+'</div>':'')
      +lfHint
      +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Resolves from whichever client/matter is active when the email is sent.</div></div>'
    : '<div class="fl" style="margin-bottom:4px"><label>Static value <span style="font-size:11px;color:var(--ink3)">\u2014 inserted verbatim when sending</span></label>'
      +'<textarea id="mph-value" rows="3" placeholder="e.g. John Smith, Managing Partner">'+H(f.value||'')+'</textarea>'
      +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Leave blank to keep the token as-is when empty.</div></div>';
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(isEdit?'Edit':'New')+' Placeholder</h2>'
    +'<button class="btn-ic" onclick="A.closeMailPH()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div class="fl" style="margin-bottom:14px"><label>Token key <span class="req">*</span> <span style="font-size:11px;color:var(--ink3)">\u2014 used as <code>{key}</code> in subject &amp; body</span></label>'
    +'<div style="display:flex;align-items:center;gap:4px">'
    +'<span style="font-family:monospace;font-size:14px;color:var(--ink3)">{</span>'
    +'<input type="text" id="mph-key" value="'+H(f.key||'')+'" placeholder="my_token" style="font-family:monospace" oninput="this.value=this.value.replace(/[^a-z0-9_]/g,\'\')" />'
    +'<span style="font-family:monospace;font-size:14px;color:var(--ink3)">}</span></div>'
    +(keyErr?'<div class="note" style="margin-top:4px">'+H(keyErr)+'</div>':'')
    +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Lowercase letters, numbers, underscores only.</div></div>'
    +'<div class="fl" style="margin-bottom:14px"><label>Label <span class="req">*</span></label>'
    +'<input type="text" id="mph-label" value="'+H(f.label||'')+'" placeholder="e.g. Client representative" />'
    +(labelErr?'<div class="note" style="margin-top:4px">'+H(labelErr)+'</div>':'')
    +'</div>'
    +sourceToggle+valueSection
    +'</div><div class="modal-ft" style="gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeMailPH()">Cancel</button>'
    +'<button class="btn btn-bl" onclick="A.saveMailPH()">'+IC.save+' Save</button>'
    +'</div></div></div>';
}

function buildMailSend(){
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' Send Email</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +(ST.mailPresets.length>0
      ? '<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Choose a preset</div>'
        +ST.mailPresets.map(function(mp,i){
          return '<div class="crow" style="cursor:pointer;margin-bottom:8px" onclick="A.sendMailPreset('+i+')">'
            +'<div style="width:32px;height:32px;border-radius:8px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0">'+IC.mail+'</div>'
            +'<div><strong style="font-size:13px;color:var(--ink)">'+H(mp.name||'Preset '+(i+1))+'</strong>'
            +(mp.to?'<div style="font-size:11px;color:var(--ink3)">To: '+H(mp.to)+'</div>':'')
            +'</div></div>';
        }).join('')
      : '<div class="empty" style="padding:20px"><p>No email presets configured</p><small>Add presets in Settings \u2192 Email tab</small></div>'
    )
    +'</div>'
    +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +(ST.mailPresets.length===0?'<button class="btn btn-bl" onclick="A.openMailPreset(null)">'+IC.plus+' Add Preset</button>':'')
    +'</div></div></div>';
}

// Purpose label helper
function purposeLabel(p){
  return {general:'General',invoice_client:'Invoice to Client',billing_staff:'Entries to Billing Staff',partner_approval:'Entries for Partner Approval'}[p]||'General';
}

// ── Screen 2: Preview + editable draft ────────────────────────────────────
function _buildMailPreview(ctx){
  var purpose=ctx.purpose||'general';
  var titles={invoice_client:'Email Invoice to Client',billing_staff:'Send Entries to Billing Staff',partner_approval:'Submit for Partner Approval',general:'Send Billing Report'};
  var d=ctx._draft||{};
  // Tab state: 'edit' | 'preview'
  var tab=ctx._pvTab||'edit';

  var bodyPreview=H(d.body||'').replace(/\n/g,'<br>');

  var editPanel='<div style="display:flex;flex-direction:column;gap:10px">'
    // To
    +'<div class="fl" style="margin:0">'
    +'<label style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">To <span class="req">*</span></label>'
    +'<input id="mc-to" type="email" value="'+H(d.to||'')+'" placeholder="recipient@example.com" oninput="A.mcLive()" />'
    +'</div>'
    // Subject
    +'<div class="fl" style="margin:0">'
    +'<label style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">Subject</label>'
    +'<input id="mc-subj" type="text" value="'+H(d.subj||'')+'" placeholder="(no subject)" oninput="A.mcLive()" />'
    +'</div>'
    // CC / BCC / Reply-To in a compact row
    +'<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">'
    +'<div class="fl" style="margin:0"><label style="font-size:11px;color:var(--ink3)">CC</label>'
    +'<input id="mc-cc" type="text" value="'+H(d.cc||'')+'" placeholder="cc@example.com" oninput="A.mcLive()" /></div>'
    +'<div class="fl" style="margin:0"><label style="font-size:11px;color:var(--ink3)">BCC</label>'
    +'<input id="mc-bcc" type="text" value="'+H(d.bcc||'')+'" placeholder="bcc@example.com" oninput="A.mcLive()" /></div>'
    +'<div class="fl" style="margin:0"><label style="font-size:11px;color:var(--ink3)">Reply-To</label>'
    +'<input id="mc-rt" type="email" value="'+H(d.replyTo||'')+'" placeholder="you@firm.com" oninput="A.mcLive()" /></div>'
    +'</div>'
    // Body
    +'<div class="fl" style="margin:0">'
    +'<label style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">Body</label>'
    +'<textarea id="mc-body" rows="12" style="font-family:inherit;font-size:13px;line-height:1.6;resize:vertical" oninput="A.mcLive()">'+H(d.body||'')+'</textarea>'
    +'</div>'
    +'</div>';

  var previewPanel='<div style="border:1px solid var(--brd);border-radius:8px;overflow:hidden">'
    // Header row mimicking an email header
    +'<div style="background:var(--bg);border-bottom:1px solid var(--brd);padding:12px 16px;display:flex;flex-direction:column;gap:4px;font-size:12px;font-family:monospace;color:var(--ink2)">'
    +'<div><strong style="color:var(--ink3);display:inline-block;width:52px">To:</strong> '+H(d.to||'—')+'</div>'
    +(d.cc?'<div><strong style="color:var(--ink3);display:inline-block;width:52px">CC:</strong> '+H(d.cc)+'</div>':'')
    +(d.bcc?'<div><strong style="color:var(--ink3);display:inline-block;width:52px">BCC:</strong> '+H(d.bcc)+'</div>':'')
    +(d.replyTo?'<div><strong style="color:var(--ink3);display:inline-block;width:52px">Reply-To:</strong> '+H(d.replyTo)+'</div>':'')
    +'<div><strong style="color:var(--ink3);display:inline-block;width:52px">Subject:</strong> <strong style="color:var(--ink)">'+H(d.subj||'(no subject)')+'</strong></div>'
    +'</div>'
    // Body
    +'<div style="padding:18px 20px;font-size:13px;line-height:1.75;color:var(--ink);white-space:pre-wrap;word-break:break-word;min-height:180px;max-height:340px;overflow-y:auto">'+bodyPreview+'</div>'
    +'</div>';

  // Tab bar
  var tabBar='<div style="display:flex;gap:0;border:1px solid var(--brd);border-radius:7px;overflow:hidden;margin-bottom:14px;width:fit-content">'
    +'<button type="button" class="btn '+(tab==='edit'?'btn-dk':'btn-gh')+'" style="border-radius:0;border:none;padding:7px 18px;font-size:12px" onclick="A.mcTab(\'edit\')">✏️ Edit</button>'
    +'<button type="button" class="btn '+(tab==='preview'?'btn-dk':'btn-gh')+'" style="border-radius:0;border:none;padding:7px 18px;font-size:12px;border-left:1px solid var(--brd)" onclick="A.mcTab(\'preview\')">👁 Preview</button>'
    +'</div>';

  // Context chips
  var ctxInfo='';
  if(ctx.clientName) ctxInfo+='<span><strong>Client:</strong> '+H(ctx.clientName)+'</span> ';
  if(ctx.invNum)     ctxInfo+='<span><strong>Invoice #:</strong> '+H(ctx.invNum)+'</span> ';
  if(ctx.invAmount)  ctxInfo+='<span><strong>Amount:</strong> '+H(ctx.invAmount)+'</span> ';
  if(ctx.entriesCount!=null) ctxInfo+='<span><strong>Entries:</strong> '+H(String(ctx.entriesCount))+'</span> ';
  if(ctx.hoursTotal) ctxInfo+='<span><strong>Hours:</strong> '+H(ctx.hoursTotal)+'h</span>';
  var ctxBar=ctxInfo?'<div style="display:flex;gap:14px;flex-wrap:wrap;background:var(--bg);border-radius:7px;padding:8px 12px;font-size:12px;color:var(--ink2);margin-bottom:12px">'+ctxInfo+'</div>':'';

  return '<div class="ov"><div class="modal modal-lg" style="max-height:92vh;display:flex;flex-direction:column"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(titles[purpose]||'Send Email')+' <span style="font-size:12px;font-weight:400;color:var(--ink3);background:var(--bg);padding:2px 9px;border-radius:12px;border:1px solid var(--brd)">Review &amp; Edit</span></h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'
    +ctxBar
    +tabBar
    +(tab==='edit' ? editPanel : previewPanel)
    +'</div>'
    +'<div class="modal-ft" style="gap:8px;flex-shrink:0">'
    +'<button class="btn btn-gh" onclick="A.backToPicker()">← Presets</button>'
    +'<button class="btn btn-gh" onclick="A.mcReset()">↺ Reset</button>'
    +'<button class="btn btn-bl" onclick="A.sendFromDraft()">'+IC.mail+' Open Mail App</button>'
    +'</div></div></div>';
}

// ── Screen 1: Preset picker ────────────────────────────────────────────────
function _buildMailPicker(ctx){
  var purpose=ctx.purpose||'general';
  var titles={invoice_client:'Email Invoice to Client',billing_staff:'Send Entries to Billing Staff',partner_approval:'Submit for Partner Approval',general:'Send Billing Report'};
  var filtered=ST.mailPresets.filter(function(mp){
    return (mp.purpose||'general')===purpose||(mp.purpose||'general')==='general';
  });
  var ctxInfo='';
  if(ctx.clientName) ctxInfo+='<span><strong>Client:</strong> '+H(ctx.clientName)+'</span> ';
  if(ctx.invNum)     ctxInfo+='<span><strong>Invoice #:</strong> '+H(ctx.invNum)+'</span> ';
  if(ctx.invAmount)  ctxInfo+='<span><strong>Amount:</strong> '+H(ctx.invAmount)+'</span> ';
  if(ctx.entriesCount!=null) ctxInfo+='<span><strong>Entries:</strong> '+H(String(ctx.entriesCount))+'</span> ';
  if(ctx.hoursTotal) ctxInfo+='<span><strong>Hours:</strong> '+H(ctx.hoursTotal)+'h</span>';
  return '<div class="ov"><div class="modal modal-md"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(titles[purpose]||'Send Email')+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +(ctxInfo?'<div style="display:flex;gap:16px;flex-wrap:wrap;background:var(--bg);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);margin-bottom:14px">'+ctxInfo+'</div>':'')
    +(ctx.toEmail?'<div style="background:var(--bg);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);margin-bottom:14px">'
      +'<strong>Recipient:</strong> <span style="color:var(--blue);font-family:monospace">'+H(ctx.toEmail)+'</span>'
      +'<span style="font-size:11px;color:var(--ink3);margin-left:8px">(auto-filled from record; preset &ldquo;To&rdquo; overrides if set)</span>'
      +'</div>':'')
    +(filtered.length>0
      ? '<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Choose a preset to review &amp; send</div>'
        +filtered.map(function(mp){
          var realIdx=ST.mailPresets.indexOf(mp);
          var toDisplay=(mp.to&&mp.to.length)?mp.to:(ctx.toEmail||'');
          return '<div class="crow" style="cursor:pointer;margin-bottom:8px;align-items:flex-start" onclick="A.previewFromCompose('+realIdx+')">'
            +'<div style="width:36px;height:36px;border-radius:8px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0;margin-top:2px">'+IC.mail+'</div>'
            +'<div style="flex:1;min-width:0">'
            +'<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap"><strong style="font-size:13px;color:var(--ink)">'+H(mp.name||'Preset '+(realIdx+1))+'</strong>'
            +'<span class="status-badge '+(({general:'s-neutral',invoice_client:'s-approved',billing_staff:'s-review',partner_approval:'s-pending'}[mp.purpose||'general']||'s-neutral'))+'" style="font-size:10px;padding:2px 7px">'+purposeLabel(mp.purpose||'general')+'</span>'
            +((mp.priority==='high')?'<span style="font-size:10px;color:var(--red);font-weight:600">\u25b2 High</span>':'')
            +'</div>'
            +(toDisplay?'<div style="font-size:11px;color:var(--ink3)">To: '+H(toDisplay)+'</div>':'')
            +(mp.cc?'<div style="font-size:11px;color:var(--ink3)">CC: '+H(mp.cc)+'</div>':'')
            +(mp.subject?'<div style="font-size:11px;color:var(--ink3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:380px">Subj: '+H(mp.subject)+'</div>':'')
            +(mp.signature?'<div style="font-size:10px;color:var(--ink3);font-style:italic">\u2014 Signature included</div>':'')
            +'</div></div>';
        }).join('')
      : '<div class="empty" style="padding:24px"><p>No presets for &ldquo;'+purposeLabel(purpose)+'&rdquo;</p>'
        +'<small>Add a preset in Settings &rarr; Email with purpose set to <strong>'+purposeLabel(purpose)+'</strong></small></div>'
    )
    +'</div>'
    +'<div class="modal-ft" style="gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-gh" onclick="ST.modal=\'settings\';ST.settingsTab=\'email\';render()">'+IC.plus+' Manage Presets</button>'
    +'</div></div></div>';
}

// Contextual mail compose modal — router between the two screens
function buildMailCompose(){
  var ctx=ST.mailCompose||{};
  if(ctx._preview)  return _buildMailPreview(ctx);
  return _buildMailPicker(ctx);
}

// ── Partner Assignment Helper ──────────────────────────────────────────────────
// Returns first partner-role contact assigned to a client, or null.
function _getClientPartner(clientId){
  if(!clientId) return null;
  var cl=ST.clients.find(function(c){return c.id==clientId;});
  if(!cl||!cl.contactIds||!cl.contactIds.length) return null;
  for(var i=0;i<cl.contactIds.length;i++){
    var ctid=cl.contactIds[i];
    var ct=ST.contacts.find(function(c){return c.id==ctid;});
    if(ct&&ct.role&&(ct.role.toLowerCase().indexOf('partner')!==-1||ct.role.toLowerCase().indexOf('supervising')!==-1)) return ct;
  }
  return null;
}

// Returns map of {partnerId|'__none__': {partner, entries[]}} for entries grouped by assigned partner.
function _groupEntriesByPartner(entries){
  var groups={};
  var groupOrder=[];
  entries.forEach(function(e){
    var pt=_getClientPartner(e.clientId);
    var key=pt?String(pt.id):'__none__';
    if(!groups[key]){groups[key]={partner:pt,entries:[]};groupOrder.push(key);}
    groups[key].entries.push(e);
  });
  return {groups:groups,order:groupOrder};
}

// ── Workflow Export Modal ────────────────────────────────────────────────────
// ── Submit Timesheet Modal ─────────────────────────────────────────────────────
// Unified send + email form. Replaces the old workflow export modal.
function buildSubmitTimesheetModal(){
  var role=myRole();
  var me=ST.user?ST.user.name:'';
  var fe=filterEnt(ST.entries,ST.tsFilter);
  if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
  if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});

  // Scope entries by role
  var entries, pkgType, recipient, recipientRole, recipientRoleKey;
  if(role==='attorney'){
    entries=fe.filter(function(e){return e.createdBy===me;});
    pkgType='attorney_submission';
    recipient='Billing Staff'; recipientRole='for billing processing'; recipientRoleKey='billing_staff';
  } else if(role==='billing_staff'){
    entries=fe;
    pkgType='billing_review';
    recipient='Partner'; recipientRole='for approval'; recipientRoleKey='partner_approval';
  } else if(role==='partner'){
    entries=fe.filter(function(e){return (e.status||'pending')==='approved';});
    pkgType='partner_approval';
    recipient='Billing Staff'; recipientRole='for invoicing'; recipientRoleKey='billing_staff';
  } else {
    entries=fe; pkgType='attorney_submission'; recipient='Billing'; recipientRole=''; recipientRoleKey='billing_staff';
  }

  var hrs=entries.reduce(function(s,e){return s+Number(e.hours||0);},0);
  var bill=entries.reduce(function(s,e){return s+Number(e.hours||0)*Number(e.rate||0);},0);
  var dateFrom=entries.length?entries.reduce(function(mn,e){return e.date<mn?e.date:mn;},entries[0].date):'';
  var dateTo=entries.length?entries.reduce(function(mx,e){return e.date>mx?e.date:mx;},entries[0].date):'';
  var firmName=ST.prefs&&ST.prefs.firmName?ST.prefs.firmName:'';

  var emptyNotice=entries.length===0
    ?'<div class="role-notice" style="margin-bottom:16px">⚠ No entries available to submit in the current view. Adjust your time filter or filters above.</div>':'';

  // Auto-find recipient email from contacts
  var rcpEmail='';
  if(recipientRoleKey==='billing_staff'){
    var bsCt=ST.contacts.find(function(c){return c.email&&c.role&&c.role.toLowerCase().indexOf('billing')!==-1;});
    if(bsCt) rcpEmail=bsCt.email;
  } else {
    var pCt=ST.contacts.find(function(c){return c.email&&c.role&&(c.role.toLowerCase().indexOf('partner')!==-1||c.role.toLowerCase().indexOf('supervising')!==-1);});
    if(pCt) rcpEmail=pCt.email;
  }

  var cardStyle='border:1px solid var(--border);border-radius:10px;padding:16px 18px;flex:1;min-width:200px;display:flex;flex-direction:column;gap:10px';
  var cardHoverStyle='background:var(--bg2)';

  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">📤 Submit to '+H(recipient)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +emptyNotice

    // Summary card
    +(entries.length?'<div style="background:var(--bg2);border-radius:10px;padding:14px 16px;margin-bottom:18px">'
      +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:8px">Package Summary</div>'
      +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center">'
      +'<div><div style="font-size:1.4rem;font-weight:300">'+entries.length+'</div><div style="font-size:11px;color:var(--ink3)">Entries</div></div>'
      +'<div><div style="font-size:1.4rem;font-weight:300">'+$h(hrs)+'</div><div style="font-size:11px;color:var(--ink3)">Hours</div></div>'
      +'<div><div style="font-size:1.4rem;font-weight:300">'+$m(bill)+'</div><div style="font-size:11px;color:var(--ink3)">Billable</div></div>'
      +'</div>'
      +(dateFrom?'<div style="font-size:11px;color:var(--ink3);margin-top:8px;text-align:center">'+$d(dateFrom)+' — '+$d(dateTo)+'</div>':'')
      +'</div>':'')



    // Two action cards side by side
    +'<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:4px">'

    // Save file card — billing_staff gets per-partner breakdown, others get single card
    +(entries.length?(role==='billing_staff'?(function(){
      // Build per-partner export cards for billing staff
      var pg=_groupEntriesByPartner(entries);
      var cards='';
      pg.order.forEach(function(key){
        var grp=pg.groups[key];
        var pt=grp.partner;
        var ptName=pt?H(pt.name):'<em>No Partner Assigned</em>';
        var ptIni=pt?H(pt.initials||(pt.name.split(' ').map(function(w){return w[0];}).join('').toUpperCase())):'?';
        var ptId=pt?pt.id:'__none__';
        var gHrs=grp.entries.reduce(function(s,e){return s+Number(e.hours||0);},0);
        var gBill=grp.entries.reduce(function(s,e){return s+Number(e.hours||0)*Number(e.rate||0);},0);
        // Determine filename preview
        var entryMonth='';
        if(grp.entries.length){var ms={};grp.entries.forEach(function(e){var m=(e.date||'').substring(0,7);if(m)ms[m]=(ms[m]||0)+1;});var bm='',bn=0;Object.keys(ms).forEach(function(m){if(ms[m]>bn){bn=ms[m];bm=m;}});entryMonth=bm;}
        var ptLast=pt?(pt.name.trim().split(/\s+/).pop().replace(/[^A-Za-z0-9]/g,'')):'Partner';
        var fnPrev='TS_'+(entryMonth||'YYYY-MM')+'_'+ptLast+'.json';
        cards+='<div style="border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px">'
          +'<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">'
          +'<div class="avatar" style="width:32px;height:32px;font-size:13px;flex-shrink:0">'+ptIni+'</div>'
          +'<div><div style="font-weight:600;font-size:13px">'+ptName+'</div>'
          +'<div style="font-size:11px;color:var(--ink3)">'+(pt&&pt.role?H(pt.role):'No partner assigned')+'</div></div>'
          +'<div style="margin-left:auto;text-align:right">'
          +'<div style="font-size:13px;font-weight:500">'+grp.entries.length+' entr'+(grp.entries.length===1?'y':'ies')+'</div>'
          +'<div style="font-size:11px;color:var(--ink3)">'+$h(gHrs)+' &middot; '+$m(gBill)+'</div>'
          +'</div></div>'
          +'<div style="font-size:11px;color:var(--ink3);margin-bottom:8px;font-family:monospace">'+H(fnPrev)+'</div>'
          +(pt?'<button class="btn btn-dk" style="width:100%;justify-content:center" onclick="A.doSubmitSaveFileByPartner('+ptId+')">💾 Save Package for '+ptName+'</button>'
               :'<button class="btn btn-gh" style="width:100%;justify-content:center" onclick="A.doSubmitSaveFileByPartner(\'__none__\')">💾 Save (Unassigned)</button>')
          +'</div>';
      });
      if(!cards) cards='<div class="empty" style="padding:14px"><p>No entries to package</p></div>';
      return '<div style="flex:1;min-width:200px;display:flex;flex-direction:column;gap:4px">'
        +'<div style="font-weight:600;font-size:13px;margin-bottom:6px">💾 Save Packages by Partner</div>'
        +'<div style="font-size:12px;color:var(--ink2);line-height:1.5;margin-bottom:10px">Each package contains only the entries for clients assigned to that partner — export one per partner for their individual approval.</div>'
        +cards+'</div>';
    })()
    :'<div style="'+cardStyle+'">'
      +'<div style="font-weight:600;font-size:13px">💾 Save Package File</div>'
      +'<div style="font-size:12px;color:var(--ink2);line-height:1.6">Downloads a <code>.json</code> transfer package the recipient imports into their own copy of the app.</div>'
      +'<button class="btn btn-dk" onclick="A.doSubmitSaveFile(\''+pkgType+'\')" style="margin-top:auto">Save Package File</button>'
      +'</div>'):'')

    // Email card
    +'<div style="'+cardStyle+'">'
    +'<div style="font-weight:600;font-size:13px">'+IC.mail+' Send Email</div>'
    +'<div style="font-size:12px;color:var(--ink2);line-height:1.6">Compose an email to notify '+H(recipient)+' '+H(recipientRole)+'. You can attach the saved file manually.</div>'
    +'<button class="btn btn-gr" onclick="A.doSubmitEmail(\''+recipientRoleKey+'\')" style="margin-top:6px">Open Email</button>'
    +'</div>'

    +'</div>'
    +'<p style="font-size:11px;color:var(--ink3);margin-top:10px">You can save the file AND send the email — they work independently.</p>'

    +'</div>'
    +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Close</button></div>'
    +'</div></div>';
}

// ── Receive Package Modal ──────────────────────────────────────────────────────
// Shown when clicking "Receive Package" / "Receive Submission".
// Separate from personal import — only accepts workflow transfer packages.
function buildReceivePackageModal(){
  var role=myRole();
  var title=role==='partner'?'Receive Billing Package':'Receive Timesheet Submission';
  var desc=role==='partner'
    ?'Import a billing review package sent by your billing staff. Entries will be merged into your Approvals queue — your existing data is never deleted.'
    :'Import a timesheet submission package sent by an attorney. Their entries will be merged into your timesheet — your existing data is never deleted.';
  return '<div class="ov"><div class="modal modal-sm" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">📥 '+H(title)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<p style="font-size:13px;color:var(--ink2);line-height:1.6;margin-bottom:20px">'+H(desc)+'</p>'
    +'<div style="border:2px dashed var(--border);border-radius:10px;padding:28px 20px;text-align:center;margin-bottom:16px">'
    +'<div style="font-size:2.5rem;margin-bottom:10px">📦</div>'
    +'<div style="font-weight:600;margin-bottom:6px">Select a package file (.json)</div>'
    +'<div style="font-size:12px;color:var(--ink3);margin-bottom:16px">Sent to you by '+(role==='partner'?'billing staff':'an attorney')+'</div>'
    +'<input type="file" id="rcv-pkg-file" accept=".json" style="display:none" onchange="A.importWorkflowPackage(this)">'
    +'<button class="btn btn-dk" onclick="document.getElementById(\'rcv-pkg-file\').click()">Choose Package File</button>'
    +'</div>'
    +'<div style="font-size:11px;color:var(--ink3);line-height:1.7">'
    +'<strong>Smart merge:</strong> Existing entries, clients and matters are never deleted. New entries are added; matching entries are updated with any changes from the sender.'
    +'</div>'
    +'</div>'
    +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button></div>'
    +'</div></div>';
}

// ── Billing Staff: Edit ABA Code + Matter Number on Entry ────────────────────
function buildBillingEditModal(){
  var e=ST.entries.find(function(x){return x.id==ST.editId;})||{};
  var cl=_lu.cl[e.clientId]||{};
  var mt=_lu.ma[e.matterId]||{};
  var abaOpts=ABA_TASK_CODES;
  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>🧾 Billing: Enrich Entry</h2>'
    +'<button class="btn-ic" onclick="A.closeF()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div style="background:var(--bg2);border-radius:8px;padding:12px 14px;margin-bottom:16px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:4px">Time Entry</div>'
    +'<div style="font-weight:500">'+$d(e.date)+' — '+H(cl.name||'?')+(mt.name?' / '+H(mt.name):'')+'</div>'
    +'<div style="font-size:12px;color:var(--ink2)">'+H(e.description||'—')+'</div>'
    +'<div style="font-size:12px;color:var(--ink3)">'+$h(e.hours)+' @ '+$m(e.rate)+' = <strong style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</strong>'+(e.createdBy?' · by '+H(e.createdBy):'')+'</div>'
    +'</div>'
    +'<div class="frow"><label style="display:block;font-size:12px;font-weight:600;margin-bottom:5px">ABA / UTBMS Task Code</label>'
    +'<select id="be-aba" style="width:100%;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)">'
    +abaOpts.map(function(o){return '<option value="'+H(o.v)+'"'+(e.abaCode===o.v?' selected':'')+'>'+H(o.l)+'</option>';}).join('')
    +'</select></div>'
    +(!mt.matterNumber?'<div class="frow" style="margin-top:10px">'+field('Matter Number','be-mn',{ph:'e.g. 2024-001',val:'',hint:'Assign firm matter number to "'+H(mt.name||'this matter')+'"'})+'</div>':'')
    +'<div class="frow" style="margin-top:10px">'+field('Description','be-desc',{type:'textarea',rows:2,val:e.description||''})+'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeF()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveBillingEdit()">'+IC.save+' Save</button>'
    +'</div></div></div>';
}


// === MAIN RENDER
var TABS=[
  {id:'timesheet', lbl:'Timesheet', ic:IC.clock},
  {id:'clients',   lbl:'Clients',   ic:IC.users},
  {id:'matters',   lbl:'Matters',   ic:IC.brief},
  {id:'contacts',  lbl:'Contacts',  ic:IC.doc},
  {id:'analytics', lbl:'Analytics', ic:IC.chart},
  {id:'invoices',  lbl:'Invoices',  ic:IC.invoice, roleExclude:['partner','attorney']},
  {id:'approvals', lbl:'Approvals', ic:IC.shield, roleOnly:'partner'}
];

// === LOOKUP MAPS
// Built once per data-change (guarded by _luDirty flag).
// All views use _lu.cl/ma/ct for O(1) lookups instead of repeated .find().
// _lu.en (entries map) is intentionally NOT rebuilt here — with tens of thousands
// of entries it's expensive and only invoice-review actually needs it.
// Invoice functions call buildEntryLookup() directly when needed.
var _lu={cl:{},ma:{},ct:{},en:{}};
var _luDirty=true;
function markLuDirty(){_luDirty=true;}
function buildLookups(){
  if(!_luDirty) return;
  var cl={},ma={},ct={};
  ST.clients.forEach(function(r){cl[r.id]=r;});
  ST.matters.forEach(function(r){ma[r.id]=r;});
  ST.contacts.forEach(function(r){ct[r.id]=r;});
  _lu.cl=cl; _lu.ma=ma; _lu.ct=ct;
  _luDirty=false;
}
// Lazily rebuild the entries lookup — call only when invoice review needs it.
function buildEntryLookup(){
  var en={};
  ST.entries.forEach(function(r){en[r.id]=r;});
  _lu.en=en;
}

// === MORPH
// Incremental DOM patching (no CDN, no external deps).
// Walks old/new DOM trees and updates only what changed.
// Preserves focused elements and cursor position naturally,
// eliminating the old _dFocusSel hack entirely.
// Keyed reconciliation: elements with id= are matched by id across the list,
// preventing O(n) mismatch when rows are added/removed.
var _morphBuf=document.createElement('div');

function _mAttrs(o,n){
  // Remove attrs absent from new node
  for(var i=o.attributes.length-1;i>=0;i--){
    var nm=o.attributes[i].name;
    if(!n.hasAttribute(nm)) o.removeAttribute(nm);
  }
  // Add/update attrs from new node
  for(var j=0;j<n.attributes.length;j++){
    var a=n.attributes[j];
    if(o.getAttribute(a.name)!==a.value) o.setAttribute(a.name,a.value);
  }
}

function _mEl(o,n){
  var focused=(document.activeElement===o);
  _mAttrs(o,n);
  // Sync form-control values — skip focused element to avoid cursor jump
  if(!focused){
    if(o.tagName==='INPUT'&&o.type!=='checkbox'&&o.type!=='radio'){
      var nv=n.hasAttribute('value')?n.getAttribute('value'):'';
      if(o.value!==nv) o.value=nv;
    }
    if(o.tagName==='INPUT'&&(o.type==='checkbox'||o.type==='radio')){
      var nc2=n.hasAttribute('checked');
      if(o.checked!==nc2) o.checked=nc2;
    }
    if(o.tagName==='TEXTAREA'){
      // textarea value lives as child text in HTML; textContent gives decoded string
      var tv=n.textContent;
      if(o.value!==tv) o.value=tv;
    }
  }
  // Recurse children (skip textarea — its content is the value, not children)
  if(o.tagName!=='TEXTAREA') _mKids(o,n);
  // Select: after options are patched, align .value to the selected option
  if(!focused&&o.tagName==='SELECT'){
    var sel=n.querySelector('option[selected]');
    var sv=sel?sel.value:(n.getAttribute('value')||'');
    if(sv!==''&&o.value!==sv) o.value=sv;
  }
}

function _mKids(o,n){
  var nc=n.childNodes,i,nk,rn,match,oid={};
  // Build id-keyed index of current children for O(1) keyed matching
  var cur=o.firstChild;
  while(cur){if(cur.nodeType===1&&cur.id)oid[cur.id]=cur;cur=cur.nextSibling;}

  for(i=0;i<nc.length;i++){
    nk=nc[i];
    rn=o.childNodes[i]||null; // live NodeList — updates as we insert/move nodes
    if(nk.nodeType===3){       // text node
      if(rn&&rn.nodeType===3){
        if(rn.textContent!==nk.textContent) rn.textContent=nk.textContent;
      } else {
        o.insertBefore(document.createTextNode(nk.textContent),rn);
      }
    } else if(nk.nodeType===1){ // element node
      match=null;
      if(nk.id&&oid[nk.id]){match=oid[nk.id];delete oid[nk.id];}
      if(match){
        // Keyed match found — move to current position if needed
        if(match!==rn) o.insertBefore(match,rn);
        if(match.tagName===nk.tagName) _mEl(match,nk);
        else { var cl=nk.cloneNode(true); o.replaceChild(cl,match); }
      } else if(rn&&rn.nodeType===1&&rn.tagName===nk.tagName&&!rn.id){
        // Unkeyed structural match — update in-place
        _mEl(rn,nk);
      } else {
        // No match — insert clone
        o.insertBefore(nk.cloneNode(true),rn);
      }
    }
  }
  // Trim extra old children
  while(o.childNodes.length>nc.length) o.removeChild(o.lastChild);
}

function morph(el,html){
  _morphBuf.innerHTML=html;
  _mKids(el,_morphBuf);
  _morphBuf.innerHTML=''; // release references
}

// dRender: debounced render for search/filter inputs.
// No focus-restore hack needed — morph preserves the active element naturally.
var _dRenderTimer=null;
function dRender(){
  clearTimeout(_dRenderTimer);
  _dRenderTimer=setTimeout(render,200);
}

function render(){
  buildLookups(); // no-op if clean; rebuilds cl/ma/ct maps when markLuDirty() was called
  // applyPrefs() removed: it runs in savePrefs() before every prefs-changing
  // render, and in INIT. Calling it on every render was wasted DOM classList work.
  var views={timesheet:vTimesheet,clients:vClients,matters:vMatters,contacts:vContacts,analytics:vAnalytics,approvals:vApprovals,invoices:vInvoices};
  var role=myRole();
  var visTabs=TABS.filter(function(t){
    if(t.id==='analytics'&&!ST.prefs.analyticsEnabled) return false;
    return (!t.roleOnly||t.roleOnly===role)&&(!t.roleExclude||t.roleExclude.indexOf(role)===-1);
  });
  var nav=visTabs.map(function(t){
    var pcount=(t.id==='approvals'&&role==='partner')?(ST.entries.filter(function(e){return (e.status||'approved')==='pending';}).length + (ST.invoices||[]).filter(function(i){return i.status==='review';}).length):0;
    var badge=pcount>0?' <span style="background:var(--amber);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px">'+pcount+'</span>':'';
    return '<button class="nav-btn'+(ST.tab===t.id?' on':'')+'" onclick="A.setTab(\''+t.id+'\')">'+t.ic+' '+t.lbl+badge+'</button>';
  }).join('');
  var tabDef=TABS.find(function(t){return t.id===ST.tab;});
  if(tabDef&&tabDef.roleOnly&&tabDef.roleOnly!==role){ST.tab="timesheet";}
  if(ST.tab==='analytics'&&!ST.prefs.analyticsEnabled){ST.tab='timesheet';}
  var viewH=(views[ST.tab]||vTimesheet)();
  var overlays='';
  if(ST.modal==='up') overlays=buildUP();
  else if(ST.modal==='ql') overlays=buildQL();
  else if(ST.modal==='help') overlays=buildHelp();
  else if(ST.modal==='settings') overlays=buildSettings();
  else if(ST.modal==='mailpreset') overlays=buildMailPreset();
  else if(ST.modal==='mailph') overlays=buildMailPH();
  else if(ST.modal==='mailsend') overlays=buildMailSend();
  else if(ST.modal==='mailcompose') overlays=buildMailCompose();
  else if(ST.modal==='importData') overlays=buildImportModal();
  else if(ST.modal==='exportModal') overlays=buildExportModal();
  else if(ST.modal==='submitTimesheet') overlays=buildSubmitTimesheetModal();
  else if(ST.modal==='receivePackage') overlays=buildReceivePackageModal();
  else if(ST.modal==='ituser') overlays=buildITUserModal();
  else if(ST.modal==='profileImport') overlays=buildProfileImport();
  else if(ST.modal==='userSelect') overlays=buildITUserSelect();
  else if(ST.modal==='invForm') overlays=buildInvoiceForm();
  else if(ST.modal==='invReview') overlays=buildInvoiceReview();
  else if(ST.modal==='invPrint') overlays=buildInvoicePrint();
  else if(ST.modal==='pref') overlays=buildPartnerReview();
  else if(ST.modal==='workflowImport') overlays=buildWorkflowImportPreview();
  else if(ST.modal==='billingEdit') overlays=buildBillingEditModal();

  var appName=H(ST.prefs.appName||'SixMinuteLog.com');
  var dmCur=ST.prefs.darkMode;
  var dmIcon=dmCur===true?IC.sun:IC.moon;
  var dmTitle=dmCur===null?'Theme: Auto (click for Dark)':dmCur===true?'Theme: Dark (click for Light)':'Theme: Light (click for Auto)';

  morph(document.getElementById('app'),
    '<div class="header">'
    +'<div class="header-inner">'
    +'<div class="logo"><span style="font-size:1.4rem">&#9878;&#65039;</span>'
    +'<div><h1>'+appName+'</h1>'+(ST.user?'<div class="logo-sub" style="display:flex;align-items:center;gap:6px">'+H(ST.user.name)+' '+roleBadge(ST.user.role)+'</div>':'')+'</div></div>'
    +'<div class="header-btns">'
    +'<button class="btn btn-gh" onclick="ST.modal=\'importData\';render()" title="Restore from backup">'+IC.ul+' Restore</button>'
    +'<button class="btn btn-gh" onclick="A.csvQuickExport()" title="Download CSV with your saved preset (configure in Settings → Backup)">'+IC.dl+' CSV</button>'
    +'<button class="btn btn-gr" onclick="A.exportJSON()" title="Download full backup (.json)">'+IC.dl+' Backup</button>'
    +'<button class="btn-ic" onclick="A.togDark()" title="'+dmTitle+'" style="'+( dmCur===true?'color:var(--amber)':dmCur===null?'color:var(--ink3)':'')+'">'+(dmIcon)+'</button>'
    +'<button class="btn-ic" onclick="A.openHelp()" title="Help">'+IC.help+'</button>'
    +'<button class="btn-ic" onclick="A.openSettings()" title="Settings">'+IC.gear+'</button>'
    +'</div></div>'
    +'<div class="nav">'+nav+'</div></div>'
    +'<div class="main">'+viewH+'</div>'
    +overlays);

  document.getElementById('fab').style.display=((isBilling()&&ST.tab!=='timesheet')||(ST.modal&&ST.modal!=='help'&&ST.modal!=='settings'))?'none':'flex';
  if(ST.modal==='up') setTimeout(function(){var el=document.getElementById('up-n');if(el)el.focus();},50);
  if(ST.modal==='mailpreset') setTimeout(_mpPreview,30);
}


// === ACTIONS
var A={
  setTab:function(t){
    ST.tab=t; ST.modal=null; ST.editId=null;
    // Analytics needs complete history for accurate aggregates
    if(t==='analytics'&&ST._entriesMode==='partial'){
      Store.getAllEntries().then(function(entries){
        ST.entries=entries; ST._entriesMode='full'; markLuDirty(); render();
      });
      return;
    }
    render();
  },
  setTsF:function(v){
    ST.tsFilter=v; ST.tsPage=0;
    // "All Time" or "All" filter may need full history — load it from IDB if partial
    if((v==='all')&&ST._entriesMode==='partial'){
      Store.getAllEntries().then(function(entries){
        ST.entries=entries; ST._entriesMode='full'; markLuDirty(); render();
      });
      return;
    }
    render();
  },
  setAnF:function(v){
    ST.anFilter=v;
    // Analytics always needs complete data for accurate aggregates
    if(ST._entriesMode==='partial'){
      Store.getAllEntries().then(function(entries){
        ST.entries=entries; ST._entriesMode='full'; markLuDirty(); render();
      });
      return;
    }
    render();
  },
  // Timesheet extra filters & sort — all reset the page
  setTsClF:function(v){ST.tsClientFilter=v;ST.tsMatterFilter='';ST.tsPage=0;render();},
  setTsMaF:function(v){ST.tsMatterFilter=v;ST.tsPage=0;render();},
  setTsSort:function(v){ST.tsSort=v;ST.tsPage=0;render();},
  // Pagination actions
  tsPrevPage:function(){if(ST.tsPage>0){ST.tsPage--;render();}},
  tsNextPage:function(){ST.tsPage++;render();},
  tsFirstPage:function(){ST.tsPage=0;render();},
  tsLastPage:function(p){ST.tsPage=p;render();},
  clearTsFilters:function(){ST.tsClientFilter='';ST.tsMatterFilter='';ST.tsSort='date-desc';ST.tsPage=0;render();},
  // Clients
  setClSort:function(v){ST.clSort=v;render();},
  setClSearch:function(v){ST.clSearch=v;dRender();},
  // Matters
  setMaSort:function(v){ST.maSort=v;render();},
  setMaClF:function(v){ST.maClientFilter=v;render();},
  setMaSearch:function(v){ST.maSearch=v;dRender();},
  toggleMaGroup:function(){ST.maGroup=!ST.maGroup;render();},
  clearMaFilters:function(){ST.maClientFilter='';ST.maSearch='';ST.maSort='alpha';ST.maGroup=false;render();},
  // Contacts
  setCtSort:function(v){ST.ctSort=v;render();},
  setCtSearch:function(v){ST.ctSearch=v;dRender();},
  setHT:function(t){ST.helpTab=t;render();},
  closeF:function(){ST.modal=null;ST.editId=null;render();},
  closeM:function(){ST.modal=null;render();},

  // == Dark Mode ==
  setDarkMode:function(v){
    // v is null (auto), true (dark), or false (light) — passed from onclick or settings
    ST.prefs.darkMode=v;
    savePrefs(); render();
  },
  togDark:function(){
    // Cycle: auto → dark → light → auto
    var cur=ST.prefs.darkMode;
    ST.prefs.darkMode=cur===null?true:(cur===true?false:null);
    savePrefs(); render();
  },
  togDarkPref:function(v){
    ST.prefs.darkMode=v;
    savePrefs(); render();
  },

  // == Analytics Tab (revenueSplit mirrors analyticsEnabled — no separate toggle) ==
  togAnalytics:function(v){
    ST.prefs.analyticsEnabled=v;
    ST.prefs.revenueSplit=v;
    if(!v&&ST.tab==='analytics') ST.tab='timesheet';
    toast(v?'Analytics enabled':'Analytics hidden','ok');
    savePrefs(); render();
  },

  // == Layout ==
  setLayout:function(v){
    ST.prefs.layout=v;
    savePrefs(); render();
  },

  // == App Name ==
  saveAppName:function(){
    var n=(document.getElementById('pref-name')||{}).value||'SixMinuteLog.com';
    ST.prefs.appName=n.trim()||'SixMinuteLog.com';
    var fn=(document.getElementById('it-firmname')||{}).value||'';
    if(!ST.firmProfile) ST.firmProfile={};
    ST.firmProfile.firmName=fn.trim();
    ST.firmProfile.appName=ST.prefs.appName;
    savePrefs(); save(); toast('Firm identity saved','ok'); render();
  },

  // == Settings Tab ==
  setStab:function(t){
    if(ST.modal==='settings'){syncForm();}
    ST.settingsTab=t; render();
  },

  // == Description Presets ==
  pickDesc:function(fieldId, idx){
    var p=typeof idx==='number'?ST.descPresets[idx]:idx;
    if(!p) return;
    var el=document.getElementById(fieldId);
    if(!el) return;
    el.value=p;
    // Sync to state
    if(fieldId==='ef-desc') ST.ef.description=p;
    if(fieldId==='ql-d'){ ST.ql.description=p; render(); }
    // Animate chip
    var chips=document.querySelectorAll('.desc-chip');
    chips.forEach(function(c){ c.classList.remove('active'); });
  },
  addDesc:function(){
    var inp=document.getElementById('desc-new');
    if(!inp) return;
    var v=inp.value.trim();
    if(!v){ toast('Enter a description first','warn'); return; }
    ST.descPresets.push(v);
    save(); toast('Suggestion added','ok'); render();
    setTimeout(function(){var el=document.getElementById('desc-new');if(el)el.focus();},50);
  },
  delDesc:function(i){
    ST.descPresets.splice(i,1);
    save(); toast('Removed','warn'); render();
  },
  moveDesc:function(i,dir){
    var arr=ST.descPresets;
    var ni=i+dir;
    if(ni<0||ni>=arr.length) return;
    var tmp=arr[i]; arr[i]=arr[ni]; arr[ni]=tmp;
    save(); render();
  },
  editDescPreset:function(i){
    var cur=ST.descPresets[i];
    var nv=prompt('Edit description suggestion:', cur);
    if(nv===null) return;
    nv=nv.trim();
    if(!nv){ toast('Cannot be empty','warn'); return; }
    ST.descPresets[i]=nv;
    save(); toast('Updated','ok'); render();
  },

  // == Mail Presets ==
  openMailPreset:function(idx){
    if(idx!=null){
      var mp=ST.mailPresets[idx];
      ST.mpf=Object.assign({},mp,{editIdx:idx});
    } else {
      ST.mpf={editIdx:null,name:'',purpose:'general',priority:'normal',to:'',cc:'',bcc:'',replyTo:'',subject:'',body:'',signature:''};
    }
    ST.modal='mailpreset'; render();
  },
  editMailPreset:function(idx){ A.openMailPreset(idx); },
  closeMailPreset:function(){
    ST.modal='settings'; ST.settingsTab='email'; render();
  },
  openMailPH:function(idx){
    if(idx!=null&&ST.mailPlaceholders[idx]){
      ST.mphf=Object.assign({},ST.mailPlaceholders[idx],{editIdx:idx,errs:{}});
      if(!ST.mphf.source) ST.mphf.source='static';
    } else {
      ST.mphf={editIdx:null,key:'',label:'',value:'',source:'static',linkedField:'',errs:{}};
    }
    ST.modal='mailph'; render();
  },
  mphSetSource:function(src){
    var key=((document.getElementById('mph-key')||{}).value||ST.mphf.key||'').trim();
    var label=((document.getElementById('mph-label')||{}).value||ST.mphf.label||'').trim();
    var value=((document.getElementById('mph-value')||{}).value||ST.mphf.value||'').trim();
    var lf=((document.getElementById('mph-lf')||{}).value||ST.mphf.linkedField||'');
    ST.mphf=Object.assign({},ST.mphf,{source:src,key:key,label:label,value:value,linkedField:lf,errs:{}});
    render();
  },
  // Live-update the hint below the linked-field dropdown without a full re-render
  mphPreviewLF:function(val){
    ST.mphf=Object.assign({},ST.mphf,{linkedField:val});
    var hint=LINKED_FIELD_HINTS[val]||'';
    // Find or create hint element
    var sel=document.getElementById('mph-lf');
    if(!sel) return;
    var existing=sel.parentNode.querySelector('.lf-hint-box');
    if(hint){
      if(!existing){
        existing=document.createElement('div');
        existing.className='lf-hint-box';
        existing.style.cssText='font-size:11px;color:var(--blue);background:rgba(59,130,246,.07);border-radius:5px;padding:4px 8px;margin-top:4px';
        sel.parentNode.insertBefore(existing,sel.nextSibling);
      }
      existing.textContent='\u2139 '+hint;
    } else if(existing){
      existing.remove();
    }
  },
  closeMailPH:function(){
    ST.mphf={}; ST.modal='settings'; ST.settingsTab='email'; render();
  },
  saveMailPH:function(){
    var key=((document.getElementById('mph-key')||{}).value||'').trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
    var label=((document.getElementById('mph-label')||{}).value||'').trim();
    var phSrc=ST.mphf.source||'static';
    var value=(phSrc==='static')?((document.getElementById('mph-value')||{}).value||'').trim():'';
    var linkedField=(phSrc==='linked')?((document.getElementById('mph-lf')||{}).value||'').trim():'';
    var errs={};
    if(!key) errs.key='Token key is required.';
    else {
      var reserved=['client','matter','firm','user','initials','date','due_date','invoice_num','amount','entries_count','hours_total','filename','cc_list'];
      if(reserved.indexOf(key)!==-1) errs.key='{'+key+'} is a built-in placeholder and cannot be overridden.';
      // Check duplicate key among custom placeholders (excluding self)
      var editIdx=ST.mphf.editIdx;
      var dupe=ST.mailPlaceholders.some(function(p,i){ return p.key===key && i!==editIdx; });
      if(dupe) errs.key='A custom placeholder with this key already exists.';
    }
    if(!label) errs.label='Label is required.';
    if(phSrc==='linked'&&!linkedField) errs.linkedField='Please choose a field to link.';
    if(Object.keys(errs).length){ ST.mphf.errs=errs; render(); return; }
    var ph={id:uid(),key:key,label:label,source:phSrc,value:value,linkedField:linkedField};
    if(ST.mphf.editIdx!=null){
      ph.id=ST.mailPlaceholders[ST.mphf.editIdx].id||ph.id;
      ST.mailPlaceholders[ST.mphf.editIdx]=ph;
    } else {
      ST.mailPlaceholders.push(ph);
    }
    save(); toast('Placeholder saved','ok');
    ST.mphf={}; ST.modal='settings'; ST.settingsTab='email'; render();
  },
  delMailPH:function(idx){
    if(!confirm('Delete this placeholder?')) return;
    ST.mailPlaceholders.splice(idx,1);
    save(); toast('Placeholder deleted','warn'); render();
  },
  saveMailPreset:function(){
    var name=(document.getElementById('mp-name')||{}).value||'';
    var purpose=(document.getElementById('mp-purpose')||{}).value||'general';
    var priority=(document.getElementById('mp-priority')||{}).value||'normal';
    var to=(document.getElementById('mp-to')||{}).value||'';
    var cc=(document.getElementById('mp-cc')||{}).value||'';
    var bcc=(document.getElementById('mp-bcc')||{}).value||'';
    var replyTo=(document.getElementById('mp-replyto')||{}).value||'';
    var subj=(document.getElementById('mp-subj')||{}).value||'';
    var body=(document.getElementById('mp-body')||{}).value||'';
    var signature=(document.getElementById('mp-sig')||{}).value||'';
    name=name.trim();
    if(!name){ toast('Preset name required','warn'); return; }
    var mp={
      id:ST.mpf.editIdx!=null?ST.mailPresets[ST.mpf.editIdx].id:uid(),
      name:name,purpose:purpose,priority:priority,
      to:to.trim(),cc:cc.trim(),bcc:bcc.trim(),replyTo:replyTo.trim(),
      subject:subj.trim(),body:body.trim(),signature:signature.trim()
    };
    if(ST.mpf.editIdx!=null){
      ST.mailPresets[ST.mpf.editIdx]=mp;
    } else {
      ST.mailPresets.push(mp);
    }
    ST.mpf={};
    save(); toast('Email preset saved','ok');
    ST.modal='settings'; ST.settingsTab='email'; render();
  },
  delMailPreset:function(i){
    if(!confirm('Delete this email preset?')) return;
    ST.mailPresets.splice(i,1);
    save(); toast('Preset deleted','warn'); render();
  },
  dupMailPreset:function(i){
    var mp=ST.mailPresets[i];
    if(!mp) return;
    var copy=Object.assign({},mp,{id:uid(),name:'Copy of '+mp.name});
    ST.mailPresets.push(copy);
    save(); toast('Preset duplicated','ok'); render();
  },
  openMailSend:function(){
    ST.mailCompose={purpose:'general',toEmail:'',clientName:'',invId:null,invNum:null,invAmount:null,entriesCount:null,_preview:false,_draft:null,_mailto:null,_preset:null};
    ST.modal='mailcompose'; render();
  },

  // From the settings email tab "Send via Email" button on a preset card —
  // goes straight to the preview/edit screen (no picker needed, preset already chosen)
  sendMailPreset:function(i){
    var mp=ST.mailPresets[i];
    if(!mp) return;
    ST.mailCompose={purpose:mp.purpose||'general',toEmail:mp.to||'',clientName:'',invId:null,invNum:null,invAmount:null,entriesCount:null,_preview:false,_draft:null,_mailto:null,_preset:null,clientId:null,matterId:null};
    ST.modal='mailcompose';
    A.previewFromCompose(i);
  },

  // Open contextual email compose for an invoice (called from invoice list, print preview, client card)
  emailInvoice:function(invId){
    var inv=ST.invoices.find(function(i){return i.id==invId;});
    if(!inv){ toast('Invoice not found','warn'); return; }
    var cl=ST.clients.find(function(c){return c.id==inv.clientId;})||{};
    var total=0;
    (inv.entryIds||[]).forEach(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;})||{};
      var h=(inv.cuts&&inv.cuts[eid]!=null)?Number(inv.cuts[eid]):Number(e.hours||0);
      total+=h*Number(e.rate||0);
    });
    (inv.mergedEntries||[]).forEach(function(mg){
      total+=Number(mg.hours||0)*Number(mg.rate||0);
    });
    ST.mailCompose={
      purpose:'invoice_client',
      toEmail:cl.email||'',
      clientId:cl.id||null,
      matterId:null,
      clientName:cl.name||'',
      invId:invId,
      invNum:String(inv.number||inv.id),
      invAmount:$m(total),
      entriesCount:null,
      hoursTotal:null,
      _preview:false, _draft:null, _mailto:null, _preset:null
    };
    ST.modal='mailcompose'; render();
  },

  // Open contextual email compose for timesheet entries
  // purpose: 'billing_staff' | 'partner_approval'
  emailEntries:function(purpose){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    if(!fe.length){ toast('No entries to email','warn'); return; }
    var pending=fe.filter(function(e){return (e.status||'approved')==='pending';});
    var target=(purpose==='partner_approval'&&pending.length>0)?pending:fe;
    var toEmail='';
    if(purpose==='billing_staff'){
      var bsCt=ST.contacts.find(function(c){
        return c.email&&c.role&&c.role.toLowerCase().indexOf('billing')!==-1;
      });
      if(bsCt) toEmail=bsCt.email;
    } else if(purpose==='partner_approval'){
      var pCt=ST.contacts.find(function(c){
        return c.email&&c.role&&(c.role.toLowerCase().indexOf('partner')!==-1||c.role.toLowerCase().indexOf('supervising')!==-1);
      });
      if(pCt) toEmail=pCt.email;
    }
    var hrs=target.reduce(function(s,e){return s+Number(e.hours||0);},0);
    var clName=ST.tsClientFilter?(ST.clients.find(function(c){return c.id==ST.tsClientFilter;})||{}).name||'All Clients':'All Clients';
    ST.mailCompose={
      purpose:purpose,
      toEmail:toEmail,
      clientId:ST.tsClientFilter||null,
      matterId:ST.tsMatterFilter||null,
      clientName:clName,
      invId:null,
      invNum:null,
      invAmount:null,
      entriesCount:target.length,
      hoursTotal:hrs.toFixed(1),
      _preview:false, _draft:null, _mailto:null, _preset:null
    };
    ST.modal='mailcompose'; render();
  },

  // Resolve a preset's placeholders and open the preview/edit screen
  previewFromCompose:function(i){
    var mp=ST.mailPresets[i];
    if(!mp){ toast('Preset not found','warn'); return; }
    var ctx=ST.mailCompose||{};
    var map=_phMap(ctx, mp);
    var fullBody=(mp.body||'')+(mp.signature?'\n\n'+(mp.signature):'');
    var toRaw=(mp.to&&mp.to.trim().length)?mp.to:(ctx.toEmail||'');
    var draft={
      to:   toRaw,
      subj: _applyPH(mp.subject||'', map),
      body: _applyPH(fullBody, map),
      cc:   mp.cc||'',
      bcc:  mp.bcc||'',
      replyTo: mp.replyTo||''
    };
    ST.mailCompose._preview=true;
    ST.mailCompose._pvTab='edit';
    ST.mailCompose._draft=draft;
    ST.mailCompose._origDraft=Object.assign({},draft); // snapshot for reset
    ST.mailCompose._preset=mp;
    ST.mailCompose._mailto=null;
    render();
  },

  // Called oninput on any draft field — sync state without full re-render.
  // Only touches fields whose elements are actually in the DOM so that calling
  // this while on the preview tab (where the inputs are absent) never clobbers
  // the draft with empty strings.
  mcLive:function(){
    if(!ST.mailCompose||!ST.mailCompose._draft) return;
    var d=ST.mailCompose._draft;
    [['mc-to','to'],['mc-subj','subj'],['mc-cc','cc'],
     ['mc-bcc','bcc'],['mc-rt','replyTo'],['mc-body','body']].forEach(function(p){
      var el=document.getElementById(p[0]);
      if(el) d[p[1]]=el.value;
    });
  },

  // Switch edit/preview tab — sync fields first so values survive re-render
  mcTab:function(tab){
    A.mcLive();
    ST.mailCompose._pvTab=tab;
    render();
  },

  // Reset draft to original resolved-preset values
  mcReset:function(){
    if(!ST.mailCompose) return;
    ST.mailCompose._draft=Object.assign({},ST.mailCompose._origDraft||{});
    ST.mailCompose._pvTab='edit';
    render();
  },

  // Build mailto from current draft and advance to the open-app screen
  sendFromDraft:function(){
    A.mcLive();
    var ctx=ST.mailCompose||{};
    var d=ctx._draft||{};
    if(!d.to){ toast('Recipient (To) is required','warn'); return; }
    var mailto='mailto:'+d.to  // to-address is path, not a query value — must not be percent-encoded
      +'?subject='+encodeURIComponent(d.subj||'')
      +'&body='+encodeURIComponent(d.body||'');
    if(d.cc)      mailto+='&cc='+encodeURIComponent(d.cc);
    if(d.bcc)     mailto+='&bcc='+encodeURIComponent(d.bcc);
    if(d.replyTo) mailto+='&reply-to='+encodeURIComponent(d.replyTo);
    var a=document.createElement('a'); a.href=mailto; a.click();
  },

  // Navigate back to picker, clearing draft
  backToPicker:function(){
    if(!ST.mailCompose) return;
    ST.mailCompose._preview=false;
    ST.mailCompose._draft=null;
    ST.mailCompose._mailto=null;
    ST.mailCompose._preset=null;
    render();
  },

  // Legacy alias kept for any callers that may exist in presets settings view
  sendFromCompose:function(i){ A.previewFromCompose(i); },



  // Live phone formatting - called oninput, doesn't cause re-render
  livePhone:function(id){
    var el=document.getElementById(id);
    if(!el) return;
    var pos=el.selectionStart;
    var raw=el.value;
    var fmt=fmtPhone(raw);
    el.value=fmt;
    // Adjust cursor: if we added chars before cursor, push it forward
    var diff=fmt.length-raw.length;
    try{el.setSelectionRange(pos+diff,pos+diff);}catch(e){}
  },

  // User
  saveUser:function(){
    var n=(document.getElementById('up-n')||{}).value||'';
    n=n.trim();
    if(!n) return;
    var raw=(document.getElementById('up-i')||{}).value||'';
    var ini=raw.trim()||n.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
    var pct=document.getElementById('up-pct');
    var ownPct=pct?Number(pct.value):100;
    if(isNaN(ownPct)||ownPct<0) ownPct=0;
    if(ownPct>100) ownPct=100;
    var roleEl=document.getElementById('up-role');
    var role=roleEl?roleEl.value:'attorney';
    var rateEl=document.getElementById('up-rate');
    var rate=rateEl?fmtCur(rateEl.value||''):'';
    var salEl=document.getElementById('up-sal');
    var salary=salEl&&salEl.value?fmtCur(salEl.value||''):'';
    var emailEl=document.getElementById('up-e');
    var email=emailEl?emailEl.value.trim():'';
    var phoneEl=document.getElementById('up-p');
    var phone=phoneEl?phoneEl.value.trim():'';
    ST.user={name:n,initials:ini,ownPct:ownPct,role:role,rate:rate?Number(rate):'',salary:salary?Number(salary):'',email:email,phone:phone};
    Store.setMeta('user',ST.user);
    // Sync user into contacts so they appear in Team Member dropdown & Contacts tab
    var existingUserCt=ST.contacts.find(function(c){return c.isUser;});
    var userCtId=existingUserCt?existingUserCt.id:uid();
    // Preserve rateHistory from existing contact record — managed via Contacts tab
    var userCt={id:userCtId,name:n,role:role||'',email:email,phone:phone,rate:rate?Number(rate):'',ownPct:ownPct,salary:salary?Number(salary):'',rateHistory:(existingUserCt&&existingUserCt.rateHistory)||[],isUser:true,createdBy:n,createdByIni:ini};
    if(existingUserCt){ST.contacts=ST.contacts.map(function(c){return c.isUser?userCt:c;});}
    else{ST.contacts=ST.contacts.concat([userCt]);}
    save();
    var wasFirstRun=ST._splashMode;
    ST._splashMode=false;
    ST.modal=null;
    render();
    toast(wasFirstRun?'Welcome, '+n+'! \ud83c\udf89':'Profile updated');
  },
  chgUser:function(){ST._splashMode=false;ST.modal='up';render();},
  upSelRole:function(role){
    var el=document.getElementById('up-role');
    if(el) el.value=role;
    // Re-render just the role cards to reflect selection without losing typed name/rate
    document.querySelectorAll('.splash-role').forEach(function(el){
      var v=el.getAttribute('onclick')||'';
      el.classList.toggle('sel',v.indexOf("'"+role+"'")!==-1);
    });
  },

  setUserPct:function(v){
    var pct=Number(v);
    if(isNaN(pct)) return;
    pct=Math.max(0,Math.min(100,pct));
    if(!ST.user) ST.user={name:'',initials:'?',ownPct:pct};
    else ST.user.ownPct=pct;
    Store.setMeta('user',ST.user);
    // Re-render only analytics section without full re-render (no flicker)
    var an=document.querySelector('.main');
    if(an&&ST.tab==='analytics') an.innerHTML=vAnalytics();
  },

  // Entry form
  openEF:function(){
    // Billing staff CAN add entries on behalf of attorneys/partners
    ST.ef={date:today(),clientId:'',matterId:'',contactId:'',byContactId:'',hours:'',rate:'',description:'',abaCode:'',errs:{}};
    ST.modal='ef'; render();
    var el=document.getElementById('ef'); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
  },
  editEnt:function(id){
    var e=ST.entries.find(function(x){return x.id==id;}); if(!e) return;
    var me=ST.user?ST.user.name:'';
    var entSt=e.status||'approved';
    var role=myRole();
    // Attorney: can only edit own pending entries
    if(role==='attorney'&&(e.createdBy!==me||entSt!=='pending')){toast(entSt==='approved'?'Cannot edit approved entries':'Cannot edit rejected entries','warn');return;}
    // Partner: can edit own entries; cannot edit others' entries via this form (use Approvals)
    if(role==='partner'&&e.createdBy!==me&&entSt==='approved'){toast('Use the Approvals tab to adjust approved entries','warn');return;}
    // Billing staff: can edit any entry; pre-populate byContactId from existing createdBy match
    var byContactId='';
    if(role==='billing_staff'){
      var byCt=ST.contacts.find(function(c){return c.name===e.createdBy;});
      byContactId=byCt?String(byCt.id):'';
    }
    ST.editId=id; ST.ef=Object.assign({abaCode:'',byContactId:byContactId},e,{errs:{}}); ST.modal='ef';
    render(); var el=document.getElementById('ef'); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
  },
  saveEnt:function(){
    // Sync all typed values first
    var f=ST.ef;
    f.date=g('ef-d'); f.clientId=g('ef-cl'); f.matterId=g('ef-ma');
    // Billing staff: contactId is derived from the attorney selection, not a separate field
    f.contactId=(entRole==='billing_staff')?f.byContactId:g('ef-ct');
    f.hours=g('ef-h'); f.rate=fmtCur(g('ef-r')||''); f.description=g('ef-desc'); f.abaCode=g('ef-aba')||'';
    var entRole=myRole();
    // Billing staff: read & validate the "Logged By" attorney selector
    if(entRole==='billing_staff'){
      var byEl=document.getElementById('ef-by');
      f.byContactId=byEl?byEl.value:'';
    }
    var errs={};
    if(!f.date) errs.d='Required';
    if(!f.clientId) errs.cl='Select a client';
    if(!f.hours||isNaN(Number(f.hours))||Number(f.hours)<=0) errs.h='Enter hours';
    // rate is optional — blank/0 is allowed (unrated entry)
    if(entRole==='billing_staff'&&!f.byContactId) errs.by='Select the attorney for this entry';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    // Keep precise hours (finalize feature will round when grouping)
    var hrs=Number(f.hours);
    var existingEntry=ST.editId?ST.entries.find(function(e){return e.id==ST.editId;}):null;
    // Preserve status when editing; set initial status based on role for new entries
    var entStatus=existingEntry?existingEntry.status:(entRole==='partner'?'approved':'pending');
    // Determine createdBy / createdByIni:
    //   - Attorney or partner: always their own identity — no override possible
    //   - Billing staff: the selected attorney/timekeeper contact
    var createdBy, createdByIni;
    if(entRole==='billing_staff'){
      var byCt=ST.contacts.find(function(c){return String(c.id)===String(f.byContactId);});
      createdBy=byCt?byCt.name:'Unknown';
      createdByIni=byCt?(byCt.initials||(byCt.name.split(' ').filter(Boolean).map(function(w){return w[0];}).join('').toUpperCase().substring(0,3))):'?';
    } else {
      createdBy=ST.user?ST.user.name:'';
      createdByIni=ST.user?ST.user.initials:'?';
    }
    var entry={id:ST.editId||uid(),date:f.date,
      clientId:Number(f.clientId),matterId:Number(f.matterId)||'',contactId:Number(f.contactId)||'',
      hours:hrs,rate:f.rate?Number(f.rate):0,description:f.description||'',abaCode:f.abaCode||'',
      createdBy:createdBy,createdByIni:createdByIni,
      // Track who actually entered this (billing staff vs. the timekeeper)
      enteredBy:(entRole==='billing_staff'&&ST.user)?ST.user.name:undefined,
      enteredByRole:entRole==='billing_staff'?'billing_staff':undefined,
      status:entStatus,finalized:existingEntry?existingEntry.finalized:false};
    if(ST.editId){ST.entries=ST.entries.map(function(e){return e.id==ST.editId?entry:e;});toast('Entry updated');}
    else{ST.entries=ST.entries.concat([entry]);toast(entRole==='billing_staff'?'Entry added on behalf of '+createdBy:entRole==='attorney'?'Entry submitted for approval':'Entry added');}
    saveOne('entries',entry); A.closeF();
  },
  delEnt:function(id){if(!confirm('Delete this time entry?'))return;ST.entries=ST.entries.filter(function(e){return e.id!=id;});delOne('entries',id);toast('Deleted','warn');render();},

  // Approval actions (partner only)
  approveEnt:function(id){
    if(!isPartner()){toast('Only partners can approve entries','warn');return;}
    var updated;
    ST.entries=ST.entries.map(function(e){
      if(e.id==id){updated=Object.assign({},e,{status:'approved',approvedBy:ST.user?ST.user.name:'',approvedAt:today()});return updated;}
      return e;
    });
    if(updated) saveOne('entries',updated);
    toast('Entry approved'); render();
  },
  rejectEnt:function(id){
    if(!isPartner()){toast('Only partners can reject entries','warn');return;}
    if(!confirm('Reject this entry?')) return;
    var updated;
    ST.entries=ST.entries.map(function(e){
      if(e.id==id){updated=Object.assign({},e,{status:'rejected',approvedBy:ST.user?ST.user.name:'',approvedAt:today()});return updated;}
      return e;
    });
    if(updated) saveOne('entries',updated);
    toast('Entry rejected','warn'); render();
  },

  // Partner Review Entry: open modal with edit + comment fields
  openPartnerReview:function(id){
    if(!isPartner()){toast('Only partners can review entries','warn');return;}
    var e=ST.entries.find(function(x){return x.id==id;});
    if(!e){toast('Entry not found','err');return;}
    ST.pref={
      entryId:id,
      hours:String(e.hours),
      rate:String(e.rate||''),
      description:e.description||'',
      comment:e.partnerComment||'',
      showOnInvoice:!!e.showCommentOnInvoice,
      errs:{}
    };
    ST.modal='pref'; render();
  },

  // Sync live changes from partner review form inputs
  syncPartnerReview:function(){
    var f=ST.pref;
    var h=document.getElementById('pref-h'); if(h)f.hours=h.value;
    var r=document.getElementById('pref-r'); if(r)f.rate=r.value;
    var d=document.getElementById('pref-desc'); if(d)f.description=d.value;
    var c=document.getElementById('pref-cmt'); if(c)f.comment=c.value;
    var inv=document.getElementById('pref-inv'); if(inv)f.showOnInvoice=inv.checked;
  },

  partnerReviewSave:function(andApprove){
    if(!isPartner()){toast('Only partners can review entries','warn');return;}
    A.syncPartnerReview();
    var f=ST.pref;
    var e=ST.entries.find(function(x){return x.id==f.entryId;});
    if(!e) return;
    var newH=Math.round(parseFloat(f.hours)*10)/10;
    if(isNaN(newH)||newH<=0){toast('Hours must be a positive number','err');return;}
    var newR=parseFloat(f.rate);
    if(isNaN(newR)||newR<0){toast('Rate must be a valid number','err');return;}
    var origH=Number(e.hours);
    var origR=Number(e.rate||0);
    var origD=e.description||'';
    var hoursEdited=(newH!==origH);
    var anyEdited=hoursEdited||(newR!==origR)||((f.description||'')!==origD);
    // Preserve the original submitted hours for invoice display (strikethrough)
    // Use existing submittedHours if already set (so we always track the attorney's original)
    var submittedHours=e.submittedHours!=null?e.submittedHours:(hoursEdited?origH:null);
    var updates={
      hours:String(newH),
      rate:String(newR),
      description:f.description||e.description,
      partnerComment:f.comment||'',
      showCommentOnInvoice:!!f.showOnInvoice,
      partnerEdited:anyEdited,
      submittedHours:submittedHours,
      approvedBy:ST.user?ST.user.name:''
    };
    if(andApprove) Object.assign(updates,{status:'approved',approvedAt:today()});
    ST.entries=ST.entries.map(function(x){return x.id==f.entryId?Object.assign({},x,updates):x;});
    // Keep inv.cuts in sync: any invoice containing this entry must reflect the
    // partner-edited hours, otherwise cuts[eid] would silently override e.hours.
    if(hoursEdited){
      ST.invoices=(ST.invoices||[]).map(function(inv){
        if(!(inv.entryIds||[]).some(function(id){return id==f.entryId;})) return inv;
        var cuts=Object.assign({},inv.cuts||{});
        cuts[f.entryId]=newH;
        var updated2=Object.assign({},inv,{cuts:cuts});
        saveOne('invoices',updated2);
        return updated2;
      });
    }
    var savedEntry=ST.entries.find(function(x){return x.id==f.entryId;});
    if(savedEntry) saveOne('entries',savedEntry);
    toast(andApprove?(anyEdited?'Approved with edits':'Entry approved'):'Changes saved',(andApprove?'ok':'ok'));
    A.closeM();
    render();
  },

  partnerReviewReject:function(){
    if(!isPartner()){toast('Only partners can reject entries','warn');return;}
    A.syncPartnerReview();    var f=ST.pref;
    if(!confirm('Reject this entry? The attorney will see the rejection and any comments you left.')) return;
    var updates={
      status:'rejected',
      approvedBy:ST.user?ST.user.name:'',
      approvedAt:today(),
      partnerComment:f.comment||'',
      showCommentOnInvoice:!!f.showOnInvoice,
      partnerEdited:false
    };
    // Also apply any hour/rate/desc edits even on reject (for tracking)
    var newH=Math.round(parseFloat(f.hours)*10)/10;
    var newR=parseFloat(f.rate);
    if(!isNaN(newH)&&newH>0) updates.hours=String(newH);
    if(!isNaN(newR)&&newR>=0) updates.rate=String(newR);
    if(f.description) updates.description=f.description;
    ST.entries=ST.entries.map(function(x){return x.id==f.entryId?Object.assign({},x,updates):x;});
    var savedEntry2=ST.entries.find(function(x){return x.id==f.entryId;});
    if(savedEntry2) saveOne('entries',savedEntry2);
    toast('Entry rejected','warn'); A.closeM(); render();
  },
  approveAll:function(){
    if(!isPartner()){toast('Only partners can approve entries','warn');return;}
    var pending=ST.entries.filter(function(e){return (e.status||'approved')==='pending';});
    if(!pending.length){toast('No pending entries to approve','warn');return;}
    if(!confirm('Approve all '+pending.length+' pending entries?')) return;
    var now=today();
    var approver=ST.user?ST.user.name:'';
    ST.entries=ST.entries.map(function(e){
      return (e.status||'approved')==='pending'?Object.assign({},e,{status:'approved',approvedBy:approver,approvedAt:now}):e;
    });
    save(); toast('Approved '+pending.length+' entr'+(pending.length===1?'y':'ies')); render();
  },

  // ── Workflow Transfer Package Export ────────────────────────────────────────
  // Attorney: export their own pending/visible entries as a submission package
  // ── Submit Timesheet / Send to Partner / Return to Billing ─────────────────
  openSubmitTimesheet:function(){ ST.modal='submitTimesheet'; render(); },
  openReceivePackage:function(){ ST.modal='receivePackage'; render(); },

  // Called from the Submit modal: save the package file
  doSubmitSaveFile:function(pkgType){
    var role=myRole();
    var me=ST.user?ST.user.name:'';
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var entries;
    if(role==='attorney') entries=fe.filter(function(e){return e.createdBy===me;});
    else if(role==='partner') entries=fe.filter(function(e){return (e.status||'pending')==='approved';});
    else entries=fe;
    if(!entries.length){toast('No entries to export in current view','warn');return;}
    var fname=_exportWorkflowPackage(pkgType||'attorney_submission', entries, {});
    toast('Saved '+entries.length+' entries \u2192 '+fname);
  },

  // Billing staff: export package scoped to entries for clients assigned to a specific partner
  doSubmitSaveFileByPartner:function(partnerId){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var entries;
    if(partnerId==='__none__'){
      entries=fe.filter(function(e){return !_getClientPartner(e.clientId);});
    } else {
      entries=fe.filter(function(e){
        var pt=_getClientPartner(e.clientId);
        return pt&&String(pt.id)===String(partnerId);
      });
    }
    if(!entries.length){toast('No entries found for this partner in the current view','warn');return;}
    var fname=_exportWorkflowPackage('billing_review', entries, {});
    toast('Saved '+entries.length+' entries \u2192 '+fname);
  },

  // Called from the Submit modal: open email compose
  doSubmitEmail:function(purpose){
    var role=myRole();
    var rcpEmail='';
    if(purpose==='billing_staff'){
      var bsCt=ST.contacts.find(function(c){return c.email&&c.role&&c.role.toLowerCase().indexOf('billing')!==-1;});
      if(bsCt) rcpEmail=bsCt.email;
    } else {
      var pCt=ST.contacts.find(function(c){return c.email&&c.role&&(c.role.toLowerCase().indexOf('partner')!==-1||c.role.toLowerCase().indexOf('supervising')!==-1);});
      if(pCt) rcpEmail=pCt.email;
    }
    var toVal=rcpEmail;
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var me=ST.user?ST.user.name:'';
    var target;
    if(role==='attorney') target=fe.filter(function(e){return e.createdBy===me;});
    else if(role==='partner') target=fe.filter(function(e){return (e.status||'pending')==='approved';});
    else target=fe;
    var hrs=target.reduce(function(s,e){return s+Number(e.hours||0);},0);
    var clName=ST.tsClientFilter?(ST.clients.find(function(c){return c.id==ST.tsClientFilter;})||{}).name||'All Clients':'All Clients';
    ST.mailCompose={
      purpose:purpose,
      toEmail:toVal,
      clientId:ST.tsClientFilter||null,
      matterId:ST.tsMatterFilter||null,
      clientName:clName,
      invId:null, invNum:null, invAmount:null,
      entriesCount:target.length,
      hoursTotal:hrs.toFixed(1),
      note:'',
      _preview:false, _draft:null, _mailto:null, _preset:null
    };
    ST.modal='mailcompose'; render();
  },

  exportAttorneySubmission:function(){
    var me=ST.user?ST.user.name:'';
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var myEntries=myRole()==='attorney'?fe.filter(function(e){return e.createdBy===me;}):fe;
    if(!myEntries.length){toast('No entries to export in current view','warn');return;}
    var fname=_exportWorkflowPackage('attorney_submission', myEntries);
    toast('Exported '+myEntries.length+' entries \u2192 '+fname);
  },
  exportBillingReview:function(){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    if(!fe.length){toast('No entries to export in current view','warn');return;}
    var fname=_exportWorkflowPackage('billing_review', fe);
    toast('Exported '+fe.length+' entries for partner review \u2192 '+fname);
  },
  exportPartnerApproval:function(){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var approved=fe.filter(function(e){return (e.status||'approved')==='approved';});
    if(!approved.length){toast('No approved entries in current view','warn');return;}
    var fname=_exportWorkflowPackage('partner_approval', approved);
    toast('Exported '+approved.length+' approved entries \u2192 '+fname);
  },

  // ── Workflow Transfer Package Import ────────────────────────────────────────
  importWorkflowPackage:function(inp){
    var file=inp.files[0]; if(!file) return;
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var pkg=JSON.parse(ev.target.result);
        if(!pkg||!pkg._type||!pkg._version){
          // Try regular JSON import fallback
          if(pkg&&pkg._version===1){A.importJSON({files:[file]});return;}
          toast('Not a valid workflow package or backup file','err'); return;
        }
        ST._pendingWorkflowPkg=pkg;
        ST.modal='workflowImport';
        render();
      }catch(e){toast('Failed to read file','err');console.error(e);}
    };
    reader.readAsText(file,'UTF-8'); inp.value='';
  },
  confirmWorkflowImport:function(){
    var pkg=ST._pendingWorkflowPkg;
    if(!pkg){toast('No package to import','err');return;}
    var msg=_importWorkflowPackage(pkg);
    ST._pendingWorkflowPkg=null;
    ST.modal=null;
    render();
    toast(msg);
  },
  cancelWorkflowImport:function(){
    ST._pendingWorkflowPkg=null;
    ST.modal=null;
    render();
  },
  openWorkflowExport:function(){ ST.modal='submitTimesheet'; render(); },

  // Billing staff: edit ABA code on an existing entry
  billingEditEntry:function(id){
    if(!isBilling()){toast('This action is for billing staff','warn');return;}
    var e=ST.entries.find(function(x){return x.id==id;}); if(!e) return;
    ST.editId=id;
    ST.ef=Object.assign({abaCode:''},e,{errs:{}});
    ST.modal='billingEdit'; render();
  },
  saveBillingEdit:function(){
    var id=ST.editId;
    var e=ST.entries.find(function(x){return x.id==id;}); if(!e) return;
    var aba=g('be-aba')||'';
    var mn=g('be-mn')||'';
    var desc=g('be-desc')||e.description||'';
    var updated=Object.assign({},e,{abaCode:aba,description:desc});
    ST.entries=ST.entries.map(function(x){return x.id==id?updated:x;});
    saveOne('entries',updated);
    // Also update matter number if provided
    if(mn&&e.matterId){
      var mt=ST.matters.find(function(m){return m.id==e.matterId;});
      if(mt&&!mt.matterNumber){
        var updatedMt=Object.assign({},mt,{matterNumber:mn});
        ST.matters=ST.matters.map(function(m){return m.id==e.matterId?updatedMt:m;});
        saveOne('matters',updatedMt);
      }
    }
    toast('Entry updated'); A.closeF();
  },


  // Client form
  openCF:function(){ST.editId=null;ST.cf={name:'',email:'',phone:'',rate:'',contactIds:[],clientPeople:[],attorneyRates:[],newPerson:{},errs:{}};ST.modal='cf';render();},
  editCl:function(id){var c=ST.clients.find(function(x){return x.id==id;});if(!c)return;ST.editId=id;
    // Migrate legacy contactId to contactIds array
    var cids=c.contactIds&&c.contactIds.length?c.contactIds:(c.contactId?[Number(c.contactId)]:[]);
    ST.cf=Object.assign({},c,{contactIds:cids,clientPeople:c.clientPeople||[],attorneyRates:(c.attorneyRates||[]).map(function(r){return Object.assign({},r);}),newPerson:{},errs:{}});ST.modal='cf';render();},
  cfTogCt:function(cb){
    var id=Number(cb.getAttribute('data-cf-ct'));
    var ids=ST.cf.contactIds||[];
    if(cb.checked){if(!ids.some(function(x){return x==id;}))ST.cf.contactIds=ids.concat([id]);}
    else{ST.cf.contactIds=ids.filter(function(x){return x!=id;});}
  },
  cfRemCt:function(id){
    syncForm();
    ST.cf.contactIds=(ST.cf.contactIds||[]).filter(function(x){return x!=id;});
    render();
  },
  cfAddPerson:function(){
    syncForm();
    var n=(document.getElementById('cf-pn')||{}).value||'';
    n=n.trim();
    if(!n){toast('Enter a name','err');return;}
    var ro=(document.getElementById('cf-pro')||{}).value||'';
    var em=(document.getElementById('cf-pe')||{}).value||'';
    var ph=(document.getElementById('cf-pp')||{}).value||'';
    ST.cf.clientPeople=(ST.cf.clientPeople||[]).concat([{id:uid(),name:n,role:ro.trim(),email:em.trim(),phone:ph.trim()}]);
    ST.cf.newPerson={};
    render();
    var el=document.getElementById('cf-pn'); if(el){el.focus();}
  },
  cfRemPerson:function(i){
    syncForm();
    ST.cf.clientPeople=(ST.cf.clientPeople||[]).filter(function(_,idx){return idx!==i;});
    render();
  },
  cfAddAtRate:function(){
    syncForm();
    var ctVal=((document.getElementById('cf-ar-ct')||{}).value||'').trim();
    var rateVal=parseFloat((document.getElementById('cf-ar-rate')||{}).value||'');
    var dateVal=((document.getElementById('cf-ar-date')||{}).value||'').trim();
    var noteVal=((document.getElementById('cf-ar-note')||{}).value||'').trim();
    if(!ctVal){toast('Select an attorney','err');return;}
    if(!rateVal||rateVal<=0){toast('Enter a valid rate','err');return;}
    if(!dateVal){toast('Enter an effective date','err');return;}
    var ar=ST.cf.attorneyRates||[];
    // Prevent exact duplicate
    if(ar.some(function(r){return r.contactId==ctVal&&r.effectiveDate===dateVal;})){toast('A rate entry for this attorney/date already exists','err');return;}
    ST.cf.attorneyRates=ar.concat([{contactId:Number(ctVal),rate:rateVal,effectiveDate:dateVal,note:noteVal}]);
    render();
  },
  cfRemAtRate:function(idx){
    syncForm();
    var ar=ST.cf.attorneyRates||[];
    ST.cf.attorneyRates=ar.filter(function(_,i){return i!==idx;});
    render();
  },
  saveCl:function(){
    var f=ST.cf;
    f.name=g('cf-n'); f.email=g('cf-e'); f.phone=g('cf-p');
    // Sync new-person draft fields
    var pn=g('cf-pn')||''; if(pn.trim())f.newPerson={name:pn,role:g('cf-pro')||'',email:g('cf-pe')||'',phone:g('cf-pp')||''};
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(f.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email)) errs.e='Invalid email';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var c={id:ST.editId||uid(),name:f.name.trim(),email:f.email||'',phone:f.phone||'',contactIds:f.contactIds||[],clientPeople:(f.clientPeople||[]).map(function(p){return p.id?p:Object.assign({id:uid()},p);}),attorneyRates:f.attorneyRates||[],createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    if(ST.editId){ST.clients=ST.clients.map(function(x){return x.id==ST.editId?c:x;});toast('Client updated');}
    else{ST.clients=ST.clients.concat([c]);toast('Client added');}
    saveOne('clients',c); A.closeF();
  },
  delCl:function(id){if(!confirm('Delete this client?'))return;ST.clients=ST.clients.filter(function(c){return c.id!=id;});delOne('clients',id);toast('Deleted','warn');render();},

  // Matter form
  openMF:function(){ST.editId=null;ST.mf={name:'',clientId:'',description:'',rate:'',contactId:'',matterNumber:'',linkedClientPeopleIds:[],attorneyRates:[],errs:{}};ST.modal='mf';render();},
  editMa:function(id){var m=ST.matters.find(function(x){return x.id==id;});if(!m)return;ST.editId=id;ST.mf=Object.assign({},m,{matterNumber:m.matterNumber||'',linkedClientPeopleIds:m.linkedClientPeopleIds||[],attorneyRates:(m.attorneyRates||[]).map(function(r){return Object.assign({},r);}),errs:{}});ST.modal='mf';render();},
  saveMa:function(){
    var f=ST.mf;
    f.name=g('mf-n'); f.clientId=g('mf-cl'); f.description=g('mf-desc'); f.contactId=g('mf-ct'); f.matterNumber=g('mf-num')||'';
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(!f.clientId) errs.cl='Select a client';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var m={id:ST.editId||uid(),name:f.name.trim(),clientId:Number(f.clientId),matterNumber:f.matterNumber.trim(),description:f.description||'',contactId:Number(f.contactId)||'',linkedClientPeopleIds:f.linkedClientPeopleIds||[],attorneyRates:f.attorneyRates||[],createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    if(ST.editId){ST.matters=ST.matters.map(function(x){return x.id==ST.editId?m:x;});toast('Matter updated');}
    else{ST.matters=ST.matters.concat([m]);toast('Matter added');}
    saveOne('matters',m); A.closeF();
  },
  delMa:function(id){if(!confirm('Delete this matter?'))return;ST.matters=ST.matters.filter(function(m){return m.id!=id;});delOne('matters',id);toast('Deleted','warn');render();},
  mfToggleClientPerson:function(personId){
    syncForm();
    var ids=ST.mf.linkedClientPeopleIds||[];
    var pid=Number(personId);
    if(ids.some(function(x){return x==pid;})){ST.mf.linkedClientPeopleIds=ids.filter(function(x){return x!=pid;});}
    else{ST.mf.linkedClientPeopleIds=ids.concat([pid]);}
    render();
  },
  mfAddAtRate:function(){
    syncForm();
    var ctVal=((document.getElementById('mf-ar-ct')||{}).value||'').trim();
    var rateVal=parseFloat((document.getElementById('mf-ar-rate')||{}).value||'');
    var dateVal=((document.getElementById('mf-ar-date')||{}).value||'').trim();
    var noteVal=((document.getElementById('mf-ar-note')||{}).value||'').trim();
    if(!ctVal){toast('Select an attorney','err');return;}
    if(!rateVal||rateVal<=0){toast('Enter a valid rate','err');return;}
    if(!dateVal){toast('Enter an effective date','err');return;}
    var ar=ST.mf.attorneyRates||[];
    if(ar.some(function(r){return r.contactId==ctVal&&r.effectiveDate===dateVal;})){toast('A rate entry for this attorney/date already exists','err');return;}
    ST.mf.attorneyRates=ar.concat([{contactId:Number(ctVal),rate:rateVal,effectiveDate:dateVal,note:noteVal}]);
    render();
  },
  mfRemAtRate:function(idx){
    syncForm();
    var ar=ST.mf.attorneyRates||[];
    ST.mf.attorneyRates=ar.filter(function(_,i){return i!==idx;});
    render();
  },

  // Contact form
  openCTF:function(){ST.editId=null;ST.ctf={name:'',role:'',email:'',phone:'',rate:'',ownPct:100,salary:'',rateHistory:[],errs:{}};ST.modal='ctf';render();},
  editCt:function(id){var c=ST.contacts.find(function(x){return x.id==id;});if(!c)return;ST.editId=id;ST.ctf=Object.assign({},c,{rateHistory:(c.rateHistory||[]).map(function(r){return Object.assign({},r);}),errs:{}});ST.modal='ctf';render();},

  // Add / remove rate history entries in contact form
  ctfAddRate:function(){
    syncForm();
    var rateVal=parseFloat((document.getElementById('ctf-rh-rate')||{}).value||'');
    var dateVal=((document.getElementById('ctf-rh-date')||{}).value||'').trim();
    var noteVal=((document.getElementById('ctf-rh-note')||{}).value||'').trim();
    if(!rateVal||rateVal<=0){toast('Enter a valid rate','err');return;}
    if(!dateVal){toast('Enter an effective date','err');return;}
    var rh=ST.ctf.rateHistory||[];
    // Prevent duplicate effective dates
    if(rh.some(function(r){return r.effectiveDate===dateVal;})){toast('A rate entry already exists for that date','err');return;}
    ST.ctf.rateHistory=(rh).concat([{effectiveDate:dateVal,rate:rateVal,note:noteVal}]);
    render();
  },
  ctfRemRate:function(idx){
    syncForm();
    var rh=ST.ctf.rateHistory||[];
    // idx is index in the sorted display order (desc by date), map back to original array
    var sorted=rh.slice().sort(function(a,b){return a.effectiveDate<b.effectiveDate?1:-1;});
    var entry=sorted[idx];
    if(!entry) return;
    ST.ctf.rateHistory=rh.filter(function(r){return r!==entry&&!(r.effectiveDate===entry.effectiveDate&&r.rate===entry.rate);});
    render();
  },

  saveCt:function(){
    var f=ST.ctf;
    f.name=g('ctf-n'); f.role=g('ctf-ro'); f.email=g('ctf-e'); f.phone=g('ctf-p'); f.rate=fmtCur(g('ctf-rate')||'');
    var opv=g('ctf-op'); f.ownPct=opv!==''?Math.min(100,Math.max(0,Number(opv))):100;
    var salv=g('ctf-sal'); f.salary=salv&&salv!==''?fmtCur(salv):'';
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(f.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email)) errs.e='Invalid email';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var existing=ST.editId?ST.contacts.find(function(x){return x.id==ST.editId;}):null;
    // If rate history has entries, derive the current .rate from the latest applicable entry today
    var rh=f.rateHistory||[];
    var latestR=_rateOnDate(rh,today());
    var savedRate=f.rate?Number(f.rate):(latestR||'');
    var c={id:ST.editId||uid(),name:f.name.trim(),role:f.role||'',email:f.email||'',phone:f.phone||'',rate:savedRate,ownPct:f.ownPct,salary:f.salary?Number(f.salary):'',rateHistory:rh,createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    // Preserve isUser flag if this contact is the logged-in user
    if(existing&&existing.isUser) c.isUser=true;
    if(ST.editId){ST.contacts=ST.contacts.map(function(x){return x.id==ST.editId?c:x;});toast('Contact updated');}
    else{ST.contacts=ST.contacts.concat([c]);toast('Contact added');}
    // If this is the user's own contact, keep ST.user in sync
    if(c.isUser&&ST.user){
      var oldIni=ST.user.initials||'';
      // Auto-regen initials if name changed and initials were auto-generated (matching old name pattern)
      var autoIni=ST.user.name?ST.user.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase():'';
      var newAutoIni=c.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
      var ini2=(oldIni===autoIni)?newAutoIni:oldIni;
      ST.user=Object.assign({},ST.user,{name:c.name,role:c.role,email:c.email,phone:c.phone,rate:c.rate,ownPct:c.ownPct,salary:c.salary,initials:ini2});
      Store.setMeta('user',ST.user);
    }
    saveOne('contacts',c); A.closeF();
  },
  delCt:function(id){if(!confirm('Delete this contact?'))return;ST.contacts=ST.contacts.filter(function(c){return c.id!=id;});delOne('contacts',id);toast('Deleted','warn');render();},

  // Quick Log
  openQL:function(){if(isBilling()){toast('Use New Entry to add entries on behalf of an attorney','warn');return;}ST.modal='ql';ST.ql={clientId:'',matterId:'',hours:'',rate:'',description:'',addToId:'',rawMs:null,newCl:false,newClName:'',newMa:false,newMaName:''};render();},
  closeQL:function(){stopTmr();ST.modal=null;render();},
  qlSet:function(k,v){ST.ql[k]=v;},
  qlCl:function(v){
    syncForm();
    if(v==='__new__'){ST.ql.newCl=true;ST.ql.newClName='';render();return;}
    ST.ql.clientId=v;ST.ql.matterId='';ST.ql.newCl=false;
    var r=autoRate(v,'','',today());if(r&&!ST.ql.rate)ST.ql.rate=String(r);
    render();
  },
  qlMa:function(v){
    syncForm();
    if(v==='__new__'){ST.ql.newMa=true;ST.ql.newMaName='';render();return;}
    ST.ql.matterId=v;ST.ql.newMa=false;
    var r=autoRate(ST.ql.clientId,v,'',today());if(r&&!ST.ql.rate)ST.ql.rate=String(r);
    render();
  },
  qlCancelNew:function(which){syncForm();if(which==='cl')ST.ql.newCl=false;else ST.ql.newMa=false;render();},
  qlCreateClient:function(){
    syncForm();
    var name=(ST.ql.newClName||'').trim();
    if(!name){toast('Client name required','err');return;}
    var rec={id:uid(),name:name,email:'',phone:'',rate:0,contactId:''};
    ST.clients=ST.clients.concat([rec]);saveOne('clients',rec);
    ST.ql.clientId=String(rec.id);ST.ql.matterId='';ST.ql.newCl=false;ST.ql.newClName='';
    toast('Client created','ok');render();
  },
  qlCreateMatter:function(){
    syncForm();
    if(!ST.ql.clientId){toast('Select a client first','err');return;}
    var name=(ST.ql.newMaName||'').trim();
    if(!name){toast('Matter name required','err');return;}
    var rec={id:uid(),name:name,clientId:Number(ST.ql.clientId),description:'',rate:0,contactId:''};
    ST.matters=ST.matters.concat([rec]);saveOne('matters',rec);
    ST.ql.matterId=String(rec.id);ST.ql.newMa=false;ST.ql.newMaName='';
    toast('Matter created','ok');render();
  },
  qlPickEntry:function(id){
    syncForm();
    var id2=String(id);
    if(!id2){ST.ql.addToId='';render();return;}
    var e=ST.entries.find(function(x){return String(x.id)===id2;});
    if(!e)return;
    ST.ql.addToId=id2;ST.ql.clientId=String(e.clientId||'');ST.ql.matterId=String(e.matterId||'');ST.ql.rate=String(e.rate||'');ST.ql.description=e.description||'';
    render();
  },
  saveQL:function(){
    syncForm();
    var f=ST.ql;
    if(!f.clientId||!f.hours){toast('Fill in client and hours','err');return;}
    stopTmr();
    var hrs=Number(f.hours);
    var qlRole=myRole();
    var qlStatus=qlRole==='partner'?'approved':'pending';
    if(f.addToId){
      var target=ST.entries.find(function(x){return String(x.id)===String(f.addToId);});
      if(target){
        var newHrs=Math.round((Number(target.hours)+hrs)*10000)/10000;
        var newRawMs=(target.rawMs!=null&&f.rawMs!=null)?(target.rawMs+f.rawMs):null;
        var updated;
        ST.entries=ST.entries.map(function(x){if(String(x.id)===String(f.addToId)){updated=Object.assign({},x,{hours:newHrs,rawMs:newRawMs});return updated;}return x;});
        if(updated)saveOne('entries',updated);
        ST.modal=null;ST.tab='timesheet';toast('+'+hrs.toFixed(1)+'h added \u2192 '+newHrs.toFixed(1)+'h total &#9889;');render();return;
      }
    }
    var entry={id:uid(),date:today(),clientId:Number(f.clientId),matterId:Number(f.matterId)||'',contactId:'',
      hours:hrs,rawMs:(f.rawMs!=null?f.rawMs:null),rate:f.rate?Number(f.rate):0,description:f.description||'',
      createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?',
      status:qlStatus,finalized:false};
    ST.entries=ST.entries.concat([entry]);
    saveOne('entries',entry);ST.modal=null;ST.tab='timesheet';toast(qlRole==='attorney'?'Entry submitted for approval &#9889;':'Entry logged! &#9889;');render();
  },

  // Row-level stopwatch
  rowTmrStart:function(entId){
    var rt=ST.rowTmr;
    if(rt&&String(rt.entId)!==String(entId)){
      if(!confirm('Timer is running on another entry. Switch to this one?\n(Time on the other entry will be discarded.)'))return;
      clearInterval(rt.iv);
    }
    ST.rowTmr={entId:entId,startMs:Date.now(),accMs:0,iv:null};
    ST.rowTmr.iv=setInterval(function(){
      var el=document.getElementById('row-tmr-'+entId);
      if(!el){clearInterval(ST.rowTmr&&ST.rowTmr.iv);return;}
      var ms=Date.now()-ST.rowTmr.startMs+ST.rowTmr.accMs;
      var h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000),s=Math.floor((ms%60000)/1000);
      el.textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    },500);
    render();
  },
  rowTmrStop:function(){
    var rt=ST.rowTmr;if(!rt)return;
    clearInterval(rt.iv);
    var elapsed=Date.now()-rt.startMs+rt.accMs;
    var addHrs=Math.round((elapsed/3600000)*10000)/10000;
    var target=ST.entries.find(function(x){return String(x.id)===String(rt.entId);});
    if(!target){ST.rowTmr=null;render();return;}
    var newHrs=Math.round((Number(target.hours)+addHrs)*10000)/10000;
    var newRawMs=target.rawMs!=null?(target.rawMs+elapsed):elapsed;
    var updated;
    ST.entries=ST.entries.map(function(x){
      if(String(x.id)===String(rt.entId)){updated=Object.assign({},x,{hours:newHrs,rawMs:newRawMs});return updated;}
      return x;
    });
    if(updated)saveOne('entries',updated);
    ST.rowTmr=null;
    toast('+'+addHrs.toFixed(2)+'h added \u2192 '+newHrs.toFixed(2)+'h total &#9889;');
    render();
  },

  // Timer
  togTmr:function(){
    if(ST.tmrOn){
      stopTmr();
      var hrs=ST.tmrMs/3600000;
      // Preserve full precision in hours field; no forced minimum — user can review and adjust
      ST.ql.hours=String(Math.round(hrs*10000)/10000);
      ST.ql.rawMs=ST.tmrMs; // carry exact ms to save
    } else {
      ST.tmrStart=Date.now();
      ST.tmrOn=true;
      ST.tmrIv=setInterval(function(){
        var el=document.getElementById('ql-t'); if(!el){stopTmr();return;}
        var ms=Date.now()-ST.tmrStart+ST.tmrMs;
        el.textContent=String(Math.floor(ms/3600000)).padStart(2,'0')+':'+String(Math.floor((ms%3600000)/60000)).padStart(2,'0')+':'+String(Math.floor((ms%60000)/1000)).padStart(2,'0');
        el.className='timer-num timer-on';
      },500);
    }
    render();
  },
  rstTmr:function(){stopTmr();ST.tmrMs=0;ST.tmrStart=0;ST.ql.hours='';ST.ql.rawMs=null;render();},

  // Help / Settings
  openHelp:function(){ST.modal='help';render();},
  openSettings:function(){ST.modal='settings';render();},

  // Reset
  resetAll:function(){
    if(!confirm('Delete ALL data? This cannot be undone!\nExport a backup first.')) return;
    if(!confirm('Are you absolutely sure?')) return;
    ST.clients=[]; ST.matters=[]; ST.entries=[]; ST.contacts=[]; ST.invoices=[];
    ST._entriesMode='full'; ST._totalEntryCount=0; markLuDirty();
    Store.clearData();
    ST.user=null; ST._splashMode=true; ST.modal='profileImport'; toast('All data reset','warn'); render();
  },


  // ─ Download helper (works without URL.createObjectURL) ─
  _dlData:function(content, fname, mime){
    // Blob+createObjectURL: reliable for large files, no encoding corruption.
    var blob=new Blob([content],{type:mime+';charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download=fname; a.style.display='none';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},2000);
  },

  // ═══════════════════════════════════════════════════════
  // CSV EXPORT WIZARD ACTIONS
  // ═══════════════════════════════════════════════════════

  openExportModal:function(){
    // Reset to fresh defaults when opening
    var today0=today();
    var fy=new Date(); fy.setMonth(0); fy.setDate(1);
    var fyStr=fy.getFullYear()+'-01-01';
    ST.csvX=Object.assign(ST.csvX,{
      dataset:'entries',
      dateFrom:fyStr, dateTo:today0,
      allClients:true, clientIds:{},
      allMatters:true, matterIds:{},
      cols:{date:true,client:true,matter:true,contact:false,hours:true,rate:true,amount:true,desc:true,by:false,entryId:false,abaCode:false},
      clCols:{name:true,email:true,phone:true,rate:true,contact:false},
      maCols:{name:true,client:true,desc:true,rate:true,contact:false},
      ctCols:{name:true,role:true,email:true,phone:true,rate:false,ownPct:false},
      groupBy:'none', includeTotals:true, includeGrandTotal:true,
      dateFormat:'iso', currencySymbol:true, filenamePrefix:''
    });
    ST.modal='exportModal'; render();
  },

  csvXDataset:function(ds){ syncForm(); ST.csvX.dataset=ds; render(); },

  csvXOpt:function(k,v){
    syncForm();
    ST.csvX[k]=v;
    render();
  },

  csvXPreset:function(p){
    syncForm();
    var t=new Date(); var x=ST.csvX;
    function iso(d){ return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate()); }
    if(p==='today'){ x.dateFrom=iso(t); x.dateTo=iso(t); }
    else if(p==='week'){
      var mon=new Date(t); mon.setDate(t.getDate()-((t.getDay()+6)%7));
      var sun=new Date(mon); sun.setDate(mon.getDate()+6);
      x.dateFrom=iso(mon); x.dateTo=iso(sun);
    } else if(p==='month'){
      var m1=new Date(t.getFullYear(),t.getMonth(),1);
      var m2=new Date(t.getFullYear(),t.getMonth()+1,0);
      x.dateFrom=iso(m1); x.dateTo=iso(m2);
    } else if(p==='quarter'){
      var q=Math.floor(t.getMonth()/3);
      var q1=new Date(t.getFullYear(),q*3,1);
      var q2=new Date(t.getFullYear(),q*3+3,0);
      x.dateFrom=iso(q1); x.dateTo=iso(q2);
    } else if(p==='year'){
      x.dateFrom=t.getFullYear()+'-01-01'; x.dateTo=t.getFullYear()+'-12-31';
    } else {
      x.dateFrom=''; x.dateTo='';
    }
    render();
  },

  csvXAllClients:function(v){ syncForm(); ST.csvX.allClients=v; if(v) ST.csvX.clientIds={}; render(); },
  csvXTogClient:function(id,v){ syncForm(); ST.csvX.allClients=false; ST.csvX.clientIds[id]=v; render(); },
  csvXAllMatters:function(v){ syncForm(); ST.csvX.allMatters=v; if(v) ST.csvX.matterIds={}; render(); },
  csvXTogMatter:function(id,v){ syncForm(); ST.csvX.allMatters=false; ST.csvX.matterIds[id]=v; render(); },

  csvXTogCol:function(k){ syncForm(); ST.csvX.cols[k]=!ST.csvX.cols[k]; render(); },
  csvXAllCols:function(v){ syncForm(); var c=ST.csvX.cols; Object.keys(c).forEach(function(k){c[k]=v;}); render(); },
  csvXTogClCol:function(k){ syncForm(); ST.csvX.clCols[k]=!ST.csvX.clCols[k]; render(); },
  csvXAllClCols:function(v){ syncForm(); var c=ST.csvX.clCols; Object.keys(c).forEach(function(k){c[k]=v;}); render(); },
  csvXTogMaCol:function(k){ syncForm(); ST.csvX.maCols[k]=!ST.csvX.maCols[k]; render(); },
  csvXAllMaCols:function(v){ syncForm(); var c=ST.csvX.maCols; Object.keys(c).forEach(function(k){c[k]=v;}); render(); },
  csvXTogCtCol:function(k){ syncForm(); ST.csvX.ctCols[k]=!ST.csvX.ctCols[k]; render(); },
  csvXAllCtCols:function(v){ syncForm(); var c=ST.csvX.ctCols; Object.keys(c).forEach(function(k){c[k]=v;}); render(); },

  // Returns count of rows that will be exported (for preview)
  _csvXCount:function(){
    var x=ST.csvX; var ds=x.dataset;
    if(ds==='entries') return A._csvXFilterEntries().length;
    if(ds==='clients') return ST.clients.length;
    if(ds==='matters') return ST.matters.length;
    if(ds==='contacts') return ST.contacts.length;
    return 0;
  },

  _csvXFilterEntries:function(){
    var x=ST.csvX;
    var rows=ST.entries;
    if(x.dateFrom) rows=rows.filter(function(e){return e.date>=x.dateFrom;});
    if(x.dateTo)   rows=rows.filter(function(e){return e.date<=x.dateTo;});
    if(!x.allClients){
      var cids=x.clientIds;
      rows=rows.filter(function(e){return cids[e.clientId];});
    }
    if(!x.allMatters){
      var mids=x.matterIds;
      rows=rows.filter(function(e){return mids[e.matterId];});
    }
    return rows;
  },

  // ── Shared CSV generation engine ──
  // cfg mirrors the shape of ST.csvX.
  // For 'entries', cfg must have dateFrom/dateTo already resolved (strings or '').
  // Returns the CSV string (with BOM).
  _runCsvExport:function(cfg){
    buildLookups();
    var x=cfg; var ds=x.dataset;
    var csv='';

    function esc(v){
      if(v===null||v===undefined) return '';
      var s=String(v);
      if(s.indexOf(',')!==-1||s.indexOf('"')!==-1||s.indexOf('\n')!==-1||s.indexOf('\r')!==-1){
        return '"'+s.replace(/"/g,'""')+'"';
      }
      return s;
    }
    function row(cells){ return cells.map(esc).join(',')+'\r\n'; }

    function fmtDate(d){
      if(!d) return '';
      var p=d.split('-'); if(p.length!==3) return d;
      var y=p[0],m=p[1],dd=p[2];
      if(x.dateFormat==='us') return m+'/'+dd+'/'+y;
      if(x.dateFormat==='uk') return dd+'/'+m+'/'+y;
      if(x.dateFormat==='long'){
        var mn=['January','February','March','April','May','June','July','August','September','October','November','December'];
        return mn[parseInt(m,10)-1]+' '+parseInt(dd,10)+', '+y;
      }
      return d;
    }
    function fmtMoney(v){
      var n=parseFloat(v)||0;
      var s=n.toFixed(2);
      return x.currencySymbol?'$'+s:s;
    }
    function fmtHours(v){ return (parseFloat(v)||0).toFixed(2); }

    function groupKey(e){
      if(x.groupBy==='client'){ var cl=_lu.cl[e.clientId]; return cl?cl.name:'(No Client)'; }
      if(x.groupBy==='matter'){ var ma=_lu.ma[e.matterId]; return ma?ma.name:'(No Matter)'; }
      if(x.groupBy==='date-month'){ var p=e.date.split('-'); return p[0]+'-'+p[1]; }
      if(x.groupBy==='date-week'){
        var dt=new Date(e.date+'T00:00:00');
        var mon=new Date(dt); mon.setDate(dt.getDate()-((dt.getDay()+6)%7));
        return 'Week of '+mon.toISOString().split('T')[0];
      }
      return '';
    }

    if(ds==='entries'){
      // Filter entries using cfg
      var rows=ST.entries;
      if(x.dateFrom) rows=rows.filter(function(e){return e.date>=x.dateFrom;});
      if(x.dateTo)   rows=rows.filter(function(e){return e.date<=x.dateTo;});
      if(!x.allClients && x.clientIds){
        var _cids=x.clientIds;
        rows=rows.filter(function(e){return _cids[e.clientId];});
      }
      if(!x.allMatters && x.matterIds){
        var _mids=x.matterIds;
        rows=rows.filter(function(e){return _mids[e.matterId];});
      }

      var c=x.cols||{};
      var hdr=[];
      if(c.date) hdr.push('Date');
      if(c.client) hdr.push('Client');
      if(c.matter) hdr.push('Matter');
      if(c.contact) hdr.push('Billing Contact');
      if(c.hours) hdr.push('Hours');
      if(c.rate) hdr.push('Rate');
      if(c.amount) hdr.push('Amount');
      if(c.desc) hdr.push('Description');
      if(c.abaCode) hdr.push('ABA Code');
      if(c.by) hdr.push('Created By');
      if(c.entryId) hdr.push('Entry ID');

      var entries=rows.slice().sort(function(a,b){
        if(x.groupBy&&x.groupBy!=='none'){
          var ka=groupKey(a),kb=groupKey(b);
          if(ka!==kb) return ka.localeCompare(kb);
        }
        return new Date(a.date)-new Date(b.date);
      });

      csv='\uFEFF';
      csv+=row(hdr);

      function entRow(e){
        var cl=_lu.cl[e.clientId]; var mt=_lu.ma[e.matterId]; var ct=_lu.ct[e.contactId];
        var cells=[];
        if(c.date) cells.push(fmtDate(e.date));
        if(c.client) cells.push(cl?cl.name:'');
        if(c.matter) cells.push(mt?mt.name:'');
        if(c.contact) cells.push(ct?ct.name:'');
        if(c.hours) cells.push(fmtHours(e.hours));
        if(c.rate) cells.push(fmtMoney(e.rate));
        if(c.amount) cells.push(fmtMoney(Number(e.hours)*Number(e.rate)));
        if(c.desc) cells.push(e.description||'');
        if(c.abaCode) cells.push(e.abaCode||'');
        if(c.by) cells.push(e.createdBy||e.createdByIni||'');
        if(c.entryId) cells.push(String(e.id));
        return row(cells);
      }

      function totalRow(label,ents){
        var hrs=ents.reduce(function(s,e){return s+Number(e.hours);},0);
        var amt=ents.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
        var cells=[];
        // Align label at first text-ish column, totals under hours/amount
        var preAmt=0;
        if(c.date) preAmt++;
        if(c.client) preAmt++;
        if(c.matter) preAmt++;
        if(c.contact) preAmt++;
        var firstCol=0;
        while(cells.length<firstCol) cells.push('');
        cells.push(label);
        while(cells.length<preAmt) cells.push('');
        if(c.hours) cells.push(fmtHours(hrs));
        if(c.rate) cells.push('');
        if(c.amount) cells.push(fmtMoney(amt));
        if(c.desc) cells.push('');
        if(c.abaCode) cells.push('');
        if(c.by) cells.push('');
        if(c.entryId) cells.push('');
        return row(cells);
      }

      var grouping=x.groupBy||'none';
      if(grouping==='none'){
        entries.forEach(function(e){ csv+=entRow(e); });
        if(x.includeGrandTotal && entries.length>0) csv+=totalRow('TOTAL',entries);
      } else {
        var groups=[]; var groupMap={};
        entries.forEach(function(e){
          var k=groupKey(e);
          if(!groupMap[k]){ groupMap[k]=[]; groups.push(k); }
          groupMap[k].push(e);
        });
        groups.forEach(function(k){
          var grpEntries=groupMap[k];
          csv+=row([k]);
          grpEntries.forEach(function(e){ csv+=entRow(e); });
          if(x.includeTotals) csv+=totalRow('Subtotal',grpEntries);
          csv+=row([]);
        });
        if(x.includeGrandTotal && entries.length>0) csv+=totalRow('GRAND TOTAL',entries);
      }
      return {csv:csv, rowCount:entries.length, dateFrom:x.dateFrom, dateTo:x.dateTo};
    }

    else if(ds==='clients'){
      var ch=x.clCols||{};
      var hdr2=[];
      if(ch.name) hdr2.push('Name');
      if(ch.email) hdr2.push('Email');
      if(ch.phone) hdr2.push('Phone');
      if(ch.rate) hdr2.push('Default Rate');
      if(ch.contact) hdr2.push('Primary Contact');
      csv='\uFEFF'+row(hdr2);
      ST.clients.slice().sort(function(a,b){return a.name.localeCompare(b.name);}).forEach(function(c){
        var ct=_lu.ct[c.contactId];
        var cells=[];
        if(ch.name) cells.push(c.name||'');
        if(ch.email) cells.push(c.email||'');
        if(ch.phone) cells.push(c.phone||'');
        if(ch.rate) cells.push(c.rate?fmtMoney(c.rate):'');
        if(ch.contact) cells.push(ct?ct.name:'');
        csv+=row(cells);
      });
      return {csv:csv, rowCount:ST.clients.length};
    }

    else if(ds==='matters'){
      var mh=x.maCols||{};
      var hdr3=[];
      if(mh.name) hdr3.push('Matter Name');
      if(mh.client) hdr3.push('Client');
      if(mh.desc) hdr3.push('Description');
      if(mh.rate) hdr3.push('Default Rate');
      if(mh.contact) hdr3.push('Billing Contact');
      csv='\uFEFF'+row(hdr3);
      ST.matters.slice().sort(function(a,b){return a.name.localeCompare(b.name);}).forEach(function(m){
        var cl2=_lu.cl[m.clientId]; var ct2=_lu.ct[m.contactId];
        var cells=[];
        if(mh.name) cells.push(m.name||'');
        if(mh.client) cells.push(cl2?cl2.name:'');
        if(mh.desc) cells.push(m.description||'');
        if(mh.rate) cells.push(m.rate?fmtMoney(m.rate):'');
        if(mh.contact) cells.push(ct2?ct2.name:'');
        csv+=row(cells);
      });
      return {csv:csv, rowCount:ST.matters.length};
    }

    else if(ds==='contacts'){
      var kh=x.ctCols||{};
      var hdr4=[];
      if(kh.name) hdr4.push('Name');
      if(kh.role) hdr4.push('Role');
      if(kh.email) hdr4.push('Email');
      if(kh.phone) hdr4.push('Phone');
      if(kh.rate) hdr4.push('Rate');
      if(kh.ownPct) hdr4.push('Ownership %');
      csv='\uFEFF'+row(hdr4);
      ST.contacts.slice().sort(function(a,b){return a.name.localeCompare(b.name);}).forEach(function(ct){
        var cells=[];
        if(kh.name) cells.push(ct.name||'');
        if(kh.role) cells.push(ct.role||'');
        if(kh.email) cells.push(ct.email||'');
        if(kh.phone) cells.push(ct.phone||'');
        if(kh.rate) cells.push(ct.rate?fmtMoney(ct.rate):'');
        if(kh.ownPct) cells.push(ct.ownPct!==undefined?String(ct.ownPct)+'%':'');
        csv+=row(cells);
      });
      return {csv:csv, rowCount:ST.contacts.length};
    }

    return {csv:'\uFEFF', rowCount:0};
  },

  // Core export runner (called from Export wizard modal)
  csvExport:function(){
    var result=A._runCsvExport(ST.csvX);
    var x=ST.csvX;
    var now=new Date();
    var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate());
    var prefix=(x.filenamePrefix||'').replace(/[^a-zA-Z0-9_\-]/g,'_');
    var dsLabel={entries:'time-entries',clients:'clients',matters:'matters',contacts:'contacts'}[x.dataset]||x.dataset;
    var dateSuffix=(x.dataset==='entries'&&(x.dateFrom||x.dateTo))
      ?(x.dateFrom?'_'+x.dateFrom:'')+(x.dateTo&&x.dateTo!==x.dateFrom?'_to_'+x.dateTo:'')
      :'';
    var fname=(prefix||'export')+'_'+dsLabel+dateSuffix+'_'+stamp+'.csv';
    A._dlData(result.csv, fname, 'text/csv');
    toast(result.rowCount+' rows exported to '+fname, 'ok');
    A.closeM();
  },

  // ── Quick-export: direct download from header button ──
  // Reads ST.prefs.csvQuick, resolves datePreset → dateFrom/dateTo, fires immediately.
  csvQuickExport:function(){
    var q=ST.prefs.csvQuick;
    if(!q){ toast('No quick export preset configured','warn'); return; }

    // Resolve datePreset to actual date strings
    var dateFrom='', dateTo='';
    var t=new Date();
    function iso(d){ return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate()); }
    var p=q.datePreset||'month';
    if(p==='today'){ dateFrom=iso(t); dateTo=iso(t); }
    else if(p==='week'){
      var mon=new Date(t); mon.setDate(t.getDate()-((t.getDay()+6)%7));
      var sun=new Date(mon); sun.setDate(mon.getDate()+6);
      dateFrom=iso(mon); dateTo=iso(sun);
    } else if(p==='month'){
      dateFrom=t.getFullYear()+'-'+pad2(t.getMonth()+1)+'-01';
      dateTo=iso(new Date(t.getFullYear(),t.getMonth()+1,0));
    } else if(p==='quarter'){
      var qn=Math.floor(t.getMonth()/3);
      dateFrom=iso(new Date(t.getFullYear(),qn*3,1));
      dateTo=iso(new Date(t.getFullYear(),qn*3+3,0));
    } else if(p==='year'){
      dateFrom=t.getFullYear()+'-01-01';
      dateTo=t.getFullYear()+'-12-31';
    }
    // p==='all' → both remain ''

    // Build a complete cfg compatible with _runCsvExport
    var cfg={
      dataset: q.dataset||'entries',
      dateFrom: dateFrom,
      dateTo: dateTo,
      allClients: true,   // quick export: no per-client filter
      allMatters: true,
      cols: Object.assign({date:true,client:true,matter:true,contact:false,hours:true,rate:true,amount:true,desc:true,by:false,entryId:false,abaCode:false}, q.cols||{}),
      clCols: Object.assign({name:true,email:true,phone:true,rate:true,contact:false}, q.clCols||{}),
      maCols: Object.assign({name:true,client:true,desc:true,rate:true,contact:false}, q.maCols||{}),
      ctCols: Object.assign({name:true,role:true,email:true,phone:true,rate:false,ownPct:false}, q.ctCols||{}),
      groupBy: q.groupBy||'none',
      includeTotals: q.includeTotals!==false,
      includeGrandTotal: q.includeGrandTotal!==false,
      dateFormat: q.dateFormat||'iso',
      currencySymbol: q.currencySymbol!==false,
      filenamePrefix: q.filenamePrefix||''
    };

    var result=A._runCsvExport(cfg);

    // Generate filename
    var now=new Date();
    var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate());
    var prefix=(cfg.filenamePrefix||'').replace(/[^a-zA-Z0-9_\-]/g,'_');
    var dsLabel={entries:'time-entries',clients:'clients',matters:'matters',contacts:'contacts'}[cfg.dataset]||cfg.dataset;
    var dateLabel=p!=='all'?'_'+{today:'today',week:'this-week',month:'this-month',quarter:'this-quarter',year:String(t.getFullYear())}[p]:'';
    var fname=(prefix||'export')+'_'+dsLabel+dateLabel+'_'+stamp+'.csv';

    A._dlData(result.csv, fname, 'text/csv');
    toast(result.rowCount+' rows → '+fname, 'ok');
  },

  // ── Quick-export preset mutators (save to prefs immediately) ──
  _csvQSave:function(){ savePrefs(); render(); },

  csvQPref:function(k,v){
    syncForm();
    ST.prefs.csvQuick[k]=v;
    A._csvQSave();
  },

  csvQTogCol:function(k){ syncForm(); ST.prefs.csvQuick.cols[k]=!ST.prefs.csvQuick.cols[k]; A._csvQSave(); },
  csvQAllCols:function(v){ syncForm(); var c=ST.prefs.csvQuick.cols; Object.keys(c).forEach(function(k){c[k]=v;}); A._csvQSave(); },

  csvQTogClCol:function(k){ syncForm(); ST.prefs.csvQuick.clCols[k]=!ST.prefs.csvQuick.clCols[k]; A._csvQSave(); },
  csvQAllClCols:function(v){ syncForm(); var c=ST.prefs.csvQuick.clCols; Object.keys(c).forEach(function(k){c[k]=v;}); A._csvQSave(); },

  csvQTogMaCol:function(k){ syncForm(); ST.prefs.csvQuick.maCols[k]=!ST.prefs.csvQuick.maCols[k]; A._csvQSave(); },
  csvQAllMaCols:function(v){ syncForm(); var c=ST.prefs.csvQuick.maCols; Object.keys(c).forEach(function(k){c[k]=v;}); A._csvQSave(); },

  csvQTogCtCol:function(k){ syncForm(); ST.prefs.csvQuick.ctCols[k]=!ST.prefs.csvQuick.ctCols[k]; A._csvQSave(); },
  csvQAllCtCols:function(v){ syncForm(); var c=ST.prefs.csvQuick.ctCols; Object.keys(c).forEach(function(k){c[k]=v;}); A._csvQSave(); },
  downloadApp:function(){
    var html='<!DOCTYPE html>\n'+document.documentElement.outerHTML;
    var blob=new Blob([html],{type:'text/html;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download=(ST.prefs.appName||'SixMinuteLog').replace(/[^a-zA-Z0-9_\-]/g,'_')+'.html';
    document.body.appendChild(a);a.click();
    document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},2000);
    toast('App downloaded \u2014 open the file in any browser to use offline','ok');
  },

  // ─ Full JSON backup export ─
  exportJSON:function(){
    var backup={
      _version:1,
      _exported:new Date().toISOString(),
      user:ST.user,
      clients:ST.clients,
      matters:ST.matters,
      entries:ST.entries,
      contacts:ST.contacts,
      prefs:ST.prefs,
      settings:ST.settings,
      descPresets:ST.descPresets,
      mailPresets:ST.mailPresets
    };
    var json=JSON.stringify(backup,null,2);
    var now=new Date();
    var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate())+'_'+pad2(now.getHours())+pad2(now.getMinutes());
    var appSlug=(ST.prefs.appName||'backup').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    var fname=appSlug+'_'+stamp+'.json';
    A._dlData(json, fname, 'application/json');
    toast('Full backup downloaded: '+fname);
  },

  // ─ Full JSON backup import ─
  importJSON:function(inp){
    var file=inp.files[0]; if(!file) return;
    if(!confirm('Restore from backup? This will REPLACE all current data with the backup.\n\nExport a backup first if you want to keep your current data.')) { inp.value=''; return; }
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var b=JSON.parse(ev.target.result);
        if(!b||!b._version){ toast('Invalid backup file','err'); return; }
        if(b.clients)  ST.clients=b.clients;
        if(b.matters)  ST.matters=b.matters;
        if(b.entries)  ST.entries=b.entries;
        if(b.contacts) ST.contacts=b.contacts;
        if(b.user)     ST.user=b.user;
        if(b.prefs)    ST.prefs=Object.assign({appName:'SixMinuteLog.com',darkMode:null,layout:'comfortable',revenueSplit:false,analyticsEnabled:false},b.prefs);
        if(b.settings) ST.settings=Object.assign({},ST.settings,b.settings);
        if(b.descPresets) ST.descPresets=b.descPresets;
        if(b.mailPresets) ST.mailPresets=b.mailPresets;
        // After a full restore the in-memory cache is complete
        ST._entriesMode='full'; ST._totalEntryCount=ST.entries.length;
        markLuDirty();
        save(); Store.setMeta('user',ST.user);
        applyPrefs();
        toast('Backup restored: '+ST.clients.length+' clients, '+ST.matters.length+' matters, '+ST.entries.length+' entries');
        ST.modal=null; render();
      }catch(e){ toast('Failed to read backup file','err'); console.error(e); }
    };
    reader.readAsText(file); inp.value='';
  },

  // Download a freshly-generated CLAUDE_BILLING.md with current line numbers
  dlManifest: function(){
    // Scan own script source for // === SECTION markers and their line numbers
    var src = document.querySelector('script').textContent;
    var srcLines = src.split('\n');
    // The script tag starts at some line in the HTML file; find it
    var htmlSrc = document.documentElement.outerHTML;
    var htmlLines = htmlSrc.split('\n');
    var scriptStartLine = 0;
    for(var i=0;i<htmlLines.length;i++){
      if(htmlLines[i].indexOf('<script>')!==-1){scriptStartLine=i+1;break;}
    }
    // Build section map: name -> html line number
    var secMap = {};
    srcLines.forEach(function(line, i){
      var m = line.match(/^\/\/ === ([A-Z][A-Z &]+)$/);
      if(m) secMap[m[1]] = scriptStartLine + i;
    });

    // Descriptions for each section
    var descs = {
      'STORAGE':           'IndexedDB — named object stores per collection. Store.getAll (read), Store.putRecord/deleteRecord (single-record ops), Store.putBatch/syncCollection (bulk), Store.getMeta/setMeta (singletons), Store.clearData (reset)',
      'STATE':             'ST object - all app state',
      'HELPERS':           'uid,today,$m,$h,H,fmtPhone,fmtCur,autoRate,filterEnt,syncForm',
      'SAVE':              'save() debounced full-sync | saveOne(coll,rec) immediate upsert | delOne(coll,id) immediate delete | _flushSave() no-debounce flush',
      'TOAST':             'toast(msg,type)',
      'ICONS':             'IC object of SVG strings',
      'FIELD BUILDER':     'field(label,id,opts), stats(arr)',
      'VIEWS':             'vTimesheet,vClients,vMatters,vContacts,vAnalytics + form builders',
      'MODALS':            'buildUP,buildQL,buildHelp,buildSettings',
      'MORPH':             'morph(el,html) — incremental DOM patcher. Diffs old DOM vs new HTML string; updates only changed nodes. Preserves focused inputs/cursor. Used by render() instead of innerHTML=. Do NOT add focus-restore hacks.',
      'MAIN RENDER':       'TABS[], views{}, render() — calls morph() for incremental update',
      'ACTIONS':           'A object - all user actions',
      'CHANGE DELEGATION': 'document.addEventListener(\'change\',...)',
      'INIT':              'startup data loading, Promise.all'
    };

    var tableRows = Object.keys(descs).map(function(sec){
      var ln = secMap[sec] || '?';
      return '| `// === '+sec+'` | '+ln+' | '+descs[sec]+' |';
    }).join('\n');

    var now = new Date().toISOString().split('T')[0];
    var totalLines = htmlLines.length;

    var md = [
'# SixMinuteLog.com - Claude Architecture Guide',
'> **Claude: Read ONLY this file first. Then `view` specific line ranges in Billing_Tracker.html.**',
'> **Never read the full HTML. Use `str_replace` for all edits.**',
'> Auto-generated: '+now+' | HTML file: ~'+totalLines+' lines',
'',
'---',
'',
'## SECTION MAP (current line numbers in Billing_Tracker.html)',
'',
'| Search String | ~Line | Contents |',
'|---|---|---|',
tableRows,
'',
'---',
'',
'## STATE SHAPE',
'',
'```',
'ST.tab          // active tab: timesheet|clients|matters|contacts|analytics',
'ST.clients[]    // {id,name,email,phone,rate,contactId}',
'ST.matters[]    // {id,name,clientId,description,rate,contactId}',
'ST.entries[]    // {id,date,clientId,matterId,contactId,hours,rate,description,createdBy,createdByIni}',
'ST.contacts[]   // {id,name,role,email,phone,rate,ownPct}',
'ST.user         // {name,initials,ownPct} or null',
'ST.settings     // {te,cl,ma,co,su,split, tc_date/client/matter/team/desc/hours/rate/amount/by, expFrom,expTo,te_group}',
'ST.modal        // null | ef|cf|mf|ctf|ql|up|help|settings | YOUR_KEY',
'ST.editId       // id of record being edited (null = new)',
'ST.ef/cf/mf/ctf/ql  // form state objects, each with .errs{}',
'```',
'',
'---',
'',
'## KEY FUNCTIONS',
'',
'```',
'uid()                              unique numeric ID for new records',
'today()                            YYYY-MM-DD string',
'$m(n) $h(n) $d(s)                 $X.XX  X.XXh  Jan 1, 2025',
'H(str)                             HTML-escape - ALWAYS use on user data in templates',
'g(id)                              get DOM element value by id',
'save()                             bulk debounced sync (imports, settings, approve-all)',
'saveOne(coll, rec)                 immediate single-record upsert — use for form saves',
'delOne(coll, id)                   immediate single-record delete — use for delete actions',
'toast(msg,type)                    type: ok|warn|err',
'syncForm()                         call before render() if user typed in fields',
'autoRate(clientId,matterId,ctId)   returns best available rate',
'fmtCur(val)                        strips non-numeric, 2 decimal max',
'```',
'',
'---',
'',
'## RECIPE: ADD A NEW TAB',
'',
'1. Add SVG to IC object (// === ICONS):',
'   myIcon: \'<svg width="17" height="17" ...>...</svg>\'',
'',
'2. Push to TABS array (// === MAIN RENDER):',
'   {id:\'mytab\', lbl:\'My Tab\', ic:IC.myIcon}',
'',
'3. Add view function before // === MODALS:',
'   function vMyTab(){ return \'<div>...</div>\'; }',
'',
'4. Register in views{} inside render():',
'   var views={..., analytics:vAnalytics, mytab:vMyTab};',
'',
'---',
'',
'## RECIPE: ADD A NEW MODAL',
'',
'1. Add builder (// === MODALS):',
'   function buildMyModal(){',
'     return \'<div class="ov"><div class="modal modal-sm">\'',
'       +\'<div class="modal-hd"><h2>Title</h2>\'',
'       +\'<button class="btn-ic" onclick="A.closeM()">\'+IC.x+\'</button></div>\'',
'       +\'<div class="modal-bd">...field() calls...</div>\'',
'       +\'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button></div>\'',
'       +\'</div></div>\';',
'   }',
'',
'2. Add to overlays in render() after "else if(ST.modal===\'settings\')":',
'   else if(ST.modal===\'mymodal\') overlays=buildMyModal();',
'',
'3. Add open action to A:',
'   openMyModal: function(){ ST.modal=\'mymodal\'; render(); },',
'',
'---',
'',
'## RECIPE: ADD PERSISTED DATA',
'',
'FOR A COLLECTION (array of objects each with .id):',
'1. Add to ST: myData: []',
'2. Add to _flushSave(): if(_dirty.mydata||_dirty._all) ops.push(Store.syncCollection(\'mydata\', ST.mydata));',
'3. In actions: use saveOne(\'mydata\',rec) for single upserts, delOne(\'mydata\',id) for deletes.',
'   Use save() only for bulk/import operations (triggers full syncCollection).',
'4. Add to INIT Promise.all: Store.getAll(\'mydata\')',
'5. Load in .then(res): try{if(res[N]&&res[N].length)ST.myData=res[N];}catch(e){}',
'   (N = index; current: 0=user(meta), 1=clients, 2=matters, 3=entries, 4=contacts)',
'   Also add \'mydata\' to Store COLLECTIONS list and Store.clearData() call.',
'',
'FOR A SINGLETON (a single object/value):',
'1. Add to _flushSave(): ops.push(Store.setMeta(\'mykey\', ST.myVal));',
'2. Add to INIT Promise.all: Store.getMeta(\'mykey\')',
'3. Load in .then(res): try{if(res[N])ST.myVal=res[N];}catch(e){}',
'',
'---',
'',
'## FIELD BUILDER',
'',
'```',
'field(label, id, { type, val, ph, req, err, hint, pfx, sfx, opts:[{v,l}], dis, oninput })',
'stats([[\'Label\',\'Value\',\'\'],[\'Label\',\'Value\',\'highlight\'],[\'Label\',\'Value\',\'highlight2\']])',
'// \'\' = white  \'highlight\' = green  \'highlight2\' = amber',
'```',
'',
'---',
'',
'## CSS CLASSES',
'',
'```',
'Layout:   .fbox .frow.c2 .frow.c3 .fl .fa .cgrid .card .card-hd .twrap .tscroll',
'Buttons:  .btn .btn-dk .btn-gr .btn-rd .btn-gh .btn-bl .btn-ic',
'Modals:   .ov .modal .modal-sm(480) .modal-md(580) .modal-lg(760) .modal-hd .modal-bd .modal-ft',
'Stats:    .srow .sc .sc-lbl .sc-val',
'Misc:     .chip .badge .split-pill .empty .note(amber) .good(green) .danger(red)',
'```',
'',
'---',
'',
'## COMMON PATTERNS',
'',
'Delete:',
'  if(!confirm(\'Delete?\')) return;',
'  ST.arr = ST.arr.filter(function(x){ return x.id!=id; });',
'  delOne(\'coll\', id); toast(\'Deleted\',\'warn\'); render();',
'',
'Edit (open form):',
'  ST.editId=id; ST.xf=Object.assign({},record,{errs:{}}); ST.modal=\'xf\'; render();',
'',
'Save form:',
'  Read: f.name=g(\'xf-n\'); f.rate=fmtCur(g(\'xf-r\')||\'\');',
'  Validate: set errs{}, if errors{ render(); return; }',
'  Build: rec = {id:ST.editId||uid(), ...fields}',
'  Upsert: ST.editId ? map-replace : concat-push',
'  saveOne(\'coll\', rec); A.closeF();   // immediate atomic write — no data-loss window',
'',
'Bulk save (imports, finalize, approve-all):',
'  // Mutate ST arrays, then call save() — triggers syncCollection on all dirty colls',
'  save(); toast(\'Done\'); render();',
'',
'Dropdown onChange (CHANGE DELEGATION):',
'  syncForm();  // ALWAYS first - preserves typed values',
'  ST.myForm.field = e.target.value;',
'  if(!ST.myForm.rate){ var r=autoRate(...); if(r) ST.myForm.rate=String(r); }',
'  render();',
'',
'---',
'',
'## GOTCHAS',
'',
'1. syncForm() FIRST in every onchange - or typed values are lost on re-render',
'2. H() on ALL user data in template strings',
'3. Only auto-fill rate when empty: if(!ST.ef.rate){ ... }',
'4. Phone: oninput="A.livePhone(\'id\')" - formats in-place, no re-render',
'5. IDs: always uid() for new records',
'6. No external deps - 100% offline, no CDN',
'7. Prefer saveOne/delOne over save() for single-record mutations (atomic, no clear, instant)',
'8. save() is for bulk ops only — still safe (uses syncCollection not clear+putAll)',
'9. render() uses morph() (incremental DOM patching). Focused inputs are NEVER destroyed.',
'   Do NOT implement focus-save/restore hacks — morph handles cursor position automatically.',
'   The old _dFocusSel pattern has been removed. dRender() is just a debounced render().',
'',
'---',
'',
'## USAGE',
'',
'Tell Claude:',
'  "Read CLAUDE_BILLING.md first. Then add [feature] to Billing_Tracker.html."',
'',
'Claude reads this (~3k tokens) instead of the full HTML (~25k tokens).',
'',
'To regenerate this file: open Billing_Tracker.html → Settings (gear) → Download Claude Guide.',
'Line numbers update automatically based on the current file state.',
'',
'---',
'SixMinuteLog.com | Line numbers auto-generated on '+now
    ].join('\n');

    A._dlData(md, 'CLAUDE_BILLING.md', 'text/markdown');
    toast('Claude guide downloaded with live line numbers!');
  },

  // === IT MODE ACTIONS ===
  togITMode: function(on){
    ST.itMode=on;
    if(!ST.firmProfile) ST.firmProfile={firmName:'',appName:ST.prefs.appName||'SixMinuteLog.com',clients:[],matters:[],contacts:[],descPresets:[],users:[],settings:{}};
    save(); render();
  },
  togITInclude: function(key,val){
    if(!ST.firmProfile) ST.firmProfile={};
    ST.firmProfile[key]=val;
    save(); render();
  },
  openITUser: function(idx){
    if(idx!=null){
      var u=ST.firmProfile.users[idx];
      ST.itf=Object.assign({},u,{editIdx:idx});
    } else {
      ST.itf={name:'',initials:'',role:'attorney',rate:'',ownPct:100};
    }
    ST.modal='ituser'; render();
  },
  editITUser: function(idx){ A.openITUser(idx); },
  delITUser: function(idx){
    if(!confirm('Remove this user from the profile?')) return;
    ST.firmProfile.users.splice(idx,1);
    save(); toast('User removed','warn'); render();
  },
  saveITUser: function(){
    var f=ST.itf||{};
    var name=g('itu-name').trim();
    if(!name){ toast('Name is required','err'); return; }
    var ini=g('itu-ini').trim()||name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,4);
    var role=g('itu-role')||'attorney';
    var rate=fmtCur(g('itu-rate')||'');
    var pct=Number(g('itu-pct')||100);
    var usr={name:name,initials:ini,role:role,rate:rate,ownPct:pct};
    if(!ST.firmProfile) ST.firmProfile={users:[]};
    if(!ST.firmProfile.users) ST.firmProfile.users=[];
    if(f.editIdx!=null){
      ST.firmProfile.users[f.editIdx]=usr;
    } else {
      ST.firmProfile.users.push(usr);
    }
    ST.itf={}; ST.modal='settings'; ST.settingsTab='export';
    save(); toast((f.editIdx!=null?'User updated':'User added')); render();
  },
  closeITUser: function(){
    ST.itf={}; ST.modal='settings'; ST.settingsTab='export'; render();
  },
  exportFirmProfile: function(){
    var fp=ST.firmProfile||{};
    var profile={
      _type:'billing-ledger-firm-profile',
      _version:1,
      firmName:fp.firmName||'',
      appName:fp.appName||ST.prefs.appName||'SixMinuteLog.com',
      users:fp.users||[],
      clients:fp.includeClients?ST.clients:[],
      matters:fp.includeMatters?ST.matters:[],
      contacts:fp.includeContacts?ST.contacts:[],
      descPresets:fp.includePresets?ST.descPresets:[],
      exportedAt:new Date().toISOString()
    };
    var fn=(fp.firmName?fp.firmName.replace(/[^a-z0-9]/gi,'_').toLowerCase():'firm')+'_profile_'+today()+'.json';
    A._dlData(JSON.stringify(profile,null,2),fn,'application/json');
    toast('Firm profile exported: '+fn);
  },
  importFirmProfile: function(inp){
    var file=inp.files[0]; if(!file) return;
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var p=JSON.parse(ev.target.result);
        if(!p||p._type!=='billing-ledger-firm-profile'){ toast('Not a valid firm profile file','err'); inp.value=''; return; }
        ST._importedProfile=p;
        // Apply branding immediately
        if(p.appName){ ST.prefs.appName=p.appName; savePrefs(); }
        // If profile has pre-configured users, let user pick one
        if(p.users&&p.users.length>0){
          ST.modal='userSelect';
        } else {
          // Apply data and go to user setup
          A._applyProfileData(p);
          ST._splashMode=true; ST.modal='up';
        }
        inp.value=''; render();
      } catch(e){ toast('Could not read profile file','err'); inp.value=''; }
    };
    reader.readAsText(file);
  },
  _applyProfileData: function(p){
    if(!p) return;
    if(p.clients&&p.clients.length) ST.clients=p.clients;
    if(p.matters&&p.matters.length) ST.matters=p.matters;
    if(p.contacts&&p.contacts.length) ST.contacts=p.contacts;
    if(p.descPresets&&p.descPresets.length) ST.descPresets=p.descPresets;
    save();
    toast('Firm profile applied: '+(p.firmName||p.appName||'Profile'));
  },
  pickITUser: function(idx){
    var p=ST._importedProfile;
    if(!p||!p.users) return;
    var u=p.users[idx];
    // Pre-fill user profile from selected profile user
    ST.user={name:u.name,initials:u.initials||(u.name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,4)),role:u.role||'attorney',rate:u.rate||'',ownPct:u.ownPct!=null?u.ownPct:100};
    Store.setMeta('user',ST.user);
    A._applyProfileData(p);
    ST._importedProfile=null;
    ST._splashMode=false;
    ST.modal=null; render();
    toast('Welcome, '+u.name+' \ud83c\udf89');
  },
  skipProfileImport: function(){
    if(ST._importedProfile){ A._applyProfileData(ST._importedProfile); ST._importedProfile=null; }
    ST._splashMode=true; ST.modal='up'; render();
  },

  // ======== INVOICE ACTIONS ========
  invSetFilter:function(v){ ST.invFilter=v; render(); },

  invNew:function(){
    ST.editId=null;
    // Auto-number: next invoice number
    var nums=(ST.invoices||[]).map(function(i){return parseInt(i.number)||0;}).filter(Boolean);
    var nextNum=nums.length>0?Math.max.apply(null,nums)+1:1001;
    ST.invf={number:String(nextNum),invoiceDate:today(),dueDate:'',status:'draft',clientId:'',matterId:'',
      firmName:ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'',
      firmAddress:'',firmPhone:'',firmEmail:'',
      paymentTerms:'Net 30',taxPct:'',notes:'',footerNote:'',
      entryIds:[],errs:{}};
    ST.modal='invForm'; render();
  },

  invEdit:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv) return;
    ST.editId=id;
    ST.invf=Object.assign({},inv,{errs:{}});
    ST.modal='invForm'; render();
  },

  invTogEnt:function(eid){
    var f=ST.invf;
    var ids=f.entryIds||[];
    var idx=ids.indexOf(eid);
    if(idx===-1){ f.entryIds=ids.concat([eid]); }
    else { f.entryIds=ids.filter(function(id){return id!==eid;}); }
    render();
  },

  invSave:function(){
    // Sync all fields
    var f=ST.invf;
    f.number=(document.getElementById('inv-num')||{}).value||f.number||'';
    f.invoiceDate=(document.getElementById('inv-date')||{}).value||f.invoiceDate;
    f.dueDate=(document.getElementById('inv-due')||{}).value||'';
    f.status=(document.getElementById('inv-status')||{}).value||'draft';
    f.firmName=(document.getElementById('inv-firm')||{}).value||'';
    f.firmAddress=(document.getElementById('inv-faddr')||{}).value||'';
    f.firmPhone=(document.getElementById('inv-fphone')||{}).value||'';
    f.firmEmail=(document.getElementById('inv-femail')||{}).value||'';
    f.paymentTerms=(document.getElementById('inv-terms')||{}).value||'Net 30';
    f.taxPct=(document.getElementById('inv-tax')||{}).value||'';
    f.notes=(document.getElementById('inv-notes')||{}).value||'';
    f.footerNote=(document.getElementById('inv-footer')||{}).value||'';

    // Sync clientId/matterId from selects
    var clSel=document.getElementById('inv-cl');
    if(clSel) f.clientId=clSel.value;
    var mtSel=document.getElementById('inv-mt');
    if(mtSel) f.matterId=mtSel.value;

    f.errs={};
    if(!f.clientId){ f.errs.clientId='Client is required'; toast('Client is required','err'); render(); return; }

    var now=Date.now();
    var inv=ST.editId
      ?Object.assign({},ST.invoices.find(function(i){return i.id==ST.editId;})||{},f,{id:ST.editId,updatedAt:now})
      :Object.assign({},f,{id:uid(),createdAt:now,updatedAt:now,cuts:{},mergedEntries:[],comments:[]});

    if(ST.editId){
      ST.invoices=ST.invoices.map(function(i){return i.id==ST.editId?inv:i;});
    } else {
      if(!ST.invoices) ST.invoices=[];
      ST.invoices.push(inv);
    }
    saveOne('invoices',inv);
    toast(ST.editId?'Invoice updated':'Invoice created');
    A.closeF();
  },

  invDel:function(id){
    if(!confirm('Delete this invoice?')) return;
    ST.invoices=ST.invoices.filter(function(i){return i.id!=id;});
    delOne('invoices',id); toast('Invoice deleted','warn'); render();
  },

  invPrint:function(id){
    ST.invPrintId=id; ST.modal='invPrint'; render();
  },

  invDoPrint:function(){
    var wrap=document.getElementById('inv-print-wrap');
    if(!wrap){ window.print(); return; }
    var html=wrap.innerHTML;
    var w=window.open('','_blank');
    if(!w){ window.print(); return; }
    w.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Invoice</title>'
      +'<style>body{margin:0;padding:0;font-family:Georgia,serif;color:#222;background:#fff}'
      +'table{width:100%;border-collapse:collapse}'
      +'@page{margin:0.5in}'
      +'@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'
      +'</style></head><body>'+html+'</body></html>');
    w.document.close();
    w.focus();
    setTimeout(function(){ w.print(); },300);
  },

  invOpenReview:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv) return;
    // Initialize review state from saved cuts
    ST.invRev={
      invoiceId:id,
      cuts:Object.assign({},inv.cuts||{}),
      comments:{},
      pendingMerge:[],
      invoiceComment:''
    };
    ST.modal='invReview'; render();
  },

  invRevCut:function(eid,val){
    var rev=ST.invRev;
    var e=ST.entries.find(function(x){return x.id==eid;});
    if(!e) return;
    var h=Math.max(0,Math.min(Number(val)||0,Number(e.hours)));
    rev.cuts[eid]=h;
    // Update the input directly for smooth UX, then re-render totals
    render();
  },

  invRevComment:function(eid,val){
    ST.invRev.comments[eid]=val;
  },

  invRevTogMerge:function(eid){
    var arr=ST.invRev.pendingMerge||[];
    var idx=arr.indexOf(eid);
    if(idx===-1){ ST.invRev.pendingMerge=arr.concat([eid]); }
    else { ST.invRev.pendingMerge=arr.filter(function(id){return id!==eid;}); }
    render();
  },

  invRevCommitMerge:function(){
    var rev=ST.invRev;
    var ids=rev.pendingMerge||[];
    if(ids.length<2){ toast('Select 2+ entries to merge','warn'); return; }
    var descEl=document.getElementById('merge-desc');
    var desc=descEl?descEl.value.trim():'';
    if(!desc){ toast('Enter a description for the merged entry','warn'); return; }
    // Compute merged hours/rate (sum hours, use rate of first entry)
    var totalH=0,rate=0;
    ids.forEach(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;});
      if(!e) return;
      var h=rev.cuts[eid]!=null?Number(rev.cuts[eid]):Number(e.hours);
      totalH+=h;
      if(!rate) rate=Number(e.rate||0);
    });
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    var mg={id:uid(),description:desc,hours:totalH.toFixed(2),rate:rate,entryIds:ids.slice()};
    var newMerged=(inv.mergedEntries||[]).concat([mg]);
    var mergedInv;
    ST.invoices=ST.invoices.map(function(i){if(i.id==rev.invoiceId){mergedInv=Object.assign({},i,{mergedEntries:newMerged});return mergedInv;}return i;});
    if(mergedInv) saveOne('invoices',mergedInv);
    rev.pendingMerge=[];
    toast('Entries merged'); render();
  },

  invRevClearMerge:function(){
    ST.invRev.pendingMerge=[];
    render();
  },

  invRevUnmerge:function(mi){
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return;
    var newMerged=(inv.mergedEntries||[]).filter(function(_,idx){return idx!==mi;});
    var unmergedInv;
    ST.invoices=ST.invoices.map(function(i){if(i.id==rev.invoiceId){unmergedInv=Object.assign({},i,{mergedEntries:newMerged});return unmergedInv;}return i;});
    if(unmergedInv) saveOne('invoices',unmergedInv);
    toast('Unmerged','warn'); render();
  },

  invRevMergeDesc:function(mi,val){
    var inv=ST.invoices.find(function(i){return i.id==ST.invRev.invoiceId;});
    if(!inv||!inv.mergedEntries[mi]) return;
    inv.mergedEntries[mi].description=val;
    saveOne('invoices',inv);
  },

  invRevMergeHours:function(mi,val){
    var inv=ST.invoices.find(function(i){return i.id==ST.invRev.invoiceId;});
    if(!inv||!inv.mergedEntries[mi]) return;
    inv.mergedEntries[mi].hours=String(Math.max(0,Number(val)||0));
    saveOne('invoices',inv); render();
  },

  invRevAddComment:function(){
    var inp=document.getElementById('inv-comment-inp');
    var text=inp?inp.value.trim():'';
    if(!text){ toast('Enter a comment first','warn'); return; }
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return;
    var cmt={id:uid(),by:ST.user?ST.user.name:'Unknown',at:today(),text:text};
    var newComments=(inv.comments||[]).concat([cmt]);
    var commentedInv;
    ST.invoices=ST.invoices.map(function(i){if(i.id==rev.invoiceId){commentedInv=Object.assign({},i,{comments:newComments});return commentedInv;}return i;});
    if(commentedInv) saveOne('invoices',commentedInv);
    toast('Comment added'); render();
  },

  invRevSave:function(andClose){
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return false;
    // Apply entry-level comments as invoice comments if any
    var entryComments=Object.keys(rev.comments||{}).filter(function(eid){
      return (rev.comments[eid]||'').trim();
    }).map(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;});
      return {id:uid(),by:ST.user?ST.user.name:'Reviewer',at:today(),entryId:Number(eid),
        text:'['+$d(e?e.date:'')+'] '+rev.comments[eid],entryRef:true};
    });
    var newComments=(inv.comments||[]).concat(entryComments);
    var savedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==rev.invoiceId){savedInv=Object.assign({},i,{cuts:rev.cuts,comments:newComments,updatedAt:Date.now()});return savedInv;}
      return i;
    });
    if(savedInv) saveOne('invoices',savedInv);
    if(andClose!==false){ toast('Review saved'); A.closeM(); }
    return true;
  },

  invRevApprove:function(){
    // Save cuts/comments without closing, then approve in same pass
    var saved=A.invRevSave(false);
    if(!saved) return;SixMinuteLog.com
    var id=ST.invRev.invoiceId;
    var approvedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){approvedInv=Object.assign({},i,{status:'approved',approvedBy:ST.user?ST.user.name:'',approvedAt:Date.now()});return approvedInv;}
      return i;
    });
    if(approvedInv) saveOne('invoices',approvedInv);
    toast('Invoice approved!','ok');
    ST.modal=null;
    render();
  },

  invRevReject:function(){
    var reason=prompt('Reason for rejection (optional):');
    if(reason===null) return;
    var id=ST.invRev.invoiceId;
    var cmt={id:uid(),by:ST.user?ST.user.name:'Reviewer',at:today(),
      text:'REJECTED'+(reason?' — '+reason:''),type:'rejection'};
    var updatedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){updatedInv=Object.assign({},i,{status:'draft',comments:(i.comments||[]).concat([cmt])});return updatedInv;}
      return i;
    });
    if(updatedInv) saveOne('invoices',updatedInv);
    toast('Invoice returned to draft','warn'); A.closeM();
  },

  invSendForReview:function(id){
    var updatedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){updatedInv=Object.assign({},i,{status:'review',updatedAt:Date.now()});return updatedInv;}
      return i;
    });
    if(updatedInv) saveOne('invoices',updatedInv);
    toast('Invoice sent for partner review','ok'); render();
  },

  invMarkSent:function(id){
    var updatedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){updatedInv=Object.assign({},i,{status:'sent',sentAt:Date.now()});return updatedInv;}
      return i;
    });
    if(updatedInv) saveOne('invoices',updatedInv);
    toast('Invoice marked as sent','ok'); render();
  },

};

function buildEntRow(e,s){
  var cl=ST.clients.find(function(c){return c.id==e.clientId;});
  var mt=ST.matters.find(function(m){return m.id==e.matterId;});
  var ct=ST.contacts.find(function(c){return c.id==e.contactId;});
  var amt=(Number(e.hours)*Number(e.rate)).toFixed(2);
  var vals=[];
  if(s.tc_date)   vals.push(e.date);
  if(s.tc_client) vals.push(cl?cl.name:'');
  if(s.tc_matter) vals.push(mt?mt.name:'General');
  if(s.tc_team)   vals.push(ct?ct.name:'');
  if(s.tc_desc)   vals.push(e.description||'');
  if(s.tc_hours)  vals.push(e.hours);
  if(s.tc_rate)   vals.push(e.rate);
  if(s.tc_amount) vals.push(amt);
  if(s.tc_by)     vals.push(e.createdBy||'');
  return vals;
}

// Timer stop helper
function stopTmr(){
  if(ST.tmrOn){ST.tmrMs+=Date.now()-ST.tmrStart;ST.tmrOn=false;}
  clearInterval(ST.tmrIv);
}

// Value getter
function g(id){var el=document.getElementById(id);return el?el.value:'';}

// ======================================================================
// === WORKFLOW TRANSFER PACKAGES
// ======================================================================
// Transfer packages are versioned JSON files with a _type field indicating
// the workflow step. They carry resolved names (not just IDs) for portability
// across instances, and use smart merge on import (never wipe-replaces).
//
// Package types:
//   'attorney_submission'  Attorney → Billing Staff
//   'billing_review'       Billing Staff → Partner
//   'partner_approval'     Partner → Billing Staff (approved/rejected)
//
// Smart merge rules (importWorkflowPackage):
//   - Clients/matters/contacts: match by name (case-insensitive), add if new
//   - Entries: match by original ID (pkg._entryOrigIds), update status/fields
//     if changed, add if not present. Never delete existing entries.
// ======================================================================

// Build a resolved-names snapshot of entries (for portability across instances)
function _resolveEntries(entries){
  return entries.map(function(e){
    var cl=_lu.cl[e.clientId]||{};
    var mt=_lu.ma[e.matterId]||{};
    var ct=_lu.ct[e.contactId]||{};
    var ma=mt||{};
    return Object.assign({},e,{
      _clientName:cl.name||'',
      _matterName:ma.name||'',
      _matterNumber:ma.matterNumber||'',
      _contactName:ct.name||''
    });
  });
}

// Export a workflow transfer package
// type: 'attorney_submission' | 'billing_review' | 'partner_approval'
// entries: array of entry objects to include (filtered subset)
function _exportWorkflowPackage(type, entries, opts){
  opts=opts||{};
  buildLookups();
  var resolved=_resolveEntries(entries);
  var now=new Date();
  var pad2=function(n){return n<10?'0'+n:String(n);};
  var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate())+'_'+pad2(now.getHours())+pad2(now.getMinutes());

  // Include only the clients/matters referenced by these entries
  var usedClientIds={};var usedMatterIds={};
  entries.forEach(function(e){
    if(e.clientId) usedClientIds[e.clientId]=true;
    if(e.matterId) usedMatterIds[e.matterId]=true;
  });
  var pkgClients=ST.clients.filter(function(c){return usedClientIds[c.id];});
  var pkgMatters=ST.matters.filter(function(m){return usedMatterIds[m.id];});
  var pkgContacts=[];
  var usedCtIds={};
  entries.forEach(function(e){if(e.contactId) usedCtIds[e.contactId]=true;});
  pkgContacts=ST.contacts.filter(function(c){return usedCtIds[c.id];});

  var typeLabels={
    attorney_submission:'Attorney Timesheet Submission',
    billing_review:'Billing Review Package',
    partner_approval:'Partner Approval Package'
  };
  var pkg={
    _type:type,
    _version:2,
    _label:typeLabels[type]||type,
    _exportedAt:now.toISOString(),
    _fromUser:ST.user?ST.user.name:'Unknown',
    _fromRole:ST.user?ST.user.role:'',
    _fromInitials:ST.user?ST.user.initials:'?',
    _firmName:(ST.firmProfile&&ST.firmProfile.firmName)||ST.prefs.firmName||'',
    _entryCount:entries.length,
    _dateFrom:opts.dateFrom||'',
    _dateTo:opts.dateTo||'',
    _note:opts.note||'',
    clients:pkgClients,
    matters:pkgMatters,
    contacts:pkgContacts,
    entries:resolved
  };
  var json=JSON.stringify(pkg,null,2);
  // === Context-aware filenames ===
  // Attorney → Billing:  INI_YYYY-MM-DD_HHMM.json
  // Billing → Partner:   TS_YYYY-MM_PartnerLastName.json
  // Partner → Billing:   TS_YYYY-MM_appr-PARTNERINIT.json
  var fname;
  if(type==='attorney_submission'){
    var ini=(ST.user&&ST.user.initials?ST.user.initials:'ATY').replace(/[^A-Za-z0-9]/g,'').toUpperCase();
    fname=ini+'_'+stamp+'.json';
  } else if(type==='billing_review'){
    // Derive month from entries (majority month) or today
    var entryMonth='';
    if(entries.length){
      var months={};
      entries.forEach(function(e){var m=(e.date||'').substring(0,7);if(m)months[m]=(months[m]||0)+1;});
      var best='',bestN=0;
      Object.keys(months).forEach(function(m){if(months[m]>bestN){bestN=months[m];best=m;}});
      entryMonth=best;
    }
    if(!entryMonth) entryMonth=now.getFullYear()+'-'+pad2(now.getMonth()+1);
    // Find first partner contact among entries' clients
    var partnerLastName='';
    var seenCl={};
    for(var pi=0;pi<entries.length;pi++){
      var ecl=entries[pi].clientId;
      if(ecl&&!seenCl[ecl]){
        seenCl[ecl]=true;
        var clObj=ST.clients.find(function(c){return c.id==ecl;});
        if(clObj&&clObj.contactIds&&clObj.contactIds.length){
          for(var ci=0;ci<clObj.contactIds.length;ci++){
            var pct=ST.contacts.find(function(c){return c.id==clObj.contactIds[ci];});
            if(pct&&pct.role&&(pct.role.toLowerCase().indexOf('partner')!==-1||pct.role.toLowerCase().indexOf('supervising')!==-1)){
              var np=pct.name.trim().split(/\s+/);
              partnerLastName=np[np.length-1].replace(/[^A-Za-z0-9]/g,'');
              break;
            }
          }
        }
        if(partnerLastName) break;
      }
    }
    var partnerSuffix=partnerLastName||'Partner';
    fname='TS_'+entryMonth+'_'+partnerSuffix+'.json';
  } else if(type==='partner_approval'){
    var apprMonth='';
    if(entries.length){
      var amonths={};
      entries.forEach(function(e){var m=(e.date||'').substring(0,7);if(m)amonths[m]=(amonths[m]||0)+1;});
      var abest='',abestN=0;
      Object.keys(amonths).forEach(function(m){if(amonths[m]>abestN){abestN=amonths[m];abest=m;}});
      apprMonth=abest;
    }
    if(!apprMonth) apprMonth=now.getFullYear()+'-'+pad2(now.getMonth()+1);
    var apprIni=(ST.user&&ST.user.initials?ST.user.initials:'PTR').replace(/[^A-Za-z0-9]/g,'').toUpperCase();
    fname='TS_'+apprMonth+'_appr-'+apprIni+'.json';
  } else {
    var shortType={attorney_submission:'atty',billing_review:'bill',partner_approval:'appr'}[type]||type;
    fname='workflow-'+shortType+'_'+stamp+'.json';
  }
  A._dlData(json, fname, 'application/json');
  return fname;
}

// Smart merge import — merges package data with existing local data
// Returns a summary string for the toast
function _importWorkflowPackage(pkg){
  var added={clients:0,matters:0,contacts:0,entries:0,updated:0};

  // === Merge Clients (by name, case-insensitive) ===
  (pkg.clients||[]).forEach(function(pc){
    var existing=ST.clients.find(function(c){return c.name.toLowerCase()===pc.name.toLowerCase();});
    if(!existing){
      var nc=Object.assign({},pc,{id:uid()});
      ST.clients=ST.clients.concat([nc]);
      saveOne('clients',nc);
      added.clients++;
    }
  });

  // === Merge Matters (by name + client name) ===
  (pkg.matters||[]).forEach(function(pm){
    var cl=ST.clients.find(function(c){return c.name.toLowerCase()===((pm._clientName||pm.clientName||'').toLowerCase());});
    var existing=ST.matters.find(function(m){
      return m.name.toLowerCase()===pm.name.toLowerCase()&&(!cl||m.clientId===(cl?cl.id:m.clientId));
    });
    if(!existing){
      var nm=Object.assign({},pm,{id:uid(),clientId:cl?cl.id:'',matterNumber:pm.matterNumber||pm._matterNumber||''});
      delete nm._clientName;
      ST.matters=ST.matters.concat([nm]);
      saveOne('matters',nm);
      added.matters++;
    } else if(pm.matterNumber&&!existing.matterNumber){
      // Backfill matter number if we learned it from this package
      var updated=Object.assign({},existing,{matterNumber:pm.matterNumber||pm._matterNumber||''});
      ST.matters=ST.matters.map(function(m){return m.id===existing.id?updated:m;});
      saveOne('matters',updated);
    }
  });

  // === Merge Contacts (by name) ===
  (pkg.contacts||[]).forEach(function(pc){
    var existing=ST.contacts.find(function(c){return c.name.toLowerCase()===pc.name.toLowerCase();});
    if(!existing){
      var nc=Object.assign({},pc,{id:uid()});
      ST.contacts=ST.contacts.concat([nc]);
      saveOne('contacts',nc);
      added.contacts++;
    }
  });

  // Rebuild lookups so ID resolution works for entries
  markLuDirty(); buildLookups();

  // === Merge Entries (by original exported ID, then by date+client+desc as fallback) ===
  (pkg.entries||[]).forEach(function(pe){
    // Resolve names → IDs using the now-merged local data
    var cl=ST.clients.find(function(c){return c.name.toLowerCase()===(pe._clientName||'').toLowerCase();});
    var mt=ST.matters.find(function(m){
      return m.name.toLowerCase()===(pe._matterName||'').toLowerCase()&&(!cl||m.clientId===(cl?cl.id:m.clientId));
    });
    var ct=ST.contacts.find(function(c){return c.name.toLowerCase()===(pe._contactName||'').toLowerCase();});
    var clientId=cl?cl.id:(pe.clientId||'');
    var matterId=mt?mt.id:(pe.matterId||'');
    var contactId=ct?ct.id:(pe.contactId||'');

    // Check by original ID
    var existIdx=ST.entries.findIndex(function(e){return String(e.id)===String(pe.id);});
    if(existIdx>=0){
      // Merge: update status, hours, rate, description, abaCode, partnerComment
      var ex=ST.entries[existIdx];
      var mergedFields={
        status:pe.status||ex.status,
        abaCode:pe.abaCode||ex.abaCode||'',
        approvedBy:pe.approvedBy||ex.approvedBy||'',
        approvedAt:pe.approvedAt||ex.approvedAt||'',
        partnerComment:pe.partnerComment||ex.partnerComment||'',
        partnerEdited:pe.partnerEdited||ex.partnerEdited||false,
        showCommentOnInvoice:pe.showCommentOnInvoice||ex.showCommentOnInvoice||false
      };
      // If package is a partner approval, also update hours/rate/description if partner edited
      if(pkg._type==='partner_approval'&&pe.partnerEdited){
        mergedFields.hours=pe.hours;
        mergedFields.rate=pe.rate;
        mergedFields.description=pe.description;
        mergedFields.submittedHours=pe.submittedHours;
      }
      var merged=Object.assign({},ex,mergedFields,{clientId:clientId||ex.clientId,matterId:matterId||ex.matterId,contactId:contactId||ex.contactId});
      ST.entries[existIdx]=merged;
      saveOne('entries',merged);
      added.updated++;
    } else {
      // New entry — add it
      var ne=Object.assign({},pe,{
        id:uid(), // new local ID
        clientId:clientId,
        matterId:matterId,
        contactId:contactId
      });
      delete ne._clientName; delete ne._matterName; delete ne._matterNumber; delete ne._contactName;
      ST.entries=ST.entries.concat([ne]);
      saveOne('entries',ne);
      added.entries++;
    }
  });

  markLuDirty();
  ST._entriesMode='full'; ST._totalEntryCount=ST.entries.length;
  return 'Imported: '+added.clients+' new clients, '+added.matters+' matters, '+added.contacts+' contacts, '+added.entries+' new entries, '+added.updated+' entries updated';
}

// Build modal for previewing a workflow package before importing
function buildWorkflowImportPreview(){
  var pkg=ST._pendingWorkflowPkg;
  if(!pkg) return '';
  var typeColors={attorney_submission:'var(--blue)',billing_review:'var(--amber)',partner_approval:'var(--green)'};
  var typeIcons={attorney_submission:'⚖️',billing_review:'🧾',partner_approval:'✅'};
  var color=typeColors[pkg._type]||'var(--ink2)';
  var icon=typeIcons[pkg._type]||'📦';
  var entryList='';
  if(pkg.entries&&pkg.entries.length<=20){
    entryList='<div style="max-height:220px;overflow-y:auto;border:1px solid var(--brd);border-radius:8px;margin-top:10px">'
      +pkg.entries.map(function(e){
        var st=e.status||'pending';
        var stColor={approved:'var(--green)',pending:'var(--amber)',rejected:'var(--red)'}[st]||'var(--ink3)';
        return '<div style="padding:8px 12px;border-bottom:1px solid var(--brd);font-size:12px;display:flex;justify-content:space-between;align-items:center;gap:10px">'
          +'<div style="flex:1;min-width:0"><strong>'+H(e._clientName||'?')+'</strong>'+(e._matterName?' / '+H(e._matterName):'')
          +(e._matterNumber?' <span style="font-family:monospace;font-size:10px;color:var(--blue)">#'+H(e._matterNumber)+'</span>':'')
          +'<div style="color:var(--ink3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+H(e.description||'—')+(e.abaCode?' <span style="color:var(--blue);font-family:monospace;font-size:10px">'+H(e.abaCode)+'</span>':'')+'</div></div>'
          +'<div style="text-align:right;white-space:nowrap"><strong>'+Number(e.hours||0).toFixed(1)+'h</strong>'
          +'<div style="font-size:11px;color:'+stColor+'">'+H(st)+'</div>'
          +'</div></div>';
      }).join('')
      +'</div>';
  } else if(pkg.entries){
    entryList='<p style="font-size:12px;color:var(--ink3);margin-top:8px">'+pkg.entries.length+' entries (too many to preview individually)</p>';
  }
  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+icon+' Review Package &amp; Confirm Import</h2>'
    +'<button class="btn-ic" onclick="A.cancelWorkflowImport()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'
    +'<div style="border:2px solid '+color+';border-radius:10px;padding:14px 16px;margin-bottom:14px">'
    +'<div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:'+color+';font-weight:700;margin-bottom:4px">'+H(pkg._label||pkg._type)+'</div>'
    +'<div style="font-size:14px;font-weight:600">From: '+H(pkg._fromUser||'Unknown')+(pkg._fromRole?' <span style="font-size:11px;font-weight:400;color:var(--ink3)">('+H(pkg._fromRole)+')</span>':'')+'</div>'
    +(pkg._firmName?'<div style="font-size:12px;color:var(--ink2);margin-top:2px">'+H(pkg._firmName)+'</div>':'')
    +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Exported: '+H(new Date(pkg._exportedAt).toLocaleString())+'</div>'
    +(pkg._note?'<div style="margin-top:10px;padding:8px 12px;background:var(--bg2);border-radius:6px;font-size:12px;color:var(--ink2);line-height:1.6"><strong>Note from sender:</strong> '+H(pkg._note)+'</div>':'')
    +'</div>'
    +'<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px">'
    +[['Entries',(pkg.entries||[]).length],['Clients',(pkg.clients||[]).length],['Matters',(pkg.matters||[]).length],['Contacts',(pkg.contacts||[]).length]].map(function(x){
      return '<div style="background:var(--bg);border-radius:8px;padding:10px;text-align:center"><div style="font-size:1.4rem;font-weight:600;color:var(--blue)">'+x[1]+'</div><div style="font-size:11px;color:var(--ink3)">'+x[0]+'</div></div>';
    }).join('')
    +'</div>'
    +(pkg._type==='attorney_submission'?'<div class="note">⚖️ <strong>Attorney Submission:</strong> New entries will be added. Existing entries will have their ABA codes and matter numbers updated. No data will be deleted.</div>':'')
    +(pkg._type==='billing_review'?'<div class="note">🧾 <strong>Billing Review Package:</strong> Contains enriched entries with matter numbers and ABA codes added by billing staff. Existing entries will be updated.</div>':'')
    +(pkg._type==='partner_approval'?'<div class="good">✅ <strong>Partner Approval:</strong> Contains approved/rejected status and any partner edits. Your local entries will be updated with approval decisions.</div>':'')
    +entryList
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.cancelWorkflowImport()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.confirmWorkflowImport()">Import Package</button>'
    +'</div></div></div>';
}

// === CHANGE DELEGATION ===
// Sync form state BEFORE any dropdown-triggered re-render so typed values survive
// === CHANGE DELEGATION
document.addEventListener('change',function(e){
  var id=e.target.id;
  // Always sync current form state first
  syncForm();
  if(id==='ef-d'){
    // Re-evaluate rate when date changes (if rate is still empty or was auto-filled)
    ST.ef.date=e.target.value;
    if(!ST.ef.rate&&(ST.ef.clientId||ST.ef.contactId)){
      var _efDateD=ST.ef.date||today();
      var r=autoRate(ST.ef.clientId||'',ST.ef.matterId||'',ST.ef.contactId||'',_efDateD);
      if(r) ST.ef.rate=String(r);
      render();
    }
  }
  else if(id==='ef-cl'){
    ST.ef.clientId=e.target.value; ST.ef.matterId='';
    // Only auto-fill rate if the rate field is empty
    var _efDate1=ST.ef.date||today();
    if(!ST.ef.rate){var r=autoRate(e.target.value,'',ST.ef.contactId||'',_efDate1);if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='ef-ma'){
    ST.ef.matterId=e.target.value;
    var _efDate2=ST.ef.date||today();
    if(!ST.ef.rate){var r=autoRate(ST.ef.clientId||'',e.target.value,ST.ef.contactId||'',_efDate2);if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='ef-ct'){
    ST.ef.contactId=e.target.value;
    var _efDate3=ST.ef.date||today();
    if(!ST.ef.rate){var r=autoRate(ST.ef.clientId||'',ST.ef.matterId||'',e.target.value,_efDate3);if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='mf-cl'){
    ST.mf.clientId=e.target.value; ST.mf.linkedClientPeopleIds=[]; render();
  }
  else if(id==='cf-ct'){
    var val=e.target.value;
    if(!val) return;
    syncForm();
    var ids=ST.cf.contactIds||[];
    if(!ids.some(function(x){return x==Number(val);}))ST.cf.contactIds=ids.concat([Number(val)]);
    render();
  }
  // Invoice form: update matter dropdown when client changes
  else if(id==='inv-cl'){
    if(ST.invf) ST.invf.clientId=e.target.value;
    render();
  }
  else if(id==='inv-mt'){
    if(ST.invf) ST.invf.matterId=e.target.value;
    render();
  }
  // Partner review form: checkbox re-render for live highlight
  else if(id==='pref-inv'){
    A.syncPartnerReview();
    render();
  }
});

// Enter key in user prompt
document.addEventListener('keydown',function(e){
  if(e.key==='Enter'&&ST.modal==='up') A.saveUser();
});

// === INIT
(function(){
  // Fast startup: load only current-year entries (covers today/week/month/year filters).
  // "All Time" view and Analytics trigger Store.getAllEntries() on demand.
  var yearStart=new Date().getFullYear()+'-01-01';

  Promise.all([
    Store.getMeta('user'),
    Store.getAll('clients'),
    Store.getAll('matters'),
    Store.getEntriesInRange(yearStart, ''),   // partial load: this year only
    Store.getAll('contacts'),
    Store.getMeta('prefs'),
    Store.getMeta('descpresets'),
    Store.getMeta('mailpresets'),
    Store.getMeta('itmode'),
    Store.getAll('invoices'),
    Store.getMeta('mailplaceholders'),
    Store.countEntries()                       // cheap count — no data transfer
  ]).then(function(res){
    // res values are already parsed native JS objects — no JSON.parse needed
    try{if(res[0])ST.user=res[0];}catch(e){}
    try{if(res[1]&&res[1].length)ST.clients=res[1];}catch(e){}
    // Backfill IDs on existing clientPeople that predate this feature
    ST.clients=ST.clients.map(function(c){
      if(!c.clientPeople||!c.clientPeople.length) return c;
      var needsFix=c.clientPeople.some(function(p){return !p.id;});
      if(!needsFix) return c;
      return Object.assign({},c,{clientPeople:c.clientPeople.map(function(p){return p.id?p:Object.assign({id:uid()},p);})});
    });
    try{if(res[2]&&res[2].length)ST.matters=res[2];}catch(e){}
    // res[3] = partial entries (this year); res[11] = total count from IDB
    try{if(res[3]&&res[3].length)ST.entries=res[3];}catch(e){}
    try{ST._totalEntryCount=Number(res[11])||0;}catch(e){}
    // Mark partial if we didn't load everything
    ST._entriesMode=(ST._totalEntryCount>0&&ST.entries.length<ST._totalEntryCount)?'partial':'full';
    try{if(res[4]&&res[4].length)ST.contacts=res[4];}catch(e){}
    // Ensure the logged-in user appears in contacts
    if(ST.user&&ST.user.name){
      var hasUserCt=ST.contacts.some(function(c){return c.isUser;});
      if(!hasUserCt){
        var ini2=ST.user.initials||ST.user.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
        ST.contacts=ST.contacts.concat([{id:uid(),name:ST.user.name,role:ST.user.role||'',email:ST.user.email||'',phone:ST.user.phone||'',rate:ST.user.rate||'',ownPct:ST.user.ownPct!=null?ST.user.ownPct:100,isUser:true,createdBy:ST.user.name,createdByIni:ini2}]);
      }
    }
    try{if(res[5]){
      var _pDefaults={appName:'SixMinuteLog.com',darkMode:null,layout:'comfortable',revenueSplit:false,analyticsEnabled:false,csvQuick:{dataset:'entries',datePreset:'month',cols:{date:true,client:true,matter:true,contact:false,hours:true,rate:true,amount:true,desc:true,by:false,entryId:false,abaCode:false},clCols:{name:true,email:true,phone:true,rate:true,contact:false},maCols:{name:true,client:true,desc:true,rate:true,contact:false},ctCols:{name:true,role:true,email:true,phone:true,rate:false,ownPct:false},groupBy:'none',includeTotals:true,includeGrandTotal:true,dateFormat:'iso',currencySymbol:true,filenamePrefix:''}};
      ST.prefs=Object.assign({},_pDefaults,res[5]);
      // Deep-merge csvQuick so individual keys survive partial stored values
      if(res[5].csvQuick) ST.prefs.csvQuick=Object.assign({},_pDefaults.csvQuick,res[5].csvQuick,{cols:Object.assign({},_pDefaults.csvQuick.cols,(res[5].csvQuick||{}).cols),clCols:Object.assign({},_pDefaults.csvQuick.clCols,(res[5].csvQuick||{}).clCols),maCols:Object.assign({},_pDefaults.csvQuick.maCols,(res[5].csvQuick||{}).maCols),ctCols:Object.assign({},_pDefaults.csvQuick.ctCols,(res[5].csvQuick||{}).ctCols)});
    }}catch(e){}
    try{if(res[6])ST.descPresets=res[6];}catch(e){}
    try{if(res[7])ST.mailPresets=res[7];}catch(e){}
    try{if(res[8]){ST.itMode=!!res[8].itMode;if(res[8].firmProfile)ST.firmProfile=res[8].firmProfile;}}catch(e){}
    try{if(res[9]&&res[9].length)ST.invoices=res[9];}catch(e){}
    try{if(res[10]&&res[10].length)ST.mailPlaceholders=res[10];}catch(e){}
    markLuDirty();
    applyPrefs();
    if(!ST.user){
      // First run: show profile import prompt
      ST._splashMode=true; ST.modal='profileImport';
    }
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    render();
  }).catch(function(err){
    console.warn('Init error:',err);
    markLuDirty();
    applyPrefs();
    ST._splashMode=true; ST.modal='profileImport';
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    render();
  });
})();

window.A=A; window.fmtCur=fmtCur;
</script>
</body>
</html>
