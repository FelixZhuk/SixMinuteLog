<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20rx%3D%226%22%20fill%3D%22%231d4ed8%22%2F%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%2211%22%20fill%3D%22%23ffffff%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%221%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%227.5%22%20x2%3D%2216%22%20y2%3D%225.5%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%222.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2224.5%22%20y1%3D%2216%22%20x2%3D%2226.5%22%20y2%3D%2216%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2224.5%22%20x2%3D%2216%22%20y2%3D%2226.5%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%227.5%22%20y1%3D%2216%22%20x2%3D%225.5%22%20y2%3D%2216%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2216%22%20x2%3D%2211.2%22%20y2%3D%2213.2%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%222.4%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2216%22%20x2%3D%2222.9%22%20y2%3D%2212.0%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%221.8%22%20stroke-linecap%3D%22round%22%2F%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%221.8%22%20fill%3D%22%231e3a8a%22%2F%3E%3C%2Fsvg%3E">
<title>SixMinuteLog.com</title>
<style>
:root{
  --bg:#f8fafc;--white:#fff;--border:#e2e8f0;--border-l:#f1f5f9;
  --ink:#0f172a;--ink2:#475569;--ink3:#94a3b8;
  --green:#16a34a;--blue:#2563eb;--red:#dc2626;--amber:#d97706;--purple:#7c3aed;
  --r:10px;--sh:0 1px 3px rgba(0,0,0,.1);--sh-lg:0 10px 30px rgba(0,0,0,.18);
  /* Layout sizing */
  --space-sm:14px;--space-md:20px;--space-lg:24px;
  --card-pad:18px;--fbox-pad:22px;--field-pad:9px 13px;
  /* Shorthand aliases */
  --brd:#e2e8f0;--bg2:#f1f5f9;--blue-pale:#eff6ff;
}

/* == Dark Mode == */
body.dark{
  --bg:#0f172a;--white:#1e293b;--border:#334155;--border-l:#1e293b;
  --ink:#f1f5f9;--ink2:#94a3b8;--ink3:#475569;
  --green:#22c55e;--blue:#3b82f6;--red:#ef4444;--amber:#f59e0b;--purple:#a78bfa;
  --sh:0 1px 3px rgba(0,0,0,.4);--sh-lg:0 10px 30px rgba(0,0,0,.6);
  --brd:#334155;--bg2:#1e293b;--blue-pale:#172554;
}
body.dark .header{background:#1e293b}
body.dark .fbox{background:#1e2d40}
body.dark .fl input,body.dark .fl select,body.dark .fl textarea{background:#0f172a;color:var(--ink)}
body.dark .fl input.err,body.dark .fl select.err{background:#300}
body.dark .btn-gh{background:var(--white);color:var(--ink)}
body.dark .btn-gh:hover{background:#2d3f55}
body.dark .btn-ic{background:#263347;color:var(--ink);border-color:#3d5068}
body.dark .btn-ic:hover{background:#2d3f55}
body.dark .btn-dk{background:#3b82f6;color:#fff;border-color:#3b82f6}
body.dark .btn-dk:hover{background:#2563eb;border-color:#2563eb}
body.dark .btn-gr{background:#16a34a;color:#fff;border-color:#16a34a}
body.dark .btn-rd{background:#dc2626;color:#fff;border-color:#dc2626}
body.dark #fab{background:#3b82f6;color:#fff}
body.dark .sc{background:var(--white)}
body.dark .twrap{background:var(--white)}
body.dark thead tr{background:#162032}
body.dark tr:hover td{background:#1a2b3f}
body.dark .card{background:var(--white)}
body.dark .preset-btn{background:var(--white)}
body.dark .crow{background:var(--white)}
body.dark .up-box{background:#1e293b}
body.dark .exp-name-preview{background:#162032;color:var(--blue);border-color:#2563eb44}
body.dark .danger{background:#300a0a;border-color:#7f1d1d}
body.dark .note{background:#422006;border-color:#78350f;color:#fcd34d}
body.dark .good{background:#052e16;border-color:#14532d;color:#4ade80}
body.dark .role-notice{background:#1e2d4f;border-color:#2563eb44;color:#93c5fd}
body.dark .total-pill{background:#052e16;border-color:#14532d;color:#4ade80}
body.dark .appr-panel{background:var(--white)}
body.dark .help-body{color:var(--ink)}
body.dark .help-nav button{color:var(--ink2)}
body.dark .help-nav button.on{background:#162032;color:var(--ink)}
body.dark #loading{background:#0f172a;color:var(--ink2)}
body.dark .desc-chip{background:#162032;border-color:#334155;color:var(--ink2)}
body.dark .desc-chip:hover{background:#1e3a5f;color:var(--ink)}
body.dark .mail-preset-card{background:var(--white);border-color:var(--border)}
body.dark select{background:#1e293b;color:var(--ink);border-color:var(--border)}
body.dark .fab-tog{background:#334155}

/* == Layout Sizes == */
body.layout-compact{--space-sm:10px;--space-md:14px;--space-lg:16px;--card-pad:12px;--fbox-pad:16px;--field-pad:7px 11px;font-size:13px}
body.layout-compact .main{padding:16px 14px}
body.layout-compact .card{padding:var(--card-pad)}
body.layout-compact .fbox{padding:var(--fbox-pad)}
body.layout-compact .fl input,.layout-compact .fl select,.layout-compact .fl textarea{padding:var(--field-pad);font-size:12px}
body.layout-compact th,body.layout-compact td{padding:7px 10px;font-size:12px}
body.layout-compact .btn{padding:7px 12px;font-size:12px}
body.layout-compact .sc{padding:10px 14px}
body.layout-compact .sc-val{font-size:1.2rem}
body.layout-compact .srow{gap:8px;margin-bottom:14px}
body.layout-compact .modal-bd{padding:16px 18px}

body.layout-spacious{--space-sm:18px;--space-md:28px;--space-lg:32px;--card-pad:26px;--fbox-pad:30px;--field-pad:12px 16px;font-size:15px}
body.layout-spacious .main{padding:32px 28px}
body.layout-spacious .card{padding:var(--card-pad)}
body.layout-spacious .fbox{padding:var(--fbox-pad)}
body.layout-spacious .fl input,.layout-spacious .fl select,.layout-spacious .fl textarea{padding:var(--field-pad);font-size:14px}
body.layout-spacious th,body.layout-spacious td{padding:13px 18px;font-size:14px}
body.layout-spacious .btn{padding:11px 20px;font-size:14px}
body.layout-spacious .sc{padding:18px 24px}
body.layout-spacious .sc-val{font-size:1.6rem}
body.layout-spacious .srow{gap:16px;margin-bottom:26px}

/* == Description Chips == */
.desc-chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:7px;margin-bottom:2px}
.desc-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:#f1f5f9;border:1px solid var(--border);border-radius:16px;font-size:11px;color:var(--ink2);cursor:pointer;transition:all .15s}
.desc-chip:hover{background:#e2e8f0;color:var(--ink);border-color:var(--ink3)}
.desc-chip svg{opacity:.6}

/* == Mail Preset Cards == */
.mail-preset-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;position:relative}
.mail-preset-card h4{font-size:13px;font-weight:500;margin-bottom:6px;color:var(--ink)}
.mail-preset-card p{font-size:11px;color:var(--ink3);margin-bottom:2px}
.mail-preset-card .mp-acts{position:absolute;top:10px;right:10px;display:flex;gap:4px}

/* == Preset List Items == */
.preset-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:7px;font-size:13px}
.preset-item span{flex:1;color:var(--ink)}
.preset-item button{padding:4px 6px;border:none;background:transparent;color:var(--ink3);border-radius:4px;cursor:pointer}
.preset-item button:hover{color:var(--red);background:#fef2f2}

/* == Settings Tab Nav == */
.set-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg);padding:4px;border-radius:10px;flex-wrap:wrap}
.set-tab{padding:7px 14px;border:none;background:transparent;border-radius:7px;font-size:12px;font-weight:500;color:var(--ink3);cursor:pointer;transition:all .15s;white-space:nowrap}
.set-tab:hover{color:var(--ink)}
.set-tab.on{background:var(--white);color:var(--ink);box-shadow:var(--sh)}
body.dark .set-tabs{background:#162032}
body.dark .set-tab.on{background:#1e293b}
body.dark .avatar-dark{background:#3b82f6;color:#fff;font-size:1rem}
body.dark .nav-btn{color:var(--ink3)}
body.dark .nav-btn:hover{color:var(--ink)}
body.dark .nav-btn.on{color:var(--ink);border-bottom-color:var(--blue)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--ink);font-size:14px}
input,select,textarea,button{font-family:inherit;font-size:14px}
button{cursor:pointer}

/* Layout */
.header{background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.header-inner{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:8px}
.logo h1{font-size:1.15rem;font-weight:300;color:var(--ink)}
.logo-sub{font-size:11px;color:var(--ink3);margin-top:1px}
.header-btns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.nav{max-width:1200px;margin:0 auto;padding:0 12px;overflow-x:auto;display:flex}
.nav::-webkit-scrollbar{display:none}
.nav-btn{display:flex;align-items:center;gap:6px;padding:10px 14px;border:none;background:transparent;color:var(--ink3);border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;font-size:13px;transition:all .15s}
.nav-btn:hover{color:var(--ink)}.nav-btn.on{color:var(--ink);border-bottom-color:var(--ink);font-weight:500}
.main{max-width:1200px;margin:0 auto;padding:24px 20px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 16px;border-radius:8px;border:1px solid transparent;font-size:13px;font-weight:400;transition:opacity .15s,transform .1s;white-space:nowrap}
.btn:active{transform:scale(.98)}
.btn-dk{background:var(--ink);color:#fff;border-color:var(--ink)}.btn-dk:hover{opacity:.85}
.btn-gr{background:var(--green);color:#fff;border-color:var(--green)}.btn-gr:hover{opacity:.85}
.btn-bl{background:var(--blue);color:#fff;border-color:var(--blue)}.btn-bl:hover{opacity:.85}
.btn-rd{background:var(--red);color:#fff;border-color:var(--red)}.btn-rd:hover{opacity:.85}
.btn-gh{background:var(--white);color:var(--ink2);border-color:var(--border)}.btn-gh:hover{background:var(--bg)}
.btn-ic{padding:8px;border-radius:8px;background:var(--white);border:1px solid var(--border);color:var(--ink2)}.btn-ic:hover{background:var(--bg)}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* Forms */
.fbox{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:18px}
.fbox h3{font-weight:400;font-size:1rem;margin-bottom:18px;color:var(--ink)}
.frow{display:grid;gap:14px;margin-bottom:14px}
.frow.c2{grid-template-columns:1fr 1fr}
.frow.c3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:580px){.frow.c2,.frow.c3{grid-template-columns:1fr}}
.fl label{display:block;font-size:12px;color:var(--ink2);margin-bottom:5px}
.fl label .req{color:var(--red);margin-left:2px}
.fl input,.fl select,.fl textarea{width:100%;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink);outline:none;transition:border .15s}
.fl input:focus,.fl select:focus,.fl textarea:focus{border-color:#94a3b8}
.fl input.err,.fl select.err{border-color:var(--red);background:#fef2f2}
.fl .hint{font-size:11px;color:var(--ink3);margin-top:4px}
.fl .emsg{font-size:11px;color:var(--red);margin-top:4px}
.fl .pw{position:relative}
.fl .pw .pfx{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--ink3);pointer-events:none}
.fl .pw .sfx{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--ink3);pointer-events:none;font-size:12px}
.fl .pw input{padding-left:26px}
.fl .pw input.has-sfx{padding-right:32px}
.fa{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}

/* Cards */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px}
.card-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.avatar{width:42px;height:42px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:1.1rem;border:1px solid var(--border)}
.card-act button{padding:5px;border:none;background:transparent;color:var(--ink3);border-radius:5px}
.card-act button:hover{color:var(--ink);background:var(--bg)}
.card h3{font-weight:500;font-size:.93rem;margin-bottom:3px}
.card p{font-size:12px;color:var(--ink2);margin-bottom:2px;line-height:1.5}
.card-rate{margin-top:10px;padding-top:10px;border-top:1px solid var(--border-l);font-size:12px;color:var(--ink3)}
.card-rate strong{color:var(--ink)}
.chip{display:inline-block;font-size:11px;background:var(--bg);color:var(--ink2);padding:3px 9px;border-radius:20px;border:1px solid var(--border);margin-bottom:8px}
.split-pill{display:inline-flex;gap:5px;font-size:11px;margin-top:6px}
.split-pill .own{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0;padding:2px 8px;border-radius:12px}
.split-pill .firm{background:#fef3c7;color:#92400e;border:1px solid #fde68a;padding:2px 8px;border-radius:12px}

/* Roles & Approval Status */
.status-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:12px;font-size:11px;font-weight:500;white-space:nowrap}
.s-pending{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
.s-approved{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0}
.s-review{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
.s-neutral{background:var(--bg);color:var(--ink3);border:1px solid var(--border)}
.s-rejected{background:#fef2f2;color:#dc2626;border:1px solid #fee2e2}
.role-lbl{display:inline-flex;align-items:center;font-size:11px;padding:2px 9px;border-radius:12px;font-weight:500;border:1px solid}
.rl-partner{background:#f5f3ff;color:#6d28d9;border-color:#ddd6fe}
.rl-attorney{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
.rl-billing{background:#f0fdf4;color:#166534;border-color:#bbf7d0}
.appr-panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:18px}
.appr-panel h3{font-weight:500;font-size:.93rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.role-notice{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:#1e40af;display:flex;align-items:center;gap:10px}

/* Stats */
.srow{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px}
.sc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 18px}
.sc-lbl{font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
.sc-val{font-size:1.4rem;font-weight:300;color:var(--ink)}
.sc.highlight{border-color:#bbf7d0;background:#f0fdf4}.sc.highlight .sc-val{color:#166534}
.sc.highlight2{border-color:#fde68a;background:#fffbeb}.sc.highlight2 .sc-val{color:#92400e}

/* Table */
.twrap{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.tscroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{background:var(--bg);border-bottom:1px solid var(--border)}
th{padding:9px 13px;text-align:left;font-weight:500;color:var(--ink2);font-size:11px;white-space:nowrap;text-transform:uppercase;letter-spacing:.03em}
td{padding:9px 13px;border-bottom:1px solid var(--border-l);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#fafafa}
.tda{display:flex;gap:4px}
.tda button{padding:5px;border:none;background:transparent;color:var(--ink3);border-radius:4px}
.tda button:hover{color:var(--ink);background:var(--bg)}
.badge{width:26px;height:26px;border-radius:50%;background:var(--bg);border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:var(--ink2)}

/* Modals */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:500;padding:16px}
.modal{background:var(--white);border-radius:14px;width:100%;box-shadow:var(--sh-lg);display:flex;flex-direction:column;max-height:90vh}
.modal-sm{max-width:480px}.modal-md{max-width:580px}.modal-lg{max-width:760px}.modal-xl{max-width:1040px}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-hd h2{font-size:1.05rem;font-weight:400}
.modal-bd{overflow-y:auto;padding:22px;flex:1;min-height:0}
.modal-ft{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;flex-shrink:0;flex-wrap:wrap}

/* Toast */
#toasts{position:fixed;top:16px;right:16px;z-index:9000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:11px 18px;border-radius:9px;color:#fff;font-size:13px;box-shadow:var(--sh-lg);animation:tin .25s ease;pointer-events:auto}
.t-ok{background:var(--green)}.t-warn{background:var(--amber)}.t-err{background:var(--red)}
@keyframes tin{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Quick Log */
.ql-timer{background:var(--bg);border-bottom:1px solid var(--border);padding:16px 22px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.timer-num{font-size:2.1rem;font-weight:200;font-family:'Courier New',monospace;letter-spacing:.04em;min-width:115px}
.timer-on{color:var(--ink)}.timer-off{color:var(--ink3)}
.total-pill{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:8px 14px;font-size:13px;color:#15803d;margin-bottom:14px}

/* Help */
.help-lay{display:flex;flex:1;overflow:hidden;min-height:0}
.help-nav{width:162px;flex-shrink:0;border-right:1px solid var(--border-l);padding:10px;overflow-y:auto}
.help-nav button{display:block;width:100%;text-align:left;padding:9px 11px;border:none;background:transparent;border-radius:7px;font-size:13px;color:var(--ink2);cursor:pointer;margin-bottom:2px}
.help-nav button:hover{background:var(--bg);color:var(--ink)}
.help-nav button.on{background:var(--bg);color:var(--ink);font-weight:500}
.help-body{flex:1;overflow-y:auto;padding:22px}
.help-body h3{font-weight:500;margin-bottom:12px}
.help-body h4{font-weight:500;color:var(--ink2);margin:18px 0 7px;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
.help-body p,.help-body li{color:var(--ink2);line-height:1.7;font-size:13px}
.help-body ol,.help-body ul{padding-left:18px}
.help-body li{margin-bottom:4px}
.note{background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:10px 14px;margin-top:14px;font-size:12px;color:#92400e}
.good{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 14px;margin-top:14px;font-size:12px;color:#166534}
.faq-item{border-bottom:1px solid var(--border-l);padding-bottom:14px;margin-bottom:14px}
.faq-item:last-child{border-bottom:none;margin-bottom:0}
.faq-item strong{display:block;color:var(--ink);margin-bottom:4px;font-size:13px}

/* Settings */
.set-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border-l)}
.set-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.set-section h3{font-weight:500;margin-bottom:12px;font-size:.93rem}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.preset-btn{padding:10px 12px;border:2px solid var(--border);border-radius:8px;background:var(--white);cursor:pointer;text-align:left;font-size:12px;transition:border .15s}
.preset-btn:hover{border-color:var(--ink3)}
.preset-btn strong{display:block;color:var(--ink);font-size:13px;margin-bottom:1px}
.crow{display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;margin-bottom:7px}
.crow input[type=checkbox]{width:14px;height:14px;cursor:pointer;flex-shrink:0;margin-top:1px}
.crow strong{display:block;font-size:13px;color:var(--ink)}
.crow span{font-size:11px;color:var(--ink3)}
.sub-checks{padding-left:20px;margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:4px}
.sub-check{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--ink2);cursor:pointer}
.sub-check input{width:13px;height:13px;cursor:pointer}
.danger{background:#fef2f2;border:1px solid #fee2e2;border-radius:8px;padding:14px 16px}
.danger h3{color:var(--red);margin-bottom:7px}
.danger p{color:#ef4444;font-size:12px;line-height:1.5;margin-bottom:12px}
.exp-name-preview{font-size:11px;color:var(--blue);background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:5px 10px;margin-bottom:14px;font-family:monospace}

/* Analytics split table */
.split-table{width:100%;font-size:13px;margin-top:8px}
.split-table th{text-align:left;font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;padding:6px 10px;border-bottom:1px solid var(--border)}
.split-table td{padding:8px 10px;border-bottom:1px solid var(--border-l)}
.split-table tr:last-child td{border-bottom:none;font-weight:500}
.own-amt{color:#166534}.firm-amt{color:#92400e}
.btn-link{background:none;border:none;padding:0;cursor:pointer;color:var(--blue);text-decoration:underline;font-size:inherit;font-family:inherit;}

/* Analytics */
.bar-row{margin-bottom:14px}
.bar-lbl{display:flex;justify-content:space-between;margin-bottom:5px;font-size:13px}
.bar-track{background:var(--bg);border-radius:4px;height:6px}
.bar-fill{background:var(--ink);border-radius:4px;height:6px;transition:width .4s ease}

/* ========== SPLASH SCREEN ========== */
.splash-ov{position:fixed;inset:0;z-index:900;display:flex;align-items:stretch;background:#0f172a;animation:splashIn .25s ease}
@keyframes splashIn{from{opacity:0}to{opacity:1}}

/* Left hero panel */
.splash-hero{width:340px;flex-shrink:0;background:linear-gradient(155deg,#1e3a5f 0%,#0f2040 50%,#0a1628 100%);display:flex;flex-direction:column;justify-content:space-between;padding:44px 40px;position:relative;overflow:hidden}
.splash-hero::before{content:'';position:absolute;top:-80px;right:-80px;width:280px;height:280px;border-radius:50%;background:rgba(59,130,246,.08);pointer-events:none}
.splash-hero::after{content:'';position:absolute;bottom:-60px;left:-60px;width:200px;height:200px;border-radius:50%;background:rgba(37,99,235,.07);pointer-events:none}
.splash-logo{display:flex;align-items:center;gap:12px}
.splash-logo-mark{width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 14px rgba(59,130,246,.4)}
.splash-logo-mark svg{color:#fff}
.splash-logo-name{font-size:1.05rem;font-weight:600;color:#f1f5f9;letter-spacing:-.01em}
.splash-tagline{margin-top:auto;padding-top:60px}
.splash-tagline h1{font-size:1.85rem;font-weight:300;color:#f1f5f9;line-height:1.25;margin-bottom:14px;letter-spacing:-.02em}
.splash-tagline h1 strong{font-weight:600;color:#fff}
.splash-tagline p{font-size:13px;color:#94a3b8;line-height:1.65}
.splash-steps{margin-top:40px;display:flex;flex-direction:column;gap:8px}
.splash-step{display:flex;align-items:center;gap:10px;font-size:12px;color:#475569;transition:color .2s}
.splash-step.active{color:#93c5fd}
.splash-step.done{color:#34d399}
.splash-step-dot{width:6px;height:6px;border-radius:50%;background:#334155;flex-shrink:0;transition:background .2s}
.splash-step.active .splash-step-dot{background:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
.splash-step.done .splash-step-dot{background:#10b981}

/* Right form panel */
.splash-form{flex:1;background:var(--white);display:flex;flex-direction:column;overflow-y:auto}
.splash-form-inner{flex:1;padding:52px 52px 36px;max-width:520px}
.splash-form-inner h2{font-size:1.5rem;font-weight:300;color:var(--ink);margin-bottom:6px;letter-spacing:-.02em}
.splash-form-inner h2 strong{font-weight:600}
.splash-form-inner .sub{font-size:13px;color:var(--ink2);line-height:1.6;margin-bottom:28px}
.splash-footer{padding:20px 52px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--white)}
.splash-footer-note{font-size:11px;color:var(--ink3)}

/* Profile option cards */
.splash-opt{display:flex;align-items:center;gap:16px;padding:18px 20px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s,background .15s;margin-bottom:12px;background:var(--white)}
.splash-opt:hover{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--blue-pale)}
.splash-opt-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.splash-opt-icon.blue{background:#eff6ff;color:var(--blue)}
.splash-opt-icon.slate{background:var(--bg);color:var(--ink2)}
.splash-opt-body{flex:1}
.splash-opt-body strong{display:block;font-size:14px;font-weight:600;color:var(--ink);margin-bottom:3px}
.splash-opt-body span{font-size:12px;color:var(--ink2);line-height:1.5}
.splash-opt-arrow{color:var(--ink3);flex-shrink:0}

/* Feature list */
.splash-features{background:var(--bg);border-radius:10px;padding:16px 18px;margin-bottom:22px}
.splash-features-title{font-size:11px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}
.splash-feature{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--ink2);padding:5px 0;border-bottom:1px solid var(--border-l)}
.splash-feature:last-child{border-bottom:none}
.splash-feature-dot{width:6px;height:6px;border-radius:50%;background:var(--blue);flex-shrink:0}

/* User select cards */
.splash-user-card{display:flex;align-items:center;gap:14px;padding:14px 18px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s,background .15s;margin-bottom:10px;background:var(--white)}
.splash-user-card:hover{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--blue-pale)}
.splash-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;letter-spacing:.01em}
.splash-user-info strong{display:block;font-size:13px;font-weight:600;color:var(--ink)}
.splash-user-info span{font-size:11px;color:var(--ink3)}

/* Role selector */
.splash-roles{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
.splash-role{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:1.5px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s;background:var(--white)}
.splash-role:hover{border-color:var(--blue);background:var(--blue-pale)}
.splash-role.sel{border-color:var(--blue);background:var(--blue-pale);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.splash-role-radio{width:16px;height:16px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;margin-top:2px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.splash-role.sel .splash-role-radio{border-color:var(--blue);background:var(--blue)}
.splash-role.sel .splash-role-radio::after{content:'';width:6px;height:6px;border-radius:50%;background:#fff;display:block}
.splash-role-body strong{display:block;font-size:13px;font-weight:600;color:var(--ink);margin-bottom:2px}
.splash-role-body span{font-size:11px;color:var(--ink2);line-height:1.5}

/* Dark mode overrides */
body.dark .splash-form,body.dark .splash-footer{background:#1e293b}
body.dark .splash-opt,body.dark .splash-user-card,body.dark .splash-role{background:#1e293b;border-color:#334155}
body.dark .splash-opt:hover,body.dark .splash-user-card:hover,body.dark .splash-role:hover{background:#172554;border-color:#3b82f6}
body.dark .splash-role.sel{background:#172554;border-color:#3b82f6}
body.dark .splash-opt-icon.slate{background:#263347}
body.dark .splash-features{background:#263347}

/* Legacy up-wrap kept for chgUser (non-first-run profile edit) */
.up-wrap{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:900;padding:16px}
.up-box{background:var(--white);border-radius:16px;padding:38px;max-width:460px;width:100%;box-shadow:var(--sh-lg);max-height:90vh;overflow-y:auto}
.up-icon{width:52px;height:52px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:22px}
.up-box h2{font-size:1.6rem;font-weight:300;margin-bottom:8px}
.up-box p{font-size:13px;color:var(--ink2);margin-bottom:24px;line-height:1.6}

/* Responsive splash */
@media(max-width:720px){
  .splash-ov{flex-direction:column}
  .splash-hero{width:auto;padding:28px 24px 24px;flex-direction:row;align-items:center;gap:20px}
  .splash-tagline,.splash-steps{display:none}
  .splash-form-inner{padding:28px 22px 20px}
  .splash-footer{padding:16px 22px}
}

/* FAB */
#fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:var(--ink);color:#fff;border:none;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:200;cursor:pointer;transition:transform .15s}
#fab:hover{transform:scale(1.1)}

/* Empty */
.empty{text-align:center;padding:60px 20px;color:var(--ink3)}
.empty-ico{font-size:2.5rem;margin-bottom:12px}
.empty p{font-weight:300;font-size:.95rem}
.empty small{font-size:12px;margin-top:4px;display:block}

/* Loading */
#loading{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);flex-direction:column;gap:12px;color:var(--ink3);font-size:1rem;font-weight:300}

/* Invoice */
@media print{
  .header,.nav,.header-btns,button,.modal-hd,.modal-ft,.tda,.fab{display:none!important}
  .modal,.ov{position:static!important;background:transparent!important;padding:0!important}
  #inv-print-wrap{margin:0!important;box-shadow:none!important;max-width:100%!important}
  body{background:#fff!important;color:#000!important}
}
</style>
</head>
<body>
<script>
// Anti-FOUC: apply dark mode and layout before first paint
(function(){
  try{
    var p=JSON.parse(localStorage.getItem('bl-prefs')||'{}');
    var dm=p.darkMode===undefined?null:p.darkMode;
    var sysDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(dm===true||(dm===null&&sysDark)) document.body.classList.add('dark');
    if(p.layout&&p.layout!=='comfortable') document.body.classList.add('layout-'+p.layout);
    if(p.appName){
      document.title=p.appName;
      // Update loading text too
      document.addEventListener('DOMContentLoaded',function(){
        var ldiv=document.getElementById('loading');
        if(ldiv&&p.appName){ var t=ldiv.querySelector('div:last-child'); if(t) t.textContent='Loading '+p.appName+'...'; }
      });
    }
  }catch(e){}
})();
</script>
<div id="loading"><div style="font-size:2rem">&#9878;&#65039;</div><div>Loading SixMinuteLog.com...</div></div>
<div id="toasts"></div>
<button id="fab" onclick="A.openQL()" title="Quick Log"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></button>
<div id="app" style="display:none"></div>

<script>
// +============================================================+
// |  SixMinuteLog.com -- CLAUDE MANIFEST                         |
// |  AI: read CLAUDE_BILLING.md first, then view line ranges.  |
// +------------------------------------------------------------+
// |  SECTION MAP (Ctrl+F these strings):                       |
// |  "// === STORAGE"       Store.get/set/del                  |
// |  "// === STATE"         ST object                          |
// |  "// === HELPERS"       uid,today,$m,$h,H,autoRate,syncForm|
// |  "// === SAVE"          save() persist                     |
// |  "// === TOAST"         toast(msg,type)                    |
// |  "// === ICONS"         IC object SVG strings              |
// |  "// === FIELD BUILDER" field(), stats()                   |
// |  "// === EXPORT FILENAME" exportFilename()                 |
// |  "// === VIEWS"         tab view functions                 |
// |  "// === MODALS"        modal builder functions            |
// |  "// === MAIN RENDER"   TABS[], views{}, render()          |
// |  "// === ACTIONS"       A object user actions              |
// |  "// === CHANGE DELEGATION" onchange handler               |
// |  "// === INIT"          startup loading                    |
// +------------------------------------------------------------+
// |  ADD TAB:   IC + TABS[] + view fn + views{} in render()   |
// |  ADD MODAL: build fn + else-if render() + open action     |
// |  ADD DATA:  ST + save() + INIT Promise.all load           |
// |  ALWAYS: syncForm() before render() / H() on user data    |
// +============================================================+

// === STORAGE  (IndexedDB — proper per-collection object stores)
//
// Schema (v2):
//   clients, matters, entries, contacts, invoices  →  keyPath:'id'  (one record per item)
//   meta                                           →  keyPath:'k'   (singletons: user,prefs,…)
//
// Public API:
//   Store.getAll(name)        → Promise<array>          (collections)
//   Store.saveAll(name, arr)  → Promise                 (clear + putAll in one tx)
//   Store.getMeta(key)        → Promise<object|null>    (parsed value or null)
//   Store.setMeta(key, val)   → Promise                 (val stored as native JS object)
//   Store.clearData()         → Promise                 (wipe all stores — for reset)
//
// bl-prefs is ALSO mirrored to localStorage so the synchronous anti-FOUC block (above)
// can read it before IndexedDB resolves.  No other data touches localStorage.
const Store=(function(){
  var _db=null;
  var DB_NAME='SixMinuteLog';
  var DB_VER=3;
  var COLLECTIONS=['clients','matters','entries','contacts','invoices','emailtemplates'];
  var COLL_SET={clients:1,matters:1,entries:1,contacts:1,invoices:1,emailtemplates:1};
  // Keys stored in the meta store (everything that isn't a collection array)
  var META_KEYS=['user','prefs','descpresets','mailpresets','itmode'];

  function _open(){
    if(_db) return Promise.resolve(_db);
    return new Promise(function(resolve,reject){
      var req=indexedDB.open(DB_NAME,DB_VER);

      req.onupgradeneeded=function(e){
        var db=e.target.result;
        var tx=e.target.transaction;
        var oldV=e.oldVersion;

        // ── Create new proper object stores (idempotent) ──
        COLLECTIONS.forEach(function(name){
          if(!db.objectStoreNames.contains(name))
            db.createObjectStore(name,{keyPath:'id'});
        });
        if(!db.objectStoreNames.contains('meta'))
          db.createObjectStore('meta',{keyPath:'k'});

        // ── Migrate from v1 kv-blob store ──
        if(oldV===1 && db.objectStoreNames.contains('kv')){
          var kvReq=tx.objectStore('kv').getAll();
          kvReq.onsuccess=function(){
            var metaOS=tx.objectStore('meta');
            (kvReq.result||[]).forEach(function(item){
              // item = {k:'bl-clients', v:'[…json…]'}
              var rawKey=item.k.replace(/^bl-/,''); // 'clients','user','prefs',…
              var parsed;
              try{parsed=JSON.parse(item.v);}catch(e2){return;}
              if(COLL_SET[rawKey]&&Array.isArray(parsed)){
                var os2=tx.objectStore(rawKey);
                parsed.forEach(function(rec){if(rec&&rec.id!=null)os2.put(rec);});
              } else {
                metaOS.put({k:rawKey,v:parsed});
              }
            });
            // Clear the old kv store (can't delete outside onupgradeneeded root,
            // but clearing it frees the space and leaves no stale data)
            tx.objectStore('kv').clear();
          };

        // ── Fresh IDB install: check localStorage for pre-IDB data ──
        } else if(oldV===0){
          var metaOS2=tx.objectStore('meta');
          META_KEYS.forEach(function(k){
            var v=localStorage.getItem('bl-'+k);
            if(v){try{metaOS2.put({k:k,v:JSON.parse(v)});}catch(e2){}}
          });
          COLLECTIONS.forEach(function(name){
            var v=localStorage.getItem('bl-'+name);
            if(v){
              try{
                var arr=JSON.parse(v);
                var os3=tx.objectStore(name);
                if(Array.isArray(arr))arr.forEach(function(r){if(r&&r.id!=null)os3.put(r);});
              }catch(e2){}
            }
          });
          // Clean up localStorage (keep bl-prefs for anti-FOUC mirror)
          try{localStorage.setItem('bl-idb-migrated','1');}catch(e2){}
          ['bl-user','bl-clients','bl-matters','bl-entries','bl-contacts',
           'bl-descpresets','bl-mailpresets','bl-itmode','bl-invoices']
            .forEach(function(k){try{localStorage.removeItem(k);}catch(e2){}});
        }
      };

      req.onsuccess=function(e){_db=e.target.result;resolve(_db);};
      req.onerror=function(e){reject(e.target.error);};
      req.onblocked=function(){console.warn('IDB open blocked — close other tabs');};
    });
  }

  return{
    // ── Collections ──
    getAll:function(name){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction(name,'readonly').objectStore(name).getAll();
          req.onsuccess=function(){resolve(req.result||[]);};
          req.onerror=function(){resolve([]);};
        });
      }).catch(function(){return[];});
    },
    saveAll:function(name,arr){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var tx=db.transaction(name,'readwrite');
          var os=tx.objectStore(name);
          os.clear();
          arr.forEach(function(rec){if(rec&&rec.id!=null)os.put(rec);});
          tx.oncomplete=function(){resolve();};
          tx.onerror=function(e){console.warn('Store.saveAll',name,e);resolve();};
        });
      }).catch(function(){});
    },

    // ── Singleton metadata ──
    getMeta:function(key){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction('meta','readonly').objectStore('meta').get(key);
          req.onsuccess=function(){resolve(req.result?req.result.v:null);};
          req.onerror=function(){resolve(null);};
        });
      }).catch(function(){return null;});
    },
    setMeta:function(key,val){
      // Mirror prefs to localStorage for synchronous anti-FOUC read
      if(key==='prefs'){try{localStorage.setItem('bl-prefs',JSON.stringify(val));}catch(e){}}
      return _open().then(function(db){
        return new Promise(function(resolve){
          var tx=db.transaction('meta','readwrite');
          tx.objectStore('meta').put({k:key,v:val});
          tx.oncomplete=function(){resolve();};
          tx.onerror=function(){resolve();};
        });
      }).catch(function(){});
    },

    // ── Wipe everything (for reset) ──
    clearData:function(){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var all=COLLECTIONS.concat(['meta']);
          var tx=db.transaction(all,'readwrite');
          all.forEach(function(name){tx.objectStore(name).clear();});
          tx.oncomplete=function(){resolve();};
          tx.onerror=function(){resolve();};
        });
      }).catch(function(){});
    }
  };
})();

// === STATE
var ST={
  tab:'timesheet',
  clients:[],matters:[],entries:[],contacts:[],
  invoices:[],
  user:null,
  settings:{
    // sections
    te:true,cl:true,ma:true,co:true,su:true,split:false,
    // time entry columns
    tc_date:true,tc_client:true,tc_matter:true,tc_team:true,
    tc_desc:true,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false,
    // date range for export (empty = all)
    expFrom:'',expTo:'',
    // per-client grouping
    te_group:false
  },
  // Appearance & customization preferences (persisted in bl-prefs)
  prefs:{
    appName:'SixMinuteLog.com',
    darkMode:null,
    layout:'comfortable',
    revenueSplit:false
  },
  // User-defined description suggestions shown as chips in entry forms (bl-descpresets)
  descPresets:[
    'Legal research and analysis',
    'Drafted correspondence',
    'Client consultation',
    'Court appearance / hearing',
    'Document review',
    'Contract drafting / review',
    'Phone conference with client',
    'Filed documents with court',
    'Deposition preparation',
    'Settlement negotiation'
  ],
  // Mail presets for emailing exported CSV (bl-mailpresets)
  mailPresets:[],
  // Email block templates (IDB: emailtemplates)
  emailTemplates:[],
  // Email template editor state
  etf:{},  // {editId, name, description, types:[], blocks:[], defaultSubject:'', expanded_id}
  modal:null,editId:null,helpTab:'start',settingsTab:'export',
  tsFilter:'all',anFilter:'month',
  // Timesheet extra filters/sort
  tsClientFilter:'',tsMatterFilter:'',tsSort:'date-desc',
  // Clients sort
  clSort:'alpha',clSearch:'',
  // Matters group/filter/sort
  maGroup:false,maClientFilter:'',maSort:'alpha',maSearch:'',
  // Contacts sort/search
  ctSort:'alpha',ctSearch:'',
  tmrOn:false,tmrStart:0,tmrMs:0,tmrIv:null,
  ef:{},cf:{},mf:{},ctf:{},ql:{},
  mpf:{},
  // Invoice form and review state
  invf:{},invRev:{invoiceId:null,cuts:{},mergeGroup:{},comments:{},pendingMerge:[]},
  invFilter:'all',invPrintId:null,
  // IT Mode - admin profile management
  itMode:false,
  firmProfile:{
    firmName:'',
    appName:'SixMinuteLog.com',
    clients:[],
    matters:[],
    contacts:[],
    descPresets:[],
    users:[],   // pre-configured user profiles for new installs
    settings:{}
  },
  itf:{},  // IT admin form state
  firstRun:false,  // true if no user set on init
  pref:{}   // partner review entry form state
};

// === HELPERS
var _uid=1;
function uid(){return Date.now()*1000+(_uid++);}
function today(){return new Date().toISOString().split('T')[0];}
function $m(n){return '$'+Number(n||0).toFixed(2);}
function $h(n){return Number(n||0).toFixed(1)+'h';}
// msToHMS: convert milliseconds to "H:MM:SS" string for raw-time tooltips
function msToHMS(ms){
  var s=Math.floor((ms||0)/1000);
  var hh=Math.floor(s/3600);
  var mm=Math.floor((s%3600)/60);
  var ss=s%60;
  return hh+':'+String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0');
}
function $d(s){if(!s)return '';var d=new Date(s+'T00:00:00');return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function H(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function pad2(n){return String(n).padStart(2,'0');}

// Phone: format live as user types
function fmtPhone(v){
  var d=v.replace(/\D/g,'');
  if(d.length<=3) return d;
  if(d.length<=6) return '('+d.slice(0,3)+') '+d.slice(3);
  return '('+d.slice(0,3)+') '+d.slice(3,6)+'-'+d.slice(6,10);
}

function fmtCur(v){
  var c=v.replace(/[^\d.]/g,''),p=c.split('.');
  if(p.length>2) return p[0]+'.'+p.slice(1).join('');
  if(p[1]&&p[1].length>2) return p[0]+'.'+p[1].slice(0,2);
  return c;
}

function myRole(){ return ST.user&&ST.user.role||'attorney'; }
function isPartner(){ return myRole()==='partner'; }
function isBilling(){ return myRole()==='billing_staff'; }

function statusBadge(st){
  var s=st||'approved';
  var map={pending:'s-pending',approved:'s-approved',rejected:'s-rejected'};
  var icon={pending:'\u23f3',approved:'\u2713',rejected:'\u2717'};
  return '<span class="status-badge '+map[s]+'">'+icon[s]+' '+s.charAt(0).toUpperCase()+s.slice(1)+'</span>';
}

function roleBadge(role){
  var r=role||'attorney';
  var cls={partner:'rl-partner',attorney:'rl-attorney',billing_staff:'rl-billing'};
  var lbl={partner:'Partner',attorney:'Attorney',billing_staff:'Billing Staff'};
  return '<span class="role-lbl '+(cls[r]||'rl-attorney')+'">'+(lbl[r]||r)+'</span>';
}

function autoRate(cid,mid,ctid){
  // Priority: 1) User/Attorney rate, 2) Contact rate, 3) Matter rate, 4) Client rate
  if(ST.user&&ST.user.rate) return ST.user.rate;
  var ct=ST.contacts.find(function(x){return x.id==ctid;});
  if(ct&&ct.rate) return ct.rate;
  var m=ST.matters.find(function(x){return x.id==mid;});
  if(m&&m.rate) return m.rate;
  var cl=ST.clients.find(function(x){return x.id==cid;});
  if(cl&&cl.rate) return cl.rate;
  return '';
}

function filterEnt(arr,f){
  var now=new Date(),t=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  function ago(d,n){d.setDate(d.getDate()-n);return d;}
  function agoM(d,n){d.setMonth(d.getMonth()-n);return d;}
  function agoY(d,n){d.setFullYear(d.getFullYear()-n);return d;}
  var cut, cutEnd;
  if(f==='today') cut=t;
  else if(f==='week')  cut=ago(new Date(t),7);
  else if(f==='month') cut=agoM(new Date(t),1);
  else if(f==='quarter') cut=ago(new Date(t),91);
  else if(f==='year')  cut=agoY(new Date(t),1);
  else if(f==='this_month'){
    cut=new Date(now.getFullYear(),now.getMonth(),1);
  } else if(f==='this_quarter'){
    var qStart=Math.floor(now.getMonth()/3)*3;
    cut=new Date(now.getFullYear(),qStart,1);
  } else if(f==='this_year'){
    cut=new Date(now.getFullYear(),0,1);
  } else return arr; // 'all'
  return arr.filter(function(e){return new Date(e.date)>=cut;});
}

// Returns the fraction of annual salary that maps to the given filter period.
// Used to prorate salary for bonus/shortfall comparisons.
// Returns null if the period is indeterminate ('all').
function salaryForPeriod(annual, f){
  if(annual==null||annual==='') return null;
  var a=Number(annual);
  var now=new Date();
  if(f==='week')        return a/52;
  if(f==='month')       return a/12;
  if(f==='quarter')     return a/4;
  if(f==='year')        return a;
  if(f==='this_month'){
    // Days elapsed in this calendar month / days in month
    var daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
    var dayOfMonth=now.getDate();
    return (a/12)*(dayOfMonth/daysInMonth);
  }
  if(f==='this_quarter'){
    var qStartM=Math.floor(now.getMonth()/3)*3;
    var qStart=new Date(now.getFullYear(),qStartM,1);
    var qEnd=new Date(now.getFullYear(),qStartM+3,0);
    var qDays=(qEnd-qStart)/86400000+1;
    var elapsed=Math.floor((now-qStart)/86400000)+1;
    return (a/4)*(elapsed/qDays);
  }
  if(f==='this_year'){
    var isLeap=(now.getFullYear()%4===0&&now.getFullYear()%100!==0)||(now.getFullYear()%400===0);
    var yearDays=isLeap?366:365;
    var jan1=new Date(now.getFullYear(),0,1);
    var elapsed2=Math.floor((now-jan1)/86400000)+1;
    return a*(elapsed2/yearDays);
  }
  return null; // 'all' — no meaningful proration
}

// Human-readable salary period label for display
function salaryPeriodLabel(f){
  return {
    week:'weekly (÷52)', month:'monthly (÷12)', quarter:'quarterly (÷4)',
    year:'annual', this_month:'month-to-date', this_quarter:'quarter-to-date',
    this_year:'year-to-date', all:null
  }[f]||null;
}

// Sync form field values to state before any re-render triggered by dropdown changes
// This prevents typed text from being lost when a select triggers a re-render
function syncForm(){
  if(ST.modal==='ef'){
    var d=g('ef-d'),h=g('ef-h'),r=g('ef-r'),desc=g('ef-desc');
    if(d) ST.ef.date=d;
    ST.ef.hours=h; // always sync so partial typing is preserved
    ST.ef.rate=r;
    ST.ef.description=desc;
  }
  if(ST.modal==='cf'){
    var n=g('cf-n'),e=g('cf-e'),p=g('cf-p'),r=g('cf-r'),op=g('cf-op');
    ST.cf.name=n; ST.cf.email=e; ST.cf.phone=p; ST.cf.rate=r;
    if(op!==undefined) ST.cf.ownPct=op;
    // Preserve new-person draft
    var pn=g('cf-pn'),pro=g('cf-pro'),pe=g('cf-pe'),pp=g('cf-pp');
    if(pn!==undefined) ST.cf.newPerson=ST.cf.newPerson||{};
    if(pn!==undefined) ST.cf.newPerson.name=pn;
    if(pro!==undefined) ST.cf.newPerson.role=pro;
    if(pe!==undefined) ST.cf.newPerson.email=pe;
    if(pp!==undefined) ST.cf.newPerson.phone=pp;
  }
  if(ST.modal==='mf'){
    var n=g('mf-n'),desc=g('mf-desc'),r=g('mf-r');
    ST.mf.name=n; ST.mf.description=desc; ST.mf.rate=r;
  }
  if(ST.modal==='ctf'){
    var n=g('ctf-n'),ro=g('ctf-ro'),e=g('ctf-e'),p=g('ctf-p'),r=g('ctf-rate'),op=g('ctf-op');
    ST.ctf.name=n; ST.ctf.role=ro; ST.ctf.email=e; ST.ctf.phone=p; ST.ctf.rate=r;
    if(op!==undefined) ST.ctf.ownPct=op;
  }
  if(ST.modal==='ql'){
    var h=g('ql-h'),r=g('ql-r'),desc=g('ql-d');
    if(h) ST.ql.hours=h;
    if(r) ST.ql.rate=r;
    if(desc) ST.ql.description=desc;
  }
  if(ST.modal==='settings'){
    var ef=g('exp-from'),et=g('exp-to');
    if(ef!==undefined) ST.settings.expFrom=ef;
    if(et!==undefined) ST.settings.expTo=et;
  }
  if(ST.modal==='pref'){
    var h=g('pref-h'),r=g('pref-r'),d=g('pref-desc'),c=g('pref-cmt'),inv=document.getElementById('pref-inv');
    if(h!==undefined) ST.pref.hours=h;
    if(r!==undefined) ST.pref.rate=r;
    if(d!==undefined) ST.pref.description=d;
    if(c!==undefined) ST.pref.comment=c;
    if(inv) ST.pref.showOnInvoice=inv.checked;
  }
}

// === SAVE
var saveT=null;
function save(){
  clearTimeout(saveT);
  saveT=setTimeout(function(){
    Store.saveAll('clients',ST.clients);
    Store.saveAll('matters',ST.matters);
    Store.saveAll('entries',ST.entries);
    Store.saveAll('contacts',ST.contacts);
    Store.saveAll('invoices',ST.invoices);
    Store.setMeta('prefs',ST.prefs);
    Store.setMeta('descpresets',ST.descPresets);
    Store.setMeta('mailpresets',ST.mailPresets);
    Store.saveAll('emailtemplates',ST.emailTemplates);
    Store.setMeta('itmode',{itMode:ST.itMode,firmProfile:ST.firmProfile});
  },400);
}
function savePrefs(){
  Store.setMeta('prefs',ST.prefs);
  applyPrefs();
}
function applyPrefs(){
  var b=document.body;
  // Dark mode: null=auto (follow system), true=always dark, false=always light
  var dm=ST.prefs.darkMode;
  var sysDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(dm===true||(dm===null&&sysDark)) b.classList.add('dark'); else b.classList.remove('dark');
  // Layout
  b.classList.remove('layout-compact','layout-comfortable','layout-spacious');
  if(ST.prefs.layout&&ST.prefs.layout!=='comfortable') b.classList.add('layout-'+ST.prefs.layout);
  // Title bar
  document.title=ST.prefs.appName||'SixMinuteLog.com';
}
// Re-apply when OS theme changes (only affects users in auto mode)
if(window.matchMedia){
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(){
    applyPrefs();
  });
}

// === TOAST
function toast(msg,type){
  type=type||'ok';
  var el=document.createElement('div');
  el.className='toast t-'+type;
  el.textContent=msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(function(){el.remove();},3000);
}

// === ICONS
var IC={
  plus:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  x:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  save:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
  edit:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
  trash:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  clock:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  users:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  brief:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
  chart:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
  doc:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  gear:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
  help:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><circle cx="12" cy="17" r="1" fill="currentColor" stroke="none"/></svg>',
  dl:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  ul:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
  rst:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>',
  usr:'<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  flash:'<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  pie:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>',
  check:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  checkLg:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
  shield:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
  xsm:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  moon:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
  sun:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
  mail:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
  list:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
  paint:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 13.5V20h6.5"/><path d="M22 13.5C22 6 17 2 12 2S2 6 2 13.5"/><circle cx="16.5" cy="20.5" r="2.5"/><path d="M16.5 18v-5"/></svg>',
  invoice:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',
  print:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>',
  scissors:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>',
  merge:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6v6m0 0v6m0-6h8m0 0l-4-4m4 4l-4 4"/></svg>',
  comment:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
  eye:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
  send:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
  copy:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>'
};

// === FIELD BUILDER
function field(label,id,o){
  o=o||{};
  var req=o.req?'<span class="req">*</span>':'';
  var ec=o.err?'err':'';
  var oninput=o.oninput?' oninput="'+o.oninput+'"':'';
  var ctrl='';
  if(o.type==='select'){
    var opts=(o.opts||[]).map(function(op){
      return '<option value="'+H(op.v)+'"'+(String(op.v)===String(o.val||'')?'selected':'')+'>'+H(op.l)+'</option>';
    }).join('');
    ctrl='<select id="'+id+'" class="'+ec+'"'+(o.dis?' disabled':'')+oninput+'>'+opts+'</select>';
  } else if(o.type==='textarea'){
    ctrl='<textarea id="'+id+'" rows="'+(o.rows||3)+'" class="'+ec+'" placeholder="'+H(o.ph||'')+'">'+H(o.val||'')+'</textarea>';
  } else if(o.pfx||o.sfx){
    var sfxHtml=o.sfx?'<span class="sfx">'+o.sfx+'</span>':'';
    var hasSfxCls=o.sfx?' has-sfx':'';
    ctrl='<div class="pw">'+(o.pfx?'<span class="pfx">'+o.pfx+'</span>':'')+sfxHtml+'<input type="'+(o.type||'text')+'" id="'+id+'" class="'+ec+hasSfxCls+'" placeholder="'+H(o.ph||'')+'" value="'+H(o.val||'')+'"'+(o.dis?' disabled':'')+oninput+' /></div>';
  } else {
    ctrl='<input type="'+(o.type||'text')+'" id="'+id+'" class="'+ec+'" placeholder="'+H(o.ph||'')+'" value="'+H(o.val||'')+'"'+(o.dis?' disabled':'')+oninput+(o.step?' step="'+o.step+'"':'')+(o.min!==undefined?' min="'+o.min+'"':'')+(o.max!==undefined?' max="'+o.max+'"':'')+' />';
  }
  return '<div class="fl"><label for="'+id+'">'+H(label)+req+'</label>'+ctrl
    +(o.err?'<div class="emsg">'+H(o.err)+'</div>':'')
    +(o.hint&&!o.err?'<div class="hint">'+o.hint+'</div>':'')
    +'</div>';
}

function stats(arr){
  return '<div class="srow">'+arr.map(function(s){
    return '<div class="sc'+(s[2]?' '+s[2]:'')+'"><div class="sc-lbl">'+H(s[0])+'</div><div class="sc-val">'+H(String(s[1]))+'</div></div>';
  }).join('')+'</div>';
}

// === EXPORT FILENAME GENERATOR
function exportFilename(){
  var s=ST.settings;
  var parts=[];
  if(s.te) parts.push('entries');
  if(s.cl) parts.push('clients');
  if(s.ma) parts.push('matters');
  if(s.co) parts.push('contacts');
  if(s.su) parts.push('summary');
  if(s.split) parts.push('split');
  var label=parts.length===0?'empty'
    :parts.length>=6?'full'
    :parts.join('+');
  var now=new Date();
  var ds=now.toISOString().split('T')[0];
  var ts=pad2(now.getHours())+pad2(now.getMinutes());
  // Date range suffix
  var range='';
  if(s.expFrom&&s.expTo) range='_'+s.expFrom+'_to_'+s.expTo;
  else if(s.expFrom) range='_from_'+s.expFrom;
  else if(s.expTo) range='_to_'+s.expTo;
  return 'billing-'+label+'_'+ds+'_'+ts+range+'.csv';
}

// === VIEWS

// == Timesheet ==
function vTimesheet(){
  var role=myRole();
  var me=ST.user?ST.user.name:'';
  var fe=filterEnt(ST.entries,ST.tsFilter);
  // Extra filters
  if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
  if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
  // Sort
  var sorted=[].concat(fe).sort(function(a,b){
    if(ST.tsSort==='date-asc') return new Date(a.date)-new Date(b.date);
    if(ST.tsSort==='client'){
      var ca=_lu.cl[a.clientId];
      var cb=_lu.cl[b.clientId];
      return ((ca&&ca.name)||'').localeCompare((cb&&cb.name)||'');
    }
    if(ST.tsSort==='hours') return Number(b.hours)-Number(a.hours);
    if(ST.tsSort==='amount') return (Number(b.hours)*Number(b.rate))-(Number(a.hours)*Number(a.rate));
    return new Date(b.date)-new Date(a.date); // date-desc default
  });
  var hrs=fe.reduce(function(s,e){return s+Number(e.hours);},0);
  var bill=fe.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
  var pending=fe.filter(function(e){return (e.status||'approved')==='pending';}).length;
  var fopts=['all','today','week','month','year'].map(function(v){
    var l={all:'All Time',today:'Today',week:'This Week',month:'This Month',year:'This Year'}[v];
    return '<option value="'+v+'"'+(ST.tsFilter===v?' selected':'')+'>'+l+'</option>';
  }).join('');
  var formH=ST.modal==='ef'?entryForm():'';
  var noticeH='';
  if(role==='billing_staff'){
    noticeH='<div class="role-notice">'+IC.shield+' <span><strong>View-only mode.</strong> You can view and export entries, but cannot add or edit them.</span></div>';
  } else if(role==='attorney'&&pending>0){
    noticeH='<div class="role-notice">'+IC.clock+' <span><strong>'+pending+' entr'+(pending===1?'y':'ies')+' awaiting partner approval.</strong></span></div>';
  }
  var tableH='';
  if(sorted.length===0){
    tableH='<div class="empty"><div class="empty-ico">&#9201;</div><p>No entries yet</p><small>Click "New Entry" or tap &#9889; to get started</small></div>';
  } else {
    var showApprCols=(role==='partner'||role==='attorney');
    var rows=sorted.map(function(e){
      var cl=_lu.cl[e.clientId];
      var mt=_lu.ma[e.matterId];
      var ct=_lu.ct[e.contactId];
      var amt=Number(e.hours)*Number(e.rate);
      var st=e.status||'approved';
      var canEdit=false,canDelete=false,canApprove=false;
      if(role==='partner'){canEdit=true;canDelete=true;canApprove=(st==='pending');}
      else if(role==='attorney'){canEdit=(e.createdBy===me&&st==='pending');canDelete=(e.createdBy===me&&st==='pending');}
      var actionsH='<div class="tda">';
      if(canApprove){actionsH+='<button onclick="A.approveEnt('+e.id+')" title="Approve" style="color:var(--green)">'+IC.check+'</button><button onclick="A.openPartnerReview('+e.id+')" title="Review & Edit" style="color:var(--blue)">'+IC.edit+'</button><button onclick="A.rejectEnt('+e.id+')" title="Reject" style="color:var(--red)">'+IC.xsm+'</button>';}
      if(canEdit) actionsH+='<button onclick="A.editEnt('+e.id+')" title="Edit">'+IC.edit+'</button>';
      if(canDelete) actionsH+='<button onclick="A.delEnt('+e.id+')" title="Delete">'+IC.trash+'</button>';
      actionsH+='</div>';
      return '<tr>'
        +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
        +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
        +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+'</td>'
        +'<td style="color:var(--ink2)">'+H(ct?ct.name:'\u2014')+'</td>'
        +'<td style="color:var(--ink2);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+H(e.description||'')+'">'+H(e.description||'\u2014')+(e.partnerComment?'<span title="Partner note: '+H(e.partnerComment)+'" style="margin-left:4px;font-size:11px;color:var(--amber);cursor:help">&#128172;</span>':'')+(e.partnerEdited?'<span title="Partner adjusted this entry" style="margin-left:2px;font-size:10px;color:var(--amber);cursor:help">*</span>':'')+'</td>'
        +'<td>'+(e.rawMs!=null?'<span title="Exact timer: '+msToHMS(e.rawMs)+' | Stored: '+Number(e.hours).toFixed(4)+'h" style="cursor:help;border-bottom:1px dotted var(--ink3)">'+$h(e.hours)+'</span>':$h(e.hours))+(e.finalized?' <span style="font-size:10px;color:var(--green);font-weight:500" title="Finalized entry (grouped & rounded)">✓</span>':'')+'</td>'
        +'<td style="color:var(--ink2)">'+$m(e.rate)+'</td>'
        +'<td style="color:var(--green);font-weight:500">'+$m(amt)+'</td>'
        +'<td><span class="badge" title="'+H(e.createdBy||'')+'">'+H(e.createdByIni||'?')+'</span></td>'
        +(showApprCols?'<td>'+statusBadge(st)+'</td>':'')
        +'<td>'+actionsH+'</td>'
        +'</tr>';
    }).join('');
    tableH='<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Team</th><th>Description</th><th>Hours</th><th>Rate</th><th>Amount</th><th>By</th>'+(showApprCols?'<th>Status</th>':'')+'<th></th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>';
  }
  var statRows=[['Total Hours',$h(hrs),''],['Total Billing',$m(bill),''],['Avg Rate',hrs>0?$m(bill/hrs):'\u2014',''],['Entries',String(fe.length),'']];
  if(role!=='billing_staff'&&pending>0) statRows.push(['Pending Approval',String(pending),'highlight2']);
  var clFilterOpts='<option value="">All Clients</option>'+ST.clients.map(function(c){return '<option value="'+c.id+'"'+(ST.tsClientFilter==c.id?' selected':'')+'>'+H(c.name)+'</option>';}).join('');
  var availMa=ST.tsMatterFilter?ST.matters:ST.matters.filter(function(m){return !ST.tsClientFilter||m.clientId==ST.tsClientFilter;});
  var maFilterOpts='<option value="">All Matters</option>'+availMa.map(function(m){return '<option value="'+m.id+'"'+(ST.tsMatterFilter==m.id?' selected':'')+'>'+H(m.name)+'</option>';}).join('');
  var sortOpts=[['date-desc','Date \u2193'],['date-asc','Date \u2191'],['client','Client A\u2013Z'],['hours','Hours \u2193'],['amount','Amount \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.tsSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  var selectStyle='padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)';
  var hasExtra=(ST.tsClientFilter||ST.tsMatterFilter||ST.tsSort!=='date-desc');
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Timesheet</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+fe.length+' entr'+(fe.length===1?'y':'ies')+'</p></div>'
    +'<div style="display:flex;gap:10px;flex-wrap:wrap">'
    +(role!=='billing_staff'?'<button class="btn btn-dk" onclick="A.openEF()">'+IC.plus+' New Entry</button>':'')
    +(role!=='billing_staff'&&fe.filter(function(e){return !e.finalized;}).length>0?'<button class="btn btn-gr" onclick="A.finalizeEntries()" title="Group identical entries by day with rounded total hours">Finalize Entries</button>':'')
    +(fe.length>0&&role==='attorney'?'<button class="btn btn-gh" onclick="A.emailEntriesApproval()" style="gap:5px" title="Email visible entries to a partner for approval">'+IC.mail+' Email for Approval</button>':'')
    +(fe.length>0&&role==='partner'?'<button class="btn btn-gh" onclick="A.emailEntriesSummary()" style="gap:5px" title="Email billing summary to staff or partners">'+IC.mail+' Email Summary</button>':'')
    +'</div></div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<select onchange="A.setTsF(this.value)" style="'+selectStyle+'">'+fopts+'</select>'
    +(ST.clients.length>0?'<select onchange="A.setTsClF(this.value)" style="'+selectStyle+'">'+clFilterOpts+'</select>':'')
    +(ST.matters.length>0?'<select onchange="A.setTsMaF(this.value)" style="'+selectStyle+'">'+maFilterOpts+'</select>':'')
    +'<select onchange="A.setTsSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(hasExtra?'<button class="btn btn-gh" onclick="A.clearTsFilters()" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>'
    +noticeH
    +stats(statRows)
    +formH+tableH+'</div>';
}

function entryForm(){
  var role=myRole();
  var f=ST.ef;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var avMat=ST.matters.filter(function(m){return m.clientId==f.clientId;});
  var maOpts=[{v:'',l:'General work'}].concat(avMat.map(function(m){return{v:m.id,l:m.name};}));
  var ctOpts=[{v:'',l:'Select team member...'}].concat(ST.contacts.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  var matHint=!f.clientId?'Select a client first':(avMat.length===0?'No matters for this client':'');
  var existingStatus=ST.editId?(ST.entries.find(function(e){return e.id==ST.editId;})||{}).status||'approved':null;
  var statusNotice='';
  if(existingStatus&&existingStatus!=='pending'){
    statusNotice='<div class="'+(existingStatus==='approved'?'good':'danger')+'" style="margin-bottom:14px">Status: '+statusBadge(existingStatus)+(existingStatus==='approved'?' - This entry has been approved by a partner.':' - This entry was rejected.')+'</div>';
  } else if(!ST.editId&&role==='attorney'){
    statusNotice='<div class="role-notice" style="margin-bottom:14px">'+IC.clock+' Your entry will be submitted for partner approval.</div>';
  }
  return '<div class="fbox" id="ef">'
    +'<h3>'+(ST.editId?'Edit Entry':'New Time Entry')+'</h3>'
    +statusNotice
    +'<div class="frow c2">'+field('Date','ef-d',{type:'date',val:f.date||today(),req:true,err:f.errs&&f.errs.d})+field('Hours','ef-h',{type:'number',ph:'1.0',val:f.hours||'',req:true,err:f.errs&&f.errs.h,hint:'e.g. 1.5 or 0.25',step:'0.01',min:'0.01'})+'</div>'
    +'<div class="frow c2">'+field('Client','ef-cl',{type:'select',opts:clOpts,val:f.clientId||'',req:true,err:f.errs&&f.errs.cl})+field('Matter','ef-ma',{type:'select',opts:maOpts,val:f.matterId||'',hint:matHint})+'</div>'
    +'<div class="frow c2">'+field('Team Member','ef-ct',{type:'select',opts:ctOpts,val:f.contactId||''})+field('Rate ($/hr)','ef-r',{pfx:'$',ph:'150.00',val:f.rate||'',req:true,err:f.errs&&f.errs.r,hint:total?'Total: '+total+'. Priority: Your rate > Contact > Matter > Client':'Priority: Your rate > Contact > Matter > Client'})+'</div>'
    +'<div class="frow">'+field('Description','ef-desc',{type:'textarea',rows:2,ph:'Describe the work performed...',val:f.description||''})+'</div>'
    +(ST.descPresets.length>0?'<div class="desc-chips"><span style="font-size:11px;color:var(--ink3);margin-right:4px">Suggestions:</span>'+ST.descPresets.map(function(p,i){return '<button type="button" class="desc-chip" onclick="A.pickDesc(\'ef-desc\','+i+')">'+ H(p)+'</button>';}).join('')+'</div>':'')
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveEnt()">'+IC.save+' '+(role==='attorney'&&!ST.editId?'Submit for Approval':'Save Entry')+'</button></div>'
    +'</div>';
}

// == Clients ==
function vClients(){
  var formH=ST.modal==='cf'?clientForm():'';
  var cardsH='';
  var list=ST.clients;
  // Search
  if(ST.clSearch) list=list.filter(function(c){var s=ST.clSearch.toLowerCase();return c.name.toLowerCase().indexOf(s)!==-1||(c.email&&c.email.toLowerCase().indexOf(s)!==-1);});
  // Sort
  list=[].concat(list).sort(function(a,b){
    if(ST.clSort==='matters'){
      var mc=function(c){return ST.matters.filter(function(m){return m.clientId==c.id;}).length;};
      return mc(b)-mc(a);
    }
    if(ST.clSort==='rate') return Number(b.rate||0)-Number(a.rate||0);
    return a.name.localeCompare(b.name); // alpha
  });
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var sortOpts=[['alpha','Name A\u2013Z'],['matters','Most Matters'],['rate','Rate \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.clSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  if(ST.clients.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128188;</div><p>No clients yet</p><small>Add your first client to get started</small></div>';
  } else if(list.length===0){
    cardsH='<div class="empty"><p>No clients match your search</p></div>';
  } else {
    cardsH='<div class="cgrid">'+list.map(function(c){
      // Support both legacy contactId and new contactIds[]
      var ctIds=c.contactIds&&c.contactIds.length?c.contactIds:(c.contactId?[c.contactId]:[]);
      var linkedCts=ctIds.map(function(id){return _lu.ct[id];}).filter(Boolean);
      var cppl=c.clientPeople&&c.clientPeople.length?c.clientPeople:[];
      // Find most recent approved invoice for this client
      var clientInvs=(ST.invoices||[]).filter(function(i){return i.clientId==c.id&&i.status==='approved';});
      clientInvs.sort(function(a,b){return b.id-a.id;});
      var latestApproved=clientInvs[0]||null;
      return '<div class="card">'
        +'<div class="card-hd"><div class="avatar">'+H(c.name.charAt(0).toUpperCase())+'</div>'
        +'<div class="card-act">'
        +(latestApproved?'<button onclick="A.emailInvoice('+latestApproved.id+')" title="Email latest invoice to client" style="color:var(--blue)">'+IC.mail+'</button>':'')
        +'<button onclick="A.editCl('+c.id+')" title="Edit">'+IC.edit+'</button><button onclick="A.delCl('+c.id+')" title="Delete">'+IC.trash+'</button></div></div>'
        +'<h3>'+H(c.name)+'</h3>'
        +(c.email?'<p style="font-size:12px">'+H(c.email)+'</p>':'')
        +(c.phone?'<p style="font-size:12px">'+H(c.phone)+'</p>':'')
        +(cppl.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Client Contacts</div>'
          +cppl.map(function(p){return '<div style="font-size:12px;padding:2px 0"><strong>'+H(p.name)+'</strong>'+(p.role?' <span style="color:var(--ink3)">&middot; '+H(p.role)+'</span>':'')+(p.email?'<br><span style="color:var(--ink2)">'+H(p.email)+'</span>':'')+(p.phone?'<span style="color:var(--ink3);font-size:11px"> '+H(p.phone)+'</span>':'')+'</div>';}).join('')+'</div>':'')
        +(linkedCts.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Firm Team</div>'
          +linkedCts.map(function(ct){return '<p style="font-size:12px;margin:2px 0">&#128203; '+H(ct.name)+(ct.role?' <span style="color:var(--ink3)">&middot; '+H(ct.role)+'</span>':'')+'</p>';}).join('')+'</div>':'')
        +(c.rate?'<div class="card-rate">Default rate <strong>'+$m(c.rate)+'/hr</strong></div>':'')
        +'<div class="card-rate" style="border-top:none;padding-top:0;margin-top:6px">'
        +(function(){var mc=ST.matters.filter(function(m){return m.clientId==c.id;}).length;return '<span style="color:var(--ink3)">'+mc+' matter'+(mc!==1?'s':'')+'</span>';})()
        +'</div>'
        +'</div>';
    }).join('')+'</div>';
  }
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Clients</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+list.length+' of '+ST.clients.length+' client'+(ST.clients.length!==1?'s':'')+'</p></div>'
    +'<button class="btn btn-dk" onclick="A.openCF()">'+IC.plus+' Add Client</button>'
    +'</div>'
    +(ST.clients.length>1?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="cl-search" type="text" value="'+H(ST.clSearch||'')+'" oninput="A.setClSearch(this.value)" placeholder="Search clients..." style="'+selectStyle+';min-width:160px">'
    +'<select onchange="A.setClSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(ST.clSearch?'<button class="btn btn-gh" onclick="A.setClSearch(\'\')" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function clientForm(){
  var f=ST.cf;
  var selIds=f.contactIds||((f.contactId&&f.contactId!='')?[Number(f.contactId)]:[]);
  // Firm contacts not yet added
  var available=ST.contacts.filter(function(c){return !selIds.some(function(id){return id==c.id;});});
  var ctOpts=[{v:'',l:'Add team member...'}].concat(available.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  // Firm contact chips
  var chipsH=selIds.length===0?''
    :selIds.map(function(id){
        var c=_lu.ct[id];
        if(!c) return '';
        return '<span style="display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px 3px 8px;font-size:12px;margin:2px">'
          +'<span class="avatar" style="width:18px;height:18px;font-size:9px;flex-shrink:0">'+H(c.name.charAt(0).toUpperCase())+'</span>'
          +H(c.name)+(c.role?'<span style="color:var(--ink3)"> &middot; '+H(c.role)+'</span>':'')
          +(c.isUser?'<span style="font-size:10px;font-weight:600;color:var(--blue)">You</span>':'')
          +'<button type="button" onclick="A.cfRemCt('+id+')" style="background:none;border:none;cursor:pointer;padding:0;line-height:1;color:var(--ink3);font-size:14px;margin-left:2px" title="Remove">&times;</button>'
          +'</span>';
      }).join('');
  var chipsRow=selIds.length>0?'<div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:4px">'+chipsH+'</div>':'';
  // Client-side people chips
  var cppl=f.clientPeople||[];
  var ppChips=cppl.length===0?''
    :'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">'+cppl.map(function(p,i){
        return '<span style="display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px 3px 8px;font-size:12px">'
          +'<span class="avatar" style="width:18px;height:18px;font-size:9px;background:#7c3aed;color:#fff;flex-shrink:0">'+H(p.name.charAt(0).toUpperCase())+'</span>'
          +H(p.name)+(p.role?'<span style="color:var(--ink3)"> &middot; '+H(p.role)+'</span>':'')
          +(p.email?'<span style="color:var(--ink2);font-size:11px"> '+H(p.email)+'</span>':'')
          +'<button type="button" onclick="A.cfRemPerson('+i+')" style="background:none;border:none;cursor:pointer;padding:0;line-height:1;color:var(--ink3);font-size:14px;margin-left:2px" title="Remove">&times;</button>'
          +'</span>';
      }).join('')+'</div>';
  var np=f.newPerson||{};
  return '<div class="fbox" id="cf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Client</h3>'
    +'<div class="frow">'+field('Client Name','cf-n',{ph:'Acme Corp',val:f.name||'',req:true,err:f.errs&&f.errs.n})+'</div>'
    +'<div class="frow c2">'+field('Email','cf-e',{type:'email',ph:'billing@acme.com',val:f.email||'',err:f.errs&&f.errs.e})+field('Phone','cf-p',{type:'tel',ph:'(555) 123-4567',val:f.phone||'',oninput:"A.livePhone('cf-p')"})+'</div>'
    +'<div class="frow c2">'+field('Default Rate ($/hr)','cf-r',{pfx:'$',ph:'250.00',val:f.rate||'',hint:'Used unless overridden by matter/contact'})+field('Firm Team','cf-ct',{type:'select',opts:ctOpts,val:'',hint:'Assign firm contacts to this client'})+'</div>'
    +(chipsRow?'<div class="frow" style="padding-top:0;margin-top:-8px"><div>'+chipsRow+'</div></div>':'')
    // Client-side contacts section
    +'<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
    +'<div style="font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:10px">Client-Side Contacts <span style="font-size:11px;font-weight:400;color:var(--ink3)">(owner, HR, billing, etc.)</span></div>'
    +ppChips
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px">'
    +'<div class="fl"><label style="font-size:11px">Name</label><input type="text" id="cf-pn" placeholder="Jane Smith" value="'+H(np.name||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Role / Title</label><input type="text" id="cf-pro" placeholder="Head of HR" value="'+H(np.role||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Email</label><input type="email" id="cf-pe" placeholder="jane@acme.com" value="'+H(np.email||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Phone</label><input type="tel" id="cf-pp" placeholder="(555) 123-4567" value="'+H(np.phone||'')+'" oninput="A.livePhone(\'cf-pp\')" style="width:100%"></div>'
    +'</div>'
    +'<button type="button" class="btn btn-gh" style="font-size:12px;padding:6px 14px" onclick="A.cfAddPerson()">+ Add Contact</button>'
    +'</div></div>'
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveCl()">'+IC.save+' Save Client</button></div>'
    +'</div>';
}

// == Matters ==
function vMatters(){
  var formH=ST.modal==='mf'?matterForm():'';
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var clFilterOpts='<option value="">All Clients</option>'+ST.clients.map(function(c){return '<option value="'+c.id+'"'+(ST.maClientFilter==c.id?' selected':'')+'>'+H(c.name)+'</option>';}).join('');
  var sortOpts=[['alpha','Name A\u2013Z'],['client','Client A\u2013Z'],['rate','Rate \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.maSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  var cardsH='';
  if(ST.matters.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128193;</div><p>No matters yet</p><small>'+(ST.clients.length===0?'Add a client first, then create matters':'Add your first matter')+'</small></div>';
  } else {
    // Apply filters
    var list=ST.matters;
    if(ST.maClientFilter) list=list.filter(function(m){return m.clientId==ST.maClientFilter;});
    if(ST.maSearch) list=list.filter(function(m){var s=ST.maSearch.toLowerCase();return m.name.toLowerCase().indexOf(s)!==-1||(m.description&&m.description.toLowerCase().indexOf(s)!==-1);});
    // Sort
    list=[].concat(list).sort(function(a,b){
      if(ST.maSort==='client'){
        var ca=_lu.cl[a.clientId];
        var cb=_lu.cl[b.clientId];
        var cn=((ca&&ca.name)||'').localeCompare((cb&&cb.name)||'');
        if(cn!==0) return cn;
        return a.name.localeCompare(b.name);
      }
      if(ST.maSort==='rate'){
        var ra=a.rate||(_lu.cl[a.clientId]||{}).rate||0;
        var rb=b.rate||(_lu.cl[b.clientId]||{}).rate||0;
        return Number(rb)-Number(ra);
      }
      return a.name.localeCompare(b.name);
    });
    if(list.length===0){
      cardsH='<div class="empty"><p>No matters match your filters</p></div>';
    } else if(ST.maGroup){
      // Grouped by client
      var groups={};var gOrder=[];
      list.forEach(function(m){
        var key=m.clientId||'__none__';
        if(!groups[key]){groups[key]=[];gOrder.push(key);}
        groups[key].push(m);
      });
      cardsH=gOrder.map(function(key){
        var cl=_lu.cl[key];
        var gName=cl?H(cl.name):'<em>No Client</em>';
        var cards=groups[key].map(function(m){return matterCard(m);}).join('');
        return '<div style="margin-bottom:18px">'
          +'<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:8px;display:flex;align-items:center;gap:8px">'
          +'<span style="flex:1;height:1px;background:var(--border-l)"></span>'
          +'<span>'+gName+'</span>'
          +'<span style="flex:1;height:1px;background:var(--border-l)"></span>'
          +'</div>'
          +'<div class="cgrid">'+cards+'</div>'
          +'</div>';
      }).join('');
    } else {
      cardsH='<div class="cgrid">'+list.map(function(m){return matterCard(m);}).join('')+'</div>';
    }
  }
  var addBtn=ST.clients.length>0
    ?'<button class="btn btn-dk" onclick="A.openMF()">'+IC.plus+' Add Matter</button>'
    :'<span style="font-size:13px;color:var(--amber);background:#fffbeb;padding:8px 14px;border-radius:8px;border:1px solid #fde68a">Add a client first</span>';
  var hasFilters=(ST.maClientFilter||ST.maSearch||ST.maSort!=='alpha'||ST.maGroup);
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Matters</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+ST.matters.length+' matter'+(ST.matters.length!==1?'s':'')+'</p></div>'
    +addBtn+'</div>'
    +(ST.matters.length>0?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="ma-search" type="text" value="'+H(ST.maSearch||'')+'" oninput="A.setMaSearch(this.value)" placeholder="Search matters..." style="'+selectStyle+';min-width:160px">'
    +(ST.clients.length>1?'<select onchange="A.setMaClF(this.value)" style="'+selectStyle+'">'+clFilterOpts+'</select>':'')
    +'<select onchange="A.setMaSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +'<label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;padding:7px 11px;border:1px solid var(--border);border-radius:8px;background:'+(ST.maGroup?'var(--bg)':'var(--white)')+'"><input type="checkbox" '+(ST.maGroup?'checked':'')+' onchange="A.toggleMaGroup()" style="margin:0"> Group by Client</label>'
    +(hasFilters?'<button class="btn btn-gh" onclick="A.clearMaFilters()" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function matterCard(m){
  var cl=_lu.cl[m.clientId];
  var ct=_lu.ct[m.contactId];
  var rate=m.rate||(cl&&cl.rate);
  // Resolve linked client-side people
  var linkedPeople=[];
  if(m.linkedClientPeopleIds&&m.linkedClientPeopleIds.length&&cl&&cl.clientPeople){
    linkedPeople=m.linkedClientPeopleIds.map(function(pid){
      return cl.clientPeople.find(function(p){return p.id==pid;});
    }).filter(Boolean);
  }
  return '<div class="card">'
    +'<div class="card-hd"><span class="chip">'+H(cl?cl.name:'Unknown')+'</span>'
    +'<div class="card-act"><button onclick="A.editMa('+m.id+')" title="Edit">'+IC.edit+'</button><button onclick="A.delMa('+m.id+')" title="Delete">'+IC.trash+'</button></div></div>'
    +'<h3>'+H(m.name)+'</h3>'
    +(ct?'<p style="font-size:12px">&#128203; '+H(ct.name)+(ct.role?'<span style="color:var(--ink3)"> &middot; '+H(ct.role)+'</span>':'')+'</p>':'')
    +(linkedPeople.length?'<div style="margin:5px 0 3px;border-top:1px solid var(--border-l);padding-top:6px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:4px">Client Contacts</div>'
      +linkedPeople.map(function(p){return '<div style="font-size:12px;padding:2px 0"><strong>'+H(p.name)+'</strong>'+(p.role?' <span style="color:var(--ink3)">&middot; '+H(p.role)+'</span>':'')+(p.email?'<br><span style="color:var(--ink2)">'+H(p.email)+'</span>':'')+'</div>';}).join('')
      +'</div>':'')
    +(m.description?'<p style="color:var(--ink3);font-size:12px">'+H(m.description)+'</p>':'')
    +(rate?'<div class="card-rate">'+(m.rate?'Matter rate':'Client rate')+' <strong>'+$m(rate)+'/hr</strong></div>':'')
    +'</div>';
}

function matterForm(){
  var f=ST.mf;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var ctOpts=[{v:'',l:'None'}].concat(ST.contacts.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  var selCl=ST.clients.find(function(c){return c.id==f.clientId;});
  var hint=selCl&&selCl.rate?'Client default: '+$m(selCl.rate)+'/hr':'Uses client default if blank';
  // Client-side people for the selected client
  var cppl=selCl&&selCl.clientPeople&&selCl.clientPeople.length?selCl.clientPeople:[];
  var linkedIds=f.linkedClientPeopleIds||[];
  var cpSection='';
  if(f.clientId&&cppl.length){
    var pChips=cppl.map(function(p){
      var pid=p.id;
      var sel=linkedIds.some(function(x){return x==pid;});
      return '<button type="button" onclick="A.mfToggleClientPerson('+pid+')" style="display:inline-flex;align-items:center;gap:5px;border-radius:20px;padding:4px 11px 4px 8px;font-size:12px;cursor:pointer;border:1px solid '+(sel?'var(--blue)':'var(--border)')+';background:'+(sel?'rgba(37,99,235,.09)':'var(--white)')+';color:'+(sel?'var(--blue)':'var(--ink)')+';transition:all .15s">'
        +'<span style="width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:'+(sel?'var(--blue)':'#7c3aed')+';color:#fff;flex-shrink:0">'+H(p.name.charAt(0).toUpperCase())+'</span>'
        +H(p.name)+(p.role?'<span style="color:var(--ink3)"> &middot; '+H(p.role)+'</span>':'')
        +(sel?'<span style="font-size:14px;line-height:1;margin-left:2px;color:var(--blue)">&#10003;</span>':'')
        +'</button>';
    }).join('');
    cpSection='<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
      +'<div style="font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:8px">Client-Side Contacts <span style="font-size:11px;font-weight:400;color:var(--ink3)">linked to this matter</span></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:6px">'+pChips+'</div>'
      +(linkedIds.length?'<p style="font-size:11px;color:var(--ink3);margin-top:6px">'+linkedIds.length+' contact'+(linkedIds.length!==1?'s':'')+' linked</p>':'<p style="font-size:11px;color:var(--ink3);margin-top:6px">Click to link contacts from this client</p>')
      +'</div></div>';
  } else if(f.clientId&&!cppl.length){
    cpSection='<div class="frow"><p class="note" style="font-size:12px;width:100%;margin:0">No client-side contacts on this client yet. <a onclick="A.editCl('+f.clientId+');return false;" href="#" style="color:var(--blue)">Edit the client</a> to add contacts first.</p></div>';
  }
  return '<div class="fbox" id="mf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Matter</h3>'
    +'<div class="frow c2">'+field('Matter Name','mf-n',{ph:'Contract Review',val:f.name||'',req:true,err:f.errs&&f.errs.n})+field('Client','mf-cl',{type:'select',opts:clOpts,val:f.clientId||'',req:true,err:f.errs&&f.errs.cl})+'</div>'
    +'<div class="frow">'+field('Description','mf-desc',{type:'textarea',rows:2,ph:'Brief description of this matter...',val:f.description||''})+'</div>'
    +'<div class="frow c2">'+field('Billing Rate ($/hr)','mf-r',{pfx:'$',ph:'Override rate...',val:f.rate||'',hint:hint})+field('Lead Attorney','mf-ct',{type:'select',opts:ctOpts,val:f.contactId||''})+'</div>'
    +cpSection
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveMa()">'+IC.save+' Save Matter</button></div>'
    +'</div>';
}

// == Contacts ==
function vContacts(){
  var formH=ST.modal==='ctf'?contactForm():'';
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var sortOpts=[['alpha','Name A\u2013Z'],['role','Role A\u2013Z'],['rate','Rate \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.ctSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  var cardsH='';
  if(ST.contacts.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128100;</div><p>No contacts yet</p><small>Add team members to track who worked on what</small></div>';
  } else {
    var list=ST.contacts;
    if(ST.ctSearch) list=list.filter(function(c){var s=ST.ctSearch.toLowerCase();return c.name.toLowerCase().indexOf(s)!==-1||(c.role&&c.role.toLowerCase().indexOf(s)!==-1)||(c.email&&c.email.toLowerCase().indexOf(s)!==-1);});
    list=[].concat(list).sort(function(a,b){
      if(ST.ctSort==='role') return ((a.role||'')).localeCompare((b.role||''));
      if(ST.ctSort==='rate') return Number(b.rate||0)-Number(a.rate||0);
      return a.name.localeCompare(b.name);
    });
    if(list.length===0){
      cardsH='<div class="empty"><p>No contacts match your search</p></div>';
    } else {
      cardsH='<div class="cgrid">'+list.map(function(c){
        var pct=c.ownPct!=null?Number(c.ownPct):100;
        var firmPct=100-pct;
        var isMe=!!c.isUser;
        return '<div class="card">'
          +'<div class="card-hd"><div class="avatar avatar-dark">'+H(c.name.charAt(0).toUpperCase())+'</div>'
          +'<div class="card-act">'+(isMe?'<span style="font-size:11px;font-weight:600;color:var(--blue);background:rgba(37,99,235,.1);padding:2px 8px;border-radius:10px;margin-right:4px">You</span>':'')+'<button onclick="A.editCt('+c.id+')" title="Edit">'+IC.edit+'</button>'+(isMe?'':'<button onclick="A.delCt('+c.id+')" title="Delete">'+IC.trash+'</button>')+'</div></div>'
          +'<h3>'+H(c.name)+'</h3>'
          +(c.role?'<p style="color:var(--ink2)">'+H(c.role)+'</p>':'')
          +(c.email?'<p>'+H(c.email)+'</p>':'')
          +(c.phone?'<p>'+H(c.phone)+'</p>':'')
          +(ST.prefs.revenueSplit?'<div class="split-pill"><span class="own">Own '+pct+'%</span><span class="firm">Firm '+firmPct+'%</span></div>':'')
          +(ST.prefs.revenueSplit&&c.salary!=null&&c.salary!==''?'<div class="card-rate">Salary <strong>'+$m(c.salary)+'/yr</strong></div>':'')
          +(c.rate?'<div class="card-rate">Rate <strong>'+$m(c.rate)+'/hr</strong></div>':'')
          +'</div>';
      }).join('')+'</div>';
    }
  }
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Team Contacts</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+ST.contacts.length+' contact'+(ST.contacts.length!==1?'s':'')+'</p></div>'
    +'<button class="btn btn-dk" onclick="A.openCTF()">'+IC.plus+' Add Contact</button>'
    +'</div>'
    +(ST.contacts.length>1?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="ct-search" type="text" value="'+H(ST.ctSearch||'')+'" oninput="A.setCtSearch(this.value)" placeholder="Search contacts..." style="'+selectStyle+';min-width:160px">'
    +'<select onchange="A.setCtSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(ST.ctSearch?'<button class="btn btn-gh" onclick="A.setCtSearch(\'\')" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function contactForm(){
  var f=ST.ctf;
  var pct=f.ownPct!=null?f.ownPct:100;
  return '<div class="fbox" id="ctf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Contact</h3>'
    +'<div class="frow c2">'+field('Name','ctf-n',{ph:'Jane Smith',val:f.name||'',req:true,err:f.errs&&f.errs.n})+field('Role / Title','ctf-ro',{ph:'Associate Attorney',val:f.role||''})+'</div>'
    +'<div class="frow c2">'+field('Email','ctf-e',{type:'email',ph:'jane@firm.com',val:f.email||'',err:f.errs&&f.errs.e})+field('Phone','ctf-p',{type:'tel',ph:'(555) 123-4567',val:f.phone||'',oninput:"A.livePhone('ctf-p')"})+'</div>'
    +'<div class="frow c2">'+field('Default Rate ($/hr)','ctf-rate',{pfx:'$',ph:'175.00',val:f.rate||'',hint:'Auto-fills when this person is assigned to an entry'})+(ST.prefs.revenueSplit?field('Personal Cut %','ctf-op',{type:'number',sfx:'%',ph:'100',val:String(pct),hint:'% of billed amount this person keeps (firm gets the rest)'}):'')+'</div>'
    +(ST.prefs.revenueSplit?'<div class="frow c2">'+field('Annual Salary','ctf-sal',{pfx:'$',ph:'120,000',val:f.salary!=null&&f.salary!==''?String(f.salary):'',hint:'Used to calculate net income and bonus/deficit vs. billed earnings'})+'<div></div>'+'</div>':'')
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveCt()">'+IC.save+' Save Contact</button></div>'
    +'</div>';
}

// == Analytics ==
function vAnalytics(){
  var fe=filterEnt(ST.entries,ST.anFilter);
  var hrs=fe.reduce(function(s,e){return s+Number(e.hours);},0);
  var bill=fe.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);

  // Salary prorated to current filter period
  var salPeriodFn=function(annual){ return salaryForPeriod(annual,ST.anFilter); };
  var salLbl=salaryPeriodLabel(ST.anFilter); // e.g. "monthly (÷12)"

  // Revenue split: per team member (includes salary & prorated income calc)
  var contactSplit=ST.contacts.map(function(c){
    var ces=fe.filter(function(e){return e.contactId==c.id;});
    var chrs=ces.reduce(function(s,e){return s+Number(e.hours);},0);
    var cbill=ces.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
    var pct=c.ownPct!=null?Number(c.ownPct):100;
    var own=cbill*pct/100;
    var annualSal=c.salary!=null&&c.salary!==''?Number(c.salary):null;
    var periodSal=salPeriodFn(annualSal);
    var net=periodSal!=null?own-periodSal:null;
    return {id:c.id,name:c.name,hrs:chrs,bill:cbill,ownPct:pct,own:own,firm:cbill*(100-pct)/100,
            annualSalary:annualSal,periodSalary:periodSal,net:net};
  }).filter(function(c){return c.hrs>0;});

  // Unassigned entries
  var unassignedEntries=fe.filter(function(e){
    if(!e.contactId) return true;
    return !ST.contacts.find(function(c){return c.id==e.contactId;});
  });
  var uHrs=unassignedEntries.reduce(function(s,e){return s+Number(e.hours);},0);
  var uBill=unassignedEntries.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
  var userPct=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
  var userAnnualSalary=ST.user&&ST.user.salary!=null&&ST.user.salary!==''?Number(ST.user.salary):null;
  if(uHrs>0){
    var uOwn=uBill*userPct/100;
    contactSplit.push({id:'__unassigned',name:'(Unassigned)',hrs:uHrs,bill:uBill,ownPct:userPct,
      own:uOwn,firm:uBill*(100-userPct)/100,annualSalary:null,periodSalary:null,net:null});
  }

  var totalOwn=contactSplit.reduce(function(s,c){return s+c.own;},0);
  var totalFirm=contactSplit.reduce(function(s,c){return s+c.firm;},0);

  var byClient=ST.clients.map(function(c){
    var es=fe.filter(function(e){return e.clientId==c.id;});
    return {name:c.name,hrs:es.reduce(function(s,e){return s+Number(e.hours);},0),
            bill:es.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0)};
  }).filter(function(c){return c.hrs>0;}).sort(function(a,b){return b.bill-a.bill;});
  var maxB=byClient.length?byClient[0].bill:1;

  // Filter options — rolling + calendar periods
  var filterGroups=[
    {label:'Rolling',opts:[
      {v:'week',l:'Past Week'},{v:'month',l:'Past Month'},
      {v:'quarter',l:'Past Quarter'},{v:'year',l:'Past Year'},{v:'all',l:'All Time'}
    ]},
    {label:'Calendar',opts:[
      {v:'this_month',l:'This Month'},{v:'this_quarter',l:'This Quarter'},{v:'this_year',l:'This Year'}
    ]}
  ];
  var fopts=filterGroups.map(function(g){
    return '<optgroup label="'+g.label+'">'+g.opts.map(function(o){
      return '<option value="'+o.v+'"'+(ST.anFilter===o.v?' selected':'')+'>'+o.l+'</option>';
    }).join('')+'</optgroup>';
  }).join('');

  var periodLblMap={week:'Past Week',month:'Past Month',quarter:'Past Quarter',year:'Past Year',
    all:'All Time',this_month:'This Month',this_quarter:'This Quarter',this_year:'This Year'};
  var periodLbl=periodLblMap[ST.anFilter]||'All Time';

  var barsH=byClient.length?'<div class="card" style="margin-top:20px">'
    +'<h3 style="font-weight:500;margin-bottom:16px;font-size:.93rem">Revenue by Client</h3>'
    +byClient.map(function(c){
      return '<div class="bar-row"><div class="bar-lbl"><span>'+H(c.name)+'</span>'
        +'<span><strong>'+$m(c.bill)+'</strong> <span style="color:var(--ink3);font-size:12px">'+$h(c.hrs)+'</span></span></div>'
        +'<div class="bar-track"><div class="bar-fill" style="width:'+((c.bill/maxB)*100).toFixed(1)+'%"></div></div></div>';
    }).join('')+'</div>':'';

  // ---- Revenue Split card ----
  var splitH='';
  if(ST.prefs.revenueSplit && contactSplit.length>0){
    var userPctDisplay=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
    var anySalary=ST.contacts.some(function(c){return c.salary!=null&&c.salary!=='';}) || (userAnnualSalary!=null);
    var hasSalLbl=anySalary&&salLbl; // only show salary cols if period is prorateable
    // Column header note
    var salColHdr=hasSalLbl?'Salary <span style="font-weight:400;font-size:10px;color:var(--ink3)">('+salLbl+')</span>':'Salary';
    splitH='<div class="card" style="margin-top:20px">'
      +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">'+IC.pie+'<h3 style="font-weight:500;font-size:.93rem;margin:0">Revenue Split (Own vs. Firm)</h3></div>'
      +'<div style="margin-bottom:14px">'
      +'<label class="fl" style="display:flex;align-items:center;gap:12px">'
      +'<span style="font-size:12px;color:var(--ink2);white-space:nowrap">Your personal cut %</span>'
      +'<input type="number" id="an-upct" min="0" max="100" step="1" value="'+H(String(userPctDisplay))+'" oninput="A.setUserPct(this.value)" style="width:80px;padding:6px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px">'
      +'<span style="font-size:12px;color:var(--ink3)">applies to unassigned entries</span>'
      +'</label></div>'
      +'<div class="tscroll"><table class="split-table">'
      +'<thead><tr><th>Team Member</th><th>Cut</th><th>Hours</th><th>Billed</th><th class="own-amt">Own</th><th class="firm-amt">Firm</th>'
      +(anySalary?'<th>'+salColHdr+'</th><th>Net Income</th><th>Status</th>':'')
      +'</tr></thead>'
      +'<tbody>'
      +contactSplit.map(function(c){
        var statusCell='';
        if(anySalary){
          if(c.annualSalary!=null&&c.periodSalary!=null&&salLbl){
            var isBonus=c.net>=0;
            var statusLabel=isBonus?'+'+$m(c.net)+' bonus':$m(Math.abs(c.net))+' short';
            var statusCls=isBonus?'good':'danger';
            statusCell='<td>'+$m(c.periodSalary)+'</td>'
              +'<td><strong>'+$m(c.own - c.periodSalary)+'</strong></td>'
              +'<td><span class="'+statusCls+'" style="font-size:11px;padding:2px 7px;border-radius:10px;display:inline-block;white-space:nowrap">'+statusLabel+'</span></td>';
          } else if(c.annualSalary!=null&&!salLbl){
            // "All time" - can't prorate, show annual for reference only
            statusCell='<td style="color:var(--ink3);font-size:11px">'+$m(c.annualSalary)+'/yr</td>'
              +'<td style="color:var(--ink3);font-size:11px">\u2014</td>'
              +'<td style="color:var(--ink3);font-size:11px">Select a period</td>';
          } else {
            statusCell='<td style="color:var(--ink3);font-size:11px">\u2014</td><td style="color:var(--ink3);font-size:11px">\u2014</td><td style="color:var(--ink3);font-size:11px">No salary set</td>';
          }
        }
        return '<tr>'
          +'<td>'+H(c.name)+'</td>'
          +'<td><span class="split-pill"><span class="own">'+c.ownPct+'%</span></span></td>'
          +'<td>'+$h(c.hrs)+'</td>'
          +'<td>'+$m(c.bill)+'</td>'
          +'<td class="own-amt"><strong>'+$m(c.own)+'</strong></td>'
          +'<td class="firm-amt"><strong>'+$m(c.firm)+'</strong></td>'
          +statusCell
          +'</tr>';
      }).join('')
      +'<tr style="background:var(--bg)">'
      +'<td><strong>Total</strong></td><td></td>'
      +'<td><strong>'+$h(hrs)+'</strong></td>'
      +'<td><strong>'+$m(bill)+'</strong></td>'
      +'<td class="own-amt"><strong>'+$m(totalOwn)+'</strong></td>'
      +'<td class="firm-amt"><strong>'+$m(totalFirm)+'</strong></td>'
      +(anySalary?'<td></td><td></td><td></td>':'')
      +'</tr>'
      +'</tbody></table></div></div>';
  }

  // ---- My Earnings card (current user only) ----
  var myEarningsH='';
  if(ST.prefs.revenueSplit){
    var me=ST.contacts.find(function(c){return c.isUser;});
    if(me){
      var myEntry=contactSplit.find(function(c){return c.id==me.id;});
      var myOwn=myEntry?myEntry.own:0;
      var myHrs=myEntry?myEntry.hrs:0;
      var myBill=myEntry?myEntry.bill:0;
      var myAnnualSal=me.salary!=null&&me.salary!==''?Number(me.salary):null;
      var myPeriodSal=salPeriodFn(myAnnualSal);
      var myCut=me.ownPct!=null?Number(me.ownPct):100;

      var myRows=[
        ['Billed ('+periodLbl+')', $m(myBill),''],
        ['Your Cut ('+myCut+'%)', $m(myOwn),'highlight']
      ];
      var myDetail='';
      if(myAnnualSal!=null){
        if(myPeriodSal!=null&&salLbl){
          var myNet=myOwn-myPeriodSal;
          var bonusLbl=myNet>=0?'Bonus':'Shortfall';
          var bonusCls=myNet>=0?'highlight':'highlight2';
          myRows.push(['Salary ('+salLbl+')', $m(myPeriodSal),'']);
          myRows.push([bonusLbl+' vs Salary', (myNet>=0?'+':'')+$m(myNet), bonusCls]);

          // Annualized projection
          var annFracs={week:52,month:12,quarter:4,year:1,this_month:12,this_quarter:4,this_year:1};
          var annFac=annFracs[ST.anFilter];
          var projAnnOwn=annFac?myOwn*annFac:null;

          myDetail='<div style="margin-top:14px;display:grid;gap:8px">'
            // Period summary bar
            +'<div style="padding:12px 16px;border-radius:8px;background:var(--bg);font-size:12px;line-height:1.8">'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Period billed</span><strong>'+$m(myBill)+'</strong></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Your cut ('+myCut+'%)</span><strong style="color:#166534">'+$m(myOwn)+'</strong></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Salary ('+salLbl+')</span><strong>'+$m(myPeriodSal)+'</strong></div>'
            +'<div style="height:1px;background:var(--border);margin:6px 0"></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Net (cut − salary)</span><strong class="'+(myNet>=0?'good':'danger')+'">'+(myNet>=0?'+':'')+$m(myNet)+'</strong></div>'
            +'</div>'
            // Annualised projection (only for rolling periods with clean multipliers)
            +(projAnnOwn&&annFac&&annFac!==1?'<div style="padding:10px 16px;border-radius:8px;background:var(--bg);border-left:3px solid var(--border);font-size:12px">'
              +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px">Annualised Projection</div>'
              +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--ink2)">Projected annual cut</span><strong>'+$m(projAnnOwn)+'</strong></div>'
              +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink2)">vs Annual salary ('+$m(myAnnualSal)+')</span>'
              +'<strong class="'+(projAnnOwn-myAnnualSal>=0?'good':'danger')+'">'+(projAnnOwn-myAnnualSal>=0?'+':'')+$m(projAnnOwn-myAnnualSal)+'</strong></div>'
              +'</div>':'')
            +'</div>';
        } else if(!salLbl){
          // "All time" - show annual salary for reference
          myRows.push(['Annual Salary', $m(myAnnualSal),'']);
          myDetail='<div style="margin-top:10px;padding:10px 14px;border-radius:8px;background:var(--bg);font-size:12px;color:var(--ink3)">'
            +'Select a specific period (month, quarter, year) to compare earnings against salary.</div>';
        }
      }

      myEarningsH='<div class="card" style="margin-top:20px">'
        +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">'+IC.usr
        +'<h3 style="font-weight:500;font-size:.93rem;margin:0">My Earnings \u2014 '+H(me.name)+'</h3>'
        +(myAnnualSal==null?'<button class="btn-link" onclick="A.chgUser()" style="font-size:11px;margin-left:6px">Set salary</button>':'')
        +'</div>'
        +stats(myRows)
        +myDetail
        +'</div>';
    }
  }

  var emptyH=fe.length===0?'<div class="empty"><div class="empty-ico">&#128202;</div><p>No data for this period</p><small>Log some time entries first</small></div>':'';
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Analytics</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+fe.length+' entries \u00b7 '+periodLbl+'</p></div>'
    +'<select onchange="A.setAnF(this.value)" style="padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)">'+fopts+'</select>'
    +'</div>'
    +(ST.prefs.revenueSplit?stats([['Total Billing',$m(bill),''],['Total Hours',$h(hrs),''],['Own Portion',$m(totalOwn),'highlight'],['Firm Portion',$m(totalFirm),'highlight2']]):stats([['Total Billing',$m(bill),''],['Total Hours',$h(hrs),'']]))
    +barsH+myEarningsH+splitH+emptyH+'</div>';
}


// == Approvals (partner-only full view, attorney status view) ==
function vApprovals(){
  var role=myRole();
  var pending=ST.entries.filter(function(e){return (e.status||'approved')==='pending';});
  var approved=ST.entries.filter(function(e){return (e.status||'approved')==='approved';});
  var rejected=ST.entries.filter(function(e){return e.status==='rejected';});

  if(role!=='partner'){
    // Attorneys and billing staff see their own entry statuses
    var me=ST.user?ST.user.name:'';
    var mine=ST.entries.filter(function(e){return e.createdBy===me;}).sort(function(a,b){return new Date(b.date)-new Date(a.date);});
    var rows=mine.map(function(e){
      var cl=_lu.cl[e.clientId];
      var mt=_lu.ma[e.matterId];
      var st=e.status||'approved';
      return '<tr>'
        +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
        +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
        +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+'</td>'
        +'<td>'+$h(e.hours)+'</td>'
        +'<td style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</td>'
        +'<td>'+statusBadge(st)+'</td>'
        +'<td style="font-size:12px;color:var(--ink3)">'+H(e.approvedBy?'by '+e.approvedBy:'')+'</td>'
        +'<td style="font-size:12px;max-width:180px">'+(e.partnerComment?'<span style="color:var(--amber);font-style:italic">'+IC.comment+' '+H(e.partnerComment)+'</span>':'')+
          (e.partnerEdited?'<span class="badge" style="font-size:10px;background:var(--amber);color:#fff;margin-left:4px" title="Partner adjusted hours/rate/description">edited</span>':'')+'</td>'
        +'</tr>';
    }).join('');
    var tableH=mine.length?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Hours</th><th>Amount</th><th>Status</th><th>Reviewed By</th><th>Partner Notes</th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
      :'<div class="empty"><div class="empty-ico">&#128203;</div><p>No entries yet</p><small>Start logging time entries to see their approval status here</small></div>';
    return '<div>'
      +'<div style="margin-bottom:18px"><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">My Entry Status</h2>'
      +'<p style="font-size:12px;color:var(--ink3)">'+mine.length+' entr'+(mine.length===1?'y':'ies')+' total</p></div>'
      +stats([['Pending',String(mine.filter(function(e){return (e.status||'approved')==='pending';}).length),'highlight2'],['Approved',String(mine.filter(function(e){return (e.status||'approved')==='approved';}).length),'highlight'],['Rejected',String(mine.filter(function(e){return e.status==='rejected';}).length),'']])
      +(role==='billing_staff'?'<div class="role-notice">'+IC.shield+' Billing staff do not submit time entries.</div>':'')
      +tableH+'</div>';
  }

  // Partner view
  var pendingRows=pending.sort(function(a,b){return new Date(a.date)-new Date(b.date);}).map(function(e){
    var cl=_lu.cl[e.clientId];
    var mt=_lu.ma[e.matterId];
    return '<tr>'
      +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
      +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+'</td>'
      +'<td>'+$h(e.hours)+'</td>'
      +'<td style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</td>'
      +'<td style="color:var(--ink2);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+H(e.description||'')+'">'+H(e.description||'-')+'</td>'
      +'<td><span class="badge" title="'+H(e.createdBy||'')+'">'+H(e.createdByIni||'?')+'</span></td>'
      +'<td><div class="tda">'
        +'<button class="btn btn-gr" onclick="A.approveEnt('+e.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.check+' Approve</button>'
        +'<button class="btn btn-gh" onclick="A.openPartnerReview('+e.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.edit+' Review</button>'
        +'<button class="btn btn-rd" onclick="A.rejectEnt('+e.id+')" style="padding:5px 10px;font-size:12px">Reject</button>'
      +'</div></td>'
      +'</tr>';
  }).join('');

  var pendingTableH=pending.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Hours</th><th>Amount</th><th>Description</th><th>By</th><th>Action</th></tr></thead>'
      +'<tbody>'+pendingRows+'</tbody></table></div></div>'
    :'<div class="empty"><div class="empty-ico">&#10003;</div><p>No pending entries</p><small>All caught up!</small></div>';

  var approveAllBtn=pending.length>1?'<button class="btn btn-gr" onclick="A.approveAll()" style="margin-left:auto">'+IC.check+' Approve All ('+pending.length+')</button>':'';

  // Invoices pending review
  var invsPending=(ST.invoices||[]).filter(function(i){return i.status==='review';});
  var invReviewRows=invsPending.map(function(inv){
    var cl=_lu.cl[inv.clientId]||{name:'?'};
    var mt=inv.matterId?_lu.ma[inv.matterId]:null;
    var total=invTotal(inv);
    return '<tr>'
      +'<td style="font-weight:600;color:var(--blue)">#'+H(inv.number||inv.id)+'</td>'
      +'<td style="font-weight:500">'+H(cl.name)+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'All Matters')+'</td>'
      +'<td>'+(inv.entryIds?inv.entryIds.length:0)+' entries</td>'
      +'<td style="color:var(--green);font-weight:600">'+$m(total)+'</td>'
      +'<td style="color:var(--ink3);font-size:12px">'+$d(inv.invoiceDate)+'</td>'
      +'<td><div class="tda">'
        +'<button class="btn btn-dk" onclick="A.invOpenReview('+inv.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.shield+' Review</button>'
        +'<button class="btn-ic" title="Email Invoice to Client" onclick="A.invEmailClient('+inv.id+')">'+IC.mail+'</button>'
        +'<button class="btn-ic" title="Preview" onclick="A.invPrint('+inv.id+')">'+IC.print+'</button>'
      +'</div></td>'
      +'</tr>';
  }).join('');
  var invReviewTableH=invsPending.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>#</th><th>Client</th><th>Matter</th><th>Entries</th><th>Total</th><th>Date</th><th>Action</th></tr></thead>'
      +'<tbody>'+invReviewRows+'</tbody></table></div></div>'
    :'<div class="empty" style="padding:20px"><div class="empty-ico" style="font-size:1.8rem">&#10003;</div><p>No invoices pending review</p></div>';

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Approvals</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">Review time entries and invoices</p></div>'
    +approveAllBtn+'</div>'
    +stats([['Pending Entries',String(pending.length),'highlight2'],['Invoices to Review',String(invsPending.length),invsPending.length>0?'highlight2':''],['Approved Entries',String(approved.length),'highlight'],['Rejected',String(rejected.length),'']])
    +'<div class="appr-panel" style="margin-bottom:16px">'
    +'<h3>'+IC.invoice+' Invoices Pending Review'+(invsPending.length>0?' <span style="background:var(--amber);color:#fff;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:6px">'+invsPending.length+'</span>':'')+'</h3>'
    +invReviewTableH+'</div>'
    +'<div class="appr-panel">'
    +'<h3>'+IC.clock+' Pending Time Entries</h3>'
    +pendingTableH+'</div>'
    +'</div>';
}

// == Invoices ==
function vInvoices(){
  var role=myRole();
  var invs=ST.invoices||[];
  // Filter
  var fil=ST.invFilter||'all';
  var shown=fil==='all'?invs:invs.filter(function(i){return i.status===fil;});
  shown=shown.slice().sort(function(a,b){return b.id-a.id;});

  var fOpts=['all','draft','review','approved','sent'].map(function(v){
    var l={all:'All',draft:'Draft',review:'In Review',approved:'Approved',sent:'Sent'}[v];
    var cnt=v==='all'?invs.length:invs.filter(function(i){return i.status===v;}).length;
    return '<option value="'+v+'"'+(fil===v?' selected':'')+'>'+l+' ('+cnt+')</option>';
  }).join('');

  var rows=shown.map(function(inv){
    var cl=_lu.cl[inv.clientId];
    var mt=inv.matterId?_lu.ma[inv.matterId]:null;
    var total=invTotal(inv);
    var stCls={draft:'s-pending',review:'s-pending',approved:'s-approved',sent:'s-approved'}[inv.status]||'s-pending';
    var stLbl={draft:'Draft',review:'In Review',approved:'Approved',sent:'Sent'}[inv.status]||inv.status;
    var btns='<div class="tda">'
      +'<button class="btn-ic" title="Email Invoice to Client" onclick="A.invEmailClient('+inv.id+')">'+IC.mail+'</button>'
      +'<button class="btn-ic" title="Preview/Print" onclick="A.invPrint('+inv.id+')">'+IC.print+'</button>'
      // Partners can review any non-sent invoice
      +(role==='partner'&&inv.status!=='sent'?'<button class="btn btn-dk" style="padding:4px 10px;font-size:12px" onclick="A.invOpenReview('+inv.id+')">'+IC.shield+' Review</button>':'')
      // Non-partners can send draft invoices for review
      +(role!=='partner'&&inv.status==='draft'?'<button class="btn btn-bl" style="padding:4px 10px;font-size:12px" onclick="A.invSendForReview('+inv.id+')">'+IC.send+' Send for Review</button>':'')
      +(role!=='partner'&&(inv.status==='draft'||inv.status==='review')?'<button class="btn btn-gh" style="padding:4px 10px;font-size:12px" onclick="A.invEmailApproval('+inv.id+')" title="Email billing entries to a partner for approval">'+IC.mail+' Email for Approval</button>':'')
      +(inv.status==='approved'&&role!=='partner'?'<button class="btn btn-gr" style="padding:4px 10px;font-size:12px" onclick="A.invMarkSent('+inv.id+')">'+IC.send+' Mark Sent</button>':'')
      +'<button class="btn-ic" title="Edit" onclick="A.invEdit('+inv.id+')">'+IC.edit+'</button>'
      +'<button class="btn-ic" title="Delete" onclick="A.invDel('+inv.id+')" style="color:var(--red)">'+IC.trash+'</button>'
      +'</div>';
    return '<tr>'
      +'<td style="font-weight:600;color:var(--blue)">#'+H(inv.number||inv.id)+'</td>'
      +'<td style="font-weight:500">'+H(cl?cl.name:'—')+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'All Matters')+'</td>'
      +'<td style="color:var(--ink2)">'+$d(inv.invoiceDate)+'</td>'
      +'<td style="color:var(--ink3)">'+H(inv.entryIds?inv.entryIds.length+' entries':'—')+'</td>'
      +'<td style="color:var(--green);font-weight:600">'+$m(total)+'</td>'
      +'<td><span class="status-badge '+stCls+'">'+H(stLbl)+'</span></td>'
      +'<td>'+btns+'</td>'
      +'</tr>';
  }).join('');

  var totalBilled=shown.reduce(function(s,i){return s+invTotal(i);},0);
  var draftCnt=invs.filter(function(i){return i.status==='draft';}).length;
  var reviewCnt=invs.filter(function(i){return i.status==='review';}).length;
  var sentCnt=invs.filter(function(i){return i.status==='sent';}).length;

  var tableH=shown.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>#</th><th>Client</th><th>Matter</th><th>Date</th><th>Entries</th><th>Total</th><th>Status</th><th></th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
    :'<div class="empty"><div class="empty-ico">&#128196;</div><p>No invoices yet</p><small>Create an invoice from approved time entries</small></div>';

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">'+IC.invoice+' Invoices</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">Create, review, and send client invoices</p></div>'
    +'<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">'
    +'<select onchange="A.invSetFilter(this.value)" style="font-size:13px;padding:5px 8px;border:1px solid var(--brd);border-radius:6px;background:var(--bg)">'+fOpts+'</select>'
    +'<button class="btn btn-dk" onclick="A.invNew()">'+IC.plus+' New Invoice</button>'
    +'</div></div>'
    +stats([['Drafts',String(draftCnt),''],['In Review',String(reviewCnt),'highlight2'],['Sent',String(sentCnt),'highlight'],['Total Billed',$m(totalBilled),'']])
    +tableH+'</div>';
}

// Invoice total calculator (applies cuts)
function invTotal(inv){
  if(!inv||!inv.entryIds) return 0;
  var cuts=inv.cuts||{};
  var merged=inv.mergedEntries||[];
  var mergedEntryIds={};
  merged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedEntryIds[eid]=true;});});
  var t=0;
  inv.entryIds.forEach(function(eid){
    if(mergedEntryIds[eid]) return;
    var e=_lu.en[eid];
    if(!e) return;
    var h=cuts[eid]!=null?Number(cuts[eid]):Number(e.hours);
    t+=h*Number(e.rate||0);
  });
  merged.forEach(function(mg){t+=Number(mg.hours||0)*Number(mg.rate||0);});
  return t;
}

// Invoice form modal (create / edit)
function buildInvoiceForm(){
  var f=ST.invf||{};
  var isEdit=!!ST.editId;
  var clOpts=[{v:'',l:'— Select Client —'}].concat(ST.clients.map(function(c){return {v:c.id,l:c.name};}));
  var mtOpts=[{v:'',l:'All Matters'}].concat(
    (f.clientId?ST.matters.filter(function(m){return m.clientId==f.clientId;}):ST.matters)
    .map(function(m){return {v:m.id,l:m.name};})
  );
  var statusOpts=[{v:'draft',l:'Draft'},{v:'review',l:'Send for Review'},{v:'approved',l:'Approved'},{v:'sent',l:'Sent'}];

  // Entry picker: approved entries for selected client/matter not already invoiced
  var invoicedIds={};
  (ST.invoices||[]).forEach(function(inv){
    if(isEdit&&inv.id==ST.editId) return; // exclude self when editing
    (inv.entryIds||[]).forEach(function(eid){invoicedIds[eid]=inv.number||inv.id;});
  });
  var candidateEnts=ST.entries.filter(function(e){
    if(e.status!==undefined&&e.status!=='approved') return false; // only approved
    if(f.clientId&&e.clientId!=f.clientId) return false;
    if(f.matterId&&e.matterId!=f.matterId) return false;
    return true;
  }).sort(function(a,b){return new Date(a.date)-new Date(b.date);});
  var selIds=f.entryIds||[];
  var selSet={};
  selIds.forEach(function(id){selSet[id]=true;});

  var entryRows=candidateEnts.map(function(e){
    var cl2=_lu.cl[e.clientId];
    var mt2=_lu.ma[e.matterId];
    var alreadyInv=invoicedIds[e.id];
    var dis=!!alreadyInv;
    var chk=selSet[e.id]?'checked':'';
    return '<label style="display:flex;align-items:flex-start;gap:8px;padding:6px 8px;border-radius:6px;cursor:'+(dis?'default':'pointer')+';background:'+(selSet[e.id]?'var(--blue-pale)':'transparent')+';border:1px solid '+(selSet[e.id]?'var(--blue)':'transparent')+';margin-bottom:3px;opacity:'+(dis?0.45:1)+'">'
      +'<input type="checkbox" '+(dis?'disabled':'')+' '+chk+' onchange="A.invTogEnt('+e.id+')" style="margin-top:2px;flex-shrink:0">'
      +'<div style="flex:1;min-width:0">'
      +'<div style="display:flex;justify-content:space-between;gap:8px"><span style="font-size:13px;font-weight:500">'+$d(e.date)+'</span><span style="font-size:12px;color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</span></div>'
      +'<div style="font-size:12px;color:var(--ink2)">'+H(cl2?cl2.name:'')+' · '+H(mt2?mt2.name:'General')+' · '+$h(e.hours)+' @ '+$m(e.rate)+'/hr</div>'
      +(e.description?'<div style="font-size:11px;color:var(--ink3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+H(e.description)+'</div>':'')
      +(alreadyInv?'<div style="font-size:11px;color:var(--amber)">Already on invoice #'+H(alreadyInv)+'</div>':'')
      +'</div></label>';
  }).join('');

  var selAmt=selIds.reduce(function(s,eid){
    var e=_lu.en[eid]; return e?s+Number(e.hours)*Number(e.rate):s;
  },0);

  var firmName=f.firmName!=null?f.firmName:(ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'');

  return '<div class="ov"><div class="modal modal-lg" style="max-height:90vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+(isEdit?IC.edit+' Edit Invoice':''+IC.invoice+' New Invoice')+'</h2>'
    +'<button class="btn-ic" onclick="A.closeF()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Invoice #','inv-num',{val:H(f.number||''),ph:'Auto-assigned if blank'})
    +field('Invoice Date','inv-date',{type:'date',val:f.invoiceDate||today()})
    +field('Due Date','inv-due',{type:'date',val:f.dueDate||''})
    +field('Status','inv-status',{type:'select',val:f.status||'draft',opts:statusOpts})
    +'</div>'

    +'<div style="background:var(--bg2);border-radius:8px;padding:14px;margin:8px 0">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:10px">Firm / From</h4>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Firm Name','inv-firm',{val:H(firmName),ph:'Your firm name'})
    +field('Phone','inv-fphone',{val:H(f.firmPhone||''),ph:'Firm phone'})
    +field('Address','inv-faddr',{val:H(f.firmAddress||''),ph:'Firm address',type:'textarea',rows:2})
    +field('Email','inv-femail',{type:'email',val:H(f.firmEmail||''),ph:'billing@yourfirm.com'})
    +'</div></div>'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Client','inv-cl',{type:'select',val:f.clientId||'',opts:clOpts,req:true,err:f.errs&&f.errs.clientId})
    +field('Matter (optional)','inv-mt',{type:'select',val:f.matterId||'',opts:mtOpts})
    +'</div>'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Payment Terms','inv-terms',{val:H(f.paymentTerms||'Net 30'),ph:'Net 30'})
    +field('Tax Rate %','inv-tax',{val:H(f.taxPct||''),ph:'0',type:'number',sfx:'%'})
    +'</div>'

    +field('Notes / Work Description','inv-notes',{val:H(f.notes||''),type:'textarea',rows:3,ph:'Summary of services rendered...'})
    +field('Footer Note','inv-footer',{val:H(f.footerNote||''),ph:'e.g. Thank you for your business'})

    +'<div style="margin-top:14px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3)">Time Entries</h4>'
    +'<div style="font-size:12px;color:var(--ink2)"><strong>'+selIds.length+' selected</strong> · '+$m(selAmt)+'</div></div>'
    +(f.clientId
      ?'<div style="max-height:240px;overflow-y:auto;border:1px solid var(--brd);border-radius:8px;padding:8px">'
        +(candidateEnts.length?entryRows:'<div style="text-align:center;padding:20px;color:var(--ink3);font-size:13px">No approved entries for this selection</div>')
        +'</div>'
      :'<div style="text-align:center;padding:20px;background:var(--bg2);border-radius:8px;color:var(--ink3);font-size:13px">Select a client to load time entries</div>')
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeF()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.invSave()">'+IC.save+' '+(isEdit?'Update Invoice':'Create Invoice')+'</button>'
    +'</div></div></div>';
}

// Invoice review modal (partner cuts/merges/comments)
function buildInvoiceReview(){
  var rev=ST.invRev||{};
  var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
  if(!inv) return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2>Review</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div><div class="modal-bd"><p>Invoice not found</p></div></div></div>';
  var cl=_lu.cl[inv.clientId]||{name:'?'};
  var mt=inv.matterId?_lu.ma[inv.matterId]:null;

  var cuts=rev.cuts||{};
  var comments=rev.comments||{};
  var pendingMerge=rev.pendingMerge||[];
  var pmSet={};
  pendingMerge.forEach(function(id){pmSet[id]=true;});

  // Merged entries already in invoice
  var existingMerged=inv.mergedEntries||[];
  var mergedIds={};
  existingMerged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedIds[eid]=mg.id;});});

  var entryRows=(inv.entryIds||[]).map(function(eid){
    var e=_lu.en[eid];
    if(!e) return '';
    if(mergedIds[eid]) return ''; // skip already-merged
    var origH=Number(e.hours);
    var cutH=cuts[eid]!=null?Number(cuts[eid]):origH;
    var amt=cutH*Number(e.rate||0);
    var hasCut=cutH<origH;
    var cmtVal=H(comments[eid]||'');
    var inMerge=pmSet[eid];
    return '<div style="border:1px solid '+(inMerge?'var(--blue)':hasCut?'var(--amber)':'var(--brd)')+';border-radius:8px;padding:10px 12px;margin-bottom:8px;background:'+(inMerge?'var(--blue-pale)':hasCut?'rgba(251,191,36,.06)':'var(--bg)')+'">'
      +'<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">'
      +'<div style="flex:1;min-width:200px">'
      +'<div style="font-size:13px;font-weight:500;margin-bottom:3px">'+$d(e.date)+' — <span style="color:var(--ink2)">'+H(e.description||'No description')+'</span></div>'
      +'<div style="font-size:12px;color:var(--ink3)">'+$h(origH)+' @ '+$m(e.rate)+'/hr &nbsp;·&nbsp; '+H(e.createdBy||'')+'</div>'
      +'</div>'
      +'<div style="display:flex;align-items:center;gap:8px;flex-shrink:0">'
      +'<label style="font-size:12px;color:var(--ink3)">Hours:</label>'
      +'<div style="display:flex;align-items:center;gap:4px">'
      +(hasCut?'<span style="font-size:11px;text-decoration:line-through;color:var(--red)">'+origH+'</span>':'')
      +'<input type="number" value="'+cutH+'" min="0" max="'+origH+'" step="0.01" style="width:68px;padding:4px 6px;border:1px solid var(--brd);border-radius:5px;font-size:13px;background:var(--bg)" onchange="A.invRevCut('+eid+',this.value)">'
      +'</div>'
      +'<span style="font-size:13px;font-weight:600;color:var(--green);min-width:60px;text-align:right">'+$m(amt)+'</span>'
      +'</div></div>'
      +'<div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">'
      +'<input type="text" placeholder="Reviewer comment (optional)..." value="'+cmtVal+'" style="flex:1;min-width:160px;font-size:12px;padding:5px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg)" onchange="A.invRevComment('+eid+',this.value)">'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 8px;gap:3px" onclick="A.invRevTogMerge('+eid+')" title="'+(inMerge?'Remove from merge group':'Add to merge group')+'">'
        +IC.merge+(inMerge?' ✓ In Merge':'Merge')+'</button>'
      +(hasCut?'<button class="btn btn-gh" style="font-size:11px;padding:4px 8px" onclick="A.invRevCut('+eid+','+origH+')">Restore</button>':'')
      +'</div>'
      +'</div>';
  }).join('');

  // Merged entry groups
  var mergedRows=existingMerged.map(function(mg,mi){
    return '<div style="border:1px solid var(--blue);border-radius:8px;padding:10px 12px;margin-bottom:8px;background:var(--blue-pale)">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
      +'<span style="font-size:12px;font-weight:600;color:var(--blue)">'+IC.merge+' Merged Entry ('+mg.entryIds.length+' combined)</span>'
      +'<button class="btn btn-rd" style="font-size:11px;padding:3px 8px" onclick="A.invRevUnmerge('+mi+')">Unmerge</button>'
      +'</div>'
      +'<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">'
      +'<div style="flex:1"><input type="text" value="'+H(mg.description||'')+'" placeholder="Merged entry description" style="width:100%;font-size:13px;padding:5px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg)" onchange="A.invRevMergeDesc('+mi+',this.value)"></div>'
      +'<div style="display:flex;gap:6px;align-items:center">'
      +'<input type="number" value="'+mg.hours+'" min="0" step="0.01" style="width:68px;padding:4px 6px;border:1px solid var(--brd);border-radius:5px;font-size:13px;background:var(--bg)" onchange="A.invRevMergeHours('+mi+',this.value)">'
      +'<span style="font-size:12px;color:var(--ink3)">hrs @ '+$m(mg.rate)+'</span>'
      +'<span style="font-size:13px;font-weight:600;color:var(--green)">'+$m(Number(mg.hours)*Number(mg.rate))+'</span>'
      +'</div></div>'
      +'<div style="margin-top:4px;font-size:11px;color:var(--ink3)">Includes: '+mg.entryIds.map(function(eid){var e=_lu.en[eid];return e?$d(e.date)+' '+$h(e.hours):'?';}).join(', ')+'</div>'
      +'</div>';
  }).join('');

  var pendingMergeTotal=pendingMerge.reduce(function(s,eid){
    var e=_lu.en[eid];
    var h=cuts[eid]!=null?Number(cuts[eid]):e?Number(e.hours):0;
    return s+h;
  },0);
  var pendingMergeRate=pendingMerge.length>0?(function(){
    var e=_lu.en[pendingMerge[0]];return e?Number(e.rate||0):0;
  })():0;

  var mergePanel=pendingMerge.length>0
    ?'<div style="background:var(--blue-pale);border:1px solid var(--blue);border-radius:8px;padding:10px 12px;margin-bottom:12px">'
      +'<div style="font-size:12px;font-weight:600;color:var(--blue);margin-bottom:8px">'+IC.merge+' Merge '+pendingMerge.length+' selected entries → single line item</div>'
      +'<input type="text" id="merge-desc" placeholder="Combined description..." style="width:100%;font-size:13px;padding:6px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg);margin-bottom:6px">'
      +'<div style="display:flex;gap:8px;align-items:center">'
      +'<span style="font-size:12px;color:var(--ink3)">Total hrs: '+pendingMergeTotal.toFixed(2)+' @ '+$m(pendingMergeRate)+'/hr</span>'
      +'<button class="btn btn-dk" style="font-size:12px;padding:4px 12px;margin-left:auto" onclick="A.invRevCommitMerge()">'+IC.merge+' Commit Merge</button>'
      +'<button class="btn btn-gh" style="font-size:12px;padding:4px 8px" onclick="A.invRevClearMerge()">Clear</button>'
      +'</div></div>'
    :'';

  // Invoice-level comments
  var invComments=rev.invoiceComment||'';
  var savedComments=(inv.comments||[]).map(function(c){
    return '<div style="padding:6px 10px;background:var(--bg2);border-radius:6px;margin-bottom:4px;font-size:12px">'
      +'<strong>'+H(c.by)+'</strong> <span style="color:var(--ink3)">'+$d(c.at)+'</span>'
      +'<div style="margin-top:3px;color:var(--ink2)">'+H(c.text)+'</div>'
      +'</div>';
  }).join('');

  var newTotal=invTotal(Object.assign({},inv,{cuts:cuts,mergedEntries:inv.mergedEntries||[]}));

  return '<div class="ov"><div class="modal modal-lg" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.shield+' Review Invoice #'+H(inv.number||inv.id)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'
    +'<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">'
    +'<div style="flex:1;min-width:200px;background:var(--bg2);padding:10px 14px;border-radius:8px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Client</div>'
    +'<div style="font-weight:600">'+H(cl.name)+'</div>'
    +(mt?'<div style="font-size:12px;color:var(--ink2)">'+H(mt.name)+'</div>':'')+'</div>'
    +'<div style="flex:1;min-width:180px;background:var(--bg2);padding:10px 14px;border-radius:8px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Invoice Total</div>'
    +'<div style="font-weight:700;font-size:1.4rem;color:var(--green)">'+$m(newTotal)+'</div>'
    +'<div style="font-size:11px;color:var(--ink3)">'+(inv.entryIds||[]).length+' entries</div></div>'
    +'</div>'

    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:8px">Time Entries — Cut / Comment / Merge</h4>'
    +mergePanel
    +(existingMerged.length?'<div style="margin-bottom:8px">'+mergedRows+'</div>':'')
    +entryRows

    +'<div style="margin-top:16px;border-top:1px solid var(--brd);padding-top:14px">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:8px">'+IC.comment+' Invoice Comments</h4>'
    +(savedComments||'')
    +'<div style="display:flex;gap:8px;margin-top:8px">'
    +'<input type="text" id="inv-comment-inp" placeholder="Add a review comment..." style="flex:1;font-size:13px;padding:6px 8px;border:1px solid var(--brd);border-radius:6px;background:var(--bg)">'
    +'<button class="btn btn-gh" onclick="A.invRevAddComment()">'+IC.comment+' Add</button>'
    +'</div></div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-gh" style="gap:5px" onclick="A.invEmailDecision()" title="Email review summary to the billing attorney">'+IC.mail+' Email Summary</button>'
    +'<button class="btn btn-rd" onclick="A.invRevReject()">Reject</button>'
    +'<button class="btn btn-dk" onclick="A.invRevSave()">'+IC.save+' Save &amp; Close</button>'
    +'<button class="btn btn-gr" onclick="A.invRevApprove()">'+IC.check+' Approve Invoice</button>'
    +'</div></div></div>';
}

// Invoice print preview
function buildInvoicePrint(){
  var inv=ST.invoices.find(function(i){return i.id==ST.invPrintId;});
  if(!inv) return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2>Print</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div><div class="modal-bd"><p>Invoice not found</p></div></div></div>';
  var cl=_lu.cl[inv.clientId]||{name:'?',email:'',phone:''};
  var mt=inv.matterId?_lu.ma[inv.matterId]:null;

  var cuts=inv.cuts||{};
  var merged=inv.mergedEntries||[];
  var mergedEntryIds={};
  merged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedEntryIds[eid]=true;});});

  // Build line items
  var lineItems=[];
  (inv.entryIds||[]).forEach(function(eid){
    if(mergedEntryIds[eid]) return;
    var e=_lu.en[eid];
    if(!e) return;
    var origH=Number(e.hours);
    var h=cuts[eid]!=null?Number(cuts[eid]):origH;
    if(h<=0) return;
    // Show strikethrough if: hours were cut via invoice review, OR partner edited them directly
    var displayOrigH=null;
    if(cuts[eid]!=null&&Number(cuts[eid])<(e.submittedHours!=null?Number(e.submittedHours):origH)){
      displayOrigH=e.submittedHours!=null?Number(e.submittedHours):origH;
    } else if(e.submittedHours!=null&&Number(e.submittedHours)!==h){
      displayOrigH=Number(e.submittedHours);
    }
    var wasCut=displayOrigH!=null;
    var mt2=_lu.ma[e.matterId];
    var ct2=_lu.ct[e.contactId];
    var cmt=(inv.comments||[]).filter(function(c){return c.entryId==eid;}).map(function(c){return c.text;}).join('; ');
    lineItems.push({date:e.date,desc:e.description||'Legal services',matter:mt2?mt2.name:'',by:ct2?ct2.name:(e.createdBy||''),hours:h,origHours:wasCut?displayOrigH:null,rate:Number(e.rate||0),amount:h*Number(e.rate||0),partnerComment:(e.showCommentOnInvoice&&e.partnerComment)?e.partnerComment:''});
  });
  merged.forEach(function(mg){
    if(Number(mg.hours||0)<=0) return;
    lineItems.push({date:'',desc:mg.description||'Legal services',matter:'',by:'',hours:Number(mg.hours||0),rate:Number(mg.rate||0),amount:Number(mg.hours||0)*Number(mg.rate||0)});
  });
  lineItems.sort(function(a,b){return a.date<b.date?-1:a.date>b.date?1:0;});

  var subtotal=lineItems.reduce(function(s,l){return s+l.amount;},0);
  var taxPct=Number(inv.taxPct||0);
  var taxAmt=subtotal*taxPct/100;
  var total=subtotal+taxAmt;

  var lineRows=lineItems.map(function(l){
    return '<tr>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;color:#555">'+(l.date?$d(l.date):'')+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee">'+H(l.desc)+(l.matter?'<br><span style="font-size:11px;color:#888">'+H(l.matter)+'</span>':'')+''+(l.by?'<br><span style="font-size:11px;color:#aaa">'+H(l.by)+'</span>':'')+(l.partnerComment?'<br><span style="font-size:11px;color:#555;font-style:italic">Note: '+H(l.partnerComment)+'</span>':'')+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right">'+(l.origHours!=null?'<span style="text-decoration:line-through;color:#bbb;font-size:11px;margin-right:5px">'+l.origHours.toFixed(1)+'</span>':'')+l.hours.toFixed(1)+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right">'+$m(l.rate)+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right;font-weight:600">'+$m(l.amount)+'</td>'
      +'</tr>';
  }).join('');

  var firmName=H(inv.firmName||ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'');
  var firmAddr=H(inv.firmAddress||'');
  var firmPhone=H(inv.firmPhone||'');
  var firmEmail=H(inv.firmEmail||'');
  var invNum=H(inv.number||String(inv.id));

  var html='<div id="inv-print-wrap" style="background:#fff;color:#222;font-family:Georgia,serif;padding:0">'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:32px 40px 24px;border-bottom:3px solid #111">'
    +'<div><div style="font-size:22px;font-weight:700;color:#111;letter-spacing:-.02em">'+firmName+'</div>'
    +(firmAddr?'<div style="font-size:12px;color:#666;margin-top:4px">'+firmAddr.replace(/\n/g,'<br>')+'</div>':'')
    +(firmPhone?'<div style="font-size:12px;color:#666">'+firmPhone+'</div>':'')
    +(firmEmail?'<div style="font-size:12px;color:#666">'+firmEmail+'</div>':'')
    +'</div>'
    +'<div style="text-align:right"><div style="font-size:30px;font-weight:300;color:#111;letter-spacing:-.02em">INVOICE</div>'
    +'<div style="font-size:14px;color:#555;margin-top:4px"># '+invNum+'</div>'
    +'<div style="font-size:12px;color:#888">Date: '+$d(inv.invoiceDate||today())+'</div>'
    +(inv.dueDate?'<div style="font-size:12px;color:#888">Due: '+$d(inv.dueDate)+'</div>':'')
    +'</div></div>'
    +'<div style="display:flex;justify-content:space-between;padding:20px 40px;background:#f8f8f8;border-bottom:1px solid #ddd">'
    +'<div><div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:#999;margin-bottom:4px">Bill To</div>'
    +'<div style="font-weight:700;font-size:15px">'+H(cl.name)+'</div>'
    +(cl.email?'<div style="font-size:12px;color:#666">'+H(cl.email)+'</div>':'')
    +(cl.phone?'<div style="font-size:12px;color:#666">'+H(cl.phone)+'</div>':'')
    +'</div>'
    +'<div style="text-align:right">'
    +(mt?'<div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:#999;margin-bottom:2px">Matter</div><div style="font-weight:600">'+H(mt.name)+'</div>':'')
    +(inv.paymentTerms?'<div style="font-size:12px;color:#666;margin-top:4px">Terms: '+H(inv.paymentTerms)+'</div>':'')
    +'</div></div>'
    +(inv.notes?'<div style="padding:16px 40px;border-bottom:1px solid #eee;font-size:13px;color:#444">'+H(inv.notes)+'</div>':'')
    +'<table style="width:100%;border-collapse:collapse">'
    +'<thead><tr style="background:#f0f0f0"><th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #ddd">Date</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #ddd">Description</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Hours</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Rate</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Amount</th>'
    +'</tr></thead>'
    +'<tbody>'+lineRows+'</tbody>'
    +'</table>'
    +'<div style="display:flex;justify-content:flex-end;padding:16px 40px">'
    +'<div style="min-width:220px">'
    +'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#555"><span>Subtotal</span><span>'+$m(subtotal)+'</span></div>'
    +(taxPct>0?'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#555"><span>Tax ('+taxPct+'%)</span><span>'+$m(taxAmt)+'</span></div>':'')
    +'<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:16px;font-weight:700;border-top:2px solid #111;margin-top:4px"><span>Total</span><span>'+$m(total)+'</span></div>'
    +'</div></div>'
    +(inv.footerNote?'<div style="padding:16px 40px;border-top:1px solid #eee;font-size:12px;color:#888;font-style:italic">'+H(inv.footerNote)+'</div>':'')
    +'</div>';

  return '<div class="ov"><div class="modal modal-lg" style="max-height:95vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.print+' Invoice Preview #'+invNum+'</h2>'
    +'<div style="display:flex;gap:8px">'
    +'<button class="btn btn-dk" onclick="A.invDoPrint()" style="gap:6px">'+IC.print+' Print</button>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button>'
    +'</div></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1;padding:0;background:#e8e8e8">'
    +'<div style="max-width:820px;margin:20px auto;box-shadow:0 4px 24px rgba(0,0,0,.15)">'+html+'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +(inv.status!=='sent'&&myRole()==='partner'?'<button class="btn btn-dk" onclick="A.invOpenReview('+inv.id+'); A.closeM()">'+IC.shield+' Review</button>':'')
    +(myRole()!=='partner'&&(inv.status==='draft'||inv.status==='review')?'<button class="btn btn-gh" onclick="A.invEmailApproval('+inv.id+')" style="gap:5px">'+IC.mail+' Email for Approval</button>':'')
    +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
    +'<button class="btn btn-gh" onclick="A.invEmailClient('+inv.id+')" style="gap:5px">'+IC.mail+' Email to Client</button>'
    +'<button class="btn btn-gr" onclick="A.invDoPrint()">'+IC.print+' Print / Save PDF</button>'
    +'</div></div></div>';
}

// === MODALS
// == Partner Review Entry Modal ==
function buildPartnerReview(){
  var f=ST.pref||{};
  var e=ST.entries.find(function(x){return x.id==f.entryId;});
  if(!e) return '';
  var cl=ST.clients.find(function(c){return c.id==e.clientId;})||{name:'?'};
  var mt=ST.matters.find(function(m){return m.id==e.matterId;});
  var orig={hours:e.hours,rate:e.rate,description:e.description||''};
  var hoursChanged=String(f.hours)!==String(orig.hours);
  var rateChanged=String(f.rate)!==String(orig.rate);
  var descChanged=(f.description||'')!==(orig.description||'');
  var anyEdited=hoursChanged||rateChanged||descChanged;
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.edit+' Partner Review: Time Entry</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1;min-height:0">'

    // Original entry summary
    +'<div style="background:var(--bg2);border-radius:8px;padding:12px 14px;margin-bottom:16px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:6px">Original Submission</div>'
    +'<div style="font-size:13px;font-weight:500">'+$d(e.date)+' — '+H(cl.name)+(mt?' / '+H(mt.name):'')+'</div>'
    +'<div style="font-size:12px;color:var(--ink2);margin-top:3px">'+H(orig.description||'No description')+'</div>'
    +'<div style="font-size:12px;color:var(--ink3);margin-top:3px">'+$h(orig.hours)+' @ '+$m(orig.rate)+'/hr &nbsp;·&nbsp; <strong style="color:var(--green)">'+$m(Number(orig.hours)*Number(orig.rate))+'</strong>'
    +(e.createdBy?' &nbsp;·&nbsp; by '+H(e.createdBy):'')+'</div>'
    +'</div>'

    // Editable fields — partner adjustments
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:10px">Partner Adjustments <span style="font-weight:400;text-transform:none;font-size:12px;color:var(--ink2)">(leave unchanged to keep originals)</span></div>'
    +'<div class="frow c2">'
    +field('Hours','pref-h',{type:'number',val:f.hours,ph:orig.hours,step:'0.1',min:'0.1',hint:hoursChanged?'<span style="color:var(--amber)">Changed from '+orig.hours+'</span>':''})
    +field('Rate ($/hr)','pref-r',{pfx:'$',val:f.rate,ph:orig.rate,hint:(rateChanged?'<span style="color:var(--amber)">Changed from '+$m(orig.rate)+'</span>':(total?'Total: '+total:''))})
    +'</div>'
    +field('Description','pref-desc',{type:'textarea',rows:2,val:f.description,ph:orig.description||'Describe the work performed...',hint:descChanged?'<span style="color:var(--amber)">Modified from original</span>':''})
    +(anyEdited?'<div class="note" style="margin-bottom:12px">'+IC.edit+' You have pending edits. These will be saved to the entry when you approve or save.</div>':'')

    // Comment section
    +'<div style="border-top:1px solid var(--brd);margin-top:4px;padding-top:14px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:10px">'+IC.comment+' Partner Comment</div>'
    +field('Comment','pref-cmt',{type:'textarea',rows:2,val:f.comment||'',ph:'Add a note for the attorney or billing reference...'})
    +'<label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-top:6px;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:'+(f.showOnInvoice?'var(--blue-pale)':'var(--bg)')+';">'
    +'<input type="checkbox" id="pref-inv" style="width:15px;height:15px;cursor:pointer;"'+(f.showOnInvoice?' checked':'')+'>'
    +'<span><strong>Show comment on invoice</strong> <span style="color:var(--ink3);font-size:12px">— visible to client</span></span>'
    +'</label>'
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-rd" onclick="A.partnerReviewReject()">Reject Entry</button>'
    +'<button class="btn btn-dk" onclick="A.partnerReviewSave(false)" style="gap:4px">'+IC.save+' Save Draft</button>'
    +'<button class="btn btn-gr" onclick="A.partnerReviewSave(true)" style="gap:4px">'+IC.check+' Save &amp; Approve</button>'
    +'</div></div></div>';
}

function buildUP(){
  var pct=ST.user&&ST.user.ownPct!=null?String(ST.user.ownPct):'100';
  var rate=ST.user&&ST.user.rate!=null?String(ST.user.rate):'';
  var curRole=ST.user&&ST.user.role||'attorney';
  var isFirstRun=!ST.user||ST._splashMode;
  var STEPS=['Firm Setup','Your Profile'];

  // Role cards for splash
  var roles=[
    {v:'attorney',  label:'Attorney',      desc:'Track and submit time entries for review'},
    {v:'partner',   label:'Partner',        desc:'Full access \u2014 add entries, approve timesheets, manage everything'},
    {v:'billing_staff', label:'Billing Staff', desc:'View-only access: review entries and export reports'}
  ];
  var roleCardsH=roles.map(function(r){
    var sel=curRole===r.v?' sel':'';
    return '<div class="splash-role'+sel+'" onclick="A.upSelRole(\''+r.v+'\')">'
      +'<div class="splash-role-radio"></div>'
      +'<div class="splash-role-body"><strong>'+r.label+'</strong><span>'+r.desc+'</span></div>'
      +'</div>';
  }).join('');

  if(isFirstRun){
    var splitFields='';
    if(ST.prefs.revenueSplit){
      splitFields='<div class="frow c2" style="margin-bottom:16px">'
        +'<div class="fl"><label for="up-pct">Personal Cut % <span style="font-size:11px;color:var(--ink3);font-weight:300">of billed revenue</span></label>'
        +'<div class="pw"><input type="number" id="up-pct" min="0" max="100" step="1" placeholder="100" value="'+H(pct)+'"/><span class="sfx">%</span></div>'
        +'<div class="hint">100 = you keep all; 0 = all to firm</div></div>'
        +'<div class="fl"><label for="up-sal">Annual Salary <span style="font-size:11px;color:var(--ink3);font-weight:300">(optional)</span></label>'
        +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-sal" placeholder="120,000" value="'+H(ST.user&&ST.user.salary!=null&&ST.user.salary!==''?String(ST.user.salary):'')+'" /></div>'
        +'<div class="hint">Shown in analytics as net vs. billed</div></div>'
        +'</div>';
    }
    return '<div class="splash-ov">'
      +splashHero(STEPS,1)
      +'<div class="splash-form">'
      +'<div class="splash-form-inner">'
      +'<h2>Set up <strong>your profile</strong></h2>'
      +'<p class="sub">This is stored only on your device. It identifies who created each time entry and controls what you can do in the app.</p>'
      +'<div class="frow c2" style="margin-bottom:16px">'
      +'<div class="fl"><label for="up-n">Full name <span class="req">*</span></label><input type="text" id="up-n" placeholder="e.g. Sarah Johnson" value="'+H(ST.user?ST.user.name:'')+'" autofocus/></div>'
      +'<div class="fl"><label for="up-i">Initials</label><input type="text" id="up-i" placeholder="SJ" maxlength="4" value="'+H(ST.user?ST.user.initials:'')+'"/><div class="hint">Auto-generated if blank</div></div>'
      +'</div>'
      +'<div class="frow c2" style="margin-bottom:16px">'
      +'<div class="fl"><label for="up-e">Email</label><input type="email" id="up-e" placeholder="sarah@firm.com" value="'+H(ST.user&&ST.user.email||'')+'"/></div>'
      +'<div class="fl"><label for="up-p">Phone</label><input type="tel" id="up-p" placeholder="(555) 123-4567" value="'+H(ST.user&&ST.user.phone||'')+'" oninput="A.livePhone(\'up-p\')"/></div>'
      +'</div>'
      +'<div class="fl" style="margin-bottom:16px"><label for="up-rate">Default Rate ($/hr)</label>'
      +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-rate" placeholder="150.00" value="'+H(rate)+'"/></div>'
      +'<div class="hint">Your billing rate. Leave blank to use client/matter rates.</div></div>'
      +splitFields
      +'<div style="margin-bottom:8px;font-size:13px;font-weight:600;color:var(--ink)">Your role</div>'
      +'<div class="splash-roles">'+roleCardsH+'</div>'
      +'<input type="hidden" id="up-role" value="'+H(curRole)+'">'
      +'</div>'
      +'<div class="splash-footer">'
      +'<span class="splash-footer-note">\ud83d\udd12 Stored only on this device</span>'
      +'<button class="btn btn-dk" onclick="A.saveUser()" style="padding:10px 28px">Continue \u2192</button>'
      +'</div>'
      +'</div></div>';
  }

  // Non-first-run: compact modal (chgUser)
  var roleOpts=roles.map(function(o){return '<option value="'+o.v+'"'+(curRole===o.v?' selected':'')+'>'+H(o.label+' \u2014 '+o.desc)+'</option>';}).join('');
  return '<div class="up-wrap">'
    +'<div class="up-box">'
    +'<div class="up-icon">'+IC.usr+'</div>'
    +'<h2>Edit Profile</h2>'
    +'<p>Changes apply to new entries from this point forward.</p>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-n">Your name <span class="req">*</span></label><input type="text" id="up-n" placeholder="e.g. Sarah Johnson" value="'+H(ST.user?ST.user.name:'')+'"/></div>'
    +'<div class="fl"><label for="up-i">Initials</label><input type="text" id="up-i" placeholder="SJ" maxlength="4" value="'+H(ST.user?ST.user.initials:'')+'"/><div class="hint">Auto-generated from name if left blank</div></div>'
    +'</div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-e">Email</label><input type="email" id="up-e" placeholder="you@firm.com" value="'+H(ST.user&&ST.user.email||'')+'"/></div>'
    +'<div class="fl"><label for="up-p">Phone</label><input type="tel" id="up-p" placeholder="(555) 123-4567" value="'+H(ST.user&&ST.user.phone||'')+'" oninput="A.livePhone(\'up-p\')"/></div>'
    +'</div>'
    +'<div class="fl" style="margin-bottom:14px"><label for="up-role">Role</label><select id="up-role">'+roleOpts+'</select></div>'
    +'<div class="fl" style="margin-bottom:14px"><label for="up-rate">Default Rate ($/hr)</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-rate" placeholder="150.00" value="'+H(rate)+'"/></div></div>'
    +(ST.prefs.revenueSplit?'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-pct">Personal Cut %</label>'
    +'<div class="pw"><input type="number" id="up-pct" min="0" max="100" step="1" value="'+H(pct)+'"/><span class="sfx">%</span></div></div>'
    +'<div class="fl"><label for="up-sal">Annual Salary</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-sal" value="'+H(ST.user&&ST.user.salary!=null&&ST.user.salary!==''?String(ST.user.salary):'')+'" /></div></div>'
    +'</div>':'')
    +'<div style="display:flex;gap:10px;margin-top:4px">'
    +'<button class="btn btn-gh" style="flex:1;justify-content:center" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-dk" style="flex:1;justify-content:center" onclick="A.saveUser()">Save Profile</button>'
    +'</div>'
    +'</div></div>';
}


function buildQL(){
  var f=ST.ql;
  var ms=ST.tmrOn?(Date.now()-ST.tmrStart+ST.tmrMs):ST.tmrMs;
  var hh=String(Math.floor(ms/3600000)).padStart(2,'0');
  var mm=String(Math.floor((ms%3600000)/60000)).padStart(2,'0');
  var ss=String(Math.floor((ms%60000)/1000)).padStart(2,'0');
  // Actual hours from timer (no rounding, no forced minimum)
  var rnd=ms/3600000;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var avMat=ST.matters.filter(function(m){return m.clientId==f.clientId;});
  var maOpts=[{v:'',l:'General'}].concat(avMat.map(function(m){return{v:m.id,l:m.name};}));
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  // Today's existing entries for "continue" feature
  var todayStr=today();
  var todayEntries=ST.entries.filter(function(e){return e.date===todayStr&&!e.finalized;}).sort(function(a,b){return b.id-a.id;});
  var continueH='';
  if(todayEntries.length>0){
    var addToId=f.addToId||'';
    var entOpts='<option value="">&#43; New entry</option>'
      +todayEntries.map(function(e){
        var cl=_lu.cl[e.clientId];
        var mt=_lu.ma[e.matterId];
        var label=(cl?cl.name:'?')+(mt?' \u2022 '+mt.name:'')+' ('+$h(e.hours)+')'+(e.description?' \u2013 '+e.description.substring(0,28)+(e.description.length>28?'\u2026':''):'');
        return '<option value="'+e.id+'"'+(String(e.id)===String(addToId)?' selected':'')+'>'+H(label)+'</option>';
      }).join('');
    continueH='<div style="background:var(--bg2,#f8f8f8);border-bottom:1px solid var(--border);padding:12px 20px">'
      +'<label style="font-size:12px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:6px">Continue existing entry today</label>'
      +'<select style="width:100%;font-size:13px" onchange="A.qlPickEntry(this.value)">'+entOpts+'</select>'
      +(addToId?'<div style="margin-top:6px;font-size:12px;color:var(--green,#2a9d5c)">&#10010; Hours you log will be added to this entry</div>':'')
      +'</div>';
  }
  var headingLabel=f.addToId?IC.flash+' Add Hours to Entry':IC.flash+' Quick Log';
  return '<div class="ov"><div class="modal modal-sm">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+headingLabel+'</h2>'
    +'<button class="btn-ic" onclick="A.closeQL()">'+IC.x+'</button></div>'
    +continueH
    +'<div class="ql-timer">'
    +'<div class="timer-num '+(ST.tmrOn?'timer-on':'timer-off')+'" id="ql-t">'+hh+':'+mm+':'+ss+'</div>'
    +'<div style="display:flex;gap:8px;align-items:center">'
    +'<button class="btn '+(ST.tmrOn?'btn-rd':'btn-dk')+'" onclick="A.togTmr()" style="padding:8px 14px;font-size:13px">'+(ST.tmrOn?'Stop':(ST.tmrMs>0?'Resume':'Start'))+'</button>'
    +(ST.tmrMs>0?'<button class="btn btn-gh" onclick="A.rstTmr()" style="padding:8px 12px;font-size:13px">Reset</button>':'')
    +'</div>'
    +(ST.tmrMs>0&&!ST.tmrOn?'<span style="font-size:12px;color:var(--ink3)" title="Exact measured time">'+msToHMS(ST.tmrMs)+' ('+rnd.toFixed(4)+'h exact)</span>':'')
    +'</div>'
    +'<div class="modal-bd" style="padding:18px 20px">'
    +(!f.addToId
      // New entry mode: show client/matter dropdowns
      ?('<div class="frow c2" style="margin-bottom:12px">'
        +'<div class="fl"><label>Client <span class="req">*</span></label>'
        +'<select id="ql-cl" onchange="A.qlCl(this.value)">'
        +clOpts.map(function(o){return '<option value="'+H(o.v)+'"'+(String(o.v)===String(f.clientId)?'selected':'')+'>'+H(o.l)+'</option>';}).join('')
        +'</select></div>'
        +'<div class="fl"><label>Matter</label>'
        +'<select id="ql-ma" onchange="A.qlSet(\'matterId\',this.value)"'+(f.clientId?'':' disabled')+'>'
        +maOpts.map(function(o){return '<option value="'+H(o.v)+'"'+(String(o.v)===String(f.matterId)?'selected':'')+'>'+H(o.l)+'</option>';}).join('')
        +'</select></div></div>')
      // Continue mode: show client/matter as read-only chips
      :(function(){
          var cl=ST.clients.find(function(c){return String(c.id)===String(f.clientId);});
          var mt=ST.matters.find(function(m){return String(m.id)===String(f.matterId);});
          return '<div class="frow c2" style="margin-bottom:12px">'
            +'<div class="fl"><label>Client</label><div style="padding:7px 10px;background:var(--bg2,#f8f8f8);border:1px solid var(--border);border-radius:6px;font-size:13px;color:var(--ink)">'+H(cl?cl.name:'\u2014')+'</div></div>'
            +'<div class="fl"><label>Matter</label><div style="padding:7px 10px;background:var(--bg2,#f8f8f8);border:1px solid var(--border);border-radius:6px;font-size:13px;color:var(--ink2)">'+H(mt?mt.name:'General')+'</div></div>'
            +'</div>';
        })()
    )
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>'+(f.addToId?'Hours to Add':'Hours')+' <span class="req">*</span></label><input type="number" id="ql-h" step="0.01" min="0.01" value="'+H(f.hours||'')+'" placeholder="1.0" oninput="A.qlSet(\'hours\',this.value)"'+(f.rawMs!=null?' title="Timer-measured: '+msToHMS(f.rawMs)+' exact — adjust for billing if needed"':'')+'></div>'
    +'<div class="fl"><label>Rate ($/hr) <span class="req">*</span></label><div class="pw"><span class="pfx">$</span><input type="text" id="ql-r" value="'+H(f.rate||'')+'" placeholder="150.00" oninput="A.qlSet(\'rate\',fmtCur(this.value))"></div></div></div>'
    +'<div class="fl" style="margin-bottom:14px"><label>Description</label>'
    +'<input type="text" id="ql-d" value="'+H(f.description||'')+'" placeholder="What did you work on?" oninput="A.qlSet(\'description\',this.value)" onkeydown="if(event.key===\'Enter\')A.saveQL()"></div>'
    +(total?'<div class="total-pill">Total: <strong>'+total+'</strong></div>':'')
    +(ST.descPresets.length>0?'<div class="desc-chips"><span style="font-size:11px;color:var(--ink3);margin-right:4px">Suggestions:</span>'+ST.descPresets.map(function(p,i){return '<button type="button" class="desc-chip" onclick="A.pickDesc(\'ql-d\','+i+')">'+ H(p)+'</button>';}).join('')+'</div>':'')
    +'<div class="fa" style="margin-top:0">'
    +'<button class="btn btn-gh" onclick="A.closeQL()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveQL()"'+((!f.clientId||!f.hours||!f.rate)?' disabled':'')+'>'
    +IC.save+' '+(f.addToId?'Add Hours':'Save Entry')
    +'</button>'
    +'</div></div></div></div>';
}

function buildHelp(){
  var tabs=[['start','Getting Started'],['time','Time Entries'],['clients','Clients & Matters'],['export','Export & Backup'],['offline','Using Offline'],['faq','FAQ']];
  var content={
    start:'<h3>Welcome to SixMinuteLog.com!</h3><p>A private billing and time-tracking app. All data stays on your device - no accounts, no cloud, no fees.</p>'
      +'<h4>Recommended Setup Order</h4><ol><li>Go to <strong>Contacts</strong> \u2248 add yourself and team members (with hourly rates'+(ST.prefs.revenueSplit?' and personal cut %':'')+')</li>'
      +'<li>Go to <strong>Clients</strong> \u2248 add your clients with default billing rates</li>'
      +'<li>Go to <strong>Matters</strong> \u2248 create matters/projects per client</li>'
      +'<li>Go to <strong>Timesheet</strong> \u2248 start logging your time!</li></ol>'
      +'<h4>Rate Priority System</h4><p>Rates fill automatically: <strong>Matter Rate \u2248 Contact Rate \u2248 Client Rate</strong>. Always overrideable.</p>'
      +(ST.prefs.revenueSplit?'<h4>Own vs. Firm Split</h4><p>Each contact and your user profile has a "Personal Cut %" field. The Analytics tab shows a split table breaking down who keeps what.</p>':'')
      +'<h4>Quick Log &#9889;</h4><p>The &#9889; button opens a popup with a stopwatch. When stopped, the exact measured time is shown and stored — no forced minimum or rounding. Adjust the hours field before saving if needed for billing.</p>',
    time:'<h3>Logging Time</h3><h4>Full Entry</h4><p>Click "New Entry". Hours accept any decimal value (e.g. 1.5, 0.25). Required: Date, Client, Hours, Rate.</p>'
      +'<h4>Form Field Preservation</h4><p>Changing a dropdown (client, matter, team member) will not clear your other typed fields - hours, rate, description are all preserved.</p>'
      +'<h4>Quick Log &#9889;</h4><p>Tap &#9889;, start the stopwatch, stop when done. The exact measured time is stored on the entry — hover the hours value in the timesheet to see it. You can adjust the billed hours before saving.</p>'
      +'<h4>Precision</h4><p>Hours display to 1 decimal place in all billing views. The underlying stored value is full precision (up to 4 decimal places). Timer-measured entries also store the exact raw milliseconds for audit purposes.</p>'
      +'<h4>Filters</h4><p>Use the dropdown to filter by Today, This Week, This Month, This Year, or All Time.</p>',
    clients:'<h3>Clients & Matters</h3><h4>Clients</h4><p>Each client has a name, contact info, and a default billing rate.</p>'
      +'<h4>Matters</h4><p>Matters are projects/cases linked to a client with an optional override rate.</p>'
      +'<h4>Linking in Time Entries</h4><ol><li>Select the <strong>Client</strong> first</li><li>Matter dropdown shows only that client\'s matters</li><li>Rate auto-fills without clearing other fields</li></ol>',
    export:'<h3>Export & Backup</h3><h4>Smart Filename</h4><p>The export filename reflects what you\'ve selected to export and includes the exact time. Example: <code>billing-entries+summary_2025-01-15_1430.csv</code></p>'
      +'<h4>Granular Controls</h4><p>In ⚙️ Settings you can choose which sections to include, which columns to include for time entries, and optionally filter by date range.</p>'
      +(ST.prefs.revenueSplit?'<h4>Revenue Split Export</h4><p>Enable "Revenue Split" in export settings to include a per-person own/firm breakdown in the CSV.</p>':'')
      +'<div class="note">⚠️ Clearing browser data will erase your data. Export regularly!</div>',
    offline:'<h3>Using Offline</h3><h4>This File IS the App</h4><p>The <code>billing-tracker.html</code> file contains everything - zero external dependencies. It works 100% offline.</p>'
      +'<h4>How to Run</h4><ol><li>Save the HTML file anywhere</li><li>Double-click to open in browser</li><li>Bookmark it for easy access</li><li>Always use the same browser</li></ol>'
      +'<div class="good">✅No internet required. No CDN, no cloud, nothing external.</div>',
    faq:'<h3>FAQ</h3>'+[
      ['Where is my data stored?','In your browser\'s IndexedDB — a local database built into every modern browser. Nothing is ever uploaded or sent anywhere. Preferences are also cached in localStorage for instant startup.'],
      ['Why doesn\'t changing a dropdown clear my typed fields?','Fixed! The app now saves all field values before re-rendering on any dropdown change.'],
      ...(ST.prefs.revenueSplit?[['How does the revenue split work?','Set a "Personal Cut %" on each contact (e.g. 65 means they keep 65%, firm gets 35%). Analytics shows the full breakdown.']]:[] ),
      ['Hours precision — what is stored vs. displayed?','Hours are stored at full precision (up to 4 decimal places). Timer entries also store exact raw milliseconds. In billing views, 1 decimal place is shown (e.g. 1.3h). Hover a timer-derived hours value in the timesheet to see the exact stored time.'],
      ['How do I customize the export filename?','The filename auto-generates based on what sections you\'ve selected to export, plus the date and time.'],
      ['What browsers work?','Chrome is most reliable. Firefox, Edge, and Safari all work too.'],
      ['Can I use this offline?','Yes - the file has zero external dependencies. Download and double-click.'],
    ].map(function(q){return '<div class="faq-item"><strong>'+H(q[0])+'</strong><p>'+H(q[1])+'</p></div>';}).join('')
  };
  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.help+' Help & Guide</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="help-lay"><div class="help-nav">'+tabs.map(function(t){return '<button class="'+(ST.helpTab===t[0]?'on':'')+'" onclick="A.setHT(\''+t[0]+'\')">'+H(t[1])+'</button>';}).join('')+'</div>'
    +'<div class="help-body">'+(content[ST.helpTab]||'')+'</div></div></div></div>';
}

function buildExportModal(){
  var s=ST.settings;
  var fname=exportFilename();
  var presets=[['Full','full'],['Billing','billing'],['Dirs','dirs'],['Summary','sum'],['W/Split','wsplit'],['T+Split','tsplit']];
  var sections=[
    ['te','Time Entries','Individual billing records'],
    ['cl','Clients','Client info & rates'],
    ['ma','Matters','Matter details'],
    ['co','Contacts','Team directory'],
    ['su','Summary','Totals & counts'],
    ['split','Revenue Split','Own vs. firm per person']
  ];
  var colRows=[
    ['tc_date','Date'],['tc_client','Client'],['tc_matter','Matter'],['tc_team','Team Member'],
    ['tc_desc','Description'],['tc_hours','Hours'],['tc_rate','Rate'],['tc_amount','Amount'],['tc_by','Created By']
  ];
  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.dl+' Export Data</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
  +'<div class="modal-bd">'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:10px">Quick Export</h3>'
  +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">'
  +'<button class="btn btn-dk" style="flex-direction:column;padding:12px 8px;gap:3px;height:auto" onclick="A.exportJSON();A.closeM()">'+IC.save+'<span style="font-size:12px;font-weight:500">Full Backup</span><span style="font-size:10px;opacity:.8">.json &mdash; everything</span></button>'
  +'<button class="btn btn-gr" style="flex-direction:column;padding:12px 8px;gap:3px;height:auto" onclick="A.exportCSV();A.closeM()">'+IC.dl+'<span style="font-size:12px;font-weight:500">Export CSV</span><span style="font-size:10px;opacity:.8">using settings below</span></button>'
  +'<button class="btn btn-gh" style="flex-direction:column;padding:12px 8px;gap:3px;height:auto" onclick="A.openMailSend()">'+IC.mail+'<span style="font-size:12px;font-weight:500">Email CSV</span><span style="font-size:10px;opacity:.8">via mail preset</span></button>'
  +'</div></div>'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:8px">CSV Presets</h3>'
  +'<div class="preset-grid">'
  +presets.map(function(p){return '<button class="preset-btn" onclick="A.applyPreset(\''+p[1]+'\')">'+'<strong>'+H(p[0])+'</strong></button>';}).join('')
  +'</div></div>'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:8px">Sections to Include</h3>'
  +sections.map(function(r){return '<label class="crow" style="margin-bottom:6px"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"><div><strong>'+H(r[1])+'</strong><span>'+H(r[2])+'</span></div></label>';}).join('')
  +(s.te?'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin:10px 0 6px">Time entry columns</div>'
    +'<div class="sub-checks">'
    +colRows.map(function(r){return '<label class="sub-check"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"> '+H(r[1])+'</label>';}).join('')
    +'</div>':'')
  +'</div>'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:8px">Date Range <span style="font-size:11px;color:var(--ink3);font-weight:400">(time entries only)</span></h3>'
  +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">'
  +'<div class="fl"><label>From</label><input type="date" id="exp-from" value="'+H(s.expFrom||'')+'" onchange="(function(el){ST.settings.expFrom=el.value;save();})(this)"></div>'
  +'<div class="fl"><label>To</label><input type="date" id="exp-to" value="'+H(s.expTo||'')+'" onchange="(function(el){ST.settings.expTo=el.value;save();})(this)"></div>'
  +'</div></div>'
  +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
  +'<h3 style="margin-bottom:8px">Export by Data Type</h3>'
  +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px">Export one data type as its own CSV file.</p>'
  +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
  +[['clients','Clients'],['matters','Matters'],['entries','Time Entries'],['contacts','Contacts'],['settings','Settings']].map(function(t){
    return '<button class="btn btn-gh" style="justify-content:flex-start" onclick="A.exportEntityCSV(\''+t[0]+'\')">'+IC.dl+' '+H(t[1])+'</button>';
  }).join('')
  +'</div></div>'
  +'</div>'
  +'<div class="modal-ft" style="justify-content:space-between;align-items:center">'
  +'<div class="exp-name-preview" style="margin:0;flex:1;margin-right:12px">'+H(fname)+'</div>'
  +'<div style="display:flex;gap:8px">'
  +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
  +'<button class="btn btn-dk" onclick="A.exportJSON();A.closeM()">'+IC.save+' Backup</button>'
  +'<button class="btn btn-gr" onclick="A.exportCSV();A.closeM()">'+IC.dl+' Export CSV</button>'
  +'</div></div>'
  +'</div></div>';
}


function buildImportModal(){
  return '<div class="ov"><div class="modal modal-md"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.ul+' Import Data</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
  +'<div class="modal-bd">'

  // Firm Profile import
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">&#127968; Firm Profile Import</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Import a firm profile distributed by your IT administrator. Applies branding, pre-configured clients, contacts, description presets, and user profiles.</p>'
  +'<input type="file" id="imp-profile" accept=".json" style="display:none" onchange="A.importFirmProfile(this)">'
  +'<button class="btn btn-dk" onclick="document.getElementById(\'imp-profile\').click()">'+IC.ul+' Import Firm Profile (.json)</button>'
  +'</div>'

  // Full JSON backup restore
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">'+IC.save+' Full Backup Restore</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Restore a complete JSON backup. <strong style="color:var(--red)">Replaces all current data.</strong> Use this to restore from a full backup file.</p>'
  +'<input type="file" id="imp-json" accept=".json" style="display:none" onchange="A.importJSON(this)">'
  +'<button class="btn btn-dk" onclick="document.getElementById(\'imp-json\').click()">'+IC.ul+' Choose Backup File (.json)</button>'
  +'</div>'

  // Combined CSV (legacy full export)
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">'+IC.doc+' Combined CSV Import</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Import a combined export CSV (containing TIME ENTRIES, CLIENTS, MATTERS, CONTACTS sections). Client/matter names are matched automatically. <strong style="color:var(--amber)">Replaces matched data types.</strong></p>'
  +'<input type="file" id="imp-csv-all" accept=".csv" style="display:none" onchange="A.importCSV(this)">'
  +'<button class="btn btn-gh" onclick="document.getElementById(\'imp-csv-all\').click()">'+IC.ul+' Choose Combined CSV</button>'
  +'</div>'

  // Individual CSV imports
  +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
  +'<h3 style="display:flex;align-items:center;gap:7px">'+IC.chart+' Import Individual CSV</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:14px;line-height:1.6">Import a single-entity CSV exported from the Settings &rarr; Export tab. Each import <strong style="color:var(--amber)">replaces that entity type only</strong>. Import clients before matters; import matters before entries.</p>'
  +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
  +(function(){
    var ents=[
      {t:'clients',  l:'Clients (.csv)'},
      {t:'matters',  l:'Matters (.csv)'},
      {t:'entries',  l:'Time Entries (.csv)'},
      {t:'contacts', l:'Contacts (.csv)'},
      {t:'settings', l:'Settings (.csv)'}
    ];
    return ents.map(function(e){
      return '<input type="file" id="imp-ent-'+e.t+'" accept=".csv" data-etype="'+e.t+'" style="display:none" onchange="A.importEntityCSV(this,this.dataset.etype)">'
        +'<button class="btn btn-gh" style="justify-content:flex-start" onclick="document.getElementById(\'imp-ent-'+e.t+'\').click()">'+IC.ul+' '+H(e.l)+'</button>';
    }).join('');
  })()
  +'</div>'
  +'<div class="note" style="margin-top:12px">&#9888;&#65039; <strong>Order matters:</strong> always import Clients first, then Matters, then Time Entries. This ensures client/matter name lookup works correctly.</div>'
  +'</div>'

  +'</div>'
  +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Close</button></div>'
  +'</div></div>';
}

function buildSettings(){
  var s=ST.settings;
  var stab=ST.settingsTab||'export';
  var fname=exportFilename();
  var presets=ST.prefs.revenueSplit?[['Full Export','full'],['Billing Only','billing'],['Clients & Contacts','dirs'],['Summary Only','sum'],['With Split','wsplit'],['Time + Split','tsplit']]:[['Full Export','full'],['Billing Only','billing'],['Clients & Contacts','dirs'],['Summary Only','sum']];
  var teColRows=[
    ['tc_date','Date'],['tc_client','Client'],['tc_matter','Matter'],['tc_team','Team Member'],
    ['tc_desc','Description'],['tc_hours','Hours'],['tc_rate','Rate'],['tc_amount','Amount'],['tc_by','Created By']
  ];
  var settingsTabs=[['export','Export'],['appearance','Appearance'],['descriptions','Descriptions'],['email','Email'],['advanced','Advanced'],['itadmin','IT Admin']];
  var tabNav='<div class="set-tabs">'+settingsTabs.map(function(t){return '<button class="set-tab'+(stab===t[0]?' on':'')+'" onclick="A.setStab(\''+t[0]+'\')">'+H(t[1])+'</button>';}).join('')+'</div>';
  var body='';

  if(stab==='export'){
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<div class="preset-grid">'
      +presets.map(function(p){return '<button class="preset-btn" onclick="A.applyPreset(\''+p[1]+'\')"><strong>'+H(p[0])+'</strong></button>';}).join('')
      +'</div>'
      +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">Sections to include</div>'
      +(ST.prefs.revenueSplit?[['te','Time Entries','Individual billing records'],['cl','Clients','Client info & rates'],['ma','Matters','Matter details'],['co','Contacts','Team directory'],['su','Summary','Totals & counts'],['split','Revenue Split','Own vs. firm per person']]:[['te','Time Entries','Individual billing records'],['cl','Clients','Client info & rates'],['ma','Matters','Matter details'],['co','Contacts','Team directory'],['su','Summary','Totals & counts']])
        .map(function(r){return '<label class="crow"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"><div><strong>'+H(r[1])+'</strong><span>'+H(r[2])+'</span></div></label>';}).join('')
      +(s.te?'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin:12px 0 8px">Time entry columns</div>'
      +'<div class="sub-checks">'
      +teColRows.map(function(r){return '<label class="sub-check"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"> '+H(r[1])+'</label>';}).join('')
      +'</div>':'')
      +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin:12px 0 8px">Date range (for time entries)</div>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">'
      +'<div class="fl"><label>From</label><input type="date" id="exp-from" value="'+H(s.expFrom||'')+'" onchange="A.setExpDate(\'expFrom\',this.value)"></div>'
      +'<div class="fl"><label>To</label><input type="date" id="exp-to" value="'+H(s.expTo||'')+'" onchange="A.setExpDate(\'expTo\',this.value)"></div>'
      +'</div>'
      +'<div style="margin-top:12px"><div style="font-size:11px;color:var(--ink3);margin-bottom:5px">Export filename preview</div>'
      +'<div class="exp-name-preview">'+H(fname)+'</div>'
      +'<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">'
      +'<button class="btn btn-gr" onclick="A.openExportModal()">'+IC.dl+' Export / Backup</button>'
      +(ST.mailPresets.length>0?'<button class="btn btn-bl" onclick="A.openMailSend()">'+IC.mail+' Send via Email</button>':'')
      +'</div></div></div>'
      // JSON Backup section
      +'<div class="set-section" style="margin-top:16px">'
      +'<h3 style="margin-bottom:8px">Full Backup</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px;line-height:1.5">Export everything (clients, matters, entries, contacts, settings, preferences) as a single JSON file. Perfect for complete backups before browser changes.</p>'
      +'<button class="btn btn-dk" onclick="A.exportJSON()">'+IC.dl+' Download Full Backup (.json)</button>'
      +'</div>'
      // Individual CSV exports section
      +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3 style="margin-bottom:8px">Export Individual CSV</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px;line-height:1.5">Export a single data type as CSV. Use these for selective imports or sharing specific data.</p>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
      +[['clients','Clients'],['matters','Matters'],['entries','Time Entries'],['contacts','Contacts'],['settings','Settings']].map(function(t){
        return '<button class="btn btn-gh" style="justify-content:flex-start" onclick="A.exportEntityCSV(\''+t[0]+'\')">'+IC.dl+' '+t[1]+'</button>';
      }).join('')
      +'</div>'
      +'</div>'
  }

  if(stab==='appearance'){
    var p=ST.prefs;
    var layouts=[['comfortable','Comfortable','Default balanced spacing'],['compact','Compact','Dense UI for more data'],['spacious','Spacious','Relaxed layout, larger text']];
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>App Name</h3>'
      +'<div style="display:flex;gap:10px;align-items:center;margin-bottom:18px">'
      +'<input type="text" id="pref-name" value="'+H(p.appName||'SixMinuteLog.com')+'" placeholder="SixMinuteLog.com" style="flex:1;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)">'
      +'<button class="btn btn-dk" onclick="A.saveAppName()">Save</button>'
      +'</div>'
      +'<h3>Dark Mode</h3>'
      +'<div class="preset-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:18px">'
      +[['null','Auto','Follows your browser or OS setting'],['false','Light','Always use light theme'],['true','Dark','Always use dark theme']].map(function(opt){
        var active=String(p.darkMode)===opt[0];
        return '<button class="preset-btn'+(active?' on':'')+'" style="'+(active?'border-color:var(--ink);background:var(--bg)':'')+'" onclick="A.setDarkMode('+opt[0]+')"><strong>'+opt[1]+'</strong><span style="font-size:11px;color:var(--ink3);display:block;margin-top:2px">'+opt[2]+'</span></button>';
      }).join('')
      +'</div>'
      +'<h3>Layout Density</h3>'
      +'<div class="preset-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:0">'
      +layouts.map(function(l){return '<button class="preset-btn'+(p.layout===l[0]?' on':'')+'" style="'+(p.layout===l[0]?'border-color:var(--ink);background:var(--bg)':'')+'" onclick="A.setLayout(\''+l[0]+'\')"><strong>'+H(l[1])+'</strong><span style="font-size:11px;color:var(--ink3);display:block;margin-top:2px">'+H(l[2])+'</span></button>';}).join('')
      +'</div></div>';
  }

  if(stab==='descriptions'){
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>Default Description Suggestions</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.6">These appear as clickable chips below description fields in the time entry form and Quick Log, letting you quickly select common descriptions.</p>'
      +(ST.descPresets.length>0
        ? ST.descPresets.map(function(p,i){
          return '<div class="preset-item"><span>'+H(p)+'</span>'
            +'<button title="Move up" onclick="A.moveDesc('+i+',-1)">'
              +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg>'
            +'</button>'
            +'<button title="Move down" onclick="A.moveDesc('+i+',1)">'
              +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>'
            +'</button>'
            +'<button title="Edit" onclick="A.editDescPreset('+i+')" style="color:var(--blue)">'+IC.edit+'</button>'
            +'<button title="Delete" onclick="A.delDesc('+i+')">'+IC.trash+'</button>'
            +'</div>';
        }).join('')
        : '<div class="empty" style="padding:24px"><p>No descriptions yet</p></div>'
      )
      +'<div style="display:flex;gap:8px;margin-top:12px">'
      +'<input type="text" id="desc-new" placeholder="Add a description suggestion..." style="flex:1;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)" onkeydown="if(event.key===\'Enter\')A.addDesc()">'
      +'<button class="btn btn-dk" onclick="A.addDesc()">'+IC.plus+' Add</button>'
      +'</div></div>';
  }

  if(stab==='email'){
    var PRIO_STYLE={high:'color:var(--red)',normal:'color:var(--ink3)',low:'color:var(--ink3)'};
    var PRIO_LABEL={high:'\u25b2 High',normal:'Normal',low:'\u25bc Low'};
    var TYPE_LABELS={invClient:'Invoice → Client',invApproval:'Partner Approval',invDecision:'Review Decision',tsApproval:'Submit for Approval',tsSummary:'Billing Summary',all:'All types'};
    // ── Email Block Templates ──────────────────────────────────────────────
    body+='<div class="set-section">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<div><h3 style="margin:0">Email Block Templates</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin:4px 0 0;line-height:1.5">Build reusable email compositions from blocks. Users select a template when sending — they only see the recipient and subject fields.</p></div>'
      +'<button class="btn btn-dk" onclick="A.etOpen(null,null)">'+IC.plus+' New Template</button>'
      +'</div>'
      +(ST.emailTemplates.length>0
        ? ST.emailTemplates.map(function(tpl,i){
          var typeChips=(tpl.types||[]).map(function(t){return '<span class="chip" style="font-size:10px;padding:1px 7px">'+H(TYPE_LABELS[t]||t)+'</span>';}).join(' ');
          var visB=tpl.blocks.filter(function(b){return !b.hidden;}).length;
          return '<div class="mail-preset-card">'
            +'<div class="mp-acts">'
            +'<button class="btn-ic" onclick="A.etOpen(\''+tpl.id+'\',null)" title="Edit">'+IC.edit+'</button>'
            +'<button class="btn-ic" onclick="A.etDelete(\''+tpl.id+'\')" title="Delete">'+IC.trash+'</button>'
            +'</div>'
            +'<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:5px">'
            +'<h4 style="margin:0">'+H(tpl.name)+'</h4>'
            +(typeChips||'<span class="chip" style="font-size:10px;padding:1px 7px;opacity:.5">No type set</span>')
            +'</div>'
            +(tpl.description?'<p style="font-size:11px;color:var(--ink3);margin-bottom:4px">'+H(tpl.description)+'</p>':'')
            +(tpl.defaultSubject?'<p style="font-size:11px">Subject: '+H(tpl.defaultSubject)+'</p>':'')
            +'<p style="font-size:11px;color:var(--ink3)">'+visB+' visible block'+(visB!==1?'s':'')+(tpl.blocks.length>visB?' (+'+(tpl.blocks.length-visB)+' hidden)':'')+'</p>'
            +'</div>';
        }).join('')
        : '<div class="empty" style="padding:20px"><p>No email templates yet</p><small>Create a template to enable the block-based email composer when sending invoices and time entries.</small></div>'
      )
      +'</div>'
    // ── Mail / CSV Presets (existing) ──────────────────────────────────────
    +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>CSV Email Presets</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.6">Simpler presets for sending exported CSV reports via your email client — define recipient, subject and body text.</p>'
      +(ST.mailPresets.length>0
        ? ST.mailPresets.map(function(mp,i){
          var pri=mp.priority||'normal';
          return '<div class="mail-preset-card">'
            +'<div class="mp-acts">'
            +'<button class="btn-ic" onclick="A.dupMailPreset('+i+')" title="Duplicate">'+IC.copy+'</button>'
            +'<button class="btn-ic" onclick="A.editMailPreset('+i+')" title="Edit">'+IC.edit+'</button>'
            +'<button class="btn-ic" onclick="A.delMailPreset('+i+')" title="Delete">'+IC.trash+'</button>'
            +'</div>'
            +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">'
            +'<h4 style="margin:0">'+H(mp.name||'Preset '+(i+1))+'</h4>'
            +'<span class="status-badge '+(({general:'s-neutral',invoice_client:'s-approved',billing_staff:'s-review',partner_approval:'s-pending'}[mp.purpose||'general']||'s-neutral')+'" style="font-size:10px;padding:2px 7px">'+purposeLabel(mp.purpose||'general')+'</span>')
            +(pri!=='normal'?'<span style="font-size:10px;font-weight:600;'+PRIO_STYLE[pri]+'">'+PRIO_LABEL[pri]+'</span>':'')
            +'</div>'
            +(mp.to?'<p>To: '+H(mp.to)+'</p>':'<p style="color:var(--ink3);font-size:11px">To: auto-filled from context</p>')
            +(mp.cc?'<p style="font-size:11px">CC: '+H(mp.cc)+'</p>':'')
            +(mp.bcc?'<p style="font-size:11px">BCC: '+H(mp.bcc)+'</p>':'')
            +(mp.replyTo?'<p style="font-size:11px">Reply-To: '+H(mp.replyTo)+'</p>':'')
            +(mp.subject?'<p>Subject: '+H(mp.subject)+'</p>':'')
            +(mp.body?'<p style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:400px;font-size:11px;color:var(--ink3)">'+H(mp.body)+'</p>':'')
            +(mp.signature?'<p style="font-size:10px;color:var(--ink3);font-style:italic">\u2014 Signature attached</p>':'')
            +'<button class="btn btn-bl" style="margin-top:10px;font-size:12px" onclick="A.sendMailPreset('+i+')">'+IC.mail+' Send via Email</button>'
            +'</div>';
        }).join('')
        : '<div class="empty" style="padding:20px"><p>No CSV presets yet</p></div>'
      )
      +'<button class="btn btn-dk" style="margin-top:12px" onclick="A.openMailPreset(null)">'+IC.plus+' New CSV Preset</button>'
      +'</div>';
  }

  if(stab==='advanced'){
    body+='<div class="set-section"><h3>Current User</h3>'
      +'<div style="display:flex;justify-content:space-between;align-items:center;background:var(--bg);border-radius:8px;padding:12px 16px;margin-bottom:10px">'
      +'<div><div style="font-weight:500;font-size:13px">'+H(ST.user?ST.user.name:'Not set')+'</div>'
      +'<div style="font-size:12px;color:var(--ink3)">'+(ST.user&&ST.user.initials?ST.user.initials+' \u00b7 ':'')+( ST.prefs.revenueSplit&&ST.user&&ST.user.ownPct!=null?ST.user.ownPct+'% personal cut\u00b7 ':'')+(ST.user?roleBadge(ST.user.role):'')+' '+'</div></div>'
      +'<button class="btn btn-gh" onclick="A.chgUser()" style="font-size:13px">Edit Profile</button>'
      +'</div></div>'
      +'<div class="set-section"><h3>Display Options</h3>'
      +'<label class="crow"><input type="checkbox" '+(s.te_group?'checked':'')+' onchange="A.togExp(\'te_group\',this.checked)"><div><strong>Group entries by client</strong><span>Adds a sub-header row between each client\'s entries in export</span></div></label>'
      +'</div>'
      +'<div class="set-section"><h3>Advanced Features</h3>'
      +'<label class="crow"><input type="checkbox" '+(ST.prefs.revenueSplit?'checked':'')+' onchange="A.togRevenueSplit(this.checked)"><div><strong>Revenue Split &amp; Personal Cut</strong><span>Track own vs. firm portions, per-person earnings, and split analytics. Adds Personal Cut % fields to contacts and your profile.</span></div></label>'
      +'</div>'
      +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<div class="danger"><h3>Danger Zone</h3><p>Permanently delete all data. Export a backup first!</p>'
      +'<button class="btn btn-rd" onclick="A.resetAll()">'+IC.rst+' Reset All Data</button></div>'
      +'</div>';
  }

  if(stab==='itadmin'){
    var fp=ST.firmProfile||{};
    var itUsers=fp.users||[];
    body+='<div class="set-section">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<h3 style="margin:0">IT Admin Mode</h3>'
      +'<label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">'
      +'<input type="checkbox" '+(ST.itMode?'checked':'')+' onchange="A.togITMode(this.checked)">'
      +'<span>'+(ST.itMode?'<strong style="color:var(--blue)">Enabled</strong>':'Disabled')+'</span></label>'
      +'</div>'
      +'<p style="font-size:12px;color:var(--ink3);line-height:1.6;margin-bottom:0">IT Admin mode lets you build a firm profile package (app name, firm name, pre-configured clients, contacts, users, description presets) that can be exported and imported by other users on first setup or via Settings.</p>'
      +'</div>'
      +(ST.itMode?
        '<div class="set-section">'
        +'<h3>Firm Identity</h3>'
        +'<div class="frow c2" style="margin-bottom:12px">'
        +'<div class="fl"><label>Firm Name</label><input type="text" id="it-firmname" value="'+H(fp.firmName||'')+'" placeholder="e.g. Smith &amp; Associates LLP" /></div>'
        +'<div class="fl"><label>App Name</label><input type="text" id="it-appname" value="'+H(fp.appName||ST.prefs.appName||'SixMinuteLog.com')+'" placeholder="SixMinuteLog.com" /></div>'
        +'</div>'
        +'<button class="btn btn-dk" onclick="A.saveITFirm()">'+IC.save+' Save Firm Identity</button>'
        +'</div>'
        +'<div class="set-section">'
        +'<h3>Pre-configured Users</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:12px;line-height:1.5">Users defined here will appear as selectable profiles when a new user imports the firm profile for the first time. Each gets their own name, initials, role, rate, and ownership %.</p>'
        +(itUsers.length>0
          ? itUsers.map(function(u,i){
              return '<div class="crow" style="margin-bottom:8px;background:var(--bg);border-radius:8px;padding:10px 14px">'
                +'<div style="flex:1"><strong style="font-size:13px">'+H(u.name)+'</strong>'
                +'<div style="font-size:11px;color:var(--ink3)">'+H(u.initials||'')+(u.role?' | '+H(u.role):'')+(u.rate?' | $'+H(u.rate)+'/hr':'')+(u.ownPct!=null?' | '+H(String(u.ownPct))+'% cut':'')+'</div></div>'
                +'<button class="btn-ic" onclick="A.editITUser('+i+')" title="Edit">'+IC.edit+'</button>'
                +'<button class="btn-ic" onclick="A.delITUser('+i+')" title="Delete">'+IC.trash+'</button>'
                +'</div>';
            }).join('')
          : '<div class="empty" style="padding:16px"><p>No users configured</p></div>'
        )
        +'<button class="btn btn-dk" style="margin-top:10px" onclick="A.openITUser(null)">'+IC.plus+' Add User</button>'
        +'</div>'
        +'<div class="set-section">'
        +'<h3>Pre-configured Data to Include in Profile</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:12px;line-height:1.5">Choose which current app data to bundle into the exported profile. New users who import the profile will receive this data as a starting point.</p>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-clients" '+(fp.includeClients?'checked':'')+' onchange="A.togITInclude(\'includeClients\',this.checked)"><div><strong>Clients</strong><span>'+ST.clients.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-matters" '+(fp.includeMatters?'checked':'')+' onchange="A.togITInclude(\'includeMatters\',this.checked)"><div><strong>Matters</strong><span>'+ST.matters.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-contacts" '+(fp.includeContacts?'checked':'')+' onchange="A.togITInclude(\'includeContacts\',this.checked)"><div><strong>Contacts</strong><span>'+ST.contacts.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-presets" '+(fp.includePresets?'checked':'')+' onchange="A.togITInclude(\'includePresets\',this.checked)"><div><strong>Description Presets</strong><span>'+ST.descPresets.length+' in app</span></div></label>'
        +'</div>'
        +'</div>'
        +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
        +'<h3>Export &amp; Share Profile</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.5">Download the firm profile as a <code style="font-size:11px;background:var(--bg);padding:1px 5px;border-radius:4px">.json</code> file. Share it with your team - they import it on first launch or via Settings &rarr; Import.</p>'
        +'<div style="display:flex;gap:10px;flex-wrap:wrap">'
        +'<button class="btn btn-gr" onclick="A.exportFirmProfile()">'+IC.dl+' Download Firm Profile (.json)</button>'
        +'</div>'
        +'</div>'
      : '')
    ;
  }

  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.gear+' Settings</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'+tabNav+body+'</div>'
    +'<div class="modal-ft" style="flex-wrap:wrap;gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
    +'<button class="btn btn-gh" onclick="A.dlManifest()" title="Regenerate CLAUDE_BILLING.md" style="color:var(--purple);border-color:var(--purple)">'+IC.dl+' Claude Guide</button>'
    +'</div></div></div>';
}

function buildITUserModal(){
  var f=ST.itf||{};
  var isEdit=(f.editIdx!=null);
  var roleOpts=[
    {v:'attorney',l:'Attorney'},
    {v:'partner',l:'Partner'},
    {v:'billing_staff',l:'Billing Staff'}
  ].map(function(o){return '<option value="'+o.v+'"'+(f.role===o.v?' selected':'')+'>'+H(o.l)+'</option>';}).join('');
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.usr+' '+(isEdit?'Edit':'Add')+' Profile User</h2>'
    +'<button class="btn-ic" onclick="A.closeITUser()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div class="fl" style="margin-bottom:14px"><label>Name <span class="req">*</span></label>'
    +'<input type="text" id="itu-name" value="'+H(f.name||'')+'" placeholder="e.g. Sarah Johnson" /></div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label>Initials</label><input type="text" id="itu-ini" value="'+H(f.initials||'')+'" maxlength="4" placeholder="SJ" />'
    +'<div class="hint">Auto-generated if blank</div></div>'
    +'<div class="fl"><label>Role</label><select id="itu-role">'+roleOpts+'</select></div>'
    +'</div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label>Default Rate ($/hr)</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="itu-rate" value="'+H(f.rate||'')+'" placeholder="150.00" /></div></div>'
    +(ST.prefs.revenueSplit?'<div class="fl"><label>Personal Cut %</label>'
    +'<div class="pw"><input type="number" id="itu-pct" min="0" max="100" step="1" value="'+H(f.ownPct!=null?String(f.ownPct):'100')+'" placeholder="100" /><span class="sfx">%</span></div></div>':'')
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeITUser()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveITUser()">'+IC.save+' '+(isEdit?'Update':'Add')+' User</button>'
    +'</div></div></div>';
}

// Shared: splash left-panel hero HTML
function splashHero(steps,activeIdx){
  var appName=H(ST.prefs.appName||'SixMinuteLog.com');
  var stepsH=steps.map(function(s,i){
    var cls='splash-step'+(i<activeIdx?' done':i===activeIdx?' active':'');
    return '<div class="'+cls+'"><div class="splash-step-dot"></div><span>'+s+'</span></div>';
  }).join('');
  return '<div class="splash-hero">'
    +'<div class="splash-logo">'
    +'<div class="splash-logo-mark"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>'
    +'<span class="splash-logo-name">'+appName+'</span>'
    +'</div>'
    +'<div class="splash-tagline"><h1>Legal billing,<br><strong>without the friction.</strong></h1>'
    +'<p>Track time, manage clients, and generate invoices \u2014 all in one place, fully offline.</p></div>'
    +'<div class="splash-steps">'+stepsH+'</div>'
    +'</div>';
}

function buildProfileImport(){
  var STEPS=['Firm Setup','Your Profile'];
  var arrowSvg='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
  return '<div class="splash-ov">'
    +splashHero(STEPS,0)
    +'<div class="splash-form">'
    +'<div class="splash-form-inner">'
    +'<h2>Welcome to <strong>'+H(ST.prefs.appName||'SixMinuteLog.com')+'</strong></h2>'
    +'<p class="sub">Get started in seconds. If your firm administrator shared a profile file, import it to pre-load your clients, contacts, and settings. Otherwise, set up manually.</p>'

    +'<div class="splash-opt" onclick="document.getElementById(\'spl-prof-inp\').click()">'
    +'<div class="splash-opt-icon blue">'+IC.ul+'</div>'
    +'<div class="splash-opt-body"><strong>Import Firm Profile</strong><span>Load pre-configured clients, matters, contacts, and user profiles from a .json file provided by your administrator.</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div>'
    +'<input type="file" id="spl-prof-inp" accept=".json" style="display:none" onchange="A.importFirmProfile(this)">'

    +'<div class="splash-opt" onclick="A.skipProfileImport()">'
    +'<div class="splash-opt-icon slate"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>'
    +'<div class="splash-opt-body"><strong>Set Up Manually</strong><span>Enter your name and role now. You can add clients, matters, and team members any time from the app.</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div>'

    +'<div class="splash-features">'
    +'<div class="splash-features-title">What a firm profile includes</div>'
    +['Firm name &amp; app branding','Pre-configured clients &amp; matters','Team contacts &amp; roles','Description presets','Pre-defined user profiles'].map(function(t){
      return '<div class="splash-feature"><div class="splash-feature-dot"></div><span>'+t+'</span></div>';
    }).join('')
    +'</div>'
    +'</div>'
    +'<div class="splash-footer"><span class="splash-footer-note">\ud83d\udd12 All data stays on this device only</span></div>'
    +'</div></div>';
}

function buildITUserSelect(){
  var STEPS=['Firm Setup','Your Profile'];
  var fp=ST._importedProfile||{};
  var users=fp.users||[];
  var arrowSvg='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
  var firmName=H(fp.firmName||fp.appName||ST.prefs.appName||'Your Firm');
  var userCards=users.map(function(u,i){
    var ini=u.initials||(u.name?u.name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,3):'?');
    var roleLabel={attorney:'Attorney',partner:'Partner',billing_staff:'Billing Staff'}[u.role]||H(u.role||'');
    return '<div class="splash-user-card" onclick="A.pickITUser('+i+')">'
      +'<div class="splash-avatar">'+H(ini)+'</div>'
      +'<div class="splash-user-info"><strong>'+H(u.name)+'</strong><span>'+roleLabel+(u.rate?' \u00b7 $'+H(String(u.rate))+'/hr':'')+'</span></div>'
      +'<div class="splash-opt-arrow" style="margin-left:auto">'+arrowSvg+'</div>'
      +'</div>';
  }).join('');
  return '<div class="splash-ov">'
    +splashHero(STEPS,1)
    +'<div class="splash-form">'
    +'<div class="splash-form-inner">'
    +'<h2>Select <strong>your profile</strong></h2>'
    +'<p class="sub">'+firmName+' has pre-configured user profiles. Select yours to get started with the right permissions and billing rate.</p>'
    +userCards
    +'<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">'
    +'<div class="splash-opt" onclick="A.skipProfileImport()" style="margin-bottom:0;padding:14px 16px">'
    +'<div class="splash-opt-icon slate"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M6 20v-2a6 6 0 0 1 12 0v2"/></svg></div>'
    +'<div class="splash-opt-body"><strong>Custom profile</strong><span>My name isn\'t listed \u2014 set up manually</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div></div>'
    +'</div>'
    +'<div class="splash-footer"><span class="splash-footer-note">\ud83c\udfe2 '+firmName+' profile loaded</span></div>'
    +'</div></div>';
}


// ── Email Preset Builder helpers ────────────────────────────────────────
// Quick-template definitions: [label, purpose, subject, body, signature]
var MAIL_QUICK_TEMPLATES=[
  ['Invoice to Client','invoice_client',
   'Invoice #{invoice_num} \u2014 {client} \u2014 {date}',
   'Dear {client},\n\nPlease find your invoice #{invoice_num} totalling {amount}, covering the period through {date}.\n\nKindly arrange payment at your earliest convenience. Do not hesitate to reach out with any questions.',
   'Warm regards,\n{user}\n{firm}'],
  ['Approval Request','partner_approval',
   'Approval Required: {entries_count} Entries \u2014 {hours_total}h \u2014 {date}',
   'Hi,\n\nI am submitting {entries_count} billing entries ({hours_total}h) for your review and approval.\n\nPlease find the attached CSV for details. Let me know if any adjustments are needed.',
   'Thank you,\n{initials}\n{user}'],
  ['Billing Staff Report','billing_staff',
   'Billing Report \u2014 {hours_total}h \u2014 {date}',
   'Hi team,\n\nAttached is this period\u2019s billing report covering {entries_count} entries and {hours_total}h across {client}.\n\nPlease process at your earliest convenience.',
   'Best,\n{user}'],
  ['General / Custom','general',
   'Billing Report \u2014 {filename}',
   'Please find the attached billing data for your records.\n\nFile: {filename}\nDate: {date}',
   '{user}']
];

// Insert a placeholder token at cursor in the focused textarea/input, else append
function _mpInsert(token){
  var el=document.getElementById('mp-body')||document.getElementById('mp-subj');
  // try to detect which field was last focused
  var focused=document.activeElement;
  if(focused&&(focused.id==='mp-body'||focused.id==='mp-subj'||focused.id==='mp-sig')){
    el=focused;
  }
  if(!el) return;
  var s=el.selectionStart||0, e2=el.selectionEnd||0;
  var v=el.value;
  el.value=v.substring(0,s)+token+v.substring(e2);
  el.selectionStart=el.selectionEnd=s+token.length;
  el.focus();
  _mpPreview();
}

// Live preview renderer — reads all fields, replaces placeholders with sample data
function _mpPreview(){
  var pv=document.getElementById('mp-preview');
  if(!pv) return;
  var subj=(document.getElementById('mp-subj')||{value:''}).value;
  var body=(document.getElementById('mp-body')||{value:''}).value;
  var sig=(document.getElementById('mp-sig')||{value:''}).value;
  var full=body+(sig?'\n\n'+sig:'');
  var sampleData={
    '{filename}':'BillingReport_Jan2026.csv',
    '{date}':'January 2026',
    '{due_date}':'February 15, 2026',
    '{client}':'Acme Corporation',
    '{matter}':'Contract Review',
    '{firm}':'Smith & Associates LLP',
    '{invoice_num}':'INV-0042',
    '{amount}':'$3,250.00',
    '{entries_count}':'8',
    '{hours_total}':'12.5',
    '{user}':(ST.user&&ST.user.name)||'Sarah Johnson',
    '{initials}':(ST.user&&ST.user.initials)||'SJ',
    '{cc_list}':''
  };
  function rep(s){
    Object.keys(sampleData).forEach(function(k){s=s.split(k).join(sampleData[k]);});
    return s;
  }
  var rSubj=H(rep(subj||'(no subject)'));
  var rBody=H(rep(full||'(no body)')).replace(/\n/g,'<br>');
  var to=(document.getElementById('mp-to')||{value:''}).value||'client@example.com';
  var cc=(document.getElementById('mp-cc')||{value:''}).value;
  var bcc=(document.getElementById('mp-bcc')||{value:''}).value;
  var rt=(document.getElementById('mp-replyto')||{value:''}).value;
  pv.innerHTML='<div style="font-size:11px;color:var(--ink3);font-family:monospace;line-height:1.8">'
    +'<div><strong style="color:var(--ink2)">To:</strong> '+H(to)+'</div>'
    +(cc?'<div><strong style="color:var(--ink2)">CC:</strong> '+H(cc)+'</div>':'')
    +(bcc?'<div><strong style="color:var(--ink2)">BCC:</strong> '+H(bcc)+'</div>':'')
    +(rt?'<div><strong style="color:var(--ink2)">Reply-To:</strong> '+H(rt)+'</div>':'')
    +'<div><strong style="color:var(--ink2)">Subject:</strong> '+rSubj+'</div>'
    +'</div>'
    +'<hr style="border:none;border-top:1px solid var(--border);margin:8px 0">'
    +'<div style="font-size:12px;color:var(--ink);line-height:1.7;white-space:pre-wrap">'+rBody+'</div>';
}

// Apply a quick-template to the form fields
function _mpApplyTemplate(idx){
  var t=MAIL_QUICK_TEMPLATES[idx];
  if(!t) return;
  var purpEl=document.getElementById('mp-purpose');
  var subjEl=document.getElementById('mp-subj');
  var bodyEl=document.getElementById('mp-body');
  var sigEl=document.getElementById('mp-sig');
  if(purpEl) purpEl.value=t[1];
  if(subjEl) subjEl.value=t[2];
  if(bodyEl) bodyEl.value=t[3];
  if(sigEl) sigEl.value=t[4]||'';
  _mpPreview();
}
// ── End helpers ─────────────────────────────────────────────────────────

function buildMailPreset(){
  var f=ST.mpf||{};
  var isEdit=(f.editIdx!=null);
  var purp=f.purpose||'general';
  var ALL_PH=[
    ['{client}','Client name'],
    ['{matter}','Matter name'],
    ['{firm}','Firm name'],
    ['{user}','Your full name'],
    ['{initials}','Your initials'],
    ['{date}','Current month/year'],
    ['{due_date}','Due date (+30 days)'],
    ['{invoice_num}','Invoice number'],
    ['{amount}','Invoice total'],
    ['{entries_count}','Number of entries'],
    ['{hours_total}','Total hours'],
    ['{filename}','Export filename'],
    ['{cc_list}','CC recipients list']
  ];
  var priorityOpts=[['normal','Normal'],['high','High \u2014 flag as urgent'],['low','Low \u2014 FYI only']];
  var pri=f.priority||'normal';
  return '<div class="ov"><div class="modal" style="max-width:820px;width:96vw"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(isEdit?'Edit':'New')+' Email Preset</h2><button class="btn-ic" onclick="A.closeMailPreset()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="display:grid;grid-template-columns:1fr 1fr;gap:0;padding:0">'

    // ── LEFT COLUMN: form ──
    +'<div style="padding:20px 18px;overflow-y:auto;max-height:72vh;border-right:1px solid var(--border)">'

    // Quick templates row
    +'<div style="margin-bottom:16px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Quick templates</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:5px">'
    +MAIL_QUICK_TEMPLATES.map(function(t,i){
      return '<button type="button" class="btn btn-gh" style="font-size:11px;padding:4px 10px" onclick="_mpApplyTemplate('+i+')">'+H(t[0])+'</button>';
    }).join('')
    +'</div></div>'

    // Name + Purpose
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>Preset Name <span class="req">*</span></label><input type="text" id="mp-name" value="'+H(f.name||'')+'" placeholder="e.g. Invoice to Acme Corp" oninput="_mpPreview()" /></div>'
    +'<div class="fl"><label>Purpose</label>'
    +'<select id="mp-purpose" onchange="_mpPreview()">'
    +'<option value="general"'+(purp==='general'?' selected':'')+'>General</option>'
    +'<option value="invoice_client"'+(purp==='invoice_client'?' selected':'')+'>Invoice to Client</option>'
    +'<option value="billing_staff"'+(purp==='billing_staff'?' selected':'')+'>Entries to Billing Staff</option>'
    +'<option value="partner_approval"'+(purp==='partner_approval'?' selected':'')+'>Entries for Partner Approval</option>'
    +'</select></div></div>'

    // Priority + Reply-To
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>Priority</label>'
    +'<select id="mp-priority" onchange="_mpPreview()">'
    +priorityOpts.map(function(o){return '<option value="'+o[0]+'"'+(pri===o[0]?' selected':'')+'>'+H(o[1])+'</option>';}).join('')
    +'</select></div>'
    +'<div class="fl"><label>Reply-To <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="email" id="mp-replyto" value="'+H(f.replyTo||'')+'" placeholder="billing@firm.com" oninput="_mpPreview()" /></div></div>'

    // To
    +'<div class="fl" style="margin-bottom:12px"><label>To <span style="font-size:11px;color:var(--ink3)">&mdash; leave blank to auto-fill from record</span></label>'
    +'<input type="text" id="mp-to" value="'+H(f.to||'')+'" placeholder="client@example.com, partner@firm.com" oninput="_mpPreview()" />'
    +'<div class="hint">Separate multiple addresses with commas.</div></div>'

    // CC + BCC
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>CC <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="text" id="mp-cc" value="'+H(f.cc||'')+'" placeholder="manager@firm.com" oninput="_mpPreview()" /></div>'
    +'<div class="fl"><label>BCC <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="text" id="mp-bcc" value="'+H(f.bcc||'')+'" placeholder="archive@firm.com" oninput="_mpPreview()" /></div></div>'

    // Subject
    +'<div class="fl" style="margin-bottom:12px"><label>Subject Line</label><input type="text" id="mp-subj" value="'+H(f.subject||'')+'" placeholder="Invoice #{invoice_num} \u2014 {client}" oninput="_mpPreview()" /></div>'

    // Body
    +'<div class="fl" style="margin-bottom:12px"><label>Message Body</label><textarea id="mp-body" rows="6" oninput="_mpPreview()" placeholder="Dear {client},\n\nPlease find attached...">'+H(f.body||'')+'</textarea></div>'

    // Signature
    +'<div class="fl" style="margin-bottom:16px">'
    +'<label>Signature <span style="font-size:11px;color:var(--ink3)">&mdash; auto-appended after double line-break</span></label>'
    +'<textarea id="mp-sig" rows="3" oninput="_mpPreview()" placeholder="Best regards,\n{user}\n{firm}">'+H(f.signature||'')+'</textarea></div>'

    // Placeholder insert bar
    +'<div style="background:var(--bg);border-radius:8px;padding:10px 12px;margin-bottom:4px">'
    +'<div style="font-size:10px;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px">Click to insert placeholder at cursor</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:4px">'
    +ALL_PH.map(function(ph){
      return '<button type="button" title="'+H(ph[1])+'" onclick="_mpInsert(\''+ph[0]+'\')" style="font-size:11px;font-family:monospace;padding:3px 8px;background:var(--white);border:1px solid var(--border);border-radius:5px;cursor:pointer;color:var(--blue)">'+H(ph[0])+'</button>';
    }).join('')
    +'</div></div>'
    +'</div>'

    // ── RIGHT COLUMN: live preview ──
    +'<div style="padding:20px 18px;overflow-y:auto;max-height:72vh;background:var(--bg2)">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Live preview <span style="opacity:.6">(sample data)</span></div>'
    +'<div id="mp-preview" style="background:var(--white);border:1px solid var(--border);border-radius:8px;padding:14px 16px;min-height:200px;word-break:break-word"></div>'
    +'<div style="margin-top:14px;font-size:11px;color:var(--ink3);line-height:1.7">'
    +'<strong style="display:block;margin-bottom:6px;color:var(--ink2)">Placeholder guide</strong>'
    +ALL_PH.map(function(ph){return '<div><code style="font-size:10px;color:var(--blue)">'+H(ph[0])+'</code> &mdash; '+H(ph[1])+'</div>';}).join('')
    +'</div>'
    +'</div>'

    +'</div>'// end grid

    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeMailPreset()">Cancel</button>'
    +'<button class="btn btn-bl" onclick="A.saveMailPreset()">'+IC.save+' Save Preset</button>'
    +'</div></div></div>';
}

function buildMailSend(){
  var fname=exportFilename();
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' Send Billing Report</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div style="background:var(--bg);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);margin-bottom:16px">'
    +'<strong>File:</strong> <span style="font-family:monospace;color:var(--blue)">'+H(fname)+'</span><br>'
    +'<span style="font-size:11px;color:var(--ink3)">Export and save the file first, then select a preset to open your email client.</span>'
    +'</div>'
    +(ST.mailPresets.length>0
      ? '<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Choose a preset</div>'
        +ST.mailPresets.map(function(mp,i){
          return '<div class="crow" style="cursor:pointer;margin-bottom:8px" onclick="A.sendMailPreset('+i+')">'
            +'<div style="width:32px;height:32px;border-radius:8px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0">'+IC.mail+'</div>'
            +'<div><strong style="font-size:13px;color:var(--ink)">'+H(mp.name||'Preset '+(i+1))+'</strong>'
            +(mp.to?'<div style="font-size:11px;color:var(--ink3)">To: '+H(mp.to)+'</div>':'')
            +'</div></div>';
        }).join('')
      : '<div class="empty" style="padding:20px"><p>No email presets configured</p><small>Add presets in Settings \u2192 Email tab</small></div>'
    )
    +'</div>'
    +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +(ST.mailPresets.length===0?'<button class="btn btn-bl" onclick="A.openMailPreset(null)">'+IC.plus+' Add Preset</button>':'')
    +'</div></div></div>';
}

// Purpose label helper
function purposeLabel(p){
  return {general:'General',invoice_client:'Invoice to Client',billing_staff:'Entries to Billing Staff',partner_approval:'Entries for Partner Approval'}[p]||'General';
}

// Contextual mail compose modal — shows purpose-filtered presets with smart pre-fill
function buildMailCompose(){
  var ctx=ST.mailCompose||{};
  var purpose=ctx.purpose||'general';
  var titles={
    invoice_client:'Email Invoice to Client',
    billing_staff:'Send Entries to Billing Staff',
    partner_approval:'Submit Entries for Partner Approval',
    general:'Send Billing Report'
  };
  // Show presets matching purpose; general presets always appear as fallback options
  var filtered=ST.mailPresets.filter(function(mp){
    return (mp.purpose||'general')===purpose||(mp.purpose||'general')==='general';
  });
  var ctxInfo='';
  if(ctx.clientName) ctxInfo+='<span><strong>Client:</strong> '+H(ctx.clientName)+'</span> ';
  if(ctx.invNum) ctxInfo+='<span><strong>Invoice #:</strong> '+H(ctx.invNum)+'</span> ';
  if(ctx.invAmount) ctxInfo+='<span><strong>Amount:</strong> '+H(ctx.invAmount)+'</span> ';
  if(ctx.entriesCount!=null) ctxInfo+='<span><strong>Entries:</strong> '+H(String(ctx.entriesCount))+'</span> ';
  if(ctx.hoursTotal) ctxInfo+='<span><strong>Hours:</strong> '+H(ctx.hoursTotal)+'h</span>';
  return '<div class="ov"><div class="modal modal-md"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(titles[purpose]||'Send Email')+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +(ctxInfo?'<div style="display:flex;gap:16px;flex-wrap:wrap;background:var(--bg);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);margin-bottom:14px">'+ctxInfo+'</div>':'')
    +(ctx.toEmail?'<div style="background:var(--bg);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);margin-bottom:14px">'
      +'<strong>Recipient:</strong> <span style="color:var(--blue);font-family:monospace">'+H(ctx.toEmail)+'</span>'
      +'<span style="font-size:11px;color:var(--ink3);margin-left:8px">(auto-filled from record; preset &ldquo;To&rdquo; overrides if set)</span>'
      +'</div>':'')
    +(filtered.length>0
      ? '<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Choose a preset to send</div>'
        +filtered.map(function(mp){
          var realIdx=ST.mailPresets.indexOf(mp);
          var toDisplay=(mp.to&&mp.to.length)?mp.to:(ctx.toEmail||'');
          return '<div class="crow" style="cursor:pointer;margin-bottom:8px;align-items:flex-start" onclick="A.sendFromCompose('+realIdx+')">'
            +'<div style="width:36px;height:36px;border-radius:8px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0;margin-top:2px">'+IC.mail+'</div>'
            +'<div style="flex:1;min-width:0">'
            +'<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap"><strong style="font-size:13px;color:var(--ink)">'+H(mp.name||'Preset '+(realIdx+1))+'</strong>'
            +'<span class="status-badge '+(({general:'s-neutral',invoice_client:'s-approved',billing_staff:'s-review',partner_approval:'s-pending'}[mp.purpose||'general']||'s-neutral'))+'" style="font-size:10px;padding:2px 7px">'+purposeLabel(mp.purpose||'general')+'</span>'
            +((mp.priority==='high')?'<span style="font-size:10px;color:var(--red);font-weight:600">\u25b2 High</span>':'')
            +'</div>'
            +(toDisplay?'<div style="font-size:11px;color:var(--ink3)">To: '+H(toDisplay)+'</div>':'')
            +(mp.cc?'<div style="font-size:11px;color:var(--ink3)">CC: '+H(mp.cc)+'</div>':'')
            +(mp.subject?'<div style="font-size:11px;color:var(--ink3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:380px">Subj: '+H(mp.subject)+'</div>':'')
            +(mp.signature?'<div style="font-size:10px;color:var(--ink3);font-style:italic">\u2014 Signature included</div>':'')
            +'</div></div>';
        }).join('')
      : '<div class="empty" style="padding:24px"><p>No presets for &ldquo;'+purposeLabel(purpose)+'&rdquo;</p>'
        +'<small>Add a preset in Settings &rarr; Email with purpose set to <strong>'+purposeLabel(purpose)+'</strong></small></div>'
    )
    +'</div>'
    +'<div class="modal-ft" style="gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-gh" onclick="ST.modal=\'settings\';ST.settingsTab=\'email\';render()">'+IC.plus+' Manage Presets</button>'
    +'</div></div></div>';
}


// === EMAIL COMPOSE BLOCK SYSTEM ===
// Block definitions: returns map of btype -> {label,icon,preview,html,text}
// All fns close over 'd' (ST.emailDraft)
function ecBlockDefs(d){
  // d = ST.emailDraft; b = a block object {id,btype,cfg:{},customText}
  // cfg fields are per-block overrides/toggles set by the user in settings panel
  var inv=d.inv||{};
  var cl=d.cl||{};
  var mt=d.mt||null;
  var lineItems=d.lineItems||[];
  var total=d.total||0;
  var taxAmt=d.taxAmt||0;
  var grandTotal=d.grandTotal||0;
  var entries=d.entries||[];
  var totalH=d.totalH||0;
  var totalAmt=d.totalAmt||0;
  var fromUser=d.fromUser||(ST.user?ST.user.name:'');
  var firmName=d.firmName||inv.firmName||ST.prefs.appName||'Our Firm';
  var reviewer=d.reviewer||(ST.user?ST.user.name:'Partner');
  var cutLines=d.cutLines||[];
  var commentLines=d.commentLines||[];
  var invComments=d.invComments||[];
  var approved=d.approved;
  var isPending=d.isPending;
  var byAuthor=d.byAuthor||{};
  var invNum=inv.number||String(inv.id||'');

  // cfg-aware helpers
  function cv(cfg,key,def){ return (cfg&&cfg[key]!=null)?cfg[key]:def; }
  function cstr(cfg,key,def){ var v=cv(cfg,key,def); return (v==null||v==='')?def:String(v); }

  function serif(inner){ return '<div style="font-family:Georgia,serif;font-size:13px;color:#222;line-height:1.6">'+inner+'</div>'; }
  function sans(inner){  return '<div style="font-family:system-ui,sans-serif;font-size:13px;color:#1a1a1a;line-height:1.5">'+inner+'</div>'; }

  // ── Config panels (HTML) for each block type ─────────────────────────────
  // Returns '' if the block has no configurable options
  function cfgPanel(b){
    var c=b.cfg||{};
    var i=b._idx; // set by caller
    function fld(key,lbl,type,opts){
      // type: text | textarea | toggle | select
      var id='bci-'+i+'-'+key;
      if(type==='toggle'){
        var chk=cv(c,key,opts.def!==false)?'checked':'';
        return '<label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;margin-bottom:4px">'
          +'<input type="checkbox" id="'+id+'" '+chk+' onchange="A.ecSetBlockCfg('+i+',\''+key+'\',this.checked)" style="margin:0">'
          +H(lbl)+'</label>';
      }
      if(type==='select'){
        var optHtml=opts.choices.map(function(ch){
          var sel=(cv(c,key,opts.def)===ch.v)?'selected':'';
          return '<option value="'+H(ch.v)+'" '+sel+'>'+H(ch.l)+'</option>';
        }).join('');
        return '<div style="margin-bottom:6px"><label style="display:block;font-size:10px;color:var(--ink3);margin-bottom:2px">'+H(lbl)+'</label>'
          +'<select id="'+id+'" onchange="A.ecSetBlockCfg('+i+',\''+key+'\',this.value)" style="font-size:11px;padding:2px 4px;border:1px solid var(--brd);border-radius:4px;background:var(--bg)">'+optHtml+'</select></div>';
      }
      if(type==='textarea'){
        return '<div style="margin-bottom:6px"><label style="display:block;font-size:10px;color:var(--ink3);margin-bottom:2px">'+H(lbl)+'</label>'
          +'<textarea id="'+id+'" rows="2" placeholder="'+H(opts.ph||'')+'" oninput="A.ecSetBlockCfg('+i+',\''+key+'\',this.value)" '
          +'style="width:100%;font-size:11px;padding:4px 6px;border:1px solid var(--brd);border-radius:4px;background:var(--bg);resize:vertical;box-sizing:border-box;font-family:inherit">'+H(cstr(c,key,''))+'</textarea></div>';
      }
      // default: text
      return '<div style="margin-bottom:6px"><label style="display:block;font-size:10px;color:var(--ink3);margin-bottom:2px">'+H(lbl)+'</label>'
        +'<input type="text" id="'+id+'" value="'+H(cstr(c,key,''))+'" placeholder="'+H(opts&&opts.ph||'')+'" oninput="A.ecSetBlockCfg('+i+',\''+key+'\',this.value)" '
        +'style="width:100%;font-size:11px;padding:4px 6px;border:1px solid var(--brd);border-radius:4px;background:var(--bg);box-sizing:border-box"></div>';
    }

    var rows='';
    if(b.btype==='greeting'){
      rows+=fld('salutation','Salutation','select',{def:'Dear',choices:[{v:'Dear',l:'Dear'},{v:'Hello',l:'Hello'},{v:'Hi',l:'Hi'},{v:'Good day',l:'Good day'}]});
      rows+=fld('nameOverride','Name override','text',{ph:'Leave blank to use client name'});
    } else if(b.btype==='inv_header'){
      rows+=fld('showDate','Show issue date','toggle',{def:true});
      rows+=fld('showDue','Show due date','toggle',{def:true});
      rows+=fld('showClientInfo','Show client email/phone','toggle',{def:true});
      rows+=fld('showMatter','Show matter','toggle',{def:true});
    } else if(b.btype==='line_items'){
      rows+=fld('showDate','Show date column','toggle',{def:true});
      rows+=fld('showHrs','Show hours column','toggle',{def:true});
      rows+=fld('showRate','Show rate column','toggle',{def:true});
      rows+=fld('showDesc','Show description in header','toggle',{def:true});
      rows+=fld('altHeading','Table heading override','text',{ph:'e.g. Services Rendered'});
    } else if(b.btype==='totals'){
      rows+=fld('showSubtotal','Show subtotal row','toggle',{def:true});
      rows+=fld('showTax','Show tax row','toggle',{def:true});
      rows+=fld('showPayTerms','Show payment terms','toggle',{def:true});
      rows+=fld('totalLabel','Total label','text',{ph:'Total Due'});
    } else if(b.btype==='inv_notes'){
      rows+=fld('textOverride','Override notes text','textarea',{ph:'Leave blank to use invoice notes'});
    } else if(b.btype==='signature'){
      rows+=fld('nameOverride','Firm name override','text',{ph:firmName});
      rows+=fld('addressOverride','Address override','text',{ph:inv.firmAddress||''});
      rows+=fld('phoneOverride','Phone override','text',{ph:inv.firmPhone||''});
      rows+=fld('emailOverride','Email override','text',{ph:inv.firmEmail||''});
      rows+=fld('closing','Closing line','text',{ph:'Thank you for your business.'});
    } else if(b.btype==='approval_header'||b.btype==='ts_header'||b.btype==='summary_header'){
      rows+=fld('titleOverride','Title override','text',{ph:'Leave blank for default'});
      rows+=fld('fromOverride','From override','text',{ph:fromUser});
    } else if(b.btype==='action_note'||b.btype==='ts_approval_note'){
      rows+=fld('textOverride','Note text override','textarea',{ph:'Leave blank for default'});
      rows+=fld('color','Color','select',{def:'yellow',choices:[{v:'yellow',l:'Yellow (warning)'},{v:'blue',l:'Blue (info)'},{v:'green',l:'Green (success)'}]});
    } else if(b.btype==='entries_table'){
      rows+=fld('showDate','Show date column','toggle',{def:true});
      rows+=fld('showMatter','Show matter column','toggle',{def:true});
      rows+=fld('showRate','Show rate column','toggle',{def:true});
      rows+=fld('showStatus','Show status badge','toggle',{def:false});
    } else if(b.btype==='decision_header'){
      rows+=fld('titleOverride','Title override','text',{ph:'Leave blank for default'});
    } else if(b.btype==='decision_closing'){
      rows+=fld('textOverride','Message override','textarea',{ph:'Leave blank for default'});
    } else if(b.btype==='ts_stats'){
      rows+=fld('showEntries','Show entry count','toggle',{def:true});
      rows+=fld('showHours','Show hours','toggle',{def:true});
      rows+=fld('showValue','Show dollar value','toggle',{def:true});
    } else if(b.btype==='spacer'){
      rows+=fld('size','Size','select',{def:'md',choices:[{v:'sm',l:'Small (8px)'},{v:'md',l:'Medium (18px)'},{v:'lg',l:'Large (36px)'},{v:'xl',l:'Extra large (56px)'}]});
    } else if(b.btype==='custom_text'){
      rows+=fld('heading','Optional heading','text',{ph:'e.g. Additional Information'});
      rows+=fld('italic','Italic style','toggle',{def:false});
    } else if(b.btype==='inv_summary'){
      rows+=fld('showInvNum','Show invoice number','toggle',{def:true});
      rows+=fld('showDue','Show due date','toggle',{def:true});
    }
    if(!rows) return '';
    return '<div style="margin-top:8px;padding:8px 10px;background:var(--bg2);border-radius:5px;border:1px solid var(--brd)">'
      +'<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink3);margin-bottom:6px">Block Settings</div>'
      +rows+'</div>';
  }

  // ── Block rendering (uses cfg) ────────────────────────────────────────────
  function renderGreeting(b){
    var c=b.cfg||{};
    var sal=cstr(c,'salutation','Dear');
    var name=cstr(c,'nameOverride','')||cl.name||'Client';
    return serif('<p style="margin:0 0 14px">'+H(sal)+' '+H(name)+',</p>');
  }

  function renderInvHeader(b){
    var c=b.cfg||{};
    return serif('<table style="width:100%;border-collapse:collapse;margin-bottom:16px"><tr>'
      +'<td style="vertical-align:top"><div style="font-size:18px;font-weight:700">Invoice #'+H(invNum)+'</div>'
      +(cv(c,'showDate',true)&&inv.invoiceDate?'<div style="font-size:12px;color:#666;margin-top:2px">Issued: '+H(inv.invoiceDate)+'</div>':'')
      +(cv(c,'showDue',true)&&inv.dueDate?'<div style="font-size:12px;color:#c00;font-weight:600;margin-top:2px">Due: '+H(inv.dueDate)+'</div>':'')
      +'</td>'
      +'<td style="text-align:right;vertical-align:top">'
      +'<div style="font-weight:600">'+H(cl.name||'')+'</div>'
      +(cv(c,'showClientInfo',true)&&cl.email?'<div style="font-size:12px;color:#888">'+H(cl.email)+'</div>':'')
      +(cv(c,'showMatter',true)&&mt?'<div style="font-size:12px;color:#888">'+H(mt.name)+'</div>':'')
      +'</td></tr></table>');
  }

  function renderLineItems(b){
    var c=b.cfg||{};
    var showDate=cv(c,'showDate',true);
    var showHrs=cv(c,'showHrs',true);
    var showRate=cv(c,'showRate',true);
    var heading=cstr(c,'altHeading','')||'Description';
    var rows=lineItems.map(function(li){
      return '<tr>'
        +'<td style="padding:7px 8px;border-bottom:1px solid #f0f0f0">'+H(li.desc)+'</td>'
        +(showDate?'<td style="padding:7px 8px;border-bottom:1px solid #f0f0f0;text-align:center;color:#666;font-size:12px;white-space:nowrap">'+H(li.date)+'</td>':'')
        +(showHrs?'<td style="padding:7px 8px;border-bottom:1px solid #f0f0f0;text-align:right;white-space:nowrap">'+H(li.hrs)+'h</td>':'')
        +(showRate?'<td style="padding:7px 8px;border-bottom:1px solid #f0f0f0;text-align:right;white-space:nowrap">'+H(li.rate)+'</td>':'')
        +'<td style="padding:7px 8px;border-bottom:1px solid #f0f0f0;text-align:right;font-weight:600;white-space:nowrap">'+H(li.amt)+'</td>'
        +'</tr>';
    }).join('');
    return serif('<table style="width:100%;border-collapse:collapse;margin-bottom:8px">'
      +'<thead><tr style="background:#f7f7f7">'
      +'<th style="padding:7px 8px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#888;font-weight:600">'+H(heading)+'</th>'
      +(showDate?'<th style="padding:7px 8px;text-align:center;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#888;font-weight:600">Date</th>':'')
      +(showHrs?'<th style="padding:7px 8px;text-align:right;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#888;font-weight:600">Hrs</th>':'')
      +(showRate?'<th style="padding:7px 8px;text-align:right;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#888;font-weight:600">Rate</th>':'')
      +'<th style="padding:7px 8px;text-align:right;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#888;font-weight:600">Amount</th>'
      +'</tr></thead><tbody>'+rows+'</tbody></table>');
  }

  function renderTotals(b){
    var c=b.cfg||{};
    var showSub=cv(c,'showSubtotal',true);
    var showTax=cv(c,'showTax',true);
    var showPay=cv(c,'showPayTerms',true);
    var lbl=cstr(c,'totalLabel','')||'Total Due';
    return serif('<div style="display:flex;justify-content:flex-end;margin:4px 0 14px">'
      +'<div style="width:220px">'
      +(showSub&&taxAmt?'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666;border-bottom:1px solid #eee"><span>Subtotal</span><span>$'+(total||0).toFixed(2)+'</span></div>':'')
      +(showTax&&taxAmt?'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666;border-bottom:1px solid #eee"><span>Tax ('+H(String(inv.taxPct||0))+'%)</span><span>$'+(taxAmt||0).toFixed(2)+'</span></div>':'')
      +'<div style="display:flex;justify-content:space-between;padding:7px 0;font-size:15px;font-weight:700;border-top:2px solid #222;margin-top:3px"><span>'+H(lbl)+'</span><span>$'+(grandTotal||0).toFixed(2)+'</span></div>'
      +(showPay&&inv.paymentTerms?'<div style="font-size:11px;color:#888;text-align:right;margin-top:2px">'+H(inv.paymentTerms)+'</div>':'')
      +'</div></div>');
  }

  function renderSignature(b){
    var c=b.cfg||{};
    var name=cstr(c,'nameOverride','')||firmName;
    var addr=cstr(c,'addressOverride','')||inv.firmAddress||'';
    var phone=cstr(c,'phoneOverride','')||inv.firmPhone||'';
    var email=cstr(c,'emailOverride','')||inv.firmEmail||'';
    var closing=cstr(c,'closing','')||'Thank you for your business.';
    return serif('<div style="border-top:1px solid #eee;padding-top:12px;margin-top:4px;font-size:13px">'
      +(closing?'<p style="margin:0 0 10px;color:#444">'+H(closing)+'</p>':'')
      +'<div style="font-weight:600">'+H(name)+'</div>'
      +(addr?'<div style="color:#777;font-size:12px">'+H(addr)+'</div>':'')
      +(phone?'<div style="color:#777;font-size:12px">'+H(phone)+'</div>':'')
      +(email?'<div style="color:#777;font-size:12px">'+H(email)+'</div>':'')
      +'</div>');
  }

  function renderActionNote(b,defaultText,defaultColor){
    var c=b.cfg||{};
    var text=cstr(c,'textOverride','')||defaultText;
    var col=cstr(c,'color','')||defaultColor||'yellow';
    var bg=col==='blue'?'#e8f3ff':col==='green'?'#e8f5ee':'#fff8e6';
    var border=col==='blue'?'#8bbfee':col==='green'?'#a0d8b3':'#f0c040';
    var color=col==='blue'?'#1a3a6a':col==='green'?'#1a4a2a':'#7a5a00';
    return sans('<div style="background:'+bg+';border:1px solid '+border+';border-radius:4px;padding:10px 14px;font-size:12px;color:'+color+'">'+H(text)+'</div>');
  }

  function renderEntriesTable(b){
    var c=b.cfg||{};
    var showDate=cv(c,'showDate',true);
    var showMatter=cv(c,'showMatter',true);
    var showRate=cv(c,'showRate',true);
    var showStatus=cv(c,'showStatus',false);
    var rows=entries.map(function(e){
      var emt=_lu.ma[e.matterId]||{};
      var amt=(Number(e.hours)*Number(e.rate)).toFixed(2);
      var st2=e.status||'approved';
      var stbg=st2==='pending'?'#fff8e6':st2==='approved'?'#e8f5ee':'#fff0f0';
      var stco=st2==='pending'?'#7a5a00':st2==='approved'?'#1a4a2a':'#6a1a1a';
      return '<tr>'
        +(showDate?'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;white-space:nowrap">'+H(e.date)+'</td>':'')
        +(showMatter?'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;font-size:12px">'+H(emt.name||'General')+'</td>':'')
        +'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+H(e.description||'—')+'</td>'
        +'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;text-align:right;white-space:nowrap">'+Number(e.hours).toFixed(2)+'h</td>'
        +(showRate?'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;text-align:right;white-space:nowrap">$'+Number(e.rate).toFixed(2)+'</td>':'')
        +'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;text-align:right;font-weight:600;white-space:nowrap">$'+amt+'</td>'
        +(showStatus?'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;text-align:center"><span style="font-size:10px;padding:2px 6px;border-radius:3px;background:'+stbg+';color:'+stco+';font-weight:600">'+st2+'</span></td>':'')
        +'</tr>';
    }).join('');
    return sans('<table style="width:100%;border-collapse:collapse;margin-bottom:12px">'
      +'<thead><tr style="background:#f5f7fa">'
      +(showDate?'<th style="padding:6px 8px;text-align:left;font-size:11px;color:#888;font-weight:600">Date</th>':'')
      +(showMatter?'<th style="padding:6px 8px;text-align:left;font-size:11px;color:#888;font-weight:600">Matter</th>':'')
      +'<th style="padding:6px 8px;text-align:left;font-size:11px;color:#888;font-weight:600">Description</th>'
      +'<th style="padding:6px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Hours</th>'
      +(showRate?'<th style="padding:6px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Rate</th>':'')
      +'<th style="padding:6px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Amount</th>'
      +(showStatus?'<th style="padding:6px 8px;text-align:center;font-size:11px;color:#888;font-weight:600">Status</th>':'')
      +'</tr></thead><tbody>'+rows+'</tbody>'
      +'<tfoot><tr>'
      +(showDate?'<td></td>':'')
      +(showMatter?'<td></td>':'')
      +'<td colspan="'+(showRate?2:1)+'" style="padding:6px 8px;text-align:right;font-weight:700;border-top:2px solid #222;font-size:12px">Total</td>'
      +'<td style="padding:6px 8px;text-align:right;font-weight:700;border-top:2px solid #222;color:#1e3a5f">$'+(totalAmt||0).toFixed(2)+'</td>'
      +(showStatus?'<td style="border-top:2px solid #222"></td>':'')
      +'</tr></tfoot></table>');
  }

  function renderTsStats(b){
    var c=b.cfg||{};
    var showE=cv(c,'showEntries',true);
    var showH=cv(c,'showHours',true);
    var showV=cv(c,'showValue',true);
    var cards=[];
    if(showE) cards.push('<div style="flex:1;min-width:90px;background:#f5f7fa;border-radius:6px;padding:10px;text-align:center"><div style="font-size:20px;font-weight:700">'+entries.length+'</div><div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:.05em">Entries</div></div>');
    if(showH) cards.push('<div style="flex:1;min-width:90px;background:#f5f7fa;border-radius:6px;padding:10px;text-align:center"><div style="font-size:20px;font-weight:700">'+(totalH||0).toFixed(1)+'h</div><div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:.05em">Hours</div></div>');
    if(showV) cards.push('<div style="flex:1;min-width:90px;background:#eaf3ff;border-radius:6px;padding:10px;text-align:center"><div style="font-size:20px;font-weight:700;color:#1e3a5f">$'+(totalAmt||0).toFixed(2)+'</div><div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:.05em">Value</div></div>');
    return sans('<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'+cards.join('')+'</div>');
  }

  function renderSpacer(b){
    var c=b.cfg||{};
    var sz=cstr(c,'size','')||'md';
    var h=sz==='sm'?8:sz==='lg'?36:sz==='xl'?56:18;
    return '<div style="height:'+h+'px"></div>';
  }

  function renderCustomText(b){
    var c=b.cfg||{};
    var heading=cstr(c,'heading','');
    var italic=cv(c,'italic',false);
    var text=(b.customText||'').trim();
    if(!text&&!heading) return '';
    var style='margin:0 0 12px;font-size:13px;line-height:1.65'+(italic?';font-style:italic':'');
    return serif((heading?'<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#888;margin-bottom:6px">'+H(heading)+'</div>':'')
      +(text?'<p style="'+style+'">'+H(text).replace(/\n/g,'<br>')+'</p>':''));
  }

  function renderByAuthor(b){
    var rows=Object.keys(byAuthor).map(function(a){
      var ad=byAuthor[a];
      var pct=(totalAmt>0?(ad.amt/totalAmt*100).toFixed(0):'0')+'%';
      return '<tr><td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;font-weight:600">'+H(a)+'</td>'
        +'<td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;text-align:right">'+ad.count+'</td>'
        +'<td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;text-align:right">'+ad.h.toFixed(2)+'h</td>'
        +'<td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;text-align:right;font-weight:600">$'+ad.amt.toFixed(2)+'</td>'
        +'<td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;text-align:right;color:#888">'+pct+'</td></tr>';
    }).join('');
    return sans('<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#888;margin-bottom:8px">By Attorney</div>'
      +'<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f5f7fa">'
      +'<th style="padding:6px 10px;text-align:left;font-size:11px;color:#888;font-weight:600">Attorney</th>'
      +'<th style="padding:6px 10px;text-align:right;font-size:11px;color:#888;font-weight:600">Entries</th>'
      +'<th style="padding:6px 10px;text-align:right;font-size:11px;color:#888;font-weight:600">Hours</th>'
      +'<th style="padding:6px 10px;text-align:right;font-size:11px;color:#888;font-weight:600">Billed</th>'
      +'<th style="padding:6px 10px;text-align:right;font-size:11px;color:#888;font-weight:600">%</th>'
      +'</tr></thead><tbody>'+rows+'</tbody>'
      +'<tfoot><tr style="background:#eee"><td style="padding:6px 10px;font-weight:700">Total</td>'
      +'<td style="padding:6px 10px;text-align:right;font-weight:700">'+(d.entries||[]).length+'</td>'
      +'<td style="padding:6px 10px;text-align:right;font-weight:700">'+(totalH||0).toFixed(2)+'h</td>'
      +'<td style="padding:6px 10px;text-align:right;font-weight:700">$'+(totalAmt||0).toFixed(2)+'</td>'
      +'<td style="padding:6px 10px;text-align:right;font-weight:700">100%</td>'
      +'</tr></tfoot></table></div>');
  }

  function renderByClient(b){
    var bc={};
    (d.entries||[]).forEach(function(e){
      var ecl=_lu.cl[e.clientId]||{name:'?'};
      if(!bc[ecl.name]){bc[ecl.name]={h:0,amt:0,count:0};}
      bc[ecl.name].h+=Number(e.hours); bc[ecl.name].amt+=Number(e.hours)*Number(e.rate); bc[ecl.name].count++;
    });
    var rows=Object.keys(bc).map(function(cn){
      var cd=bc[cn];
      return '<tr><td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;font-weight:600">'+H(cn)+'</td>'
        +'<td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;text-align:right">'+cd.count+'</td>'
        +'<td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;text-align:right">'+cd.h.toFixed(2)+'h</td>'
        +'<td style="padding:7px 10px;border-bottom:1px solid #f0f0f0;text-align:right;font-weight:600">$'+cd.amt.toFixed(2)+'</td></tr>';
    }).join('');
    return sans('<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#888;margin-bottom:8px">By Client</div>'
      +'<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f5f7fa">'
      +'<th style="padding:6px 10px;text-align:left;font-size:11px;color:#888;font-weight:600">Client</th>'
      +'<th style="padding:6px 10px;text-align:right;font-size:11px;color:#888;font-weight:600">Entries</th>'
      +'<th style="padding:6px 10px;text-align:right;font-size:11px;color:#888;font-weight:600">Hours</th>'
      +'<th style="padding:6px 10px;text-align:right;font-size:11px;color:#888;font-weight:600">Billed</th>'
      +'</tr></thead><tbody>'+rows+'</tbody></table></div>');
  }

  function renderHdrBanner(b,bg,icon,title,sub){
    var c=b.cfg||{};
    var t=cstr(c,'titleOverride','')||title;
    var f=cstr(c,'fromOverride','')||sub;
    return sans('<div style="background:'+bg+';color:#fff;border-radius:6px;padding:13px 16px;margin-bottom:12px;display:flex;align-items:center;gap:10px">'
      +'<div style="font-size:22px">'+icon+'</div>'
      +'<div><div style="font-weight:700;font-size:14px">'+H(t)+'</div>'
      +(f?'<div style="font-size:12px;opacity:.8">'+H(f)+'</div>':'')
      +'</div></div>');
  }

  function renderInvSummary(b){
    var c=b.cfg||{};
    return sans('<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'
      +(cv(c,'showInvNum',true)?'<div style="flex:1;min-width:100px;background:#f5f7fa;border-radius:6px;padding:10px 12px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#888">Invoice</div><div style="font-weight:700;font-size:14px">#'+H(invNum)+'</div>'+(inv.invoiceDate?'<div style="font-size:11px;color:#666">'+H(inv.invoiceDate)+'</div>':'')+(cv(c,'showDue',true)&&inv.dueDate?'<div style="font-size:11px;color:#c00;font-weight:600">Due: '+H(inv.dueDate)+'</div>':'')+'</div>':'')
      +'<div style="flex:1;min-width:100px;background:#f5f7fa;border-radius:6px;padding:10px 12px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#888">Client</div><div style="font-weight:700">'+H(cl.name||'')+'</div>'+(mt?'<div style="font-size:11px;color:#666">'+H(mt.name)+'</div>':'')+'</div>'
      +'<div style="flex:1;min-width:100px;background:#eaf3ff;border-radius:6px;padding:10px 12px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#888">Total</div><div style="font-weight:700;color:#1e3a5f;font-size:16px">$'+(totalAmt||0).toFixed(2)+'</div><div style="font-size:11px;color:#666">'+(totalH||0).toFixed(2)+'h · '+entries.length+' entries</div></div>'
      +'</div>');
  }

  function renderHourCuts(b){
    if(!cutLines.length) return '';
    var rows=cutLines.map(function(c2){
      return '<tr><td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;font-size:12px">'+H(c2.label)+'</td>'
        +'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;text-align:right;font-size:12px">'+c2.orig+'h</td>'
        +'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;text-align:right;font-size:12px;font-weight:600">'+c2.cut+'h</td>'
        +'<td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;text-align:right;font-size:12px;color:#c00">−'+(Number(c2.orig)-Number(c2.cut)).toFixed(2)+'h</td></tr>';
    }).join('');
    return sans('<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#888;margin-bottom:6px">Hour Adjustments</div>'
      +'<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f5f7fa">'
      +'<th style="padding:6px 8px;text-align:left;font-size:11px;color:#888;font-weight:600">Entry</th>'
      +'<th style="padding:6px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Original</th>'
      +'<th style="padding:6px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Adjusted</th>'
      +'<th style="padding:6px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Δ</th>'
      +'</tr></thead><tbody>'+rows+'</tbody></table></div>');
  }

  function renderEntryComments(b){
    if(!commentLines.length) return '';
    return sans('<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#888;margin-bottom:6px">Entry Comments</div>'
      +commentLines.map(function(c2){
        return '<div style="border-left:3px solid #f0c040;padding:7px 10px;margin-bottom:5px;background:#fff8e6;border-radius:0 4px 4px 0;font-size:12px">'
          +'<div style="font-weight:600;margin-bottom:2px">'+H(c2.label)+'</div>'
          +'<div style="color:#555">'+H(c2.text)+'</div></div>';
      }).join('')+'</div>');
  }

  function renderInvComments(b){
    if(!invComments.length) return '';
    return sans('<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#888;margin-bottom:6px">Invoice Notes</div>'
      +invComments.map(function(c2){
        return '<div style="border-left:3px solid #ccc;padding:7px 10px;margin-bottom:5px;background:#f9f9f9;border-radius:0 4px 4px 0;font-size:12px">'
          +'<div style="font-weight:600;color:#888;margin-bottom:2px">'+H(c2.by)+' · '+H(c2.at)+'</div>'
          +'<div>'+H(c2.text)+'</div></div>';
      }).join('')+'</div>');
  }

  function renderDecisionClosing(b){
    var c=b.cfg||{};
    var text=cstr(c,'textOverride','')||(approved?'This invoice has been approved and is ready to be sent to the client.':'Please update the entries as noted above and resubmit for final approval.');
    var bg=approved?'#e8f5ee':'#fff0f0';
    var border=approved?'#a0d8b3':'#f0a0a0';
    var color=approved?'#1a4a2a':'#6a1a1a';
    return sans('<div style="background:'+bg+';border:1px solid '+border+';border-radius:4px;padding:10px 14px;font-size:12px;color:'+color+'">'+H(text)+'</div>');
  }

  function renderTsEntriesByClient(b){
    var c=b.cfg||{};
    var showStatus=cv(c,'showStatus',false);
    var bc={};
    entries.forEach(function(e){
      var ecl=_lu.cl[e.clientId]||{name:'?'};
      if(!bc[ecl.name]){bc[ecl.name]={e:[],h:0,amt:0};}
      bc[ecl.name].e.push(e); bc[ecl.name].h+=Number(e.hours); bc[ecl.name].amt+=Number(e.hours)*Number(e.rate);
    });
    var sections=Object.keys(bc).map(function(cn){
      var cg=bc[cn];
      var rows=cg.e.map(function(e){
        var emt=_lu.ma[e.matterId]||{};
        var amt=(Number(e.hours)*Number(e.rate)).toFixed(2);
        var st2=e.status||'approved';
        var stbg=st2==='pending'?'#fff8e6':st2==='approved'?'#e8f5ee':'#fff0f0';
        var stco=st2==='pending'?'#7a5a00':st2==='approved'?'#1a4a2a':'#6a1a1a';
        return '<tr>'
          +'<td style="padding:5px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;white-space:nowrap">'+H(e.date)+'</td>'
          +'<td style="padding:5px 8px;border-bottom:1px solid #f0f0f0;font-size:12px">'+H(emt.name||'General')+'</td>'
          +'<td style="padding:5px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+H(e.description||'—')+'</td>'
          +'<td style="padding:5px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;text-align:right;white-space:nowrap">'+Number(e.hours).toFixed(2)+'h</td>'
          +'<td style="padding:5px 8px;border-bottom:1px solid #f0f0f0;font-size:12px;text-align:right;font-weight:600;white-space:nowrap">$'+amt+'</td>'
          +(showStatus?'<td style="padding:5px 8px;border-bottom:1px solid #f0f0f0;text-align:center"><span style="font-size:10px;padding:2px 5px;border-radius:3px;background:'+stbg+';color:'+stco+';font-weight:600">'+st2+'</span></td>':'')
          +'</tr>';
      }).join('');
      return '<div style="margin-bottom:10px">'
        +'<div style="background:#f5f7fa;padding:6px 10px;border-bottom:2px solid #1e3a5f;display:flex;justify-content:space-between;align-items:center">'
        +'<span style="font-weight:700;font-size:13px">'+H(cn)+'</span>'
        +'<span style="font-size:11px;color:#555">'+cg.h.toFixed(2)+'h · $'+cg.amt.toFixed(2)+'</span></div>'
        +'<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#fafafa">'
        +'<th style="padding:5px 8px;text-align:left;font-size:11px;color:#888;font-weight:600">Date</th>'
        +'<th style="padding:5px 8px;text-align:left;font-size:11px;color:#888;font-weight:600">Matter</th>'
        +'<th style="padding:5px 8px;text-align:left;font-size:11px;color:#888;font-weight:600">Description</th>'
        +'<th style="padding:5px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Hours</th>'
        +'<th style="padding:5px 8px;text-align:right;font-size:11px;color:#888;font-weight:600">Amount</th>'
        +(showStatus?'<th style="padding:5px 8px;text-align:center;font-size:11px;color:#888;font-weight:600">Status</th>':'')
        +'</tr></thead><tbody>'+rows+'</tbody></table></div>';
    }).join('');
    return sans(sections);
  }

  function renderSummaryHeader(b){
    var c=b.cfg||{};
    var name=cstr(c,'titleOverride','')||firmName;
    var from=cstr(c,'fromOverride','')||fromUser;
    return sans('<div style="background:#2d2d2d;color:#fff;border-radius:6px;padding:13px 18px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">'
      +'<div><div style="font-weight:700;font-size:14px">'+H(name)+' — Billing Summary</div>'
      +(from?'<div style="font-size:12px;opacity:.8">Prepared by '+H(from)+'</div>':'')+'</div>'
      +'<div style="text-align:right"><div style="font-size:20px;font-weight:700">$'+(totalAmt||0).toFixed(2)+'</div>'
      +'<div style="font-size:11px;opacity:.7">'+(totalH||0).toFixed(2)+'h · '+(d.entries||[]).length+' entries</div></div></div>');
  }

  // ── Master block-type map ─────────────────────────────────────────────────
  return {
    greeting:{
      label:'Greeting', icon:'👋',
      preview:'Salutation + client name',
      renderHtml:renderGreeting,
      cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};return cstr(c,'salutation','Dear')+' '+(cstr(c,'nameOverride','')||cl.name||'Client')+',';}
    },
    inv_header:{
      label:'Invoice Header', icon:'📄',
      preview:'#'+invNum+' · '+(inv.invoiceDate||'')+(inv.dueDate?' · Due: '+inv.dueDate:''),
      renderHtml:renderInvHeader, cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};return 'Invoice #'+invNum+(cv(c,'showDate',true)&&inv.invoiceDate?'\nDate: '+inv.invoiceDate:'')+(cv(c,'showDue',true)&&inv.dueDate?'\nDue: '+inv.dueDate:'')+(cl.name?'\nClient: '+cl.name:'')+(cv(c,'showMatter',true)&&mt?'\nMatter: '+mt.name:'');}
    },
    line_items:{
      label:'Line Items Table', icon:'📋',
      preview:lineItems.length+' items · $'+(total||0).toFixed(2),
      renderHtml:renderLineItems, cfgPanel:cfgPanel,
      textFn:function(b){return lineItems.map(function(li){return li.date+'  '+li.desc+'  '+li.hrs+'h @ '+li.rate+' = '+li.amt;}).join('\n');}
    },
    totals:{
      label:'Totals', icon:'💰',
      preview:'Total Due: $'+(grandTotal||0).toFixed(2),
      renderHtml:renderTotals, cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};return (cv(c,'showSubtotal',true)&&taxAmt?'Subtotal: $'+(total||0).toFixed(2)+'\n':'')+(cv(c,'showTax',true)&&taxAmt?'Tax: $'+taxAmt.toFixed(2)+'\n':'')+(cstr(c,'totalLabel','')||'Total Due')+': $'+(grandTotal||0).toFixed(2)+(cv(c,'showPayTerms',true)&&inv.paymentTerms?'\nPayment Terms: '+inv.paymentTerms:'');}
    },
    inv_notes:{
      label:'Invoice Notes', icon:'📝',
      preview:inv.notes?(inv.notes.substring(0,40)+'…'):'(no notes)',
      renderHtml:function(b){var c=b.cfg||{};var t=cstr(c,'textOverride','')||inv.notes||'';return t?serif('<div style="background:#f9f9f9;border-left:3px solid #ddd;padding:9px 12px;font-size:12px;color:#555;margin-bottom:10px">'+H(t)+'</div>'):'';},
      cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};var t=cstr(c,'textOverride','')||inv.notes||'';return t?'Notes: '+t:'';}
    },
    signature:{
      label:'Firm Signature', icon:'✍️',
      preview:firmName+(inv.firmPhone?' · '+inv.firmPhone:''),
      renderHtml:renderSignature, cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};return (cstr(c,'closing','')||'Thank you for your business.')+'\n'+(cstr(c,'nameOverride','')||firmName)+(cstr(c,'addressOverride','')||inv.firmAddress?'\n'+(cstr(c,'addressOverride','')||inv.firmAddress):'')+(cstr(c,'phoneOverride','')||inv.firmPhone?'\n'+(cstr(c,'phoneOverride','')||inv.firmPhone):'')+(cstr(c,'emailOverride','')||inv.firmEmail?'\n'+(cstr(c,'emailOverride','')||inv.firmEmail):'');}
    },
    approval_header:{
      label:'Approval Header', icon:'🔔',
      preview:'Action Required: Invoice #'+invNum,
      renderHtml:function(b){return renderHdrBanner(b,'#1e3a5f','📋','Action Required: Invoice Approval','Submitted by '+(b.cfg&&b.cfg.fromOverride||fromUser));},
      cfgPanel:cfgPanel,
      textFn:function(b){return 'ACTION REQUIRED: Invoice Approval\nSubmitted by: '+(b.cfg&&b.cfg.fromOverride||fromUser);}
    },
    inv_summary:{
      label:'Invoice Summary Cards', icon:'📊',
      preview:'#'+invNum+' · '+H(cl.name||'')+(mt?' / '+H(mt.name):''),
      renderHtml:renderInvSummary, cfgPanel:cfgPanel,
      textFn:function(b){return 'Invoice #'+invNum+' | Client: '+(cl.name||'')+(mt?' | Matter: '+mt.name:'')+'\nTotal: $'+(totalAmt||0).toFixed(2)+' ('+(totalH||0).toFixed(2)+'h)';}
    },
    entries_table:{
      label:'Entries Table', icon:'🗃️',
      preview:entries.length+' entries · '+(totalH||0).toFixed(1)+'h',
      renderHtml:renderEntriesTable, cfgPanel:cfgPanel,
      textFn:function(b){return entries.map(function(e){var emt=ST.matters.find(function(m){return m.id==e.matterId;})||{};return e.date+'  '+(emt.name||'General')+'  '+Number(e.hours).toFixed(2)+'h = $'+(Number(e.hours)*Number(e.rate)).toFixed(2)+(e.description?'  '+e.description:'');}).join('\n');}
    },
    action_note:{
      label:'Action Note', icon:'⚠️',
      preview:'Please log in to review and approve',
      renderHtml:function(b){return renderActionNote(b,'Please log in to review the entries and approve or request changes before the invoice is sent to the client.','yellow');},
      cfgPanel:cfgPanel,
      textFn:function(b){return (b.cfg&&b.cfg.textOverride)||'Please log in to review and approve the entries.';}
    },
    decision_header:{
      label:'Decision Banner', icon:approved?'✅':'🔄',
      preview:(approved?'APPROVED':'CHANGES REQUESTED')+' — #'+invNum,
      renderHtml:function(b){var c=b.cfg||{};var t=cstr(c,'titleOverride','')||(approved?'APPROVED':'CHANGES REQUESTED');return sans('<div style="background:'+(approved?'#1a6b3a':'#8b1a1a')+';color:#fff;border-radius:6px;padding:13px 16px;margin-bottom:12px;display:flex;align-items:center;gap:10px"><div style="font-size:24px">'+(approved?'✅':'🔄')+'</div><div><div style="font-weight:700;font-size:14px">Invoice #'+H(invNum)+' — '+H(t)+'</div><div style="font-size:12px;opacity:.8">Reviewed by '+H(reviewer)+'</div></div></div>');},
      cfgPanel:cfgPanel,
      textFn:function(b){return 'Invoice #'+invNum+' — '+(approved?'APPROVED':'CHANGES REQUESTED')+'\nReviewed by: '+reviewer;}
    },
    hour_cuts:{
      label:'Hour Adjustments', icon:'✂️',
      preview:cutLines.length?cutLines.length+' adjustment'+(cutLines.length!==1?'s':''):'(none)',
      renderHtml:renderHourCuts, cfgPanel:cfgPanel,
      textFn:function(b){return cutLines.length?'--- Hour Adjustments ---\n'+cutLines.map(function(c2){return c2.label+': '+c2.orig+'h → '+c2.cut+'h';}).join('\n'):'';}
    },
    entry_comments:{
      label:'Entry Comments', icon:'💬',
      preview:commentLines.length?commentLines.length+' comment'+(commentLines.length!==1?'s':''):'(none)',
      renderHtml:renderEntryComments, cfgPanel:cfgPanel,
      textFn:function(b){return commentLines.length?'--- Entry Comments ---\n'+commentLines.map(function(c2){return c2.label+': '+c2.text;}).join('\n'):'';}
    },
    inv_comments:{
      label:'Invoice Notes Thread', icon:'🗒️',
      preview:invComments.length?invComments.length+' note'+(invComments.length!==1?'s':''):'(none)',
      renderHtml:renderInvComments, cfgPanel:cfgPanel,
      textFn:function(b){return invComments.length?'--- Invoice Notes ---\n'+invComments.map(function(c2){return c2.by+' ('+c2.at+'): '+c2.text;}).join('\n'):'';}
    },
    decision_closing:{
      label:'Closing Statement', icon:'🤝',
      preview:approved?'Invoice approved, ready to send.':'Please update and resubmit.',
      renderHtml:renderDecisionClosing, cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};return cstr(c,'textOverride','')||(approved?'This invoice is approved and ready to send to the client.':'Please update entries and resubmit for approval.');}
    },
    ts_header:{
      label:isPending?'Approval Request Header':'Summary Header', icon:'⏱',
      preview:(isPending?'Approval Request':'Billing Entries')+' from '+H(fromUser),
      renderHtml:function(b){return renderHdrBanner(b,'#1e3a5f','⏱',(b.cfg&&b.cfg.titleOverride)||(isPending?'Approval Request':'Billing Entries Summary'),'Submitted by '+(b.cfg&&b.cfg.fromOverride||fromUser));},
      cfgPanel:cfgPanel,
      textFn:function(b){return (isPending?'APPROVAL REQUEST':'BILLING SUMMARY')+'\nSubmitted by: '+(b.cfg&&b.cfg.fromOverride||fromUser);}
    },
    ts_stats:{
      label:'Stats Summary', icon:'📊',
      preview:entries.length+' entries · '+(totalH||0).toFixed(1)+'h · $'+(totalAmt||0).toFixed(2),
      renderHtml:renderTsStats, cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};var parts=[];if(cv(c,'showEntries',true))parts.push('Entries: '+entries.length);if(cv(c,'showHours',true))parts.push('Hours: '+(totalH||0).toFixed(2)+'h');if(cv(c,'showValue',true))parts.push('Total: $'+(totalAmt||0).toFixed(2));return parts.join(' | ');}
    },
    ts_entries:{
      label:'Entries by Client', icon:'📋',
      preview:entries.length+' entries grouped by client',
      renderHtml:renderTsEntriesByClient, cfgPanel:cfgPanel,
      textFn:function(b){var bc={};entries.forEach(function(e){var ecl=ST.clients.find(function(c){return c.id==e.clientId;})||{name:'?'};if(!bc[ecl.name])bc[ecl.name]=[];bc[ecl.name].push(e);});return Object.keys(bc).map(function(cn){return cn+':\n'+bc[cn].map(function(e){var emt=ST.matters.find(function(m){return m.id==e.matterId;})||{};return '  '+e.date+'  '+(emt.name||'General')+'  '+Number(e.hours).toFixed(2)+'h = $'+(Number(e.hours)*Number(e.rate)).toFixed(2)+(e.description?'  '+e.description:'');}).join('\n');}).join('\n\n');}
    },
    ts_approval_note:{
      label:'Approval Note', icon:'⚠️',
      preview:'Please log in to approve entries',
      renderHtml:function(b){return renderActionNote(b,'Please log in to approve or return these entries. Approved entries will be available for invoicing.','yellow');},
      cfgPanel:cfgPanel,
      textFn:function(b){return (b.cfg&&b.cfg.textOverride)||'Please log in to approve or return these entries.';}
    },
    by_attorney:{
      label:'By Attorney', icon:'👥',
      preview:Object.keys(byAuthor).length+' attorney'+(Object.keys(byAuthor).length!==1?'s':''),
      renderHtml:renderByAuthor, cfgPanel:cfgPanel,
      textFn:function(b){return '--- By Attorney ---\n'+Object.keys(byAuthor).map(function(a){var ad=byAuthor[a];return a+': '+ad.h.toFixed(2)+'h / $'+ad.amt.toFixed(2)+' ('+ad.count+' entries)';}).join('\n');}
    },
    by_client:{
      label:'By Client', icon:'🏢',
      preview:(function(){var cs={};(d.entries||[]).forEach(function(e){var ecl=ST.clients.find(function(c){return c.id==e.clientId;})||{name:'?'};cs[ecl.name]=1;});return Object.keys(cs).length+' client'+(Object.keys(cs).length!==1?'s':'');})(),
      renderHtml:renderByClient, cfgPanel:cfgPanel,
      textFn:function(b){var bc={};(d.entries||[]).forEach(function(e){var ecl=ST.clients.find(function(c){return c.id==e.clientId;})||{name:'?'};if(!bc[ecl.name]){bc[ecl.name]={h:0,amt:0,count:0};}bc[ecl.name].h+=Number(e.hours);bc[ecl.name].amt+=Number(e.hours)*Number(e.rate);bc[ecl.name].count++;});return '--- By Client ---\n'+Object.keys(bc).map(function(cn){var cd=bc[cn];return cn+': '+cd.h.toFixed(2)+'h / $'+cd.amt.toFixed(2)+' ('+cd.count+' entries)';}).join('\n');}
    },
    summary_header:{
      label:'Summary Header', icon:'📈',
      preview:firmName+' · $'+(totalAmt||0).toFixed(2),
      renderHtml:renderSummaryHeader, cfgPanel:cfgPanel,
      textFn:function(b){var c=b.cfg||{};return (cstr(c,'titleOverride','')||firmName)+' — Billing Summary\nPrepared by: '+(cstr(c,'fromOverride','')||fromUser)+'\nTotal: $'+(totalAmt||0).toFixed(2)+' ('+(totalH||0).toFixed(2)+'h)';}
    },
    custom_text:{
      label:'Custom Text', icon:'✏️',
      preview:'Editable text block',
      renderHtml:renderCustomText, cfgPanel:cfgPanel,
      textFn:function(b){return (b.customText||'').trim();}
    },
    spacer:{
      label:'Spacer', icon:'⬜',
      preview:'Vertical spacing',
      renderHtml:renderSpacer, cfgPanel:cfgPanel,
      textFn:function(){ return ''; }
    }
  };
}


function ecPaletteFor(d){
  var type=d.type||'generic';
  var cl=d.cl||{};
  var inv=d.inv||{};
  var mt=d.mt||null;
  var invNum=inv.number||String(inv.id||'');
  var fromUser=d.fromUser||(ST.user?ST.user.name:'');
  var firmName=d.firmName||inv.firmName||ST.prefs.appName||'Our Firm';
  var approved=d.approved;
  var partners=ST.contacts.filter(function(c){return c.role&&c.role.toLowerCase().indexOf('partner')!==-1;});
  var allStaff=ST.contacts.filter(function(c){return c.email;});

  var recs=[], subjs=[], btypes=[];

  if(type==='invClient'){
    if(cl.email) recs.push({label:H(cl.name)+(cl.email?' <'+cl.email+'>':''),email:cl.email});
    recs.push({label:'+ Custom recipient',email:''});
    subjs=['Invoice #'+invNum+' from '+firmName+(mt?' — '+mt.name:''),
           'Your invoice is ready — '+H(cl.name||''),
           'Payment due: Invoice #'+invNum];
    btypes=['greeting','inv_header','line_items','totals','payment_terms','inv_notes','signature','custom_text','spacer'];

  } else if(type==='invApproval'){
    partners.forEach(function(p){if(p.email)recs.push({label:H(p.name)+' <'+p.email+'>',email:p.email});});
    if(!recs.length) recs.push({label:'+ Add partner email',email:''});
    subjs=['Action Required: Invoice #'+invNum+' — '+H(cl.name||'')+(mt?' / '+H(mt.name):''),
           'Invoice #'+invNum+' ready for your approval'];
    btypes=['approval_header','inv_summary','entries_table','action_note','signature','custom_text','spacer'];

  } else if(type==='invDecision'){
    var entAuthors={};
    (inv.entryIds||[]).forEach(function(eid){var e=_lu.en[eid];if(e&&e.createdBy)entAuthors[e.createdBy]=true;});
    var authorNames=Object.keys(entAuthors);
    var ct=ST.contacts.find(function(c){return authorNames.indexOf(c.name)!==-1&&c.email;});
    if(ct) recs.push({label:H(ct.name)+' <'+ct.email+'>',email:ct.email});
    recs.push({label:'+ Custom recipient',email:''});
    subjs=['Invoice #'+invNum+' — '+(approved?'Approved':'Changes Requested')+' — '+H(cl.name||''),
           'Review complete: Invoice #'+invNum];
    btypes=['decision_header','hour_cuts','entry_comments','inv_comments','decision_closing','signature','custom_text','spacer'];

  } else if(type==='tsApproval'){
    partners.forEach(function(p){if(p.email)recs.push({label:H(p.name)+' <'+p.email+'>',email:p.email});});
    if(!recs.length) recs.push({label:'+ Add partner email',email:''});
    subjs=[(d.isPending?'Approval Request':'Billing Entries')+' from '+H(fromUser),
           'Time entries ready for review — '+H(fromUser)];
    btypes=['ts_header','ts_stats','ts_entries','ts_approval_note','signature','custom_text','spacer'];

  } else if(type==='tsSummary'){
    allStaff.forEach(function(c){recs.push({label:H(c.name)+' <'+c.email+'>',email:c.email});});
    if(!recs.length) recs.push({label:'+ Add recipient',email:''});
    subjs=['Billing Summary — '+H(firmName),
           'Monthly billing report — '+H(firmName)];
    btypes=['summary_header','ts_stats','by_attorney','by_client','signature','custom_text','spacer'];
  }

  return {recs:recs, subjs:subjs, btypes:btypes};
}

// Default body blocks for each context
function ecDefaultBlocks(type){
  var map={
    invClient:   ['greeting','inv_header','line_items','totals','payment_terms','inv_notes','signature'],
    invApproval: ['approval_header','inv_summary','entries_table','action_note'],
    invDecision: ['decision_header','hour_cuts','entry_comments','inv_comments','decision_closing'],
    tsApproval:  ['ts_header','ts_stats','ts_entries','ts_approval_note'],
    tsSummary:   ['summary_header','ts_stats','by_attorney','by_client','signature']
  };
  return (map[type]||['custom_text']).map(function(btype,i){
    return {id:Date.now()+i, btype:btype, customText:''};
  });
}

// === EMAIL COMPOSE MODAL (simple send screen — pick template, review, send)
function buildEmailCompose(){
  var d=ST.emailDraft||{};
  var type=d.type||'generic';
  var typeLabels={invClient:'Email Invoice to Client',invApproval:'Request Partner Approval',invDecision:'Send Review Decision',tsApproval:'Submit Entries for Approval',tsSummary:'Send Billing Summary'};
  var typeLabel=typeLabels[type]||'Send Email';

  // Context info banner
  var ctx=d;
  var ctxPills='';
  if(ctx.clientName) ctxPills+='<span style="background:var(--bg);border:1px solid var(--brd);border-radius:12px;padding:2px 10px;font-size:11px"><strong>Client:</strong> '+H(ctx.clientName)+'</span> ';
  if(ctx.invNum) ctxPills+='<span style="background:var(--bg);border:1px solid var(--brd);border-radius:12px;padding:2px 10px;font-size:11px"><strong>Invoice:</strong> #'+H(String(ctx.invNum))+'</span> ';
  if(ctx.invAmount) ctxPills+='<span style="background:var(--bg);border:1px solid var(--brd);border-radius:12px;padding:2px 10px;font-size:11px"><strong>Amount:</strong> '+H(String(ctx.invAmount))+'</span> ';
  if(ctx.hoursTotal) ctxPills+='<span style="background:var(--bg);border:1px solid var(--brd);border-radius:12px;padding:2px 10px;font-size:11px"><strong>Hours:</strong> '+H(String(ctx.hoursTotal))+'h</span> ';
  if(ctx.entriesCount!=null) ctxPills+='<span style="background:var(--bg);border:1px solid var(--brd);border-radius:12px;padding:2px 10px;font-size:11px"><strong>Entries:</strong> '+H(String(ctx.entriesCount))+'</span>';

  // Filter templates for this email type
  var allTpl=ST.emailTemplates||[];
  var matching=allTpl.filter(function(t){return !t.types||!t.types.length||t.types.indexOf(type)!==-1||t.types.indexOf('all')!==-1;});
  var selected=d.selectedTemplateId?allTpl.find(function(t){return t.id==d.selectedTemplateId;}):null;

  // Template picker list
  var tplList=matching.length===0
    ?'<div class="empty" style="padding:32px"><p>No templates yet</p><small>Build one in <strong>Settings → Email Templates</strong> and tag it for this email type.</small>'
      +'<br><button class="btn btn-dk" style="margin-top:12px" onclick="A.etOpen(null,\''+type+'\')">'+IC.plus+' Create Template</button></div>'
    :matching.map(function(t){
        var isSelected=selected&&selected.id===t.id;
        return '<button onclick="A.ecSelectTemplate(\''+t.id+'\')" style="display:flex;align-items:flex-start;gap:10px;width:100%;text-align:left;padding:11px 13px;border:2px solid '+(isSelected?'var(--blue)':'var(--brd)')+';border-radius:8px;background:'+(isSelected?'var(--blue-pale)':'var(--white)')+';cursor:pointer;margin-bottom:7px">'
          +'<span style="font-size:20px;flex-shrink:0;line-height:1;margin-top:1px">📧</span>'
          +'<div style="flex:1;min-width:0">'
          +'<div style="font-size:13px;font-weight:600;color:'+(isSelected?'var(--blue)':'var(--ink)')+'">'+H(t.name)+'</div>'
          +(t.description?'<div style="font-size:11px;color:var(--ink3);margin-top:1px">'+H(t.description)+'</div>':'')
          +'<div style="font-size:10px;color:var(--ink3);margin-top:3px">'+t.blocks.filter(function(b){return !b.hidden;}).length+' block'+(t.blocks.filter(function(b){return !b.hidden;}).length!==1?'s':'')+' · '+(t.defaultSubject?H(t.defaultSubject):'no default subject')+'</div>'
          +'</div>'
          +(isSelected?'<span style="color:var(--blue);font-size:18px;flex-shrink:0;line-height:1">✓</span>':'')
          +'</button>';
      }).join('');

  // Preview panel (right side when template selected)
  var previewH='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--ink3);font-size:13px;flex-direction:column;gap:8px">'
    +'<span style="font-size:32px;opacity:.3">📧</span>'
    +'<span>Select a template to preview</span></div>';
  if(selected){
    var defs2=ecBlockDefs(Object.assign({},d,{bodyBlocks:selected.blocks}));
    previewH=selected.blocks.filter(function(b){return !b.hidden;}).map(function(b){
      var def=defs2[b.btype]; if(!def) return '';
      return (def.renderHtml?def.renderHtml(b):'')||'';
    }).join('');
    if(!previewH) previewH='<div style="color:var(--ink3);font-size:12px;padding:20px">No preview content for this template with the current context data.</div>';
  }

  var toVal=H(d.to||'');
  var subjVal=H(selected&&selected.defaultSubject||d.subject||'');
  var hasTemplate=!!selected;

  return '<div class="ov"><div class="modal modal-xl" style="height:88vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd" style="flex-shrink:0">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+H(typeLabel)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'

    // Context pills strip
    +(ctxPills?'<div style="flex-shrink:0;display:flex;flex-wrap:wrap;gap:6px;padding:8px 16px;border-bottom:1px solid var(--brd);background:var(--bg2)">'+ctxPills+'</div>':'')

    // To + Subject (minimal, always visible)
    +'<div style="flex-shrink:0;display:grid;grid-template-columns:200px 1fr;gap:10px;padding:9px 16px;border-bottom:1px solid var(--brd);align-items:end">'
    +'<div class="fl" style="margin:0"><label style="font-size:11px">To</label>'
    +'<input type="text" id="ec-to" value="'+toVal+'" placeholder="recipient@example.com" style="font-size:13px"></div>'
    +'<div class="fl" style="margin:0"><label style="font-size:11px">Subject</label>'
    +'<input type="text" id="ec-subject" value="'+subjVal+'" placeholder="Email subject…" style="font-size:13px"></div>'
    +'</div>'

    // Body: left = template picker, right = preview
    +'<div style="display:flex;flex:1;overflow:hidden;min-height:0">'

    // Left: template list
    +'<div style="width:280px;flex-shrink:0;border-right:1px solid var(--brd);overflow-y:auto;padding:12px">'
    +'<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink3);margin-bottom:10px">Choose a template</div>'
    +tplList
    +'<button onclick="A.etOpen(null,\''+type+'\')" style="display:flex;align-items:center;gap:5px;width:100%;font-size:11px;padding:7px 10px;border:1px dashed var(--brd);border-radius:7px;background:none;cursor:pointer;color:var(--ink3);margin-top:4px">'
    +IC.plus+' New template</button>'
    +'</div>'

    // Right: preview
    +'<div style="flex:1;overflow-y:auto;padding:16px 20px;background:var(--bg2)">'
    +(selected
      ?'<div style="background:var(--white);border:1px solid var(--brd);border-radius:8px;padding:24px 28px;max-width:700px;margin:0 auto">'+previewH+'</div>'
        +'<div style="text-align:center;margin-top:14px">'
        +'<button onclick="A.etOpen(\''+selected.id+'\',\''+type+'\')" style="font-size:11px;padding:4px 12px;background:none;border:1px solid var(--brd);border-radius:5px;cursor:pointer;color:var(--ink3)">'+IC.edit+' Edit template</button>'
        +'</div>'
      :previewH)
    +'</div>'

    +'</div>'

    // Footer
    +'<div class="modal-ft" style="gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +(hasTemplate?'<button class="btn btn-gh" onclick="A.ecCopyText()" style="gap:5px">'+IC.dl+' Copy Text</button>'
      +'<button class="btn btn-gr" onclick="A.ecOpen()" style="gap:5px">'+IC.mail+' Open in Mail App</button>':'')
    +'</div>'
    +'</div></div>';
}


// === EMAIL TEMPLATE EDITOR (full block builder — accessed from Settings or Send screen)
function buildEmailTemplateEditor(){
  var tf=ST.etf||{};
  var isEdit=(tf.editId!=null);
  var blocks=tf.blocks||[];
  var showPreview=!!tf.showPreview;

  // Proxy emailDraft-style object for block rendering
  var dProxy=Object.assign({},ST.emailDraft||{},{bodyBlocks:blocks});
  var defs=ecBlockDefs(dProxy);

  // ── Palette (all block categories)
  var BLOCK_CATS2=[
    {label:'Structure',      btypes:['greeting','custom_text','spacer','signature']},
    {label:'Invoice',        btypes:['inv_header','inv_summary','line_items','totals','inv_notes']},
    {label:'Entries & Data', btypes:['entries_table','ts_entries','ts_stats','by_attorney','by_client']},
    {label:'Workflow',       btypes:['approval_header','action_note','ts_header','ts_approval_note','decision_header','decision_closing','hour_cuts','entry_comments','inv_comments','summary_header']}
  ];
  var etBlockPal=BLOCK_CATS2.map(function(cat){
    var items=cat.btypes.map(function(btype){
      var def=defs[btype]; if(!def) return '';
      return '<div draggable="true" ondragstart="A.etDragPalette(event,\''+btype+'\')" '
        +'style="display:flex;align-items:center;gap:5px;padding:4px 6px;margin-bottom:2px;border:1px solid var(--brd);border-radius:5px;background:var(--bg);user-select:none">'
        +'<span style="font-size:12px;flex-shrink:0;cursor:grab">'+def.icon+'</span>'
        +'<div style="flex:1;min-width:0;cursor:grab"><div style="font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+H(def.label)+'</div></div>'
        +'<button onclick="A.etAddBlock(\''+btype+'\',null)" title="Add" style="flex-shrink:0;background:none;border:none;cursor:pointer;font-size:14px;font-weight:700;color:var(--blue);padding:0 2px;opacity:.7" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.7">+</button>'
        +'</div>';
    }).join('');
    return '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--ink3);padding:7px 0 3px">'+H(cat.label)+'</div>'+items;
  }).join('');

  // ── Insert picker
  function etRenderInsertPicker(atIdx){
    return '<div style="background:var(--blue-pale);border:2px solid var(--blue);border-radius:7px;padding:8px 10px;margin-bottom:4px">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">'
      +'<span style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--blue)">Insert block '+(atIdx===null?'at end':'above #'+(atIdx+1))+'</span>'
      +'<button onclick="A.etHideInsertPicker()" style="background:none;border:none;cursor:pointer;font-size:16px;line-height:1;color:var(--ink3)">×</button>'
      +'</div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:3px">'
      +Object.keys(defs).map(function(btype){
        var bd=defs[btype];
        return '<button onclick="A.etAddBlock(\''+btype+'\','+JSON.stringify(atIdx)+')" '
          +'style="display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border:1px solid var(--brd);border-radius:12px;background:var(--white);cursor:pointer;font-size:11px;white-space:nowrap">'
          +bd.icon+' '+H(bd.label)+'</button>';
      }).join('')
      +'</div></div>';
  }

  // ── Block row renderer
  function etRenderBlock(b,i){
    var def=defs[b.btype]; if(!def) return '';
    var isExp=!!b.expanded, isHid=!!b.hidden;
    var isFirst=(i===0), isLast=(i===blocks.length-1);
    var pickerSlot=(tf.insertPickerAt===i)?etRenderInsertPicker(i):'';
    b._idx=i;
    var cfgH=isExp&&def.cfgPanel?(def.cfgPanel(b)||''):'';
    if(isExp&&!cfgH) cfgH='<div style="font-size:11px;color:var(--ink3);font-style:italic;padding:6px 0">No settings for this block type.</div>';
    var contentH='';
    if(isHid){
      contentH='<span style="font-size:11px;color:var(--ink3);font-style:italic">Hidden</span>';
    } else if(b.btype==='custom_text'){
      contentH='<textarea id="et-custom-'+i+'" rows="2" placeholder="Type your message…" oninput="A.etCustomText('+i+',this.value)" '
        +'style="display:block;width:100%;margin-top:4px;font-size:12px;padding:5px 8px;border:1px solid var(--brd);border-radius:4px;background:var(--bg);resize:vertical;box-sizing:border-box;font-family:inherit">'
        +H(b.customText||'')+'</textarea>';
    } else {
      contentH='<span style="font-size:11px;color:var(--ink2)">'+H(def.preview)+'</span>';
    }
    function cb(title,content,oc,extra){
      return '<button onclick="'+oc+'" title="'+title+'" style="flex-shrink:0;background:none;border:none;cursor:pointer;font-size:12px;padding:2px 4px;border-radius:3px;color:var(--ink3);line-height:1;opacity:.5'+(extra?';'+extra:'')+'" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.5">'+content+'</button>';
    }
    return pickerSlot
      +'<div id="etb-'+i+'" draggable="true" '
      +'ondragstart="A.etDragBody(event,'+i+')" '
      +'ondragover="A.etBodyDragOver(event,'+i+')" '
      +'ondrop="A.etBodyDrop(event,'+i+')" '
      +'ondragleave="A.etBodyDragLeave(event)" '
      +'style="border:1px solid var(--brd);border-radius:6px;background:var(--bg);margin-bottom:4px;overflow:hidden'+(isHid?';opacity:.4':'')+';">'
      +'<div style="display:flex;align-items:flex-start;gap:5px;padding:6px 7px">'
      +'<span style="cursor:grab;color:var(--ink3);font-size:13px;line-height:1;padding-top:3px;flex-shrink:0;opacity:.35">⠿</span>'
      +'<span style="font-size:13px;flex-shrink:0;line-height:1;padding-top:3px">'+def.icon+'</span>'
      +'<div style="flex:1;min-width:0">'
      +'<div style="font-size:12px;font-weight:600;line-height:1.2'+(isHid?';text-decoration:line-through;color:var(--ink3)':'')+'">'+H(def.label)+'</div>'
      +contentH+'</div>'
      +'<div style="display:flex;align-items:center;gap:1px;flex-shrink:0;padding-top:1px">'
      +cb('Move up','↑','A.etMoveBlock('+i+',-1)', isFirst?'opacity:.15;cursor:not-allowed':'')
      +cb('Move down','↓','A.etMoveBlock('+i+',1)', isLast?'opacity:.15;cursor:not-allowed':'')
      +'<span style="width:1px;height:12px;background:var(--border);margin:0 2px;display:inline-block;opacity:.5"></span>'
      +cb('Duplicate','⧉','A.etDuplicateBlock('+i+')')
      +cb('Insert above','⊕','A.etShowInsertPicker('+i+')')
      +'<span style="width:1px;height:12px;background:var(--border);margin:0 2px;display:inline-block;opacity:.5"></span>'
      +'<button onclick="A.etToggleBlockVisible('+i+')" title="'+(isHid?'Show':'Hide')+'" style="flex-shrink:0;background:none;border:none;cursor:pointer;font-size:12px;padding:2px 4px;border-radius:3px;color:'+(isHid?'var(--blue)':'var(--ink3)')+';line-height:1;opacity:'+(isHid?'1':'.5')+'" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=\''+(isHid?'1':'.5')+'\'">'+(isHid?'👁':'🙈')+'</button>'
      +'<button onclick="A.etToggleBlockExpand('+i+')" title="Settings" style="flex-shrink:0;background:none;border:none;cursor:pointer;font-size:13px;padding:2px 4px;border-radius:3px;color:'+(isExp?'var(--blue)':'var(--ink3)')+';opacity:'+(isExp?'1':'.5')+'" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=\''+(isExp?'1':'.5')+'\'">⚙</button>'
      +'<button onclick="A.etRemoveBlock('+i+')" title="Remove" style="flex-shrink:0;background:none;border:none;cursor:pointer;color:var(--ink3);font-size:16px;padding:1px 3px;opacity:.4;border-radius:3px;line-height:1" onmouseover="this.style.opacity=1;this.style.color=\'var(--red)\'" onmouseout="this.style.opacity=.4;this.style.color=\'var(--ink3)\'">×</button>'
      +'</div></div>'
      +(isExp?'<div style="border-top:1px solid var(--brd);padding:8px 10px;background:var(--bg2)">'+cfgH+'</div>':'')
      +'</div>';
  }

  var endPickerH=(tf.insertPickerAt===null&&blocks.length>0)?etRenderInsertPicker(null):'';
  var visCount=blocks.filter(function(b){return !b.hidden;}).length;
  var hidCount=blocks.length-visCount;
  var blockCountH='<span style="font-size:10px;color:var(--ink3);margin-left:6px">'+blocks.length+' block'+(blocks.length!==1?'s':''+(hidCount?' · '+hidCount+' hidden':''))+'</span>';

  var bodyBlocksH=blocks.length===0
    ?'<div style="border:2px dashed var(--brd);border-radius:7px;padding:28px;text-align:center;color:var(--ink3);font-size:12px">← Drag blocks from the panel, or click <strong>+</strong></div>'
    :blocks.map(etRenderBlock).join('')+endPickerH;

  var dropZoneH='<div id="et-drop-zone" ondragover="A.etZoneDragOver(event)" ondrop="A.etZoneDrop(event)" '
    +'style="height:28px;border:2px dashed var(--brd);border-radius:6px;display:flex;align-items:center;justify-content:center;margin-top:3px;color:var(--ink3);font-size:11px">'
    +'<span>⬇ drop to append · <button onclick="A.etShowInsertPicker(null)" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--blue);padding:0">⊕ insert here</button></span></div>';

  // Preview
  var assembledPreview='';
  if(showPreview){
    assembledPreview=blocks.filter(function(b){return !b.hidden;}).map(function(b){
      var def=defs[b.btype]; if(!def) return '';
      return (def.renderHtml?def.renderHtml(b):'')||'';
    }).join('');
    if(!assembledPreview) assembledPreview='<div style="color:var(--ink3);font-size:12px;padding:20px">No visible blocks to preview.</div>';
  }

  // Type tags — what email contexts this template applies to
  var allTypes=[['invClient','Invoice to Client'],['invApproval','Partner Approval'],['invDecision','Review Decision'],['tsApproval','Submit for Approval'],['tsSummary','Billing Summary'],['all','All contexts']];
  var selTypes=tf.types||[];
  var typesH=allTypes.map(function(tp){
    var sel=selTypes.indexOf(tp[0])!==-1;
    return '<button onclick="A.etToggleType(\''+tp[0]+'\')" '
      +'style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border:1px solid '+(sel?'var(--blue)':'var(--brd)')+';border-radius:12px;background:'+(sel?'var(--blue-pale)':'var(--bg)')+';cursor:pointer;font-size:11px;font-weight:'+(sel?'600':'400')+';color:'+(sel?'var(--blue)':'var(--ink2)')+'">'
      +(sel?'✓ ':'')+H(tp[1])+'</button>';
  }).join(' ');

  function etTabBtn(lbl,active,oc){
    return '<button onclick="'+oc+'" style="padding:5px 14px;font-size:12px;font-weight:'+(active?'700':'400')+';border:none;border-bottom:2px solid '+(active?'var(--blue)':'transparent')+';background:none;cursor:pointer;color:'+(active?'var(--blue)':'var(--ink2)')+'">'+lbl+'</button>';
  }
  var tabBar2='<div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--brd);padding:0 2px;margin-bottom:8px;flex-shrink:0">'
    +'<div style="display:flex;align-items:center">'
    +etTabBtn('Build',!showPreview,'A.etSetView(false)')
    +etTabBtn('Preview',showPreview,'A.etSetView(true)')
    +(!showPreview?blockCountH:'')
    +'</div>'
    +(!showPreview
      ?'<div style="display:flex;gap:4px">'
        +'<button onclick="A.etExpandAll()" style="font-size:10px;padding:2px 7px;background:none;border:1px solid var(--brd);border-radius:4px;cursor:pointer;color:var(--ink3)">Expand all ⚙</button>'
        +'<button onclick="A.etCollapseAll()" style="font-size:10px;padding:2px 7px;background:none;border:1px solid var(--brd);border-radius:4px;cursor:pointer;color:var(--ink3)">Collapse all</button>'
        +'</div>':'')
    +'</div>';

  var rightContent2=showPreview
    ?tabBar2+'<div style="flex:1;overflow-y:auto;min-height:0;padding-bottom:16px"><div style="background:#fff;padding:24px 28px;border:1px solid var(--brd);border-radius:7px;max-width:700px;margin:0 auto">'+assembledPreview+'</div></div>'
    :tabBar2+'<div style="flex:1;overflow-y:auto;min-height:0">'+bodyBlocksH+dropZoneH+'</div>';

  return '<div class="ov"><div class="modal modal-xl" style="height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd" style="flex-shrink:0">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(isEdit?'Edit':'New')+' Email Template</h2>'
    +'<button class="btn-ic" onclick="A.etClose()">'+IC.x+'</button></div>'

    // Template meta strip
    +'<div style="flex-shrink:0;padding:10px 14px;border-bottom:1px solid var(--brd);background:var(--bg2);display:grid;grid-template-columns:1fr 1fr;gap:10px">'
    +'<div class="fl" style="margin:0"><label style="font-size:11px">Template Name <span class="req">*</span></label>'
    +'<input type="text" id="et-name" value="'+H(tf.name||'')+'" placeholder="e.g. Standard Invoice to Client"></div>'
    +'<div class="fl" style="margin:0"><label style="font-size:11px">Default Subject</label>'
    +'<input type="text" id="et-subject" value="'+H(tf.defaultSubject||'')+'" placeholder="Invoice #{invoice_num} — {client}"></div>'
    +'</div>'
    +'<div style="flex-shrink:0;padding:8px 14px;border-bottom:1px solid var(--brd);background:var(--bg2)">'
    +'<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink3);margin-bottom:6px">Applies to email type (multi-select)</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:5px">'+typesH+'</div>'
    +'</div>'
    +'<div style="flex-shrink:0;padding:6px 14px;border-bottom:1px solid var(--brd);background:var(--bg2)">'
    +'<div class="fl" style="margin:0"><label style="font-size:11px">Description / notes <span style="color:var(--ink3)">(optional)</span></label>'
    +'<input type="text" id="et-desc" value="'+H(tf.description||'')+'" placeholder="e.g. Used for monthly billing…"></div>'
    +'</div>'

    // Two-col body
    +'<div style="display:flex;flex:1;overflow:hidden;min-height:0">'

    // Left palette
    +'<div style="width:180px;flex-shrink:0;border-right:1px solid var(--brd);overflow-y:auto;padding:0 8px 12px">'
    +'<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--ink3);padding:8px 0 5px">Drag or click + to add</div>'
    +etBlockPal
    +'</div>'

    // Right: build / preview
    +'<div style="flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;padding:10px 12px 0">'
    +rightContent2
    +'</div>'

    +'</div>'

    +'<div class="modal-ft" style="gap:8px">'
    +'<button class="btn btn-gh" onclick="A.etClose()">Cancel</button>'
    +'<button class="btn btn-bl" onclick="A.etSave()">'+IC.save+' Save Template</button>'
    +'</div>'
    +'</div></div>';
}



// === MAIN RENDER
var TABS=[
  {id:'timesheet', lbl:'Timesheet', ic:IC.clock},
  {id:'clients',   lbl:'Clients',   ic:IC.users},
  {id:'matters',   lbl:'Matters',   ic:IC.brief},
  {id:'contacts',  lbl:'Contacts',  ic:IC.doc},
  {id:'analytics', lbl:'Analytics', ic:IC.chart},
  {id:'invoices',  lbl:'Invoices',  ic:IC.invoice},
  {id:'approvals', lbl:'Approvals', ic:IC.shield, roleOnly:'partner'}
];

// === LOOKUP MAPS
// Built once at the start of render() — all views get O(1) id→record access
// instead of repeated O(n) .find() inside .map()/.sort() callbacks.
var _lu={cl:{},ma:{},ct:{},en:{}};
function buildLookups(){
  var cl={},ma={},ct={},en={};
  ST.clients.forEach(function(r){cl[r.id]=r;});
  ST.matters.forEach(function(r){ma[r.id]=r;});
  ST.contacts.forEach(function(r){ct[r.id]=r;});
  ST.entries.forEach(function(r){en[r.id]=r;});
  _lu.cl=cl; _lu.ma=ma; _lu.ct=ct; _lu.en=en;
}

var _dRenderTimer=null;
var _dFocusId='',_dFocusSel=0;
function dRender(){
  var a=document.activeElement;
  if(a&&a.id&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA')){_dFocusId=a.id;_dFocusSel=a.selectionStart||0;}
  clearTimeout(_dRenderTimer);
  _dRenderTimer=setTimeout(function(){
    render();
    if(_dFocusId){var el=document.getElementById(_dFocusId);if(el){el.focus();try{el.setSelectionRange(_dFocusSel,_dFocusSel);}catch(e){}}_dFocusId='';} 
  },200);
}

function render(){
  buildLookups(); // O(n) once — all views use _lu.cl/ma/ct/en for O(1) lookups
  // applyPrefs() removed: it runs in savePrefs() before every prefs-changing
  // render, and in INIT. Calling it on every render was wasted DOM classList work.
  var views={timesheet:vTimesheet,clients:vClients,matters:vMatters,contacts:vContacts,analytics:vAnalytics,approvals:vApprovals,invoices:vInvoices};
  var role=myRole();
  var visTabs=TABS.filter(function(t){return !t.roleOnly||t.roleOnly===role;});
  var nav=visTabs.map(function(t){
    var pcount=(t.id==='approvals'&&role==='partner')?(ST.entries.filter(function(e){return (e.status||'approved')==='pending';}).length + (ST.invoices||[]).filter(function(i){return i.status==='review';}).length):0;
    var badge=pcount>0?' <span style="background:var(--amber);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px">'+pcount+'</span>':'';
    return '<button class="nav-btn'+(ST.tab===t.id?' on':'')+'" onclick="A.setTab(\''+t.id+'\')">'+t.ic+' '+t.lbl+badge+'</button>';
  }).join('');
  var tabDef=TABS.find(function(t){return t.id===ST.tab;});
  if(tabDef&&tabDef.roleOnly&&tabDef.roleOnly!==role){ST.tab="timesheet";}
  var viewH=(views[ST.tab]||vTimesheet)();
  var overlays='';
  if(ST.modal==='up') overlays=buildUP();
  else if(ST.modal==='ql') overlays=buildQL();
  else if(ST.modal==='help') overlays=buildHelp();
  else if(ST.modal==='settings') overlays=buildSettings();
  else if(ST.modal==='mailpreset') overlays=buildMailPreset();
  else if(ST.modal==='mailsend') overlays=buildMailSend();
  else if(ST.modal==='mailcompose') overlays=buildMailCompose();
  else if(ST.modal==='importData') overlays=buildImportModal();
  else if(ST.modal==='exportModal') overlays=buildExportModal();
  else if(ST.modal==='ituser') overlays=buildITUserModal();
  else if(ST.modal==='profileImport') overlays=buildProfileImport();
  else if(ST.modal==='userSelect') overlays=buildITUserSelect();
  else if(ST.modal==='invForm') overlays=buildInvoiceForm();
  else if(ST.modal==='invReview') overlays=buildInvoiceReview();
  else if(ST.modal==='invPrint') overlays=buildInvoicePrint();
  else if(ST.modal==='pref') overlays=buildPartnerReview();
  else if(ST.modal==='emailCompose') overlays=buildEmailCompose();
  else if(ST.modal==='emailtemplateeditor') overlays=buildEmailTemplateEditor();

  var appName=H(ST.prefs.appName||'SixMinuteLog.com');
  var dmCur=ST.prefs.darkMode;
  var dmIcon=dmCur===true?IC.sun:IC.moon;
  var dmTitle=dmCur===null?'Theme: Auto (click for Dark)':dmCur===true?'Theme: Dark (click for Light)':'Theme: Light (click for Auto)';

  document.getElementById('app').innerHTML=
    '<div class="header">'
    +'<div class="header-inner">'
    +'<div class="logo"><span style="font-size:1.4rem">&#9878;&#65039;</span>'
    +'<div><h1>'+appName+'</h1>'+(ST.user?'<div class="logo-sub" style="display:flex;align-items:center;gap:6px">'+H(ST.user.name)+' '+roleBadge(ST.user.role)+'</div>':'')+'</div></div>'
    +'<div class="header-btns">'
    +'<button class="btn btn-bl" onclick="A.openImport()">'+IC.ul+' Import</button>'
    +'<button class="btn btn-gr" onclick="A.openExportModal()">'+IC.dl+' Export</button>'
    +'<button class="btn-ic" onclick="A.downloadApp()" title="Download app for offline use" style="font-size:15px">&#128190;</button>'
    +'<button class="btn-ic" onclick="A.togDark()" title="'+dmTitle+'" style="'+( dmCur===true?'color:var(--amber)':dmCur===null?'color:var(--ink3)':'')+'">'+(dmIcon)+'</button>'
    +'<button class="btn-ic" onclick="A.openHelp()" title="Help">'+IC.help+'</button>'
    +'<button class="btn-ic" onclick="A.openSettings()" title="Settings">'+IC.gear+'</button>'
    +'</div></div>'
    +'<div class="nav">'+nav+'</div></div>'
    +'<div class="main">'+viewH+'</div>'
    +overlays;

  document.getElementById('fab').style.display=(isBilling()||(ST.modal&&ST.modal!=='help'&&ST.modal!=='settings'))?'none':'flex';
  if(ST.modal==='up') setTimeout(function(){var el=document.getElementById('up-n');if(el)el.focus();},50);
  if(ST.modal==='mailpreset') setTimeout(_mpPreview,30);
}


// === ACTIONS
var A={
  setTab:function(t){ST.tab=t;ST.modal=null;ST.editId=null;render();},
  setTsF:function(v){ST.tsFilter=v;render();},
  setAnF:function(v){ST.anFilter=v;render();},
  // Timesheet extra filters & sort
  setTsClF:function(v){ST.tsClientFilter=v;ST.tsMatterFilter='';render();},
  setTsMaF:function(v){ST.tsMatterFilter=v;render();},
  setTsSort:function(v){ST.tsSort=v;render();},
  clearTsFilters:function(){ST.tsClientFilter='';ST.tsMatterFilter='';ST.tsSort='date-desc';render();},
  // Clients
  setClSort:function(v){ST.clSort=v;render();},
  setClSearch:function(v){ST.clSearch=v;dRender();},
  // Matters
  setMaSort:function(v){ST.maSort=v;render();},
  setMaClF:function(v){ST.maClientFilter=v;render();},
  setMaSearch:function(v){ST.maSearch=v;dRender();},
  toggleMaGroup:function(){ST.maGroup=!ST.maGroup;render();},
  clearMaFilters:function(){ST.maClientFilter='';ST.maSearch='';ST.maSort='alpha';ST.maGroup=false;render();},
  // Contacts
  setCtSort:function(v){ST.ctSort=v;render();},
  setCtSearch:function(v){ST.ctSearch=v;dRender();},
  setHT:function(t){ST.helpTab=t;render();},
  closeF:function(){ST.modal=null;ST.editId=null;render();},
  closeM:function(){ST.modal=null;render();},

  // == Dark Mode ==
  setDarkMode:function(v){
    // v is null (auto), true (dark), or false (light) — passed from onclick or settings
    ST.prefs.darkMode=v;
    savePrefs(); render();
  },
  togDark:function(){
    // Cycle: auto → dark → light → auto
    var cur=ST.prefs.darkMode;
    ST.prefs.darkMode=cur===null?true:(cur===true?false:null);
    savePrefs(); render();
  },
  togDarkPref:function(v){
    ST.prefs.darkMode=v;
    savePrefs(); render();
  },

  // == Revenue Split Feature ==
  togRevenueSplit:function(v){
    ST.prefs.revenueSplit=v;
    savePrefs();
    toast(v?'Revenue split enabled — Personal Cut % fields are now visible':'Revenue split disabled','ok');
    render();
  },

  // == Layout ==
  setLayout:function(v){
    ST.prefs.layout=v;
    savePrefs(); render();
  },

  // == App Name ==
  saveAppName:function(){
    var n=(document.getElementById('pref-name')||{}).value||'SixMinuteLog.com';
    ST.prefs.appName=n.trim()||'SixMinuteLog.com';
    savePrefs(); toast('App name saved','ok'); render();
  },

  // == Settings Tab ==
  setStab:function(t){
    if(ST.modal==='settings'){syncForm();}
    ST.settingsTab=t; render();
  },

  // == Description Presets ==
  pickDesc:function(fieldId, idx){
    var p=typeof idx==='number'?ST.descPresets[idx]:idx;
    if(!p) return;
    var el=document.getElementById(fieldId);
    if(!el) return;
    el.value=p;
    // Sync to state
    if(fieldId==='ef-desc') ST.ef.description=p;
    if(fieldId==='ql-d'){ ST.ql.description=p; render(); }
    // Animate chip
    var chips=document.querySelectorAll('.desc-chip');
    chips.forEach(function(c){ c.classList.remove('active'); });
  },
  addDesc:function(){
    var inp=document.getElementById('desc-new');
    if(!inp) return;
    var v=inp.value.trim();
    if(!v){ toast('Enter a description first','warn'); return; }
    ST.descPresets.push(v);
    save(); toast('Suggestion added','ok'); render();
    setTimeout(function(){var el=document.getElementById('desc-new');if(el)el.focus();},50);
  },
  delDesc:function(i){
    ST.descPresets.splice(i,1);
    save(); toast('Removed','warn'); render();
  },
  moveDesc:function(i,dir){
    var arr=ST.descPresets;
    var ni=i+dir;
    if(ni<0||ni>=arr.length) return;
    var tmp=arr[i]; arr[i]=arr[ni]; arr[ni]=tmp;
    save(); render();
  },
  editDescPreset:function(i){
    var cur=ST.descPresets[i];
    var nv=prompt('Edit description suggestion:', cur);
    if(nv===null) return;
    nv=nv.trim();
    if(!nv){ toast('Cannot be empty','warn'); return; }
    ST.descPresets[i]=nv;
    save(); toast('Updated','ok'); render();
  },

  // == Mail Presets ==
  openMailPreset:function(idx){
    if(idx!=null){
      var mp=ST.mailPresets[idx];
      ST.mpf=Object.assign({},mp,{editIdx:idx});
    } else {
      ST.mpf={editIdx:null,name:'',purpose:'general',priority:'normal',to:'',cc:'',bcc:'',replyTo:'',subject:'',body:'',signature:''};
    }
    ST.modal='mailpreset'; render();
  },
  editMailPreset:function(idx){ A.openMailPreset(idx); },
  closeMailPreset:function(){
    ST.modal='settings'; ST.settingsTab='email'; render();
  },
  saveMailPreset:function(){
    var name=(document.getElementById('mp-name')||{}).value||'';
    var purpose=(document.getElementById('mp-purpose')||{}).value||'general';
    var priority=(document.getElementById('mp-priority')||{}).value||'normal';
    var to=(document.getElementById('mp-to')||{}).value||'';
    var cc=(document.getElementById('mp-cc')||{}).value||'';
    var bcc=(document.getElementById('mp-bcc')||{}).value||'';
    var replyTo=(document.getElementById('mp-replyto')||{}).value||'';
    var subj=(document.getElementById('mp-subj')||{}).value||'';
    var body=(document.getElementById('mp-body')||{}).value||'';
    var signature=(document.getElementById('mp-sig')||{}).value||'';
    name=name.trim();
    if(!name){ toast('Preset name required','warn'); return; }
    var mp={
      id:ST.mpf.editIdx!=null?ST.mailPresets[ST.mpf.editIdx].id:uid(),
      name:name,purpose:purpose,priority:priority,
      to:to.trim(),cc:cc.trim(),bcc:bcc.trim(),replyTo:replyTo.trim(),
      subject:subj.trim(),body:body.trim(),signature:signature.trim()
    };
    if(ST.mpf.editIdx!=null){
      ST.mailPresets[ST.mpf.editIdx]=mp;
    } else {
      ST.mailPresets.push(mp);
    }
    ST.mpf={};
    save(); toast('Email preset saved','ok');
    ST.modal='settings'; ST.settingsTab='email'; render();
  },
  delMailPreset:function(i){
    if(!confirm('Delete this email preset?')) return;
    ST.mailPresets.splice(i,1);
    save(); toast('Preset deleted','warn'); render();
  },
  dupMailPreset:function(i){
    var mp=ST.mailPresets[i];
    if(!mp) return;
    var copy=Object.assign({},mp,{id:uid(),name:'Copy of '+mp.name});
    ST.mailPresets.push(copy);
    save(); toast('Preset duplicated','ok'); render();
  },
  openMailSend:function(){
    ST.mailCompose={purpose:'general',toEmail:'',clientName:'',invId:null,invNum:null,invAmount:null,entriesCount:null};
    ST.modal='mailcompose'; render();
  },
  sendMailPreset:function(i){
    var mp=ST.mailPresets[i];
    if(!mp) return;
    var fname=exportFilename();
    var now=new Date();
    var dateStr=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
    var due=new Date(now); due.setDate(due.getDate()+30);
    var dueStr=due.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
    var userName=(ST.user&&ST.user.name)||'';
    var userIni=(ST.user&&ST.user.initials)||'';
    var firmName=ST.prefs.firmName||(ST.firmProfile&&ST.firmProfile.firmName)||'';
    function replacePlaceholders(s){
      return (s||'')
        .replace(/\{filename\}/g, fname)
        .replace(/\{date\}/g, dateStr)
        .replace(/\{due_date\}/g, dueStr)
        .replace(/\{client\}/g, '')
        .replace(/\{matter\}/g, '')
        .replace(/\{firm\}/g, firmName)
        .replace(/\{invoice_num\}/g, '')
        .replace(/\{amount\}/g, '')
        .replace(/\{entries_count\}/g, '')
        .replace(/\{hours_total\}/g, '')
        .replace(/\{user\}/g, userName)
        .replace(/\{initials\}/g, userIni)
        .replace(/\{cc_list\}/g, mp.cc||'');
    }
    var fullBody=(mp.body||'')+(mp.signature?'\n\n'+(mp.signature):'');
    var to=encodeURIComponent(mp.to||'');
    var subj=encodeURIComponent(replacePlaceholders(mp.subject||''));
    var body=encodeURIComponent(replacePlaceholders(fullBody));
    var mailto='mailto:'+to+'?subject='+subj+'&body='+body;
    if(mp.cc) mailto+='&cc='+encodeURIComponent(mp.cc);
    if(mp.bcc) mailto+='&bcc='+encodeURIComponent(mp.bcc);
    A.exportCSV();
    setTimeout(function(){ window.location.href=mailto; }, 500);
  },

  // Open contextual email compose for an invoice (called from invoice list, print preview, client card)
  emailInvoice:function(invId){
    var inv=ST.invoices.find(function(i){return i.id==invId;});
    if(!inv){ toast('Invoice not found','warn'); return; }
    var cl=ST.clients.find(function(c){return c.id==inv.clientId;})||{};
    var total=0;
    (inv.entryIds||[]).forEach(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;})||{};
      var h=(inv.cuts&&inv.cuts[eid]!=null)?Number(inv.cuts[eid]):Number(e.hours||0);
      total+=h*Number(e.rate||0);
    });
    (inv.mergedEntries||[]).forEach(function(mg){
      total+=Number(mg.hours||0)*Number(mg.rate||0);
    });
    ST.mailCompose={
      purpose:'invoice_client',
      toEmail:cl.email||'',
      clientName:cl.name||'',
      invId:invId,
      invNum:String(inv.number||inv.id),
      invAmount:$m(total),
      entriesCount:null,
      hoursTotal:null
    };
    ST.modal='mailcompose'; render();
  },

  // Open contextual email compose for timesheet entries
  // purpose: 'billing_staff' | 'partner_approval'
  emailEntries:function(purpose){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    if(!fe.length){ toast('No entries to email','warn'); return; }
    var pending=fe.filter(function(e){return (e.status||'approved')==='pending';});
    var target=(purpose==='partner_approval'&&pending.length>0)?pending:fe;
    var toEmail='';
    if(purpose==='billing_staff'){
      var bsCt=ST.contacts.find(function(c){
        return c.email&&c.role&&c.role.toLowerCase().indexOf('billing')!==-1;
      });
      if(bsCt) toEmail=bsCt.email;
    } else if(purpose==='partner_approval'){
      var pCt=ST.contacts.find(function(c){
        return c.email&&c.role&&(c.role.toLowerCase().indexOf('partner')!==-1||c.role.toLowerCase().indexOf('supervising')!==-1);
      });
      if(pCt) toEmail=pCt.email;
    }
    var hrs=target.reduce(function(s,e){return s+Number(e.hours||0);},0);
    var clName=ST.tsClientFilter?(ST.clients.find(function(c){return c.id==ST.tsClientFilter;})||{}).name||'All Clients':'All Clients';
    ST.mailCompose={
      purpose:purpose,
      toEmail:toEmail,
      clientName:clName,
      invId:null,
      invNum:null,
      invAmount:null,
      entriesCount:target.length,
      hoursTotal:hrs.toFixed(1)
    };
    ST.modal='mailcompose'; render();
  },

  // Send from the contextual compose modal using a chosen preset
  sendFromCompose:function(i){
    var mp=ST.mailPresets[i];
    if(!mp){ toast('Preset not found','warn'); return; }
    var ctx=ST.mailCompose||{};
    var fname=exportFilename();
    var now=new Date();
    var dateStr=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
    var due=new Date(now); due.setDate(due.getDate()+30);
    var dueStr=due.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
    var userName=(ST.user&&ST.user.name)||'';
    var userIni=(ST.user&&ST.user.initials)||'';
    var firmName=ST.prefs.firmName||(ST.firmProfile&&ST.firmProfile.firmName)||'';
    function replacePlaceholders(s){
      return (s||'')
        .replace(/\{filename\}/g, fname)
        .replace(/\{date\}/g, dateStr)
        .replace(/\{due_date\}/g, dueStr)
        .replace(/\{client\}/g, ctx.clientName||'')
        .replace(/\{matter\}/g, ctx.matterName||'')
        .replace(/\{firm\}/g, firmName)
        .replace(/\{invoice_num\}/g, ctx.invNum||'')
        .replace(/\{amount\}/g, ctx.invAmount||'')
        .replace(/\{entries_count\}/g, ctx.entriesCount!=null?String(ctx.entriesCount):'')
        .replace(/\{hours_total\}/g, ctx.hoursTotal||'')
        .replace(/\{user\}/g, userName)
        .replace(/\{initials\}/g, userIni)
        .replace(/\{cc_list\}/g, mp.cc||'');
    }
    var fullBody=(mp.body||'')+(mp.signature?'\n\n'+(mp.signature):'');
    var toRaw=(mp.to&&mp.to.trim().length)?mp.to:(ctx.toEmail||'');
    var mailto='mailto:'+encodeURIComponent(toRaw)
      +'?subject='+encodeURIComponent(replacePlaceholders(mp.subject||''))
      +'&body='+encodeURIComponent(replacePlaceholders(fullBody));
    if(mp.cc) mailto+='&cc='+encodeURIComponent(mp.cc);
    if(mp.bcc) mailto+='&bcc='+encodeURIComponent(mp.bcc);
    if(mp.replyTo) mailto+='&reply-to='+encodeURIComponent(mp.replyTo);
    if(ctx.purpose==='billing_staff'||ctx.purpose==='partner_approval'){
      A.exportCSV();
    }
    A.closeM();
    setTimeout(function(){ window.location.href=mailto; }, 400);
  },



  // Live phone formatting - called oninput, doesn't cause re-render
  livePhone:function(id){
    var el=document.getElementById(id);
    if(!el) return;
    var pos=el.selectionStart;
    var raw=el.value;
    var fmt=fmtPhone(raw);
    el.value=fmt;
    // Adjust cursor: if we added chars before cursor, push it forward
    var diff=fmt.length-raw.length;
    try{el.setSelectionRange(pos+diff,pos+diff);}catch(e){}
  },

  // User
  saveUser:function(){
    var n=(document.getElementById('up-n')||{}).value||'';
    n=n.trim();
    if(!n) return;
    var raw=(document.getElementById('up-i')||{}).value||'';
    var ini=raw.trim()||n.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
    var pct=document.getElementById('up-pct');
    var ownPct=pct?Number(pct.value):100;
    if(isNaN(ownPct)||ownPct<0) ownPct=0;
    if(ownPct>100) ownPct=100;
    var roleEl=document.getElementById('up-role');
    var role=roleEl?roleEl.value:'attorney';
    var rateEl=document.getElementById('up-rate');
    var rate=rateEl?fmtCur(rateEl.value||''):'';
    var salEl=document.getElementById('up-sal');
    var salary=salEl&&salEl.value?fmtCur(salEl.value||''):'';
    var emailEl=document.getElementById('up-e');
    var email=emailEl?emailEl.value.trim():'';
    var phoneEl=document.getElementById('up-p');
    var phone=phoneEl?phoneEl.value.trim():'';
    ST.user={name:n,initials:ini,ownPct:ownPct,role:role,rate:rate?Number(rate):'',salary:salary?Number(salary):'',email:email,phone:phone};
    Store.setMeta('user',ST.user);
    // Sync user into contacts so they appear in Team Member dropdown & Contacts tab
    var existingUserCt=ST.contacts.find(function(c){return c.isUser;});
    var userCtId=existingUserCt?existingUserCt.id:uid();
    var userCt={id:userCtId,name:n,role:role||'',email:email,phone:phone,rate:rate?Number(rate):'',ownPct:ownPct,salary:salary?Number(salary):'',isUser:true,createdBy:n,createdByIni:ini};
    if(existingUserCt){ST.contacts=ST.contacts.map(function(c){return c.isUser?userCt:c;});}
    else{ST.contacts=ST.contacts.concat([userCt]);}
    save();
    var wasFirstRun=ST._splashMode;
    ST._splashMode=false;
    ST.modal=null;
    render();
    toast(wasFirstRun?'Welcome, '+n+'! \ud83c\udf89':'Profile updated');
  },
  chgUser:function(){ST._splashMode=false;ST.modal='up';render();},
  upSelRole:function(role){
    var el=document.getElementById('up-role');
    if(el) el.value=role;
    // Re-render just the role cards to reflect selection without losing typed name/rate
    document.querySelectorAll('.splash-role').forEach(function(el){
      var v=el.getAttribute('onclick')||'';
      el.classList.toggle('sel',v.indexOf("'"+role+"'")!==-1);
    });
  },

  setUserPct:function(v){
    var pct=Number(v);
    if(isNaN(pct)) return;
    pct=Math.max(0,Math.min(100,pct));
    if(!ST.user) ST.user={name:'',initials:'?',ownPct:pct};
    else ST.user.ownPct=pct;
    Store.setMeta('user',ST.user);
    // Re-render only analytics section without full re-render (no flicker)
    var an=document.querySelector('.main');
    if(an&&ST.tab==='analytics') an.innerHTML=vAnalytics();
  },

  // Entry form
  openEF:function(){
    if(isBilling()){toast('View-only mode: cannot add entries','warn');return;}
    ST.ef={date:today(),clientId:'',matterId:'',contactId:'',hours:'',rate:'',description:'',errs:{}};
    ST.modal='ef'; render();
    var el=document.getElementById('ef'); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
  },
  editEnt:function(id){
    var e=ST.entries.find(function(x){return x.id==id;}); if(!e) return;
    if(isBilling()){toast('View-only mode: cannot edit entries','warn');return;}
    var me=ST.user?ST.user.name:'';
    var entSt=e.status||'approved';
    if(myRole()==='attorney'&&(e.createdBy!==me||entSt!=='pending')){toast(entSt==='approved'?'Cannot edit approved entries':'Cannot edit rejected entries','warn');return;}
    ST.editId=id; ST.ef=Object.assign({},e,{errs:{}}); ST.modal='ef';
    render(); var el=document.getElementById('ef'); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
  },
  saveEnt:function(){
    // Sync all typed values first
    var f=ST.ef;
    f.date=g('ef-d'); f.clientId=g('ef-cl'); f.matterId=g('ef-ma'); f.contactId=g('ef-ct');
    f.hours=g('ef-h'); f.rate=fmtCur(g('ef-r')||''); f.description=g('ef-desc');
    var errs={};
    if(!f.date) errs.d='Required';
    if(!f.clientId) errs.cl='Select a client';
    if(!f.hours||isNaN(Number(f.hours))||Number(f.hours)<=0) errs.h='Enter hours';
    if(!f.rate||Number(f.rate)<=0) errs.r='Enter rate';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    // Keep precise hours (finalize feature will round when grouping)
    var hrs=Number(f.hours);
    var entRole=myRole();
    var existingEntry=ST.editId?ST.entries.find(function(e){return e.id==ST.editId;}):null;
    // Preserve status when editing; set initial status based on role for new entries
    var entStatus=existingEntry?existingEntry.status:(entRole==='partner'?'approved':'pending');
    var entry={id:ST.editId||uid(),date:f.date,
      clientId:Number(f.clientId),matterId:Number(f.matterId)||'',contactId:Number(f.contactId)||'',
      hours:hrs,rate:Number(f.rate),description:f.description||'',
      createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?',
      status:entStatus,finalized:existingEntry?existingEntry.finalized:false};
    if(ST.editId){ST.entries=ST.entries.map(function(e){return e.id==ST.editId?entry:e;});toast('Entry updated');}
    else{ST.entries=ST.entries.concat([entry]);toast(entRole==='attorney'?'Entry submitted for approval':'Entry added');}
    save(); A.closeF();
  },
  delEnt:function(id){if(!confirm('Delete this time entry?'))return;ST.entries=ST.entries.filter(function(e){return e.id!=id;});save();toast('Deleted','warn');render();},

  // Finalize entries - groups identical entries for each day with total rounded hours
  finalizeEntries:function(){
    if(isBilling()){toast('View-only mode: cannot finalize entries','warn');return;}
    var unfinalized=ST.entries.filter(function(e){return !e.finalized;});
    if(unfinalized.length===0){toast('No entries to finalize','warn');return;}
    if(!confirm('Finalize entries? This will group identical entries by day (same client, matter, and description) with rounded total hours. Finalized entries cannot be unfinalized.'))return;
    
    // Group ONLY by: date + client + matter + description
    // This means entries with same work but different hours, rates, contacts, etc. will be grouped
    var groups={};
    unfinalized.forEach(function(e){
      var key=[e.date,e.clientId,e.matterId||'',e.description||''].join('|');
      if(!groups[key])groups[key]=[];
      groups[key].push(e);
    });
    
    // For each group, combine entries
    var finalized=0;
    var newEntries=[];
    Object.keys(groups).forEach(function(key){
      var group=groups[key];
      if(group.length===1){
        // Single entry - just mark as finalized and round hours
        var e=group[0];
        e.hours=Math.round(Number(e.hours)*10)/10;
        e.finalized=true;
        newEntries.push(e);
        finalized++;
      } else {
        // Multiple entries - combine into one
        // Use first entry as template, sum hours, take average rate if rates differ
        var first=group[0];
        var totalHours=group.reduce(function(sum,e){return sum+Number(e.hours);},0);
        var roundedHours=Math.round(totalHours*10)/10;
        
        // Use the most common rate, or first rate if all different
        var rates=group.map(function(e){return e.rate;});
        var rate=rates[0];
        
        var combined=Object.assign({},first,{
          hours:roundedHours,
          rate:Number(rate),
          finalized:true,
          combinedFrom:group.map(function(e){return e.id;})
        });
        newEntries.push(combined);
        finalized+=group.length;
      }
    });
    
    // Keep all already-finalized entries
    var alreadyFinalized=ST.entries.filter(function(e){return e.finalized;});
    ST.entries=alreadyFinalized.concat(newEntries);
    
    save(); 
    toast('Finalized '+finalized+' entr'+(finalized===1?'y':'ies')+' into '+newEntries.length+' final entr'+(newEntries.length===1?'y':'ies'));
    render();
  },

  // Approval actions (partner only)
  approveEnt:function(id){
    if(!isPartner()){toast('Only partners can approve entries','warn');return;}
    ST.entries=ST.entries.map(function(e){
      return e.id==id?Object.assign({},e,{status:'approved',approvedBy:ST.user?ST.user.name:'',approvedAt:today()}):e;
    });
    save(); toast('Entry approved'); render();
  },
  rejectEnt:function(id){
    if(!isPartner()){toast('Only partners can reject entries','warn');return;}
    if(!confirm('Reject this entry? The attorney will be notified via status.')) return;
    ST.entries=ST.entries.map(function(e){
      return e.id==id?Object.assign({},e,{status:'rejected',approvedBy:ST.user?ST.user.name:'',approvedAt:today()}):e;
    });
    save(); toast('Entry rejected','warn'); render();
  },

  // Partner Review Entry: open modal with edit + comment fields
  openPartnerReview:function(id){
    if(!isPartner()){toast('Only partners can review entries','warn');return;}
    var e=ST.entries.find(function(x){return x.id==id;});
    if(!e){toast('Entry not found','err');return;}
    ST.pref={
      entryId:id,
      hours:String(e.hours),
      rate:String(e.rate||''),
      description:e.description||'',
      comment:e.partnerComment||'',
      showOnInvoice:!!e.showCommentOnInvoice,
      errs:{}
    };
    ST.modal='pref'; render();
  },

  // Sync live changes from partner review form inputs
  syncPartnerReview:function(){
    var f=ST.pref;
    var h=document.getElementById('pref-h'); if(h)f.hours=h.value;
    var r=document.getElementById('pref-r'); if(r)f.rate=r.value;
    var d=document.getElementById('pref-desc'); if(d)f.description=d.value;
    var c=document.getElementById('pref-cmt'); if(c)f.comment=c.value;
    var inv=document.getElementById('pref-inv'); if(inv)f.showOnInvoice=inv.checked;
  },

  partnerReviewSave:function(andApprove){
    if(!isPartner()){toast('Only partners can review entries','warn');return;}
    A.syncPartnerReview();
    var f=ST.pref;
    var e=ST.entries.find(function(x){return x.id==f.entryId;});
    if(!e) return;
    var newH=Math.round(parseFloat(f.hours)*10)/10;
    if(isNaN(newH)||newH<=0){toast('Hours must be a positive number','err');return;}
    var newR=parseFloat(f.rate);
    if(isNaN(newR)||newR<0){toast('Rate must be a valid number','err');return;}
    var origH=Number(e.hours);
    var origR=Number(e.rate||0);
    var origD=e.description||'';
    var hoursEdited=(newH!==origH);
    var anyEdited=hoursEdited||(newR!==origR)||((f.description||'')!==origD);
    // Preserve the original submitted hours for invoice display (strikethrough)
    // Use existing submittedHours if already set (so we always track the attorney's original)
    var submittedHours=e.submittedHours!=null?e.submittedHours:(hoursEdited?origH:null);
    var updates={
      hours:String(newH),
      rate:String(newR),
      description:f.description||e.description,
      partnerComment:f.comment||'',
      showCommentOnInvoice:!!f.showOnInvoice,
      partnerEdited:anyEdited,
      submittedHours:submittedHours,
      approvedBy:ST.user?ST.user.name:''
    };
    if(andApprove) Object.assign(updates,{status:'approved',approvedAt:today()});
    ST.entries=ST.entries.map(function(x){return x.id==f.entryId?Object.assign({},x,updates):x;});
    // Keep inv.cuts in sync: any invoice containing this entry must reflect the
    // partner-edited hours, otherwise cuts[eid] would silently override e.hours.
    if(hoursEdited){
      ST.invoices=(ST.invoices||[]).map(function(inv){
        if(!(inv.entryIds||[]).some(function(id){return id==f.entryId;})) return inv;
        var cuts=Object.assign({},inv.cuts||{});
        cuts[f.entryId]=newH;
        return Object.assign({},inv,{cuts:cuts});
      });
    }
    save();
    toast(andApprove?(anyEdited?'Approved with edits':'Entry approved'):'Changes saved',(andApprove?'ok':'ok'));
    A.closeM();
    render();
  },

  partnerReviewReject:function(){
    if(!isPartner()){toast('Only partners can reject entries','warn');return;}
    A.syncPartnerReview();
    var f=ST.pref;
    if(!confirm('Reject this entry? The attorney will see the rejection and any comments you left.')) return;
    var updates={
      status:'rejected',
      approvedBy:ST.user?ST.user.name:'',
      approvedAt:today(),
      partnerComment:f.comment||'',
      showCommentOnInvoice:!!f.showOnInvoice,
      partnerEdited:false
    };
    // Also apply any hour/rate/desc edits even on reject (for tracking)
    var newH=Math.round(parseFloat(f.hours)*10)/10;
    var newR=parseFloat(f.rate);
    if(!isNaN(newH)&&newH>0) updates.hours=String(newH);
    if(!isNaN(newR)&&newR>=0) updates.rate=String(newR);
    if(f.description) updates.description=f.description;
    ST.entries=ST.entries.map(function(x){return x.id==f.entryId?Object.assign({},x,updates):x;});
    save(); toast('Entry rejected','warn'); A.closeM(); render();
  },
  approveAll:function(){
    if(!isPartner()){toast('Only partners can approve entries','warn');return;}
    var pending=ST.entries.filter(function(e){return (e.status||'approved')==='pending';});
    if(!pending.length){toast('No pending entries to approve','warn');return;}
    if(!confirm('Approve all '+pending.length+' pending entries?')) return;
    var now=today();
    var approver=ST.user?ST.user.name:'';
    ST.entries=ST.entries.map(function(e){
      return (e.status||'approved')==='pending'?Object.assign({},e,{status:'approved',approvedBy:approver,approvedAt:now}):e;
    });
    save(); toast('Approved '+pending.length+' entr'+(pending.length===1?'y':'ies')); render();
  },


  // Client form
  openCF:function(){ST.editId=null;ST.cf={name:'',email:'',phone:'',rate:'',contactIds:[],clientPeople:[],newPerson:{},errs:{}};ST.modal='cf';render();},
  editCl:function(id){var c=ST.clients.find(function(x){return x.id==id;});if(!c)return;ST.editId=id;
    // Migrate legacy contactId to contactIds array
    var cids=c.contactIds&&c.contactIds.length?c.contactIds:(c.contactId?[Number(c.contactId)]:[]);
    ST.cf=Object.assign({},c,{contactIds:cids,clientPeople:c.clientPeople||[],newPerson:{},errs:{}});ST.modal='cf';render();},
  cfTogCt:function(cb){
    var id=Number(cb.getAttribute('data-cf-ct'));
    var ids=ST.cf.contactIds||[];
    if(cb.checked){if(!ids.some(function(x){return x==id;}))ST.cf.contactIds=ids.concat([id]);}
    else{ST.cf.contactIds=ids.filter(function(x){return x!=id;});}
  },
  cfRemCt:function(id){
    syncForm();
    ST.cf.contactIds=(ST.cf.contactIds||[]).filter(function(x){return x!=id;});
    render();
  },
  cfAddPerson:function(){
    syncForm();
    var n=(document.getElementById('cf-pn')||{}).value||'';
    n=n.trim();
    if(!n){toast('Enter a name','err');return;}
    var ro=(document.getElementById('cf-pro')||{}).value||'';
    var em=(document.getElementById('cf-pe')||{}).value||'';
    var ph=(document.getElementById('cf-pp')||{}).value||'';
    ST.cf.clientPeople=(ST.cf.clientPeople||[]).concat([{id:uid(),name:n,role:ro.trim(),email:em.trim(),phone:ph.trim()}]);
    ST.cf.newPerson={};
    render();
    var el=document.getElementById('cf-pn'); if(el){el.focus();}
  },
  cfRemPerson:function(i){
    syncForm();
    ST.cf.clientPeople=(ST.cf.clientPeople||[]).filter(function(_,idx){return idx!==i;});
    render();
  },
  saveCl:function(){
    var f=ST.cf;
    f.name=g('cf-n'); f.email=g('cf-e'); f.phone=g('cf-p'); f.rate=fmtCur(g('cf-r')||'');
    // Sync new-person draft fields
    var pn=g('cf-pn')||''; if(pn.trim())f.newPerson={name:pn,role:g('cf-pro')||'',email:g('cf-pe')||'',phone:g('cf-pp')||''};
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(f.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email)) errs.e='Invalid email';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var c={id:ST.editId||uid(),name:f.name.trim(),email:f.email||'',phone:f.phone||'',rate:f.rate?Number(f.rate):'',contactIds:f.contactIds||[],clientPeople:(f.clientPeople||[]).map(function(p){return p.id?p:Object.assign({id:uid()},p);}),createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    if(ST.editId){ST.clients=ST.clients.map(function(x){return x.id==ST.editId?c:x;});toast('Client updated');}
    else{ST.clients=ST.clients.concat([c]);toast('Client added');}
    save(); A.closeF();
  },
  delCl:function(id){if(!confirm('Delete this client?'))return;ST.clients=ST.clients.filter(function(c){return c.id!=id;});save();toast('Deleted','warn');render();},

  // Matter form
  openMF:function(){ST.editId=null;ST.mf={name:'',clientId:'',description:'',rate:'',contactId:'',linkedClientPeopleIds:[],errs:{}};ST.modal='mf';render();},
  editMa:function(id){var m=ST.matters.find(function(x){return x.id==id;});if(!m)return;ST.editId=id;ST.mf=Object.assign({},m,{linkedClientPeopleIds:m.linkedClientPeopleIds||[],errs:{}});ST.modal='mf';render();},
  saveMa:function(){
    var f=ST.mf;
    f.name=g('mf-n'); f.clientId=g('mf-cl'); f.description=g('mf-desc'); f.rate=fmtCur(g('mf-r')||''); f.contactId=g('mf-ct');
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(!f.clientId) errs.cl='Select a client';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var m={id:ST.editId||uid(),name:f.name.trim(),clientId:Number(f.clientId),description:f.description||'',rate:f.rate?Number(f.rate):'',contactId:Number(f.contactId)||'',linkedClientPeopleIds:f.linkedClientPeopleIds||[],createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    if(ST.editId){ST.matters=ST.matters.map(function(x){return x.id==ST.editId?m:x;});toast('Matter updated');}
    else{ST.matters=ST.matters.concat([m]);toast('Matter added');}
    save(); A.closeF();
  },
  delMa:function(id){if(!confirm('Delete this matter?'))return;ST.matters=ST.matters.filter(function(m){return m.id!=id;});save();toast('Deleted','warn');render();},
  mfToggleClientPerson:function(personId){
    syncForm();
    var ids=ST.mf.linkedClientPeopleIds||[];
    var pid=Number(personId);
    if(ids.some(function(x){return x==pid;})){ST.mf.linkedClientPeopleIds=ids.filter(function(x){return x!=pid;});}
    else{ST.mf.linkedClientPeopleIds=ids.concat([pid]);}
    render();
  },

  // Contact form
  openCTF:function(){ST.editId=null;ST.ctf={name:'',role:'',email:'',phone:'',rate:'',ownPct:100,salary:'',errs:{}};ST.modal='ctf';render();},
  editCt:function(id){var c=ST.contacts.find(function(x){return x.id==id;});if(!c)return;if(c.isUser){ST._splashMode=false;ST.modal='up';render();return;}ST.editId=id;ST.ctf=Object.assign({},c,{errs:{}});ST.modal='ctf';render();},
  saveCt:function(){
    var f=ST.ctf;
    f.name=g('ctf-n'); f.role=g('ctf-ro'); f.email=g('ctf-e'); f.phone=g('ctf-p'); f.rate=fmtCur(g('ctf-rate')||'');
    var opv=g('ctf-op'); f.ownPct=opv!==''?Math.min(100,Math.max(0,Number(opv))):100;
    var salv=g('ctf-sal'); f.salary=salv&&salv!==''?fmtCur(salv):'';
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(f.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email)) errs.e='Invalid email';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var existing=ST.editId?ST.contacts.find(function(x){return x.id==ST.editId;}):null;
    var c={id:ST.editId||uid(),name:f.name.trim(),role:f.role||'',email:f.email||'',phone:f.phone||'',rate:f.rate?Number(f.rate):'',ownPct:f.ownPct,salary:f.salary?Number(f.salary):'',createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    // Preserve isUser flag if this contact is the logged-in user
    if(existing&&existing.isUser) c.isUser=true;
    if(ST.editId){ST.contacts=ST.contacts.map(function(x){return x.id==ST.editId?c:x;});toast('Contact updated');}
    else{ST.contacts=ST.contacts.concat([c]);toast('Contact added');}
    // If this is the user's own contact, keep ST.user in sync
    if(c.isUser&&ST.user){
      var oldIni=ST.user.initials||'';
      // Auto-regen initials if name changed and initials were auto-generated (matching old name pattern)
      var autoIni=ST.user.name?ST.user.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase():'';
      var newAutoIni=c.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
      var ini2=(oldIni===autoIni)?newAutoIni:oldIni;
      ST.user=Object.assign({},ST.user,{name:c.name,role:c.role,email:c.email,phone:c.phone,rate:c.rate,ownPct:c.ownPct,salary:c.salary,initials:ini2});
      Store.setMeta('user',ST.user);
    }
    save(); A.closeF();
  },
  delCt:function(id){if(!confirm('Delete this contact?'))return;ST.contacts=ST.contacts.filter(function(c){return c.id!=id;});save();toast('Deleted','warn');render();},

  // Quick Log
  openQL:function(){if(isBilling()){toast('View-only mode: cannot log entries','warn');return;}ST.modal='ql';ST.ql={clientId:'',matterId:'',hours:'',rate:'',description:'',addToId:'',rawMs:null};render();},
  closeQL:function(){stopTmr();ST.modal=null;render();},
  qlSet:function(k,v){ST.ql[k]=v;},
  qlCl:function(v){
    syncForm();
    ST.ql.clientId=v; ST.ql.matterId='';
    var r=autoRate(v,'','');
    if(r&&!ST.ql.rate) ST.ql.rate=String(r);
    render();
  },
  qlPickEntry:function(id){
    syncForm();
    var id2=String(id);
    if(!id2){
      ST.ql.addToId='';
      render();
      return;
    }
    var e=ST.entries.find(function(x){return String(x.id)===id2;});
    if(!e) return;
    ST.ql.addToId=id2;
    ST.ql.clientId=String(e.clientId||'');
    ST.ql.matterId=String(e.matterId||'');
    ST.ql.rate=String(e.rate||'');
    ST.ql.description=e.description||'';
    render();
  },
  saveQL:function(){
    syncForm();
    var f=ST.ql;
    if(!f.clientId||!f.hours||!f.rate){toast('Fill in client, hours and rate','err');return;}
    stopTmr();
    var hrs=Number(f.hours);
    var qlRole=myRole();
    var qlStatus=qlRole==='partner'?'approved':'pending';
    // === ADD TO EXISTING ENTRY ===
    if(f.addToId){
      var target=ST.entries.find(function(x){return String(x.id)===String(f.addToId);});
      if(target){
        var newHrs=Math.round((Number(target.hours)+hrs)*10000)/10000;
        var newRawMs=(target.rawMs!=null&&f.rawMs!=null)?(target.rawMs+f.rawMs):null;
        ST.entries=ST.entries.map(function(x){
          if(String(x.id)===String(f.addToId)){
            return Object.assign({},x,{hours:newHrs,rawMs:newRawMs});
          }
          return x;
        });
        save(); ST.modal=null; ST.tab='timesheet';
        toast('+'+hrs.toFixed(1)+'h added \u2192 '+newHrs.toFixed(1)+'h total &#9889;');
        render();
        return;
      }
    }
    // === NEW ENTRY ===
    var entry={id:uid(),date:today(),clientId:Number(f.clientId),matterId:Number(f.matterId)||'',contactId:'',
      hours:hrs,rawMs:(f.rawMs!=null?f.rawMs:null),rate:Number(f.rate),description:f.description||'',
      createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?',
      status:qlStatus,finalized:false};
    ST.entries=ST.entries.concat([entry]);
    save(); ST.modal=null; ST.tab='timesheet'; toast(qlRole==='attorney'?'Entry submitted for approval &#9889;':'Entry logged! &#9889;'); render();
  },

  // Timer
  togTmr:function(){
    if(ST.tmrOn){
      stopTmr();
      var hrs=ST.tmrMs/3600000;
      // Preserve full precision in hours field; no forced minimum — user can review and adjust
      ST.ql.hours=String(Math.round(hrs*10000)/10000);
      ST.ql.rawMs=ST.tmrMs; // carry exact ms to save
    } else {
      ST.tmrStart=Date.now();
      ST.tmrOn=true;
      ST.tmrIv=setInterval(function(){
        var el=document.getElementById('ql-t'); if(!el){stopTmr();return;}
        var ms=Date.now()-ST.tmrStart+ST.tmrMs;
        el.textContent=String(Math.floor(ms/3600000)).padStart(2,'0')+':'+String(Math.floor((ms%3600000)/60000)).padStart(2,'0')+':'+String(Math.floor((ms%60000)/1000)).padStart(2,'0');
        el.className='timer-num timer-on';
      },500);
    }
    render();
  },
  rstTmr:function(){stopTmr();ST.tmrMs=0;ST.tmrStart=0;ST.ql.hours='';ST.ql.rawMs=null;render();},

  // Help / Settings
  openHelp:function(){ST.modal='help';render();},
  openSettings:function(){ST.modal='settings';render();},
  applyPreset:function(k){
    var p={
      full: {te:true,cl:true,ma:true,co:true,su:true,split:false,tc_date:true,tc_client:true,tc_matter:true,tc_team:true,tc_desc:true,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false},
      billing:{te:true,cl:false,ma:false,co:false,su:true,split:false,tc_date:true,tc_client:true,tc_matter:true,tc_team:false,tc_desc:true,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false},
      dirs: {te:false,cl:true,ma:true,co:true,su:false,split:false},
      sum:  {te:false,cl:false,ma:false,co:false,su:true,split:false},
      wsplit:{te:true,cl:true,ma:false,co:true,su:true,split:true,tc_date:true,tc_client:true,tc_matter:true,tc_team:true,tc_desc:false,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false},
      tsplit:{te:true,cl:false,ma:false,co:false,su:true,split:true,tc_date:true,tc_client:true,tc_matter:false,tc_team:true,tc_desc:false,tc_hours:true,tc_rate:false,tc_amount:true,tc_by:false}
    };
    if(p[k]){
      ST.settings=Object.assign({},ST.settings,p[k]);
      render();
    }
  },
  togExp:function(k,v){
    syncForm();
    ST.settings[k]=v;
    render();
  },
  setExpDate:function(k,v){ST.settings[k]=v;render();},

  // Reset
  resetAll:function(){
    if(!confirm('Delete ALL data? This cannot be undone!\nExport a backup first.')) return;
    if(!confirm('Are you absolutely sure?')) return;
    ST.clients=[]; ST.matters=[]; ST.entries=[]; ST.contacts=[]; ST.invoices=[];
    Store.clearData();
    ST.user=null; ST._splashMode=true; ST.modal='profileImport'; toast('All data reset','warn'); render();
  },


  // ─ Download helper (works without URL.createObjectURL) ─
  _dlData:function(content, fname, mime){
    // Blob+createObjectURL: reliable for large files, no encoding corruption.
    // UTF-8 BOM added for CSV so Excel opens with correct encoding.
    var bom=(mime==='text/csv')?'\uFEFF':'';
    var blob=new Blob([bom+content],{type:mime+';charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download=fname; a.style.display='none';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},2000);
  },

  // Export modal
  openExportModal:function(){ ST.modal='exportModal'; render(); },
  downloadApp:function(){
    var html='<!DOCTYPE html>\n'+document.documentElement.outerHTML;
    var blob=new Blob([html],{type:'text/html;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download='SixMinuteLog_'+today().replace(/-/g,'')+'.html';
    document.body.appendChild(a);a.click();
    document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},2000);
    toast('App downloaded \u2014 open the file in any browser to use offline','ok');
  },

  // Export
  exportCSV:function(){
    var s=ST.settings;
    var Q=function(v){return '"'+String(v||'').replace(/"/g,'""')+'"';};
    var R=function(a){return a.map(Q).join(',')+'\n';};
    var csv='';

    // Filter entries by date range if set
    var ents=ST.entries;
    if(s.expFrom) ents=ents.filter(function(e){return e.date>=s.expFrom;});
    if(s.expTo)   ents=ents.filter(function(e){return e.date<=s.expTo;});

    if(s.te&&ents.length){
      // Build column list
      var cols=[];
      if(s.tc_date)   cols.push('Date');
      if(s.tc_client) cols.push('Client');
      if(s.tc_matter) cols.push('Matter');
      if(s.tc_team)   cols.push('Team Member');
      if(s.tc_desc)   cols.push('Description');
      if(s.tc_hours)  cols.push('Hours');
      if(s.tc_rate)   cols.push('Rate');
      if(s.tc_amount) cols.push('Amount');
      if(s.tc_by)     cols.push('Created By');

      if(s.te_group){
        // Group by client
        var clIds=[...new Set(ents.map(function(e){return e.clientId;}))];
        clIds.forEach(function(cid){
          var cl=ST.clients.find(function(c){return c.id==cid;});
          var clName=cl?cl.name:'Unknown';
          csv+='TIME ENTRIES - '+clName+'\n'+R(cols);
          ents.filter(function(e){return e.clientId==cid;})
            .sort(function(a,b){return new Date(a.date)-new Date(b.date);})
            .forEach(function(e){csv+=R(buildEntRow(e,s));});
          csv+='\n';
        });
      } else {
        csv+='TIME ENTRIES\n'+R(cols);
        ents.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date);}).forEach(function(e){csv+=R(buildEntRow(e,s));});
        csv+='\n';
      }
    }
    if(s.cl&&ST.clients.length){
      csv+='CLIENTS\n'+R(['Name','Email','Phone','Default Rate']);
      ST.clients.forEach(function(c){csv+=R([c.name,c.email||'',c.phone||'',c.rate||'']);});
      csv+='\n';
    }
    if(s.ma&&ST.matters.length){
      csv+='MATTERS\n'+R(['Client','Matter Name','Description','Rate']);
      ST.matters.forEach(function(m){var cl=ST.clients.find(function(c){return c.id==m.clientId;});csv+=R([cl?cl.name:'',m.name,m.description||'',m.rate||'Client Default']);});
      csv+='\n';
    }
    if(s.co&&ST.contacts.length){
      csv+='CONTACTS\n'+R(['Name','Role','Email','Phone','Rate','Personal Cut %','Annual Salary']);
      ST.contacts.forEach(function(c){csv+=R([c.name,c.role||'',c.email||'',c.phone||'',c.rate||'',c.ownPct!=null?c.ownPct:100,c.salary!=null&&c.salary!==''?c.salary:'']);});
      csv+='\n';
    }
    if(s.su){
      var hrs=ents.reduce(function(s,e){return s+Number(e.hours);},0);
      var bill=ents.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
      csv+='SUMMARY\n'+R(['Total Hours',hrs.toFixed(2)])+R(['Total Billing','$'+bill.toFixed(2)])+R(['Entries',String(ents.length)])+R(['Clients',String(ST.clients.length)])+R(['Matters',String(ST.matters.length)]);
      if(s.expFrom||s.expTo) csv+=R(['Date Range',(s.expFrom||'beginning')+' to '+(s.expTo||'today')]);
      csv+='\n';
    }
    if(s.split){
      var salPeriodLblCsv=salaryPeriodLabel(ST.anFilter)||'All Time';
      csv+='REVENUE SPLIT\n'+R(['Team Member','Personal Cut %','Hours','Total Billed','Own Portion','Firm Portion','Annual Salary','Salary ('+salPeriodLblCsv+')','Net Income (Own - Period Salary)','Status']);
      var userPct=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
      var userSalExp=ST.user&&ST.user.salary!=null&&ST.user.salary!==''?Number(ST.user.salary):null;
      var splitRows=ST.contacts.map(function(c){
        var ces=ents.filter(function(e){return e.contactId==c.id;});
        var chrs=ces.reduce(function(s,e){return s+Number(e.hours);},0);
        var cbill=ces.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
        var pct=c.ownPct!=null?Number(c.ownPct):100;
        var own=cbill*pct/100;
        var annSal=c.salary!=null&&c.salary!==''?Number(c.salary):null;
        var perSal=salaryForPeriod(annSal,ST.anFilter);
        var net=perSal!=null?own-perSal:null;
        return [c.name,pct,chrs.toFixed(2),'$'+cbill.toFixed(2),'$'+own.toFixed(2),'$'+(cbill*(100-pct)/100).toFixed(2),
          annSal!=null?'$'+annSal.toFixed(2):'',
          perSal!=null?'$'+perSal.toFixed(2):'',
          net!=null?'$'+net.toFixed(2):'',
          net!=null?(net>=0?'Bonus':'Shortfall'):''];
      });
      var uEnts=ents.filter(function(e){return !ST.contacts.find(function(c){return c.id==e.contactId;});});
      if(uEnts.length){
        var uH=uEnts.reduce(function(s,e){return s+Number(e.hours);},0);
        var uB=uEnts.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
        var uOwn=uB*userPct/100;
        var uPerSal=salaryForPeriod(userSalExp,ST.anFilter);
        var uNet=uPerSal!=null?uOwn-uPerSal:null;
        splitRows.push(['(Unassigned)',userPct,uH.toFixed(2),'$'+uB.toFixed(2),'$'+uOwn.toFixed(2),'$'+(uB*(100-userPct)/100).toFixed(2),
          userSalExp!=null?'$'+userSalExp.toFixed(2):'',
          uPerSal!=null?'$'+uPerSal.toFixed(2):'',
          uNet!=null?'$'+uNet.toFixed(2):'',
          uNet!=null?(uNet>=0?'Bonus':'Shortfall'):'']);
      }
      splitRows.forEach(function(r){csv+=R(r);});
      csv+='\n';
    }
    if(!csv){toast('Nothing selected to export','warn');return;}
    var fname=exportFilename();
    A._dlData(csv, fname, 'text/csv');
    toast('Exported: '+(fname.split('_')[1]||'CSV'));
  },

  // ─ Import helpers ─
  openImport:function(){ ST.modal='importData'; render(); },

  // CSV row parser (handles quoted commas and escaped quotes)
  _parseCSVRow:function(line){
    var vals=[],cur='',inQ=false;
    for(var i=0;i<line.length;i++){
      var ch=line[i];
      if(ch==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
      else if(ch===','&&!inQ){vals.push(cur);cur='';}
      else cur+=ch;
    }
    vals.push(cur);
    return vals;
  },

  // ─ Full JSON backup export ─
  exportJSON:function(){
    var backup={
      _version:1,
      _exported:new Date().toISOString(),
      user:ST.user,
      clients:ST.clients,
      matters:ST.matters,
      entries:ST.entries,
      contacts:ST.contacts,
      prefs:ST.prefs,
      settings:ST.settings,
      descPresets:ST.descPresets,
      mailPresets:ST.mailPresets
    };
    var json=JSON.stringify(backup,null,2);
    var now=new Date();
    var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate())+'_'+pad2(now.getHours())+pad2(now.getMinutes());
    var fname='billing-backup_'+stamp+'.json';
    A._dlData(json, fname, 'application/json');
    toast('Full backup downloaded: '+fname);
  },

  // ─ Full JSON backup import ─
  importJSON:function(inp){
    var file=inp.files[0]; if(!file) return;
    if(!confirm('Restore from backup? This will REPLACE all current data with the backup.\n\nExport a backup first if you want to keep your current data.')) { inp.value=''; return; }
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var b=JSON.parse(ev.target.result);
        if(!b||!b._version){ toast('Invalid backup file','err'); return; }
        if(b.clients)  ST.clients=b.clients;
        if(b.matters)  ST.matters=b.matters;
        if(b.entries)  ST.entries=b.entries;
        if(b.contacts) ST.contacts=b.contacts;
        if(b.user)     ST.user=b.user;
        if(b.prefs)    ST.prefs=Object.assign({appName:'SixMinuteLog.com',darkMode:null,layout:'comfortable'},b.prefs);
        if(b.settings) ST.settings=Object.assign({},ST.settings,b.settings);
        if(b.descPresets) ST.descPresets=b.descPresets;
        if(b.mailPresets) ST.mailPresets=b.mailPresets;
        save(); Store.setMeta('user',ST.user);
        applyPrefs();
        toast('Backup restored: '+ST.clients.length+' clients, '+ST.matters.length+' matters, '+ST.entries.length+' entries');
        ST.modal=null; render();
      }catch(e){ toast('Failed to read backup file','err'); console.error(e); }
    };
    reader.readAsText(file); inp.value='';
  },

  // ─ Per-entity CSV export ─
  exportEntityCSV:function(type){
    var Q=function(v){return '"'+String(v||'').replace(/"/g,'""')+'"';};
    var R=function(a){return a.map(Q).join(',')+'\n';};
    var csv='',fname='';
    var now=new Date();
    var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate())+'_'+pad2(now.getHours())+pad2(now.getMinutes());
    if(type==='clients'){
      csv+=R(['Name','Email','Phone','Default Rate']);
      ST.clients.forEach(function(c){csv+=R([c.name,c.email||'',c.phone||'',c.rate||'']);});
      fname='billing-clients_'+stamp+'.csv';
    } else if(type==='matters'){
      csv+=R(['Client Name','Matter Name','Description','Rate']);
      ST.matters.forEach(function(m){
        var cl=ST.clients.find(function(c){return c.id==m.clientId;});
        csv+=R([cl?cl.name:'',m.name,m.description||'',m.rate||'']);
      });
      fname='billing-matters_'+stamp+'.csv';
    } else if(type==='entries'){
      csv+=R(['Date','Client Name','Matter Name','Team Member','Description','Hours','Rate','Status','Created By']);
      ST.entries.forEach(function(e){
        var cl=ST.clients.find(function(c){return c.id==e.clientId;});
        var mt=ST.matters.find(function(m){return m.id==e.matterId;});
        var ct=ST.contacts.find(function(c){return c.id==e.contactId;});
        csv+=R([e.date,cl?cl.name:'',mt?mt.name:'',ct?ct.name:'',e.description||'',e.hours,e.rate,e.status||'approved',e.createdBy||'']);
      });
      fname='billing-entries_'+stamp+'.csv';
    } else if(type==='contacts'){
      csv+=R(['Name','Role','Email','Phone','Rate','Personal Cut %','Annual Salary']);
      ST.contacts.forEach(function(c){csv+=R([c.name,c.role||'',c.email||'',c.phone||'',c.rate||'',c.ownPct!=null?c.ownPct:100,c.salary!=null&&c.salary!==''?c.salary:'']);});
      fname='billing-contacts_'+stamp+'.csv';
    } else if(type==='settings'){
      // Settings exported as simple key-value CSV
      csv+=R(['Setting','Value']);
      csv+=R(['App Name',ST.prefs.appName||'SixMinuteLog.com']);
      csv+=R(['Dark Mode',ST.prefs.darkMode===null?'null':ST.prefs.darkMode?'true':'false']);
      csv+=R(['Layout',ST.prefs.layout||'comfortable']);
      csv+=R(['Description Presets',ST.descPresets.join('|')]);
      fname='billing-settings_'+stamp+'.csv';
    }
    if(!csv){ toast('No data to export','warn'); return; }
    A._dlData(csv, fname, 'text/csv');
    toast('Exported: '+(fname.split('_')[1]||type));
  },

  // ─ Combined CSV import (full multi-section file) ─
  importCSV:function(inp){
    var file=inp.files[0]; if(!file) return;
    var self=A;
    var reader=new FileReader();
    reader.onload=function(ev){
      var lines=ev.target.result.split(/\r?\n/);
      var sec='',nc=[],nm=[],ne=[],nct=[];
      var colMap={};  // track column positions per section
      lines.forEach(function(line){
        var l=line.trim(); if(!l) return;
        if(l.indexOf('TIME ENTRIES')===0){sec='e';colMap={};return;}
        if(l==='CLIENTS'){sec='c';colMap={};return;}
        if(l==='MATTERS'){sec='m';colMap={};return;}
        if(l==='CONTACTS'){sec='ct';colMap={};return;}
        if(l==='SUMMARY'||l==='REVENUE SPLIT'){sec='';return;}
        var v=self._parseCSVRow(l);
        // Header rows - build column map
        if(sec==='e'&&v[0]==='Date'){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(sec==='c'&&v[0]==='Name'){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(sec==='m'&&(v[0]==='Client'||v[0]==='Client Name')){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(sec==='ct'&&v[0]==='Name'){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(!v[0]) return;
        if(sec==='c') nc.push({id:uid(),name:v[0],email:v[1]||'',phone:v[2]||'',rate:v[3]||'',createdBy:'Imported',createdByIni:'?'});
        else if(sec==='ct') nct.push({id:uid(),name:v[0],role:v[1]||'',email:v[2]||'',phone:v[3]||'',rate:v[4]||'',ownPct:v[5]!=null?Number(v[5]):100,salary:v[6]!=null&&v[6]!==''?Number(v[6]):'',createdBy:'Imported',createdByIni:'?'});
        else if(sec==='m'){
          var cName=v[colMap['Client']!=null?colMap['Client']:(colMap['Client Name']!=null?colMap['Client Name']:0)]||'';
          nm.push({_clientName:cName,name:v[colMap['Matter Name']!=null?colMap['Matter Name']:1]||v[1]||'',description:v[colMap['Description']!=null?colMap['Description']:2]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:3]||''});
        }
        else if(sec==='e'){
          var ci=colMap['Client Name']!=null?colMap['Client Name']:(colMap['Client']!=null?colMap['Client']:1);
          var mi=colMap['Matter Name']!=null?colMap['Matter Name']:(colMap['Matter']!=null?colMap['Matter']:2);
          var ti=colMap['Team Member']!=null?colMap['Team Member']:3;
          var di=colMap['Description']!=null?colMap['Description']:4;
          var hi=colMap['Hours']!=null?colMap['Hours']:5;
          var ri=colMap['Rate']!=null?colMap['Rate']:6;
          var sti=colMap['Status']!=null?colMap['Status']:7;
          var bi=colMap['Created By']!=null?colMap['Created By']:8;
          ne.push({id:uid(),date:v[0],_clientName:v[ci]||'',_matterName:v[mi]||'',_contactName:v[ti]||'',description:v[di]||'',hours:v[hi]||'',rate:v[ri]||'',status:v[sti]||'approved',createdBy:v[bi]||'Imported',createdByIni:'?'});
        }
      });
      // Resolve IDs - use newly imported clients if available, fall back to existing
      var allClients=nc.length?nc:ST.clients;
      var allContacts=nct.length?nct:ST.contacts;
      // Assign IDs to matters
      var resolvedMatters=nm.map(function(m){
        var cl=allClients.find(function(c){return c.name.toLowerCase()===m._clientName.toLowerCase();});
        return {id:uid(),name:m.name,clientId:cl?cl.id:'',description:m.description,rate:m.rate,createdBy:'Imported',createdByIni:'?'};
      });
      var allMatters=resolvedMatters.length?resolvedMatters:ST.matters;
      // Assign IDs to entries
      var resolvedEntries=ne.map(function(e){
        var cl=allClients.find(function(c){return c.name.toLowerCase()===e._clientName.toLowerCase();});
        var mt=allMatters.find(function(m){return m.name.toLowerCase()===e._matterName.toLowerCase()&&(!cl||m.clientId==cl.id);});
        var ct=allContacts.find(function(c){return c.name.toLowerCase()===e._contactName.toLowerCase();});
        return {id:e.id,date:e.date,clientId:cl?cl.id:'',matterId:mt?mt.id:'',contactId:ct?ct.id:'',description:e.description,hours:e.hours,rate:e.rate,status:e.status,createdBy:e.createdBy,createdByIni:e.createdByIni};
      });
      // Apply results
      if(nc.length) ST.clients=nc;
      if(resolvedMatters.length) ST.matters=resolvedMatters;
      if(resolvedEntries.length) ST.entries=resolvedEntries;
      if(nct.length) ST.contacts=nct;
      var msg='Imported: '+nc.length+' clients, '+resolvedMatters.length+' matters, '+resolvedEntries.length+' entries, '+nct.length+' contacts';
      save(); toast(msg); ST.modal=null; render();
    };
    reader.readAsText(file); inp.value='';
  },

  // ─ Single-entity CSV import (clients/matters/entries/contacts/settings) ─
  importEntityCSV:function(inp,type){
    var file=inp.files[0]; if(!file) return;
    var self=A;
    var reader=new FileReader();
    reader.onload=function(ev){
      var lines=ev.target.result.split(/\r?\n/);
      var colMap={};
      var parsed=[];
      var isFirst=true;
      lines.forEach(function(line){
        var l=line.trim(); if(!l) return;
        var v=self._parseCSVRow(l);
        if(isFirst){isFirst=false;v.forEach(function(h,i){colMap[h]=i;});return;}
        if(!v[0]) return;
        parsed.push(v);
      });
      if(!parsed.length){ toast('No data rows found in file','warn'); inp.value=''; return; }
      if(type==='clients'){
        var nc=parsed.map(function(v){return {id:uid(),name:v[colMap['Name']!=null?colMap['Name']:0],email:v[colMap['Email']!=null?colMap['Email']:1]||'',phone:v[colMap['Phone']!=null?colMap['Phone']:2]||'',rate:v[colMap['Default Rate']!=null?colMap['Default Rate']:3]||'',createdBy:'Imported',createdByIni:'?'};});
        ST.clients=nc; save(); toast('Imported '+nc.length+' clients'); ST.modal=null; render();
      } else if(type==='matters'){
        var nm=parsed.map(function(v){
          var cName=v[colMap['Client Name']!=null?colMap['Client Name']:(colMap['Client']!=null?colMap['Client']:0)]||'';
          var cl=ST.clients.find(function(c){return c.name.toLowerCase()===cName.toLowerCase();});
          return {id:uid(),name:v[colMap['Matter Name']!=null?colMap['Matter Name']:1]||'',clientId:cl?cl.id:'',description:v[colMap['Description']!=null?colMap['Description']:2]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:3]||'',createdBy:'Imported',createdByIni:'?'};
        }).filter(function(m){return m.name;});
        ST.matters=nm; save(); toast('Imported '+nm.length+' matters'); ST.modal=null; render();
      } else if(type==='entries'){
        var ne=parsed.map(function(v){
          var cName=v[colMap['Client Name']!=null?colMap['Client Name']:(colMap['Client']!=null?colMap['Client']:1)]||'';
          var mName=v[colMap['Matter Name']!=null?colMap['Matter Name']:(colMap['Matter']!=null?colMap['Matter']:2)]||'';
          var tName=v[colMap['Team Member']!=null?colMap['Team Member']:3]||'';
          var cl=ST.clients.find(function(c){return c.name.toLowerCase()===cName.toLowerCase();});
          var mt=ST.matters.find(function(m){return m.name.toLowerCase()===mName.toLowerCase()&&(!cl||m.clientId==cl.id);});
          var ct=ST.contacts.find(function(c){return c.name.toLowerCase()===tName.toLowerCase();});
          return {id:uid(),date:v[0],clientId:cl?cl.id:'',matterId:mt?mt.id:'',contactId:ct?ct.id:'',description:v[colMap['Description']!=null?colMap['Description']:4]||'',hours:v[colMap['Hours']!=null?colMap['Hours']:5]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:6]||'',status:v[colMap['Status']!=null?colMap['Status']:7]||'approved',createdBy:v[colMap['Created By']!=null?colMap['Created By']:8]||'Imported',createdByIni:'?'};
        }).filter(function(e){return e.date;});
        ST.entries=ne; save(); toast('Imported '+ne.length+' entries'); ST.modal=null; render();
      } else if(type==='contacts'){
        var nct=parsed.map(function(v){return {id:uid(),name:v[0],role:v[colMap['Role']!=null?colMap['Role']:1]||'',email:v[colMap['Email']!=null?colMap['Email']:2]||'',phone:v[colMap['Phone']!=null?colMap['Phone']:3]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:4]||'',ownPct:v[colMap['Personal Cut %']!=null?colMap['Personal Cut %']:5]!=null?Number(v[colMap['Personal Cut %']!=null?colMap['Personal Cut %']:5]):100,salary:colMap['Annual Salary']!=null&&v[colMap['Annual Salary']]!=null&&v[colMap['Annual Salary']]!==''?Number(v[colMap['Annual Salary']]):'' ,createdBy:'Imported',createdByIni:'?'};});
        ST.contacts=nct; save(); toast('Imported '+nct.length+' contacts'); ST.modal=null; render();
      } else if(type==='settings'){
        parsed.forEach(function(v){
          var k=v[0],val=v[1]||'';
          if(k==='App Name') ST.prefs.appName=val;
          else if(k==='Dark Mode') ST.prefs.darkMode=(val==='null'?null:(val==='true'));
          else if(k==='Layout') ST.prefs.layout=val;
          else if(k==='Description Presets'&&val) ST.descPresets=val.split('|').filter(Boolean);
        });
        save(); applyPrefs(); toast('Settings imported'); ST.modal=null; render();
      }
    };
    reader.readAsText(file); inp.value='';
  },

  // Download a freshly-generated CLAUDE_BILLING.md with current line numbers
  dlManifest: function(){
    // Scan own script source for // === SECTION markers and their line numbers
    var src = document.querySelector('script').textContent;
    var srcLines = src.split('\n');
    // The script tag starts at some line in the HTML file; find it
    var htmlSrc = document.documentElement.outerHTML;
    var htmlLines = htmlSrc.split('\n');
    var scriptStartLine = 0;
    for(var i=0;i<htmlLines.length;i++){
      if(htmlLines[i].indexOf('<script>')!==-1){scriptStartLine=i+1;break;}
    }
    // Build section map: name -> html line number
    var secMap = {};
    srcLines.forEach(function(line, i){
      var m = line.match(/^\/\/ === ([A-Z][A-Z &]+)$/);
      if(m) secMap[m[1]] = scriptStartLine + i;
    });

    // Descriptions for each section
    var descs = {
      'STORAGE':           'IndexedDB — named object stores per collection. Store.getAll/saveAll (collections) Store.getMeta/setMeta (singletons) Store.clearData (reset)',
      'STATE':             'ST object - all app state',
      'HELPERS':           'uid,today,$m,$h,H,fmtPhone,fmtCur,autoRate,filterEnt,syncForm',
      'SAVE':              'save() debounced persist',
      'TOAST':             'toast(msg,type)',
      'ICONS':             'IC object of SVG strings',
      'FIELD BUILDER':     'field(label,id,opts), stats(arr)',
      'EXPORT FILENAME GENERATOR':'exportFilename()',
      'VIEWS':             'vTimesheet,vClients,vMatters,vContacts,vAnalytics + form builders',
      'MODALS':            'buildUP,buildQL,buildHelp,buildSettings',
      'MAIN RENDER':       'TABS[], views{}, render()',
      'ACTIONS':           'A object - all user actions',
      'CHANGE DELEGATION': 'document.addEventListener(\'change\',...)',
      'INIT':              'startup data loading, Promise.all'
    };

    var tableRows = Object.keys(descs).map(function(sec){
      var ln = secMap[sec] || '?';
      return '| `// === '+sec+'` | '+ln+' | '+descs[sec]+' |';
    }).join('\n');

    var now = new Date().toISOString().split('T')[0];
    var totalLines = htmlLines.length;

    var md = [
'# SixMinuteLog.com - Claude Architecture Guide',
'> **Claude: Read ONLY this file first. Then `view` specific line ranges in Billing_Tracker.html.**',
'> **Never read the full HTML. Use `str_replace` for all edits.**',
'> Auto-generated: '+now+' | HTML file: ~'+totalLines+' lines',
'',
'---',
'',
'## SECTION MAP (current line numbers in Billing_Tracker.html)',
'',
'| Search String | ~Line | Contents |',
'|---|---|---|',
tableRows,
'',
'---',
'',
'## STATE SHAPE',
'',
'```',
'ST.tab          // active tab: timesheet|clients|matters|contacts|analytics',
'ST.clients[]    // {id,name,email,phone,rate,contactId}',
'ST.matters[]    // {id,name,clientId,description,rate,contactId}',
'ST.entries[]    // {id,date,clientId,matterId,contactId,hours,rate,description,createdBy,createdByIni}',
'ST.contacts[]   // {id,name,role,email,phone,rate,ownPct}',
'ST.user         // {name,initials,ownPct} or null',
'ST.settings     // {te,cl,ma,co,su,split, tc_date/client/matter/team/desc/hours/rate/amount/by, expFrom,expTo,te_group}',
'ST.modal        // null | ef|cf|mf|ctf|ql|up|help|settings | YOUR_KEY',
'ST.editId       // id of record being edited (null = new)',
'ST.ef/cf/mf/ctf/ql  // form state objects, each with .errs{}',
'```',
'',
'---',
'',
'## KEY FUNCTIONS',
'',
'```',
'uid()                              unique numeric ID for new records',
'today()                            YYYY-MM-DD string',
'$m(n) $h(n) $d(s)                 $X.XX  X.XXh  Jan 1, 2025',
'H(str)                             HTML-escape - ALWAYS use on user data in templates',
'g(id)                              get DOM element value by id',
'save()                             call after mutating clients/matters/entries/contacts',
'toast(msg,type)                    type: ok|warn|err',
'syncForm()                         call before render() if user typed in fields',
'autoRate(clientId,matterId,ctId)   returns best available rate',
'fmtCur(val)                        strips non-numeric, 2 decimal max',
'```',
'',
'---',
'',
'## RECIPE: ADD A NEW TAB',
'',
'1. Add SVG to IC object (// === ICONS):',
'   myIcon: \'<svg width="17" height="17" ...>...</svg>\'',
'',
'2. Push to TABS array (// === MAIN RENDER):',
'   {id:\'mytab\', lbl:\'My Tab\', ic:IC.myIcon}',
'',
'3. Add view function before // === MODALS:',
'   function vMyTab(){ return \'<div>...</div>\'; }',
'',
'4. Register in views{} inside render():',
'   var views={..., analytics:vAnalytics, mytab:vMyTab};',
'',
'---',
'',
'## RECIPE: ADD A NEW MODAL',
'',
'1. Add builder (// === MODALS):',
'   function buildMyModal(){',
'     return \'<div class="ov"><div class="modal modal-sm">\'',
'       +\'<div class="modal-hd"><h2>Title</h2>\'',
'       +\'<button class="btn-ic" onclick="A.closeM()">\'+IC.x+\'</button></div>\'',
'       +\'<div class="modal-bd">...field() calls...</div>\'',
'       +\'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button></div>\'',
'       +\'</div></div>\';',
'   }',
'',
'2. Add to overlays in render() after "else if(ST.modal===\'settings\')":',
'   else if(ST.modal===\'mymodal\') overlays=buildMyModal();',
'',
'3. Add open action to A:',
'   openMyModal: function(){ ST.modal=\'mymodal\'; render(); },',
'',
'---',
'',
'## RECIPE: ADD PERSISTED DATA',
'',
'FOR A COLLECTION (array of objects each with .id):',
'1. Add to ST: myData: []',
'2. Add to save(): Store.saveAll(\'mydata\', ST.myData);',
'3. Add to INIT Promise.all: Store.getAll(\'mydata\')',
'4. Load in .then(res): try{if(res[N]&&res[N].length)ST.myData=res[N];}catch(e){}',
'   (N = index; current: 0=user(meta), 1=clients, 2=matters, 3=entries, 4=contacts)',
'   Also add \'mydata\' to Store clearData() COLLECTIONS list.',
'',
'FOR A SINGLETON (a single object/value):',
'1. Add to save(): Store.setMeta(\'mykey\', ST.myVal);',
'2. Add to INIT Promise.all: Store.getMeta(\'mykey\')',
'3. Load in .then(res): try{if(res[N])ST.myVal=res[N];}catch(e){}',
'',
'---',
'',
'## FIELD BUILDER',
'',
'```',
'field(label, id, { type, val, ph, req, err, hint, pfx, sfx, opts:[{v,l}], dis, oninput })',
'stats([[\'Label\',\'Value\',\'\'],[\'Label\',\'Value\',\'highlight\'],[\'Label\',\'Value\',\'highlight2\']])',
'// \'\' = white  \'highlight\' = green  \'highlight2\' = amber',
'```',
'',
'---',
'',
'## CSS CLASSES',
'',
'```',
'Layout:   .fbox .frow.c2 .frow.c3 .fl .fa .cgrid .card .card-hd .twrap .tscroll',
'Buttons:  .btn .btn-dk .btn-gr .btn-rd .btn-gh .btn-bl .btn-ic',
'Modals:   .ov .modal .modal-sm(480) .modal-md(580) .modal-lg(760) .modal-hd .modal-bd .modal-ft',
'Stats:    .srow .sc .sc-lbl .sc-val',
'Misc:     .chip .badge .split-pill .empty .note(amber) .good(green) .danger(red)',
'```',
'',
'---',
'',
'## COMMON PATTERNS',
'',
'Delete:',
'  if(!confirm(\'Delete?\')) return;',
'  ST.arr = ST.arr.filter(function(x){ return x.id!=id; });',
'  save(); toast(\'Deleted\',\'warn\'); render();',
'',
'Edit (open form):',
'  ST.editId=id; ST.xf=Object.assign({},record,{errs:{}}); ST.modal=\'xf\'; render();',
'',
'Save form:',
'  Read: f.name=g(\'xf-n\'); f.rate=fmtCur(g(\'xf-r\')||\'\');',
'  Validate: set errs{}, if errors{ render(); return; }',
'  Build: {id:ST.editId||uid(), ...fields}',
'  Upsert: ST.editId ? map-replace : concat-push',
'  save(); A.closeF();',
'',
'Dropdown onChange (CHANGE DELEGATION):',
'  syncForm();  // ALWAYS first - preserves typed values',
'  ST.myForm.field = e.target.value;',
'  if(!ST.myForm.rate){ var r=autoRate(...); if(r) ST.myForm.rate=String(r); }',
'  render();',
'',
'---',
'',
'## GOTCHAS',
'',
'1. syncForm() FIRST in every onchange - or typed values are lost on re-render',
'2. H() on ALL user data in template strings',
'3. Only auto-fill rate when empty: if(!ST.ef.rate){ ... }',
'4. Phone: oninput="A.livePhone(\'id\')" - formats in-place, no re-render',
'5. IDs: always uid() for new records',
'6. No external deps - 100% offline, no CDN',
'7. save() after every data mutation',
'',
'---',
'',
'## USAGE',
'',
'Tell Claude:',
'  "Read CLAUDE_BILLING.md first. Then add [feature] to Billing_Tracker.html."',
'',
'Claude reads this (~3k tokens) instead of the full HTML (~25k tokens).',
'',
'To regenerate this file: open Billing_Tracker.html → Settings (gear) → Download Claude Guide.',
'Line numbers update automatically based on the current file state.',
'',
'---',
'SixMinuteLog.com | Line numbers auto-generated on '+now
    ].join('\n');

    A._dlData(md, 'CLAUDE_BILLING.md', 'text/markdown');
    toast('Claude guide downloaded with live line numbers!');
  },

  // === IT MODE ACTIONS ===
  togITMode: function(on){
    ST.itMode=on;
    if(!ST.firmProfile) ST.firmProfile={firmName:'',appName:ST.prefs.appName||'SixMinuteLog.com',clients:[],matters:[],contacts:[],descPresets:[],users:[],settings:{}};
    save(); render();
  },
  saveITFirm: function(){
    var fn=g('it-firmname').trim();
    var an=g('it-appname').trim();
    if(!ST.firmProfile) ST.firmProfile={};
    ST.firmProfile.firmName=fn;
    ST.firmProfile.appName=an||'SixMinuteLog.com';
    if(an){ ST.prefs.appName=an; savePrefs(); }
    save(); toast('Firm identity saved'); render();
  },
  togITInclude: function(key,val){
    if(!ST.firmProfile) ST.firmProfile={};
    ST.firmProfile[key]=val;
    save(); render();
  },
  openITUser: function(idx){
    if(idx!=null){
      var u=ST.firmProfile.users[idx];
      ST.itf=Object.assign({},u,{editIdx:idx});
    } else {
      ST.itf={name:'',initials:'',role:'attorney',rate:'',ownPct:100};
    }
    ST.modal='ituser'; render();
  },
  editITUser: function(idx){ A.openITUser(idx); },
  delITUser: function(idx){
    if(!confirm('Remove this user from the profile?')) return;
    ST.firmProfile.users.splice(idx,1);
    save(); toast('User removed','warn'); render();
  },
  saveITUser: function(){
    var f=ST.itf||{};
    var name=g('itu-name').trim();
    if(!name){ toast('Name is required','err'); return; }
    var ini=g('itu-ini').trim()||name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,4);
    var role=g('itu-role')||'attorney';
    var rate=fmtCur(g('itu-rate')||'');
    var pct=Number(g('itu-pct')||100);
    var usr={name:name,initials:ini,role:role,rate:rate,ownPct:pct};
    if(!ST.firmProfile) ST.firmProfile={users:[]};
    if(!ST.firmProfile.users) ST.firmProfile.users=[];
    if(f.editIdx!=null){
      ST.firmProfile.users[f.editIdx]=usr;
    } else {
      ST.firmProfile.users.push(usr);
    }
    ST.itf={}; ST.modal='settings'; ST.settingsTab='itadmin';
    save(); toast((f.editIdx!=null?'User updated':'User added')); render();
  },
  closeITUser: function(){
    ST.itf={}; ST.modal='settings'; ST.settingsTab='itadmin'; render();
  },
  exportFirmProfile: function(){
    var fp=ST.firmProfile||{};
    var profile={
      _type:'billing-ledger-firm-profile',
      _version:1,
      firmName:fp.firmName||'',
      appName:fp.appName||ST.prefs.appName||'SixMinuteLog.com',
      users:fp.users||[],
      clients:fp.includeClients?ST.clients:[],
      matters:fp.includeMatters?ST.matters:[],
      contacts:fp.includeContacts?ST.contacts:[],
      descPresets:fp.includePresets?ST.descPresets:[],
      exportedAt:new Date().toISOString()
    };
    var fn=(fp.firmName?fp.firmName.replace(/[^a-z0-9]/gi,'_').toLowerCase():'firm')+'_profile_'+today()+'.json';
    A._dlData(JSON.stringify(profile,null,2),fn,'application/json');
    toast('Firm profile exported: '+fn);
  },
  importFirmProfile: function(inp){
    var file=inp.files[0]; if(!file) return;
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var p=JSON.parse(ev.target.result);
        if(!p||p._type!=='billing-ledger-firm-profile'){ toast('Not a valid firm profile file','err'); inp.value=''; return; }
        ST._importedProfile=p;
        // Apply branding immediately
        if(p.appName){ ST.prefs.appName=p.appName; savePrefs(); }
        // If profile has pre-configured users, let user pick one
        if(p.users&&p.users.length>0){
          ST.modal='userSelect';
        } else {
          // Apply data and go to user setup
          A._applyProfileData(p);
          ST._splashMode=true; ST.modal='up';
        }
        inp.value=''; render();
      } catch(e){ toast('Could not read profile file','err'); inp.value=''; }
    };
    reader.readAsText(file);
  },
  _applyProfileData: function(p){
    if(!p) return;
    if(p.clients&&p.clients.length) ST.clients=p.clients;
    if(p.matters&&p.matters.length) ST.matters=p.matters;
    if(p.contacts&&p.contacts.length) ST.contacts=p.contacts;
    if(p.descPresets&&p.descPresets.length) ST.descPresets=p.descPresets;
    save();
    toast('Firm profile applied: '+(p.firmName||p.appName||'Profile'));
  },
  pickITUser: function(idx){
    var p=ST._importedProfile;
    if(!p||!p.users) return;
    var u=p.users[idx];
    // Pre-fill user profile from selected profile user
    ST.user={name:u.name,initials:u.initials||(u.name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,4)),role:u.role||'attorney',rate:u.rate||'',ownPct:u.ownPct!=null?u.ownPct:100};
    Store.setMeta('user',ST.user);
    A._applyProfileData(p);
    ST._importedProfile=null;
    ST._splashMode=false;
    ST.modal=null; render();
    toast('Welcome, '+u.name+' \ud83c\udf89');
  },
  skipProfileImport: function(){
    if(ST._importedProfile){ A._applyProfileData(ST._importedProfile); ST._importedProfile=null; }
    ST._splashMode=true; ST.modal='up'; render();
  },

  // ======== INVOICE ACTIONS ========
  invSetFilter:function(v){ ST.invFilter=v; render(); },

  invNew:function(){
    ST.editId=null;
    // Auto-number: next invoice number
    var nums=(ST.invoices||[]).map(function(i){return parseInt(i.number)||0;}).filter(Boolean);
    var nextNum=nums.length>0?Math.max.apply(null,nums)+1:1001;
    ST.invf={number:String(nextNum),invoiceDate:today(),dueDate:'',status:'draft',clientId:'',matterId:'',
      firmName:ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'',
      firmAddress:'',firmPhone:'',firmEmail:'',
      paymentTerms:'Net 30',taxPct:'',notes:'',footerNote:'',
      entryIds:[],errs:{}};
    ST.modal='invForm'; render();
  },

  invEdit:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv) return;
    ST.editId=id;
    ST.invf=Object.assign({},inv,{errs:{}});
    ST.modal='invForm'; render();
  },

  invTogEnt:function(eid){
    var f=ST.invf;
    var ids=f.entryIds||[];
    var idx=ids.indexOf(eid);
    if(idx===-1){ f.entryIds=ids.concat([eid]); }
    else { f.entryIds=ids.filter(function(id){return id!==eid;}); }
    render();
  },

  invSave:function(){
    // Sync all fields
    var f=ST.invf;
    f.number=(document.getElementById('inv-num')||{}).value||f.number||'';
    f.invoiceDate=(document.getElementById('inv-date')||{}).value||f.invoiceDate;
    f.dueDate=(document.getElementById('inv-due')||{}).value||'';
    f.status=(document.getElementById('inv-status')||{}).value||'draft';
    f.firmName=(document.getElementById('inv-firm')||{}).value||'';
    f.firmAddress=(document.getElementById('inv-faddr')||{}).value||'';
    f.firmPhone=(document.getElementById('inv-fphone')||{}).value||'';
    f.firmEmail=(document.getElementById('inv-femail')||{}).value||'';
    f.paymentTerms=(document.getElementById('inv-terms')||{}).value||'Net 30';
    f.taxPct=(document.getElementById('inv-tax')||{}).value||'';
    f.notes=(document.getElementById('inv-notes')||{}).value||'';
    f.footerNote=(document.getElementById('inv-footer')||{}).value||'';

    // Sync clientId/matterId from selects
    var clSel=document.getElementById('inv-cl');
    if(clSel) f.clientId=clSel.value;
    var mtSel=document.getElementById('inv-mt');
    if(mtSel) f.matterId=mtSel.value;

    f.errs={};
    if(!f.clientId){ f.errs.clientId='Client is required'; toast('Client is required','err'); render(); return; }

    var now=Date.now();
    var inv=ST.editId
      ?Object.assign({},ST.invoices.find(function(i){return i.id==ST.editId;})||{},f,{id:ST.editId,updatedAt:now})
      :Object.assign({},f,{id:uid(),createdAt:now,updatedAt:now,cuts:{},mergedEntries:[],comments:[]});

    if(ST.editId){
      ST.invoices=ST.invoices.map(function(i){return i.id==ST.editId?inv:i;});
    } else {
      if(!ST.invoices) ST.invoices=[];
      ST.invoices.push(inv);
    }
    save();
    toast(ST.editId?'Invoice updated':'Invoice created');
    A.closeF();
  },

  invDel:function(id){
    if(!confirm('Delete this invoice?')) return;
    ST.invoices=ST.invoices.filter(function(i){return i.id!=id;});
    save(); toast('Invoice deleted','warn'); render();
  },

  invPrint:function(id){
    ST.invPrintId=id; ST.modal='invPrint'; render();
  },

  invDoPrint:function(){
    var wrap=document.getElementById('inv-print-wrap');
    if(!wrap){ window.print(); return; }
    var html=wrap.innerHTML;
    var w=window.open('','_blank');
    if(!w){ window.print(); return; }
    w.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Invoice</title>'
      +'<style>body{margin:0;padding:0;font-family:Georgia,serif;color:#222;background:#fff}'
      +'table{width:100%;border-collapse:collapse}'
      +'@page{margin:0.5in}'
      +'@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'
      +'</style></head><body>'+html+'</body></html>');
    w.document.close();
    w.focus();
    setTimeout(function(){ w.print(); },300);
  },

  invOpenReview:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv) return;
    // Initialize review state from saved cuts
    ST.invRev={
      invoiceId:id,
      cuts:Object.assign({},inv.cuts||{}),
      comments:{},
      pendingMerge:[],
      invoiceComment:''
    };
    ST.modal='invReview'; render();
  },

  invRevCut:function(eid,val){
    var rev=ST.invRev;
    var e=ST.entries.find(function(x){return x.id==eid;});
    if(!e) return;
    var h=Math.max(0,Math.min(Number(val)||0,Number(e.hours)));
    rev.cuts[eid]=h;
    // Update the input directly for smooth UX, then re-render totals
    render();
  },

  invRevComment:function(eid,val){
    ST.invRev.comments[eid]=val;
  },

  invRevTogMerge:function(eid){
    var arr=ST.invRev.pendingMerge||[];
    var idx=arr.indexOf(eid);
    if(idx===-1){ ST.invRev.pendingMerge=arr.concat([eid]); }
    else { ST.invRev.pendingMerge=arr.filter(function(id){return id!==eid;}); }
    render();
  },

  invRevCommitMerge:function(){
    var rev=ST.invRev;
    var ids=rev.pendingMerge||[];
    if(ids.length<2){ toast('Select 2+ entries to merge','warn'); return; }
    var descEl=document.getElementById('merge-desc');
    var desc=descEl?descEl.value.trim():'';
    if(!desc){ toast('Enter a description for the merged entry','warn'); return; }
    // Compute merged hours/rate (sum hours, use rate of first entry)
    var totalH=0,rate=0;
    ids.forEach(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;});
      if(!e) return;
      var h=rev.cuts[eid]!=null?Number(rev.cuts[eid]):Number(e.hours);
      totalH+=h;
      if(!rate) rate=Number(e.rate||0);
    });
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    var mg={id:uid(),description:desc,hours:totalH.toFixed(2),rate:rate,entryIds:ids.slice()};
    var newMerged=(inv.mergedEntries||[]).concat([mg]);
    ST.invoices=ST.invoices.map(function(i){return i.id==rev.invoiceId?Object.assign({},i,{mergedEntries:newMerged}):i;});
    save();
    rev.pendingMerge=[];
    toast('Entries merged'); render();
  },

  invRevClearMerge:function(){
    ST.invRev.pendingMerge=[];
    render();
  },

  invRevUnmerge:function(mi){
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return;
    var newMerged=(inv.mergedEntries||[]).filter(function(_,idx){return idx!==mi;});
    ST.invoices=ST.invoices.map(function(i){return i.id==rev.invoiceId?Object.assign({},i,{mergedEntries:newMerged}):i;});
    save(); toast('Unmerged','warn'); render();
  },

  invRevMergeDesc:function(mi,val){
    var inv=ST.invoices.find(function(i){return i.id==ST.invRev.invoiceId;});
    if(!inv||!inv.mergedEntries[mi]) return;
    inv.mergedEntries[mi].description=val;
    save();
  },

  invRevMergeHours:function(mi,val){
    var inv=ST.invoices.find(function(i){return i.id==ST.invRev.invoiceId;});
    if(!inv||!inv.mergedEntries[mi]) return;
    inv.mergedEntries[mi].hours=String(Math.max(0,Number(val)||0));
    save(); render();
  },

  invRevAddComment:function(){
    var inp=document.getElementById('inv-comment-inp');
    var text=inp?inp.value.trim():'';
    if(!text){ toast('Enter a comment first','warn'); return; }
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return;
    var cmt={id:uid(),by:ST.user?ST.user.name:'Unknown',at:today(),text:text};
    var newComments=(inv.comments||[]).concat([cmt]);
    ST.invoices=ST.invoices.map(function(i){return i.id==rev.invoiceId?Object.assign({},i,{comments:newComments}):i;});
    save(); toast('Comment added'); render();
  },

  invRevSave:function(andClose){
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return false;
    // Apply entry-level comments as invoice comments if any
    var entryComments=Object.keys(rev.comments||{}).filter(function(eid){
      return (rev.comments[eid]||'').trim();
    }).map(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;});
      return {id:uid(),by:ST.user?ST.user.name:'Reviewer',at:today(),entryId:Number(eid),
        text:'['+$d(e?e.date:'')+'] '+rev.comments[eid],entryRef:true};
    });
    var newComments=(inv.comments||[]).concat(entryComments);
    ST.invoices=ST.invoices.map(function(i){
      return i.id==rev.invoiceId?Object.assign({},i,{cuts:rev.cuts,comments:newComments,updatedAt:Date.now()}):i;
    });
    save();
    if(andClose!==false){ toast('Review saved'); A.closeM(); }
    return true;
  },

  invRevApprove:function(){
    // Save cuts/comments without closing, then approve in same pass
    var saved=A.invRevSave(false);
    if(!saved) return;SixMinuteLog.com
    var id=ST.invRev.invoiceId;
    ST.invoices=ST.invoices.map(function(i){
      return i.id==id?Object.assign({},i,{
        status:'approved',
        approvedBy:ST.user?ST.user.name:'',
        approvedAt:Date.now()
      }):i;
    });
    save();
    toast('Invoice approved!','ok');
    ST.modal=null;
    render();
  },

  invRevReject:function(){
    var reason=prompt('Reason for rejection (optional):');
    if(reason===null) return;
    var id=ST.invRev.invoiceId;
    var cmt={id:uid(),by:ST.user?ST.user.name:'Reviewer',at:today(),
      text:'REJECTED'+(reason?' — '+reason:''),type:'rejection'};
    ST.invoices=ST.invoices.map(function(i){
      return i.id==id?Object.assign({},i,{
        status:'draft',
        comments:(i.comments||[]).concat([cmt])
      }):i;
    });
    save(); toast('Invoice returned to draft','warn'); A.closeM();
  },

  invSendForReview:function(id){
    ST.invoices=ST.invoices.map(function(i){
      return i.id==id?Object.assign({},i,{status:'review',updatedAt:Date.now()}):i;
    });
    save(); toast('Invoice sent for partner review','ok'); render();
  },

  invMarkSent:function(id){
    ST.invoices=ST.invoices.map(function(i){
      return i.id==id?Object.assign({},i,{status:'sent',sentAt:Date.now()}):i;
    });
    save(); toast('Invoice marked as sent','ok'); render();
  },

  // ======== EMAIL ACTIONS ========

  _openMailto:function(d){
    // Derive context pill display values from the data already in d
    d.clientName = (d.cl&&d.cl.name)||d.clientName||'';
    d.invNum     = (d.inv&&(d.inv.number||d.inv.id))||d.invNum||'';
    d.invAmount  = (d.grandTotal!=null?'$'+Number(d.grandTotal).toFixed(2):d.invAmount)||'';
    d.hoursTotal = (d.totalH!=null?Number(d.totalH).toFixed(1):d.hoursTotal)||'';
    d.entriesCount = (d.entries!=null?d.entries.length:d.entriesCount);
    d.selectedTemplateId = null;  // reset on each open
    // Auto-select a template if there's exactly one matching this type
    var matching=(ST.emailTemplates||[]).filter(function(t){
      return !t.types||!t.types.length||t.types.indexOf(d.type)!==-1||t.types.indexOf('all')!==-1;
    });
    if(matching.length===1) d.selectedTemplateId=matching[0].id;
    ST.emailDraft=d;
    ST.modal='emailCompose';
    render();
  },

  // ── Sync live field values into emailDraft ────────────────────────────────
  _ecSyncFields:function(){
    if(!ST.emailDraft) return;
    var toEl=document.getElementById('ec-to');
    var subEl=document.getElementById('ec-subject');
    if(toEl) ST.emailDraft.to=toEl.value;
    if(subEl) ST.emailDraft.subject=subEl.value;
    // sync custom text blocks
    (ST.emailDraft.bodyBlocks||[]).forEach(function(b,i){
      if(b.btype==='custom_text'){var ta=document.getElementById('ec-custom-'+i);if(ta)b.customText=ta.value;}
    });
  },

  // ── View toggle (Compose / Preview) ──────────────────────────────────────
  ecSetView:function(preview){
    A._ecSyncFields();
    ST.emailDraft.showPreview=!!preview;
    render();
  },

  // ── Reset blocks to context defaults ─────────────────────────────────────
  ecResetBlocks:function(){
    if(!ST.emailDraft) return;
    if(!confirm('Reset email body to defaults? Custom edits will be lost.')) return;
    ST.emailDraft.bodyBlocks=ecDefaultBlocks(ST.emailDraft.type);
    render();
  },

  // ── Palette: add recipient ────────────────────────────────────────────────
  ecAddRecipient:function(email){
    var el=document.getElementById('ec-to');
    if(!el) return;
    if(!email){var custom=prompt('Enter email address:');if(!custom||!custom.trim()) return;email=custom.trim();}
    var cur=el.value.trim();
    el.value=cur?(cur.replace(/,\s*$/,'')+', '+email):email;
    if(ST.emailDraft) ST.emailDraft.to=el.value;
  },

  // ── Palette: set subject ──────────────────────────────────────────────────
  ecSetSubject:function(idx){
    var d=ST.emailDraft||{};
    var s=(ecPaletteFor(d).subjs||[])[idx]||'';
    var el=document.getElementById('ec-subject');
    if(el) el.value=s;
    if(ST.emailDraft) ST.emailDraft.subject=s;
  },

  // ── Block: toggle settings panel ─────────────────────────────────────────
  ecToggleBlockExpand:function(idx){
    A._ecSyncFields();
    var blocks=ST.emailDraft&&ST.emailDraft.bodyBlocks;
    if(!blocks||!blocks[idx]) return;
    blocks[idx].expanded=!blocks[idx].expanded;
    if(ST.emailDraft) ST.emailDraft.insertPickerAt=undefined;
    render();
  },

  // ── Block: set a config key ───────────────────────────────────────────────
  ecSetBlockCfg:function(idx,key,val){
    // When the template editor is open, the cfgPanel still emits A.ecSetBlockCfg — delegate
    if(ST.modal==='emailtemplateeditor'){ A.etSetBlockCfg(idx,key,val); return; }
    var blocks=ST.emailDraft&&ST.emailDraft.bodyBlocks;
    if(!blocks||!blocks[idx]) return;
    if(!blocks[idx].cfg) blocks[idx].cfg={};
    blocks[idx].cfg[key]=val;
    // Re-render only if the preview is showing; otherwise just store
    if(ST.emailDraft&&ST.emailDraft.showPreview) render();
  },

  // ── Block: custom text update ─────────────────────────────────────────────
  ecCustomText:function(idx,val){
    var blocks=ST.emailDraft&&ST.emailDraft.bodyBlocks;
    if(blocks&&blocks[idx]) blocks[idx].customText=val;
  },

  // ── Block: remove ─────────────────────────────────────────────────────────
  ecRemoveBlock:function(idx){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    var blocks=(ST.emailDraft.bodyBlocks||[]).slice();
    blocks.splice(idx,1);
    ST.emailDraft.bodyBlocks=blocks;
    render();
  },

  // ── Block: add at position (null = append) ────────────────────────────────
  ecAddBlock:function(btype,atIdx){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    var nb={id:uid(),btype:btype,cfg:{},customText:'',expanded:false,hidden:false};
    var blocks=(ST.emailDraft.bodyBlocks||[]).slice();
    if(atIdx===null||atIdx===undefined) blocks.push(nb);
    else blocks.splice(atIdx,0,nb);
    ST.emailDraft.bodyBlocks=blocks;
    ST.emailDraft.insertPickerAt=undefined;
    render();
  },

  // ── Block: duplicate ──────────────────────────────────────────────────────
  ecDuplicateBlock:function(idx){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    var blocks=(ST.emailDraft.bodyBlocks||[]).slice();
    var src=blocks[idx]; if(!src) return;
    var copy={id:uid(),btype:src.btype,cfg:Object.assign({},src.cfg||{}),customText:src.customText||'',expanded:false,hidden:false};
    blocks.splice(idx+1,0,copy);
    ST.emailDraft.bodyBlocks=blocks;
    toast('Block duplicated','ok'); render();
  },

  // ── Block: move up or down ────────────────────────────────────────────────
  ecMoveBlock:function(idx,dir){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    var blocks=(ST.emailDraft.bodyBlocks||[]).slice();
    var target=idx+dir;
    if(target<0||target>=blocks.length) return;
    var tmp=blocks[idx]; blocks[idx]=blocks[target]; blocks[target]=tmp;
    ST.emailDraft.bodyBlocks=blocks;
    render();
  },

  // ── Block: toggle visibility ──────────────────────────────────────────────
  ecToggleBlockVisible:function(idx){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    var blocks=ST.emailDraft.bodyBlocks;
    if(!blocks||!blocks[idx]) return;
    blocks[idx].hidden=!blocks[idx].hidden;
    render();
  },

  // ── Block: insert picker ──────────────────────────────────────────────────
  ecShowInsertPicker:function(atIdx){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    ST.emailDraft.insertPickerAt=atIdx;
    render();
  },
  ecHideInsertPicker:function(){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    ST.emailDraft.insertPickerAt=undefined;
    render();
  },

  // ── Expand / collapse all ─────────────────────────────────────────────────
  ecExpandAll:function(){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    (ST.emailDraft.bodyBlocks||[]).forEach(function(b){b.expanded=true;});
    render();
  },
  ecCollapseAll:function(){
    if(!ST.emailDraft) return;
    A._ecSyncFields();
    (ST.emailDraft.bodyBlocks||[]).forEach(function(b){b.expanded=false;});
    render();
  },

  // ── Drag-and-drop ─────────────────────────────────────────────────────────
  ecDragPalette:function(ev,btype){
    window._ecDrag={src:'palette',btype:btype};
    ev.dataTransfer.effectAllowed='copy';
    ev.dataTransfer.setData('text/plain',btype);
  },

  ecDragBody:function(ev,idx){
    window._ecDrag={src:'body',idx:idx};
    ev.dataTransfer.effectAllowed='move';
    ev.dataTransfer.setData('text/plain',String(idx));
    ev.stopPropagation();
  },

  ecBodyDragOver:function(ev,targetIdx){
    ev.preventDefault();
    ev.dataTransfer.dropEffect=(window._ecDrag&&window._ecDrag.src==='body')?'move':'copy';
    var el=document.getElementById('ecb-'+targetIdx);
    if(el) el.style.outline='2px solid var(--blue)';
  },

  ecBodyDragLeave:function(ev){
    var el=ev.currentTarget; if(el) el.style.outline='';
  },

  ecBodyDrop:function(ev,targetIdx){
    ev.preventDefault(); ev.stopPropagation();
    var el=document.getElementById('ecb-'+targetIdx); if(el) el.style.outline='';
    A._ecCommitDrop(targetIdx);
  },

  ecZoneDragOver:function(ev){
    ev.preventDefault();
    var z=document.getElementById('ec-drop-zone'); if(z) z.style.borderColor='var(--blue)';
  },

  ecZoneDrop:function(ev){
    ev.preventDefault();
    var z=document.getElementById('ec-drop-zone'); if(z) z.style.borderColor='var(--brd)';
    A._ecCommitDrop(null);
  },

  _ecCommitDrop:function(targetIdx){
    A._ecSyncFields();
    var drag=window._ecDrag; if(!drag||!ST.emailDraft) return;
    window._ecDrag=null;
    ST.emailDraft.insertPickerAt=undefined;
    var blocks=(ST.emailDraft.bodyBlocks||[]).slice();
    if(drag.src==='palette'){
      var nb={id:uid(),btype:drag.btype,cfg:{},customText:'',expanded:false};
      if(targetIdx===null||targetIdx===undefined) blocks.push(nb);
      else blocks.splice(targetIdx,0,nb);
    } else if(drag.src==='body'){
      var si=drag.idx; if(si===targetIdx) return;
      var mv=blocks.splice(si,1)[0];
      if(targetIdx===null||targetIdx===undefined) blocks.push(mv);
      else blocks.splice(si<targetIdx?targetIdx-1:targetIdx,0,mv);
    }
    ST.emailDraft.bodyBlocks=blocks;
    render();
  },

  // ── Plain text generation ─────────────────────────────────────────────────
  _draftPlainText:function(d){
    var defs=ecBlockDefs(d);
    return (d.bodyBlocks||[]).filter(function(b){return !b.hidden;}).map(function(b){
      var def=defs[b.btype];
      if(!def) return '';
      return (def.textFn?def.textFn(b):'').trim();
    }).filter(Boolean).join('\n\n');
  },

  // ── Send / copy ───────────────────────────────────────────────────────────
  ecOpen:function(){
    A._ecSyncFields();
    var d=ST.emailDraft||{};
    var to=d.to||''; var subject=d.subject||''; var body=A._draftPlainText(d);
    var uri='mailto:'+to+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
    var a=document.createElement('a'); a.href=uri; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    toast('Opening mail app…','ok');
  },

  ecCopyText:function(){
    A._ecSyncFields();
    var d=ST.emailDraft||{};
    var sel=d.selectedTemplateId?ST.emailTemplates.find(function(t){return t.id==d.selectedTemplateId;}):null;
    var dProxy=sel?Object.assign({},d,{bodyBlocks:sel.blocks}):d;
    var to=d.to||''; var subject=(document.getElementById('ec-subject')||{}).value||d.subject||''; var body=A._draftPlainText(dProxy);
    var full='To: '+to+'\nSubject: '+subject+'\n\n'+body;
    if(navigator.clipboard){navigator.clipboard.writeText(full).then(function(){toast('Email copied to clipboard','ok');});}
    else{var ta=document.createElement('textarea');ta.value=full;ta.style.cssText='position:fixed;opacity:0;top:0;left:0';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('Email copied','ok');}
  },

  // ── Select a template in the send screen ─────────────────────────────────
  ecSelectTemplate:function(id){
    if(!ST.emailDraft) return;
    var tpl=ST.emailTemplates.find(function(t){return t.id==id;});
    ST.emailDraft.selectedTemplateId=id;
    if(tpl&&tpl.defaultSubject&&!ST.emailDraft.subject){
      ST.emailDraft.subject=tpl.defaultSubject;
    }
    render();
  },

  // ── ecOpen uses selected template blocks ──────────────────────────────────
  ecOpen:function(){
    var d=ST.emailDraft||{};
    var sel=d.selectedTemplateId?ST.emailTemplates.find(function(t){return t.id==d.selectedTemplateId;}):null;
    var dProxy=sel?Object.assign({},d,{bodyBlocks:sel.blocks}):d;
    var toEl=document.getElementById('ec-to'); var subjEl=document.getElementById('ec-subject');
    var to=toEl?toEl.value:(d.to||'');
    var subject=subjEl?subjEl.value:(d.subject||'');
    var body=A._draftPlainText(dProxy);
    var uri='mailto:'+to+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
    var a=document.createElement('a'); a.href=uri; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    toast('Opening mail app…','ok');
  },

  // ── Email Template Editor ─────────────────────────────────────────────────
  // etOpen: open editor for new (id=null) or edit (id=templateId)
  etOpen:function(id,defaultType){
    var returnToSend=(ST.modal==='emailCompose');
    var tpl=id?ST.emailTemplates.find(function(t){return t.id==id;}):null;
    if(tpl){
      ST.etf={editId:id,name:tpl.name,description:tpl.description||'',defaultSubject:tpl.defaultSubject||'',types:tpl.types||[],blocks:(tpl.blocks||[]).map(function(b){return Object.assign({},b,{cfg:Object.assign({},b.cfg||{})});}),_returnToSend:returnToSend};
    } else {
      ST.etf={editId:null,name:'',description:'',defaultSubject:'',types:defaultType?[defaultType]:[],blocks:[],_returnToSend:returnToSend};
    }
    ST.modal='emailtemplateeditor'; render();
  },
  etClose:function(){
    var returnToSend=ST.etf&&ST.etf._returnToSend;
    ST.etf={};
    ST.modal=returnToSend?'emailCompose':null;
    render();
  },
  etSave:function(){
    var name=(document.getElementById('et-name')||{}).value||'';
    var subject=(document.getElementById('et-subject')||{}).value||'';
    var desc=(document.getElementById('et-desc')||{}).value||'';
    // sync custom_text blocks from DOM
    (ST.etf.blocks||[]).forEach(function(b,i){
      if(b.btype==='custom_text'){var ta=document.getElementById('et-custom-'+i);if(ta)b.customText=ta.value;}
    });
    name=name.trim();
    if(!name){toast('Template name required','warn');return;}
    var tpl={
      id:ST.etf.editId||uid(),
      name:name,
      description:desc.trim(),
      defaultSubject:subject.trim(),
      types:ST.etf.types||[],
      blocks:(ST.etf.blocks||[]).map(function(b){return Object.assign({},b,{_idx:undefined,expanded:false});})
    };
    if(ST.etf.editId){
      ST.emailTemplates=ST.emailTemplates.map(function(t){return t.id==ST.etf.editId?tpl:t;});
    } else {
      ST.emailTemplates.push(tpl);
    }
    var returnToSend=ST.etf._returnToSend;
    // Auto-select this template in the send screen if returning there
    if(returnToSend&&ST.emailDraft) ST.emailDraft.selectedTemplateId=tpl.id;
    ST.etf={};
    save(); toast('Template saved','ok');
    ST.modal=returnToSend?'emailCompose':null; render();
  },
  etToggleType:function(typ){
    var types=ST.etf.types||[];
    var idx=types.indexOf(typ);
    if(idx===-1) types=types.concat([typ]);
    else types=types.filter(function(x){return x!==typ;});
    ST.etf.types=types; render();
  },
  etSetView:function(preview){
    // sync custom_text before re-render
    (ST.etf.blocks||[]).forEach(function(b,i){
      if(b.btype==='custom_text'){var ta=document.getElementById('et-custom-'+i);if(ta)b.customText=ta.value;}
    });
    ST.etf.showPreview=!!preview; render();
  },
  // ── et* block manipulation (mirrors ec* but operates on ST.etf.blocks) ────
  _etSync:function(){
    (ST.etf.blocks||[]).forEach(function(b,i){
      if(b.btype==='custom_text'){var ta=document.getElementById('et-custom-'+i);if(ta)b.customText=ta.value;}
    });
  },
  etAddBlock:function(btype,atIdx){
    A._etSync();
    var nb={id:uid(),btype:btype,cfg:{},customText:'',expanded:false,hidden:false};
    var blocks=(ST.etf.blocks||[]).slice();
    if(atIdx===null||atIdx===undefined) blocks.push(nb);
    else blocks.splice(atIdx,0,nb);
    ST.etf.blocks=blocks; ST.etf.insertPickerAt=undefined; render();
  },
  etRemoveBlock:function(idx){
    A._etSync();
    var blocks=(ST.etf.blocks||[]).slice();
    blocks.splice(idx,1);
    ST.etf.blocks=blocks; render();
  },
  etDuplicateBlock:function(idx){
    A._etSync();
    var blocks=(ST.etf.blocks||[]).slice();
    var src=blocks[idx]; if(!src) return;
    var copy={id:uid(),btype:src.btype,cfg:Object.assign({},src.cfg||{}),customText:src.customText||'',expanded:false,hidden:false};
    blocks.splice(idx+1,0,copy);
    ST.etf.blocks=blocks; toast('Block duplicated','ok'); render();
  },
  etMoveBlock:function(idx,dir){
    A._etSync();
    var blocks=(ST.etf.blocks||[]).slice();
    var target=idx+dir;
    if(target<0||target>=blocks.length) return;
    var tmp=blocks[idx]; blocks[idx]=blocks[target]; blocks[target]=tmp;
    ST.etf.blocks=blocks; render();
  },
  etToggleBlockVisible:function(idx){
    A._etSync();
    var blocks=ST.etf.blocks;
    if(!blocks||!blocks[idx]) return;
    blocks[idx].hidden=!blocks[idx].hidden; render();
  },
  etToggleBlockExpand:function(idx){
    A._etSync();
    var blocks=ST.etf.blocks;
    if(!blocks||!blocks[idx]) return;
    blocks[idx].expanded=!blocks[idx].expanded;
    ST.etf.insertPickerAt=undefined; render();
  },
  etSetBlockCfg:function(idx,key,val){
    var blocks=ST.etf.blocks;
    if(!blocks||!blocks[idx]) return;
    if(!blocks[idx].cfg) blocks[idx].cfg={};
    blocks[idx].cfg[key]=val;
    if(ST.etf.showPreview) render();
  },
  etCustomText:function(idx,val){
    var blocks=ST.etf.blocks;
    if(blocks&&blocks[idx]) blocks[idx].customText=val;
  },
  etShowInsertPicker:function(atIdx){ A._etSync(); ST.etf.insertPickerAt=atIdx; render(); },
  etHideInsertPicker:function(){ A._etSync(); ST.etf.insertPickerAt=undefined; render(); },
  etExpandAll:function(){ A._etSync(); (ST.etf.blocks||[]).forEach(function(b){b.expanded=true;}); render(); },
  etCollapseAll:function(){ A._etSync(); (ST.etf.blocks||[]).forEach(function(b){b.expanded=false;}); render(); },
  // ── et drag-and-drop ─────────────────────────────────────────────────────
  etDragPalette:function(ev,btype){
    window._etDrag={src:'palette',btype:btype};
    ev.dataTransfer.effectAllowed='copy';
    ev.dataTransfer.setData('text/plain',btype);
  },
  etDragBody:function(ev,idx){
    window._etDrag={src:'body',idx:idx};
    ev.dataTransfer.effectAllowed='move';
    ev.dataTransfer.setData('text/plain',String(idx));
    ev.stopPropagation();
  },
  etBodyDragOver:function(ev,targetIdx){
    ev.preventDefault();
    ev.dataTransfer.dropEffect=(window._etDrag&&window._etDrag.src==='body')?'move':'copy';
    var el=document.getElementById('etb-'+targetIdx);
    if(el) el.style.outline='2px solid var(--blue)';
  },
  etBodyDragLeave:function(ev){
    var el=ev.currentTarget; if(el) el.style.outline='';
  },
  etBodyDrop:function(ev,targetIdx){
    ev.preventDefault(); ev.stopPropagation();
    var el=document.getElementById('etb-'+targetIdx); if(el) el.style.outline='';
    A._etCommitDrop(targetIdx);
  },
  etZoneDragOver:function(ev){
    ev.preventDefault();
    var z=document.getElementById('et-drop-zone'); if(z) z.style.borderColor='var(--blue)';
  },
  etZoneDrop:function(ev){
    ev.preventDefault();
    var z=document.getElementById('et-drop-zone'); if(z) z.style.borderColor='var(--brd)';
    A._etCommitDrop(null);
  },
  _etCommitDrop:function(targetIdx){
    A._etSync();
    var drag=window._etDrag; if(!drag) return;
    window._etDrag=null;
    ST.etf.insertPickerAt=undefined;
    var blocks=(ST.etf.blocks||[]).slice();
    if(drag.src==='palette'){
      var nb={id:uid(),btype:drag.btype,cfg:{},customText:'',expanded:false,hidden:false};
      if(targetIdx===null||targetIdx===undefined) blocks.push(nb);
      else blocks.splice(targetIdx,0,nb);
    } else if(drag.src==='body'){
      var si=drag.idx; if(si===targetIdx) return;
      var mv=blocks.splice(si,1)[0];
      if(targetIdx===null||targetIdx===undefined) blocks.push(mv);
      else blocks.splice(si<targetIdx?targetIdx-1:targetIdx,0,mv);
    }
    ST.etf.blocks=blocks; render();
  },
  // ── Delete template ───────────────────────────────────────────────────────
  etDelete:function(id){
    if(!confirm('Delete this email template? This cannot be undone.')) return;
    ST.emailTemplates=ST.emailTemplates.filter(function(t){return t.id!=id;});
    save(); toast('Template deleted','warn'); render();
  },

  // ── Email trigger functions ───────────────────────────────────────────────
  invEmailClient:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv){toast('Invoice not found','err');return;}
    var cl=ST.clients.find(function(c){return c.id==inv.clientId;})||{name:'Client',email:''};
    var mt=inv.matterId?(ST.matters.find(function(m){return m.id==inv.matterId;})||null):null;
    var cuts=inv.cuts||{};
    var merged=inv.mergedEntries||[];
    var mergedIds={};
    merged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedIds[eid]=true;});});
    var total=0; var lineItems=[];
    (inv.entryIds||[]).forEach(function(eid){
      if(mergedIds[eid]) return;
      var e=ST.entries.find(function(x){return x.id==eid;}); if(!e) return;
      var h=cuts[eid]!=null?Number(cuts[eid]):Number(e.hours);
      var amt=h*Number(e.rate); total+=amt;
      lineItems.push({date:e.date,desc:e.description||'Legal Services',hrs:h.toFixed(2),rate:'$'+Number(e.rate).toFixed(2),amt:'$'+amt.toFixed(2)});
    });
    merged.forEach(function(mg){
      var amt=Number(mg.hours)*Number(mg.rate); total+=amt;
      lineItems.push({date:'',desc:mg.description,hrs:Number(mg.hours).toFixed(2),rate:'$'+Number(mg.rate).toFixed(2),amt:'$'+amt.toFixed(2)});
    });
    var taxAmt=inv.taxPct?total*Number(inv.taxPct)/100:0;
    var firmName=inv.firmName||ST.prefs.appName||'Our Firm';
    var invNum=inv.number||String(inv.id);
    A._openMailto({type:'invClient',to:cl.email||'',subject:'Invoice #'+invNum+' from '+firmName+(mt?' — '+mt.name:''),
      inv:inv,cl:cl,mt:mt,lineItems:lineItems,total:total,taxAmt:taxAmt,grandTotal:total+taxAmt});
  },

  invEmailApproval:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv){toast('Invoice not found','err');return;}
    var cl=ST.clients.find(function(c){return c.id==inv.clientId;})||{name:'Client'};
    var mt=inv.matterId?(ST.matters.find(function(m){return m.id==inv.matterId;})||null):null;
    var partners=ST.contacts.filter(function(c){return c.role&&c.role.toLowerCase().indexOf('partner')!==-1;});
    var to=partners.map(function(p){return p.email||'';}).filter(Boolean).join(', ');
    var fromUser=ST.user?ST.user.name:'Billing Staff';
    var entries=(inv.entryIds||[]).map(function(eid){return _lu.en[eid];}).filter(Boolean);
    var totalH=entries.reduce(function(s,e){return s+Number(e.hours);},0);
    var totalAmt=entries.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
    var invNum=inv.number||String(inv.id);
    A._openMailto({type:'invApproval',to:to,subject:'Action Required: Invoice #'+invNum+' — '+(cl.name||'')+(mt?' / '+mt.name:''),
      inv:inv,cl:cl,mt:mt,entries:entries,totalH:totalH,totalAmt:totalAmt,fromUser:fromUser});
  },

  invEmailDecision:function(){
    var rev=ST.invRev; if(!rev){toast('No active review','err');return;}
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;}); if(!inv) return;
    var cl=ST.clients.find(function(c){return c.id==inv.clientId;})||{name:'Client'};
    var reviewer=ST.user?ST.user.name:'Partner';
    var cuts=rev.cuts||{}; var comments=rev.comments||{};
    var cutLines=[];
    Object.keys(cuts).forEach(function(eid){
      var e=_lu.en[eid]; if(!e) return;
      var orig=Number(e.hours); var cut=Number(cuts[eid]);
      if(cut!==orig) cutLines.push({label:e.date+(e.description?' — '+e.description:''),orig:orig.toFixed(2),cut:cut.toFixed(2)});
    });
    var commentLines=[];
    Object.keys(comments).forEach(function(eid){
      var txt=(comments[eid]||'').trim(); if(!txt) return;
      var e=_lu.en[eid];
      commentLines.push({label:e?e.date+(e.description?' — '+e.description:''):eid,text:txt});
    });
    var entryAuthors={};
    (inv.entryIds||[]).forEach(function(eid){var e=_lu.en[eid];if(e&&e.createdBy)entryAuthors[e.createdBy]=true;});
    var to=''; var authorNames=Object.keys(entryAuthors);
    if(authorNames.length>0){var ct=ST.contacts.find(function(c){return authorNames.indexOf(c.name)!==-1&&c.email;});if(ct)to=ct.email;}
    var invNum=inv.number||String(inv.id);
    A._openMailto({type:'invDecision',to:to,subject:'Invoice #'+invNum+' — '+(inv.status==='approved'?'Approved':'Changes Requested')+' — '+(cl.name||''),
      inv:inv,cl:cl,reviewer:reviewer,cutLines:cutLines,commentLines:commentLines,invComments:inv.comments||[],approved:inv.status==='approved'});
  },

  emailEntriesApproval:function(){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    if(!fe.length){toast('No entries visible to email','warn');return;}
    var pending=fe.filter(function(e){return (e.status||'approved')==='pending';});
    var entriesToSend=pending.length?pending:fe;
    var partners=ST.contacts.filter(function(c){return c.role&&c.role.toLowerCase().indexOf('partner')!==-1;});
    var to=partners.map(function(p){return p.email||'';}).filter(Boolean).join(', ');
    var fromUser=ST.user?ST.user.name:'Attorney';
    var totalH=entriesToSend.reduce(function(s,e){return s+Number(e.hours);},0);
    var totalAmt=entriesToSend.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
    A._openMailto({type:'tsApproval',to:to,subject:(pending.length?'Approval Request':'Billing Entries')+' from '+fromUser+' — '+totalH.toFixed(1)+'h',
      entries:entriesToSend,totalH:totalH,totalAmt:totalAmt,fromUser:fromUser,isPending:pending.length>0});
  },

  emailEntriesSummary:function(){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    if(!fe.length){toast('No entries visible to email','warn');return;}
    var totalH=fe.reduce(function(s,e){return s+Number(e.hours);},0);
    var totalAmt=fe.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
    var fromUser=ST.user?ST.user.name:'Partner';
    var firmName=ST.prefs.appName||'Our Firm';
    var byAuthor={};
    fe.forEach(function(e){
      var a=e.createdBy||'Unknown';
      if(!byAuthor[a]){byAuthor[a]={h:0,amt:0,count:0};}
      byAuthor[a].h+=Number(e.hours); byAuthor[a].amt+=Number(e.hours)*Number(e.rate); byAuthor[a].count++;
    });
    var allStaff=ST.contacts.filter(function(c){return c.email;});
    var to=allStaff.map(function(c){return c.email;}).join(', ');
    A._openMailto({type:'tsSummary',to:to,subject:'Billing Summary — '+firmName+' — '+totalH.toFixed(1)+'h / $'+totalAmt.toFixed(2),
      entries:fe,totalH:totalH,totalAmt:totalAmt,fromUser:fromUser,firmName:firmName,byAuthor:byAuthor});
  }

};

function buildEntRow(e,s){
  var cl=ST.clients.find(function(c){return c.id==e.clientId;});
  var mt=ST.matters.find(function(m){return m.id==e.matterId;});
  var ct=ST.contacts.find(function(c){return c.id==e.contactId;});
  var amt=(Number(e.hours)*Number(e.rate)).toFixed(2);
  var vals=[];
  if(s.tc_date)   vals.push(e.date);
  if(s.tc_client) vals.push(cl?cl.name:'');
  if(s.tc_matter) vals.push(mt?mt.name:'General');
  if(s.tc_team)   vals.push(ct?ct.name:'');
  if(s.tc_desc)   vals.push(e.description||'');
  if(s.tc_hours)  vals.push(e.hours);
  if(s.tc_rate)   vals.push(e.rate);
  if(s.tc_amount) vals.push(amt);
  if(s.tc_by)     vals.push(e.createdBy||'');
  return vals;
}

// Timer stop helper
function stopTmr(){
  if(ST.tmrOn){ST.tmrMs+=Date.now()-ST.tmrStart;ST.tmrOn=false;}
  clearInterval(ST.tmrIv);
}

// Value getter
function g(id){var el=document.getElementById(id);return el?el.value:'';}

// === CHANGE DELEGATION ===
// Sync form state BEFORE any dropdown-triggered re-render so typed values survive
// === CHANGE DELEGATION
document.addEventListener('change',function(e){
  var id=e.target.id;
  // Always sync current form state first
  syncForm();
  if(id==='ef-cl'){
    ST.ef.clientId=e.target.value; ST.ef.matterId='';
    // Only auto-fill rate if the rate field is empty
    if(!ST.ef.rate){var r=autoRate(e.target.value,'',ST.ef.contactId||'');if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='ef-ma'){
    ST.ef.matterId=e.target.value;
    if(!ST.ef.rate){var r=autoRate(ST.ef.clientId||'',e.target.value,ST.ef.contactId||'');if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='ef-ct'){
    ST.ef.contactId=e.target.value;
    if(!ST.ef.rate){var r=autoRate(ST.ef.clientId||'',ST.ef.matterId||'',e.target.value);if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='mf-cl'){
    ST.mf.clientId=e.target.value; ST.mf.linkedClientPeopleIds=[]; render();
  }
  else if(id==='cf-ct'){
    var val=e.target.value;
    if(!val) return;
    syncForm();
    var ids=ST.cf.contactIds||[];
    if(!ids.some(function(x){return x==Number(val);}))ST.cf.contactIds=ids.concat([Number(val)]);
    render();
  }
  // Invoice form: update matter dropdown when client changes
  else if(id==='inv-cl'){
    if(ST.invf) ST.invf.clientId=e.target.value;
    render();
  }
  else if(id==='inv-mt'){
    if(ST.invf) ST.invf.matterId=e.target.value;
    render();
  }
  // Partner review form: checkbox re-render for live highlight
  else if(id==='pref-inv'){
    A.syncPartnerReview();
    render();
  }
});

// Enter key in user prompt
document.addEventListener('keydown',function(e){
  if(e.key==='Enter'&&ST.modal==='up') A.saveUser();
});

// === INIT
(function(){
  Promise.all([
    Store.getMeta('user'),
    Store.getAll('clients'),
    Store.getAll('matters'),
    Store.getAll('entries'),
    Store.getAll('contacts'),
    Store.getMeta('prefs'),
    Store.getMeta('descpresets'),
    Store.getMeta('mailpresets'),
    Store.getMeta('itmode'),
    Store.getAll('invoices'),
    Store.getAll('emailtemplates')
  ]).then(function(res){
    // res values are already parsed native JS objects — no JSON.parse needed
    try{if(res[0])ST.user=res[0];}catch(e){}
    try{if(res[1]&&res[1].length)ST.clients=res[1];}catch(e){}
    // Backfill IDs on existing clientPeople that predate this feature
    ST.clients=ST.clients.map(function(c){
      if(!c.clientPeople||!c.clientPeople.length) return c;
      var needsFix=c.clientPeople.some(function(p){return !p.id;});
      if(!needsFix) return c;
      return Object.assign({},c,{clientPeople:c.clientPeople.map(function(p){return p.id?p:Object.assign({id:uid()},p);})});
    });
    try{if(res[2]&&res[2].length)ST.matters=res[2];}catch(e){}
    try{if(res[3]&&res[3].length)ST.entries=res[3];}catch(e){}
    try{if(res[4]&&res[4].length)ST.contacts=res[4];}catch(e){}
    // Ensure the logged-in user appears in contacts
    if(ST.user&&ST.user.name){
      var hasUserCt=ST.contacts.some(function(c){return c.isUser;});
      if(!hasUserCt){
        var ini2=ST.user.initials||ST.user.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
        ST.contacts=ST.contacts.concat([{id:uid(),name:ST.user.name,role:ST.user.role||'',email:ST.user.email||'',phone:ST.user.phone||'',rate:ST.user.rate||'',ownPct:ST.user.ownPct!=null?ST.user.ownPct:100,isUser:true,createdBy:ST.user.name,createdByIni:ini2}]);
      }
    }
    try{if(res[5])ST.prefs=Object.assign({appName:'SixMinuteLog.com',darkMode:null,layout:'comfortable'},res[5]);}catch(e){}
    try{if(res[6])ST.descPresets=res[6];}catch(e){}
    try{if(res[7])ST.mailPresets=res[7];}catch(e){}
    try{if(res[8]){ST.itMode=!!res[8].itMode;if(res[8].firmProfile)ST.firmProfile=res[8].firmProfile;}}catch(e){}
    try{if(res[9]&&res[9].length)ST.invoices=res[9];}catch(e){}
    try{if(res[10]&&res[10].length)ST.emailTemplates=res[10];}catch(e){}
    applyPrefs();
    if(!ST.user){
      // First run: show profile import prompt
      ST._splashMode=true; ST.modal='profileImport';
    }
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    render();
  }).catch(function(err){
    console.warn('Init error:',err);
    applyPrefs();
    ST._splashMode=true; ST.modal='profileImport';
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    render();
  });
})();

window.A=A; window.fmtCur=fmtCur;
</script>
</body>
</html>
