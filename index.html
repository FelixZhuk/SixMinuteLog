<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20rx%3D%226%22%20fill%3D%22%231d4ed8%22%2F%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%2211%22%20fill%3D%22%23ffffff%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%221%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%227.5%22%20x2%3D%2216%22%20y2%3D%225.5%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%222.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2224.5%22%20y1%3D%2216%22%20x2%3D%2226.5%22%20y2%3D%2216%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2224.5%22%20x2%3D%2216%22%20y2%3D%2226.5%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%227.5%22%20y1%3D%2216%22%20x2%3D%225.5%22%20y2%3D%2216%22%20stroke%3D%22%2393c5fd%22%20stroke-width%3D%221.2%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2216%22%20x2%3D%2211.2%22%20y2%3D%2213.2%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%222.4%22%20stroke-linecap%3D%22round%22%2F%3E%3Cline%20x1%3D%2216%22%20y1%3D%2216%22%20x2%3D%2222.9%22%20y2%3D%2212.0%22%20stroke%3D%22%231e3a8a%22%20stroke-width%3D%221.8%22%20stroke-linecap%3D%22round%22%2F%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%221.8%22%20fill%3D%22%231e3a8a%22%2F%3E%3C%2Fsvg%3E">
<title>SixMinuteLog.com</title>
<style>
:root{
  --bg:#f8fafc;--white:#fff;--border:#e2e8f0;--border-l:#f1f5f9;
  --ink:#0f172a;--ink2:#475569;--ink3:#94a3b8;
  --green:#16a34a;--blue:#2563eb;--red:#dc2626;--amber:#d97706;--purple:#7c3aed;
  --r:10px;--sh:0 1px 3px rgba(0,0,0,.1);--sh-lg:0 10px 30px rgba(0,0,0,.18);
  /* Layout sizing */
  --space-sm:14px;--space-md:20px;--space-lg:24px;
  --card-pad:18px;--fbox-pad:22px;--field-pad:9px 13px;
  /* Shorthand aliases */
  --brd:#e2e8f0;--bg2:#f1f5f9;--blue-pale:#eff6ff;
}

/* == Dark Mode == */
body.dark{
  --bg:#0f172a;--white:#1e293b;--border:#334155;--border-l:#1e293b;
  --ink:#f1f5f9;--ink2:#94a3b8;--ink3:#475569;
  --green:#22c55e;--blue:#3b82f6;--red:#ef4444;--amber:#f59e0b;--purple:#a78bfa;
  --sh:0 1px 3px rgba(0,0,0,.4);--sh-lg:0 10px 30px rgba(0,0,0,.6);
  --brd:#334155;--bg2:#1e293b;--blue-pale:#172554;
}
body.dark .header{background:#1e293b}
body.dark .fbox{background:#1e2d40}
body.dark .fl input,body.dark .fl select,body.dark .fl textarea{background:#0f172a;color:var(--ink)}
body.dark .fl input.err,body.dark .fl select.err{background:#300}
body.dark .btn-gh{background:var(--white);color:var(--ink)}
body.dark .btn-gh:hover{background:#2d3f55}
body.dark .btn-ic{background:#263347;color:var(--ink);border-color:#3d5068}
body.dark .btn-ic:hover{background:#2d3f55}
body.dark .btn-dk{background:#3b82f6;color:#fff;border-color:#3b82f6}
body.dark .btn-dk:hover{background:#2563eb;border-color:#2563eb}
body.dark .btn-gr{background:#16a34a;color:#fff;border-color:#16a34a}
body.dark .btn-rd{background:#dc2626;color:#fff;border-color:#dc2626}
body.dark #fab{background:#3b82f6;color:#fff}
body.dark .sc{background:var(--white)}
body.dark .twrap{background:var(--white)}
body.dark thead tr{background:#162032}
body.dark tr:hover td{background:#1a2b3f}
body.dark .card{background:var(--white)}
body.dark .preset-btn{background:var(--white)}
body.dark .crow{background:var(--white)}
body.dark .up-box{background:#1e293b}
body.dark .exp-name-preview{background:#162032;color:var(--blue);border-color:#2563eb44}
body.dark .danger{background:#300a0a;border-color:#7f1d1d}
body.dark .note{background:#422006;border-color:#78350f;color:#fcd34d}
body.dark .good{background:#052e16;border-color:#14532d;color:#4ade80}
body.dark .role-notice{background:#1e2d4f;border-color:#2563eb44;color:#93c5fd}
body.dark .total-pill{background:#052e16;border-color:#14532d;color:#4ade80}
body.dark .appr-panel{background:var(--white)}
body.dark .help-body{color:var(--ink)}
body.dark .help-nav button{color:var(--ink2)}
body.dark .help-nav button.on{background:#162032;color:var(--ink)}
body.dark #loading{background:#0f172a;color:var(--ink2)}
body.dark .desc-chip{background:#162032;border-color:#334155;color:var(--ink2)}
body.dark .desc-chip:hover{background:#1e3a5f;color:var(--ink)}
body.dark .mail-preset-card{background:var(--white);border-color:var(--border)}
body.dark select{background:#1e293b;color:var(--ink);border-color:var(--border)}
body.dark .fab-tog{background:#334155}

/* == Layout Sizes == */
body.layout-compact{--space-sm:10px;--space-md:14px;--space-lg:16px;--card-pad:12px;--fbox-pad:16px;--field-pad:7px 11px;font-size:13px}
body.layout-compact .main{padding:16px 14px}
body.layout-compact .card{padding:var(--card-pad)}
body.layout-compact .fbox{padding:var(--fbox-pad)}
body.layout-compact .fl input,.layout-compact .fl select,.layout-compact .fl textarea{padding:var(--field-pad);font-size:12px}
body.layout-compact th,body.layout-compact td{padding:7px 10px;font-size:12px}
body.layout-compact .btn{padding:7px 12px;font-size:12px}
body.layout-compact .sc{padding:10px 14px}
body.layout-compact .sc-val{font-size:1.2rem}
body.layout-compact .srow{gap:8px;margin-bottom:14px}
body.layout-compact .modal-bd{padding:16px 18px}

body.layout-spacious{--space-sm:18px;--space-md:28px;--space-lg:32px;--card-pad:26px;--fbox-pad:30px;--field-pad:12px 16px;font-size:15px}
body.layout-spacious .main{padding:32px 28px}
body.layout-spacious .card{padding:var(--card-pad)}
body.layout-spacious .fbox{padding:var(--fbox-pad)}
body.layout-spacious .fl input,.layout-spacious .fl select,.layout-spacious .fl textarea{padding:var(--field-pad);font-size:14px}
body.layout-spacious th,body.layout-spacious td{padding:13px 18px;font-size:14px}
body.layout-spacious .btn{padding:11px 20px;font-size:14px}
body.layout-spacious .sc{padding:18px 24px}
body.layout-spacious .sc-val{font-size:1.6rem}
body.layout-spacious .srow{gap:16px;margin-bottom:26px}

/* == Description Chips == */
.desc-chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:7px;margin-bottom:2px}
.desc-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:#f1f5f9;border:1px solid var(--border);border-radius:16px;font-size:11px;color:var(--ink2);cursor:pointer;transition:all .15s}
.desc-chip:hover{background:#e2e8f0;color:var(--ink);border-color:var(--ink3)}
.desc-chip svg{opacity:.6}

/* == Mail Preset Cards == */
.mail-preset-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;position:relative}
.mail-preset-card h4{font-size:13px;font-weight:500;margin-bottom:6px;color:var(--ink)}
.mail-preset-card p{font-size:11px;color:var(--ink3);margin-bottom:2px}
.mail-preset-card .mp-acts{position:absolute;top:10px;right:10px;display:flex;gap:4px}

/* == Preset List Items == */
.preset-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:7px;font-size:13px}
.preset-item span{flex:1;color:var(--ink)}
.preset-item button{padding:4px 6px;border:none;background:transparent;color:var(--ink3);border-radius:4px;cursor:pointer}
.preset-item button:hover{color:var(--red);background:#fef2f2}

/* == Settings Tab Nav == */
.set-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg);padding:4px;border-radius:10px;flex-wrap:wrap}
.set-tab{padding:7px 14px;border:none;background:transparent;border-radius:7px;font-size:12px;font-weight:500;color:var(--ink3);cursor:pointer;transition:all .15s;white-space:nowrap}
.set-tab:hover{color:var(--ink)}
.set-tab.on{background:var(--white);color:var(--ink);box-shadow:var(--sh)}
body.dark .set-tabs{background:#162032}
body.dark .set-tab.on{background:#1e293b}
body.dark .avatar-dark{background:#3b82f6;color:#fff;font-size:1rem}
body.dark .nav-btn{color:var(--ink3)}
body.dark .nav-btn:hover{color:var(--ink)}
body.dark .nav-btn.on{color:var(--ink);border-bottom-color:var(--blue)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--ink);font-size:14px}
input,select,textarea,button{font-family:inherit;font-size:14px}
button{cursor:pointer}

/* Layout */
.header{background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.header-inner{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:8px}
.logo h1{font-size:1.15rem;font-weight:300;color:var(--ink)}
.logo-sub{font-size:11px;color:var(--ink3);margin-top:1px}
.header-btns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.nav{max-width:1200px;margin:0 auto;padding:0 12px;overflow-x:auto;display:flex}
.nav::-webkit-scrollbar{display:none}
.nav-btn{display:flex;align-items:center;gap:6px;padding:10px 14px;border:none;background:transparent;color:var(--ink3);border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;font-size:13px;transition:all .15s}
.nav-btn:hover{color:var(--ink)}.nav-btn.on{color:var(--ink);border-bottom-color:var(--ink);font-weight:500}
.main{max-width:1200px;margin:0 auto;padding:24px 20px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 16px;border-radius:8px;border:1px solid transparent;font-size:13px;font-weight:400;transition:opacity .15s,transform .1s;white-space:nowrap}
.btn:active{transform:scale(.98)}
.btn-dk{background:var(--ink);color:#fff;border-color:var(--ink)}.btn-dk:hover{opacity:.85}
.btn-gr{background:var(--green);color:#fff;border-color:var(--green)}.btn-gr:hover{opacity:.85}
.btn-bl{background:var(--blue);color:#fff;border-color:var(--blue)}.btn-bl:hover{opacity:.85}
.btn-rd{background:var(--red);color:#fff;border-color:var(--red)}.btn-rd:hover{opacity:.85}
.btn-gh{background:var(--white);color:var(--ink2);border-color:var(--border)}.btn-gh:hover{background:var(--bg)}
.btn-ic{padding:8px;border-radius:8px;background:var(--white);border:1px solid var(--border);color:var(--ink2)}.btn-ic:hover{background:var(--bg)}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* Forms */
.fbox{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:18px}
.fbox h3{font-weight:400;font-size:1rem;margin-bottom:18px;color:var(--ink)}
.frow{display:grid;gap:14px;margin-bottom:14px}
.frow.c2{grid-template-columns:1fr 1fr}
.frow.c3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:580px){.frow.c2,.frow.c3{grid-template-columns:1fr}}
.fl label{display:block;font-size:12px;color:var(--ink2);margin-bottom:5px}
.fl label .req{color:var(--red);margin-left:2px}
.fl input,.fl select,.fl textarea{width:100%;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink);outline:none;transition:border .15s}
.fl input:focus,.fl select:focus,.fl textarea:focus{border-color:#94a3b8}
.fl input.err,.fl select.err{border-color:var(--red);background:#fef2f2}
.fl .hint{font-size:11px;color:var(--ink3);margin-top:4px}
.fl .emsg{font-size:11px;color:var(--red);margin-top:4px}
.fl .pw{position:relative}
.fl .pw .pfx{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--ink3);pointer-events:none}
.fl .pw .sfx{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--ink3);pointer-events:none;font-size:12px}
.fl .pw input{padding-left:26px}
.fl .pw input.has-sfx{padding-right:32px}
.fa{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}

/* Cards */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px}
.card-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.avatar{width:42px;height:42px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:1.1rem;border:1px solid var(--border)}
.card-act button{padding:5px;border:none;background:transparent;color:var(--ink3);border-radius:5px}
.card-act button:hover{color:var(--ink);background:var(--bg)}
.card h3{font-weight:500;font-size:.93rem;margin-bottom:3px}
.card p{font-size:12px;color:var(--ink2);margin-bottom:2px;line-height:1.5}
.card-rate{margin-top:10px;padding-top:10px;border-top:1px solid var(--border-l);font-size:12px;color:var(--ink3)}
.card-rate strong{color:var(--ink)}
.chip{display:inline-block;font-size:11px;background:var(--bg);color:var(--ink2);padding:3px 9px;border-radius:20px;border:1px solid var(--border);margin-bottom:8px}
.split-pill{display:inline-flex;gap:5px;font-size:11px;margin-top:6px}
.split-pill .own{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0;padding:2px 8px;border-radius:12px}
.split-pill .firm{background:#fef3c7;color:#92400e;border:1px solid #fde68a;padding:2px 8px;border-radius:12px}

/* Roles & Approval Status */
.status-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:12px;font-size:11px;font-weight:500;white-space:nowrap}
.s-pending{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
.s-approved{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0}
.s-review{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
.s-neutral{background:var(--bg);color:var(--ink3);border:1px solid var(--border)}
.s-rejected{background:#fef2f2;color:#dc2626;border:1px solid #fee2e2}
.role-lbl{display:inline-flex;align-items:center;font-size:11px;padding:2px 9px;border-radius:12px;font-weight:500;border:1px solid}
.rl-partner{background:#f5f3ff;color:#6d28d9;border-color:#ddd6fe}
.rl-attorney{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
.rl-billing{background:#f0fdf4;color:#166534;border-color:#bbf7d0}
.appr-panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:18px}
.appr-panel h3{font-weight:500;font-size:.93rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.role-notice{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:#1e40af;display:flex;align-items:center;gap:10px}

/* Stats */
.srow{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px}
.sc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 18px}
.sc-lbl{font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
.sc-val{font-size:1.4rem;font-weight:300;color:var(--ink)}
.sc.highlight{border-color:#bbf7d0;background:#f0fdf4}.sc.highlight .sc-val{color:#166534}
.sc.highlight2{border-color:#fde68a;background:#fffbeb}.sc.highlight2 .sc-val{color:#92400e}

/* Table */
.twrap{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.tscroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{background:var(--bg);border-bottom:1px solid var(--border)}
th{padding:9px 13px;text-align:left;font-weight:500;color:var(--ink2);font-size:11px;white-space:nowrap;text-transform:uppercase;letter-spacing:.03em}
td{padding:9px 13px;border-bottom:1px solid var(--border-l);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#fafafa}
.tda{display:flex;gap:4px}
.tda button{padding:5px;border:none;background:transparent;color:var(--ink3);border-radius:4px}
.tda button:hover{color:var(--ink);background:var(--bg)}
.badge{width:26px;height:26px;border-radius:50%;background:var(--bg);border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:var(--ink2)}

/* Modals */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:500;padding:16px}
.modal{background:var(--white);border-radius:14px;width:100%;box-shadow:var(--sh-lg);display:flex;flex-direction:column;max-height:90vh}
.modal-sm{max-width:480px}.modal-md{max-width:580px}.modal-lg{max-width:760px}.modal-xl{max-width:1040px}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-hd h2{font-size:1.05rem;font-weight:400}
.modal-bd{overflow-y:auto;padding:22px;flex:1;min-height:0}
.modal-ft{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;flex-shrink:0;flex-wrap:wrap}

/* Toast */
#toasts{position:fixed;top:16px;right:16px;z-index:9000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:11px 18px;border-radius:9px;color:#fff;font-size:13px;box-shadow:var(--sh-lg);animation:tin .25s ease;pointer-events:auto}
.t-ok{background:var(--green)}.t-warn{background:var(--amber)}.t-err{background:var(--red)}
@keyframes tin{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Quick Log */
.ql-timer{background:var(--bg);border-bottom:1px solid var(--border);padding:16px 22px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.timer-num{font-size:2.1rem;font-weight:200;font-family:'Courier New',monospace;letter-spacing:.04em;min-width:115px}
.timer-on{color:var(--ink)}.timer-off{color:var(--ink3)}
.total-pill{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:8px 14px;font-size:13px;color:#15803d;margin-bottom:14px}

/* Help */
.help-lay{display:flex;flex:1;overflow:hidden;min-height:0}
.help-nav{width:162px;flex-shrink:0;border-right:1px solid var(--border-l);padding:10px;overflow-y:auto}
.help-nav button{display:block;width:100%;text-align:left;padding:9px 11px;border:none;background:transparent;border-radius:7px;font-size:13px;color:var(--ink2);cursor:pointer;margin-bottom:2px}
.help-nav button:hover{background:var(--bg);color:var(--ink)}
.help-nav button.on{background:var(--bg);color:var(--ink);font-weight:500}
.help-body{flex:1;overflow-y:auto;padding:22px}
.help-body h3{font-weight:500;margin-bottom:12px}
.help-body h4{font-weight:500;color:var(--ink2);margin:18px 0 7px;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
.help-body p,.help-body li{color:var(--ink2);line-height:1.7;font-size:13px}
.help-body ol,.help-body ul{padding-left:18px}
.help-body li{margin-bottom:4px}
.note{background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:10px 14px;margin-top:14px;font-size:12px;color:#92400e}
.good{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 14px;margin-top:14px;font-size:12px;color:#166534}
.faq-item{border-bottom:1px solid var(--border-l);padding-bottom:14px;margin-bottom:14px}
.faq-item:last-child{border-bottom:none;margin-bottom:0}
.faq-item strong{display:block;color:var(--ink);margin-bottom:4px;font-size:13px}

/* Settings */
.set-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border-l)}
.set-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.set-section h3{font-weight:500;margin-bottom:12px;font-size:.93rem}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.preset-btn{padding:10px 12px;border:2px solid var(--border);border-radius:8px;background:var(--white);cursor:pointer;text-align:left;font-size:12px;transition:border .15s}
.preset-btn:hover{border-color:var(--ink3)}
.preset-btn strong{display:block;color:var(--ink);font-size:13px;margin-bottom:1px}
.crow{display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;margin-bottom:7px}
.crow input[type=checkbox]{width:14px;height:14px;cursor:pointer;flex-shrink:0;margin-top:1px}
.crow strong{display:block;font-size:13px;color:var(--ink)}
.crow span{font-size:11px;color:var(--ink3)}
.sub-checks{padding-left:20px;margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:4px}
.sub-check{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--ink2);cursor:pointer}
.sub-check input{width:13px;height:13px;cursor:pointer}
.danger{background:#fef2f2;border:1px solid #fee2e2;border-radius:8px;padding:14px 16px}
.danger h3{color:var(--red);margin-bottom:7px}
.danger p{color:#ef4444;font-size:12px;line-height:1.5;margin-bottom:12px}
.exp-name-preview{font-size:11px;color:var(--blue);background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:5px 10px;margin-bottom:14px;font-family:monospace}

/* Analytics split table */
.split-table{width:100%;font-size:13px;margin-top:8px}
.split-table th{text-align:left;font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;padding:6px 10px;border-bottom:1px solid var(--border)}
.split-table td{padding:8px 10px;border-bottom:1px solid var(--border-l)}
.split-table tr:last-child td{border-bottom:none;font-weight:500}
.own-amt{color:#166534}.firm-amt{color:#92400e}
.btn-link{background:none;border:none;padding:0;cursor:pointer;color:var(--blue);text-decoration:underline;font-size:inherit;font-family:inherit;}

/* Analytics */
.bar-row{margin-bottom:14px}
.bar-lbl{display:flex;justify-content:space-between;margin-bottom:5px;font-size:13px}
.bar-track{background:var(--bg);border-radius:4px;height:6px}
.bar-fill{background:var(--ink);border-radius:4px;height:6px;transition:width .4s ease}

/* ========== SPLASH SCREEN ========== */
.splash-ov{position:fixed;inset:0;z-index:900;display:flex;align-items:stretch;background:#0f172a;animation:splashIn .25s ease}
@keyframes splashIn{from{opacity:0}to{opacity:1}}

/* Left hero panel */
.splash-hero{width:340px;flex-shrink:0;background:linear-gradient(155deg,#1e3a5f 0%,#0f2040 50%,#0a1628 100%);display:flex;flex-direction:column;justify-content:space-between;padding:44px 40px;position:relative;overflow:hidden}
.splash-hero::before{content:'';position:absolute;top:-80px;right:-80px;width:280px;height:280px;border-radius:50%;background:rgba(59,130,246,.08);pointer-events:none}
.splash-hero::after{content:'';position:absolute;bottom:-60px;left:-60px;width:200px;height:200px;border-radius:50%;background:rgba(37,99,235,.07);pointer-events:none}
.splash-logo{display:flex;align-items:center;gap:12px}
.splash-logo-mark{width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 14px rgba(59,130,246,.4)}
.splash-logo-mark svg{color:#fff}
.splash-logo-name{font-size:1.05rem;font-weight:600;color:#f1f5f9;letter-spacing:-.01em}
.splash-tagline{margin-top:auto;padding-top:60px}
.splash-tagline h1{font-size:1.85rem;font-weight:300;color:#f1f5f9;line-height:1.25;margin-bottom:14px;letter-spacing:-.02em}
.splash-tagline h1 strong{font-weight:600;color:#fff}
.splash-tagline p{font-size:13px;color:#94a3b8;line-height:1.65}
.splash-steps{margin-top:40px;display:flex;flex-direction:column;gap:8px}
.splash-step{display:flex;align-items:center;gap:10px;font-size:12px;color:#475569;transition:color .2s}
.splash-step.active{color:#93c5fd}
.splash-step.done{color:#34d399}
.splash-step-dot{width:6px;height:6px;border-radius:50%;background:#334155;flex-shrink:0;transition:background .2s}
.splash-step.active .splash-step-dot{background:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
.splash-step.done .splash-step-dot{background:#10b981}

/* Right form panel */
.splash-form{flex:1;background:var(--white);display:flex;flex-direction:column;overflow-y:auto}
.splash-form-inner{flex:1;padding:52px 52px 36px;max-width:520px}
.splash-form-inner h2{font-size:1.5rem;font-weight:300;color:var(--ink);margin-bottom:6px;letter-spacing:-.02em}
.splash-form-inner h2 strong{font-weight:600}
.splash-form-inner .sub{font-size:13px;color:var(--ink2);line-height:1.6;margin-bottom:28px}
.splash-footer{padding:20px 52px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--white)}
.splash-footer-note{font-size:11px;color:var(--ink3)}

/* Profile option cards */
.splash-opt{display:flex;align-items:center;gap:16px;padding:18px 20px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s,background .15s;margin-bottom:12px;background:var(--white)}
.splash-opt:hover{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--blue-pale)}
.splash-opt-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.splash-opt-icon.blue{background:#eff6ff;color:var(--blue)}
.splash-opt-icon.slate{background:var(--bg);color:var(--ink2)}
.splash-opt-body{flex:1}
.splash-opt-body strong{display:block;font-size:14px;font-weight:600;color:var(--ink);margin-bottom:3px}
.splash-opt-body span{font-size:12px;color:var(--ink2);line-height:1.5}
.splash-opt-arrow{color:var(--ink3);flex-shrink:0}

/* Feature list */
.splash-features{background:var(--bg);border-radius:10px;padding:16px 18px;margin-bottom:22px}
.splash-features-title{font-size:11px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}
.splash-feature{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--ink2);padding:5px 0;border-bottom:1px solid var(--border-l)}
.splash-feature:last-child{border-bottom:none}
.splash-feature-dot{width:6px;height:6px;border-radius:50%;background:var(--blue);flex-shrink:0}

/* User select cards */
.splash-user-card{display:flex;align-items:center;gap:14px;padding:14px 18px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s,background .15s;margin-bottom:10px;background:var(--white)}
.splash-user-card:hover{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--blue-pale)}
.splash-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;letter-spacing:.01em}
.splash-user-info strong{display:block;font-size:13px;font-weight:600;color:var(--ink)}
.splash-user-info span{font-size:11px;color:var(--ink3)}

/* Role selector */
.splash-roles{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
.splash-role{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:1.5px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s;background:var(--white)}
.splash-role:hover{border-color:var(--blue);background:var(--blue-pale)}
.splash-role.sel{border-color:var(--blue);background:var(--blue-pale);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.splash-role-radio{width:16px;height:16px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;margin-top:2px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.splash-role.sel .splash-role-radio{border-color:var(--blue);background:var(--blue)}
.splash-role.sel .splash-role-radio::after{content:'';width:6px;height:6px;border-radius:50%;background:#fff;display:block}
.splash-role-body strong{display:block;font-size:13px;font-weight:600;color:var(--ink);margin-bottom:2px}
.splash-role-body span{font-size:11px;color:var(--ink2);line-height:1.5}

/* Dark mode overrides */
body.dark .splash-form,body.dark .splash-footer{background:#1e293b}
body.dark .splash-opt,body.dark .splash-user-card,body.dark .splash-role{background:#1e293b;border-color:#334155}
body.dark .splash-opt:hover,body.dark .splash-user-card:hover,body.dark .splash-role:hover{background:#172554;border-color:#3b82f6}
body.dark .splash-role.sel{background:#172554;border-color:#3b82f6}
body.dark .splash-opt-icon.slate{background:#263347}
body.dark .splash-features{background:#263347}

/* Legacy up-wrap kept for chgUser (non-first-run profile edit) */
.up-wrap{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:900;padding:16px}
.up-box{background:var(--white);border-radius:16px;padding:38px;max-width:460px;width:100%;box-shadow:var(--sh-lg);max-height:90vh;overflow-y:auto}
.up-icon{width:52px;height:52px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:22px}
.up-box h2{font-size:1.6rem;font-weight:300;margin-bottom:8px}
.up-box p{font-size:13px;color:var(--ink2);margin-bottom:24px;line-height:1.6}

/* Responsive splash */
@media(max-width:720px){
  .splash-ov{flex-direction:column}
  .splash-hero{width:auto;padding:28px 24px 24px;flex-direction:row;align-items:center;gap:20px}
  .splash-tagline,.splash-steps{display:none}
  .splash-form-inner{padding:28px 22px 20px}
  .splash-footer{padding:16px 22px}
}

/* FAB */
#fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:var(--ink);color:#fff;border:none;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:200;cursor:pointer;transition:transform .15s}
#fab:hover{transform:scale(1.1)}

/* Empty */
.empty{text-align:center;padding:60px 20px;color:var(--ink3)}
.empty-ico{font-size:2.5rem;margin-bottom:12px}
.empty p{font-weight:300;font-size:.95rem}
.empty small{font-size:12px;margin-top:4px;display:block}

/* Loading */
#loading{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);flex-direction:column;gap:12px;color:var(--ink3);font-size:1rem;font-weight:300}

/* Invoice */
@media print{
  .header,.nav,.header-btns,button,.modal-hd,.modal-ft,.tda,.fab{display:none!important}
  .modal,.ov{position:static!important;background:transparent!important;padding:0!important}
  #inv-print-wrap{margin:0!important;box-shadow:none!important;max-width:100%!important}
  body{background:#fff!important;color:#000!important}
}
</style>
</head>
<body>
<script>
// Anti-FOUC: apply dark mode and layout before first paint
(function(){
  try{
    var p=JSON.parse(localStorage.getItem('bl-prefs')||'{}');
    var dm=p.darkMode===undefined?null:p.darkMode;
    var sysDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(dm===true||(dm===null&&sysDark)) document.body.classList.add('dark');
    if(p.layout&&p.layout!=='comfortable') document.body.classList.add('layout-'+p.layout);
    if(p.appName){
      document.title=p.appName;
      // Update loading text too
      document.addEventListener('DOMContentLoaded',function(){
        var ldiv=document.getElementById('loading');
        if(ldiv&&p.appName){ var t=ldiv.querySelector('div:last-child'); if(t) t.textContent='Loading '+p.appName+'...'; }
      });
    }
  }catch(e){}
})();
</script>
<div id="loading"><div style="font-size:2rem">&#9878;&#65039;</div><div>Loading SixMinuteLog.com...</div></div>
<div id="toasts"></div>
<button id="fab" onclick="A.openQL()" title="Quick Log"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></button>
<div id="app" style="display:none"></div>

<script>
// +============================================================+
// |  SixMinuteLog.com -- CLAUDE MANIFEST                         |
// |  AI: read CLAUDE_BILLING.md first, then view line ranges.  |
// +------------------------------------------------------------+
// |  SECTION MAP (Ctrl+F these strings):                       |
// |  "// === STORAGE"       Store.get/set/del                  |
// |  "// === STATE"         ST object                          |
// |  "// === HELPERS"       uid,today,$m,$h,H,autoRate,syncForm|
// |  "// === SAVE"          save() persist                     |
// |  "// === TOAST"         toast(msg,type)                    |
// |  "// === ICONS"         IC object SVG strings              |
// |  "// === FIELD BUILDER" field(), stats()                   |
// |  "// === EXPORT FILENAME" exportFilename()                 |
// |  "// === VIEWS"         tab view functions                 |
// |  "// === MODALS"        modal builder functions            |
// |  "// === MAIN RENDER"   TABS[], views{}, render()          |
// |  "// === ACTIONS"       A object user actions              |
// |  "// === CHANGE DELEGATION" onchange handler               |
// |  "// === INIT"          startup loading                    |
// +------------------------------------------------------------+
// |  ADD TAB:   IC + TABS[] + view fn + views{} in render()   |
// |  ADD MODAL: build fn + else-if render() + open action     |
// |  ADD DATA:  ST + save() + INIT Promise.all load           |
// |  ALWAYS: syncForm() before render() / H() on user data    |
// +============================================================+

// === STORAGE  (IndexedDB — proper per-collection object stores)
//
// Schema (v3):
//   clients, matters, entries, contacts, invoices  →  keyPath:'id'  (one record per item)
//   meta                                           →  keyPath:'k'   (singletons: user,prefs,…)
//
// Public API:
//   Store.getAll(name)              → Promise<array>   read all records in a collection
//   Store.putRecord(name, rec)      → Promise          upsert one record (SAFE — no clear)
//   Store.deleteRecord(name, id)    → Promise          delete one record by id
//   Store.putBatch(name, arr)       → Promise          upsert many records (NO clear — safe)
//   Store.syncCollection(name,arr)  → Promise          upsert batch + delete IDs not in arr
//   Store.getMeta(key)              → Promise<any|null>
//   Store.setMeta(key, val)         → Promise
//   Store.clearData()               → Promise          wipe all stores (reset only)
//
// NOTE: saveAll (clear+putAll) has been REMOVED. All writes are additive upserts.
//       Deletions must be explicit via deleteRecord or syncCollection.
//
// bl-prefs is ALSO mirrored to localStorage so the synchronous anti-FOUC block (above)
// can read it before IndexedDB resolves.  No other data touches localStorage.
const Store=(function(){
  var _db=null;
  var DB_NAME='SixMinuteLog';
  var DB_VER=4;
  var COLLECTIONS=['clients','matters','entries','contacts','invoices'];
  var COLL_SET={clients:1,matters:1,entries:1,contacts:1,invoices:1};
  var META_KEYS=['user','prefs','descpresets','mailpresets','mailplaceholders','itmode'];

  function _open(){
    if(_db) return Promise.resolve(_db);
    return new Promise(function(resolve,reject){
      var req=indexedDB.open(DB_NAME,DB_VER);

      req.onupgradeneeded=function(e){
        var db=e.target.result;
        var tx=e.target.transaction;
        var oldV=e.oldVersion;

        // ── Create object stores (idempotent) ──
        COLLECTIONS.forEach(function(name){
          if(!db.objectStoreNames.contains(name))
            db.createObjectStore(name,{keyPath:'id'});
        });
        if(!db.objectStoreNames.contains('meta'))
          db.createObjectStore('meta',{keyPath:'k'});

        // ── v4: Add date index on entries for efficient range queries ──
        var entriesOS = tx.objectStore('entries');
        if(!entriesOS.indexNames.contains('dateIdx'))
          entriesOS.createIndex('dateIdx','date',{unique:false});

        // ── Migrate from v1 kv-blob store ──
        if(oldV===1 && db.objectStoreNames.contains('kv')){
          var kvReq=tx.objectStore('kv').getAll();
          kvReq.onsuccess=function(){
            var metaOS=tx.objectStore('meta');
            (kvReq.result||[]).forEach(function(item){
              var rawKey=item.k.replace(/^bl-/,'');
              var parsed;
              try{parsed=JSON.parse(item.v);}catch(e2){return;}
              if(COLL_SET[rawKey]&&Array.isArray(parsed)){
                var os2=tx.objectStore(rawKey);
                parsed.forEach(function(rec){if(rec&&rec.id!=null)os2.put(rec);});
              } else {
                metaOS.put({k:rawKey,v:parsed});
              }
            });
            tx.objectStore('kv').clear();
          };
        } else if(oldV===0){
          // Fresh install: migrate from localStorage
          var metaOS2=tx.objectStore('meta');
          META_KEYS.forEach(function(k){
            var v=localStorage.getItem('bl-'+k);
            if(v){try{metaOS2.put({k:k,v:JSON.parse(v)});}catch(e2){}}
          });
          COLLECTIONS.forEach(function(name){
            var v=localStorage.getItem('bl-'+name);
            if(v){
              try{
                var arr=JSON.parse(v);
                var os3=tx.objectStore(name);
                if(Array.isArray(arr))arr.forEach(function(r){if(r&&r.id!=null)os3.put(r);});
              }catch(e2){}
            }
          });
          try{localStorage.setItem('bl-idb-migrated','1');}catch(e2){}
          ['bl-user','bl-clients','bl-matters','bl-entries','bl-contacts',
           'bl-descpresets','bl-mailpresets','bl-itmode','bl-invoices']
            .forEach(function(k){try{localStorage.removeItem(k);}catch(e2){}});
        }
      };

      req.onsuccess=function(e){_db=e.target.result;resolve(_db);};
      req.onerror=function(e){reject(e.target.error);};
      req.onblocked=function(){console.warn('IDB open blocked — close other tabs');};
    });
  }

  // Internal: run a readwrite transaction and resolve when complete
  function _tx(stores, fn){
    return _open().then(function(db){
      return new Promise(function(resolve,reject){
        var storeList=Array.isArray(stores)?stores:[stores];
        var tx=db.transaction(storeList,'readwrite');
        tx.oncomplete=function(){resolve();};
        tx.onerror=function(e){console.warn('Store tx error',e);resolve();};
        tx.onabort=function(e){console.warn('Store tx abort',e);resolve();};
        try{ fn(tx); }catch(err){console.warn('Store tx fn error',err);resolve();}
      });
    }).catch(function(e){console.warn('Store._tx catch',e);});
  }

  return{
    // ── Read ──
    getAll:function(name){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction(name,'readonly').objectStore(name).getAll();
          req.onsuccess=function(){resolve(req.result||[]);};
          req.onerror=function(){resolve([]);};
        });
      }).catch(function(){return[];});
    },

    // ── Single-record upsert (safe: no clear, atomic) ──
    putRecord:function(name,rec){
      if(!rec||rec.id==null){console.warn('Store.putRecord: invalid record',name,rec);return Promise.resolve();}
      return _tx(name,function(tx){tx.objectStore(name).put(rec);});
    },

    // ── Single-record delete (safe, atomic) ──
    deleteRecord:function(name,id){
      if(id==null){return Promise.resolve();}
      return _tx(name,function(tx){tx.objectStore(name).delete(id);});
    },

    // ── Batch upsert WITHOUT clearing — safe even if interrupted ──
    putBatch:function(name,arr){
      if(!arr||!arr.length)return Promise.resolve();
      return _tx(name,function(tx){
        var os=tx.objectStore(name);
        arr.forEach(function(rec){if(rec&&rec.id!=null)os.put(rec);});
      });
    },

    // ── Full sync: upsert all records, delete IDs no longer in arr ──
    // Use this for imports or bulk replace — never in normal edit flows.
    syncCollection:function(name,arr){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var tx=db.transaction(name,'readwrite');
          var os=tx.objectStore(name);
          // Build set of incoming IDs
          var incoming={};
          (arr||[]).forEach(function(r){if(r&&r.id!=null)incoming[r.id]=r;});
          // Read existing IDs, delete ones not in incoming
          var getAllReq=os.getAll();
          getAllReq.onsuccess=function(){
            (getAllReq.result||[]).forEach(function(existing){
              if(!incoming[existing.id]) os.delete(existing.id);
            });
            // Put all incoming
            Object.values(incoming).forEach(function(r){os.put(r);});
          };
          tx.oncomplete=function(){resolve();};
          tx.onerror=function(e){console.warn('Store.syncCollection',name,e);resolve();};
        });
      }).catch(function(){});
    },

    // ── Legacy alias (now uses syncCollection — safe upsert+prune) ──
    // Kept so any external code referencing saveAll still works.
    saveAll:function(name,arr){return this.syncCollection(name,arr);},

    // ── Efficient date-range query on entries (uses IDB dateIdx index) ──
    // from / to are 'YYYY-MM-DD' strings (inclusive). Pass '' / '' for all.
    getEntriesInRange:function(from, to){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var tx=db.transaction('entries','readonly');
          var idx=tx.objectStore('entries').index('dateIdx');
          var range;
          if(from && to)      range=IDBKeyRange.bound(from, to);
          else if(from)        range=IDBKeyRange.lowerBound(from);
          else if(to)          range=IDBKeyRange.upperBound(to);
          var req=range ? idx.getAll(range) : idx.getAll();
          req.onsuccess=function(){resolve(req.result||[]);};
          req.onerror=function(){resolve([]);};
        });
      }).catch(function(){return[];});
    },

    // ── Total entries count (no data transfer) ──
    countEntries:function(){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction('entries','readonly').objectStore('entries').count();
          req.onsuccess=function(){resolve(req.result||0);};
          req.onerror=function(){resolve(0);};
        });
      }).catch(function(){return 0;});
    },

    // ── Explicit full entries load (analytics, export, invoice) ──
    getAllEntries:function(){return this.getAll('entries');},

    // ── Singleton metadata ──
    getMeta:function(key){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var req=db.transaction('meta','readonly').objectStore('meta').get(key);
          req.onsuccess=function(){resolve(req.result?req.result.v:null);};
          req.onerror=function(){resolve(null);};
        });
      }).catch(function(){return null;});
    },
    setMeta:function(key,val){
      if(key==='prefs'){try{localStorage.setItem('bl-prefs',JSON.stringify(val));}catch(e){}}
      return _tx('meta',function(tx){tx.objectStore('meta').put({k:key,v:val});});
    },

    // ── Wipe everything (reset only) ──
    clearData:function(){
      return _open().then(function(db){
        return new Promise(function(resolve){
          var all=COLLECTIONS.concat(['meta']);
          var tx=db.transaction(all,'readwrite');
          all.forEach(function(name){tx.objectStore(name).clear();});
          tx.oncomplete=function(){resolve();};
          tx.onerror=function(){resolve();};
        });
      }).catch(function(){});
    }
  };
})();

// === STATE
var ST={
  tab:'timesheet',
  clients:[],matters:[],entries:[],contacts:[],
  invoices:[],
  user:null,
  settings:{
    // sections
    te:true,cl:true,ma:true,co:true,su:true,split:false,
    // time entry columns
    tc_date:true,tc_client:true,tc_matter:true,tc_team:true,
    tc_desc:true,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false,
    // date range for export (empty = all)
    expFrom:'',expTo:'',
    // per-client grouping
    te_group:false
  },
  // Appearance & customization preferences (persisted in bl-prefs)
  prefs:{
    appName:'SixMinuteLog.com',
    darkMode:null,
    layout:'comfortable',
    revenueSplit:false
  },
  // User-defined description suggestions shown as chips in entry forms (bl-descpresets)
  descPresets:[
    'Legal research and analysis',
    'Drafted correspondence',
    'Client consultation',
    'Court appearance / hearing',
    'Document review',
    'Contract drafting / review',
    'Phone conference with client',
    'Filed documents with court',
    'Deposition preparation',
    'Settlement negotiation'
  ],
  // Mail presets for emailing exported CSV (bl-mailpresets)
  mailPresets:[],
  // Custom/editable email placeholders
  mailPlaceholders:[],
  modal:null,editId:null,helpTab:'start',settingsTab:'export',
  tsFilter:'all',anFilter:'month',
  // Timesheet extra filters/sort
  tsClientFilter:'',tsMatterFilter:'',tsSort:'date-desc',
  // Clients sort
  clSort:'alpha',clSearch:'',
  // Matters group/filter/sort
  maGroup:false,maClientFilter:'',maSort:'alpha',maSearch:'',
  // Contacts sort/search
  ctSort:'alpha',ctSearch:'',
  tmrOn:false,tmrStart:0,tmrMs:0,tmrIv:null,
  ef:{},cf:{},mf:{},ctf:{},ql:{},
  mpf:{},
  // Pagination (timesheet)
  tsPage:0,
  TS_PAGE_SIZE:50,
  // Entries loading tier:
  //   'partial' = only loaded YEAR_START … today (default, fast startup)
  //   'full'    = all entries loaded (triggered by "All Time" or analytics)
  _entriesMode:'partial',
  _totalEntryCount:0,  // from IDB count() — used to show "X of Y entries"
  // Invoice form and review state
  invf:{},invRev:{invoiceId:null,cuts:{},mergeGroup:{},comments:{},pendingMerge:[]},
  invFilter:'all',invPrintId:null,
  // IT Mode - admin profile management
  itMode:false,
  firmProfile:{
    firmName:'',
    appName:'SixMinuteLog.com',
    clients:[],
    matters:[],
    contacts:[],
    descPresets:[],
    users:[],   // pre-configured user profiles for new installs
    settings:{}
  },
  itf:{},  // IT admin form state
  firstRun:false,  // true if no user set on init
  pref:{}   // partner review entry form state
};

// === HELPERS
var _uid=1;
function uid(){return Date.now()*1000+(_uid++);}
function today(){return new Date().toISOString().split('T')[0];}

// ABA/UTBMS Uniform Task-Based Management System codes
var ABA_TASK_CODES=[
  {v:'',l:'-- No ABA Task Code --'},
  // Case Assessment, Development and Administration
  {v:'L110',l:'L110 – Fact Investigation/Development'},
  {v:'L120',l:'L120 – Analysis/Strategy'},
  {v:'L130',l:'L130 – Experts/Consultants'},
  {v:'L140',l:'L140 – Document/File Management'},
  {v:'L150',l:'L150 – Budgeting'},
  {v:'L160',l:'L160 – Settlement/Non-Binding ADR'},
  {v:'L190',l:'L190 – Other Case Assessment'},
  // Pre-Trial Pleadings
  {v:'L210',l:'L210 – Pleadings'},
  {v:'L220',l:'L220 – Preliminary Injunctions/Provisional Remedies'},
  {v:'L230',l:'L230 – Court Mandated Conferences'},
  {v:'L240',l:'L240 – Dispositive Motions'},
  {v:'L250',l:'L250 – Other Written Motions/Submissions'},
  {v:'L260',l:'L260 – Class Action Certification'},
  // Discovery
  {v:'L310',l:'L310 – Written Discovery'},
  {v:'L320',l:'L320 – Document Production'},
  {v:'L330',l:'L330 – Depositions'},
  {v:'L340',l:'L340 – Expert Discovery'},
  {v:'L350',l:'L350 – Discovery Motions'},
  {v:'L360',l:'L360 – Other Discovery'},
  // Trial Preparation and Trial
  {v:'L410',l:'L410 – Fact Witnesses at Trial'},
  {v:'L420',l:'L420 – Expert Witnesses'},
  {v:'L430',l:'L430 – Jury Issues'},
  {v:'L440',l:'L440 – Preparing Trial Exhibits'},
  {v:'L450',l:'L450 – Trial/Hearing Attendance'},
  {v:'L460',l:'L460 – Post-Trial Motions/Submissions'},
  // Appeals
  {v:'L510',l:'L510 – Appellate Motions/Submissions'},
  {v:'L520',l:'L520 – Appellate Briefs'},
  {v:'L530',l:'L530 – Oral Argument'},
  // Transactional / Counseling
  {v:'A101',l:'A101 – Plan and Prepare For'},
  {v:'A102',l:'A102 – Research'},
  {v:'A103',l:'A103 – Draft/Revise'},
  {v:'A104',l:'A104 – Review/Analyze'},
  {v:'A105',l:'A105 – Communicate (internal)'},
  {v:'A106',l:'A106 – Communicate (with client)'},
  {v:'A107',l:'A107 – Communicate (other outside counsel)'},
  {v:'A108',l:'A108 – Manage Data/Files'},
  {v:'A109',l:'A109 – Appear For/Attend'}
];
function $m(n){return '$'+Number(n||0).toFixed(2);}
function $h(n){return Number(n||0).toFixed(1)+'h';}
// msToHMS: convert milliseconds to "H:MM:SS" string for raw-time tooltips
function msToHMS(ms){
  var s=Math.floor((ms||0)/1000);
  var hh=Math.floor(s/3600);
  var mm=Math.floor((s%3600)/60);
  var ss=s%60;
  return hh+':'+String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0');
}
function $d(s){if(!s)return '';var d=new Date(s+'T00:00:00');return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function H(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function pad2(n){return String(n).padStart(2,'0');}

// Phone: format live as user types
function fmtPhone(v){
  var d=v.replace(/\D/g,'');
  if(d.length<=3) return d;
  if(d.length<=6) return '('+d.slice(0,3)+') '+d.slice(3);
  return '('+d.slice(0,3)+') '+d.slice(3,6)+'-'+d.slice(6,10);
}

function fmtCur(v){
  var c=v.replace(/[^\d.]/g,''),p=c.split('.');
  if(p.length>2) return p[0]+'.'+p.slice(1).join('');
  if(p[1]&&p[1].length>2) return p[0]+'.'+p[1].slice(0,2);
  return c;
}

function myRole(){ return ST.user&&ST.user.role||'attorney'; }
function isPartner(){ return myRole()==='partner'; }
function isBilling(){ return myRole()==='billing_staff'; }

function statusBadge(st){
  var s=st||'approved';
  var map={pending:'s-pending',approved:'s-approved',rejected:'s-rejected'};
  var icon={pending:'\u23f3',approved:'\u2713',rejected:'\u2717'};
  return '<span class="status-badge '+map[s]+'">'+icon[s]+' '+s.charAt(0).toUpperCase()+s.slice(1)+'</span>';
}

function roleBadge(role){
  var r=role||'attorney';
  var cls={partner:'rl-partner',attorney:'rl-attorney',billing_staff:'rl-billing'};
  var lbl={partner:'Partner',attorney:'Attorney',billing_staff:'Billing Staff'};
  return '<span class="role-lbl '+(cls[r]||'rl-attorney')+'">'+(lbl[r]||r)+'</span>';
}

function autoRate(cid,mid,ctid){
  // Priority: 1) User/Attorney rate, 2) Contact rate, 3) Matter rate, 4) Client rate
  if(ST.user&&ST.user.rate) return ST.user.rate;
  var ct=ST.contacts.find(function(x){return x.id==ctid;});
  if(ct&&ct.rate) return ct.rate;
  var m=ST.matters.find(function(x){return x.id==mid;});
  if(m&&m.rate) return m.rate;
  var cl=ST.clients.find(function(x){return x.id==cid;});
  if(cl&&cl.rate) return cl.rate;
  return '';
}

function filterEnt(arr,f){
  var now=new Date(),t=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  function ago(d,n){d.setDate(d.getDate()-n);return d;}
  function agoM(d,n){d.setMonth(d.getMonth()-n);return d;}
  function agoY(d,n){d.setFullYear(d.getFullYear()-n);return d;}
  var cut, cutEnd;
  if(f==='today') cut=t;
  else if(f==='week')  cut=ago(new Date(t),7);
  else if(f==='month') cut=agoM(new Date(t),1);
  else if(f==='quarter') cut=ago(new Date(t),91);
  else if(f==='year')  cut=agoY(new Date(t),1);
  else if(f==='this_month'){
    cut=new Date(now.getFullYear(),now.getMonth(),1);
  } else if(f==='this_quarter'){
    var qStart=Math.floor(now.getMonth()/3)*3;
    cut=new Date(now.getFullYear(),qStart,1);
  } else if(f==='this_year'){
    cut=new Date(now.getFullYear(),0,1);
  } else return arr; // 'all'
  return arr.filter(function(e){return new Date(e.date)>=cut;});
}

// Returns the fraction of annual salary that maps to the given filter period.
// Used to prorate salary for bonus/shortfall comparisons.
// Returns null if the period is indeterminate ('all').
function salaryForPeriod(annual, f){
  if(annual==null||annual==='') return null;
  var a=Number(annual);
  var now=new Date();
  if(f==='week')        return a/52;
  if(f==='month')       return a/12;
  if(f==='quarter')     return a/4;
  if(f==='year')        return a;
  if(f==='this_month'){
    // Days elapsed in this calendar month / days in month
    var daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
    var dayOfMonth=now.getDate();
    return (a/12)*(dayOfMonth/daysInMonth);
  }
  if(f==='this_quarter'){
    var qStartM=Math.floor(now.getMonth()/3)*3;
    var qStart=new Date(now.getFullYear(),qStartM,1);
    var qEnd=new Date(now.getFullYear(),qStartM+3,0);
    var qDays=(qEnd-qStart)/86400000+1;
    var elapsed=Math.floor((now-qStart)/86400000)+1;
    return (a/4)*(elapsed/qDays);
  }
  if(f==='this_year'){
    var isLeap=(now.getFullYear()%4===0&&now.getFullYear()%100!==0)||(now.getFullYear()%400===0);
    var yearDays=isLeap?366:365;
    var jan1=new Date(now.getFullYear(),0,1);
    var elapsed2=Math.floor((now-jan1)/86400000)+1;
    return a*(elapsed2/yearDays);
  }
  return null; // 'all' — no meaningful proration
}

// Human-readable salary period label for display
function salaryPeriodLabel(f){
  return {
    week:'weekly (÷52)', month:'monthly (÷12)', quarter:'quarterly (÷4)',
    year:'annual', this_month:'month-to-date', this_quarter:'quarter-to-date',
    this_year:'year-to-date', all:null
  }[f]||null;
}

// Sync form field values to state before any re-render triggered by dropdown changes
// This prevents typed text from being lost when a select triggers a re-render
function syncForm(){
  if(ST.modal==='ef'){
    var d=g('ef-d'),h=g('ef-h'),r=g('ef-r'),desc=g('ef-desc');
    if(d) ST.ef.date=d;
    ST.ef.hours=h; // always sync so partial typing is preserved
    ST.ef.rate=r;
    ST.ef.description=desc;
  }
  if(ST.modal==='cf'){
    var n=g('cf-n'),e=g('cf-e'),p=g('cf-p'),r=g('cf-r'),op=g('cf-op');
    ST.cf.name=n; ST.cf.email=e; ST.cf.phone=p; ST.cf.rate=r;
    if(op!==undefined) ST.cf.ownPct=op;
    // Preserve new-person draft
    var pn=g('cf-pn'),pro=g('cf-pro'),pe=g('cf-pe'),pp=g('cf-pp');
    if(pn!==undefined) ST.cf.newPerson=ST.cf.newPerson||{};
    if(pn!==undefined) ST.cf.newPerson.name=pn;
    if(pro!==undefined) ST.cf.newPerson.role=pro;
    if(pe!==undefined) ST.cf.newPerson.email=pe;
    if(pp!==undefined) ST.cf.newPerson.phone=pp;
  }
  if(ST.modal==='mf'){
    var n=g('mf-n'),desc=g('mf-desc'),r=g('mf-r');
    ST.mf.name=n; ST.mf.description=desc; ST.mf.rate=r;
  }
  if(ST.modal==='ctf'){
    var n=g('ctf-n'),ro=g('ctf-ro'),e=g('ctf-e'),p=g('ctf-p'),r=g('ctf-rate'),op=g('ctf-op');
    ST.ctf.name=n; ST.ctf.role=ro; ST.ctf.email=e; ST.ctf.phone=p; ST.ctf.rate=r;
    if(op!==undefined) ST.ctf.ownPct=op;
  }
  if(ST.modal==='ql'){
    var h=g('ql-h'),r=g('ql-r'),desc=g('ql-d');
    if(h) ST.ql.hours=h;
    if(r) ST.ql.rate=r;
    if(desc) ST.ql.description=desc;
  }
  if(ST.modal==='settings'){
    var ef=g('exp-from'),et=g('exp-to');
    if(ef!==undefined) ST.settings.expFrom=ef;
    if(et!==undefined) ST.settings.expTo=et;
  }
  if(ST.modal==='pref'){
    var h=g('pref-h'),r=g('pref-r'),d=g('pref-desc'),c=g('pref-cmt'),inv=document.getElementById('pref-inv');
    if(h!==undefined) ST.pref.hours=h;
    if(r!==undefined) ST.pref.rate=r;
    if(d!==undefined) ST.pref.description=d;
    if(c!==undefined) ST.pref.comment=c;
    if(inv) ST.pref.showOnInvoice=inv.checked;
  }
}

// === SAVE
//
// Strategy:
//   saveOne(coll, rec)  — immediate single-record upsert (for form saves, no data-loss risk)
//   delOne(coll, id)    — immediate single-record delete
//   save()              — debounced full-state sync (for bulk/meta; 200ms debounce)
//   _flushSave()        — immediate (no debounce) full sync — called on tab hide
//
// Collections use putRecord/deleteRecord (safe, atomic, no clear).
// Bulk import uses syncCollection (upsert + prune orphans in one tx).
//
var _saveTimer=null;
var _dirty={};     // tracks which collections have pending changes

// Mark a collection dirty so the next save() includes it
function _markDirty(coll){ _dirty[coll]=true; }

// Flush all dirty state to IDB immediately (no debounce).
// Returns a Promise that resolves when all writes complete.
function _flushSave(){
  clearTimeout(_saveTimer);
  _saveTimer=null;
  var ops=[];
  // Collections — use syncCollection so orphaned deletes are pruned if we ever
  // fall back to this path from a dirty-tracking gap.
  if(_dirty.clients||_dirty._all)   ops.push(Store.syncCollection('clients',  ST.clients));
  if(_dirty.matters||_dirty._all)   ops.push(Store.syncCollection('matters',  ST.matters));
  if(_dirty.entries||_dirty._all)   ops.push(Store.syncCollection('entries',  ST.entries));
  if(_dirty.contacts||_dirty._all)  ops.push(Store.syncCollection('contacts', ST.contacts));
  if(_dirty.invoices||_dirty._all)  ops.push(Store.syncCollection('invoices', ST.invoices));
  // Meta — always write (cheap single-record puts)
  ops.push(Store.setMeta('prefs',ST.prefs));
  ops.push(Store.setMeta('descpresets',ST.descPresets));
  ops.push(Store.setMeta('mailpresets',ST.mailPresets));
  ops.push(Store.setMeta('mailplaceholders',ST.mailPlaceholders));
  ops.push(Store.setMeta('itmode',{itMode:ST.itMode,firmProfile:ST.firmProfile}));
  _dirty={};
  return Promise.all(ops);
}

// Debounced save — used for rapid-fire changes (e.g. settings toggles, imports).
// For single-record mutations prefer saveOne/delOne instead.
function save(){
  _dirty._all=true;  // full sync on next flush
  markLuDirty();     // bulk changes always invalidate lookup cache
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(_flushSave, 200);
}

// Immediate single-record upsert — use after saving a form (no data-loss window).
function saveOne(coll, rec){
  if(!rec||rec.id==null) return;
  _dirty[coll]=true;
  markLuDirty(); // lookup maps must be rebuilt after any record mutation
  Store.putRecord(coll, rec);
  // Also sync meta on the debounced path so prefs etc. stay consistent
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(function(){
    Store.setMeta('prefs',ST.prefs);
    Store.setMeta('descpresets',ST.descPresets);
    Store.setMeta('mailpresets',ST.mailPresets);
    Store.setMeta('mailplaceholders',ST.mailPlaceholders);
    Store.setMeta('itmode',{itMode:ST.itMode,firmProfile:ST.firmProfile});
    _dirty={};
  }, 200);
}

// Immediate single-record delete — use after confirming a delete action.
function delOne(coll, id){
  if(id==null) return;
  _dirty[coll]=true;
  markLuDirty(); // lookup maps must be rebuilt after any record deletion
  Store.deleteRecord(coll, id);
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(function(){ _dirty={}; }, 200);
}

// ── Flush immediately when tab is hidden (before browser may suspend) ──
document.addEventListener('visibilitychange', function(){
  if(document.visibilityState==='hidden' && Object.keys(_dirty).length){
    _flushSave();
  }
});

function savePrefs(){
  Store.setMeta('prefs',ST.prefs);
  applyPrefs();
}
function applyPrefs(){
  var b=document.body;
  // Dark mode: null=auto (follow system), true=always dark, false=always light
  var dm=ST.prefs.darkMode;
  var sysDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(dm===true||(dm===null&&sysDark)) b.classList.add('dark'); else b.classList.remove('dark');
  // Layout
  b.classList.remove('layout-compact','layout-comfortable','layout-spacious');
  if(ST.prefs.layout&&ST.prefs.layout!=='comfortable') b.classList.add('layout-'+ST.prefs.layout);
  // Title bar
  document.title=ST.prefs.appName||'SixMinuteLog.com';
}
// Re-apply when OS theme changes (only affects users in auto mode)
if(window.matchMedia){
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(){
    applyPrefs();
  });
}

// === TOAST
function toast(msg,type){
  type=type||'ok';
  var el=document.createElement('div');
  el.className='toast t-'+type;
  el.textContent=msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(function(){el.remove();},3000);
}

// === ICONS
var IC={
  plus:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  x:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  save:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
  edit:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
  trash:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  clock:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  users:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  brief:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
  chart:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
  doc:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  gear:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
  help:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><circle cx="12" cy="17" r="1" fill="currentColor" stroke="none"/></svg>',
  dl:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  ul:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
  rst:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>',
  usr:'<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  flash:'<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  pie:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>',
  check:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  checkLg:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
  shield:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
  xsm:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  moon:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
  sun:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
  mail:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
  list:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
  paint:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 13.5V20h6.5"/><path d="M22 13.5C22 6 17 2 12 2S2 6 2 13.5"/><circle cx="16.5" cy="20.5" r="2.5"/><path d="M16.5 18v-5"/></svg>',
  invoice:'<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',
  print:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>',
  scissors:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>',
  merge:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6v6m0 0v6m0-6h8m0 0l-4-4m4 4l-4 4"/></svg>',
  comment:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
  eye:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
  send:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
  copy:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>'
};

// === FIELD BUILDER
function field(label,id,o){
  o=o||{};
  var req=o.req?'<span class="req">*</span>':'';
  var ec=o.err?'err':'';
  var oninput=o.oninput?' oninput="'+o.oninput+'"':'';
  var ctrl='';
  if(o.type==='select'){
    var opts=(o.opts||[]).map(function(op){
      return '<option value="'+H(op.v)+'"'+(String(op.v)===String(o.val||'')?'selected':'')+'>'+H(op.l)+'</option>';
    }).join('');
    ctrl='<select id="'+id+'" class="'+ec+'"'+(o.dis?' disabled':'')+oninput+'>'+opts+'</select>';
  } else if(o.type==='textarea'){
    ctrl='<textarea id="'+id+'" rows="'+(o.rows||3)+'" class="'+ec+'" placeholder="'+H(o.ph||'')+'">'+H(o.val||'')+'</textarea>';
  } else if(o.pfx||o.sfx){
    var sfxHtml=o.sfx?'<span class="sfx">'+o.sfx+'</span>':'';
    var hasSfxCls=o.sfx?' has-sfx':'';
    ctrl='<div class="pw">'+(o.pfx?'<span class="pfx">'+o.pfx+'</span>':'')+sfxHtml+'<input type="'+(o.type||'text')+'" id="'+id+'" class="'+ec+hasSfxCls+'" placeholder="'+H(o.ph||'')+'" value="'+H(o.val||'')+'"'+(o.dis?' disabled':'')+oninput+' /></div>';
  } else {
    ctrl='<input type="'+(o.type||'text')+'" id="'+id+'" class="'+ec+'" placeholder="'+H(o.ph||'')+'" value="'+H(o.val||'')+'"'+(o.dis?' disabled':'')+oninput+(o.step?' step="'+o.step+'"':'')+(o.min!==undefined?' min="'+o.min+'"':'')+(o.max!==undefined?' max="'+o.max+'"':'')+' />';
  }
  return '<div class="fl"><label for="'+id+'">'+H(label)+req+'</label>'+ctrl
    +(o.err?'<div class="emsg">'+H(o.err)+'</div>':'')
    +(o.hint&&!o.err?'<div class="hint">'+o.hint+'</div>':'')
    +'</div>';
}

function stats(arr){
  return '<div class="srow">'+arr.map(function(s){
    return '<div class="sc'+(s[2]?' '+s[2]:'')+'"><div class="sc-lbl">'+H(s[0])+'</div><div class="sc-val">'+H(String(s[1]))+'</div></div>';
  }).join('')+'</div>';
}

// === EXPORT FILENAME GENERATOR
function exportFilename(){
  var s=ST.settings;
  var parts=[];
  if(s.te) parts.push('entries');
  if(s.cl) parts.push('clients');
  if(s.ma) parts.push('matters');
  if(s.co) parts.push('contacts');
  if(s.su) parts.push('summary');
  if(s.split) parts.push('split');
  var label=parts.length===0?'empty'
    :parts.length>=6?'full'
    :parts.join('+');
  var now=new Date();
  var ds=now.toISOString().split('T')[0];
  var ts=pad2(now.getHours())+pad2(now.getMinutes());
  // Date range suffix
  var range='';
  if(s.expFrom&&s.expTo) range='_'+s.expFrom+'_to_'+s.expTo;
  else if(s.expFrom) range='_from_'+s.expFrom;
  else if(s.expTo) range='_to_'+s.expTo;
  return 'billing-'+label+'_'+ds+'_'+ts+range+'.csv';
}

// === VIEWS

// == Timesheet ==
function vTimesheet(){
  var role=myRole();
  var me=ST.user?ST.user.name:'';

  // Attorneys and partners see ONLY their own entries in this tab.
  // Billing staff see all entries (that's their job as hub).
  var baseEntries=(role==='billing_staff')
    ? ST.entries
    : ST.entries.filter(function(e){return e.createdBy===me;});

  var fe=filterEnt(baseEntries,ST.tsFilter);
  if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
  if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});

  var sorted=[].concat(fe).sort(function(a,b){
    if(ST.tsSort==='date-asc') return new Date(a.date)-new Date(b.date);
    if(ST.tsSort==='client'){
      var ca=_lu.cl[a.clientId],cb=_lu.cl[b.clientId];
      return ((ca&&ca.name)||'').localeCompare((cb&&cb.name)||'');
    }
    if(ST.tsSort==='hours') return Number(b.hours)-Number(a.hours);
    if(ST.tsSort==='amount') return (Number(b.hours)*Number(b.rate))-(Number(a.hours)*Number(a.rate));
    return new Date(b.date)-new Date(a.date);
  });

  var hrs=fe.reduce(function(s,e){return s+Number(e.hours);},0);
  var bill=fe.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);

  // For attorneys: track how many of MY entries are still pending (need submission)
  var myPending=(role==='attorney')
    ? fe.filter(function(e){return (e.status||'pending')==='pending';}).length : 0;

  var fopts=['all','today','week','month','year'].map(function(v){
    var l={all:'All Time',today:'Today',week:'This Week',month:'This Month',year:'This Year'}[v];
    return '<option value="'+v+'"'+(ST.tsFilter===v?' selected':'')+'>'+l+'</option>';
  }).join('');

  var formH=ST.modal==='ef'?entryForm():'';

  // ── Role-specific notice bar ──────────────────────────────────────────────
  var noticeH='';
  if(role==='billing_staff'){
    noticeH='<div class="role-notice">'+IC.shield
      +' <span><strong>Billing mode:</strong> You can view all entries, assign ABA codes &amp; matter numbers (🧾 per row), then use <strong>Send to Partner</strong> to forward for approval.</span></div>';
  } else if(role==='attorney'&&myPending>0){
    noticeH='<div class="role-notice">'+IC.clock
      +' <span><strong>'+myPending+' unsent entr'+(myPending===1?'y':'ies')+'.</strong> Review your entries below, then click <strong>Submit Timesheet</strong> to send to billing.</span></div>';
  } else if(role==='attorney'&&fe.length>0&&myPending===0){
    noticeH='<div class="good">'+IC.check+' All entries submitted. Check the <strong>Approvals</strong> tab for partner decisions.</div>';
  } else if(role==='partner'&&fe.length>0){
    var myApproved=fe.filter(function(e){return (e.status||'approved')==='approved';}).length;
    var allApp=ST.entries.filter(function(e){return (e.status||'approved')==='pending';}).length;
    noticeH='<div class="role-notice">'+IC.shield
      +' <span>Your entries are shown here. '+(allApp>0?'<strong>'+allApp+' entries from others</strong> await your review in the <strong>Approvals</strong> tab.':'All team entries approved.')+'</span></div>';
  }

  // ── Table ─────────────────────────────────────────────────────────────────
  var tableH='';
  if(sorted.length===0){
    tableH='<div class="empty"><div class="empty-ico">&#9201;</div><p>No entries yet</p>'
      +'<small>'+(role==='billing_staff'?'No entries in this time range.':'Click "+ New Entry" or tap ⚡ to log time.')+'</small></div>';
  } else {
    var PAGE_SIZE=ST.TS_PAGE_SIZE||50;
    var totalFiltered=sorted.length;
    var totalPages=Math.max(1,Math.ceil(totalFiltered/PAGE_SIZE));
    if(ST.tsPage>=totalPages) ST.tsPage=totalPages-1;
    if(ST.tsPage<0) ST.tsPage=0;
    var pageStart=ST.tsPage*PAGE_SIZE;
    var pageEnd=Math.min(pageStart+PAGE_SIZE,totalFiltered);
    var paginated=sorted.slice(pageStart,pageEnd);

    var rows=paginated.map(function(e){
      var cl=_lu.cl[e.clientId];
      var mt=_lu.ma[e.matterId];
      var ct=_lu.ct[e.contactId];
      var amt=Number(e.hours)*Number(e.rate);
      var est=e.status||'pending';

      // Actions — no approve/reject here; that lives in Approvals tab
      var canEdit=false,canDelete=false;
      if(role==='partner'){canEdit=true;canDelete=true;}
      else if(role==='attorney'){canEdit=(est==='pending');canDelete=(est==='pending');}

      var actionsH='<div class="tda">';
      if(canEdit)   actionsH+='<button onclick="A.editEnt('+e.id+')" title="Edit">'+IC.edit+'</button>';
      if(canDelete) actionsH+='<button onclick="A.delEnt('+e.id+')" title="Delete">'+IC.trash+'</button>';
      if(role==='billing_staff') actionsH+='<button onclick="A.billingEditEntry('+e.id+')" title="Add ABA code / matter number" style="color:var(--blue)">🧾</button>';
      actionsH+='</div>';

      var abaDisplay=e.abaCode
        ?'<span style="font-family:monospace;font-size:10px;color:var(--blue);display:block">'+H(e.abaCode)+'</span>':'';
      var mnDisplay=(mt&&mt.matterNumber)
        ?'<span style="font-family:monospace;font-size:10px;color:var(--ink3);display:block">#'+H(mt.matterNumber)+'</span>':'';
      // For billing staff, show submitter badge; for attorney/partner it's always self so omit
      var byCell=role==='billing_staff'
        ?'<td><span class="badge" title="'+H(e.createdBy||'')+'">'+H(e.createdByIni||'?')+'</span></td>':'';

      return '<tr>'
        +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
        +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
        +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+mnDisplay+'</td>'
        +'<td style="color:var(--ink2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+H(e.description||'')+'">'+H(e.description||'\u2014')+abaDisplay
          +(e.partnerComment?'<span title="Partner note: '+H(e.partnerComment)+'" style="margin-left:4px;font-size:11px;color:var(--amber);cursor:help">&#128172;</span>':'')
          +(e.partnerEdited?'<span title="Partner adjusted this entry" style="margin-left:2px;font-size:10px;color:var(--amber);cursor:help">✎</span>':'')
        +'</td>'
        +'<td>'+(e.rawMs!=null
          ?'<span title="Timer: '+msToHMS(e.rawMs)+'" style="cursor:help;border-bottom:1px dotted var(--ink3)">'+$h(e.hours)+'</span>'
          :$h(e.hours))
          +(e.finalized?'<span style="font-size:10px;color:var(--green);margin-left:3px" title="Finalized">✓</span>':'')
        +'</td>'
        +'<td style="color:var(--ink2)">'+$m(e.rate)+'</td>'
        +'<td style="color:var(--green);font-weight:500">'+$m(amt)+'</td>'
        +byCell
        +'<td>'+actionsH+'</td>'
        +'</tr>';
    }).join('');

    var pagCtrl='';
    if(totalPages>1){
      var btnStyle='padding:5px 12px;border:1px solid var(--border);border-radius:6px;background:var(--white);color:var(--ink);cursor:pointer;font-size:12px';
      var pagInfo='Page '+(ST.tsPage+1)+' of '+totalPages+' ('+(pageStart+1)+'–'+pageEnd+' of '+totalFiltered+')';
      pagCtrl='<div style="display:flex;align-items:center;gap:8px;padding:10px 0;justify-content:center;flex-wrap:wrap">'
        +'<button style="'+btnStyle+'" '+(ST.tsPage===0?'disabled':'')+' onclick="A.tsFirstPage()">&#8676; First</button>'
        +'<button style="'+btnStyle+'" '+(ST.tsPage===0?'disabled':'')+' onclick="A.tsPrevPage()">&#8249; Prev</button>'
        +'<span style="font-size:12px;color:var(--ink2)">'+pagInfo+'</span>'
        +'<button style="'+btnStyle+'" '+(ST.tsPage>=totalPages-1?'disabled':'')+' onclick="A.tsNextPage()">Next &#8250;</button>'
        +'<button style="'+btnStyle+'" '+(ST.tsPage>=totalPages-1?'disabled':'')+' onclick="A.tsLastPage('+(totalPages-1)+')">Last &#8677;</button>'
        +'</div>';
    }

    var thBy=role==='billing_staff'?'<th>By</th>':'';
    tableH='<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Description</th><th>Hours</th><th>Rate</th><th>Amount</th>'+thBy+'<th></th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
      +pagCtrl;
  }

  var statRows=[['Total Hours',$h(hrs),''],['Total Billing',$m(bill),''],['Avg Rate',hrs>0?$m(bill/hrs):'\u2014',''],['Entries',String(fe.length),'']];
  var clFilterOpts='<option value="">All Clients</option>'+ST.clients.map(function(c){
    return '<option value="'+c.id+'"'+(ST.tsClientFilter==c.id?' selected':'')+'>'+H(c.name)+'</option>';
  }).join('');
  var availMa=ST.matters.filter(function(m){return !ST.tsClientFilter||m.clientId==ST.tsClientFilter;});
  var maFilterOpts='<option value="">All Matters</option>'+availMa.map(function(m){
    return '<option value="'+m.id+'"'+(ST.tsMatterFilter==m.id?' selected':'')+'>'+H(m.name)+'</option>';
  }).join('');
  var sortOpts=[['date-desc','Date ↓'],['date-asc','Date ↑'],['client','Client A–Z'],['hours','Hours ↓'],['amount','Amount ↓']].map(function(x){
    return '<option value="'+x[0]+'"'+(ST.tsSort===x[0]?' selected':'')+'>'+x[1]+'</option>';
  }).join('');
  var selectStyle='padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)';
  var hasExtra=(ST.tsClientFilter||ST.tsMatterFilter||ST.tsSort!=='date-desc');

  // ── Header action buttons ─────────────────────────────────────────────────
  // One clear primary action per role; no redundant alternatives in this toolbar.
  var actionBtns='';
  if(role==='attorney'){
    actionBtns+='<button class="btn btn-dk" onclick="A.openEF()">'+IC.plus+' New Entry</button>';
    if(fe.filter(function(e){return !e.finalized;}).length>0)
      actionBtns+='<button class="btn btn-gr" onclick="A.finalizeEntries()" title="Group identical entries for the same day">Finalize</button>';
    if(fe.length>0)
      actionBtns+='<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Review, export, and email your timesheet to billing">📤 Submit Timesheet</button>';
  } else if(role==='partner'){
    actionBtns+='<button class="btn btn-dk" onclick="A.openEF()">'+IC.plus+' New Entry</button>';
    if(fe.filter(function(e){return !e.finalized;}).length>0)
      actionBtns+='<button class="btn btn-gr" onclick="A.finalizeEntries()">Finalize</button>';
    if(fe.length>0)
      actionBtns+='<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Send your own entries to billing">📤 Submit My Time</button>';
  } else if(role==='billing_staff'){
    actionBtns+='<button class="btn btn-gh" onclick="A.openReceivePackage()" title="Import a timesheet submission received from an attorney">📥 Receive Submission</button>';
    if(fe.length>0)
      actionBtns+='<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Send all visible entries to partner for approval">📤 Send to Partner</button>';
  }

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">'
    +(role==='billing_staff'?'All Entries':'My Timesheet')+'</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+fe.length+' entr'+(fe.length===1?'y':'ies')
    +(ST._entriesMode==='partial'&&ST._totalEntryCount>ST.entries.length
      ?' <span title="Showing this year. Select All Time to load full history." style="color:var(--amber);cursor:help">('+ST._totalEntryCount+' total — partial)</span>':'')
    +'</p></div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap">'+actionBtns+'</div></div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<select onchange="A.setTsF(this.value)" style="'+selectStyle+'">'+fopts+'</select>'
    +(ST.clients.length>0?'<select onchange="A.setTsClF(this.value)" style="'+selectStyle+'">'+clFilterOpts+'</select>':'')
    +(ST.matters.length>0?'<select onchange="A.setTsMaF(this.value)" style="'+selectStyle+'">'+maFilterOpts+'</select>':'')
    +'<select onchange="A.setTsSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(hasExtra?'<button class="btn btn-gh" onclick="A.clearTsFilters()" style="font-size:12px;padding:7px 12px">✕ Clear</button>':'')
    +'</div>'
    +noticeH
    +stats(statRows)
    +formH+tableH+'</div>';
}

function entryForm(){
  var role=myRole();
  var f=ST.ef;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var avMat=ST.matters.filter(function(m){return m.clientId==f.clientId;});
  var maOpts=[{v:'',l:'General work'}].concat(avMat.map(function(m){return{v:m.id,l:m.name};}));
  var ctOpts=[{v:'',l:'Select team member...'}].concat(ST.contacts.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  var matHint=!f.clientId?'Select a client first':(avMat.length===0?'No matters for this client':'');
  var existingStatus=ST.editId?(ST.entries.find(function(e){return e.id==ST.editId;})||{}).status||'pending':null;
  var statusNotice='';
  if(existingStatus==='approved'){
    statusNotice='<div class="good" style="margin-bottom:14px">'+IC.check+' This entry has been <strong>approved</strong> by a partner. Edits will reset it to pending.</div>';
  } else if(existingStatus==='rejected'){
    statusNotice='<div class="danger" style="margin-bottom:14px">This entry was <strong>rejected</strong>. Edit and re-submit via the Submit Timesheet button.</div>';
  }
  return '<div class="fbox" id="ef">'
    +'<h3>'+(ST.editId?'Edit Entry':'New Time Entry')+'</h3>'
    +statusNotice
    +'<div class="frow c2">'+field('Date','ef-d',{type:'date',val:f.date||today(),req:true,err:f.errs&&f.errs.d})+field('Hours','ef-h',{type:'number',ph:'1.0',val:f.hours||'',req:true,err:f.errs&&f.errs.h,hint:'e.g. 1.5 or 0.25',step:'0.01',min:'0.01'})+'</div>'
    +'<div class="frow c2">'+field('Client','ef-cl',{type:'select',opts:clOpts,val:f.clientId||'',req:true,err:f.errs&&f.errs.cl})+field('Matter','ef-ma',{type:'select',opts:maOpts,val:f.matterId||'',hint:matHint})+'</div>'
    +'<div class="frow c2">'+field('Team Member','ef-ct',{type:'select',opts:ctOpts,val:f.contactId||''})+field('Rate ($/hr)','ef-r',{pfx:'$',ph:'150.00',val:f.rate||'',req:true,err:f.errs&&f.errs.r,hint:total?'Total: '+total+'. Priority: Your rate > Contact > Matter > Client':'Priority: Your rate > Contact > Matter > Client'})+'</div>'
    +'<div class="frow c2">'+field('ABA/UTBMS Code','ef-aba',{type:'select',opts:ABA_TASK_CODES,val:f.abaCode||'',hint:'Optional task code for billing compliance'})+'<div></div></div>'
    +'<div class="frow">'+field('Description','ef-desc',{type:'textarea',rows:2,ph:'Describe the work performed...',val:f.description||''})+'</div>'
    +(ST.descPresets.length>0?'<div class="desc-chips"><span style="font-size:11px;color:var(--ink3);margin-right:4px">Suggestions:</span>'+ST.descPresets.map(function(p,i){return '<button type="button" class="desc-chip" onclick="A.pickDesc(\'ef-desc\','+i+')">'+ H(p)+'</button>';}).join('')+'</div>':'')
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveEnt()">'+IC.save+' Save Entry</button></div>'
    +'</div>';
}

// == Clients ==
function vClients(){
  var formH=ST.modal==='cf'?clientForm():'';
  var cardsH='';
  var list=ST.clients;
  // Search
  if(ST.clSearch) list=list.filter(function(c){var s=ST.clSearch.toLowerCase();return c.name.toLowerCase().indexOf(s)!==-1||(c.email&&c.email.toLowerCase().indexOf(s)!==-1);});
  // Sort
  list=[].concat(list).sort(function(a,b){
    if(ST.clSort==='matters'){
      var mc=function(c){return ST.matters.filter(function(m){return m.clientId==c.id;}).length;};
      return mc(b)-mc(a);
    }
    if(ST.clSort==='rate') return Number(b.rate||0)-Number(a.rate||0);
    return a.name.localeCompare(b.name); // alpha
  });
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var sortOpts=[['alpha','Name A\u2013Z'],['matters','Most Matters'],['rate','Rate \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.clSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  if(ST.clients.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128188;</div><p>No clients yet</p><small>Add your first client to get started</small></div>';
  } else if(list.length===0){
    cardsH='<div class="empty"><p>No clients match your search</p></div>';
  } else {
    cardsH='<div class="cgrid">'+list.map(function(c){
      // Support both legacy contactId and new contactIds[]
      var ctIds=c.contactIds&&c.contactIds.length?c.contactIds:(c.contactId?[c.contactId]:[]);
      var linkedCts=ctIds.map(function(id){return _lu.ct[id];}).filter(Boolean);
      var cppl=c.clientPeople&&c.clientPeople.length?c.clientPeople:[];
      // Find most recent approved invoice for this client
      var clientInvs=(ST.invoices||[]).filter(function(i){return i.clientId==c.id&&i.status==='approved';});
      clientInvs.sort(function(a,b){return b.id-a.id;});
      var latestApproved=clientInvs[0]||null;
      return '<div class="card">'
        +'<div class="card-hd"><div class="avatar">'+H(c.name.charAt(0).toUpperCase())+'</div>'
        +'<div class="card-act">'
        +(latestApproved?'<button onclick="A.emailInvoice('+latestApproved.id+')" title="Email latest invoice to client" style="color:var(--blue)">'+IC.mail+'</button>':'')
        +'<button onclick="A.editCl('+c.id+')" title="Edit">'+IC.edit+'</button><button onclick="A.delCl('+c.id+')" title="Delete">'+IC.trash+'</button></div></div>'
        +'<h3>'+H(c.name)+'</h3>'
        +(c.email?'<p style="font-size:12px">'+H(c.email)+'</p>':'')
        +(c.phone?'<p style="font-size:12px">'+H(c.phone)+'</p>':'')
        +(cppl.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Client Contacts</div>'
          +cppl.map(function(p){return '<div style="font-size:12px;padding:2px 0"><strong>'+H(p.name)+'</strong>'+(p.role?' <span style="color:var(--ink3)">&middot; '+H(p.role)+'</span>':'')+(p.email?'<br><span style="color:var(--ink2)">'+H(p.email)+'</span>':'')+(p.phone?'<span style="color:var(--ink3);font-size:11px"> '+H(p.phone)+'</span>':'')+'</div>';}).join('')+'</div>':'')
        +(linkedCts.length?'<div style="margin:6px 0 4px;border-top:1px solid var(--border-l);padding-top:7px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:5px">Firm Team</div>'
          +linkedCts.map(function(ct){return '<p style="font-size:12px;margin:2px 0">&#128203; '+H(ct.name)+(ct.role?' <span style="color:var(--ink3)">&middot; '+H(ct.role)+'</span>':'')+'</p>';}).join('')+'</div>':'')
        +(c.rate?'<div class="card-rate">Default rate <strong>'+$m(c.rate)+'/hr</strong></div>':'')
        +'<div class="card-rate" style="border-top:none;padding-top:0;margin-top:6px">'
        +(function(){var mc=ST.matters.filter(function(m){return m.clientId==c.id;}).length;return '<span style="color:var(--ink3)">'+mc+' matter'+(mc!==1?'s':'')+'</span>';})()
        +'</div>'
        +'</div>';
    }).join('')+'</div>';
  }
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Clients</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+list.length+' of '+ST.clients.length+' client'+(ST.clients.length!==1?'s':'')+'</p></div>'
    +'<button class="btn btn-dk" onclick="A.openCF()">'+IC.plus+' Add Client</button>'
    +'</div>'
    +(ST.clients.length>1?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="cl-search" type="text" value="'+H(ST.clSearch||'')+'" oninput="A.setClSearch(this.value)" placeholder="Search clients..." style="'+selectStyle+';min-width:160px">'
    +'<select onchange="A.setClSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(ST.clSearch?'<button class="btn btn-gh" onclick="A.setClSearch(\'\')" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function clientForm(){
  var f=ST.cf;
  var selIds=f.contactIds||((f.contactId&&f.contactId!='')?[Number(f.contactId)]:[]);
  // Firm contacts not yet added
  var available=ST.contacts.filter(function(c){return !selIds.some(function(id){return id==c.id;});});
  var ctOpts=[{v:'',l:'Add team member...'}].concat(available.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  // Firm contact chips
  var chipsH=selIds.length===0?''
    :selIds.map(function(id){
        var c=_lu.ct[id];
        if(!c) return '';
        return '<span style="display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px 3px 8px;font-size:12px;margin:2px">'
          +'<span class="avatar" style="width:18px;height:18px;font-size:9px;flex-shrink:0">'+H(c.name.charAt(0).toUpperCase())+'</span>'
          +H(c.name)+(c.role?'<span style="color:var(--ink3)"> &middot; '+H(c.role)+'</span>':'')
          +(c.isUser?'<span style="font-size:10px;font-weight:600;color:var(--blue)">You</span>':'')
          +'<button type="button" onclick="A.cfRemCt('+id+')" style="background:none;border:none;cursor:pointer;padding:0;line-height:1;color:var(--ink3);font-size:14px;margin-left:2px" title="Remove">&times;</button>'
          +'</span>';
      }).join('');
  var chipsRow=selIds.length>0?'<div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:4px">'+chipsH+'</div>':'';
  // Client-side people chips
  var cppl=f.clientPeople||[];
  var ppChips=cppl.length===0?''
    :'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">'+cppl.map(function(p,i){
        return '<span style="display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:3px 10px 3px 8px;font-size:12px">'
          +'<span class="avatar" style="width:18px;height:18px;font-size:9px;background:#7c3aed;color:#fff;flex-shrink:0">'+H(p.name.charAt(0).toUpperCase())+'</span>'
          +H(p.name)+(p.role?'<span style="color:var(--ink3)"> &middot; '+H(p.role)+'</span>':'')
          +(p.email?'<span style="color:var(--ink2);font-size:11px"> '+H(p.email)+'</span>':'')
          +'<button type="button" onclick="A.cfRemPerson('+i+')" style="background:none;border:none;cursor:pointer;padding:0;line-height:1;color:var(--ink3);font-size:14px;margin-left:2px" title="Remove">&times;</button>'
          +'</span>';
      }).join('')+'</div>';
  var np=f.newPerson||{};
  return '<div class="fbox" id="cf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Client</h3>'
    +'<div class="frow">'+field('Client Name','cf-n',{ph:'Acme Corp',val:f.name||'',req:true,err:f.errs&&f.errs.n})+'</div>'
    +'<div class="frow c2">'+field('Email','cf-e',{type:'email',ph:'billing@acme.com',val:f.email||'',err:f.errs&&f.errs.e})+field('Phone','cf-p',{type:'tel',ph:'(555) 123-4567',val:f.phone||'',oninput:"A.livePhone('cf-p')"})+'</div>'
    +'<div class="frow c2">'+field('Default Rate ($/hr)','cf-r',{pfx:'$',ph:'250.00',val:f.rate||'',hint:'Used unless overridden by matter/contact'})+field('Firm Team','cf-ct',{type:'select',opts:ctOpts,val:'',hint:'Assign firm contacts to this client'})+'</div>'
    +(chipsRow?'<div class="frow" style="padding-top:0;margin-top:-8px"><div>'+chipsRow+'</div></div>':'')
    // Client-side contacts section
    +'<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
    +'<div style="font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:10px">Client-Side Contacts <span style="font-size:11px;font-weight:400;color:var(--ink3)">(owner, HR, billing, etc.)</span></div>'
    +ppChips
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px">'
    +'<div class="fl"><label style="font-size:11px">Name</label><input type="text" id="cf-pn" placeholder="Jane Smith" value="'+H(np.name||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Role / Title</label><input type="text" id="cf-pro" placeholder="Head of HR" value="'+H(np.role||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Email</label><input type="email" id="cf-pe" placeholder="jane@acme.com" value="'+H(np.email||'')+'" style="width:100%"></div>'
    +'<div class="fl"><label style="font-size:11px">Phone</label><input type="tel" id="cf-pp" placeholder="(555) 123-4567" value="'+H(np.phone||'')+'" oninput="A.livePhone(\'cf-pp\')" style="width:100%"></div>'
    +'</div>'
    +'<button type="button" class="btn btn-gh" style="font-size:12px;padding:6px 14px" onclick="A.cfAddPerson()">+ Add Contact</button>'
    +'</div></div>'
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveCl()">'+IC.save+' Save Client</button></div>'
    +'</div>';
}

// == Matters ==
function vMatters(){
  var formH=ST.modal==='mf'?matterForm():'';
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var clFilterOpts='<option value="">All Clients</option>'+ST.clients.map(function(c){return '<option value="'+c.id+'"'+(ST.maClientFilter==c.id?' selected':'')+'>'+H(c.name)+'</option>';}).join('');
  var sortOpts=[['alpha','Name A\u2013Z'],['client','Client A\u2013Z'],['rate','Rate \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.maSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  var cardsH='';
  if(ST.matters.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128193;</div><p>No matters yet</p><small>'+(ST.clients.length===0?'Add a client first, then create matters':'Add your first matter')+'</small></div>';
  } else {
    // Apply filters
    var list=ST.matters;
    if(ST.maClientFilter) list=list.filter(function(m){return m.clientId==ST.maClientFilter;});
    if(ST.maSearch) list=list.filter(function(m){var s=ST.maSearch.toLowerCase();return m.name.toLowerCase().indexOf(s)!==-1||(m.description&&m.description.toLowerCase().indexOf(s)!==-1);});
    // Sort
    list=[].concat(list).sort(function(a,b){
      if(ST.maSort==='client'){
        var ca=_lu.cl[a.clientId];
        var cb=_lu.cl[b.clientId];
        var cn=((ca&&ca.name)||'').localeCompare((cb&&cb.name)||'');
        if(cn!==0) return cn;
        return a.name.localeCompare(b.name);
      }
      if(ST.maSort==='rate'){
        var ra=a.rate||(_lu.cl[a.clientId]||{}).rate||0;
        var rb=b.rate||(_lu.cl[b.clientId]||{}).rate||0;
        return Number(rb)-Number(ra);
      }
      return a.name.localeCompare(b.name);
    });
    if(list.length===0){
      cardsH='<div class="empty"><p>No matters match your filters</p></div>';
    } else if(ST.maGroup){
      // Grouped by client
      var groups={};var gOrder=[];
      list.forEach(function(m){
        var key=m.clientId||'__none__';
        if(!groups[key]){groups[key]=[];gOrder.push(key);}
        groups[key].push(m);
      });
      cardsH=gOrder.map(function(key){
        var cl=_lu.cl[key];
        var gName=cl?H(cl.name):'<em>No Client</em>';
        var cards=groups[key].map(function(m){return matterCard(m);}).join('');
        return '<div style="margin-bottom:18px">'
          +'<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:8px;display:flex;align-items:center;gap:8px">'
          +'<span style="flex:1;height:1px;background:var(--border-l)"></span>'
          +'<span>'+gName+'</span>'
          +'<span style="flex:1;height:1px;background:var(--border-l)"></span>'
          +'</div>'
          +'<div class="cgrid">'+cards+'</div>'
          +'</div>';
      }).join('');
    } else {
      cardsH='<div class="cgrid">'+list.map(function(m){return matterCard(m);}).join('')+'</div>';
    }
  }
  var addBtn=ST.clients.length>0
    ?'<button class="btn btn-dk" onclick="A.openMF()">'+IC.plus+' Add Matter</button>'
    :'<span style="font-size:13px;color:var(--amber);background:#fffbeb;padding:8px 14px;border-radius:8px;border:1px solid #fde68a">Add a client first</span>';
  var hasFilters=(ST.maClientFilter||ST.maSearch||ST.maSort!=='alpha'||ST.maGroup);
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Matters</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+ST.matters.length+' matter'+(ST.matters.length!==1?'s':'')+'</p></div>'
    +addBtn+'</div>'
    +(ST.matters.length>0?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="ma-search" type="text" value="'+H(ST.maSearch||'')+'" oninput="A.setMaSearch(this.value)" placeholder="Search matters..." style="'+selectStyle+';min-width:160px">'
    +(ST.clients.length>1?'<select onchange="A.setMaClF(this.value)" style="'+selectStyle+'">'+clFilterOpts+'</select>':'')
    +'<select onchange="A.setMaSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +'<label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;padding:7px 11px;border:1px solid var(--border);border-radius:8px;background:'+(ST.maGroup?'var(--bg)':'var(--white)')+'"><input type="checkbox" '+(ST.maGroup?'checked':'')+' onchange="A.toggleMaGroup()" style="margin:0"> Group by Client</label>'
    +(hasFilters?'<button class="btn btn-gh" onclick="A.clearMaFilters()" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function matterCard(m){
  var cl=_lu.cl[m.clientId];
  var ct=_lu.ct[m.contactId];
  var rate=m.rate||(cl&&cl.rate);
  // Resolve linked client-side people
  var linkedPeople=[];
  if(m.linkedClientPeopleIds&&m.linkedClientPeopleIds.length&&cl&&cl.clientPeople){
    linkedPeople=m.linkedClientPeopleIds.map(function(pid){
      return cl.clientPeople.find(function(p){return p.id==pid;});
    }).filter(Boolean);
  }
  return '<div class="card">'
    +'<div class="card-hd"><span class="chip">'+H(cl?cl.name:'Unknown')+'</span>'
    +'<div class="card-act"><button onclick="A.editMa('+m.id+')" title="Edit">'+IC.edit+'</button><button onclick="A.delMa('+m.id+')" title="Delete">'+IC.trash+'</button></div></div>'
    +'<h3>'+H(m.name)+(m.matterNumber?' <span style="font-size:11px;font-weight:400;color:var(--blue);background:var(--blue-pale);padding:2px 7px;border-radius:10px;font-family:monospace">#'+H(m.matterNumber)+'</span>':'')+'</h3>'
    +(ct?'<p style="font-size:12px">&#128203; '+H(ct.name)+(ct.role?'<span style="color:var(--ink3)"> &middot; '+H(ct.role)+'</span>':'')+'</p>':'')
    +(linkedPeople.length?'<div style="margin:5px 0 3px;border-top:1px solid var(--border-l);padding-top:6px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:4px">Client Contacts</div>'
      +linkedPeople.map(function(p){return '<div style="font-size:12px;padding:2px 0"><strong>'+H(p.name)+'</strong>'+(p.role?' <span style="color:var(--ink3)">&middot; '+H(p.role)+'</span>':'')+(p.email?'<br><span style="color:var(--ink2)">'+H(p.email)+'</span>':'')+'</div>';}).join('')
      +'</div>':'')
    +(m.description?'<p style="color:var(--ink3);font-size:12px">'+H(m.description)+'</p>':'')
    +(rate?'<div class="card-rate">'+(m.rate?'Matter rate':'Client rate')+' <strong>'+$m(rate)+'/hr</strong></div>':'')
    +'</div>';
}

function matterForm(){
  var f=ST.mf;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var ctOpts=[{v:'',l:'None'}].concat(ST.contacts.map(function(c){return{v:c.id,l:c.name+(c.role?' - '+c.role:'')};}));
  var selCl=ST.clients.find(function(c){return c.id==f.clientId;});
  var hint=selCl&&selCl.rate?'Client default: '+$m(selCl.rate)+'/hr':'Uses client default if blank';
  // Client-side people for the selected client
  var cppl=selCl&&selCl.clientPeople&&selCl.clientPeople.length?selCl.clientPeople:[];
  var linkedIds=f.linkedClientPeopleIds||[];
  var cpSection='';
  if(f.clientId&&cppl.length){
    var pChips=cppl.map(function(p){
      var pid=p.id;
      var sel=linkedIds.some(function(x){return x==pid;});
      return '<button type="button" onclick="A.mfToggleClientPerson('+pid+')" style="display:inline-flex;align-items:center;gap:5px;border-radius:20px;padding:4px 11px 4px 8px;font-size:12px;cursor:pointer;border:1px solid '+(sel?'var(--blue)':'var(--border)')+';background:'+(sel?'rgba(37,99,235,.09)':'var(--white)')+';color:'+(sel?'var(--blue)':'var(--ink)')+';transition:all .15s">'
        +'<span style="width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:'+(sel?'var(--blue)':'#7c3aed')+';color:#fff;flex-shrink:0">'+H(p.name.charAt(0).toUpperCase())+'</span>'
        +H(p.name)+(p.role?'<span style="color:var(--ink3)"> &middot; '+H(p.role)+'</span>':'')
        +(sel?'<span style="font-size:14px;line-height:1;margin-left:2px;color:var(--blue)">&#10003;</span>':'')
        +'</button>';
    }).join('');
    cpSection='<div class="frow"><div style="border-top:1px solid var(--border-l);padding-top:14px;width:100%">'
      +'<div style="font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:8px">Client-Side Contacts <span style="font-size:11px;font-weight:400;color:var(--ink3)">linked to this matter</span></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:6px">'+pChips+'</div>'
      +(linkedIds.length?'<p style="font-size:11px;color:var(--ink3);margin-top:6px">'+linkedIds.length+' contact'+(linkedIds.length!==1?'s':'')+' linked</p>':'<p style="font-size:11px;color:var(--ink3);margin-top:6px">Click to link contacts from this client</p>')
      +'</div></div>';
  } else if(f.clientId&&!cppl.length){
    cpSection='<div class="frow"><p class="note" style="font-size:12px;width:100%;margin:0">No client-side contacts on this client yet. <a onclick="A.editCl('+f.clientId+');return false;" href="#" style="color:var(--blue)">Edit the client</a> to add contacts first.</p></div>';
  }
  return '<div class="fbox" id="mf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Matter</h3>'
    +'<div class="frow c2">'+field('Matter Name','mf-n',{ph:'Contract Review',val:f.name||'',req:true,err:f.errs&&f.errs.n})+field('Client','mf-cl',{type:'select',opts:clOpts,val:f.clientId||'',req:true,err:f.errs&&f.errs.cl})+'</div>'
    +'<div class="frow c2">'+field('Matter Number','mf-num',{ph:'e.g. 2024-001 or 12345',val:f.matterNumber||'',hint:'Firm-assigned matter number for billing/invoice reference'})+field('Lead Attorney','mf-ct',{type:'select',opts:ctOpts,val:f.contactId||''})+'</div>'
    +'<div class="frow">'+field('Description','mf-desc',{type:'textarea',rows:2,ph:'Brief description of this matter...',val:f.description||''})+'</div>'
    +'<div class="frow c2">'+field('Billing Rate ($/hr)','mf-r',{pfx:'$',ph:'Override rate...',val:f.rate||'',hint:hint})+'<div></div></div>'
    +cpSection
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveMa()">'+IC.save+' Save Matter</button></div>'
    +'</div>';
}

// == Contacts ==
function vContacts(){
  var formH=ST.modal==='ctf'?contactForm():'';
  var selectStyle='padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--white);color:var(--ink)';
  var sortOpts=[['alpha','Name A\u2013Z'],['role','Role A\u2013Z'],['rate','Rate \u2193']].map(function(x){return '<option value="'+x[0]+'"'+(ST.ctSort===x[0]?' selected':'')+'>'+x[1]+'</option>';}).join('');
  var cardsH='';
  if(ST.contacts.length===0){
    cardsH='<div class="empty"><div class="empty-ico">&#128100;</div><p>No contacts yet</p><small>Add team members to track who worked on what</small></div>';
  } else {
    var list=ST.contacts;
    if(ST.ctSearch) list=list.filter(function(c){var s=ST.ctSearch.toLowerCase();return c.name.toLowerCase().indexOf(s)!==-1||(c.role&&c.role.toLowerCase().indexOf(s)!==-1)||(c.email&&c.email.toLowerCase().indexOf(s)!==-1);});
    list=[].concat(list).sort(function(a,b){
      if(ST.ctSort==='role') return ((a.role||'')).localeCompare((b.role||''));
      if(ST.ctSort==='rate') return Number(b.rate||0)-Number(a.rate||0);
      return a.name.localeCompare(b.name);
    });
    if(list.length===0){
      cardsH='<div class="empty"><p>No contacts match your search</p></div>';
    } else {
      cardsH='<div class="cgrid">'+list.map(function(c){
        var pct=c.ownPct!=null?Number(c.ownPct):100;
        var firmPct=100-pct;
        var isMe=!!c.isUser;
        return '<div class="card">'
          +'<div class="card-hd"><div class="avatar avatar-dark">'+H(c.name.charAt(0).toUpperCase())+'</div>'
          +'<div class="card-act">'+(isMe?'<span style="font-size:11px;font-weight:600;color:var(--blue);background:rgba(37,99,235,.1);padding:2px 8px;border-radius:10px;margin-right:4px">You</span>':'')+'<button onclick="A.editCt('+c.id+')" title="Edit">'+IC.edit+'</button>'+(isMe?'':'<button onclick="A.delCt('+c.id+')" title="Delete">'+IC.trash+'</button>')+'</div></div>'
          +'<h3>'+H(c.name)+'</h3>'
          +(c.role?'<p style="color:var(--ink2)">'+H(c.role)+'</p>':'')
          +(c.email?'<p>'+H(c.email)+'</p>':'')
          +(c.phone?'<p>'+H(c.phone)+'</p>':'')
          +(ST.prefs.revenueSplit?'<div class="split-pill"><span class="own">Own '+pct+'%</span><span class="firm">Firm '+firmPct+'%</span></div>':'')
          +(ST.prefs.revenueSplit&&c.salary!=null&&c.salary!==''?'<div class="card-rate">Salary <strong>'+$m(c.salary)+'/yr</strong></div>':'')
          +(c.rate?'<div class="card-rate">Rate <strong>'+$m(c.rate)+'/hr</strong></div>':'')
          +'</div>';
      }).join('')+'</div>';
    }
  }
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Team Contacts</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+ST.contacts.length+' contact'+(ST.contacts.length!==1?'s':'')+'</p></div>'
    +'<button class="btn btn-dk" onclick="A.openCTF()">'+IC.plus+' Add Contact</button>'
    +'</div>'
    +(ST.contacts.length>1?'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">'
    +'<input id="ct-search" type="text" value="'+H(ST.ctSearch||'')+'" oninput="A.setCtSearch(this.value)" placeholder="Search contacts..." style="'+selectStyle+';min-width:160px">'
    +'<select onchange="A.setCtSort(this.value)" style="'+selectStyle+'">'+sortOpts+'</select>'
    +(ST.ctSearch?'<button class="btn btn-gh" onclick="A.setCtSearch(\'\')" style="font-size:12px;padding:7px 12px">&#10006; Clear</button>':'')
    +'</div>':'')
    +formH+cardsH+'</div>';
}

function contactForm(){
  var f=ST.ctf;
  var pct=f.ownPct!=null?f.ownPct:100;
  return '<div class="fbox" id="ctf">'
    +'<h3>'+(ST.editId?'Edit':'New')+' Contact</h3>'
    +'<div class="frow c2">'+field('Name','ctf-n',{ph:'Jane Smith',val:f.name||'',req:true,err:f.errs&&f.errs.n})+field('Role / Title','ctf-ro',{ph:'Associate Attorney',val:f.role||''})+'</div>'
    +'<div class="frow c2">'+field('Email','ctf-e',{type:'email',ph:'jane@firm.com',val:f.email||'',err:f.errs&&f.errs.e})+field('Phone','ctf-p',{type:'tel',ph:'(555) 123-4567',val:f.phone||'',oninput:"A.livePhone('ctf-p')"})+'</div>'
    +'<div class="frow c2">'+field('Default Rate ($/hr)','ctf-rate',{pfx:'$',ph:'175.00',val:f.rate||'',hint:'Auto-fills when this person is assigned to an entry'})+(ST.prefs.revenueSplit?field('Personal Cut %','ctf-op',{type:'number',sfx:'%',ph:'100',val:String(pct),hint:'% of billed amount this person keeps (firm gets the rest)'}):'')+'</div>'
    +(ST.prefs.revenueSplit?'<div class="frow c2">'+field('Annual Salary','ctf-sal',{pfx:'$',ph:'120,000',val:f.salary!=null&&f.salary!==''?String(f.salary):'',hint:'Used to calculate net income and bonus/deficit vs. billed earnings'})+'<div></div>'+'</div>':'')
    +'<div class="fa"><button class="btn btn-gh" onclick="A.closeF()">Cancel</button><button class="btn btn-dk" onclick="A.saveCt()">'+IC.save+' Save Contact</button></div>'
    +'</div>';
}

// == Analytics ==
function vAnalytics(){
  var fe=filterEnt(ST.entries,ST.anFilter);
  var hrs=fe.reduce(function(s,e){return s+Number(e.hours);},0);
  var bill=fe.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);

  // Salary prorated to current filter period
  var salPeriodFn=function(annual){ return salaryForPeriod(annual,ST.anFilter); };
  var salLbl=salaryPeriodLabel(ST.anFilter); // e.g. "monthly (÷12)"

  // Revenue split: per team member (includes salary & prorated income calc)
  var contactSplit=ST.contacts.map(function(c){
    var ces=fe.filter(function(e){return e.contactId==c.id;});
    var chrs=ces.reduce(function(s,e){return s+Number(e.hours);},0);
    var cbill=ces.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
    var pct=c.ownPct!=null?Number(c.ownPct):100;
    var own=cbill*pct/100;
    var annualSal=c.salary!=null&&c.salary!==''?Number(c.salary):null;
    var periodSal=salPeriodFn(annualSal);
    var net=periodSal!=null?own-periodSal:null;
    return {id:c.id,name:c.name,hrs:chrs,bill:cbill,ownPct:pct,own:own,firm:cbill*(100-pct)/100,
            annualSalary:annualSal,periodSalary:periodSal,net:net};
  }).filter(function(c){return c.hrs>0;});

  // Unassigned entries
  var unassignedEntries=fe.filter(function(e){
    if(!e.contactId) return true;
    return !ST.contacts.find(function(c){return c.id==e.contactId;});
  });
  var uHrs=unassignedEntries.reduce(function(s,e){return s+Number(e.hours);},0);
  var uBill=unassignedEntries.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
  var userPct=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
  var userAnnualSalary=ST.user&&ST.user.salary!=null&&ST.user.salary!==''?Number(ST.user.salary):null;
  if(uHrs>0){
    var uOwn=uBill*userPct/100;
    contactSplit.push({id:'__unassigned',name:'(Unassigned)',hrs:uHrs,bill:uBill,ownPct:userPct,
      own:uOwn,firm:uBill*(100-userPct)/100,annualSalary:null,periodSalary:null,net:null});
  }

  var totalOwn=contactSplit.reduce(function(s,c){return s+c.own;},0);
  var totalFirm=contactSplit.reduce(function(s,c){return s+c.firm;},0);

  var byClient=ST.clients.map(function(c){
    var es=fe.filter(function(e){return e.clientId==c.id;});
    return {name:c.name,hrs:es.reduce(function(s,e){return s+Number(e.hours);},0),
            bill:es.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0)};
  }).filter(function(c){return c.hrs>0;}).sort(function(a,b){return b.bill-a.bill;});
  var maxB=byClient.length?byClient[0].bill:1;

  // Filter options — rolling + calendar periods
  var filterGroups=[
    {label:'Rolling',opts:[
      {v:'week',l:'Past Week'},{v:'month',l:'Past Month'},
      {v:'quarter',l:'Past Quarter'},{v:'year',l:'Past Year'},{v:'all',l:'All Time'}
    ]},
    {label:'Calendar',opts:[
      {v:'this_month',l:'This Month'},{v:'this_quarter',l:'This Quarter'},{v:'this_year',l:'This Year'}
    ]}
  ];
  var fopts=filterGroups.map(function(g){
    return '<optgroup label="'+g.label+'">'+g.opts.map(function(o){
      return '<option value="'+o.v+'"'+(ST.anFilter===o.v?' selected':'')+'>'+o.l+'</option>';
    }).join('')+'</optgroup>';
  }).join('');

  var periodLblMap={week:'Past Week',month:'Past Month',quarter:'Past Quarter',year:'Past Year',
    all:'All Time',this_month:'This Month',this_quarter:'This Quarter',this_year:'This Year'};
  var periodLbl=periodLblMap[ST.anFilter]||'All Time';

  var barsH=byClient.length?'<div class="card" style="margin-top:20px">'
    +'<h3 style="font-weight:500;margin-bottom:16px;font-size:.93rem">Revenue by Client</h3>'
    +byClient.map(function(c){
      return '<div class="bar-row"><div class="bar-lbl"><span>'+H(c.name)+'</span>'
        +'<span><strong>'+$m(c.bill)+'</strong> <span style="color:var(--ink3);font-size:12px">'+$h(c.hrs)+'</span></span></div>'
        +'<div class="bar-track"><div class="bar-fill" style="width:'+((c.bill/maxB)*100).toFixed(1)+'%"></div></div></div>';
    }).join('')+'</div>':'';

  // ---- Revenue Split card ----
  var splitH='';
  if(ST.prefs.revenueSplit && contactSplit.length>0){
    var userPctDisplay=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
    var anySalary=ST.contacts.some(function(c){return c.salary!=null&&c.salary!=='';}) || (userAnnualSalary!=null);
    var hasSalLbl=anySalary&&salLbl; // only show salary cols if period is prorateable
    // Column header note
    var salColHdr=hasSalLbl?'Salary <span style="font-weight:400;font-size:10px;color:var(--ink3)">('+salLbl+')</span>':'Salary';
    splitH='<div class="card" style="margin-top:20px">'
      +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">'+IC.pie+'<h3 style="font-weight:500;font-size:.93rem;margin:0">Revenue Split (Own vs. Firm)</h3></div>'
      +'<div style="margin-bottom:14px">'
      +'<label class="fl" style="display:flex;align-items:center;gap:12px">'
      +'<span style="font-size:12px;color:var(--ink2);white-space:nowrap">Your personal cut %</span>'
      +'<input type="number" id="an-upct" min="0" max="100" step="1" value="'+H(String(userPctDisplay))+'" oninput="A.setUserPct(this.value)" style="width:80px;padding:6px 10px;border:1px solid var(--border);border-radius:7px;font-size:13px">'
      +'<span style="font-size:12px;color:var(--ink3)">applies to unassigned entries</span>'
      +'</label></div>'
      +'<div class="tscroll"><table class="split-table">'
      +'<thead><tr><th>Team Member</th><th>Cut</th><th>Hours</th><th>Billed</th><th class="own-amt">Own</th><th class="firm-amt">Firm</th>'
      +(anySalary?'<th>'+salColHdr+'</th><th>Net Income</th><th>Status</th>':'')
      +'</tr></thead>'
      +'<tbody>'
      +contactSplit.map(function(c){
        var statusCell='';
        if(anySalary){
          if(c.annualSalary!=null&&c.periodSalary!=null&&salLbl){
            var isBonus=c.net>=0;
            var statusLabel=isBonus?'+'+$m(c.net)+' bonus':$m(Math.abs(c.net))+' short';
            var statusCls=isBonus?'good':'danger';
            statusCell='<td>'+$m(c.periodSalary)+'</td>'
              +'<td><strong>'+$m(c.own - c.periodSalary)+'</strong></td>'
              +'<td><span class="'+statusCls+'" style="font-size:11px;padding:2px 7px;border-radius:10px;display:inline-block;white-space:nowrap">'+statusLabel+'</span></td>';
          } else if(c.annualSalary!=null&&!salLbl){
            // "All time" - can't prorate, show annual for reference only
            statusCell='<td style="color:var(--ink3);font-size:11px">'+$m(c.annualSalary)+'/yr</td>'
              +'<td style="color:var(--ink3);font-size:11px">\u2014</td>'
              +'<td style="color:var(--ink3);font-size:11px">Select a period</td>';
          } else {
            statusCell='<td style="color:var(--ink3);font-size:11px">\u2014</td><td style="color:var(--ink3);font-size:11px">\u2014</td><td style="color:var(--ink3);font-size:11px">No salary set</td>';
          }
        }
        return '<tr>'
          +'<td>'+H(c.name)+'</td>'
          +'<td><span class="split-pill"><span class="own">'+c.ownPct+'%</span></span></td>'
          +'<td>'+$h(c.hrs)+'</td>'
          +'<td>'+$m(c.bill)+'</td>'
          +'<td class="own-amt"><strong>'+$m(c.own)+'</strong></td>'
          +'<td class="firm-amt"><strong>'+$m(c.firm)+'</strong></td>'
          +statusCell
          +'</tr>';
      }).join('')
      +'<tr style="background:var(--bg)">'
      +'<td><strong>Total</strong></td><td></td>'
      +'<td><strong>'+$h(hrs)+'</strong></td>'
      +'<td><strong>'+$m(bill)+'</strong></td>'
      +'<td class="own-amt"><strong>'+$m(totalOwn)+'</strong></td>'
      +'<td class="firm-amt"><strong>'+$m(totalFirm)+'</strong></td>'
      +(anySalary?'<td></td><td></td><td></td>':'')
      +'</tr>'
      +'</tbody></table></div></div>';
  }

  // ---- My Earnings card (current user only) ----
  var myEarningsH='';
  if(ST.prefs.revenueSplit){
    var me=ST.contacts.find(function(c){return c.isUser;});
    if(me){
      var myEntry=contactSplit.find(function(c){return c.id==me.id;});
      var myOwn=myEntry?myEntry.own:0;
      var myHrs=myEntry?myEntry.hrs:0;
      var myBill=myEntry?myEntry.bill:0;
      var myAnnualSal=me.salary!=null&&me.salary!==''?Number(me.salary):null;
      var myPeriodSal=salPeriodFn(myAnnualSal);
      var myCut=me.ownPct!=null?Number(me.ownPct):100;

      var myRows=[
        ['Billed ('+periodLbl+')', $m(myBill),''],
        ['Your Cut ('+myCut+'%)', $m(myOwn),'highlight']
      ];
      var myDetail='';
      if(myAnnualSal!=null){
        if(myPeriodSal!=null&&salLbl){
          var myNet=myOwn-myPeriodSal;
          var bonusLbl=myNet>=0?'Bonus':'Shortfall';
          var bonusCls=myNet>=0?'highlight':'highlight2';
          myRows.push(['Salary ('+salLbl+')', $m(myPeriodSal),'']);
          myRows.push([bonusLbl+' vs Salary', (myNet>=0?'+':'')+$m(myNet), bonusCls]);

          // Annualized projection
          var annFracs={week:52,month:12,quarter:4,year:1,this_month:12,this_quarter:4,this_year:1};
          var annFac=annFracs[ST.anFilter];
          var projAnnOwn=annFac?myOwn*annFac:null;

          myDetail='<div style="margin-top:14px;display:grid;gap:8px">'
            // Period summary bar
            +'<div style="padding:12px 16px;border-radius:8px;background:var(--bg);font-size:12px;line-height:1.8">'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Period billed</span><strong>'+$m(myBill)+'</strong></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Your cut ('+myCut+'%)</span><strong style="color:#166534">'+$m(myOwn)+'</strong></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Salary ('+salLbl+')</span><strong>'+$m(myPeriodSal)+'</strong></div>'
            +'<div style="height:1px;background:var(--border);margin:6px 0"></div>'
            +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink3)">Net (cut − salary)</span><strong class="'+(myNet>=0?'good':'danger')+'">'+(myNet>=0?'+':'')+$m(myNet)+'</strong></div>'
            +'</div>'
            // Annualised projection (only for rolling periods with clean multipliers)
            +(projAnnOwn&&annFac&&annFac!==1?'<div style="padding:10px 16px;border-radius:8px;background:var(--bg);border-left:3px solid var(--border);font-size:12px">'
              +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px">Annualised Projection</div>'
              +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--ink2)">Projected annual cut</span><strong>'+$m(projAnnOwn)+'</strong></div>'
              +'<div style="display:flex;justify-content:space-between"><span style="color:var(--ink2)">vs Annual salary ('+$m(myAnnualSal)+')</span>'
              +'<strong class="'+(projAnnOwn-myAnnualSal>=0?'good':'danger')+'">'+(projAnnOwn-myAnnualSal>=0?'+':'')+$m(projAnnOwn-myAnnualSal)+'</strong></div>'
              +'</div>':'')
            +'</div>';
        } else if(!salLbl){
          // "All time" - show annual salary for reference
          myRows.push(['Annual Salary', $m(myAnnualSal),'']);
          myDetail='<div style="margin-top:10px;padding:10px 14px;border-radius:8px;background:var(--bg);font-size:12px;color:var(--ink3)">'
            +'Select a specific period (month, quarter, year) to compare earnings against salary.</div>';
        }
      }

      myEarningsH='<div class="card" style="margin-top:20px">'
        +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">'+IC.usr
        +'<h3 style="font-weight:500;font-size:.93rem;margin:0">My Earnings \u2014 '+H(me.name)+'</h3>'
        +(myAnnualSal==null?'<button class="btn-link" onclick="A.chgUser()" style="font-size:11px;margin-left:6px">Set salary</button>':'')
        +'</div>'
        +stats(myRows)
        +myDetail
        +'</div>';
    }
  }

  var emptyH=fe.length===0?'<div class="empty"><div class="empty-ico">&#128202;</div><p>No data for this period</p><small>Log some time entries first</small></div>':'';
  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Analytics</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">'+fe.length+' entries \u00b7 '+periodLbl+'</p></div>'
    +'<select onchange="A.setAnF(this.value)" style="padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)">'+fopts+'</select>'
    +'</div>'
    +(ST.prefs.revenueSplit?stats([['Total Billing',$m(bill),''],['Total Hours',$h(hrs),''],['Own Portion',$m(totalOwn),'highlight'],['Firm Portion',$m(totalFirm),'highlight2']]):stats([['Total Billing',$m(bill),''],['Total Hours',$h(hrs),'']]))
    +barsH+myEarningsH+splitH+emptyH+'</div>';
}


// == Approvals (partner-only full view, attorney status view) ==
function vApprovals(){
  var role=myRole();
  var pending=ST.entries.filter(function(e){return (e.status||'approved')==='pending';});
  var approved=ST.entries.filter(function(e){return (e.status||'approved')==='approved';});
  var rejected=ST.entries.filter(function(e){return e.status==='rejected';});

  if(role!=='partner'){
    // Attorneys and billing staff see their own entry statuses
    var me=ST.user?ST.user.name:'';
    var mine=ST.entries.filter(function(e){return e.createdBy===me;}).sort(function(a,b){return new Date(b.date)-new Date(a.date);});
    var rows=mine.map(function(e){
      var cl=_lu.cl[e.clientId];
      var mt=_lu.ma[e.matterId];
      var st=e.status||'approved';
      return '<tr>'
        +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
        +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
        +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+'</td>'
        +'<td>'+$h(e.hours)+'</td>'
        +'<td style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</td>'
        +'<td>'+statusBadge(st)+'</td>'
        +'<td style="font-size:12px;color:var(--ink3)">'+H(e.approvedBy?'by '+e.approvedBy:'')+'</td>'
        +'<td style="font-size:12px;max-width:180px">'+(e.partnerComment?'<span style="color:var(--amber);font-style:italic">'+IC.comment+' '+H(e.partnerComment)+'</span>':'')+
          (e.partnerEdited?'<span class="badge" style="font-size:10px;background:var(--amber);color:#fff;margin-left:4px" title="Partner adjusted hours/rate/description">edited</span>':'')+'</td>'
        +'</tr>';
    }).join('');
    var tableH=mine.length?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Hours</th><th>Amount</th><th>Status</th><th>Reviewed By</th><th>Partner Notes</th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
      :'<div class="empty"><div class="empty-ico">&#128203;</div><p>No entries yet</p><small>Start logging time entries to see their approval status here</small></div>';
    return '<div>'
      +'<div style="margin-bottom:18px"><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">My Entry Status</h2>'
      +'<p style="font-size:12px;color:var(--ink3)">'+mine.length+' entr'+(mine.length===1?'y':'ies')+' total</p></div>'
      +stats([['Pending',String(mine.filter(function(e){return (e.status||'approved')==='pending';}).length),'highlight2'],['Approved',String(mine.filter(function(e){return (e.status||'approved')==='approved';}).length),'highlight'],['Rejected',String(mine.filter(function(e){return e.status==='rejected';}).length),'']])
      +(role==='billing_staff'?'<div class="role-notice">'+IC.shield+' Billing staff do not submit time entries.</div>':'')
      +tableH+'</div>';
  }

  // Partner view
  var pendingRows=pending.sort(function(a,b){return new Date(a.date)-new Date(b.date);}).map(function(e){
    var cl=_lu.cl[e.clientId];
    var mt=_lu.ma[e.matterId];
    var mnDisplay=(mt&&mt.matterNumber)?'<span style="font-family:monospace;font-size:10px;color:var(--blue);display:block">#'+H(mt.matterNumber)+'</span>':'';
    var abaDisplay=e.abaCode?'<span style="font-family:monospace;font-size:10px;color:var(--ink3)">'+H(e.abaCode)+'</span>':'<span style="font-size:10px;color:var(--amber)" title="No ABA code set">⚠ no code</span>';
    return '<tr>'
      +'<td style="white-space:nowrap;color:var(--ink2)">'+$d(e.date)+'</td>'
      +'<td style="font-weight:500">'+H(cl?cl.name:'?')+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'General')+mnDisplay+'</td>'
      +'<td>'+$h(e.hours)+'</td>'
      +'<td style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</td>'
      +'<td style="color:var(--ink2);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+H(e.description||'')+'">'+H(e.description||'-')+'</td>'
      +'<td>'+abaDisplay+'</td>'
      +'<td><span class="badge" title="'+H(e.createdBy||'')+'">'+H(e.createdByIni||'?')+'</span></td>'
      +'<td><div class="tda">'
        +'<button class="btn btn-gr" onclick="A.approveEnt('+e.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.check+' Approve</button>'
        +'<button class="btn btn-gh" onclick="A.openPartnerReview('+e.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.edit+' Review</button>'
        +'<button class="btn btn-rd" onclick="A.rejectEnt('+e.id+')" style="padding:5px 10px;font-size:12px">Reject</button>'
      +'</div></td>'
      +'</tr>';
  }).join('');

  var pendingTableH=pending.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>Date</th><th>Client</th><th>Matter</th><th>Hours</th><th>Amount</th><th>Description</th><th>ABA Code</th><th>By</th><th>Action</th></tr></thead>'
      +'<tbody>'+pendingRows+'</tbody></table></div></div>'
    :'<div class="empty"><div class="empty-ico">&#10003;</div><p>No pending entries</p><small>All caught up!</small></div>';

  var approveAllBtn=pending.length>1?'<button class="btn btn-gr" onclick="A.approveAll()" style="margin-left:auto">'+IC.check+' Approve All ('+pending.length+')</button>':'';
  var returnToBillingBtn=approved.length>0?'<button class="btn btn-bl" onclick="A.openSubmitTimesheet()" title="Send approved entries back to billing staff for invoicing" style="gap:5px">📤 Return to Billing ('+approved.length+')</button>':'';
  var receivePackageBtn='<button class="btn btn-gh" onclick="A.openReceivePackage()" title="Import a billing review package from billing staff" style="gap:5px">📥 Receive Package</button>';

  // Invoices pending review
  var invsPending=(ST.invoices||[]).filter(function(i){return i.status==='review';});
  var invReviewRows=invsPending.map(function(inv){
    var cl=_lu.cl[inv.clientId]||{name:'?'};
    var mt=inv.matterId?_lu.ma[inv.matterId]:null;
    var total=invTotal(inv);
    return '<tr>'
      +'<td style="font-weight:600;color:var(--blue)">#'+H(inv.number||inv.id)+'</td>'
      +'<td style="font-weight:500">'+H(cl.name)+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'All Matters')+'</td>'
      +'<td>'+(inv.entryIds?inv.entryIds.length:0)+' entries</td>'
      +'<td style="color:var(--green);font-weight:600">'+$m(total)+'</td>'
      +'<td style="color:var(--ink3);font-size:12px">'+$d(inv.invoiceDate)+'</td>'
      +'<td><div class="tda">'
        +'<button class="btn btn-dk" onclick="A.invOpenReview('+inv.id+')" style="padding:5px 10px;font-size:12px;gap:4px">'+IC.shield+' Review</button>'
        +'<button class="btn-ic" title="Email Invoice to Client" onclick="A.emailInvoice('+inv.id+')">'+IC.mail+'</button>'
        +'<button class="btn-ic" title="Preview" onclick="A.invPrint('+inv.id+')">'+IC.print+'</button>'
      +'</div></td>'
      +'</tr>';
  }).join('');
  var invReviewTableH=invsPending.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>#</th><th>Client</th><th>Matter</th><th>Entries</th><th>Total</th><th>Date</th><th>Action</th></tr></thead>'
      +'<tbody>'+invReviewRows+'</tbody></table></div></div>'
    :'<div class="empty" style="padding:20px"><div class="empty-ico" style="font-size:1.8rem">&#10003;</div><p>No invoices pending review</p></div>';

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">Approvals</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">Review time entries and invoices</p></div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap">'+receivePackageBtn+returnToBillingBtn+approveAllBtn+'</div></div>'
    +stats([['Pending Entries',String(pending.length),'highlight2'],['Invoices to Review',String(invsPending.length),invsPending.length>0?'highlight2':''],['Approved Entries',String(approved.length),'highlight'],['Rejected',String(rejected.length),'']])
    +'<div class="appr-panel" style="margin-bottom:16px">'
    +'<h3>'+IC.invoice+' Invoices Pending Review'+(invsPending.length>0?' <span style="background:var(--amber);color:#fff;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:6px">'+invsPending.length+'</span>':'')+'</h3>'
    +invReviewTableH+'</div>'
    +'<div class="appr-panel">'
    +'<h3>'+IC.clock+' Pending Time Entries</h3>'
    +pendingTableH+'</div>'
    +'</div>';
}

// == Invoices ==
function vInvoices(){
  var role=myRole();
  var invs=ST.invoices||[];
  // Filter
  var fil=ST.invFilter||'all';
  var shown=fil==='all'?invs:invs.filter(function(i){return i.status===fil;});
  shown=shown.slice().sort(function(a,b){return b.id-a.id;});

  var fOpts=['all','draft','review','approved','sent'].map(function(v){
    var l={all:'All',draft:'Draft',review:'In Review',approved:'Approved',sent:'Sent'}[v];
    var cnt=v==='all'?invs.length:invs.filter(function(i){return i.status===v;}).length;
    return '<option value="'+v+'"'+(fil===v?' selected':'')+'>'+l+' ('+cnt+')</option>';
  }).join('');

  var rows=shown.map(function(inv){
    var cl=_lu.cl[inv.clientId];
    var mt=inv.matterId?_lu.ma[inv.matterId]:null;
    var total=invTotal(inv);
    var stCls={draft:'s-pending',review:'s-pending',approved:'s-approved',sent:'s-approved'}[inv.status]||'s-pending';
    var stLbl={draft:'Draft',review:'In Review',approved:'Approved',sent:'Sent'}[inv.status]||inv.status;
    var btns='<div class="tda">'
      +'<button class="btn-ic" title="Email Invoice to Client" onclick="A.emailInvoice('+inv.id+')">'+IC.mail+'</button>'
      +'<button class="btn-ic" title="Preview/Print" onclick="A.invPrint('+inv.id+')">'+IC.print+'</button>'
      // Partners can review any non-sent invoice
      +(role==='partner'&&inv.status!=='sent'?'<button class="btn btn-dk" style="padding:4px 10px;font-size:12px" onclick="A.invOpenReview('+inv.id+')">'+IC.shield+' Review</button>':'')
      // Non-partners can send draft invoices for review
      +(role!=='partner'&&inv.status==='draft'?'<button class="btn btn-bl" style="padding:4px 10px;font-size:12px" onclick="A.invSendForReview('+inv.id+')">'+IC.send+' Send for Review</button>':'')
      +(role!=='partner'&&(inv.status==='draft'||inv.status==='review')?'<button class="btn btn-gh" style="padding:4px 10px;font-size:12px" onclick="A.emailEntries(\'partner_approval\')" title="Email billing entries to a partner for approval">'+IC.mail+' Email for Approval</button>':'')
      +(inv.status==='approved'&&role!=='partner'?'<button class="btn btn-gr" style="padding:4px 10px;font-size:12px" onclick="A.invMarkSent('+inv.id+')">'+IC.send+' Mark Sent</button>':'')
      +'<button class="btn-ic" title="Edit" onclick="A.invEdit('+inv.id+')">'+IC.edit+'</button>'
      +'<button class="btn-ic" title="Delete" onclick="A.invDel('+inv.id+')" style="color:var(--red)">'+IC.trash+'</button>'
      +'</div>';
    return '<tr>'
      +'<td style="font-weight:600;color:var(--blue)">#'+H(inv.number||inv.id)+'</td>'
      +'<td style="font-weight:500">'+H(cl?cl.name:'—')+'</td>'
      +'<td style="color:var(--ink2)">'+H(mt?mt.name:'All Matters')+'</td>'
      +'<td style="color:var(--ink2)">'+$d(inv.invoiceDate)+'</td>'
      +'<td style="color:var(--ink3)">'+H(inv.entryIds?inv.entryIds.length+' entries':'—')+'</td>'
      +'<td style="color:var(--green);font-weight:600">'+$m(total)+'</td>'
      +'<td><span class="status-badge '+stCls+'">'+H(stLbl)+'</span></td>'
      +'<td>'+btns+'</td>'
      +'</tr>';
  }).join('');

  var totalBilled=shown.reduce(function(s,i){return s+invTotal(i);},0);
  var draftCnt=invs.filter(function(i){return i.status==='draft';}).length;
  var reviewCnt=invs.filter(function(i){return i.status==='review';}).length;
  var sentCnt=invs.filter(function(i){return i.status==='sent';}).length;

  var tableH=shown.length
    ?'<div class="twrap"><div class="tscroll"><table>'
      +'<thead><tr><th>#</th><th>Client</th><th>Matter</th><th>Date</th><th>Entries</th><th>Total</th><th>Status</th><th></th></tr></thead>'
      +'<tbody>'+rows+'</tbody></table></div></div>'
    :'<div class="empty"><div class="empty-ico">&#128196;</div><p>No invoices yet</p><small>Create an invoice from approved time entries</small></div>';

  return '<div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:12px">'
    +'<div><h2 style="font-size:1.3rem;font-weight:300;margin-bottom:3px">'+IC.invoice+' Invoices</h2>'
    +'<p style="font-size:12px;color:var(--ink3)">Create, review, and send client invoices</p></div>'
    +'<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">'
    +'<select onchange="A.invSetFilter(this.value)" style="font-size:13px;padding:5px 8px;border:1px solid var(--brd);border-radius:6px;background:var(--bg)">'+fOpts+'</select>'
    +'<button class="btn btn-dk" onclick="A.invNew()">'+IC.plus+' New Invoice</button>'
    +'</div></div>'
    +stats([['Drafts',String(draftCnt),''],['In Review',String(reviewCnt),'highlight2'],['Sent',String(sentCnt),'highlight'],['Total Billed',$m(totalBilled),'']])
    +tableH+'</div>';
}

// Invoice total calculator (applies cuts)
function invTotal(inv){
  if(!inv||!inv.entryIds) return 0;
  buildEntryLookup(); // ensure _lu.en is populated
  var cuts=inv.cuts||{};
  var merged=inv.mergedEntries||[];
  var mergedEntryIds={};
  merged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedEntryIds[eid]=true;});});
  var t=0;
  inv.entryIds.forEach(function(eid){
    if(mergedEntryIds[eid]) return;
    var e=_lu.en[eid];
    if(!e) return;
    var h=cuts[eid]!=null?Number(cuts[eid]):Number(e.hours);
    t+=h*Number(e.rate||0);
  });
  merged.forEach(function(mg){t+=Number(mg.hours||0)*Number(mg.rate||0);});
  return t;
}

// Invoice form modal (create / edit)
function buildInvoiceForm(){
  var f=ST.invf||{};
  var isEdit=!!ST.editId;
  var clOpts=[{v:'',l:'— Select Client —'}].concat(ST.clients.map(function(c){return {v:c.id,l:c.name};}));
  var mtOpts=[{v:'',l:'All Matters'}].concat(
    (f.clientId?ST.matters.filter(function(m){return m.clientId==f.clientId;}):ST.matters)
    .map(function(m){return {v:m.id,l:m.name};})
  );
  var statusOpts=[{v:'draft',l:'Draft'},{v:'review',l:'Send for Review'},{v:'approved',l:'Approved'},{v:'sent',l:'Sent'}];

  // Entry picker: approved entries for selected client/matter not already invoiced
  var invoicedIds={};
  (ST.invoices||[]).forEach(function(inv){
    if(isEdit&&inv.id==ST.editId) return; // exclude self when editing
    (inv.entryIds||[]).forEach(function(eid){invoicedIds[eid]=inv.number||inv.id;});
  });
  var candidateEnts=ST.entries.filter(function(e){
    if(e.status!==undefined&&e.status!=='approved') return false; // only approved
    if(f.clientId&&e.clientId!=f.clientId) return false;
    if(f.matterId&&e.matterId!=f.matterId) return false;
    return true;
  }).sort(function(a,b){return new Date(a.date)-new Date(b.date);});
  var selIds=f.entryIds||[];
  var selSet={};
  selIds.forEach(function(id){selSet[id]=true;});

  var entryRows=candidateEnts.map(function(e){
    var cl2=_lu.cl[e.clientId];
    var mt2=_lu.ma[e.matterId];
    var alreadyInv=invoicedIds[e.id];
    var dis=!!alreadyInv;
    var chk=selSet[e.id]?'checked':'';
    return '<label style="display:flex;align-items:flex-start;gap:8px;padding:6px 8px;border-radius:6px;cursor:'+(dis?'default':'pointer')+';background:'+(selSet[e.id]?'var(--blue-pale)':'transparent')+';border:1px solid '+(selSet[e.id]?'var(--blue)':'transparent')+';margin-bottom:3px;opacity:'+(dis?0.45:1)+'">'
      +'<input type="checkbox" '+(dis?'disabled':'')+' '+chk+' onchange="A.invTogEnt('+e.id+')" style="margin-top:2px;flex-shrink:0">'
      +'<div style="flex:1;min-width:0">'
      +'<div style="display:flex;justify-content:space-between;gap:8px"><span style="font-size:13px;font-weight:500">'+$d(e.date)+'</span><span style="font-size:12px;color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</span></div>'
      +'<div style="font-size:12px;color:var(--ink2)">'+H(cl2?cl2.name:'')+' · '+H(mt2?mt2.name:'General')+' · '+$h(e.hours)+' @ '+$m(e.rate)+'/hr</div>'
      +(e.description?'<div style="font-size:11px;color:var(--ink3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+H(e.description)+'</div>':'')
      +(alreadyInv?'<div style="font-size:11px;color:var(--amber)">Already on invoice #'+H(alreadyInv)+'</div>':'')
      +'</div></label>';
  }).join('');

  var selAmt=selIds.reduce(function(s,eid){
    var e=_lu.en[eid]; return e?s+Number(e.hours)*Number(e.rate):s;
  },0);

  var firmName=f.firmName!=null?f.firmName:(ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'');

  return '<div class="ov"><div class="modal modal-lg" style="max-height:90vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+(isEdit?IC.edit+' Edit Invoice':''+IC.invoice+' New Invoice')+'</h2>'
    +'<button class="btn-ic" onclick="A.closeF()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Invoice #','inv-num',{val:H(f.number||''),ph:'Auto-assigned if blank'})
    +field('Invoice Date','inv-date',{type:'date',val:f.invoiceDate||today()})
    +field('Due Date','inv-due',{type:'date',val:f.dueDate||''})
    +field('Status','inv-status',{type:'select',val:f.status||'draft',opts:statusOpts})
    +'</div>'

    +'<div style="background:var(--bg2);border-radius:8px;padding:14px;margin:8px 0">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:10px">Firm / From</h4>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Firm Name','inv-firm',{val:H(firmName),ph:'Your firm name'})
    +field('Phone','inv-fphone',{val:H(f.firmPhone||''),ph:'Firm phone'})
    +field('Address','inv-faddr',{val:H(f.firmAddress||''),ph:'Firm address',type:'textarea',rows:2})
    +field('Email','inv-femail',{type:'email',val:H(f.firmEmail||''),ph:'billing@yourfirm.com'})
    +'</div></div>'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Client','inv-cl',{type:'select',val:f.clientId||'',opts:clOpts,req:true,err:f.errs&&f.errs.clientId})
    +field('Matter (optional)','inv-mt',{type:'select',val:f.matterId||'',opts:mtOpts})
    +'</div>'

    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">'
    +field('Payment Terms','inv-terms',{val:H(f.paymentTerms||'Net 30'),ph:'Net 30'})
    +field('Tax Rate %','inv-tax',{val:H(f.taxPct||''),ph:'0',type:'number',sfx:'%'})
    +'</div>'

    +field('Notes / Work Description','inv-notes',{val:H(f.notes||''),type:'textarea',rows:3,ph:'Summary of services rendered...'})
    +field('Footer Note','inv-footer',{val:H(f.footerNote||''),ph:'e.g. Thank you for your business'})

    +'<div style="margin-top:14px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3)">Time Entries</h4>'
    +'<div style="font-size:12px;color:var(--ink2)"><strong>'+selIds.length+' selected</strong> · '+$m(selAmt)+'</div></div>'
    +(f.clientId
      ?'<div style="max-height:240px;overflow-y:auto;border:1px solid var(--brd);border-radius:8px;padding:8px">'
        +(candidateEnts.length?entryRows:'<div style="text-align:center;padding:20px;color:var(--ink3);font-size:13px">No approved entries for this selection</div>')
        +'</div>'
      :'<div style="text-align:center;padding:20px;background:var(--bg2);border-radius:8px;color:var(--ink3);font-size:13px">Select a client to load time entries</div>')
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeF()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.invSave()">'+IC.save+' '+(isEdit?'Update Invoice':'Create Invoice')+'</button>'
    +'</div></div></div>';
}

// Invoice review modal (partner cuts/merges/comments)
function buildInvoiceReview(){
  buildEntryLookup(); // invoice review needs _lu.en — build it lazily here
  var rev=ST.invRev||{};
  var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
  if(!inv) return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2>Review</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div><div class="modal-bd"><p>Invoice not found</p></div></div></div>';
  var cl=_lu.cl[inv.clientId]||{name:'?'};
  var mt=inv.matterId?_lu.ma[inv.matterId]:null;

  var cuts=rev.cuts||{};
  var comments=rev.comments||{};
  var pendingMerge=rev.pendingMerge||[];
  var pmSet={};
  pendingMerge.forEach(function(id){pmSet[id]=true;});

  // Merged entries already in invoice
  var existingMerged=inv.mergedEntries||[];
  var mergedIds={};
  existingMerged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedIds[eid]=mg.id;});});

  var entryRows=(inv.entryIds||[]).map(function(eid){
    var e=_lu.en[eid];
    if(!e) return '';
    if(mergedIds[eid]) return ''; // skip already-merged
    var origH=Number(e.hours);
    var cutH=cuts[eid]!=null?Number(cuts[eid]):origH;
    var amt=cutH*Number(e.rate||0);
    var hasCut=cutH<origH;
    var cmtVal=H(comments[eid]||'');
    var inMerge=pmSet[eid];
    return '<div style="border:1px solid '+(inMerge?'var(--blue)':hasCut?'var(--amber)':'var(--brd)')+';border-radius:8px;padding:10px 12px;margin-bottom:8px;background:'+(inMerge?'var(--blue-pale)':hasCut?'rgba(251,191,36,.06)':'var(--bg)')+'">'
      +'<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">'
      +'<div style="flex:1;min-width:200px">'
      +'<div style="font-size:13px;font-weight:500;margin-bottom:3px">'+$d(e.date)+' — <span style="color:var(--ink2)">'+H(e.description||'No description')+'</span></div>'
      +'<div style="font-size:12px;color:var(--ink3)">'+$h(origH)+' @ '+$m(e.rate)+'/hr &nbsp;·&nbsp; '+H(e.createdBy||'')+'</div>'
      +'</div>'
      +'<div style="display:flex;align-items:center;gap:8px;flex-shrink:0">'
      +'<label style="font-size:12px;color:var(--ink3)">Hours:</label>'
      +'<div style="display:flex;align-items:center;gap:4px">'
      +(hasCut?'<span style="font-size:11px;text-decoration:line-through;color:var(--red)">'+origH+'</span>':'')
      +'<input type="number" value="'+cutH+'" min="0" max="'+origH+'" step="0.01" style="width:68px;padding:4px 6px;border:1px solid var(--brd);border-radius:5px;font-size:13px;background:var(--bg)" onchange="A.invRevCut('+eid+',this.value)">'
      +'</div>'
      +'<span style="font-size:13px;font-weight:600;color:var(--green);min-width:60px;text-align:right">'+$m(amt)+'</span>'
      +'</div></div>'
      +'<div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">'
      +'<input type="text" placeholder="Reviewer comment (optional)..." value="'+cmtVal+'" style="flex:1;min-width:160px;font-size:12px;padding:5px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg)" onchange="A.invRevComment('+eid+',this.value)">'
      +'<button class="btn btn-gh" style="font-size:11px;padding:4px 8px;gap:3px" onclick="A.invRevTogMerge('+eid+')" title="'+(inMerge?'Remove from merge group':'Add to merge group')+'">'
        +IC.merge+(inMerge?' ✓ In Merge':'Merge')+'</button>'
      +(hasCut?'<button class="btn btn-gh" style="font-size:11px;padding:4px 8px" onclick="A.invRevCut('+eid+','+origH+')">Restore</button>':'')
      +'</div>'
      +'</div>';
  }).join('');

  // Merged entry groups
  var mergedRows=existingMerged.map(function(mg,mi){
    return '<div style="border:1px solid var(--blue);border-radius:8px;padding:10px 12px;margin-bottom:8px;background:var(--blue-pale)">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
      +'<span style="font-size:12px;font-weight:600;color:var(--blue)">'+IC.merge+' Merged Entry ('+mg.entryIds.length+' combined)</span>'
      +'<button class="btn btn-rd" style="font-size:11px;padding:3px 8px" onclick="A.invRevUnmerge('+mi+')">Unmerge</button>'
      +'</div>'
      +'<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">'
      +'<div style="flex:1"><input type="text" value="'+H(mg.description||'')+'" placeholder="Merged entry description" style="width:100%;font-size:13px;padding:5px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg)" onchange="A.invRevMergeDesc('+mi+',this.value)"></div>'
      +'<div style="display:flex;gap:6px;align-items:center">'
      +'<input type="number" value="'+mg.hours+'" min="0" step="0.01" style="width:68px;padding:4px 6px;border:1px solid var(--brd);border-radius:5px;font-size:13px;background:var(--bg)" onchange="A.invRevMergeHours('+mi+',this.value)">'
      +'<span style="font-size:12px;color:var(--ink3)">hrs @ '+$m(mg.rate)+'</span>'
      +'<span style="font-size:13px;font-weight:600;color:var(--green)">'+$m(Number(mg.hours)*Number(mg.rate))+'</span>'
      +'</div></div>'
      +'<div style="margin-top:4px;font-size:11px;color:var(--ink3)">Includes: '+mg.entryIds.map(function(eid){var e=_lu.en[eid];return e?$d(e.date)+' '+$h(e.hours):'?';}).join(', ')+'</div>'
      +'</div>';
  }).join('');

  var pendingMergeTotal=pendingMerge.reduce(function(s,eid){
    var e=_lu.en[eid];
    var h=cuts[eid]!=null?Number(cuts[eid]):e?Number(e.hours):0;
    return s+h;
  },0);
  var pendingMergeRate=pendingMerge.length>0?(function(){
    var e=_lu.en[pendingMerge[0]];return e?Number(e.rate||0):0;
  })():0;

  var mergePanel=pendingMerge.length>0
    ?'<div style="background:var(--blue-pale);border:1px solid var(--blue);border-radius:8px;padding:10px 12px;margin-bottom:12px">'
      +'<div style="font-size:12px;font-weight:600;color:var(--blue);margin-bottom:8px">'+IC.merge+' Merge '+pendingMerge.length+' selected entries → single line item</div>'
      +'<input type="text" id="merge-desc" placeholder="Combined description..." style="width:100%;font-size:13px;padding:6px 8px;border:1px solid var(--brd);border-radius:5px;background:var(--bg);margin-bottom:6px">'
      +'<div style="display:flex;gap:8px;align-items:center">'
      +'<span style="font-size:12px;color:var(--ink3)">Total hrs: '+pendingMergeTotal.toFixed(2)+' @ '+$m(pendingMergeRate)+'/hr</span>'
      +'<button class="btn btn-dk" style="font-size:12px;padding:4px 12px;margin-left:auto" onclick="A.invRevCommitMerge()">'+IC.merge+' Commit Merge</button>'
      +'<button class="btn btn-gh" style="font-size:12px;padding:4px 8px" onclick="A.invRevClearMerge()">Clear</button>'
      +'</div></div>'
    :'';

  // Invoice-level comments
  var invComments=rev.invoiceComment||'';
  var savedComments=(inv.comments||[]).map(function(c){
    return '<div style="padding:6px 10px;background:var(--bg2);border-radius:6px;margin-bottom:4px;font-size:12px">'
      +'<strong>'+H(c.by)+'</strong> <span style="color:var(--ink3)">'+$d(c.at)+'</span>'
      +'<div style="margin-top:3px;color:var(--ink2)">'+H(c.text)+'</div>'
      +'</div>';
  }).join('');

  var newTotal=invTotal(Object.assign({},inv,{cuts:cuts,mergedEntries:inv.mergedEntries||[]}));

  return '<div class="ov"><div class="modal modal-lg" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.shield+' Review Invoice #'+H(inv.number||inv.id)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'
    +'<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">'
    +'<div style="flex:1;min-width:200px;background:var(--bg2);padding:10px 14px;border-radius:8px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Client</div>'
    +'<div style="font-weight:600">'+H(cl.name)+'</div>'
    +(mt?'<div style="font-size:12px;color:var(--ink2)">'+H(mt.name)+'</div>':'')+'</div>'
    +'<div style="flex:1;min-width:180px;background:var(--bg2);padding:10px 14px;border-radius:8px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Invoice Total</div>'
    +'<div style="font-weight:700;font-size:1.4rem;color:var(--green)">'+$m(newTotal)+'</div>'
    +'<div style="font-size:11px;color:var(--ink3)">'+(inv.entryIds||[]).length+' entries</div></div>'
    +'</div>'

    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:8px">Time Entries — Cut / Comment / Merge</h4>'
    +mergePanel
    +(existingMerged.length?'<div style="margin-bottom:8px">'+mergedRows+'</div>':'')
    +entryRows

    +'<div style="margin-top:16px;border-top:1px solid var(--brd);padding-top:14px">'
    +'<h4 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink3);margin-bottom:8px">'+IC.comment+' Invoice Comments</h4>'
    +(savedComments||'')
    +'<div style="display:flex;gap:8px;margin-top:8px">'
    +'<input type="text" id="inv-comment-inp" placeholder="Add a review comment..." style="flex:1;font-size:13px;padding:6px 8px;border:1px solid var(--brd);border-radius:6px;background:var(--bg)">'
    +'<button class="btn btn-gh" onclick="A.invRevAddComment()">'+IC.comment+' Add</button>'
    +'</div></div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-gh" style="gap:5px" onclick="A.emailEntries(\'billing_staff\')" title="Email review summary to the billing attorney">'+IC.mail+' Email Summary</button>'
    +'<button class="btn btn-rd" onclick="A.invRevReject()">Reject</button>'
    +'<button class="btn btn-dk" onclick="A.invRevSave()">'+IC.save+' Save &amp; Close</button>'
    +'<button class="btn btn-gr" onclick="A.invRevApprove()">'+IC.check+' Approve Invoice</button>'
    +'</div></div></div>';
}

// Invoice print preview
function buildInvoicePrint(){
  var inv=ST.invoices.find(function(i){return i.id==ST.invPrintId;});
  if(!inv) return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2>Print</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div><div class="modal-bd"><p>Invoice not found</p></div></div></div>';
  var cl=_lu.cl[inv.clientId]||{name:'?',email:'',phone:''};
  var mt=inv.matterId?_lu.ma[inv.matterId]:null;

  var cuts=inv.cuts||{};
  var merged=inv.mergedEntries||[];
  var mergedEntryIds={};
  merged.forEach(function(mg){(mg.entryIds||[]).forEach(function(eid){mergedEntryIds[eid]=true;});});

  // Build line items
  var lineItems=[];
  (inv.entryIds||[]).forEach(function(eid){
    if(mergedEntryIds[eid]) return;
    var e=_lu.en[eid];
    if(!e) return;
    var origH=Number(e.hours);
    var h=cuts[eid]!=null?Number(cuts[eid]):origH;
    if(h<=0) return;
    // Show strikethrough if: hours were cut via invoice review, OR partner edited them directly
    var displayOrigH=null;
    if(cuts[eid]!=null&&Number(cuts[eid])<(e.submittedHours!=null?Number(e.submittedHours):origH)){
      displayOrigH=e.submittedHours!=null?Number(e.submittedHours):origH;
    } else if(e.submittedHours!=null&&Number(e.submittedHours)!==h){
      displayOrigH=Number(e.submittedHours);
    }
    var wasCut=displayOrigH!=null;
    var mt2=_lu.ma[e.matterId];
    var ct2=_lu.ct[e.contactId];
    var cmt=(inv.comments||[]).filter(function(c){return c.entryId==eid;}).map(function(c){return c.text;}).join('; ');
    lineItems.push({date:e.date,desc:e.description||'Legal services',matter:mt2?mt2.name:'',by:ct2?ct2.name:(e.createdBy||''),hours:h,origHours:wasCut?displayOrigH:null,rate:Number(e.rate||0),amount:h*Number(e.rate||0),partnerComment:(e.showCommentOnInvoice&&e.partnerComment)?e.partnerComment:''});
  });
  merged.forEach(function(mg){
    if(Number(mg.hours||0)<=0) return;
    lineItems.push({date:'',desc:mg.description||'Legal services',matter:'',by:'',hours:Number(mg.hours||0),rate:Number(mg.rate||0),amount:Number(mg.hours||0)*Number(mg.rate||0)});
  });
  lineItems.sort(function(a,b){return a.date<b.date?-1:a.date>b.date?1:0;});

  var subtotal=lineItems.reduce(function(s,l){return s+l.amount;},0);
  var taxPct=Number(inv.taxPct||0);
  var taxAmt=subtotal*taxPct/100;
  var total=subtotal+taxAmt;

  var lineRows=lineItems.map(function(l){
    return '<tr>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;color:#555">'+(l.date?$d(l.date):'')+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee">'+H(l.desc)+(l.matter?'<br><span style="font-size:11px;color:#888">'+H(l.matter)+'</span>':'')+''+(l.by?'<br><span style="font-size:11px;color:#aaa">'+H(l.by)+'</span>':'')+(l.partnerComment?'<br><span style="font-size:11px;color:#555;font-style:italic">Note: '+H(l.partnerComment)+'</span>':'')+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right">'+(l.origHours!=null?'<span style="text-decoration:line-through;color:#bbb;font-size:11px;margin-right:5px">'+l.origHours.toFixed(1)+'</span>':'')+l.hours.toFixed(1)+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right">'+$m(l.rate)+'</td>'
      +'<td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #eee;text-align:right;font-weight:600">'+$m(l.amount)+'</td>'
      +'</tr>';
  }).join('');

  var firmName=H(inv.firmName||ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'');
  var firmAddr=H(inv.firmAddress||'');
  var firmPhone=H(inv.firmPhone||'');
  var firmEmail=H(inv.firmEmail||'');
  var invNum=H(inv.number||String(inv.id));

  var html='<div id="inv-print-wrap" style="background:#fff;color:#222;font-family:Georgia,serif;padding:0">'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:32px 40px 24px;border-bottom:3px solid #111">'
    +'<div><div style="font-size:22px;font-weight:700;color:#111;letter-spacing:-.02em">'+firmName+'</div>'
    +(firmAddr?'<div style="font-size:12px;color:#666;margin-top:4px">'+firmAddr.replace(/\n/g,'<br>')+'</div>':'')
    +(firmPhone?'<div style="font-size:12px;color:#666">'+firmPhone+'</div>':'')
    +(firmEmail?'<div style="font-size:12px;color:#666">'+firmEmail+'</div>':'')
    +'</div>'
    +'<div style="text-align:right"><div style="font-size:30px;font-weight:300;color:#111;letter-spacing:-.02em">INVOICE</div>'
    +'<div style="font-size:14px;color:#555;margin-top:4px"># '+invNum+'</div>'
    +'<div style="font-size:12px;color:#888">Date: '+$d(inv.invoiceDate||today())+'</div>'
    +(inv.dueDate?'<div style="font-size:12px;color:#888">Due: '+$d(inv.dueDate)+'</div>':'')
    +'</div></div>'
    +'<div style="display:flex;justify-content:space-between;padding:20px 40px;background:#f8f8f8;border-bottom:1px solid #ddd">'
    +'<div><div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:#999;margin-bottom:4px">Bill To</div>'
    +'<div style="font-weight:700;font-size:15px">'+H(cl.name)+'</div>'
    +(cl.email?'<div style="font-size:12px;color:#666">'+H(cl.email)+'</div>':'')
    +(cl.phone?'<div style="font-size:12px;color:#666">'+H(cl.phone)+'</div>':'')
    +'</div>'
    +'<div style="text-align:right">'
    +(mt?'<div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:#999;margin-bottom:2px">Matter</div><div style="font-weight:600">'+H(mt.name)+'</div>':'')
    +(inv.paymentTerms?'<div style="font-size:12px;color:#666;margin-top:4px">Terms: '+H(inv.paymentTerms)+'</div>':'')
    +'</div></div>'
    +(inv.notes?'<div style="padding:16px 40px;border-bottom:1px solid #eee;font-size:13px;color:#444">'+H(inv.notes)+'</div>':'')
    +'<table style="width:100%;border-collapse:collapse">'
    +'<thead><tr style="background:#f0f0f0"><th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #ddd">Date</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #ddd">Description</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Hours</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Rate</th>'
    +'<th style="padding:10px 10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;text-align:right;font-weight:600;color:#555;border-bottom:2px solid #ddd">Amount</th>'
    +'</tr></thead>'
    +'<tbody>'+lineRows+'</tbody>'
    +'</table>'
    +'<div style="display:flex;justify-content:flex-end;padding:16px 40px">'
    +'<div style="min-width:220px">'
    +'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#555"><span>Subtotal</span><span>'+$m(subtotal)+'</span></div>'
    +(taxPct>0?'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#555"><span>Tax ('+taxPct+'%)</span><span>'+$m(taxAmt)+'</span></div>':'')
    +'<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:16px;font-weight:700;border-top:2px solid #111;margin-top:4px"><span>Total</span><span>'+$m(total)+'</span></div>'
    +'</div></div>'
    +(inv.footerNote?'<div style="padding:16px 40px;border-top:1px solid #eee;font-size:12px;color:#888;font-style:italic">'+H(inv.footerNote)+'</div>':'')
    +'</div>';

  return '<div class="ov"><div class="modal modal-lg" style="max-height:95vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.print+' Invoice Preview #'+invNum+'</h2>'
    +'<div style="display:flex;gap:8px">'
    +'<button class="btn btn-dk" onclick="A.invDoPrint()" style="gap:6px">'+IC.print+' Print</button>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button>'
    +'</div></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1;padding:0;background:#e8e8e8">'
    +'<div style="max-width:820px;margin:20px auto;box-shadow:0 4px 24px rgba(0,0,0,.15)">'+html+'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +(inv.status!=='sent'&&myRole()==='partner'?'<button class="btn btn-dk" onclick="A.invOpenReview('+inv.id+'); A.closeM()">'+IC.shield+' Review</button>':'')
    +(myRole()!=='partner'&&(inv.status==='draft'||inv.status==='review')?'<button class="btn btn-gh" onclick="A.emailEntries(\'partner_approval\')" style="gap:5px">'+IC.mail+' Email for Approval</button>':'')
    +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
    +'<button class="btn btn-gh" onclick="A.emailInvoice('+inv.id+')" style="gap:5px">'+IC.mail+' Email to Client</button>'
    +'<button class="btn btn-gr" onclick="A.invDoPrint()">'+IC.print+' Print / Save PDF</button>'
    +'</div></div></div>';
}

// === MODALS
// == Partner Review Entry Modal ==
function buildPartnerReview(){
  var f=ST.pref||{};
  var e=ST.entries.find(function(x){return x.id==f.entryId;});
  if(!e) return '';
  var cl=ST.clients.find(function(c){return c.id==e.clientId;})||{name:'?'};
  var mt=ST.matters.find(function(m){return m.id==e.matterId;});
  var orig={hours:e.hours,rate:e.rate,description:e.description||''};
  var hoursChanged=String(f.hours)!==String(orig.hours);
  var rateChanged=String(f.rate)!==String(orig.rate);
  var descChanged=(f.description||'')!==(orig.description||'');
  var anyEdited=hoursChanged||rateChanged||descChanged;
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+IC.edit+' Partner Review: Time Entry</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1;min-height:0">'

    // Original entry summary
    +'<div style="background:var(--bg2);border-radius:8px;padding:12px 14px;margin-bottom:16px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:6px">Original Submission</div>'
    +'<div style="font-size:13px;font-weight:500">'+$d(e.date)+' — '+H(cl.name)+(mt?' / '+H(mt.name):'')+'</div>'
    +'<div style="font-size:12px;color:var(--ink2);margin-top:3px">'+H(orig.description||'No description')+'</div>'
    +'<div style="font-size:12px;color:var(--ink3);margin-top:3px">'+$h(orig.hours)+' @ '+$m(orig.rate)+'/hr &nbsp;·&nbsp; <strong style="color:var(--green)">'+$m(Number(orig.hours)*Number(orig.rate))+'</strong>'
    +(e.createdBy?' &nbsp;·&nbsp; by '+H(e.createdBy):'')+'</div>'
    +'</div>'

    // Editable fields — partner adjustments
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:10px">Partner Adjustments <span style="font-weight:400;text-transform:none;font-size:12px;color:var(--ink2)">(leave unchanged to keep originals)</span></div>'
    +'<div class="frow c2">'
    +field('Hours','pref-h',{type:'number',val:f.hours,ph:orig.hours,step:'0.1',min:'0.1',hint:hoursChanged?'<span style="color:var(--amber)">Changed from '+orig.hours+'</span>':''})
    +field('Rate ($/hr)','pref-r',{pfx:'$',val:f.rate,ph:orig.rate,hint:(rateChanged?'<span style="color:var(--amber)">Changed from '+$m(orig.rate)+'</span>':(total?'Total: '+total:''))})
    +'</div>'
    +field('Description','pref-desc',{type:'textarea',rows:2,val:f.description,ph:orig.description||'Describe the work performed...',hint:descChanged?'<span style="color:var(--amber)">Modified from original</span>':''})
    +(anyEdited?'<div class="note" style="margin-bottom:12px">'+IC.edit+' You have pending edits. These will be saved to the entry when you approve or save.</div>':'')

    // Comment section
    +'<div style="border-top:1px solid var(--brd);margin-top:4px;padding-top:14px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:10px">'+IC.comment+' Partner Comment</div>'
    +field('Comment','pref-cmt',{type:'textarea',rows:2,val:f.comment||'',ph:'Add a note for the attorney or billing reference...'})
    +'<label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-top:6px;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:'+(f.showOnInvoice?'var(--blue-pale)':'var(--bg)')+';">'
    +'<input type="checkbox" id="pref-inv" style="width:15px;height:15px;cursor:pointer;"'+(f.showOnInvoice?' checked':'')+'>'
    +'<span><strong>Show comment on invoice</strong> <span style="color:var(--ink3);font-size:12px">— visible to client</span></span>'
    +'</label>'
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-rd" onclick="A.partnerReviewReject()">Reject Entry</button>'
    +'<button class="btn btn-dk" onclick="A.partnerReviewSave(false)" style="gap:4px">'+IC.save+' Save Draft</button>'
    +'<button class="btn btn-gr" onclick="A.partnerReviewSave(true)" style="gap:4px">'+IC.check+' Save &amp; Approve</button>'
    +'</div></div></div>';
}

function buildUP(){
  var pct=ST.user&&ST.user.ownPct!=null?String(ST.user.ownPct):'100';
  var rate=ST.user&&ST.user.rate!=null?String(ST.user.rate):'';
  var curRole=ST.user&&ST.user.role||'attorney';
  var isFirstRun=!ST.user||ST._splashMode;
  var STEPS=['Firm Setup','Your Profile'];

  // Role cards for splash
  var roles=[
    {v:'attorney',  label:'Attorney',      desc:'Track and submit time entries for review'},
    {v:'partner',   label:'Partner',        desc:'Full access \u2014 add entries, approve timesheets, manage everything'},
    {v:'billing_staff', label:'Billing Staff', desc:'View-only access: review entries and export reports'}
  ];
  var roleCardsH=roles.map(function(r){
    var sel=curRole===r.v?' sel':'';
    return '<div class="splash-role'+sel+'" onclick="A.upSelRole(\''+r.v+'\')">'
      +'<div class="splash-role-radio"></div>'
      +'<div class="splash-role-body"><strong>'+r.label+'</strong><span>'+r.desc+'</span></div>'
      +'</div>';
  }).join('');

  if(isFirstRun){
    var splitFields='';
    if(ST.prefs.revenueSplit){
      splitFields='<div class="frow c2" style="margin-bottom:16px">'
        +'<div class="fl"><label for="up-pct">Personal Cut % <span style="font-size:11px;color:var(--ink3);font-weight:300">of billed revenue</span></label>'
        +'<div class="pw"><input type="number" id="up-pct" min="0" max="100" step="1" placeholder="100" value="'+H(pct)+'"/><span class="sfx">%</span></div>'
        +'<div class="hint">100 = you keep all; 0 = all to firm</div></div>'
        +'<div class="fl"><label for="up-sal">Annual Salary <span style="font-size:11px;color:var(--ink3);font-weight:300">(optional)</span></label>'
        +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-sal" placeholder="120,000" value="'+H(ST.user&&ST.user.salary!=null&&ST.user.salary!==''?String(ST.user.salary):'')+'" /></div>'
        +'<div class="hint">Shown in analytics as net vs. billed</div></div>'
        +'</div>';
    }
    return '<div class="splash-ov">'
      +splashHero(STEPS,1)
      +'<div class="splash-form">'
      +'<div class="splash-form-inner">'
      +'<h2>Set up <strong>your profile</strong></h2>'
      +'<p class="sub">This is stored only on your device. It identifies who created each time entry and controls what you can do in the app.</p>'
      +'<div class="frow c2" style="margin-bottom:16px">'
      +'<div class="fl"><label for="up-n">Full name <span class="req">*</span></label><input type="text" id="up-n" placeholder="e.g. Sarah Johnson" value="'+H(ST.user?ST.user.name:'')+'" autofocus/></div>'
      +'<div class="fl"><label for="up-i">Initials</label><input type="text" id="up-i" placeholder="SJ" maxlength="4" value="'+H(ST.user?ST.user.initials:'')+'"/><div class="hint">Auto-generated if blank</div></div>'
      +'</div>'
      +'<div class="frow c2" style="margin-bottom:16px">'
      +'<div class="fl"><label for="up-e">Email</label><input type="email" id="up-e" placeholder="sarah@firm.com" value="'+H(ST.user&&ST.user.email||'')+'"/></div>'
      +'<div class="fl"><label for="up-p">Phone</label><input type="tel" id="up-p" placeholder="(555) 123-4567" value="'+H(ST.user&&ST.user.phone||'')+'" oninput="A.livePhone(\'up-p\')"/></div>'
      +'</div>'
      +'<div class="fl" style="margin-bottom:16px"><label for="up-rate">Default Rate ($/hr)</label>'
      +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-rate" placeholder="150.00" value="'+H(rate)+'"/></div>'
      +'<div class="hint">Your billing rate. Leave blank to use client/matter rates.</div></div>'
      +splitFields
      +'<div style="margin-bottom:8px;font-size:13px;font-weight:600;color:var(--ink)">Your role</div>'
      +'<div class="splash-roles">'+roleCardsH+'</div>'
      +'<input type="hidden" id="up-role" value="'+H(curRole)+'">'
      +'</div>'
      +'<div class="splash-footer">'
      +'<span class="splash-footer-note">\ud83d\udd12 Stored only on this device</span>'
      +'<button class="btn btn-dk" onclick="A.saveUser()" style="padding:10px 28px">Continue \u2192</button>'
      +'</div>'
      +'</div></div>';
  }

  // Non-first-run: compact modal (chgUser)
  var roleOpts=roles.map(function(o){return '<option value="'+o.v+'"'+(curRole===o.v?' selected':'')+'>'+H(o.label+' \u2014 '+o.desc)+'</option>';}).join('');
  return '<div class="up-wrap">'
    +'<div class="up-box">'
    +'<div class="up-icon">'+IC.usr+'</div>'
    +'<h2>Edit Profile</h2>'
    +'<p>Changes apply to new entries from this point forward.</p>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-n">Your name <span class="req">*</span></label><input type="text" id="up-n" placeholder="e.g. Sarah Johnson" value="'+H(ST.user?ST.user.name:'')+'"/></div>'
    +'<div class="fl"><label for="up-i">Initials</label><input type="text" id="up-i" placeholder="SJ" maxlength="4" value="'+H(ST.user?ST.user.initials:'')+'"/><div class="hint">Auto-generated from name if left blank</div></div>'
    +'</div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-e">Email</label><input type="email" id="up-e" placeholder="you@firm.com" value="'+H(ST.user&&ST.user.email||'')+'"/></div>'
    +'<div class="fl"><label for="up-p">Phone</label><input type="tel" id="up-p" placeholder="(555) 123-4567" value="'+H(ST.user&&ST.user.phone||'')+'" oninput="A.livePhone(\'up-p\')"/></div>'
    +'</div>'
    +'<div class="fl" style="margin-bottom:14px"><label for="up-role">Role</label><select id="up-role">'+roleOpts+'</select></div>'
    +'<div class="fl" style="margin-bottom:14px"><label for="up-rate">Default Rate ($/hr)</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-rate" placeholder="150.00" value="'+H(rate)+'"/></div></div>'
    +(ST.prefs.revenueSplit?'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label for="up-pct">Personal Cut %</label>'
    +'<div class="pw"><input type="number" id="up-pct" min="0" max="100" step="1" value="'+H(pct)+'"/><span class="sfx">%</span></div></div>'
    +'<div class="fl"><label for="up-sal">Annual Salary</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="up-sal" value="'+H(ST.user&&ST.user.salary!=null&&ST.user.salary!==''?String(ST.user.salary):'')+'" /></div></div>'
    +'</div>':'')
    +'<div style="display:flex;gap:10px;margin-top:4px">'
    +'<button class="btn btn-gh" style="flex:1;justify-content:center" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-dk" style="flex:1;justify-content:center" onclick="A.saveUser()">Save Profile</button>'
    +'</div>'
    +'</div></div>';
}


function buildQL(){
  var f=ST.ql;
  var ms=ST.tmrOn?(Date.now()-ST.tmrStart+ST.tmrMs):ST.tmrMs;
  var hh=String(Math.floor(ms/3600000)).padStart(2,'0');
  var mm=String(Math.floor((ms%3600000)/60000)).padStart(2,'0');
  var ss=String(Math.floor((ms%60000)/1000)).padStart(2,'0');
  // Actual hours from timer (no rounding, no forced minimum)
  var rnd=ms/3600000;
  var clOpts=[{v:'',l:'Select client...'}].concat(ST.clients.map(function(c){return{v:c.id,l:c.name};}));
  var avMat=ST.matters.filter(function(m){return m.clientId==f.clientId;});
  var maOpts=[{v:'',l:'General'}].concat(avMat.map(function(m){return{v:m.id,l:m.name};}));
  var total=(f.hours&&f.rate)?$m(Number(f.hours)*Number(f.rate)):null;
  // Today's existing entries for "continue" feature
  var todayStr=today();
  var todayEntries=ST.entries.filter(function(e){return e.date===todayStr&&!e.finalized;}).sort(function(a,b){return b.id-a.id;});
  var continueH='';
  if(todayEntries.length>0){
    var addToId=f.addToId||'';
    var entOpts='<option value="">&#43; New entry</option>'
      +todayEntries.map(function(e){
        var cl=_lu.cl[e.clientId];
        var mt=_lu.ma[e.matterId];
        var label=(cl?cl.name:'?')+(mt?' \u2022 '+mt.name:'')+' ('+$h(e.hours)+')'+(e.description?' \u2013 '+e.description.substring(0,28)+(e.description.length>28?'\u2026':''):'');
        return '<option value="'+e.id+'"'+(String(e.id)===String(addToId)?' selected':'')+'>'+H(label)+'</option>';
      }).join('');
    continueH='<div style="background:var(--bg2,#f8f8f8);border-bottom:1px solid var(--border);padding:12px 20px">'
      +'<label style="font-size:12px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:6px">Continue existing entry today</label>'
      +'<select style="width:100%;font-size:13px" onchange="A.qlPickEntry(this.value)">'+entOpts+'</select>'
      +(addToId?'<div style="margin-top:6px;font-size:12px;color:var(--green,#2a9d5c)">&#10010; Hours you log will be added to this entry</div>':'')
      +'</div>';
  }
  var headingLabel=f.addToId?IC.flash+' Add Hours to Entry':IC.flash+' Quick Log';
  return '<div class="ov"><div class="modal modal-sm">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+headingLabel+'</h2>'
    +'<button class="btn-ic" onclick="A.closeQL()">'+IC.x+'</button></div>'
    +continueH
    +'<div class="ql-timer">'
    +'<div class="timer-num '+(ST.tmrOn?'timer-on':'timer-off')+'" id="ql-t">'+hh+':'+mm+':'+ss+'</div>'
    +'<div style="display:flex;gap:8px;align-items:center">'
    +'<button class="btn '+(ST.tmrOn?'btn-rd':'btn-dk')+'" onclick="A.togTmr()" style="padding:8px 14px;font-size:13px">'+(ST.tmrOn?'Stop':(ST.tmrMs>0?'Resume':'Start'))+'</button>'
    +(ST.tmrMs>0?'<button class="btn btn-gh" onclick="A.rstTmr()" style="padding:8px 12px;font-size:13px">Reset</button>':'')
    +'</div>'
    +(ST.tmrMs>0&&!ST.tmrOn?'<span style="font-size:12px;color:var(--ink3)" title="Exact measured time">'+msToHMS(ST.tmrMs)+' ('+rnd.toFixed(4)+'h exact)</span>':'')
    +'</div>'
    +'<div class="modal-bd" style="padding:18px 20px">'
    +(!f.addToId
      // New entry mode: show client/matter dropdowns
      ?('<div class="frow c2" style="margin-bottom:12px">'
        +'<div class="fl"><label>Client <span class="req">*</span></label>'
        +'<select id="ql-cl" onchange="A.qlCl(this.value)">'
        +clOpts.map(function(o){return '<option value="'+H(o.v)+'"'+(String(o.v)===String(f.clientId)?'selected':'')+'>'+H(o.l)+'</option>';}).join('')
        +'</select></div>'
        +'<div class="fl"><label>Matter</label>'
        +'<select id="ql-ma" onchange="A.qlSet(\'matterId\',this.value)"'+(f.clientId?'':' disabled')+'>'
        +maOpts.map(function(o){return '<option value="'+H(o.v)+'"'+(String(o.v)===String(f.matterId)?'selected':'')+'>'+H(o.l)+'</option>';}).join('')
        +'</select></div></div>')
      // Continue mode: show client/matter as read-only chips
      :(function(){
          var cl=ST.clients.find(function(c){return String(c.id)===String(f.clientId);});
          var mt=ST.matters.find(function(m){return String(m.id)===String(f.matterId);});
          return '<div class="frow c2" style="margin-bottom:12px">'
            +'<div class="fl"><label>Client</label><div style="padding:7px 10px;background:var(--bg2,#f8f8f8);border:1px solid var(--border);border-radius:6px;font-size:13px;color:var(--ink)">'+H(cl?cl.name:'\u2014')+'</div></div>'
            +'<div class="fl"><label>Matter</label><div style="padding:7px 10px;background:var(--bg2,#f8f8f8);border:1px solid var(--border);border-radius:6px;font-size:13px;color:var(--ink2)">'+H(mt?mt.name:'General')+'</div></div>'
            +'</div>';
        })()
    )
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>'+(f.addToId?'Hours to Add':'Hours')+' <span class="req">*</span></label><input type="number" id="ql-h" step="0.01" min="0.01" value="'+H(f.hours||'')+'" placeholder="1.0" oninput="A.qlSet(\'hours\',this.value)"'+(f.rawMs!=null?' title="Timer-measured: '+msToHMS(f.rawMs)+' exact — adjust for billing if needed"':'')+'></div>'
    +'<div class="fl"><label>Rate ($/hr) <span class="req">*</span></label><div class="pw"><span class="pfx">$</span><input type="text" id="ql-r" value="'+H(f.rate||'')+'" placeholder="150.00" oninput="A.qlSet(\'rate\',fmtCur(this.value))"></div></div></div>'
    +'<div class="fl" style="margin-bottom:14px"><label>Description</label>'
    +'<input type="text" id="ql-d" value="'+H(f.description||'')+'" placeholder="What did you work on?" oninput="A.qlSet(\'description\',this.value)" onkeydown="if(event.key===\'Enter\')A.saveQL()"></div>'
    +(total?'<div class="total-pill">Total: <strong>'+total+'</strong></div>':'')
    +(ST.descPresets.length>0?'<div class="desc-chips"><span style="font-size:11px;color:var(--ink3);margin-right:4px">Suggestions:</span>'+ST.descPresets.map(function(p,i){return '<button type="button" class="desc-chip" onclick="A.pickDesc(\'ql-d\','+i+')">'+ H(p)+'</button>';}).join('')+'</div>':'')
    +'<div class="fa" style="margin-top:0">'
    +'<button class="btn btn-gh" onclick="A.closeQL()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveQL()"'+((!f.clientId||!f.hours||!f.rate)?' disabled':'')+'>'
    +IC.save+' '+(f.addToId?'Add Hours':'Save Entry')
    +'</button>'
    +'</div></div></div></div>';
}

function buildHelp(){
  var tabs=[['start','Getting Started'],['time','Time Entries'],['clients','Clients & Matters'],['export','Export & Backup'],['offline','Using Offline'],['faq','FAQ']];
  var content={
    start:'<h3>Welcome to SixMinuteLog.com!</h3><p>A private billing and time-tracking app. All data stays on your device - no accounts, no cloud, no fees.</p>'
      +'<h4>Recommended Setup Order</h4><ol><li>Go to <strong>Contacts</strong> \u2248 add yourself and team members (with hourly rates'+(ST.prefs.revenueSplit?' and personal cut %':'')+')</li>'
      +'<li>Go to <strong>Clients</strong> \u2248 add your clients with default billing rates</li>'
      +'<li>Go to <strong>Matters</strong> \u2248 create matters/projects per client</li>'
      +'<li>Go to <strong>Timesheet</strong> \u2248 start logging your time!</li></ol>'
      +'<h4>Rate Priority System</h4><p>Rates fill automatically: <strong>Matter Rate \u2248 Contact Rate \u2248 Client Rate</strong>. Always overrideable.</p>'
      +(ST.prefs.revenueSplit?'<h4>Own vs. Firm Split</h4><p>Each contact and your user profile has a "Personal Cut %" field. The Analytics tab shows a split table breaking down who keeps what.</p>':'')
      +'<h4>Quick Log &#9889;</h4><p>The &#9889; button opens a popup with a stopwatch. When stopped, the exact measured time is shown and stored — no forced minimum or rounding. Adjust the hours field before saving if needed for billing.</p>',
    time:'<h3>Logging Time</h3><h4>Full Entry</h4><p>Click "New Entry". Hours accept any decimal value (e.g. 1.5, 0.25). Required: Date, Client, Hours, Rate.</p>'
      +'<h4>Form Field Preservation</h4><p>Changing a dropdown (client, matter, team member) will not clear your other typed fields - hours, rate, description are all preserved.</p>'
      +'<h4>Quick Log &#9889;</h4><p>Tap &#9889;, start the stopwatch, stop when done. The exact measured time is stored on the entry — hover the hours value in the timesheet to see it. You can adjust the billed hours before saving.</p>'
      +'<h4>Precision</h4><p>Hours display to 1 decimal place in all billing views. The underlying stored value is full precision (up to 4 decimal places). Timer-measured entries also store the exact raw milliseconds for audit purposes.</p>'
      +'<h4>Filters</h4><p>Use the dropdown to filter by Today, This Week, This Month, This Year, or All Time.</p>',
    clients:'<h3>Clients & Matters</h3><h4>Clients</h4><p>Each client has a name, contact info, and a default billing rate.</p>'
      +'<h4>Matters</h4><p>Matters are projects/cases linked to a client with an optional override rate.</p>'
      +'<h4>Linking in Time Entries</h4><ol><li>Select the <strong>Client</strong> first</li><li>Matter dropdown shows only that client\'s matters</li><li>Rate auto-fills without clearing other fields</li></ol>',
    export:'<h3>Export & Backup</h3><h4>Smart Filename</h4><p>The export filename reflects what you\'ve selected to export and includes the exact time. Example: <code>billing-entries+summary_2025-01-15_1430.csv</code></p>'
      +'<h4>Granular Controls</h4><p>In ⚙️ Settings you can choose which sections to include, which columns to include for time entries, and optionally filter by date range.</p>'
      +(ST.prefs.revenueSplit?'<h4>Revenue Split Export</h4><p>Enable "Revenue Split" in export settings to include a per-person own/firm breakdown in the CSV.</p>':'')
      +'<div class="note">⚠️ Clearing browser data will erase your data. Export regularly!</div>',
    offline:'<h3>Using Offline</h3><h4>This File IS the App</h4><p>The <code>billing-tracker.html</code> file contains everything - zero external dependencies. It works 100% offline.</p>'
      +'<h4>How to Run</h4><ol><li>Save the HTML file anywhere</li><li>Double-click to open in browser</li><li>Bookmark it for easy access</li><li>Always use the same browser</li></ol>'
      +'<div class="good">✅No internet required. No CDN, no cloud, nothing external.</div>',
    faq:'<h3>FAQ</h3>'+[
      ['Where is my data stored?','In your browser\'s IndexedDB — a local database built into every modern browser. Nothing is ever uploaded or sent anywhere. Preferences are also cached in localStorage for instant startup.'],
      ['Why doesn\'t changing a dropdown clear my typed fields?','Fixed! The app now saves all field values before re-rendering on any dropdown change.'],
      ...(ST.prefs.revenueSplit?[['How does the revenue split work?','Set a "Personal Cut %" on each contact (e.g. 65 means they keep 65%, firm gets 35%). Analytics shows the full breakdown.']]:[] ),
      ['Hours precision — what is stored vs. displayed?','Hours are stored at full precision (up to 4 decimal places). Timer entries also store exact raw milliseconds. In billing views, 1 decimal place is shown (e.g. 1.3h). Hover a timer-derived hours value in the timesheet to see the exact stored time.'],
      ['How do I customize the export filename?','The filename auto-generates based on what sections you\'ve selected to export, plus the date and time.'],
      ['What browsers work?','Chrome is most reliable. Firefox, Edge, and Safari all work too.'],
      ['Can I use this offline?','Yes - the file has zero external dependencies. Download and double-click.'],
    ].map(function(q){return '<div class="faq-item"><strong>'+H(q[0])+'</strong><p>'+H(q[1])+'</p></div>';}).join('')
  };
  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.help+' Help & Guide</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="help-lay"><div class="help-nav">'+tabs.map(function(t){return '<button class="'+(ST.helpTab===t[0]?'on':'')+'" onclick="A.setHT(\''+t[0]+'\')">'+H(t[1])+'</button>';}).join('')+'</div>'
    +'<div class="help-body">'+(content[ST.helpTab]||'')+'</div></div></div></div>';
}

function buildExportModal(){
  var s=ST.settings;
  var fname=exportFilename();
  var presets=[['Full','full'],['Billing','billing'],['Dirs','dirs'],['Summary','sum'],['W/Split','wsplit'],['T+Split','tsplit']];
  var sections=[
    ['te','Time Entries','Individual billing records'],
    ['cl','Clients','Client info & rates'],
    ['ma','Matters','Matter details'],
    ['co','Contacts','Team directory'],
    ['su','Summary','Totals & counts'],
    ['split','Revenue Split','Own vs. firm per person']
  ];
  var colRows=[
    ['tc_date','Date'],['tc_client','Client'],['tc_matter','Matter'],['tc_team','Team Member'],
    ['tc_desc','Description'],['tc_hours','Hours'],['tc_rate','Rate'],['tc_amount','Amount'],['tc_by','Created By']
  ];
  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.dl+' Backup &amp; Export</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
  +'<div class="modal-bd">'
  +'<div class="note" style="margin-bottom:14px">This exports <strong>your own data</strong> — backups and CSV files for records or migration. To send entries to a colleague, use the <strong>📤 Submit Timesheet</strong> button on the Timesheet tab.</div>'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:10px">Quick Export</h3>'
  +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">'
  +'<button class="btn btn-dk" style="flex-direction:column;padding:12px 8px;gap:3px;height:auto" onclick="A.exportJSON();A.closeM()">'+IC.save+'<span style="font-size:12px;font-weight:500">Full Backup</span><span style="font-size:10px;opacity:.8">.json &mdash; everything</span></button>'
  +'<button class="btn btn-gr" style="flex-direction:column;padding:12px 8px;gap:3px;height:auto" onclick="A.exportCSV();A.closeM()">'+IC.dl+'<span style="font-size:12px;font-weight:500">Export CSV</span><span style="font-size:10px;opacity:.8">using settings below</span></button>'
  +'<button class="btn btn-gh" style="flex-direction:column;padding:12px 8px;gap:3px;height:auto" onclick="A.openMailSend()">'+IC.mail+'<span style="font-size:12px;font-weight:500">Email CSV</span><span style="font-size:10px;opacity:.8">via mail preset</span></button>'
  +'</div></div>'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:8px">CSV Presets</h3>'
  +'<div class="preset-grid">'
  +presets.map(function(p){return '<button class="preset-btn" onclick="A.applyPreset(\''+p[1]+'\')">'+'<strong>'+H(p[0])+'</strong></button>';}).join('')
  +'</div></div>'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:8px">Sections to Include</h3>'
  +sections.map(function(r){return '<label class="crow" style="margin-bottom:6px"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"><div><strong>'+H(r[1])+'</strong><span>'+H(r[2])+'</span></div></label>';}).join('')
  +(s.te?'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin:10px 0 6px">Time entry columns</div>'
    +'<div class="sub-checks">'
    +colRows.map(function(r){return '<label class="sub-check"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"> '+H(r[1])+'</label>';}).join('')
    +'</div>':'')
  +'</div>'
  +'<div class="set-section">'
  +'<h3 style="margin-bottom:8px">Date Range <span style="font-size:11px;color:var(--ink3);font-weight:400">(time entries only)</span></h3>'
  +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">'
  +'<div class="fl"><label>From</label><input type="date" id="exp-from" value="'+H(s.expFrom||'')+'" onchange="(function(el){ST.settings.expFrom=el.value;save();})(this)"></div>'
  +'<div class="fl"><label>To</label><input type="date" id="exp-to" value="'+H(s.expTo||'')+'" onchange="(function(el){ST.settings.expTo=el.value;save();})(this)"></div>'
  +'</div></div>'
  +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
  +'<h3 style="margin-bottom:8px">Export by Data Type</h3>'
  +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px">Export one data type as its own CSV file.</p>'
  +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
  +[['clients','Clients'],['matters','Matters'],['entries','Time Entries'],['contacts','Contacts'],['settings','Settings']].map(function(t){
    return '<button class="btn btn-gh" style="justify-content:flex-start" onclick="A.exportEntityCSV(\''+t[0]+'\')">'+IC.dl+' '+H(t[1])+'</button>';
  }).join('')
  +'</div></div>'
  +'</div>'
  +'<div class="modal-ft" style="justify-content:space-between;align-items:center">'
  +'<div class="exp-name-preview" style="margin:0;flex:1;margin-right:12px">'+H(fname)+'</div>'
  +'<div style="display:flex;gap:8px">'
  +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
  +'<button class="btn btn-dk" onclick="A.exportJSON();A.closeM()">'+IC.save+' Backup</button>'
  +'<button class="btn btn-gr" onclick="A.exportCSV();A.closeM()">'+IC.dl+' Export CSV</button>'
  +'</div></div>'
  +'</div></div>';
}


function buildImportModal(){
  return '<div class="ov"><div class="modal modal-md"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.ul+' Restore / Import Data</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
  +'<div class="modal-bd">'

  +'<div class="note" style="margin-bottom:16px">These options import <strong>your own data</strong> — backups, CSV exports, and firm profiles. To receive a submission from a colleague, use the <strong>📥 Receive Submission</strong> button on the Timesheet or Approvals tab.</div>'

  // Firm Profile
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">🏢 Firm Profile</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Import a firm profile distributed by your IT administrator. Applies branding, pre-configured clients, contacts, description presets, and user profiles.</p>'
  +'<input type="file" id="imp-profile" accept=".json" style="display:none" onchange="A.importFirmProfile(this)">'
  +'<button class="btn btn-dk" onclick="document.getElementById(\'imp-profile\').click()">'+IC.ul+' Import Firm Profile (.json)</button>'
  +'</div>'

  // Full JSON backup restore
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">'+IC.save+' Full Backup Restore</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Restore a complete JSON backup of your own data. <strong style="color:var(--red)">Replaces all current data.</strong></p>'
  +'<input type="file" id="imp-json" accept=".json" style="display:none" onchange="A.importJSON(this)">'
  +'<button class="btn btn-dk" onclick="document.getElementById(\'imp-json\').click()">'+IC.ul+' Choose Backup File (.json)</button>'
  +'</div>'

  // Combined CSV
  +'<div class="set-section">'
  +'<h3 style="display:flex;align-items:center;gap:7px">'+IC.doc+' Combined CSV Import</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Import a combined export CSV (containing TIME ENTRIES, CLIENTS, MATTERS, CONTACTS sections). <strong style="color:var(--amber)">Replaces matched data types.</strong></p>'
  +'<input type="file" id="imp-csv-all" accept=".csv" style="display:none" onchange="A.importCSV(this)">'
  +'<button class="btn btn-gh" onclick="document.getElementById(\'imp-csv-all\').click()">'+IC.ul+' Choose Combined CSV</button>'
  +'</div>'

  // Individual CSV imports
  +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
  +'<h3 style="display:flex;align-items:center;gap:7px">'+IC.chart+' Import Individual CSV</h3>'
  +'<p style="font-size:12px;color:var(--ink2);margin-bottom:14px;line-height:1.6">Import a single-entity CSV. Each import <strong style="color:var(--amber)">replaces that entity type only</strong>. Import clients before matters, matters before entries.</p>'
  +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
  +(function(){
    var ents=[
      {t:'clients',  l:'Clients (.csv)'},
      {t:'matters',  l:'Matters (.csv)'},
      {t:'entries',  l:'Time Entries (.csv)'},
      {t:'contacts', l:'Contacts (.csv)'},
      {t:'settings', l:'Settings (.csv)'}
    ];
    return ents.map(function(e){
      return '<input type="file" id="imp-ent-'+e.t+'" accept=".csv" data-etype="'+e.t+'" style="display:none" onchange="A.importEntityCSV(this,this.dataset.etype)">'
        +'<button class="btn btn-gh" style="justify-content:flex-start" onclick="document.getElementById(\'imp-ent-'+e.t+'\').click()">'+IC.ul+' '+H(e.l)+'</button>';
    }).join('');
  })()
  +'</div>'
  +'</div>'

  +'</div>'
  +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Close</button></div>'
  +'</div></div>';
}

function buildSettings(){
  var s=ST.settings;
  var stab=ST.settingsTab||'export';
  var fname=exportFilename();
  var presets=ST.prefs.revenueSplit?[['Full Export','full'],['Billing Only','billing'],['Clients & Contacts','dirs'],['Summary Only','sum'],['With Split','wsplit'],['Time + Split','tsplit']]:[['Full Export','full'],['Billing Only','billing'],['Clients & Contacts','dirs'],['Summary Only','sum']];
  var teColRows=[
    ['tc_date','Date'],['tc_client','Client'],['tc_matter','Matter'],['tc_team','Team Member'],
    ['tc_desc','Description'],['tc_hours','Hours'],['tc_rate','Rate'],['tc_amount','Amount'],['tc_by','Created By']
  ];
  var settingsTabs=[['export','Export'],['appearance','Appearance'],['descriptions','Descriptions'],['email','Email'],['advanced','Advanced'],['itadmin','IT Admin']];
  var tabNav='<div class="set-tabs">'+settingsTabs.map(function(t){return '<button class="set-tab'+(stab===t[0]?' on':'')+'" onclick="A.setStab(\''+t[0]+'\')">'+H(t[1])+'</button>';}).join('')+'</div>';
  var body='';

  if(stab==='export'){
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<div class="preset-grid">'
      +presets.map(function(p){return '<button class="preset-btn" onclick="A.applyPreset(\''+p[1]+'\')"><strong>'+H(p[0])+'</strong></button>';}).join('')
      +'</div>'
      +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">Sections to include</div>'
      +(ST.prefs.revenueSplit?[['te','Time Entries','Individual billing records'],['cl','Clients','Client info & rates'],['ma','Matters','Matter details'],['co','Contacts','Team directory'],['su','Summary','Totals & counts'],['split','Revenue Split','Own vs. firm per person']]:[['te','Time Entries','Individual billing records'],['cl','Clients','Client info & rates'],['ma','Matters','Matter details'],['co','Contacts','Team directory'],['su','Summary','Totals & counts']])
        .map(function(r){return '<label class="crow"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"><div><strong>'+H(r[1])+'</strong><span>'+H(r[2])+'</span></div></label>';}).join('')
      +(s.te?'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin:12px 0 8px">Time entry columns</div>'
      +'<div class="sub-checks">'
      +teColRows.map(function(r){return '<label class="sub-check"><input type="checkbox" '+(s[r[0]]?'checked':'')+' onchange="A.togExp(\''+r[0]+'\',this.checked)"> '+H(r[1])+'</label>';}).join('')
      +'</div>':'')
      +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin:12px 0 8px">Date range (for time entries)</div>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">'
      +'<div class="fl"><label>From</label><input type="date" id="exp-from" value="'+H(s.expFrom||'')+'" onchange="A.setExpDate(\'expFrom\',this.value)"></div>'
      +'<div class="fl"><label>To</label><input type="date" id="exp-to" value="'+H(s.expTo||'')+'" onchange="A.setExpDate(\'expTo\',this.value)"></div>'
      +'</div>'
      +'<div style="margin-top:12px"><div style="font-size:11px;color:var(--ink3);margin-bottom:5px">Export filename preview</div>'
      +'<div class="exp-name-preview">'+H(fname)+'</div>'
      +'<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">'
      +'<button class="btn btn-gr" onclick="ST.modal=\'exportModal\';render()">'+IC.dl+' Backup &amp; Export</button>'
      +(ST.mailPresets.length>0?'<button class="btn btn-bl" onclick="A.openMailSend()">'+IC.mail+' Send via Email</button>':'')
      +'</div></div></div>'
      // JSON Backup section
      +'<div class="set-section" style="margin-top:16px">'
      +'<h3 style="margin-bottom:8px">Full Backup</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px;line-height:1.5">Export everything (clients, matters, entries, contacts, settings, preferences) as a single JSON file. Perfect for complete backups before browser changes.</p>'
      +'<button class="btn btn-dk" onclick="A.exportJSON()">'+IC.dl+' Download Full Backup (.json)</button>'
      +'</div>'
      // Individual CSV exports section
      +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3 style="margin-bottom:8px">Export Individual CSV</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:10px;line-height:1.5">Export a single data type as CSV. Use these for selective imports or sharing specific data.</p>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
      +[['clients','Clients'],['matters','Matters'],['entries','Time Entries'],['contacts','Contacts'],['settings','Settings']].map(function(t){
        return '<button class="btn btn-gh" style="justify-content:flex-start" onclick="A.exportEntityCSV(\''+t[0]+'\')">'+IC.dl+' '+t[1]+'</button>';
      }).join('')
      +'</div>'
      +'</div>'
  }

  if(stab==='appearance'){
    var p=ST.prefs;
    var layouts=[['comfortable','Comfortable','Default balanced spacing'],['compact','Compact','Dense UI for more data'],['spacious','Spacious','Relaxed layout, larger text']];
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>App Name</h3>'
      +'<div style="display:flex;gap:10px;align-items:center;margin-bottom:18px">'
      +'<input type="text" id="pref-name" value="'+H(p.appName||'SixMinuteLog.com')+'" placeholder="SixMinuteLog.com" style="flex:1;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)">'
      +'<button class="btn btn-dk" onclick="A.saveAppName()">Save</button>'
      +'</div>'
      +'<h3>Dark Mode</h3>'
      +'<div class="preset-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:18px">'
      +[['null','Auto','Follows your browser or OS setting'],['false','Light','Always use light theme'],['true','Dark','Always use dark theme']].map(function(opt){
        var active=String(p.darkMode)===opt[0];
        return '<button class="preset-btn'+(active?' on':'')+'" style="'+(active?'border-color:var(--ink);background:var(--bg)':'')+'" onclick="A.setDarkMode('+opt[0]+')"><strong>'+opt[1]+'</strong><span style="font-size:11px;color:var(--ink3);display:block;margin-top:2px">'+opt[2]+'</span></button>';
      }).join('')
      +'</div>'
      +'<h3>Layout Density</h3>'
      +'<div class="preset-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:0">'
      +layouts.map(function(l){return '<button class="preset-btn'+(p.layout===l[0]?' on':'')+'" style="'+(p.layout===l[0]?'border-color:var(--ink);background:var(--bg)':'')+'" onclick="A.setLayout(\''+l[0]+'\')"><strong>'+H(l[1])+'</strong><span style="font-size:11px;color:var(--ink3);display:block;margin-top:2px">'+H(l[2])+'</span></button>';}).join('')
      +'</div></div>';
  }

  if(stab==='descriptions'){
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>Default Description Suggestions</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.6">These appear as clickable chips below description fields in the time entry form and Quick Log, letting you quickly select common descriptions.</p>'
      +(ST.descPresets.length>0
        ? ST.descPresets.map(function(p,i){
          return '<div class="preset-item"><span>'+H(p)+'</span>'
            +'<button title="Move up" onclick="A.moveDesc('+i+',-1)">'
              +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg>'
            +'</button>'
            +'<button title="Move down" onclick="A.moveDesc('+i+',1)">'
              +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>'
            +'</button>'
            +'<button title="Edit" onclick="A.editDescPreset('+i+')" style="color:var(--blue)">'+IC.edit+'</button>'
            +'<button title="Delete" onclick="A.delDesc('+i+')">'+IC.trash+'</button>'
            +'</div>';
        }).join('')
        : '<div class="empty" style="padding:24px"><p>No descriptions yet</p></div>'
      )
      +'<div style="display:flex;gap:8px;margin-top:12px">'
      +'<input type="text" id="desc-new" placeholder="Add a description suggestion..." style="flex:1;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)" onkeydown="if(event.key===\'Enter\')A.addDesc()">'
      +'<button class="btn btn-dk" onclick="A.addDesc()">'+IC.plus+' Add</button>'
      +'</div></div>';
  }

  if(stab==='email'){
    var PRIO_STYLE={high:'color:var(--red)',normal:'color:var(--ink3)',low:'color:var(--ink3)'};
    var PRIO_LABEL={high:'\u25b2 High',normal:'Normal',low:'\u25bc Low'};
    var TYPE_LABELS={invClient:'Invoice → Client',invApproval:'Partner Approval',invDecision:'Review Decision',tsApproval:'Submit for Approval',tsSummary:'Billing Summary',all:'All types'};
    // ── Mail / CSV Presets ─────────────────────────────────────────────────────
    body+='<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<h3>Email Presets</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.6">Reusable email compositions — define recipient, subject, body, and signature. Selecting a preset opens your default mail client with everything pre-filled.</p>'
      +(ST.mailPresets.length>0
        ? ST.mailPresets.map(function(mp,i){
          var pri=mp.priority||'normal';
          return '<div class="mail-preset-card">'
            +'<div class="mp-acts">'
            +'<button class="btn-ic" onclick="A.dupMailPreset('+i+')" title="Duplicate">'+IC.copy+'</button>'
            +'<button class="btn-ic" onclick="A.editMailPreset('+i+')" title="Edit">'+IC.edit+'</button>'
            +'<button class="btn-ic" onclick="A.delMailPreset('+i+')" title="Delete">'+IC.trash+'</button>'
            +'</div>'
            +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">'
            +'<h4 style="margin:0">'+H(mp.name||'Preset '+(i+1))+'</h4>'
            +'<span class="status-badge '+(({general:'s-neutral',invoice_client:'s-approved',billing_staff:'s-review',partner_approval:'s-pending'}[mp.purpose||'general']||'s-neutral')+'" style="font-size:10px;padding:2px 7px">'+purposeLabel(mp.purpose||'general')+'</span>')
            +(pri!=='normal'?'<span style="font-size:10px;font-weight:600;'+PRIO_STYLE[pri]+'">'+PRIO_LABEL[pri]+'</span>':'')
            +'</div>'
            +(mp.to?'<p>To: '+H(mp.to)+'</p>':'<p style="color:var(--ink3);font-size:11px">To: auto-filled from context</p>')
            +(mp.cc?'<p style="font-size:11px">CC: '+H(mp.cc)+'</p>':'')
            +(mp.bcc?'<p style="font-size:11px">BCC: '+H(mp.bcc)+'</p>':'')
            +(mp.replyTo?'<p style="font-size:11px">Reply-To: '+H(mp.replyTo)+'</p>':'')
            +(mp.subject?'<p>Subject: '+H(mp.subject)+'</p>':'')
            +(mp.body?'<p style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:400px;font-size:11px;color:var(--ink3)">'+H(mp.body)+'</p>':'')
            +(mp.signature?'<p style="font-size:10px;color:var(--ink3);font-style:italic">\u2014 Signature attached</p>':'')
            +'<button class="btn btn-bl" style="margin-top:10px;font-size:12px" onclick="A.sendMailPreset('+i+')">'+IC.mail+' Send via Email</button>'
            +'</div>';
        }).join('')
        : '<div class="empty" style="padding:20px"><p>No email presets yet</p></div>'
      )
      +'<button class="btn btn-dk" style="margin-top:12px" onclick="A.openMailPreset(null)">'+IC.plus+' New CSV Preset</button>'
      +'</div>'
    // ── Placeholder editor ─────────────────────────────────────────────────
    +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<div><h3 style="margin:0">Email Placeholders</h3>'
      +'<p style="font-size:12px;color:var(--ink3);margin:4px 0 0;line-height:1.5">Custom tokens like <code style="font-size:11px;background:var(--bg);padding:1px 5px;border-radius:4px">{my_token}</code> you can insert into subject and body fields. Built-in placeholders are filled automatically; custom ones use the value you set here.</p></div>'
      +'<button class="btn btn-dk" onclick="A.openMailPH(null)">'+IC.plus+' New Placeholder</button>'
      +'</div>'
      // Built-in placeholders table
      +'<div style="margin-bottom:14px">'
      +'<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:6px">Built-in (auto-filled)</div>'
      +'<div style="display:grid;grid-template-columns:auto 1fr auto;gap:0;border:1px solid var(--brd);border-radius:8px;overflow:hidden">'
      +BUILTIN_PH.map(function(p,i){
        var bg=i%2===0?'background:var(--bg)':'background:var(--white)';
        return '<div style="'+bg+';padding:5px 10px;font-family:monospace;font-size:11px;color:var(--blue);border-bottom:1px solid var(--brd)">'+H(p[0])+'</div>'
          +'<div style="'+bg+';padding:5px 10px;font-size:11px;color:var(--ink2);border-bottom:1px solid var(--brd)">'+H(p[1])+'<span style="color:var(--ink3);margin-left:6px;font-size:10px">'+H(p[3])+'</span></div>'
          +'<div style="'+bg+';padding:5px 10px;font-size:10px;color:var(--ink3);border-bottom:1px solid var(--brd);white-space:nowrap">e.g. '+H(p[2])+'</div>';
      }).join('')
      +'</div>'
      +'</div>'
      // Custom placeholders
      +(ST.mailPlaceholders.length>0
        ? '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:6px">Custom</div>'
          +'<div style="border:1px solid var(--brd);border-radius:8px;overflow:hidden">'
          +ST.mailPlaceholders.map(function(p,i){
            var bg=i%2===0?'background:var(--bg)':'background:var(--white)';
            var valueDisplay=p.source==='linked'&&p.linkedField
              ? '<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;background:rgba(59,130,246,.1);color:var(--blue);border-radius:4px;padding:1px 7px;font-weight:500">\uD83D\uDD17 '+H(_lfLabel(p.linkedField))+'</span>'
              : '<span style="font-size:11px;color:var(--ink3)">Value: '+H(p.value||'(empty)')+'</span>';
            return '<div style="'+bg+';display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--brd)">'
              +'<code style="font-size:12px;color:var(--blue);flex-shrink:0">{'+H(p.key)+'}</code>'
              +'<div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:500">'+H(p.label)+'</div>'
              +'<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:1px">'+valueDisplay+'</div></div>'
              +'<button class="btn-ic" onclick="A.openMailPH('+i+')" title="Edit">'+IC.edit+'</button>'
              +'<button class="btn-ic" onclick="A.delMailPH('+i+')" title="Delete" style="color:var(--red)">'+IC.trash+'</button>'
              +'</div>';
          }).join('')
          +'</div>'
        : '<div class="empty" style="padding:14px"><p>No custom placeholders yet</p><small>Add one to create reusable tokens like {my_firm_address} or {partner_name}</small></div>'
      )
      +'</div>';
  }

  if(stab==='advanced'){
    body+='<div class="set-section"><h3>Current User</h3>'
      +'<div style="display:flex;justify-content:space-between;align-items:center;background:var(--bg);border-radius:8px;padding:12px 16px;margin-bottom:10px">'
      +'<div><div style="font-weight:500;font-size:13px">'+H(ST.user?ST.user.name:'Not set')+'</div>'
      +'<div style="font-size:12px;color:var(--ink3)">'+(ST.user&&ST.user.initials?ST.user.initials+' \u00b7 ':'')+( ST.prefs.revenueSplit&&ST.user&&ST.user.ownPct!=null?ST.user.ownPct+'% personal cut\u00b7 ':'')+(ST.user?roleBadge(ST.user.role):'')+' '+'</div></div>'
      +'<button class="btn btn-gh" onclick="A.chgUser()" style="font-size:13px">Edit Profile</button>'
      +'</div></div>'
      +'<div class="set-section"><h3>Display Options</h3>'
      +'<label class="crow"><input type="checkbox" '+(s.te_group?'checked':'')+' onchange="A.togExp(\'te_group\',this.checked)"><div><strong>Group entries by client</strong><span>Adds a sub-header row between each client\'s entries in export</span></div></label>'
      +'</div>'
      +'<div class="set-section"><h3>Advanced Features</h3>'
      +'<label class="crow"><input type="checkbox" '+(ST.prefs.revenueSplit?'checked':'')+' onchange="A.togRevenueSplit(this.checked)"><div><strong>Revenue Split &amp; Personal Cut</strong><span>Track own vs. firm portions, per-person earnings, and split analytics. Adds Personal Cut % fields to contacts and your profile.</span></div></label>'
      +'</div>'
      +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
      +'<div class="danger"><h3>Danger Zone</h3><p>Permanently delete all data. Export a backup first!</p>'
      +'<button class="btn btn-rd" onclick="A.resetAll()">'+IC.rst+' Reset All Data</button></div>'
      +'</div>';
  }

  if(stab==='itadmin'){
    var fp=ST.firmProfile||{};
    var itUsers=fp.users||[];
    body+='<div class="set-section">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
      +'<h3 style="margin:0">IT Admin Mode</h3>'
      +'<label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">'
      +'<input type="checkbox" '+(ST.itMode?'checked':'')+' onchange="A.togITMode(this.checked)">'
      +'<span>'+(ST.itMode?'<strong style="color:var(--blue)">Enabled</strong>':'Disabled')+'</span></label>'
      +'</div>'
      +'<p style="font-size:12px;color:var(--ink3);line-height:1.6;margin-bottom:0">IT Admin mode lets you build a firm profile package (app name, firm name, pre-configured clients, contacts, users, description presets) that can be exported and imported by other users on first setup or via Settings.</p>'
      +'</div>'
      +(ST.itMode?
        '<div class="set-section">'
        +'<h3>Firm Identity</h3>'
        +'<div class="frow c2" style="margin-bottom:12px">'
        +'<div class="fl"><label>Firm Name</label><input type="text" id="it-firmname" value="'+H(fp.firmName||'')+'" placeholder="e.g. Smith &amp; Associates LLP" /></div>'
        +'<div class="fl"><label>App Name</label><input type="text" id="it-appname" value="'+H(fp.appName||ST.prefs.appName||'SixMinuteLog.com')+'" placeholder="SixMinuteLog.com" /></div>'
        +'</div>'
        +'<button class="btn btn-dk" onclick="A.saveITFirm()">'+IC.save+' Save Firm Identity</button>'
        +'</div>'
        +'<div class="set-section">'
        +'<h3>Pre-configured Users</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:12px;line-height:1.5">Users defined here will appear as selectable profiles when a new user imports the firm profile for the first time. Each gets their own name, initials, role, rate, and ownership %.</p>'
        +(itUsers.length>0
          ? itUsers.map(function(u,i){
              return '<div class="crow" style="margin-bottom:8px;background:var(--bg);border-radius:8px;padding:10px 14px">'
                +'<div style="flex:1"><strong style="font-size:13px">'+H(u.name)+'</strong>'
                +'<div style="font-size:11px;color:var(--ink3)">'+H(u.initials||'')+(u.role?' | '+H(u.role):'')+(u.rate?' | $'+H(u.rate)+'/hr':'')+(u.ownPct!=null?' | '+H(String(u.ownPct))+'% cut':'')+'</div></div>'
                +'<button class="btn-ic" onclick="A.editITUser('+i+')" title="Edit">'+IC.edit+'</button>'
                +'<button class="btn-ic" onclick="A.delITUser('+i+')" title="Delete">'+IC.trash+'</button>'
                +'</div>';
            }).join('')
          : '<div class="empty" style="padding:16px"><p>No users configured</p></div>'
        )
        +'<button class="btn btn-dk" style="margin-top:10px" onclick="A.openITUser(null)">'+IC.plus+' Add User</button>'
        +'</div>'
        +'<div class="set-section">'
        +'<h3>Pre-configured Data to Include in Profile</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:12px;line-height:1.5">Choose which current app data to bundle into the exported profile. New users who import the profile will receive this data as a starting point.</p>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-clients" '+(fp.includeClients?'checked':'')+' onchange="A.togITInclude(\'includeClients\',this.checked)"><div><strong>Clients</strong><span>'+ST.clients.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-matters" '+(fp.includeMatters?'checked':'')+' onchange="A.togITInclude(\'includeMatters\',this.checked)"><div><strong>Matters</strong><span>'+ST.matters.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-contacts" '+(fp.includeContacts?'checked':'')+' onchange="A.togITInclude(\'includeContacts\',this.checked)"><div><strong>Contacts</strong><span>'+ST.contacts.length+' in app</span></div></label>'
        +'<label class="crow" style="background:var(--bg);border-radius:8px;padding:10px 14px"><input type="checkbox" id="it-inc-presets" '+(fp.includePresets?'checked':'')+' onchange="A.togITInclude(\'includePresets\',this.checked)"><div><strong>Description Presets</strong><span>'+ST.descPresets.length+' in app</span></div></label>'
        +'</div>'
        +'</div>'
        +'<div class="set-section" style="border-bottom:none;margin-bottom:0;padding-bottom:0">'
        +'<h3>Export &amp; Share Profile</h3>'
        +'<p style="font-size:12px;color:var(--ink3);margin-bottom:14px;line-height:1.5">Download the firm profile as a <code style="font-size:11px;background:var(--bg);padding:1px 5px;border-radius:4px">.json</code> file. Share it with your team - they import it on first launch or via Settings &rarr; Import.</p>'
        +'<div style="display:flex;gap:10px;flex-wrap:wrap">'
        +'<button class="btn btn-gr" onclick="A.exportFirmProfile()">'+IC.dl+' Download Firm Profile (.json)</button>'
        +'</div>'
        +'</div>'
      : '')
    ;
  }

  return '<div class="ov"><div class="modal modal-lg"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.gear+' Settings</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'+tabNav+body+'</div>'
    +'<div class="modal-ft" style="flex-wrap:wrap;gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Close</button>'
    +'<button class="btn btn-gh" onclick="A.dlManifest()" title="Regenerate CLAUDE_BILLING.md" style="color:var(--purple);border-color:var(--purple)">'+IC.dl+' Claude Guide</button>'
    +'</div></div></div>';
}

function buildITUserModal(){
  var f=ST.itf||{};
  var isEdit=(f.editIdx!=null);
  var roleOpts=[
    {v:'attorney',l:'Attorney'},
    {v:'partner',l:'Partner'},
    {v:'billing_staff',l:'Billing Staff'}
  ].map(function(o){return '<option value="'+o.v+'"'+(f.role===o.v?' selected':'')+'>'+H(o.l)+'</option>';}).join('');
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.usr+' '+(isEdit?'Edit':'Add')+' Profile User</h2>'
    +'<button class="btn-ic" onclick="A.closeITUser()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div class="fl" style="margin-bottom:14px"><label>Name <span class="req">*</span></label>'
    +'<input type="text" id="itu-name" value="'+H(f.name||'')+'" placeholder="e.g. Sarah Johnson" /></div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label>Initials</label><input type="text" id="itu-ini" value="'+H(f.initials||'')+'" maxlength="4" placeholder="SJ" />'
    +'<div class="hint">Auto-generated if blank</div></div>'
    +'<div class="fl"><label>Role</label><select id="itu-role">'+roleOpts+'</select></div>'
    +'</div>'
    +'<div class="frow c2" style="margin-bottom:14px">'
    +'<div class="fl"><label>Default Rate ($/hr)</label>'
    +'<div class="pw"><span class="pfx">$</span><input type="text" id="itu-rate" value="'+H(f.rate||'')+'" placeholder="150.00" /></div></div>'
    +(ST.prefs.revenueSplit?'<div class="fl"><label>Personal Cut %</label>'
    +'<div class="pw"><input type="number" id="itu-pct" min="0" max="100" step="1" value="'+H(f.ownPct!=null?String(f.ownPct):'100')+'" placeholder="100" /><span class="sfx">%</span></div></div>':'')
    +'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeITUser()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveITUser()">'+IC.save+' '+(isEdit?'Update':'Add')+' User</button>'
    +'</div></div></div>';
}

// Shared: splash left-panel hero HTML
function splashHero(steps,activeIdx){
  var appName=H(ST.prefs.appName||'SixMinuteLog.com');
  var stepsH=steps.map(function(s,i){
    var cls='splash-step'+(i<activeIdx?' done':i===activeIdx?' active':'');
    return '<div class="'+cls+'"><div class="splash-step-dot"></div><span>'+s+'</span></div>';
  }).join('');
  return '<div class="splash-hero">'
    +'<div class="splash-logo">'
    +'<div class="splash-logo-mark"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>'
    +'<span class="splash-logo-name">'+appName+'</span>'
    +'</div>'
    +'<div class="splash-tagline"><h1>Legal billing,<br><strong>without the friction.</strong></h1>'
    +'<p>Track time, manage clients, and generate invoices \u2014 all in one place, fully offline.</p></div>'
    +'<div class="splash-steps">'+stepsH+'</div>'
    +'</div>';
}

function buildProfileImport(){
  var STEPS=['Firm Setup','Your Profile'];
  var arrowSvg='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
  return '<div class="splash-ov">'
    +splashHero(STEPS,0)
    +'<div class="splash-form">'
    +'<div class="splash-form-inner">'
    +'<h2>Welcome to <strong>'+H(ST.prefs.appName||'SixMinuteLog.com')+'</strong></h2>'
    +'<p class="sub">Get started in seconds. If your firm administrator shared a profile file, import it to pre-load your clients, contacts, and settings. Otherwise, set up manually.</p>'

    +'<div class="splash-opt" onclick="document.getElementById(\'spl-prof-inp\').click()">'
    +'<div class="splash-opt-icon blue">'+IC.ul+'</div>'
    +'<div class="splash-opt-body"><strong>Import Firm Profile</strong><span>Load pre-configured clients, matters, contacts, and user profiles from a .json file provided by your administrator.</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div>'
    +'<input type="file" id="spl-prof-inp" accept=".json" style="display:none" onchange="A.importFirmProfile(this)">'

    +'<div class="splash-opt" onclick="A.skipProfileImport()">'
    +'<div class="splash-opt-icon slate"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>'
    +'<div class="splash-opt-body"><strong>Set Up Manually</strong><span>Enter your name and role now. You can add clients, matters, and team members any time from the app.</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div>'

    +'<div class="splash-features">'
    +'<div class="splash-features-title">What a firm profile includes</div>'
    +['Firm name &amp; app branding','Pre-configured clients &amp; matters','Team contacts &amp; roles','Description presets','Pre-defined user profiles'].map(function(t){
      return '<div class="splash-feature"><div class="splash-feature-dot"></div><span>'+t+'</span></div>';
    }).join('')
    +'</div>'
    +'</div>'
    +'<div class="splash-footer"><span class="splash-footer-note">\ud83d\udd12 All data stays on this device only</span></div>'
    +'</div></div>';
}

function buildITUserSelect(){
  var STEPS=['Firm Setup','Your Profile'];
  var fp=ST._importedProfile||{};
  var users=fp.users||[];
  var arrowSvg='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
  var firmName=H(fp.firmName||fp.appName||ST.prefs.appName||'Your Firm');
  var userCards=users.map(function(u,i){
    var ini=u.initials||(u.name?u.name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,3):'?');
    var roleLabel={attorney:'Attorney',partner:'Partner',billing_staff:'Billing Staff'}[u.role]||H(u.role||'');
    return '<div class="splash-user-card" onclick="A.pickITUser('+i+')">'
      +'<div class="splash-avatar">'+H(ini)+'</div>'
      +'<div class="splash-user-info"><strong>'+H(u.name)+'</strong><span>'+roleLabel+(u.rate?' \u00b7 $'+H(String(u.rate))+'/hr':'')+'</span></div>'
      +'<div class="splash-opt-arrow" style="margin-left:auto">'+arrowSvg+'</div>'
      +'</div>';
  }).join('');
  return '<div class="splash-ov">'
    +splashHero(STEPS,1)
    +'<div class="splash-form">'
    +'<div class="splash-form-inner">'
    +'<h2>Select <strong>your profile</strong></h2>'
    +'<p class="sub">'+firmName+' has pre-configured user profiles. Select yours to get started with the right permissions and billing rate.</p>'
    +userCards
    +'<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">'
    +'<div class="splash-opt" onclick="A.skipProfileImport()" style="margin-bottom:0;padding:14px 16px">'
    +'<div class="splash-opt-icon slate"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M6 20v-2a6 6 0 0 1 12 0v2"/></svg></div>'
    +'<div class="splash-opt-body"><strong>Custom profile</strong><span>My name isn\'t listed \u2014 set up manually</span></div>'
    +'<div class="splash-opt-arrow">'+arrowSvg+'</div>'
    +'</div></div>'
    +'</div>'
    +'<div class="splash-footer"><span class="splash-footer-note">\ud83c\udfe2 '+firmName+' profile loaded</span></div>'
    +'</div></div>';
}


// ── Email Preset Builder helpers ────────────────────────────────────────
// Quick-template definitions: [label, purpose, subject, body, signature]
// ── Shared placeholder helpers ───────────────────────────────────────────────

// Built-in placeholders: [token, label, sampleValue, description]
var BUILTIN_PH=[
  ['{client}',      'Client name',         'Acme Corporation',       'Auto-filled from the active record'],
  ['{matter}',      'Matter name',         'Contract Review',        'Auto-filled from the active record'],
  ['{firm}',        'Firm name',           'Smith & Associates LLP', 'Set in Settings → Advanced → Firm Name'],
  ['{user}',        'Your full name',      'Sarah Johnson',          'Your profile name'],
  ['{initials}',    'Your initials',       'SJ',                     'Your profile initials'],
  ['{date}',        'Current month/year',  'January 2026',           'Resolved at send time'],
  ['{due_date}',    'Due date (+30 days)', 'February 15, 2026',      'Resolved at send time'],
  ['{invoice_num}', 'Invoice number',      'INV-0042',               'Auto-filled when sending an invoice email'],
  ['{amount}',      'Invoice total',       '$3,250.00',              'Auto-filled when sending an invoice email'],
  ['{entries_count}','Number of entries',  '8',                      'Auto-filled from visible timesheet'],
  ['{hours_total}', 'Total hours',         '12.5',                   'Auto-filled from visible timesheet'],
  ['{filename}',    'Export filename',     'billing-entries_2026-01-24.csv', 'Generated from current export settings'],
  ['{cc_list}',     'CC recipients list',  '',                       'Taken from the preset CC field']
];

// Linkable record fields: [fieldKey, displayLabel, groupLabel]
var LINKED_FIELDS=[
  ['client_name',          'Name',                   'Client'],
  ['client_email',         'Email',                  'Client'],
  ['client_phone',         'Phone',                  'Client'],
  ['client_rate',          'Default Rate',           'Client'],
  ['client_contact_name',  'Rep Name',               'Client Representative'],
  ['client_contact_role',  'Rep Role / Title',       'Client Representative'],
  ['client_contact_email', 'Rep Email',              'Client Representative'],
  ['client_contact_phone', 'Rep Phone',              'Client Representative'],
  ['matter_name',          'Name',                   'Matter'],
  ['matter_contact_name',  'Contact Name',           'Matter Contact'],
  ['matter_contact_role',  'Contact Role / Title',   'Matter Contact'],
  ['matter_contact_email', 'Contact Email',          'Matter Contact'],
  ['matter_contact_phone', 'Contact Phone',          'Matter Contact'],
  ['user_name',            'Full Name',              'My Profile'],
  ['user_initials',        'Initials',               'My Profile'],
  ['user_email',           'Email',                  'My Profile'],
  ['user_phone',           'Phone',                  'My Profile'],
];
function _lfLabel(key){
  var f=LINKED_FIELDS.find(function(x){return x[0]===key;});
  return f ? f[2]+' \u2192 '+f[1] : key;
}

// Returns merged list of [token, label] for UI display
function _allPH(){
  var list=BUILTIN_PH.map(function(p){return [p[0],p[1]];});
  (ST.mailPlaceholders||[]).forEach(function(p){
    list.push(['{'+p.key+'}', p.label]);
  });
  return list;
}

// Build the full token→value map used by replacePlaceholders
// ctx: optional object with {clientName, matterName, invNum, invAmount, entriesCount, hoursTotal}
function _phMap(ctx, mp){
  ctx=ctx||{};
  mp=mp||{};
  var now=new Date();
  var dateStr=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  var due=new Date(now); due.setDate(due.getDate()+30);
  var dueStr=due.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  var map={
    '{filename}': exportFilename(),
    '{date}':     dateStr,
    '{due_date}': dueStr,
    '{client}':   ctx.clientName||'',
    '{matter}':   ctx.matterName||'',
    '{firm}':     ST.prefs.firmName||(ST.firmProfile&&ST.firmProfile.firmName)||'',
    '{invoice_num}': ctx.invNum||'',
    '{amount}':   ctx.invAmount||'',
    '{entries_count}': ctx.entriesCount!=null?String(ctx.entriesCount):'',
    '{hours_total}':   ctx.hoursTotal||'',
    '{user}':     (ST.user&&ST.user.name)||'',
    '{initials}': (ST.user&&ST.user.initials)||'',
    '{cc_list}':  mp.cc||''
  };
  var _cl=null,_clCt=null,_ma=null,_maCt=null;
  function _getClient(){
    if(_cl===null){_cl=ST.clients.find(function(c){return c.id==ctx.clientId;})||{};
      _clCt=_cl.contactId?ST.contacts.find(function(c){return c.id==_cl.contactId;})||{}:{};}
    return _cl;}
  function _getMatter(){
    if(_ma===null){_ma=ST.matters.find(function(m){return m.id==ctx.matterId;})||{};
      _maCt=_ma.contactId?ST.contacts.find(function(c){return c.id==_ma.contactId;})||{}:{};}
    return _ma;}
  function _resolveLinkedField(key){
    switch(key){
      case 'client_name':          return _getClient().name||'';
      case 'client_email':         return _getClient().email||'';
      case 'client_phone':         return _getClient().phone||'';
      case 'client_rate':          return _getClient().rate?'$'+_getClient().rate+'/hr':'';
      case 'client_contact_name':  _getClient(); return (_clCt&&_clCt.name)||'';
      case 'client_contact_role':  _getClient(); return (_clCt&&_clCt.role)||'';
      case 'client_contact_email': _getClient(); return (_clCt&&_clCt.email)||'';
      case 'client_contact_phone': _getClient(); return (_clCt&&_clCt.phone)||'';
      case 'matter_name':          return _getMatter().name||'';
      case 'matter_contact_name':  _getMatter(); return (_maCt&&_maCt.name)||'';
      case 'matter_contact_role':  _getMatter(); return (_maCt&&_maCt.role)||'';
      case 'matter_contact_email': _getMatter(); return (_maCt&&_maCt.email)||'';
      case 'matter_contact_phone': _getMatter(); return (_maCt&&_maCt.phone)||'';
      case 'user_name':            return (ST.user&&ST.user.name)||'';
      case 'user_initials':        return (ST.user&&ST.user.initials)||'';
      case 'user_email':           return (ST.user&&ST.user.email)||'';
      case 'user_phone':           return (ST.user&&ST.user.phone)||'';
      default:                     return '';
    }
  }
  (ST.mailPlaceholders||[]).forEach(function(p){
    if(p.source==='linked'&&p.linkedField){
      map['{'+p.key+'}'] = _resolveLinkedField(p.linkedField);
    } else {
      map['{'+p.key+'}'] = p.value||'';
    }
  });
  return map;
}

// Apply a token→value map to a string
function _applyPH(s, map){
  s=s||'';
  Object.keys(map).forEach(function(k){ s=s.split(k).join(map[k]); });
  return s;
}

// ── End shared placeholder helpers ───────────────────────────────────────────

var MAIL_QUICK_TEMPLATES=[
  ['Invoice to Client','invoice_client',
   'Invoice #{invoice_num} \u2014 {client} \u2014 {date}',
   'Dear {client},\n\nPlease find your invoice #{invoice_num} totalling {amount}, covering the period through {date}.\n\nKindly arrange payment at your earliest convenience. Do not hesitate to reach out with any questions.',
   'Warm regards,\n{user}\n{firm}'],
  ['Approval Request','partner_approval',
   'Approval Required: {entries_count} Entries \u2014 {hours_total}h \u2014 {date}',
   'Hi,\n\nI am submitting {entries_count} billing entries ({hours_total}h) for your review and approval.\n\nPlease find the attached CSV for details. Let me know if any adjustments are needed.',
   'Thank you,\n{initials}\n{user}'],
  ['Billing Staff Report','billing_staff',
   'Billing Report \u2014 {hours_total}h \u2014 {date}',
   'Hi team,\n\nAttached is this period\u2019s billing report covering {entries_count} entries and {hours_total}h across {client}.\n\nPlease process at your earliest convenience.',
   'Best,\n{user}'],
  ['General / Custom','general',
   'Billing Report \u2014 {filename}',
   'Please find the attached billing data for your records.\n\nFile: {filename}\nDate: {date}',
   '{user}']
];

// Insert a placeholder token at cursor in the focused textarea/input, else append
function _mpInsert(token){
  var el=document.getElementById('mp-body')||document.getElementById('mp-subj');
  // try to detect which field was last focused
  var focused=document.activeElement;
  if(focused&&(focused.id==='mp-body'||focused.id==='mp-subj'||focused.id==='mp-sig')){
    el=focused;
  }
  if(!el) return;
  var s=el.selectionStart||0, e2=el.selectionEnd||0;
  var v=el.value;
  el.value=v.substring(0,s)+token+v.substring(e2);
  el.selectionStart=el.selectionEnd=s+token.length;
  el.focus();
  _mpPreview();
}

// Live preview renderer — reads all fields, replaces placeholders with sample data
function _mpPreview(){
  var pv=document.getElementById('mp-preview');
  if(!pv) return;
  var subj=(document.getElementById('mp-subj')||{value:''}).value;
  var body=(document.getElementById('mp-body')||{value:''}).value;
  var sig=(document.getElementById('mp-sig')||{value:''}).value;
  var full=body+(sig?'\n\n'+sig:'');
  // Build sample map: use real user data + built-in samples + custom placeholder values
  var sampleCtx={clientName:'Acme Corporation',matterName:'Contract Review',invNum:'INV-0042',invAmount:'$3,250.00',entriesCount:'8',hoursTotal:'12.5'};
  var sampleMp={cc:(document.getElementById('mp-cc')||{value:''}).value};
  var map=_phMap(sampleCtx, sampleMp);
  // Override built-ins with richer samples where real data isn't meaningful
  map['{date}']='January 2026';
  map['{due_date}']='February 15, 2026';
  map['{filename}']='billing-entries_2026-01-24.csv';
  if(!map['{firm}']) map['{firm}']='Smith & Associates LLP';
  if(!map['{user}']) map['{user}']='Sarah Johnson';
  if(!map['{initials}']) map['{initials}']='SJ';
  // Custom placeholders show their configured value in preview
  var rSubj=H(_applyPH(subj||'(no subject)', map));
  var rBody=H(_applyPH(full||'(no body)', map)).replace(/\n/g,'<br>');
  var to=(document.getElementById('mp-to')||{value:''}).value||'client@example.com';
  var cc=(document.getElementById('mp-cc')||{value:''}).value;
  var bcc=(document.getElementById('mp-bcc')||{value:''}).value;
  var rt=(document.getElementById('mp-replyto')||{value:''}).value;
  pv.innerHTML='<div style="font-size:11px;color:var(--ink3);font-family:monospace;line-height:1.8">'
    +'<div><strong style="color:var(--ink2)">To:</strong> '+H(to)+'</div>'
    +(cc?'<div><strong style="color:var(--ink2)">CC:</strong> '+H(cc)+'</div>':'')
    +(bcc?'<div><strong style="color:var(--ink2)">BCC:</strong> '+H(bcc)+'</div>':'')
    +(rt?'<div><strong style="color:var(--ink2)">Reply-To:</strong> '+H(rt)+'</div>':'')
    +'<div><strong style="color:var(--ink2)">Subject:</strong> '+rSubj+'</div>'
    +'</div>'
    +'<hr style="border:none;border-top:1px solid var(--border);margin:8px 0">'
    +'<div style="font-size:12px;color:var(--ink);line-height:1.7;white-space:pre-wrap">'+rBody+'</div>';
}

// Apply a quick-template to the form fields
function _mpApplyTemplate(idx){
  var t=MAIL_QUICK_TEMPLATES[idx];
  if(!t) return;
  var purpEl=document.getElementById('mp-purpose');
  var subjEl=document.getElementById('mp-subj');
  var bodyEl=document.getElementById('mp-body');
  var sigEl=document.getElementById('mp-sig');
  if(purpEl) purpEl.value=t[1];
  if(subjEl) subjEl.value=t[2];
  if(bodyEl) bodyEl.value=t[3];
  if(sigEl) sigEl.value=t[4]||'';
  _mpPreview();
}
// ── End helpers ─────────────────────────────────────────────────────────

function buildMailPreset(){
  var f=ST.mpf||{};
  var isEdit=(f.editIdx!=null);
  var purp=f.purpose||'general';
  var ALL_PH=_allPH();
  var priorityOpts=[['normal','Normal'],['high','High \u2014 flag as urgent'],['low','Low \u2014 FYI only']];
  var pri=f.priority||'normal';
  return '<div class="ov"><div class="modal" style="max-width:820px;width:96vw"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(isEdit?'Edit':'New')+' Email Preset</h2><button class="btn-ic" onclick="A.closeMailPreset()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="display:grid;grid-template-columns:1fr 1fr;gap:0;padding:0">'

    // ── LEFT COLUMN: form ──
    +'<div style="padding:20px 18px;overflow-y:auto;max-height:72vh;border-right:1px solid var(--border)">'

    // Quick templates row
    +'<div style="margin-bottom:16px">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px">Quick templates</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:5px">'
    +MAIL_QUICK_TEMPLATES.map(function(t,i){
      return '<button type="button" class="btn btn-gh" style="font-size:11px;padding:4px 10px" onclick="_mpApplyTemplate('+i+')">'+H(t[0])+'</button>';
    }).join('')
    +'</div></div>'

    // Name + Purpose
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>Preset Name <span class="req">*</span></label><input type="text" id="mp-name" value="'+H(f.name||'')+'" placeholder="e.g. Invoice to Acme Corp" oninput="_mpPreview()" /></div>'
    +'<div class="fl"><label>Purpose</label>'
    +'<select id="mp-purpose" onchange="_mpPreview()">'
    +'<option value="general"'+(purp==='general'?' selected':'')+'>General</option>'
    +'<option value="invoice_client"'+(purp==='invoice_client'?' selected':'')+'>Invoice to Client</option>'
    +'<option value="billing_staff"'+(purp==='billing_staff'?' selected':'')+'>Entries to Billing Staff</option>'
    +'<option value="partner_approval"'+(purp==='partner_approval'?' selected':'')+'>Entries for Partner Approval</option>'
    +'</select></div></div>'

    // Priority + Reply-To
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>Priority</label>'
    +'<select id="mp-priority" onchange="_mpPreview()">'
    +priorityOpts.map(function(o){return '<option value="'+o[0]+'"'+(pri===o[0]?' selected':'')+'>'+H(o[1])+'</option>';}).join('')
    +'</select></div>'
    +'<div class="fl"><label>Reply-To <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="email" id="mp-replyto" value="'+H(f.replyTo||'')+'" placeholder="billing@firm.com" oninput="_mpPreview()" /></div></div>'

    // To
    +'<div class="fl" style="margin-bottom:12px"><label>To <span style="font-size:11px;color:var(--ink3)">&mdash; leave blank to auto-fill from record</span></label>'
    +'<input type="text" id="mp-to" value="'+H(f.to||'')+'" placeholder="client@example.com, partner@firm.com" oninput="_mpPreview()" />'
    +'<div class="hint">Separate multiple addresses with commas.</div></div>'

    // CC + BCC
    +'<div class="frow c2" style="margin-bottom:12px">'
    +'<div class="fl"><label>CC <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="text" id="mp-cc" value="'+H(f.cc||'')+'" placeholder="manager@firm.com" oninput="_mpPreview()" /></div>'
    +'<div class="fl"><label>BCC <span style="font-size:11px;color:var(--ink3)">(optional)</span></label><input type="text" id="mp-bcc" value="'+H(f.bcc||'')+'" placeholder="archive@firm.com" oninput="_mpPreview()" /></div></div>'

    // Subject
    +'<div class="fl" style="margin-bottom:12px"><label>Subject Line</label><input type="text" id="mp-subj" value="'+H(f.subject||'')+'" placeholder="Invoice #{invoice_num} \u2014 {client}" oninput="_mpPreview()" /></div>'

    // Body
    +'<div class="fl" style="margin-bottom:12px"><label>Message Body</label><textarea id="mp-body" rows="6" oninput="_mpPreview()" placeholder="Dear {client},\n\nPlease find attached...">'+H(f.body||'')+'</textarea></div>'

    // Signature
    +'<div class="fl" style="margin-bottom:16px">'
    +'<label>Signature <span style="font-size:11px;color:var(--ink3)">&mdash; auto-appended after double line-break</span></label>'
    +'<textarea id="mp-sig" rows="3" oninput="_mpPreview()" placeholder="Best regards,\n{user}\n{firm}">'+H(f.signature||'')+'</textarea></div>'

    // Placeholder insert bar
    +'<div style="background:var(--bg);border-radius:8px;padding:10px 12px;margin-bottom:4px">'
    +'<div style="font-size:10px;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px">Click to insert placeholder at cursor</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:4px">'
    +ALL_PH.map(function(ph){
      return '<button type="button" title="'+H(ph[1])+'" onclick="_mpInsert(\''+ph[0]+'\')" style="font-size:11px;font-family:monospace;padding:3px 8px;background:var(--white);border:1px solid var(--border);border-radius:5px;cursor:pointer;color:var(--blue)">'+H(ph[0])+'</button>';
    }).join('')
    +'</div></div>'
    +'</div>'

    // ── RIGHT COLUMN: live preview ──
    +'<div style="padding:20px 18px;overflow-y:auto;max-height:72vh;background:var(--bg2)">'
    +'<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Live preview <span style="opacity:.6">(sample data)</span></div>'
    +'<div id="mp-preview" style="background:var(--white);border:1px solid var(--border);border-radius:8px;padding:14px 16px;min-height:200px;word-break:break-word"></div>'
    +'<div style="margin-top:14px;font-size:11px;color:var(--ink3);line-height:1.7">'
    +'<strong style="display:block;margin-bottom:6px;color:var(--ink2)">Placeholder guide</strong>'
    +ALL_PH.map(function(ph){return '<div><code style="font-size:10px;color:var(--blue)">'+H(ph[0])+'</code> &mdash; '+H(ph[1])+'</div>';}).join('')
    +'</div>'
    +'</div>'

    +'</div>'// end grid

    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeMailPreset()">Cancel</button>'
    +'<button class="btn btn-bl" onclick="A.saveMailPreset()">'+IC.save+' Save Preset</button>'
    +'</div></div></div>';
}

function buildMailPH(){
  var f=ST.mphf||{};
  var isEdit=(f.editIdx!=null);
  var src=f.source||'static';
  var keyErr=f.errs&&f.errs.key;
  var labelErr=f.errs&&f.errs.label;
  var lfGroups={};
  LINKED_FIELDS.forEach(function(x){if(!lfGroups[x[2]])lfGroups[x[2]]=[];lfGroups[x[2]].push(x);});
  var lfOpts='<option value="">— choose a field —</option>';
  Object.keys(lfGroups).forEach(function(grp){
    lfOpts+='<optgroup label="'+H(grp)+'">';
    lfGroups[grp].forEach(function(x){lfOpts+='<option value="'+H(x[0])+'"'+(f.linkedField===x[0]?' selected':'')+'>'+H(x[1])+'</option>';});
    lfOpts+='</optgroup>';
  });
  var sourceToggle='<div class="fl" style="margin-bottom:14px"><label>Value source</label>'
    +'<div style="display:flex;gap:6px">'
    +'<button type="button" class="btn '+(src==='static'?'btn-bl':'btn-gh')+'" style="flex:1;font-size:12px" onclick="A.mphSetSource(\'static\')">Static text</button>'
    +'<button type="button" class="btn '+(src==='linked'?'btn-bl':'btn-gh')+'" style="flex:1;font-size:12px" onclick="A.mphSetSource(\'linked\')">Linked field</button>'
    +'</div><div style="font-size:11px;color:var(--ink3);margin-top:4px">'
    +(src==='linked'?'Value is pulled from the active client/matter record each time the placeholder is resolved.':'Value is a fixed text string you set here.')
    +'</div></div>';
  var valueSection=src==='linked'
    ? '<div class="fl" style="margin-bottom:4px"><label>Linked field <span class="req">*</span></label>'
      +'<select id="mph-lf" style="width:100%">'+lfOpts+'</select>'
      +(f.errs&&f.errs.linkedField?'<div class="note" style="margin-top:4px">'+H(f.errs.linkedField)+'</div>':'')
      +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Resolves from whichever client/matter is active when the email is sent.</div></div>'
    : '<div class="fl" style="margin-bottom:4px"><label>Static value <span style="font-size:11px;color:var(--ink3)">\u2014 inserted verbatim when sending</span></label>'
      +'<textarea id="mph-value" rows="3" placeholder="e.g. John Smith, Managing Partner">'+H(f.value||'')+'</textarea>'
      +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Leave blank to keep the token as-is when empty.</div></div>';
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(isEdit?'Edit':'New')+' Placeholder</h2>'
    +'<button class="btn-ic" onclick="A.closeMailPH()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div class="fl" style="margin-bottom:14px"><label>Token key <span class="req">*</span> <span style="font-size:11px;color:var(--ink3)">\u2014 used as <code>{key}</code> in subject &amp; body</span></label>'
    +'<div style="display:flex;align-items:center;gap:4px">'
    +'<span style="font-family:monospace;font-size:14px;color:var(--ink3)">{</span>'
    +'<input type="text" id="mph-key" value="'+H(f.key||'')+'" placeholder="my_token" style="font-family:monospace" oninput="this.value=this.value.replace(/[^a-z0-9_]/g,\'\')" />'
    +'<span style="font-family:monospace;font-size:14px;color:var(--ink3)">}</span></div>'
    +(keyErr?'<div class="note" style="margin-top:4px">'+H(keyErr)+'</div>':'')
    +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Lowercase letters, numbers, underscores only.</div></div>'
    +'<div class="fl" style="margin-bottom:14px"><label>Label <span class="req">*</span></label>'
    +'<input type="text" id="mph-label" value="'+H(f.label||'')+'" placeholder="e.g. Client representative" />'
    +(labelErr?'<div class="note" style="margin-top:4px">'+H(labelErr)+'</div>':'')
    +'</div>'
    +sourceToggle+valueSection
    +'</div><div class="modal-ft" style="gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeMailPH()">Cancel</button>'
    +'<button class="btn btn-bl" onclick="A.saveMailPH()">'+IC.save+' Save</button>'
    +'</div></div></div>';
}

function buildMailSend(){
  return '<div class="ov"><div class="modal modal-sm"><div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' Send Email</h2><button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +(ST.mailPresets.length>0
      ? '<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Choose a preset</div>'
        +ST.mailPresets.map(function(mp,i){
          return '<div class="crow" style="cursor:pointer;margin-bottom:8px" onclick="A.sendMailPreset('+i+')">'
            +'<div style="width:32px;height:32px;border-radius:8px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0">'+IC.mail+'</div>'
            +'<div><strong style="font-size:13px;color:var(--ink)">'+H(mp.name||'Preset '+(i+1))+'</strong>'
            +(mp.to?'<div style="font-size:11px;color:var(--ink3)">To: '+H(mp.to)+'</div>':'')
            +'</div></div>';
        }).join('')
      : '<div class="empty" style="padding:20px"><p>No email presets configured</p><small>Add presets in Settings \u2192 Email tab</small></div>'
    )
    +'</div>'
    +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +(ST.mailPresets.length===0?'<button class="btn btn-bl" onclick="A.openMailPreset(null)">'+IC.plus+' Add Preset</button>':'')
    +'</div></div></div>';
}

// Purpose label helper
function purposeLabel(p){
  return {general:'General',invoice_client:'Invoice to Client',billing_staff:'Entries to Billing Staff',partner_approval:'Entries for Partner Approval'}[p]||'General';
}

// ── Screen 2: Preview + editable draft ────────────────────────────────────
function _buildMailPreview(ctx){
  var purpose=ctx.purpose||'general';
  var titles={invoice_client:'Email Invoice to Client',billing_staff:'Send Entries to Billing Staff',partner_approval:'Submit for Partner Approval',general:'Send Billing Report'};
  var d=ctx._draft||{};
  // Tab state: 'edit' | 'preview'
  var tab=ctx._pvTab||'edit';

  var bodyPreview=H(d.body||'').replace(/\n/g,'<br>');

  var editPanel='<div style="display:flex;flex-direction:column;gap:10px">'
    // To
    +'<div class="fl" style="margin:0">'
    +'<label style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">To <span class="req">*</span></label>'
    +'<input id="mc-to" type="email" value="'+H(d.to||'')+'" placeholder="recipient@example.com" oninput="A.mcLive()" />'
    +'</div>'
    // Subject
    +'<div class="fl" style="margin:0">'
    +'<label style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">Subject</label>'
    +'<input id="mc-subj" type="text" value="'+H(d.subj||'')+'" placeholder="(no subject)" oninput="A.mcLive()" />'
    +'</div>'
    // CC / BCC / Reply-To in a compact row
    +'<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">'
    +'<div class="fl" style="margin:0"><label style="font-size:11px;color:var(--ink3)">CC</label>'
    +'<input id="mc-cc" type="text" value="'+H(d.cc||'')+'" placeholder="cc@example.com" oninput="A.mcLive()" /></div>'
    +'<div class="fl" style="margin:0"><label style="font-size:11px;color:var(--ink3)">BCC</label>'
    +'<input id="mc-bcc" type="text" value="'+H(d.bcc||'')+'" placeholder="bcc@example.com" oninput="A.mcLive()" /></div>'
    +'<div class="fl" style="margin:0"><label style="font-size:11px;color:var(--ink3)">Reply-To</label>'
    +'<input id="mc-rt" type="email" value="'+H(d.replyTo||'')+'" placeholder="you@firm.com" oninput="A.mcLive()" /></div>'
    +'</div>'
    // Body
    +'<div class="fl" style="margin:0">'
    +'<label style="font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">Body</label>'
    +'<textarea id="mc-body" rows="12" style="font-family:inherit;font-size:13px;line-height:1.6;resize:vertical" oninput="A.mcLive()">'+H(d.body||'')+'</textarea>'
    +'</div>'
    +'</div>';

  var previewPanel='<div style="border:1px solid var(--brd);border-radius:8px;overflow:hidden">'
    // Header row mimicking an email header
    +'<div style="background:var(--bg);border-bottom:1px solid var(--brd);padding:12px 16px;display:flex;flex-direction:column;gap:4px;font-size:12px;font-family:monospace;color:var(--ink2)">'
    +'<div><strong style="color:var(--ink3);display:inline-block;width:52px">To:</strong> '+H(d.to||'—')+'</div>'
    +(d.cc?'<div><strong style="color:var(--ink3);display:inline-block;width:52px">CC:</strong> '+H(d.cc)+'</div>':'')
    +(d.bcc?'<div><strong style="color:var(--ink3);display:inline-block;width:52px">BCC:</strong> '+H(d.bcc)+'</div>':'')
    +(d.replyTo?'<div><strong style="color:var(--ink3);display:inline-block;width:52px">Reply-To:</strong> '+H(d.replyTo)+'</div>':'')
    +'<div><strong style="color:var(--ink3);display:inline-block;width:52px">Subject:</strong> <strong style="color:var(--ink)">'+H(d.subj||'(no subject)')+'</strong></div>'
    +'</div>'
    // Body
    +'<div style="padding:18px 20px;font-size:13px;line-height:1.75;color:var(--ink);white-space:pre-wrap;word-break:break-word;min-height:180px;max-height:340px;overflow-y:auto">'+bodyPreview+'</div>'
    +'</div>';

  // Tab bar
  var tabBar='<div style="display:flex;gap:0;border:1px solid var(--brd);border-radius:7px;overflow:hidden;margin-bottom:14px;width:fit-content">'
    +'<button type="button" class="btn '+(tab==='edit'?'btn-dk':'btn-gh')+'" style="border-radius:0;border:none;padding:7px 18px;font-size:12px" onclick="A.mcTab(\'edit\')">✏️ Edit</button>'
    +'<button type="button" class="btn '+(tab==='preview'?'btn-dk':'btn-gh')+'" style="border-radius:0;border:none;padding:7px 18px;font-size:12px;border-left:1px solid var(--brd)" onclick="A.mcTab(\'preview\')">👁 Preview</button>'
    +'</div>';

  // Context chips
  var ctxInfo='';
  if(ctx.clientName) ctxInfo+='<span><strong>Client:</strong> '+H(ctx.clientName)+'</span> ';
  if(ctx.invNum)     ctxInfo+='<span><strong>Invoice #:</strong> '+H(ctx.invNum)+'</span> ';
  if(ctx.invAmount)  ctxInfo+='<span><strong>Amount:</strong> '+H(ctx.invAmount)+'</span> ';
  if(ctx.entriesCount!=null) ctxInfo+='<span><strong>Entries:</strong> '+H(String(ctx.entriesCount))+'</span> ';
  if(ctx.hoursTotal) ctxInfo+='<span><strong>Hours:</strong> '+H(ctx.hoursTotal)+'h</span>';
  var ctxBar=ctxInfo?'<div style="display:flex;gap:14px;flex-wrap:wrap;background:var(--bg);border-radius:7px;padding:8px 12px;font-size:12px;color:var(--ink2);margin-bottom:12px">'+ctxInfo+'</div>':'';

  return '<div class="ov"><div class="modal modal-lg" style="max-height:92vh;display:flex;flex-direction:column"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(titles[purpose]||'Send Email')+' <span style="font-size:12px;font-weight:400;color:var(--ink3);background:var(--bg);padding:2px 9px;border-radius:12px;border:1px solid var(--brd)">Review &amp; Edit</span></h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'
    +ctxBar
    +tabBar
    +(tab==='edit' ? editPanel : previewPanel)
    +'</div>'
    +'<div class="modal-ft" style="gap:8px;flex-shrink:0">'
    +'<button class="btn btn-gh" onclick="A.backToPicker()">← Presets</button>'
    +'<button class="btn btn-gh" onclick="A.mcReset()">↺ Reset</button>'
    +'<button class="btn btn-bl" onclick="A.sendFromDraft()">'+IC.mail+' Open Mail App</button>'
    +'</div></div></div>';
}

// ── Screen 1: Preset picker ────────────────────────────────────────────────
function _buildMailPicker(ctx){
  var purpose=ctx.purpose||'general';
  var titles={invoice_client:'Email Invoice to Client',billing_staff:'Send Entries to Billing Staff',partner_approval:'Submit for Partner Approval',general:'Send Billing Report'};
  var filtered=ST.mailPresets.filter(function(mp){
    return (mp.purpose||'general')===purpose||(mp.purpose||'general')==='general';
  });
  var ctxInfo='';
  if(ctx.clientName) ctxInfo+='<span><strong>Client:</strong> '+H(ctx.clientName)+'</span> ';
  if(ctx.invNum)     ctxInfo+='<span><strong>Invoice #:</strong> '+H(ctx.invNum)+'</span> ';
  if(ctx.invAmount)  ctxInfo+='<span><strong>Amount:</strong> '+H(ctx.invAmount)+'</span> ';
  if(ctx.entriesCount!=null) ctxInfo+='<span><strong>Entries:</strong> '+H(String(ctx.entriesCount))+'</span> ';
  if(ctx.hoursTotal) ctxInfo+='<span><strong>Hours:</strong> '+H(ctx.hoursTotal)+'h</span>';
  return '<div class="ov"><div class="modal modal-md"><div class="modal-hd">'
    +'<h2 style="display:flex;align-items:center;gap:8px">'+IC.mail+' '+(titles[purpose]||'Send Email')+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +(ctxInfo?'<div style="display:flex;gap:16px;flex-wrap:wrap;background:var(--bg);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);margin-bottom:14px">'+ctxInfo+'</div>':'')
    +(ctx.toEmail?'<div style="background:var(--bg);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--ink2);margin-bottom:14px">'
      +'<strong>Recipient:</strong> <span style="color:var(--blue);font-family:monospace">'+H(ctx.toEmail)+'</span>'
      +'<span style="font-size:11px;color:var(--ink3);margin-left:8px">(auto-filled from record; preset &ldquo;To&rdquo; overrides if set)</span>'
      +'</div>':'')
    +(filtered.length>0
      ? '<div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Choose a preset to review &amp; send</div>'
        +filtered.map(function(mp){
          var realIdx=ST.mailPresets.indexOf(mp);
          var toDisplay=(mp.to&&mp.to.length)?mp.to:(ctx.toEmail||'');
          return '<div class="crow" style="cursor:pointer;margin-bottom:8px;align-items:flex-start" onclick="A.previewFromCompose('+realIdx+')">'
            +'<div style="width:36px;height:36px;border-radius:8px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0;margin-top:2px">'+IC.mail+'</div>'
            +'<div style="flex:1;min-width:0">'
            +'<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap"><strong style="font-size:13px;color:var(--ink)">'+H(mp.name||'Preset '+(realIdx+1))+'</strong>'
            +'<span class="status-badge '+(({general:'s-neutral',invoice_client:'s-approved',billing_staff:'s-review',partner_approval:'s-pending'}[mp.purpose||'general']||'s-neutral'))+'" style="font-size:10px;padding:2px 7px">'+purposeLabel(mp.purpose||'general')+'</span>'
            +((mp.priority==='high')?'<span style="font-size:10px;color:var(--red);font-weight:600">\u25b2 High</span>':'')
            +'</div>'
            +(toDisplay?'<div style="font-size:11px;color:var(--ink3)">To: '+H(toDisplay)+'</div>':'')
            +(mp.cc?'<div style="font-size:11px;color:var(--ink3)">CC: '+H(mp.cc)+'</div>':'')
            +(mp.subject?'<div style="font-size:11px;color:var(--ink3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:380px">Subj: '+H(mp.subject)+'</div>':'')
            +(mp.signature?'<div style="font-size:10px;color:var(--ink3);font-style:italic">\u2014 Signature included</div>':'')
            +'</div></div>';
        }).join('')
      : '<div class="empty" style="padding:24px"><p>No presets for &ldquo;'+purposeLabel(purpose)+'&rdquo;</p>'
        +'<small>Add a preset in Settings &rarr; Email with purpose set to <strong>'+purposeLabel(purpose)+'</strong></small></div>'
    )
    +'</div>'
    +'<div class="modal-ft" style="gap:8px">'
    +'<button class="btn btn-gh" onclick="A.closeM()">Cancel</button>'
    +'<button class="btn btn-gh" onclick="ST.modal=\'settings\';ST.settingsTab=\'email\';render()">'+IC.plus+' Manage Presets</button>'
    +'</div></div></div>';
}

// Contextual mail compose modal — router between the two screens
function buildMailCompose(){
  var ctx=ST.mailCompose||{};
  if(ctx._preview)  return _buildMailPreview(ctx);
  return _buildMailPicker(ctx);
}

// ── Workflow Export Modal ────────────────────────────────────────────────────
// ── Submit Timesheet Modal ─────────────────────────────────────────────────────
// Unified send + email form. Replaces the old workflow export modal.
function buildSubmitTimesheetModal(){
  var role=myRole();
  var me=ST.user?ST.user.name:'';
  var fe=filterEnt(ST.entries,ST.tsFilter);
  if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
  if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});

  // Scope entries by role
  var entries, pkgType, recipient, recipientRole, recipientRoleKey;
  if(role==='attorney'){
    entries=fe.filter(function(e){return e.createdBy===me;});
    pkgType='attorney_submission';
    recipient='Billing Staff'; recipientRole='for billing processing'; recipientRoleKey='billing_staff';
  } else if(role==='billing_staff'){
    entries=fe;
    pkgType='billing_review';
    recipient='Partner'; recipientRole='for approval'; recipientRoleKey='partner_approval';
  } else if(role==='partner'){
    entries=fe.filter(function(e){return (e.status||'pending')==='approved';});
    pkgType='partner_approval';
    recipient='Billing Staff'; recipientRole='for invoicing'; recipientRoleKey='billing_staff';
  } else {
    entries=fe; pkgType='attorney_submission'; recipient='Billing'; recipientRole=''; recipientRoleKey='billing_staff';
  }

  var hrs=entries.reduce(function(s,e){return s+Number(e.hours||0);},0);
  var bill=entries.reduce(function(s,e){return s+Number(e.hours||0)*Number(e.rate||0);},0);
  var dateFrom=entries.length?entries.reduce(function(mn,e){return e.date<mn?e.date:mn;},entries[0].date):'';
  var dateTo=entries.length?entries.reduce(function(mx,e){return e.date>mx?e.date:mx;},entries[0].date):'';
  var firmName=ST.prefs&&ST.prefs.firmName?ST.prefs.firmName:'';

  var emptyNotice=entries.length===0
    ?'<div class="role-notice" style="margin-bottom:16px">⚠ No entries available to submit in the current view. Adjust your time filter or filters above.</div>':'';

  // Auto-find recipient email from contacts
  var rcpEmail='';
  if(recipientRoleKey==='billing_staff'){
    var bsCt=ST.contacts.find(function(c){return c.email&&c.role&&c.role.toLowerCase().indexOf('billing')!==-1;});
    if(bsCt) rcpEmail=bsCt.email;
  } else {
    var pCt=ST.contacts.find(function(c){return c.email&&c.role&&(c.role.toLowerCase().indexOf('partner')!==-1||c.role.toLowerCase().indexOf('supervising')!==-1);});
    if(pCt) rcpEmail=pCt.email;
  }

  var cardStyle='border:1px solid var(--border);border-radius:10px;padding:16px 18px;flex:1;min-width:200px;display:flex;flex-direction:column;gap:10px';
  var cardHoverStyle='background:var(--bg2)';

  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">📤 Submit to '+H(recipient)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +emptyNotice

    // Summary card
    +(entries.length?'<div style="background:var(--bg2);border-radius:10px;padding:14px 16px;margin-bottom:18px">'
      +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink3);margin-bottom:8px">Package Summary</div>'
      +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center">'
      +'<div><div style="font-size:1.4rem;font-weight:300">'+entries.length+'</div><div style="font-size:11px;color:var(--ink3)">Entries</div></div>'
      +'<div><div style="font-size:1.4rem;font-weight:300">'+$h(hrs)+'</div><div style="font-size:11px;color:var(--ink3)">Hours</div></div>'
      +'<div><div style="font-size:1.4rem;font-weight:300">'+$m(bill)+'</div><div style="font-size:11px;color:var(--ink3)">Billable</div></div>'
      +'</div>'
      +(dateFrom?'<div style="font-size:11px;color:var(--ink3);margin-top:8px;text-align:center">'+$d(dateFrom)+' — '+$d(dateTo)+'</div>':'')
      +'</div>':'')

    // Note to recipient
    +'<div class="frow" style="margin-bottom:18px">'
    +'<label style="font-size:12px;font-weight:600;margin-bottom:5px;display:block">Note to '+H(recipient)+' <span style="font-weight:400;color:var(--ink3)">(optional)</span></label>'
    +'<textarea id="st-note" rows="2" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;resize:vertical;background:var(--white);color:var(--ink)" placeholder="Any context, instructions, or dates to highlight..."></textarea>'
    +'</div>'

    // Two action cards side by side
    +'<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:4px">'

    // Save file card
    +(entries.length?'<div style="'+cardStyle+'">'
      +'<div style="font-weight:600;font-size:13px">💾 Save Package File</div>'
      +'<div style="font-size:12px;color:var(--ink2);line-height:1.6">Downloads a <code>.json</code> transfer package the recipient imports into their own copy of the app.</div>'
      +'<button class="btn btn-dk" onclick="A.doSubmitSaveFile(\''+pkgType+'\')" style="margin-top:auto">Save Package File</button>'
      +'</div>':'')

    // Email card
    +'<div style="'+cardStyle+'">'
    +'<div style="font-weight:600;font-size:13px">'+IC.mail+' Send Email</div>'
    +'<div style="font-size:12px;color:var(--ink2);line-height:1.6">Compose an email to notify '+H(recipient)+' '+H(recipientRole)+'. You can attach the saved file manually.</div>'
    +'<div class="fl" style="margin-top:auto">'
    +'<label style="font-size:11px;color:var(--ink3)">Recipient email</label>'
    +'<input type="email" id="st-email" value="'+H(rcpEmail)+'" placeholder="colleague@firm.com" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:7px;font-size:12px;background:var(--white);color:var(--ink)">'
    +'</div>'
    +'<button class="btn btn-gr" onclick="A.doSubmitEmail(\''+recipientRoleKey+'\')" style="margin-top:6px">Open Email</button>'
    +'</div>'

    +'</div>'
    +'<p style="font-size:11px;color:var(--ink3);margin-top:10px">You can save the file AND send the email — they work independently.</p>'

    +'</div>'
    +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Close</button></div>'
    +'</div></div>';
}

// ── Receive Package Modal ──────────────────────────────────────────────────────
// Shown when clicking "Receive Package" / "Receive Submission".
// Separate from personal import — only accepts workflow transfer packages.
function buildReceivePackageModal(){
  var role=myRole();
  var title=role==='partner'?'Receive Billing Package':'Receive Timesheet Submission';
  var desc=role==='partner'
    ?'Import a billing review package sent by your billing staff. Entries will be merged into your Approvals queue — your existing data is never deleted.'
    :'Import a timesheet submission package sent by an attorney. Their entries will be merged into your timesheet — your existing data is never deleted.';
  return '<div class="ov"><div class="modal modal-sm" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2 style="display:flex;align-items:center;gap:8px">📥 '+H(title)+'</h2>'
    +'<button class="btn-ic" onclick="A.closeM()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<p style="font-size:13px;color:var(--ink2);line-height:1.6;margin-bottom:20px">'+H(desc)+'</p>'
    +'<div style="border:2px dashed var(--border);border-radius:10px;padding:28px 20px;text-align:center;margin-bottom:16px">'
    +'<div style="font-size:2.5rem;margin-bottom:10px">📦</div>'
    +'<div style="font-weight:600;margin-bottom:6px">Select a package file (.json)</div>'
    +'<div style="font-size:12px;color:var(--ink3);margin-bottom:16px">Sent to you by '+(role==='partner'?'billing staff':'an attorney')+'</div>'
    +'<input type="file" id="rcv-pkg-file" accept=".json" style="display:none" onchange="A.importWorkflowPackage(this)">'
    +'<button class="btn btn-dk" onclick="document.getElementById(\'rcv-pkg-file\').click()">Choose Package File</button>'
    +'</div>'
    +'<div style="font-size:11px;color:var(--ink3);line-height:1.7">'
    +'<strong>Smart merge:</strong> Existing entries, clients and matters are never deleted. New entries are added; matching entries are updated with any changes from the sender.'
    +'</div>'
    +'</div>'
    +'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button></div>'
    +'</div></div>';
}

// ── Billing Staff: Edit ABA Code + Matter Number on Entry ────────────────────
function buildBillingEditModal(){
  var e=ST.entries.find(function(x){return x.id==ST.editId;})||{};
  var cl=_lu.cl[e.clientId]||{};
  var mt=_lu.ma[e.matterId]||{};
  var abaOpts=ABA_TASK_CODES;
  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>🧾 Billing: Enrich Entry</h2>'
    +'<button class="btn-ic" onclick="A.closeF()">'+IC.x+'</button></div>'
    +'<div class="modal-bd">'
    +'<div style="background:var(--bg2);border-radius:8px;padding:12px 14px;margin-bottom:16px">'
    +'<div style="font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);margin-bottom:4px">Time Entry</div>'
    +'<div style="font-weight:500">'+$d(e.date)+' — '+H(cl.name||'?')+(mt.name?' / '+H(mt.name):'')+'</div>'
    +'<div style="font-size:12px;color:var(--ink2)">'+H(e.description||'—')+'</div>'
    +'<div style="font-size:12px;color:var(--ink3)">'+$h(e.hours)+' @ '+$m(e.rate)+' = <strong style="color:var(--green)">'+$m(Number(e.hours)*Number(e.rate))+'</strong>'+(e.createdBy?' · by '+H(e.createdBy):'')+'</div>'
    +'</div>'
    +'<div class="frow"><label style="display:block;font-size:12px;font-weight:600;margin-bottom:5px">ABA / UTBMS Task Code</label>'
    +'<select id="be-aba" style="width:100%;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--white);color:var(--ink)">'
    +abaOpts.map(function(o){return '<option value="'+H(o.v)+'"'+(e.abaCode===o.v?' selected':'')+'>'+H(o.l)+'</option>';}).join('')
    +'</select></div>'
    +(!mt.matterNumber?'<div class="frow" style="margin-top:10px">'+field('Matter Number','be-mn',{ph:'e.g. 2024-001',val:'',hint:'Assign firm matter number to "'+H(mt.name||'this matter')+'"'})+'</div>':'')
    +'<div class="frow" style="margin-top:10px">'+field('Description','be-desc',{type:'textarea',rows:2,val:e.description||''})+'</div>'
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.closeF()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.saveBillingEdit()">'+IC.save+' Save</button>'
    +'</div></div></div>';
}


// === MAIN RENDER
var TABS=[
  {id:'timesheet', lbl:'Timesheet', ic:IC.clock},
  {id:'clients',   lbl:'Clients',   ic:IC.users},
  {id:'matters',   lbl:'Matters',   ic:IC.brief},
  {id:'contacts',  lbl:'Contacts',  ic:IC.doc},
  {id:'analytics', lbl:'Analytics', ic:IC.chart},
  {id:'invoices',  lbl:'Invoices',  ic:IC.invoice},
  {id:'approvals', lbl:'Approvals', ic:IC.shield, roleOnly:'partner'}
];

// === LOOKUP MAPS
// Built once per data-change (guarded by _luDirty flag).
// All views use _lu.cl/ma/ct for O(1) lookups instead of repeated .find().
// _lu.en (entries map) is intentionally NOT rebuilt here — with tens of thousands
// of entries it's expensive and only invoice-review actually needs it.
// Invoice functions call buildEntryLookup() directly when needed.
var _lu={cl:{},ma:{},ct:{},en:{}};
var _luDirty=true;
function markLuDirty(){_luDirty=true;}
function buildLookups(){
  if(!_luDirty) return;
  var cl={},ma={},ct={};
  ST.clients.forEach(function(r){cl[r.id]=r;});
  ST.matters.forEach(function(r){ma[r.id]=r;});
  ST.contacts.forEach(function(r){ct[r.id]=r;});
  _lu.cl=cl; _lu.ma=ma; _lu.ct=ct;
  _luDirty=false;
}
// Lazily rebuild the entries lookup — call only when invoice review needs it.
function buildEntryLookup(){
  var en={};
  ST.entries.forEach(function(r){en[r.id]=r;});
  _lu.en=en;
}

var _dRenderTimer=null;
var _dFocusId='',_dFocusSel=0;
function dRender(){
  var a=document.activeElement;
  if(a&&a.id&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA')){_dFocusId=a.id;_dFocusSel=a.selectionStart||0;}
  clearTimeout(_dRenderTimer);
  _dRenderTimer=setTimeout(function(){
    render();
    if(_dFocusId){var el=document.getElementById(_dFocusId);if(el){el.focus();try{el.setSelectionRange(_dFocusSel,_dFocusSel);}catch(e){}}_dFocusId='';} 
  },200);
}

function render(){
  buildLookups(); // no-op if clean; rebuilds cl/ma/ct maps when markLuDirty() was called
  // applyPrefs() removed: it runs in savePrefs() before every prefs-changing
  // render, and in INIT. Calling it on every render was wasted DOM classList work.
  var views={timesheet:vTimesheet,clients:vClients,matters:vMatters,contacts:vContacts,analytics:vAnalytics,approvals:vApprovals,invoices:vInvoices};
  var role=myRole();
  var visTabs=TABS.filter(function(t){return !t.roleOnly||t.roleOnly===role;});
  var nav=visTabs.map(function(t){
    var pcount=(t.id==='approvals'&&role==='partner')?(ST.entries.filter(function(e){return (e.status||'approved')==='pending';}).length + (ST.invoices||[]).filter(function(i){return i.status==='review';}).length):0;
    var badge=pcount>0?' <span style="background:var(--amber);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px">'+pcount+'</span>':'';
    return '<button class="nav-btn'+(ST.tab===t.id?' on':'')+'" onclick="A.setTab(\''+t.id+'\')">'+t.ic+' '+t.lbl+badge+'</button>';
  }).join('');
  var tabDef=TABS.find(function(t){return t.id===ST.tab;});
  if(tabDef&&tabDef.roleOnly&&tabDef.roleOnly!==role){ST.tab="timesheet";}
  var viewH=(views[ST.tab]||vTimesheet)();
  var overlays='';
  if(ST.modal==='up') overlays=buildUP();
  else if(ST.modal==='ql') overlays=buildQL();
  else if(ST.modal==='help') overlays=buildHelp();
  else if(ST.modal==='settings') overlays=buildSettings();
  else if(ST.modal==='mailpreset') overlays=buildMailPreset();
  else if(ST.modal==='mailph') overlays=buildMailPH();
  else if(ST.modal==='mailsend') overlays=buildMailSend();
  else if(ST.modal==='mailcompose') overlays=buildMailCompose();
  else if(ST.modal==='importData') overlays=buildImportModal();
  else if(ST.modal==='exportModal') overlays=buildExportModal();
  else if(ST.modal==='submitTimesheet') overlays=buildSubmitTimesheetModal();
  else if(ST.modal==='receivePackage') overlays=buildReceivePackageModal();
  else if(ST.modal==='ituser') overlays=buildITUserModal();
  else if(ST.modal==='profileImport') overlays=buildProfileImport();
  else if(ST.modal==='userSelect') overlays=buildITUserSelect();
  else if(ST.modal==='invForm') overlays=buildInvoiceForm();
  else if(ST.modal==='invReview') overlays=buildInvoiceReview();
  else if(ST.modal==='invPrint') overlays=buildInvoicePrint();
  else if(ST.modal==='pref') overlays=buildPartnerReview();
  else if(ST.modal==='workflowImport') overlays=buildWorkflowImportPreview();
  else if(ST.modal==='billingEdit') overlays=buildBillingEditModal();

  var appName=H(ST.prefs.appName||'SixMinuteLog.com');
  var dmCur=ST.prefs.darkMode;
  var dmIcon=dmCur===true?IC.sun:IC.moon;
  var dmTitle=dmCur===null?'Theme: Auto (click for Dark)':dmCur===true?'Theme: Dark (click for Light)':'Theme: Light (click for Auto)';

  document.getElementById('app').innerHTML=
    '<div class="header">'
    +'<div class="header-inner">'
    +'<div class="logo"><span style="font-size:1.4rem">&#9878;&#65039;</span>'
    +'<div><h1>'+appName+'</h1>'+(ST.user?'<div class="logo-sub" style="display:flex;align-items:center;gap:6px">'+H(ST.user.name)+' '+roleBadge(ST.user.role)+'</div>':'')+'</div></div>'
    +'<div class="header-btns">'
    +'<button class="btn btn-gh" onclick="A.openImport()" title="Restore from backup or import CSV data">'+IC.ul+' Restore</button>'
    +'<button class="btn btn-gr" onclick="ST.modal=\'exportModal\';render()" title="Backup or export data as CSV">'+IC.dl+' Backup</button>'
    +'<button class="btn-ic" onclick="A.downloadApp()" title="Download app for offline use" style="font-size:15px">&#128190;</button>'
    +'<button class="btn-ic" onclick="A.togDark()" title="'+dmTitle+'" style="'+( dmCur===true?'color:var(--amber)':dmCur===null?'color:var(--ink3)':'')+'">'+(dmIcon)+'</button>'
    +'<button class="btn-ic" onclick="A.openHelp()" title="Help">'+IC.help+'</button>'
    +'<button class="btn-ic" onclick="A.openSettings()" title="Settings">'+IC.gear+'</button>'
    +'</div></div>'
    +'<div class="nav">'+nav+'</div></div>'
    +'<div class="main">'+viewH+'</div>'
    +overlays;

  document.getElementById('fab').style.display=(isBilling()||(ST.modal&&ST.modal!=='help'&&ST.modal!=='settings'))?'none':'flex';
  if(ST.modal==='up') setTimeout(function(){var el=document.getElementById('up-n');if(el)el.focus();},50);
  if(ST.modal==='mailpreset') setTimeout(_mpPreview,30);
}


// === ACTIONS
var A={
  setTab:function(t){
    ST.tab=t; ST.modal=null; ST.editId=null;
    // Analytics needs complete history for accurate aggregates
    if(t==='analytics'&&ST._entriesMode==='partial'){
      Store.getAllEntries().then(function(entries){
        ST.entries=entries; ST._entriesMode='full'; markLuDirty(); render();
      });
      return;
    }
    render();
  },
  setTsF:function(v){
    ST.tsFilter=v; ST.tsPage=0;
    // "All Time" or "All" filter may need full history — load it from IDB if partial
    if((v==='all')&&ST._entriesMode==='partial'){
      Store.getAllEntries().then(function(entries){
        ST.entries=entries; ST._entriesMode='full'; markLuDirty(); render();
      });
      return;
    }
    render();
  },
  setAnF:function(v){
    ST.anFilter=v;
    // Analytics always needs complete data for accurate aggregates
    if(ST._entriesMode==='partial'){
      Store.getAllEntries().then(function(entries){
        ST.entries=entries; ST._entriesMode='full'; markLuDirty(); render();
      });
      return;
    }
    render();
  },
  // Timesheet extra filters & sort — all reset the page
  setTsClF:function(v){ST.tsClientFilter=v;ST.tsMatterFilter='';ST.tsPage=0;render();},
  setTsMaF:function(v){ST.tsMatterFilter=v;ST.tsPage=0;render();},
  setTsSort:function(v){ST.tsSort=v;ST.tsPage=0;render();},
  // Pagination actions
  tsPrevPage:function(){if(ST.tsPage>0){ST.tsPage--;render();}},
  tsNextPage:function(){ST.tsPage++;render();},
  tsFirstPage:function(){ST.tsPage=0;render();},
  tsLastPage:function(p){ST.tsPage=p;render();},
  clearTsFilters:function(){ST.tsClientFilter='';ST.tsMatterFilter='';ST.tsSort='date-desc';ST.tsPage=0;render();},
  // Clients
  setClSort:function(v){ST.clSort=v;render();},
  setClSearch:function(v){ST.clSearch=v;dRender();},
  // Matters
  setMaSort:function(v){ST.maSort=v;render();},
  setMaClF:function(v){ST.maClientFilter=v;render();},
  setMaSearch:function(v){ST.maSearch=v;dRender();},
  toggleMaGroup:function(){ST.maGroup=!ST.maGroup;render();},
  clearMaFilters:function(){ST.maClientFilter='';ST.maSearch='';ST.maSort='alpha';ST.maGroup=false;render();},
  // Contacts
  setCtSort:function(v){ST.ctSort=v;render();},
  setCtSearch:function(v){ST.ctSearch=v;dRender();},
  setHT:function(t){ST.helpTab=t;render();},
  closeF:function(){ST.modal=null;ST.editId=null;render();},
  closeM:function(){ST.modal=null;render();},

  // == Dark Mode ==
  setDarkMode:function(v){
    // v is null (auto), true (dark), or false (light) — passed from onclick or settings
    ST.prefs.darkMode=v;
    savePrefs(); render();
  },
  togDark:function(){
    // Cycle: auto → dark → light → auto
    var cur=ST.prefs.darkMode;
    ST.prefs.darkMode=cur===null?true:(cur===true?false:null);
    savePrefs(); render();
  },
  togDarkPref:function(v){
    ST.prefs.darkMode=v;
    savePrefs(); render();
  },

  // == Revenue Split Feature ==
  togRevenueSplit:function(v){
    ST.prefs.revenueSplit=v;
    savePrefs();
    toast(v?'Revenue split enabled — Personal Cut % fields are now visible':'Revenue split disabled','ok');
    render();
  },

  // == Layout ==
  setLayout:function(v){
    ST.prefs.layout=v;
    savePrefs(); render();
  },

  // == App Name ==
  saveAppName:function(){
    var n=(document.getElementById('pref-name')||{}).value||'SixMinuteLog.com';
    ST.prefs.appName=n.trim()||'SixMinuteLog.com';
    savePrefs(); toast('App name saved','ok'); render();
  },

  // == Settings Tab ==
  setStab:function(t){
    if(ST.modal==='settings'){syncForm();}
    ST.settingsTab=t; render();
  },

  // == Description Presets ==
  pickDesc:function(fieldId, idx){
    var p=typeof idx==='number'?ST.descPresets[idx]:idx;
    if(!p) return;
    var el=document.getElementById(fieldId);
    if(!el) return;
    el.value=p;
    // Sync to state
    if(fieldId==='ef-desc') ST.ef.description=p;
    if(fieldId==='ql-d'){ ST.ql.description=p; render(); }
    // Animate chip
    var chips=document.querySelectorAll('.desc-chip');
    chips.forEach(function(c){ c.classList.remove('active'); });
  },
  addDesc:function(){
    var inp=document.getElementById('desc-new');
    if(!inp) return;
    var v=inp.value.trim();
    if(!v){ toast('Enter a description first','warn'); return; }
    ST.descPresets.push(v);
    save(); toast('Suggestion added','ok'); render();
    setTimeout(function(){var el=document.getElementById('desc-new');if(el)el.focus();},50);
  },
  delDesc:function(i){
    ST.descPresets.splice(i,1);
    save(); toast('Removed','warn'); render();
  },
  moveDesc:function(i,dir){
    var arr=ST.descPresets;
    var ni=i+dir;
    if(ni<0||ni>=arr.length) return;
    var tmp=arr[i]; arr[i]=arr[ni]; arr[ni]=tmp;
    save(); render();
  },
  editDescPreset:function(i){
    var cur=ST.descPresets[i];
    var nv=prompt('Edit description suggestion:', cur);
    if(nv===null) return;
    nv=nv.trim();
    if(!nv){ toast('Cannot be empty','warn'); return; }
    ST.descPresets[i]=nv;
    save(); toast('Updated','ok'); render();
  },

  // == Mail Presets ==
  openMailPreset:function(idx){
    if(idx!=null){
      var mp=ST.mailPresets[idx];
      ST.mpf=Object.assign({},mp,{editIdx:idx});
    } else {
      ST.mpf={editIdx:null,name:'',purpose:'general',priority:'normal',to:'',cc:'',bcc:'',replyTo:'',subject:'',body:'',signature:''};
    }
    ST.modal='mailpreset'; render();
  },
  editMailPreset:function(idx){ A.openMailPreset(idx); },
  closeMailPreset:function(){
    ST.modal='settings'; ST.settingsTab='email'; render();
  },
  openMailPH:function(idx){
    if(idx!=null&&ST.mailPlaceholders[idx]){
      ST.mphf=Object.assign({},ST.mailPlaceholders[idx],{editIdx:idx,errs:{}});
      if(!ST.mphf.source) ST.mphf.source='static';
    } else {
      ST.mphf={editIdx:null,key:'',label:'',value:'',source:'static',linkedField:'',errs:{}};
    }
    ST.modal='mailph'; render();
  },
  mphSetSource:function(src){
    var key=((document.getElementById('mph-key')||{}).value||ST.mphf.key||'').trim();
    var label=((document.getElementById('mph-label')||{}).value||ST.mphf.label||'').trim();
    var value=((document.getElementById('mph-value')||{}).value||ST.mphf.value||'').trim();
    var lf=((document.getElementById('mph-lf')||{}).value||ST.mphf.linkedField||'');
    ST.mphf=Object.assign({},ST.mphf,{source:src,key:key,label:label,value:value,linkedField:lf,errs:{}});
    render();
  },
  closeMailPH:function(){
    ST.mphf={}; ST.modal='settings'; ST.settingsTab='email'; render();
  },
  saveMailPH:function(){
    var key=((document.getElementById('mph-key')||{}).value||'').trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
    var label=((document.getElementById('mph-label')||{}).value||'').trim();
    var phSrc=ST.mphf.source||'static';
    var value=(phSrc==='static')?((document.getElementById('mph-value')||{}).value||'').trim():'';
    var linkedField=(phSrc==='linked')?((document.getElementById('mph-lf')||{}).value||'').trim():'';
    var errs={};
    if(!key) errs.key='Token key is required.';
    else {
      var reserved=['client','matter','firm','user','initials','date','due_date','invoice_num','amount','entries_count','hours_total','filename','cc_list'];
      if(reserved.indexOf(key)!==-1) errs.key='{'+key+'} is a built-in placeholder and cannot be overridden.';
      // Check duplicate key among custom placeholders (excluding self)
      var editIdx=ST.mphf.editIdx;
      var dupe=ST.mailPlaceholders.some(function(p,i){ return p.key===key && i!==editIdx; });
      if(dupe) errs.key='A custom placeholder with this key already exists.';
    }
    if(!label) errs.label='Label is required.';
    if(phSrc==='linked'&&!linkedField) errs.linkedField='Please choose a field to link.';
    if(Object.keys(errs).length){ ST.mphf.errs=errs; render(); return; }
    var ph={id:uid(),key:key,label:label,source:phSrc,value:value,linkedField:linkedField};
    if(ST.mphf.editIdx!=null){
      ph.id=ST.mailPlaceholders[ST.mphf.editIdx].id||ph.id;
      ST.mailPlaceholders[ST.mphf.editIdx]=ph;
    } else {
      ST.mailPlaceholders.push(ph);
    }
    save(); toast('Placeholder saved','ok');
    ST.mphf={}; ST.modal='settings'; ST.settingsTab='email'; render();
  },
  delMailPH:function(idx){
    if(!confirm('Delete this placeholder?')) return;
    ST.mailPlaceholders.splice(idx,1);
    save(); toast('Placeholder deleted','warn'); render();
  },
  saveMailPreset:function(){
    var name=(document.getElementById('mp-name')||{}).value||'';
    var purpose=(document.getElementById('mp-purpose')||{}).value||'general';
    var priority=(document.getElementById('mp-priority')||{}).value||'normal';
    var to=(document.getElementById('mp-to')||{}).value||'';
    var cc=(document.getElementById('mp-cc')||{}).value||'';
    var bcc=(document.getElementById('mp-bcc')||{}).value||'';
    var replyTo=(document.getElementById('mp-replyto')||{}).value||'';
    var subj=(document.getElementById('mp-subj')||{}).value||'';
    var body=(document.getElementById('mp-body')||{}).value||'';
    var signature=(document.getElementById('mp-sig')||{}).value||'';
    name=name.trim();
    if(!name){ toast('Preset name required','warn'); return; }
    var mp={
      id:ST.mpf.editIdx!=null?ST.mailPresets[ST.mpf.editIdx].id:uid(),
      name:name,purpose:purpose,priority:priority,
      to:to.trim(),cc:cc.trim(),bcc:bcc.trim(),replyTo:replyTo.trim(),
      subject:subj.trim(),body:body.trim(),signature:signature.trim()
    };
    if(ST.mpf.editIdx!=null){
      ST.mailPresets[ST.mpf.editIdx]=mp;
    } else {
      ST.mailPresets.push(mp);
    }
    ST.mpf={};
    save(); toast('Email preset saved','ok');
    ST.modal='settings'; ST.settingsTab='email'; render();
  },
  delMailPreset:function(i){
    if(!confirm('Delete this email preset?')) return;
    ST.mailPresets.splice(i,1);
    save(); toast('Preset deleted','warn'); render();
  },
  dupMailPreset:function(i){
    var mp=ST.mailPresets[i];
    if(!mp) return;
    var copy=Object.assign({},mp,{id:uid(),name:'Copy of '+mp.name});
    ST.mailPresets.push(copy);
    save(); toast('Preset duplicated','ok'); render();
  },
  openMailSend:function(){
    ST.mailCompose={purpose:'general',toEmail:'',clientName:'',invId:null,invNum:null,invAmount:null,entriesCount:null,_preview:false,_draft:null,_mailto:null,_preset:null};
    ST.modal='mailcompose'; render();
  },

  // From the settings email tab "Send via Email" button on a preset card —
  // goes straight to the preview/edit screen (no picker needed, preset already chosen)
  sendMailPreset:function(i){
    var mp=ST.mailPresets[i];
    if(!mp) return;
    ST.mailCompose={purpose:mp.purpose||'general',toEmail:mp.to||'',clientName:'',invId:null,invNum:null,invAmount:null,entriesCount:null,_preview:false,_draft:null,_mailto:null,_preset:null,clientId:null,matterId:null};
    ST.modal='mailcompose';
    A.previewFromCompose(i);
  },

  // Open contextual email compose for an invoice (called from invoice list, print preview, client card)
  emailInvoice:function(invId){
    var inv=ST.invoices.find(function(i){return i.id==invId;});
    if(!inv){ toast('Invoice not found','warn'); return; }
    var cl=ST.clients.find(function(c){return c.id==inv.clientId;})||{};
    var total=0;
    (inv.entryIds||[]).forEach(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;})||{};
      var h=(inv.cuts&&inv.cuts[eid]!=null)?Number(inv.cuts[eid]):Number(e.hours||0);
      total+=h*Number(e.rate||0);
    });
    (inv.mergedEntries||[]).forEach(function(mg){
      total+=Number(mg.hours||0)*Number(mg.rate||0);
    });
    ST.mailCompose={
      purpose:'invoice_client',
      toEmail:cl.email||'',
      clientId:cl.id||null,
      matterId:null,
      clientName:cl.name||'',
      invId:invId,
      invNum:String(inv.number||inv.id),
      invAmount:$m(total),
      entriesCount:null,
      hoursTotal:null,
      _preview:false, _draft:null, _mailto:null, _preset:null
    };
    ST.modal='mailcompose'; render();
  },

  // Open contextual email compose for timesheet entries
  // purpose: 'billing_staff' | 'partner_approval'
  emailEntries:function(purpose){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    if(!fe.length){ toast('No entries to email','warn'); return; }
    var pending=fe.filter(function(e){return (e.status||'approved')==='pending';});
    var target=(purpose==='partner_approval'&&pending.length>0)?pending:fe;
    var toEmail='';
    if(purpose==='billing_staff'){
      var bsCt=ST.contacts.find(function(c){
        return c.email&&c.role&&c.role.toLowerCase().indexOf('billing')!==-1;
      });
      if(bsCt) toEmail=bsCt.email;
    } else if(purpose==='partner_approval'){
      var pCt=ST.contacts.find(function(c){
        return c.email&&c.role&&(c.role.toLowerCase().indexOf('partner')!==-1||c.role.toLowerCase().indexOf('supervising')!==-1);
      });
      if(pCt) toEmail=pCt.email;
    }
    var hrs=target.reduce(function(s,e){return s+Number(e.hours||0);},0);
    var clName=ST.tsClientFilter?(ST.clients.find(function(c){return c.id==ST.tsClientFilter;})||{}).name||'All Clients':'All Clients';
    ST.mailCompose={
      purpose:purpose,
      toEmail:toEmail,
      clientId:ST.tsClientFilter||null,
      matterId:ST.tsMatterFilter||null,
      clientName:clName,
      invId:null,
      invNum:null,
      invAmount:null,
      entriesCount:target.length,
      hoursTotal:hrs.toFixed(1),
      _preview:false, _draft:null, _mailto:null, _preset:null
    };
    ST.modal='mailcompose'; render();
  },

  // Resolve a preset's placeholders and open the preview/edit screen
  previewFromCompose:function(i){
    var mp=ST.mailPresets[i];
    if(!mp){ toast('Preset not found','warn'); return; }
    var ctx=ST.mailCompose||{};
    var map=_phMap(ctx, mp);
    var fullBody=(mp.body||'')+(mp.signature?'\n\n'+(mp.signature):'');
    var toRaw=(mp.to&&mp.to.trim().length)?mp.to:(ctx.toEmail||'');
    var draft={
      to:   toRaw,
      subj: _applyPH(mp.subject||'', map),
      body: _applyPH(fullBody, map),
      cc:   mp.cc||'',
      bcc:  mp.bcc||'',
      replyTo: mp.replyTo||''
    };
    ST.mailCompose._preview=true;
    ST.mailCompose._pvTab='edit';
    ST.mailCompose._draft=draft;
    ST.mailCompose._origDraft=Object.assign({},draft); // snapshot for reset
    ST.mailCompose._preset=mp;
    ST.mailCompose._mailto=null;
    render();
  },

  // Called oninput on any draft field — sync state without full re-render.
  // Only touches fields whose elements are actually in the DOM so that calling
  // this while on the preview tab (where the inputs are absent) never clobbers
  // the draft with empty strings.
  mcLive:function(){
    if(!ST.mailCompose||!ST.mailCompose._draft) return;
    var d=ST.mailCompose._draft;
    [['mc-to','to'],['mc-subj','subj'],['mc-cc','cc'],
     ['mc-bcc','bcc'],['mc-rt','replyTo'],['mc-body','body']].forEach(function(p){
      var el=document.getElementById(p[0]);
      if(el) d[p[1]]=el.value;
    });
  },

  // Switch edit/preview tab — sync fields first so values survive re-render
  mcTab:function(tab){
    A.mcLive();
    ST.mailCompose._pvTab=tab;
    render();
  },

  // Reset draft to original resolved-preset values
  mcReset:function(){
    if(!ST.mailCompose) return;
    ST.mailCompose._draft=Object.assign({},ST.mailCompose._origDraft||{});
    ST.mailCompose._pvTab='edit';
    render();
  },

  // Build mailto from current draft and advance to the open-app screen
  sendFromDraft:function(){
    A.mcLive();
    var ctx=ST.mailCompose||{};
    var d=ctx._draft||{};
    if(!d.to){ toast('Recipient (To) is required','warn'); return; }
    var mailto='mailto:'+d.to  // to-address is path, not a query value — must not be percent-encoded
      +'?subject='+encodeURIComponent(d.subj||'')
      +'&body='+encodeURIComponent(d.body||'');
    if(d.cc)      mailto+='&cc='+encodeURIComponent(d.cc);
    if(d.bcc)     mailto+='&bcc='+encodeURIComponent(d.bcc);
    if(d.replyTo) mailto+='&reply-to='+encodeURIComponent(d.replyTo);
    var a=document.createElement('a'); a.href=mailto; a.click();
  },

  // Navigate back to picker, clearing draft
  backToPicker:function(){
    if(!ST.mailCompose) return;
    ST.mailCompose._preview=false;
    ST.mailCompose._draft=null;
    ST.mailCompose._mailto=null;
    ST.mailCompose._preset=null;
    render();
  },

  // Legacy alias kept for any callers that may exist in presets settings view
  sendFromCompose:function(i){ A.previewFromCompose(i); },



  // Live phone formatting - called oninput, doesn't cause re-render
  livePhone:function(id){
    var el=document.getElementById(id);
    if(!el) return;
    var pos=el.selectionStart;
    var raw=el.value;
    var fmt=fmtPhone(raw);
    el.value=fmt;
    // Adjust cursor: if we added chars before cursor, push it forward
    var diff=fmt.length-raw.length;
    try{el.setSelectionRange(pos+diff,pos+diff);}catch(e){}
  },

  // User
  saveUser:function(){
    var n=(document.getElementById('up-n')||{}).value||'';
    n=n.trim();
    if(!n) return;
    var raw=(document.getElementById('up-i')||{}).value||'';
    var ini=raw.trim()||n.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
    var pct=document.getElementById('up-pct');
    var ownPct=pct?Number(pct.value):100;
    if(isNaN(ownPct)||ownPct<0) ownPct=0;
    if(ownPct>100) ownPct=100;
    var roleEl=document.getElementById('up-role');
    var role=roleEl?roleEl.value:'attorney';
    var rateEl=document.getElementById('up-rate');
    var rate=rateEl?fmtCur(rateEl.value||''):'';
    var salEl=document.getElementById('up-sal');
    var salary=salEl&&salEl.value?fmtCur(salEl.value||''):'';
    var emailEl=document.getElementById('up-e');
    var email=emailEl?emailEl.value.trim():'';
    var phoneEl=document.getElementById('up-p');
    var phone=phoneEl?phoneEl.value.trim():'';
    ST.user={name:n,initials:ini,ownPct:ownPct,role:role,rate:rate?Number(rate):'',salary:salary?Number(salary):'',email:email,phone:phone};
    Store.setMeta('user',ST.user);
    // Sync user into contacts so they appear in Team Member dropdown & Contacts tab
    var existingUserCt=ST.contacts.find(function(c){return c.isUser;});
    var userCtId=existingUserCt?existingUserCt.id:uid();
    var userCt={id:userCtId,name:n,role:role||'',email:email,phone:phone,rate:rate?Number(rate):'',ownPct:ownPct,salary:salary?Number(salary):'',isUser:true,createdBy:n,createdByIni:ini};
    if(existingUserCt){ST.contacts=ST.contacts.map(function(c){return c.isUser?userCt:c;});}
    else{ST.contacts=ST.contacts.concat([userCt]);}
    save();
    var wasFirstRun=ST._splashMode;
    ST._splashMode=false;
    ST.modal=null;
    render();
    toast(wasFirstRun?'Welcome, '+n+'! \ud83c\udf89':'Profile updated');
  },
  chgUser:function(){ST._splashMode=false;ST.modal='up';render();},
  upSelRole:function(role){
    var el=document.getElementById('up-role');
    if(el) el.value=role;
    // Re-render just the role cards to reflect selection without losing typed name/rate
    document.querySelectorAll('.splash-role').forEach(function(el){
      var v=el.getAttribute('onclick')||'';
      el.classList.toggle('sel',v.indexOf("'"+role+"'")!==-1);
    });
  },

  setUserPct:function(v){
    var pct=Number(v);
    if(isNaN(pct)) return;
    pct=Math.max(0,Math.min(100,pct));
    if(!ST.user) ST.user={name:'',initials:'?',ownPct:pct};
    else ST.user.ownPct=pct;
    Store.setMeta('user',ST.user);
    // Re-render only analytics section without full re-render (no flicker)
    var an=document.querySelector('.main');
    if(an&&ST.tab==='analytics') an.innerHTML=vAnalytics();
  },

  // Entry form
  openEF:function(){
    if(isBilling()){toast('View-only mode: cannot add entries','warn');return;}
    ST.ef={date:today(),clientId:'',matterId:'',contactId:'',hours:'',rate:'',description:'',abaCode:'',errs:{}};
    ST.modal='ef'; render();
    var el=document.getElementById('ef'); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
  },
  editEnt:function(id){
    var e=ST.entries.find(function(x){return x.id==id;}); if(!e) return;
    if(isBilling()){toast('View-only mode: cannot edit entries','warn');return;}
    var me=ST.user?ST.user.name:'';
    var entSt=e.status||'approved';
    if(myRole()==='attorney'&&(e.createdBy!==me||entSt!=='pending')){toast(entSt==='approved'?'Cannot edit approved entries':'Cannot edit rejected entries','warn');return;}
    ST.editId=id; ST.ef=Object.assign({abaCode:''},e,{errs:{}}); ST.modal='ef';
    render(); var el=document.getElementById('ef'); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'});
  },
  saveEnt:function(){
    // Sync all typed values first
    var f=ST.ef;
    f.date=g('ef-d'); f.clientId=g('ef-cl'); f.matterId=g('ef-ma'); f.contactId=g('ef-ct');
    f.hours=g('ef-h'); f.rate=fmtCur(g('ef-r')||''); f.description=g('ef-desc'); f.abaCode=g('ef-aba')||'';
    var errs={};
    if(!f.date) errs.d='Required';
    if(!f.clientId) errs.cl='Select a client';
    if(!f.hours||isNaN(Number(f.hours))||Number(f.hours)<=0) errs.h='Enter hours';
    if(!f.rate||Number(f.rate)<=0) errs.r='Enter rate';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    // Keep precise hours (finalize feature will round when grouping)
    var hrs=Number(f.hours);
    var entRole=myRole();
    var existingEntry=ST.editId?ST.entries.find(function(e){return e.id==ST.editId;}):null;
    // Preserve status when editing; set initial status based on role for new entries
    var entStatus=existingEntry?existingEntry.status:(entRole==='partner'?'approved':'pending');
    var entry={id:ST.editId||uid(),date:f.date,
      clientId:Number(f.clientId),matterId:Number(f.matterId)||'',contactId:Number(f.contactId)||'',
      hours:hrs,rate:Number(f.rate),description:f.description||'',abaCode:f.abaCode||'',
      createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?',
      status:entStatus,finalized:existingEntry?existingEntry.finalized:false};
    if(ST.editId){ST.entries=ST.entries.map(function(e){return e.id==ST.editId?entry:e;});toast('Entry updated');}
    else{ST.entries=ST.entries.concat([entry]);toast(entRole==='attorney'?'Entry submitted for approval':'Entry added');}
    saveOne('entries',entry); A.closeF();
  },
  delEnt:function(id){if(!confirm('Delete this time entry?'))return;ST.entries=ST.entries.filter(function(e){return e.id!=id;});delOne('entries',id);toast('Deleted','warn');render();},

  // Finalize entries - groups identical entries for each day with total rounded hours
  finalizeEntries:function(){
    if(isBilling()){toast('View-only mode: cannot finalize entries','warn');return;}
    var unfinalized=ST.entries.filter(function(e){return !e.finalized;});
    if(unfinalized.length===0){toast('No entries to finalize','warn');return;}
    if(!confirm('Finalize entries? This will group identical entries by day (same client, matter, and description) with rounded total hours. Finalized entries cannot be unfinalized.'))return;
    
    // Group ONLY by: date + client + matter + description
    // This means entries with same work but different hours, rates, contacts, etc. will be grouped
    var groups={};
    unfinalized.forEach(function(e){
      var key=[e.date,e.clientId,e.matterId||'',e.description||''].join('|');
      if(!groups[key])groups[key]=[];
      groups[key].push(e);
    });
    
    // For each group, combine entries
    var finalized=0;
    var newEntries=[];
    Object.keys(groups).forEach(function(key){
      var group=groups[key];
      if(group.length===1){
        // Single entry - just mark as finalized and round hours
        var e=group[0];
        e.hours=Math.round(Number(e.hours)*10)/10;
        e.finalized=true;
        newEntries.push(e);
        finalized++;
      } else {
        // Multiple entries - combine into one
        // Use first entry as template, sum hours, take average rate if rates differ
        var first=group[0];
        var totalHours=group.reduce(function(sum,e){return sum+Number(e.hours);},0);
        var roundedHours=Math.round(totalHours*10)/10;
        
        // Use the most common rate, or first rate if all different
        var rates=group.map(function(e){return e.rate;});
        var rate=rates[0];
        
        var combined=Object.assign({},first,{
          hours:roundedHours,
          rate:Number(rate),
          finalized:true,
          combinedFrom:group.map(function(e){return e.id;})
        });
        newEntries.push(combined);
        finalized+=group.length;
      }
    });
    
    // Keep all already-finalized entries
    var alreadyFinalized=ST.entries.filter(function(e){return e.finalized;});
    ST.entries=alreadyFinalized.concat(newEntries);
    
    save(); 
    toast('Finalized '+finalized+' entr'+(finalized===1?'y':'ies')+' into '+newEntries.length+' final entr'+(newEntries.length===1?'y':'ies'));
    render();
  },

  // Approval actions (partner only)
  approveEnt:function(id){
    if(!isPartner()){toast('Only partners can approve entries','warn');return;}
    var updated;
    ST.entries=ST.entries.map(function(e){
      if(e.id==id){updated=Object.assign({},e,{status:'approved',approvedBy:ST.user?ST.user.name:'',approvedAt:today()});return updated;}
      return e;
    });
    if(updated) saveOne('entries',updated);
    toast('Entry approved'); render();
  },
  rejectEnt:function(id){
    if(!isPartner()){toast('Only partners can reject entries','warn');return;}
    if(!confirm('Reject this entry? The attorney will be notified via status.')) return;
    var updated;
    ST.entries=ST.entries.map(function(e){
      if(e.id==id){updated=Object.assign({},e,{status:'rejected',approvedBy:ST.user?ST.user.name:'',approvedAt:today()});return updated;}
      return e;
    });
    if(updated) saveOne('entries',updated);
    toast('Entry rejected','warn'); render();
  },

  // Partner Review Entry: open modal with edit + comment fields
  openPartnerReview:function(id){
    if(!isPartner()){toast('Only partners can review entries','warn');return;}
    var e=ST.entries.find(function(x){return x.id==id;});
    if(!e){toast('Entry not found','err');return;}
    ST.pref={
      entryId:id,
      hours:String(e.hours),
      rate:String(e.rate||''),
      description:e.description||'',
      comment:e.partnerComment||'',
      showOnInvoice:!!e.showCommentOnInvoice,
      errs:{}
    };
    ST.modal='pref'; render();
  },

  // Sync live changes from partner review form inputs
  syncPartnerReview:function(){
    var f=ST.pref;
    var h=document.getElementById('pref-h'); if(h)f.hours=h.value;
    var r=document.getElementById('pref-r'); if(r)f.rate=r.value;
    var d=document.getElementById('pref-desc'); if(d)f.description=d.value;
    var c=document.getElementById('pref-cmt'); if(c)f.comment=c.value;
    var inv=document.getElementById('pref-inv'); if(inv)f.showOnInvoice=inv.checked;
  },

  partnerReviewSave:function(andApprove){
    if(!isPartner()){toast('Only partners can review entries','warn');return;}
    A.syncPartnerReview();
    var f=ST.pref;
    var e=ST.entries.find(function(x){return x.id==f.entryId;});
    if(!e) return;
    var newH=Math.round(parseFloat(f.hours)*10)/10;
    if(isNaN(newH)||newH<=0){toast('Hours must be a positive number','err');return;}
    var newR=parseFloat(f.rate);
    if(isNaN(newR)||newR<0){toast('Rate must be a valid number','err');return;}
    var origH=Number(e.hours);
    var origR=Number(e.rate||0);
    var origD=e.description||'';
    var hoursEdited=(newH!==origH);
    var anyEdited=hoursEdited||(newR!==origR)||((f.description||'')!==origD);
    // Preserve the original submitted hours for invoice display (strikethrough)
    // Use existing submittedHours if already set (so we always track the attorney's original)
    var submittedHours=e.submittedHours!=null?e.submittedHours:(hoursEdited?origH:null);
    var updates={
      hours:String(newH),
      rate:String(newR),
      description:f.description||e.description,
      partnerComment:f.comment||'',
      showCommentOnInvoice:!!f.showOnInvoice,
      partnerEdited:anyEdited,
      submittedHours:submittedHours,
      approvedBy:ST.user?ST.user.name:''
    };
    if(andApprove) Object.assign(updates,{status:'approved',approvedAt:today()});
    ST.entries=ST.entries.map(function(x){return x.id==f.entryId?Object.assign({},x,updates):x;});
    // Keep inv.cuts in sync: any invoice containing this entry must reflect the
    // partner-edited hours, otherwise cuts[eid] would silently override e.hours.
    if(hoursEdited){
      ST.invoices=(ST.invoices||[]).map(function(inv){
        if(!(inv.entryIds||[]).some(function(id){return id==f.entryId;})) return inv;
        var cuts=Object.assign({},inv.cuts||{});
        cuts[f.entryId]=newH;
        var updated2=Object.assign({},inv,{cuts:cuts});
        saveOne('invoices',updated2);
        return updated2;
      });
    }
    var savedEntry=ST.entries.find(function(x){return x.id==f.entryId;});
    if(savedEntry) saveOne('entries',savedEntry);
    toast(andApprove?(anyEdited?'Approved with edits':'Entry approved'):'Changes saved',(andApprove?'ok':'ok'));
    A.closeM();
    render();
  },

  partnerReviewReject:function(){
    if(!isPartner()){toast('Only partners can reject entries','warn');return;}
    A.syncPartnerReview();    var f=ST.pref;
    if(!confirm('Reject this entry? The attorney will see the rejection and any comments you left.')) return;
    var updates={
      status:'rejected',
      approvedBy:ST.user?ST.user.name:'',
      approvedAt:today(),
      partnerComment:f.comment||'',
      showCommentOnInvoice:!!f.showOnInvoice,
      partnerEdited:false
    };
    // Also apply any hour/rate/desc edits even on reject (for tracking)
    var newH=Math.round(parseFloat(f.hours)*10)/10;
    var newR=parseFloat(f.rate);
    if(!isNaN(newH)&&newH>0) updates.hours=String(newH);
    if(!isNaN(newR)&&newR>=0) updates.rate=String(newR);
    if(f.description) updates.description=f.description;
    ST.entries=ST.entries.map(function(x){return x.id==f.entryId?Object.assign({},x,updates):x;});
    var savedEntry2=ST.entries.find(function(x){return x.id==f.entryId;});
    if(savedEntry2) saveOne('entries',savedEntry2);
    toast('Entry rejected','warn'); A.closeM(); render();
  },
  approveAll:function(){
    if(!isPartner()){toast('Only partners can approve entries','warn');return;}
    var pending=ST.entries.filter(function(e){return (e.status||'approved')==='pending';});
    if(!pending.length){toast('No pending entries to approve','warn');return;}
    if(!confirm('Approve all '+pending.length+' pending entries?')) return;
    var now=today();
    var approver=ST.user?ST.user.name:'';
    ST.entries=ST.entries.map(function(e){
      return (e.status||'approved')==='pending'?Object.assign({},e,{status:'approved',approvedBy:approver,approvedAt:now}):e;
    });
    save(); toast('Approved '+pending.length+' entr'+(pending.length===1?'y':'ies')); render();
  },

  // ── Workflow Transfer Package Export ────────────────────────────────────────
  // Attorney: export their own pending/visible entries as a submission package
  // ── Submit Timesheet / Send to Partner / Return to Billing ─────────────────
  openSubmitTimesheet:function(){ ST.modal='submitTimesheet'; render(); },
  openReceivePackage:function(){ ST.modal='receivePackage'; render(); },

  // Called from the Submit modal: save the package file
  doSubmitSaveFile:function(pkgType){
    var role=myRole();
    var me=ST.user?ST.user.name:'';
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var entries;
    if(role==='attorney') entries=fe.filter(function(e){return e.createdBy===me;});
    else if(role==='partner') entries=fe.filter(function(e){return (e.status||'pending')==='approved';});
    else entries=fe;
    if(!entries.length){toast('No entries to export in current view','warn');return;}
    var note=g('st-note')||'';
    var fname=_exportWorkflowPackage(pkgType||'attorney_submission', entries, {note:note});
    toast('Saved '+entries.length+' entries \u2192 '+fname);
  },

  // Called from the Submit modal: open email compose
  doSubmitEmail:function(purpose){
    var toVal=g('st-email')||'';
    var note=g('st-note')||'';
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var me=ST.user?ST.user.name:'';
    var role=myRole();
    var target;
    if(role==='attorney') target=fe.filter(function(e){return e.createdBy===me;});
    else if(role==='partner') target=fe.filter(function(e){return (e.status||'pending')==='approved';});
    else target=fe;
    var hrs=target.reduce(function(s,e){return s+Number(e.hours||0);},0);
    var clName=ST.tsClientFilter?(ST.clients.find(function(c){return c.id==ST.tsClientFilter;})||{}).name||'All Clients':'All Clients';
    ST.mailCompose={
      purpose:purpose,
      toEmail:toVal,
      clientId:ST.tsClientFilter||null,
      matterId:ST.tsMatterFilter||null,
      clientName:clName,
      invId:null, invNum:null, invAmount:null,
      entriesCount:target.length,
      hoursTotal:hrs.toFixed(1),
      note:note,
      _preview:false, _draft:null, _mailto:null, _preset:null
    };
    ST.modal='mailcompose'; render();
  },

  exportAttorneySubmission:function(){
    var me=ST.user?ST.user.name:'';
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var myEntries=myRole()==='attorney'?fe.filter(function(e){return e.createdBy===me;}):fe;
    if(!myEntries.length){toast('No entries to export in current view','warn');return;}
    var fname=_exportWorkflowPackage('attorney_submission', myEntries);
    toast('Exported '+myEntries.length+' entries \u2192 '+fname);
  },
  exportBillingReview:function(){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    if(!fe.length){toast('No entries to export in current view','warn');return;}
    var fname=_exportWorkflowPackage('billing_review', fe);
    toast('Exported '+fe.length+' entries for partner review \u2192 '+fname);
  },
  exportPartnerApproval:function(){
    var fe=filterEnt(ST.entries,ST.tsFilter);
    if(ST.tsClientFilter) fe=fe.filter(function(e){return e.clientId==ST.tsClientFilter;});
    if(ST.tsMatterFilter) fe=fe.filter(function(e){return e.matterId==ST.tsMatterFilter;});
    var approved=fe.filter(function(e){return (e.status||'approved')==='approved';});
    if(!approved.length){toast('No approved entries in current view','warn');return;}
    var fname=_exportWorkflowPackage('partner_approval', approved);
    toast('Exported '+approved.length+' approved entries \u2192 '+fname);
  },

  // ── Workflow Transfer Package Import ────────────────────────────────────────
  importWorkflowPackage:function(inp){
    var file=inp.files[0]; if(!file) return;
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var pkg=JSON.parse(ev.target.result);
        if(!pkg||!pkg._type||!pkg._version){
          // Try regular JSON import fallback
          if(pkg&&pkg._version===1){A.importJSON({files:[file]});return;}
          toast('Not a valid workflow package or backup file','err'); return;
        }
        ST._pendingWorkflowPkg=pkg;
        ST.modal='workflowImport';
        render();
      }catch(e){toast('Failed to read file','err');console.error(e);}
    };
    reader.readAsText(file,'UTF-8'); inp.value='';
  },
  confirmWorkflowImport:function(){
    var pkg=ST._pendingWorkflowPkg;
    if(!pkg){toast('No package to import','err');return;}
    var msg=_importWorkflowPackage(pkg);
    ST._pendingWorkflowPkg=null;
    ST.modal=null;
    render();
    toast(msg);
  },
  cancelWorkflowImport:function(){
    ST._pendingWorkflowPkg=null;
    ST.modal=null;
    render();
  },
  openWorkflowExport:function(){ ST.modal='submitTimesheet'; render(); },

  // Billing staff: edit ABA code on an existing entry
  billingEditEntry:function(id){
    if(!isBilling()){toast('This action is for billing staff','warn');return;}
    var e=ST.entries.find(function(x){return x.id==id;}); if(!e) return;
    ST.editId=id;
    ST.ef=Object.assign({abaCode:''},e,{errs:{}});
    ST.modal='billingEdit'; render();
  },
  saveBillingEdit:function(){
    var id=ST.editId;
    var e=ST.entries.find(function(x){return x.id==id;}); if(!e) return;
    var aba=g('be-aba')||'';
    var mn=g('be-mn')||'';
    var desc=g('be-desc')||e.description||'';
    var updated=Object.assign({},e,{abaCode:aba,description:desc});
    ST.entries=ST.entries.map(function(x){return x.id==id?updated:x;});
    saveOne('entries',updated);
    // Also update matter number if provided
    if(mn&&e.matterId){
      var mt=ST.matters.find(function(m){return m.id==e.matterId;});
      if(mt&&!mt.matterNumber){
        var updatedMt=Object.assign({},mt,{matterNumber:mn});
        ST.matters=ST.matters.map(function(m){return m.id==e.matterId?updatedMt:m;});
        saveOne('matters',updatedMt);
      }
    }
    toast('Entry updated'); A.closeF();
  },


  // Client form
  openCF:function(){ST.editId=null;ST.cf={name:'',email:'',phone:'',rate:'',contactIds:[],clientPeople:[],newPerson:{},errs:{}};ST.modal='cf';render();},
  editCl:function(id){var c=ST.clients.find(function(x){return x.id==id;});if(!c)return;ST.editId=id;
    // Migrate legacy contactId to contactIds array
    var cids=c.contactIds&&c.contactIds.length?c.contactIds:(c.contactId?[Number(c.contactId)]:[]);
    ST.cf=Object.assign({},c,{contactIds:cids,clientPeople:c.clientPeople||[],newPerson:{},errs:{}});ST.modal='cf';render();},
  cfTogCt:function(cb){
    var id=Number(cb.getAttribute('data-cf-ct'));
    var ids=ST.cf.contactIds||[];
    if(cb.checked){if(!ids.some(function(x){return x==id;}))ST.cf.contactIds=ids.concat([id]);}
    else{ST.cf.contactIds=ids.filter(function(x){return x!=id;});}
  },
  cfRemCt:function(id){
    syncForm();
    ST.cf.contactIds=(ST.cf.contactIds||[]).filter(function(x){return x!=id;});
    render();
  },
  cfAddPerson:function(){
    syncForm();
    var n=(document.getElementById('cf-pn')||{}).value||'';
    n=n.trim();
    if(!n){toast('Enter a name','err');return;}
    var ro=(document.getElementById('cf-pro')||{}).value||'';
    var em=(document.getElementById('cf-pe')||{}).value||'';
    var ph=(document.getElementById('cf-pp')||{}).value||'';
    ST.cf.clientPeople=(ST.cf.clientPeople||[]).concat([{id:uid(),name:n,role:ro.trim(),email:em.trim(),phone:ph.trim()}]);
    ST.cf.newPerson={};
    render();
    var el=document.getElementById('cf-pn'); if(el){el.focus();}
  },
  cfRemPerson:function(i){
    syncForm();
    ST.cf.clientPeople=(ST.cf.clientPeople||[]).filter(function(_,idx){return idx!==i;});
    render();
  },
  saveCl:function(){
    var f=ST.cf;
    f.name=g('cf-n'); f.email=g('cf-e'); f.phone=g('cf-p'); f.rate=fmtCur(g('cf-r')||'');
    // Sync new-person draft fields
    var pn=g('cf-pn')||''; if(pn.trim())f.newPerson={name:pn,role:g('cf-pro')||'',email:g('cf-pe')||'',phone:g('cf-pp')||''};
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(f.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email)) errs.e='Invalid email';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var c={id:ST.editId||uid(),name:f.name.trim(),email:f.email||'',phone:f.phone||'',rate:f.rate?Number(f.rate):'',contactIds:f.contactIds||[],clientPeople:(f.clientPeople||[]).map(function(p){return p.id?p:Object.assign({id:uid()},p);}),createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    if(ST.editId){ST.clients=ST.clients.map(function(x){return x.id==ST.editId?c:x;});toast('Client updated');}
    else{ST.clients=ST.clients.concat([c]);toast('Client added');}
    saveOne('clients',c); A.closeF();
  },
  delCl:function(id){if(!confirm('Delete this client?'))return;ST.clients=ST.clients.filter(function(c){return c.id!=id;});delOne('clients',id);toast('Deleted','warn');render();},

  // Matter form
  openMF:function(){ST.editId=null;ST.mf={name:'',clientId:'',description:'',rate:'',contactId:'',matterNumber:'',linkedClientPeopleIds:[],errs:{}};ST.modal='mf';render();},
  editMa:function(id){var m=ST.matters.find(function(x){return x.id==id;});if(!m)return;ST.editId=id;ST.mf=Object.assign({},m,{matterNumber:m.matterNumber||'',linkedClientPeopleIds:m.linkedClientPeopleIds||[],errs:{}});ST.modal='mf';render();},
  saveMa:function(){
    var f=ST.mf;
    f.name=g('mf-n'); f.clientId=g('mf-cl'); f.description=g('mf-desc'); f.rate=fmtCur(g('mf-r')||''); f.contactId=g('mf-ct'); f.matterNumber=g('mf-num')||'';
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(!f.clientId) errs.cl='Select a client';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var m={id:ST.editId||uid(),name:f.name.trim(),clientId:Number(f.clientId),matterNumber:f.matterNumber.trim(),description:f.description||'',rate:f.rate?Number(f.rate):'',contactId:Number(f.contactId)||'',linkedClientPeopleIds:f.linkedClientPeopleIds||[],createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    if(ST.editId){ST.matters=ST.matters.map(function(x){return x.id==ST.editId?m:x;});toast('Matter updated');}
    else{ST.matters=ST.matters.concat([m]);toast('Matter added');}
    saveOne('matters',m); A.closeF();
  },
  delMa:function(id){if(!confirm('Delete this matter?'))return;ST.matters=ST.matters.filter(function(m){return m.id!=id;});delOne('matters',id);toast('Deleted','warn');render();},
  mfToggleClientPerson:function(personId){
    syncForm();
    var ids=ST.mf.linkedClientPeopleIds||[];
    var pid=Number(personId);
    if(ids.some(function(x){return x==pid;})){ST.mf.linkedClientPeopleIds=ids.filter(function(x){return x!=pid;});}
    else{ST.mf.linkedClientPeopleIds=ids.concat([pid]);}
    render();
  },

  // Contact form
  openCTF:function(){ST.editId=null;ST.ctf={name:'',role:'',email:'',phone:'',rate:'',ownPct:100,salary:'',errs:{}};ST.modal='ctf';render();},
  editCt:function(id){var c=ST.contacts.find(function(x){return x.id==id;});if(!c)return;if(c.isUser){ST._splashMode=false;ST.modal='up';render();return;}ST.editId=id;ST.ctf=Object.assign({},c,{errs:{}});ST.modal='ctf';render();},
  saveCt:function(){
    var f=ST.ctf;
    f.name=g('ctf-n'); f.role=g('ctf-ro'); f.email=g('ctf-e'); f.phone=g('ctf-p'); f.rate=fmtCur(g('ctf-rate')||'');
    var opv=g('ctf-op'); f.ownPct=opv!==''?Math.min(100,Math.max(0,Number(opv))):100;
    var salv=g('ctf-sal'); f.salary=salv&&salv!==''?fmtCur(salv):'';
    var errs={};
    if(!f.name||!f.name.trim()) errs.n='Name required';
    if(f.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email)) errs.e='Invalid email';
    f.errs=errs;
    if(Object.keys(errs).length){render();return;}
    var existing=ST.editId?ST.contacts.find(function(x){return x.id==ST.editId;}):null;
    var c={id:ST.editId||uid(),name:f.name.trim(),role:f.role||'',email:f.email||'',phone:f.phone||'',rate:f.rate?Number(f.rate):'',ownPct:f.ownPct,salary:f.salary?Number(f.salary):'',createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?'};
    // Preserve isUser flag if this contact is the logged-in user
    if(existing&&existing.isUser) c.isUser=true;
    if(ST.editId){ST.contacts=ST.contacts.map(function(x){return x.id==ST.editId?c:x;});toast('Contact updated');}
    else{ST.contacts=ST.contacts.concat([c]);toast('Contact added');}
    // If this is the user's own contact, keep ST.user in sync
    if(c.isUser&&ST.user){
      var oldIni=ST.user.initials||'';
      // Auto-regen initials if name changed and initials were auto-generated (matching old name pattern)
      var autoIni=ST.user.name?ST.user.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase():'';
      var newAutoIni=c.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
      var ini2=(oldIni===autoIni)?newAutoIni:oldIni;
      ST.user=Object.assign({},ST.user,{name:c.name,role:c.role,email:c.email,phone:c.phone,rate:c.rate,ownPct:c.ownPct,salary:c.salary,initials:ini2});
      Store.setMeta('user',ST.user);
    }
    saveOne('contacts',c); A.closeF();
  },
  delCt:function(id){if(!confirm('Delete this contact?'))return;ST.contacts=ST.contacts.filter(function(c){return c.id!=id;});delOne('contacts',id);toast('Deleted','warn');render();},

  // Quick Log
  openQL:function(){if(isBilling()){toast('View-only mode: cannot log entries','warn');return;}ST.modal='ql';ST.ql={clientId:'',matterId:'',hours:'',rate:'',description:'',addToId:'',rawMs:null};render();},
  closeQL:function(){stopTmr();ST.modal=null;render();},
  qlSet:function(k,v){ST.ql[k]=v;},
  qlCl:function(v){
    syncForm();
    ST.ql.clientId=v; ST.ql.matterId='';
    var r=autoRate(v,'','');
    if(r&&!ST.ql.rate) ST.ql.rate=String(r);
    render();
  },
  qlPickEntry:function(id){
    syncForm();
    var id2=String(id);
    if(!id2){
      ST.ql.addToId='';
      render();
      return;
    }
    var e=ST.entries.find(function(x){return String(x.id)===id2;});
    if(!e) return;
    ST.ql.addToId=id2;
    ST.ql.clientId=String(e.clientId||'');
    ST.ql.matterId=String(e.matterId||'');
    ST.ql.rate=String(e.rate||'');
    ST.ql.description=e.description||'';
    render();
  },
  saveQL:function(){
    syncForm();
    var f=ST.ql;
    if(!f.clientId||!f.hours||!f.rate){toast('Fill in client, hours and rate','err');return;}
    stopTmr();
    var hrs=Number(f.hours);
    var qlRole=myRole();
    var qlStatus=qlRole==='partner'?'approved':'pending';
    // === ADD TO EXISTING ENTRY ===
    if(f.addToId){
      var target=ST.entries.find(function(x){return String(x.id)===String(f.addToId);});
      if(target){
        var newHrs=Math.round((Number(target.hours)+hrs)*10000)/10000;
        var newRawMs=(target.rawMs!=null&&f.rawMs!=null)?(target.rawMs+f.rawMs):null;
        var updatedTarget;
        ST.entries=ST.entries.map(function(x){
          if(String(x.id)===String(f.addToId)){
            updatedTarget=Object.assign({},x,{hours:newHrs,rawMs:newRawMs});
            return updatedTarget;
          }
          return x;
        });
        if(updatedTarget) saveOne('entries',updatedTarget);
        ST.modal=null; ST.tab='timesheet';
        toast('+'+hrs.toFixed(1)+'h added \u2192 '+newHrs.toFixed(1)+'h total &#9889;');
        render();
        return;
      }
    }
    // === NEW ENTRY ===
    var entry={id:uid(),date:today(),clientId:Number(f.clientId),matterId:Number(f.matterId)||'',contactId:'',
      hours:hrs,rawMs:(f.rawMs!=null?f.rawMs:null),rate:Number(f.rate),description:f.description||'',
      createdBy:ST.user?ST.user.name:'',createdByIni:ST.user?ST.user.initials:'?',
      status:qlStatus,finalized:false};
    ST.entries=ST.entries.concat([entry]);
    saveOne('entries',entry); ST.modal=null; ST.tab='timesheet'; toast(qlRole==='attorney'?'Entry submitted for approval &#9889;':'Entry logged! &#9889;'); render();
  },

  // Timer
  togTmr:function(){
    if(ST.tmrOn){
      stopTmr();
      var hrs=ST.tmrMs/3600000;
      // Preserve full precision in hours field; no forced minimum — user can review and adjust
      ST.ql.hours=String(Math.round(hrs*10000)/10000);
      ST.ql.rawMs=ST.tmrMs; // carry exact ms to save
    } else {
      ST.tmrStart=Date.now();
      ST.tmrOn=true;
      ST.tmrIv=setInterval(function(){
        var el=document.getElementById('ql-t'); if(!el){stopTmr();return;}
        var ms=Date.now()-ST.tmrStart+ST.tmrMs;
        el.textContent=String(Math.floor(ms/3600000)).padStart(2,'0')+':'+String(Math.floor((ms%3600000)/60000)).padStart(2,'0')+':'+String(Math.floor((ms%60000)/1000)).padStart(2,'0');
        el.className='timer-num timer-on';
      },500);
    }
    render();
  },
  rstTmr:function(){stopTmr();ST.tmrMs=0;ST.tmrStart=0;ST.ql.hours='';ST.ql.rawMs=null;render();},

  // Help / Settings
  openHelp:function(){ST.modal='help';render();},
  openSettings:function(){ST.modal='settings';render();},
  applyPreset:function(k){
    var p={
      full: {te:true,cl:true,ma:true,co:true,su:true,split:false,tc_date:true,tc_client:true,tc_matter:true,tc_team:true,tc_desc:true,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false},
      billing:{te:true,cl:false,ma:false,co:false,su:true,split:false,tc_date:true,tc_client:true,tc_matter:true,tc_team:false,tc_desc:true,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false},
      dirs: {te:false,cl:true,ma:true,co:true,su:false,split:false},
      sum:  {te:false,cl:false,ma:false,co:false,su:true,split:false},
      wsplit:{te:true,cl:true,ma:false,co:true,su:true,split:true,tc_date:true,tc_client:true,tc_matter:true,tc_team:true,tc_desc:false,tc_hours:true,tc_rate:true,tc_amount:true,tc_by:false},
      tsplit:{te:true,cl:false,ma:false,co:false,su:true,split:true,tc_date:true,tc_client:true,tc_matter:false,tc_team:true,tc_desc:false,tc_hours:true,tc_rate:false,tc_amount:true,tc_by:false}
    };
    if(p[k]){
      ST.settings=Object.assign({},ST.settings,p[k]);
      render();
    }
  },
  togExp:function(k,v){
    syncForm();
    ST.settings[k]=v;
    render();
  },
  setExpDate:function(k,v){ST.settings[k]=v;render();},

  // Reset
  resetAll:function(){
    if(!confirm('Delete ALL data? This cannot be undone!\nExport a backup first.')) return;
    if(!confirm('Are you absolutely sure?')) return;
    ST.clients=[]; ST.matters=[]; ST.entries=[]; ST.contacts=[]; ST.invoices=[];
    ST._entriesMode='full'; ST._totalEntryCount=0; markLuDirty();
    Store.clearData();
    ST.user=null; ST._splashMode=true; ST.modal='profileImport'; toast('All data reset','warn'); render();
  },


  // ─ Download helper (works without URL.createObjectURL) ─
  _dlData:function(content, fname, mime){
    // Blob+createObjectURL: reliable for large files, no encoding corruption.
    // UTF-8 BOM added for CSV so Excel opens with correct encoding.
    var bom=(mime==='text/csv')?'\uFEFF':'';
    var blob=new Blob([bom+content],{type:mime+';charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download=fname; a.style.display='none';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},2000);
  },

  // Export modal - now opens workflow-aware export modal
  openExportModal:function(){ ST.modal='exportModal'; render(); },
  downloadApp:function(){
    var html='<!DOCTYPE html>\n'+document.documentElement.outerHTML;
    var blob=new Blob([html],{type:'text/html;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download='SixMinuteLog_'+today().replace(/-/g,'')+'.html';
    document.body.appendChild(a);a.click();
    document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},2000);
    toast('App downloaded \u2014 open the file in any browser to use offline','ok');
  },

  // Export
  exportCSV:function(){
    var s=ST.settings;
    var Q=function(v){return '"'+String(v||'').replace(/"/g,'""')+'"';};
    var R=function(a){return a.map(Q).join(',')+'\n';};
    var csv='';

    // Filter entries by date range if set
    var ents=ST.entries;
    if(s.expFrom) ents=ents.filter(function(e){return e.date>=s.expFrom;});
    if(s.expTo)   ents=ents.filter(function(e){return e.date<=s.expTo;});

    if(s.te&&ents.length){
      // Build column list
      var cols=[];
      if(s.tc_date)   cols.push('Date');
      if(s.tc_client) cols.push('Client');
      if(s.tc_matter) cols.push('Matter');
      if(s.tc_team)   cols.push('Team Member');
      if(s.tc_desc)   cols.push('Description');
      if(s.tc_hours)  cols.push('Hours');
      if(s.tc_rate)   cols.push('Rate');
      if(s.tc_amount) cols.push('Amount');
      if(s.tc_by)     cols.push('Created By');

      if(s.te_group){
        // Group by client
        var clIds=[...new Set(ents.map(function(e){return e.clientId;}))];
        clIds.forEach(function(cid){
          var cl=ST.clients.find(function(c){return c.id==cid;});
          var clName=cl?cl.name:'Unknown';
          csv+='TIME ENTRIES - '+clName+'\n'+R(cols);
          ents.filter(function(e){return e.clientId==cid;})
            .sort(function(a,b){return new Date(a.date)-new Date(b.date);})
            .forEach(function(e){csv+=R(buildEntRow(e,s));});
          csv+='\n';
        });
      } else {
        csv+='TIME ENTRIES\n'+R(cols);
        ents.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date);}).forEach(function(e){csv+=R(buildEntRow(e,s));});
        csv+='\n';
      }
    }
    if(s.cl&&ST.clients.length){
      csv+='CLIENTS\n'+R(['Name','Email','Phone','Default Rate']);
      ST.clients.forEach(function(c){csv+=R([c.name,c.email||'',c.phone||'',c.rate||'']);});
      csv+='\n';
    }
    if(s.ma&&ST.matters.length){
      csv+='MATTERS\n'+R(['Client','Matter Name','Matter Number','Description','Rate']);
      ST.matters.forEach(function(m){var cl=ST.clients.find(function(c){return c.id==m.clientId;});csv+=R([cl?cl.name:'',m.name,m.matterNumber||'',m.description||'',m.rate||'Client Default']);});
      csv+='\n';
    }
    if(s.co&&ST.contacts.length){
      csv+='CONTACTS\n'+R(['Name','Role','Email','Phone','Rate','Personal Cut %','Annual Salary']);
      ST.contacts.forEach(function(c){csv+=R([c.name,c.role||'',c.email||'',c.phone||'',c.rate||'',c.ownPct!=null?c.ownPct:100,c.salary!=null&&c.salary!==''?c.salary:'']);});
      csv+='\n';
    }
    if(s.su){
      var hrs=ents.reduce(function(s,e){return s+Number(e.hours);},0);
      var bill=ents.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
      csv+='SUMMARY\n'+R(['Total Hours',hrs.toFixed(2)])+R(['Total Billing','$'+bill.toFixed(2)])+R(['Entries',String(ents.length)])+R(['Clients',String(ST.clients.length)])+R(['Matters',String(ST.matters.length)]);
      if(s.expFrom||s.expTo) csv+=R(['Date Range',(s.expFrom||'beginning')+' to '+(s.expTo||'today')]);
      csv+='\n';
    }
    if(s.split){
      var salPeriodLblCsv=salaryPeriodLabel(ST.anFilter)||'All Time';
      csv+='REVENUE SPLIT\n'+R(['Team Member','Personal Cut %','Hours','Total Billed','Own Portion','Firm Portion','Annual Salary','Salary ('+salPeriodLblCsv+')','Net Income (Own - Period Salary)','Status']);
      var userPct=ST.user&&ST.user.ownPct!=null?Number(ST.user.ownPct):100;
      var userSalExp=ST.user&&ST.user.salary!=null&&ST.user.salary!==''?Number(ST.user.salary):null;
      var splitRows=ST.contacts.map(function(c){
        var ces=ents.filter(function(e){return e.contactId==c.id;});
        var chrs=ces.reduce(function(s,e){return s+Number(e.hours);},0);
        var cbill=ces.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
        var pct=c.ownPct!=null?Number(c.ownPct):100;
        var own=cbill*pct/100;
        var annSal=c.salary!=null&&c.salary!==''?Number(c.salary):null;
        var perSal=salaryForPeriod(annSal,ST.anFilter);
        var net=perSal!=null?own-perSal:null;
        return [c.name,pct,chrs.toFixed(2),'$'+cbill.toFixed(2),'$'+own.toFixed(2),'$'+(cbill*(100-pct)/100).toFixed(2),
          annSal!=null?'$'+annSal.toFixed(2):'',
          perSal!=null?'$'+perSal.toFixed(2):'',
          net!=null?'$'+net.toFixed(2):'',
          net!=null?(net>=0?'Bonus':'Shortfall'):''];
      });
      var uEnts=ents.filter(function(e){return !ST.contacts.find(function(c){return c.id==e.contactId;});});
      if(uEnts.length){
        var uH=uEnts.reduce(function(s,e){return s+Number(e.hours);},0);
        var uB=uEnts.reduce(function(s,e){return s+Number(e.hours)*Number(e.rate);},0);
        var uOwn=uB*userPct/100;
        var uPerSal=salaryForPeriod(userSalExp,ST.anFilter);
        var uNet=uPerSal!=null?uOwn-uPerSal:null;
        splitRows.push(['(Unassigned)',userPct,uH.toFixed(2),'$'+uB.toFixed(2),'$'+uOwn.toFixed(2),'$'+(uB*(100-userPct)/100).toFixed(2),
          userSalExp!=null?'$'+userSalExp.toFixed(2):'',
          uPerSal!=null?'$'+uPerSal.toFixed(2):'',
          uNet!=null?'$'+uNet.toFixed(2):'',
          uNet!=null?(uNet>=0?'Bonus':'Shortfall'):'']);
      }
      splitRows.forEach(function(r){csv+=R(r);});
      csv+='\n';
    }
    if(!csv){toast('Nothing selected to export','warn');return;}
    var fname=exportFilename();
    A._dlData(csv, fname, 'text/csv');
    toast('Exported: '+(fname.split('_')[1]||'CSV'));
  },

  // ─ Import helpers ─
  openImport:function(){ ST.modal='importData'; render(); },

  // CSV row parser (handles quoted commas and escaped quotes)
  _parseCSVRow:function(line){
    var vals=[],cur='',inQ=false;
    for(var i=0;i<line.length;i++){
      var ch=line[i];
      if(ch==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
      else if(ch===','&&!inQ){vals.push(cur);cur='';}
      else cur+=ch;
    }
    vals.push(cur);
    return vals;
  },

  // ─ Full JSON backup export ─
  exportJSON:function(){
    var backup={
      _version:1,
      _exported:new Date().toISOString(),
      user:ST.user,
      clients:ST.clients,
      matters:ST.matters,
      entries:ST.entries,
      contacts:ST.contacts,
      prefs:ST.prefs,
      settings:ST.settings,
      descPresets:ST.descPresets,
      mailPresets:ST.mailPresets
    };
    var json=JSON.stringify(backup,null,2);
    var now=new Date();
    var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate())+'_'+pad2(now.getHours())+pad2(now.getMinutes());
    var fname='billing-backup_'+stamp+'.json';
    A._dlData(json, fname, 'application/json');
    toast('Full backup downloaded: '+fname);
  },

  // ─ Full JSON backup import ─
  importJSON:function(inp){
    var file=inp.files[0]; if(!file) return;
    if(!confirm('Restore from backup? This will REPLACE all current data with the backup.\n\nExport a backup first if you want to keep your current data.')) { inp.value=''; return; }
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var b=JSON.parse(ev.target.result);
        if(!b||!b._version){ toast('Invalid backup file','err'); return; }
        if(b.clients)  ST.clients=b.clients;
        if(b.matters)  ST.matters=b.matters;
        if(b.entries)  ST.entries=b.entries;
        if(b.contacts) ST.contacts=b.contacts;
        if(b.user)     ST.user=b.user;
        if(b.prefs)    ST.prefs=Object.assign({appName:'SixMinuteLog.com',darkMode:null,layout:'comfortable'},b.prefs);
        if(b.settings) ST.settings=Object.assign({},ST.settings,b.settings);
        if(b.descPresets) ST.descPresets=b.descPresets;
        if(b.mailPresets) ST.mailPresets=b.mailPresets;
        // After a full restore the in-memory cache is complete
        ST._entriesMode='full'; ST._totalEntryCount=ST.entries.length;
        markLuDirty();
        save(); Store.setMeta('user',ST.user);
        applyPrefs();
        toast('Backup restored: '+ST.clients.length+' clients, '+ST.matters.length+' matters, '+ST.entries.length+' entries');
        ST.modal=null; render();
      }catch(e){ toast('Failed to read backup file','err'); console.error(e); }
    };
    reader.readAsText(file); inp.value='';
  },

  // ─ Per-entity CSV export ─
  exportEntityCSV:function(type){
    var Q=function(v){return '"'+String(v||'').replace(/"/g,'""')+'"';};
    var R=function(a){return a.map(Q).join(',')+'\n';};
    var csv='',fname='';
    var now=new Date();
    var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate())+'_'+pad2(now.getHours())+pad2(now.getMinutes());
    if(type==='clients'){
      csv+=R(['Name','Email','Phone','Default Rate']);
      ST.clients.forEach(function(c){csv+=R([c.name,c.email||'',c.phone||'',c.rate||'']);});
      fname='billing-clients_'+stamp+'.csv';
    } else if(type==='matters'){
      csv+=R(['Client Name','Matter Name','Matter Number','Description','Rate']);
      ST.matters.forEach(function(m){
        var cl=ST.clients.find(function(c){return c.id==m.clientId;});
        csv+=R([cl?cl.name:'',m.name,m.matterNumber||'',m.description||'',m.rate||'']);
      });
      fname='billing-matters_'+stamp+'.csv';
    } else if(type==='entries'){
      csv+=R(['Date','Client Name','Matter Name','Matter Number','ABA Code','Team Member','Description','Hours','Rate','Status','Created By']);
      ST.entries.forEach(function(e){
        var cl=ST.clients.find(function(c){return c.id==e.clientId;});
        var mt=ST.matters.find(function(m){return m.id==e.matterId;});
        var ct=ST.contacts.find(function(c){return c.id==e.contactId;});
        csv+=R([e.date,cl?cl.name:'',mt?mt.name:'',mt?mt.matterNumber||'':'',e.abaCode||'',ct?ct.name:'',e.description||'',e.hours,e.rate,e.status||'approved',e.createdBy||'']);
      });
      fname='billing-entries_'+stamp+'.csv';
    } else if(type==='contacts'){
      csv+=R(['Name','Role','Email','Phone','Rate','Personal Cut %','Annual Salary']);
      ST.contacts.forEach(function(c){csv+=R([c.name,c.role||'',c.email||'',c.phone||'',c.rate||'',c.ownPct!=null?c.ownPct:100,c.salary!=null&&c.salary!==''?c.salary:'']);});
      fname='billing-contacts_'+stamp+'.csv';
    } else if(type==='settings'){
      // Settings exported as simple key-value CSV
      csv+=R(['Setting','Value']);
      csv+=R(['App Name',ST.prefs.appName||'SixMinuteLog.com']);
      csv+=R(['Dark Mode',ST.prefs.darkMode===null?'null':ST.prefs.darkMode?'true':'false']);
      csv+=R(['Layout',ST.prefs.layout||'comfortable']);
      csv+=R(['Description Presets',ST.descPresets.join('|')]);
      fname='billing-settings_'+stamp+'.csv';
    }
    if(!csv){ toast('No data to export','warn'); return; }
    A._dlData(csv, fname, 'text/csv');
    toast('Exported: '+(fname.split('_')[1]||type));
  },

  // ─ Combined CSV import (full multi-section file) ─
  importCSV:function(inp){
    var file=inp.files[0]; if(!file) return;
    var self=A;
    var reader=new FileReader();
    reader.onload=function(ev){
      var lines=ev.target.result.split(/\r?\n/);
      var sec='',nc=[],nm=[],ne=[],nct=[];
      var colMap={};  // track column positions per section
      lines.forEach(function(line){
        var l=line.trim(); if(!l) return;
        if(l.indexOf('TIME ENTRIES')===0){sec='e';colMap={};return;}
        if(l==='CLIENTS'){sec='c';colMap={};return;}
        if(l==='MATTERS'){sec='m';colMap={};return;}
        if(l==='CONTACTS'){sec='ct';colMap={};return;}
        if(l==='SUMMARY'||l==='REVENUE SPLIT'){sec='';return;}
        var v=self._parseCSVRow(l);
        // Header rows - build column map
        if(sec==='e'&&v[0]==='Date'){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(sec==='c'&&v[0]==='Name'){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(sec==='m'&&(v[0]==='Client'||v[0]==='Client Name')){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(sec==='ct'&&v[0]==='Name'){v.forEach(function(h,i){colMap[h]=i;});return;}
        if(!v[0]) return;
        if(sec==='c') nc.push({id:uid(),name:v[0],email:v[1]||'',phone:v[2]||'',rate:v[3]||'',createdBy:'Imported',createdByIni:'?'});
        else if(sec==='ct') nct.push({id:uid(),name:v[0],role:v[1]||'',email:v[2]||'',phone:v[3]||'',rate:v[4]||'',ownPct:v[5]!=null?Number(v[5]):100,salary:v[6]!=null&&v[6]!==''?Number(v[6]):'',createdBy:'Imported',createdByIni:'?'});
        else if(sec==='m'){
          var cName=v[colMap['Client']!=null?colMap['Client']:(colMap['Client Name']!=null?colMap['Client Name']:0)]||'';
          var mnIdx=colMap['Matter Number']!=null?colMap['Matter Number']:-1;
          nm.push({_clientName:cName,name:v[colMap['Matter Name']!=null?colMap['Matter Name']:1]||v[1]||'',matterNumber:mnIdx>=0?(v[mnIdx]||''):'',description:v[colMap['Description']!=null?colMap['Description']:2]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:3]||''});
        }
        else if(sec==='e'){
          var ci=colMap['Client Name']!=null?colMap['Client Name']:(colMap['Client']!=null?colMap['Client']:1);
          var mi=colMap['Matter Name']!=null?colMap['Matter Name']:(colMap['Matter']!=null?colMap['Matter']:2);
          var ti=colMap['Team Member']!=null?colMap['Team Member']:3;
          var di=colMap['Description']!=null?colMap['Description']:4;
          var hi=colMap['Hours']!=null?colMap['Hours']:5;
          var ri=colMap['Rate']!=null?colMap['Rate']:6;
          var sti=colMap['Status']!=null?colMap['Status']:7;
          var bi=colMap['Created By']!=null?colMap['Created By']:8;
          var abai=colMap['ABA Code']!=null?colMap['ABA Code']:-1;
          ne.push({id:uid(),date:v[0],_clientName:v[ci]||'',_matterName:v[mi]||'',_contactName:v[ti]||'',description:v[di]||'',hours:v[hi]||'',rate:v[ri]||'',status:v[sti]||'approved',createdBy:v[bi]||'Imported',createdByIni:'?',abaCode:abai>=0?(v[abai]||''):''});
        }
      });
      // Resolve IDs - use newly imported clients if available, fall back to existing
      var allClients=nc.length?nc:ST.clients;
      var allContacts=nct.length?nct:ST.contacts;
      // Assign IDs to matters
      var resolvedMatters=nm.map(function(m){
        var cl=allClients.find(function(c){return c.name.toLowerCase()===m._clientName.toLowerCase();});
        return {id:uid(),name:m.name,clientId:cl?cl.id:'',matterNumber:m.matterNumber||'',description:m.description,rate:m.rate,createdBy:'Imported',createdByIni:'?'};
      });
      var allMatters=resolvedMatters.length?resolvedMatters:ST.matters;
      // Assign IDs to entries
      var resolvedEntries=ne.map(function(e){
        var cl=allClients.find(function(c){return c.name.toLowerCase()===e._clientName.toLowerCase();});
        var mt=allMatters.find(function(m){return m.name.toLowerCase()===e._matterName.toLowerCase()&&(!cl||m.clientId==cl.id);});
        var ct=allContacts.find(function(c){return c.name.toLowerCase()===e._contactName.toLowerCase();});
        return {id:e.id,date:e.date,clientId:cl?cl.id:'',matterId:mt?mt.id:'',contactId:ct?ct.id:'',description:e.description,hours:e.hours,rate:e.rate,status:e.status,createdBy:e.createdBy,createdByIni:e.createdByIni};
      });
      // Apply results
      if(nc.length) ST.clients=nc;
      if(resolvedMatters.length) ST.matters=resolvedMatters;
      if(resolvedEntries.length) ST.entries=resolvedEntries;
      if(nct.length) ST.contacts=nct;
      ST._entriesMode='full'; ST._totalEntryCount=ST.entries.length; markLuDirty();
      var msg='Imported: '+nc.length+' clients, '+resolvedMatters.length+' matters, '+resolvedEntries.length+' entries, '+nct.length+' contacts';
      save(); toast(msg); ST.modal=null; render();
    };
    reader.readAsText(file); inp.value='';
  },

  // ─ Single-entity CSV import (clients/matters/entries/contacts/settings) ─
  importEntityCSV:function(inp,type){
    var file=inp.files[0]; if(!file) return;
    var self=A;
    var reader=new FileReader();
    reader.onload=function(ev){
      var lines=ev.target.result.split(/\r?\n/);
      var colMap={};
      var parsed=[];
      var isFirst=true;
      lines.forEach(function(line){
        var l=line.trim(); if(!l) return;
        var v=self._parseCSVRow(l);
        if(isFirst){isFirst=false;v.forEach(function(h,i){colMap[h]=i;});return;}
        if(!v[0]) return;
        parsed.push(v);
      });
      if(!parsed.length){ toast('No data rows found in file','warn'); inp.value=''; return; }
      if(type==='clients'){
        var nc=parsed.map(function(v){return {id:uid(),name:v[colMap['Name']!=null?colMap['Name']:0],email:v[colMap['Email']!=null?colMap['Email']:1]||'',phone:v[colMap['Phone']!=null?colMap['Phone']:2]||'',rate:v[colMap['Default Rate']!=null?colMap['Default Rate']:3]||'',createdBy:'Imported',createdByIni:'?'};});
        ST.clients=nc; save(); toast('Imported '+nc.length+' clients'); ST.modal=null; render();
      } else if(type==='matters'){
        var nm=parsed.map(function(v){
          var cName=v[colMap['Client Name']!=null?colMap['Client Name']:(colMap['Client']!=null?colMap['Client']:0)]||'';
          var cl=ST.clients.find(function(c){return c.name.toLowerCase()===cName.toLowerCase();});
          var mnIdx=colMap['Matter Number']!=null?colMap['Matter Number']:-1;
          return {id:uid(),name:v[colMap['Matter Name']!=null?colMap['Matter Name']:1]||'',clientId:cl?cl.id:'',matterNumber:mnIdx>=0?(v[mnIdx]||''):'',description:v[colMap['Description']!=null?colMap['Description']:2]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:3]||'',createdBy:'Imported',createdByIni:'?'};
        }).filter(function(m){return m.name;});
        ST.matters=nm; save(); toast('Imported '+nm.length+' matters'); ST.modal=null; render();
      } else if(type==='entries'){
        var ne=parsed.map(function(v){
          var cName=v[colMap['Client Name']!=null?colMap['Client Name']:(colMap['Client']!=null?colMap['Client']:1)]||'';
          var mName=v[colMap['Matter Name']!=null?colMap['Matter Name']:(colMap['Matter']!=null?colMap['Matter']:2)]||'';
          var tName=v[colMap['Team Member']!=null?colMap['Team Member']:3]||'';
          var cl=ST.clients.find(function(c){return c.name.toLowerCase()===cName.toLowerCase();});
          var mt=ST.matters.find(function(m){return m.name.toLowerCase()===mName.toLowerCase()&&(!cl||m.clientId==cl.id);});
          var ct=ST.contacts.find(function(c){return c.name.toLowerCase()===tName.toLowerCase();});
          return {id:uid(),date:v[0],clientId:cl?cl.id:'',matterId:mt?mt.id:'',contactId:ct?ct.id:'',description:v[colMap['Description']!=null?colMap['Description']:4]||'',hours:v[colMap['Hours']!=null?colMap['Hours']:5]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:6]||'',status:v[colMap['Status']!=null?colMap['Status']:7]||'approved',createdBy:v[colMap['Created By']!=null?colMap['Created By']:8]||'Imported',createdByIni:'?'};
        }).filter(function(e){return e.date;});
        ST.entries=ne; ST._entriesMode='full'; ST._totalEntryCount=ne.length; markLuDirty(); save(); toast('Imported '+ne.length+' entries'); ST.modal=null; render();
      } else if(type==='contacts'){
        var nct=parsed.map(function(v){return {id:uid(),name:v[0],role:v[colMap['Role']!=null?colMap['Role']:1]||'',email:v[colMap['Email']!=null?colMap['Email']:2]||'',phone:v[colMap['Phone']!=null?colMap['Phone']:3]||'',rate:v[colMap['Rate']!=null?colMap['Rate']:4]||'',ownPct:v[colMap['Personal Cut %']!=null?colMap['Personal Cut %']:5]!=null?Number(v[colMap['Personal Cut %']!=null?colMap['Personal Cut %']:5]):100,salary:colMap['Annual Salary']!=null&&v[colMap['Annual Salary']]!=null&&v[colMap['Annual Salary']]!==''?Number(v[colMap['Annual Salary']]):'' ,createdBy:'Imported',createdByIni:'?'};});
        ST.contacts=nct; save(); toast('Imported '+nct.length+' contacts'); ST.modal=null; render();
      } else if(type==='settings'){
        parsed.forEach(function(v){
          var k=v[0],val=v[1]||'';
          if(k==='App Name') ST.prefs.appName=val;
          else if(k==='Dark Mode') ST.prefs.darkMode=(val==='null'?null:(val==='true'));
          else if(k==='Layout') ST.prefs.layout=val;
          else if(k==='Description Presets'&&val) ST.descPresets=val.split('|').filter(Boolean);
        });
        save(); applyPrefs(); toast('Settings imported'); ST.modal=null; render();
      }
    };
    reader.readAsText(file); inp.value='';
  },

  // Download a freshly-generated CLAUDE_BILLING.md with current line numbers
  dlManifest: function(){
    // Scan own script source for // === SECTION markers and their line numbers
    var src = document.querySelector('script').textContent;
    var srcLines = src.split('\n');
    // The script tag starts at some line in the HTML file; find it
    var htmlSrc = document.documentElement.outerHTML;
    var htmlLines = htmlSrc.split('\n');
    var scriptStartLine = 0;
    for(var i=0;i<htmlLines.length;i++){
      if(htmlLines[i].indexOf('<script>')!==-1){scriptStartLine=i+1;break;}
    }
    // Build section map: name -> html line number
    var secMap = {};
    srcLines.forEach(function(line, i){
      var m = line.match(/^\/\/ === ([A-Z][A-Z &]+)$/);
      if(m) secMap[m[1]] = scriptStartLine + i;
    });

    // Descriptions for each section
    var descs = {
      'STORAGE':           'IndexedDB — named object stores per collection. Store.getAll (read), Store.putRecord/deleteRecord (single-record ops), Store.putBatch/syncCollection (bulk), Store.getMeta/setMeta (singletons), Store.clearData (reset)',
      'STATE':             'ST object - all app state',
      'HELPERS':           'uid,today,$m,$h,H,fmtPhone,fmtCur,autoRate,filterEnt,syncForm',
      'SAVE':              'save() debounced full-sync | saveOne(coll,rec) immediate upsert | delOne(coll,id) immediate delete | _flushSave() no-debounce flush',
      'TOAST':             'toast(msg,type)',
      'ICONS':             'IC object of SVG strings',
      'FIELD BUILDER':     'field(label,id,opts), stats(arr)',
      'EXPORT FILENAME GENERATOR':'exportFilename()',
      'VIEWS':             'vTimesheet,vClients,vMatters,vContacts,vAnalytics + form builders',
      'MODALS':            'buildUP,buildQL,buildHelp,buildSettings',
      'MAIN RENDER':       'TABS[], views{}, render()',
      'ACTIONS':           'A object - all user actions',
      'CHANGE DELEGATION': 'document.addEventListener(\'change\',...)',
      'INIT':              'startup data loading, Promise.all'
    };

    var tableRows = Object.keys(descs).map(function(sec){
      var ln = secMap[sec] || '?';
      return '| `// === '+sec+'` | '+ln+' | '+descs[sec]+' |';
    }).join('\n');

    var now = new Date().toISOString().split('T')[0];
    var totalLines = htmlLines.length;

    var md = [
'# SixMinuteLog.com - Claude Architecture Guide',
'> **Claude: Read ONLY this file first. Then `view` specific line ranges in Billing_Tracker.html.**',
'> **Never read the full HTML. Use `str_replace` for all edits.**',
'> Auto-generated: '+now+' | HTML file: ~'+totalLines+' lines',
'',
'---',
'',
'## SECTION MAP (current line numbers in Billing_Tracker.html)',
'',
'| Search String | ~Line | Contents |',
'|---|---|---|',
tableRows,
'',
'---',
'',
'## STATE SHAPE',
'',
'```',
'ST.tab          // active tab: timesheet|clients|matters|contacts|analytics',
'ST.clients[]    // {id,name,email,phone,rate,contactId}',
'ST.matters[]    // {id,name,clientId,description,rate,contactId}',
'ST.entries[]    // {id,date,clientId,matterId,contactId,hours,rate,description,createdBy,createdByIni}',
'ST.contacts[]   // {id,name,role,email,phone,rate,ownPct}',
'ST.user         // {name,initials,ownPct} or null',
'ST.settings     // {te,cl,ma,co,su,split, tc_date/client/matter/team/desc/hours/rate/amount/by, expFrom,expTo,te_group}',
'ST.modal        // null | ef|cf|mf|ctf|ql|up|help|settings | YOUR_KEY',
'ST.editId       // id of record being edited (null = new)',
'ST.ef/cf/mf/ctf/ql  // form state objects, each with .errs{}',
'```',
'',
'---',
'',
'## KEY FUNCTIONS',
'',
'```',
'uid()                              unique numeric ID for new records',
'today()                            YYYY-MM-DD string',
'$m(n) $h(n) $d(s)                 $X.XX  X.XXh  Jan 1, 2025',
'H(str)                             HTML-escape - ALWAYS use on user data in templates',
'g(id)                              get DOM element value by id',
'save()                             bulk debounced sync (imports, settings, approve-all)',
'saveOne(coll, rec)                 immediate single-record upsert — use for form saves',
'delOne(coll, id)                   immediate single-record delete — use for delete actions',
'toast(msg,type)                    type: ok|warn|err',
'syncForm()                         call before render() if user typed in fields',
'autoRate(clientId,matterId,ctId)   returns best available rate',
'fmtCur(val)                        strips non-numeric, 2 decimal max',
'```',
'',
'---',
'',
'## RECIPE: ADD A NEW TAB',
'',
'1. Add SVG to IC object (// === ICONS):',
'   myIcon: \'<svg width="17" height="17" ...>...</svg>\'',
'',
'2. Push to TABS array (// === MAIN RENDER):',
'   {id:\'mytab\', lbl:\'My Tab\', ic:IC.myIcon}',
'',
'3. Add view function before // === MODALS:',
'   function vMyTab(){ return \'<div>...</div>\'; }',
'',
'4. Register in views{} inside render():',
'   var views={..., analytics:vAnalytics, mytab:vMyTab};',
'',
'---',
'',
'## RECIPE: ADD A NEW MODAL',
'',
'1. Add builder (// === MODALS):',
'   function buildMyModal(){',
'     return \'<div class="ov"><div class="modal modal-sm">\'',
'       +\'<div class="modal-hd"><h2>Title</h2>\'',
'       +\'<button class="btn-ic" onclick="A.closeM()">\'+IC.x+\'</button></div>\'',
'       +\'<div class="modal-bd">...field() calls...</div>\'',
'       +\'<div class="modal-ft"><button class="btn btn-gh" onclick="A.closeM()">Cancel</button></div>\'',
'       +\'</div></div>\';',
'   }',
'',
'2. Add to overlays in render() after "else if(ST.modal===\'settings\')":',
'   else if(ST.modal===\'mymodal\') overlays=buildMyModal();',
'',
'3. Add open action to A:',
'   openMyModal: function(){ ST.modal=\'mymodal\'; render(); },',
'',
'---',
'',
'## RECIPE: ADD PERSISTED DATA',
'',
'FOR A COLLECTION (array of objects each with .id):',
'1. Add to ST: myData: []',
'2. Add to _flushSave(): if(_dirty.mydata||_dirty._all) ops.push(Store.syncCollection(\'mydata\', ST.mydata));',
'3. In actions: use saveOne(\'mydata\',rec) for single upserts, delOne(\'mydata\',id) for deletes.',
'   Use save() only for bulk/import operations (triggers full syncCollection).',
'4. Add to INIT Promise.all: Store.getAll(\'mydata\')',
'5. Load in .then(res): try{if(res[N]&&res[N].length)ST.myData=res[N];}catch(e){}',
'   (N = index; current: 0=user(meta), 1=clients, 2=matters, 3=entries, 4=contacts)',
'   Also add \'mydata\' to Store COLLECTIONS list and Store.clearData() call.',
'',
'FOR A SINGLETON (a single object/value):',
'1. Add to _flushSave(): ops.push(Store.setMeta(\'mykey\', ST.myVal));',
'2. Add to INIT Promise.all: Store.getMeta(\'mykey\')',
'3. Load in .then(res): try{if(res[N])ST.myVal=res[N];}catch(e){}',
'',
'---',
'',
'## FIELD BUILDER',
'',
'```',
'field(label, id, { type, val, ph, req, err, hint, pfx, sfx, opts:[{v,l}], dis, oninput })',
'stats([[\'Label\',\'Value\',\'\'],[\'Label\',\'Value\',\'highlight\'],[\'Label\',\'Value\',\'highlight2\']])',
'// \'\' = white  \'highlight\' = green  \'highlight2\' = amber',
'```',
'',
'---',
'',
'## CSS CLASSES',
'',
'```',
'Layout:   .fbox .frow.c2 .frow.c3 .fl .fa .cgrid .card .card-hd .twrap .tscroll',
'Buttons:  .btn .btn-dk .btn-gr .btn-rd .btn-gh .btn-bl .btn-ic',
'Modals:   .ov .modal .modal-sm(480) .modal-md(580) .modal-lg(760) .modal-hd .modal-bd .modal-ft',
'Stats:    .srow .sc .sc-lbl .sc-val',
'Misc:     .chip .badge .split-pill .empty .note(amber) .good(green) .danger(red)',
'```',
'',
'---',
'',
'## COMMON PATTERNS',
'',
'Delete:',
'  if(!confirm(\'Delete?\')) return;',
'  ST.arr = ST.arr.filter(function(x){ return x.id!=id; });',
'  delOne(\'coll\', id); toast(\'Deleted\',\'warn\'); render();',
'',
'Edit (open form):',
'  ST.editId=id; ST.xf=Object.assign({},record,{errs:{}}); ST.modal=\'xf\'; render();',
'',
'Save form:',
'  Read: f.name=g(\'xf-n\'); f.rate=fmtCur(g(\'xf-r\')||\'\');',
'  Validate: set errs{}, if errors{ render(); return; }',
'  Build: rec = {id:ST.editId||uid(), ...fields}',
'  Upsert: ST.editId ? map-replace : concat-push',
'  saveOne(\'coll\', rec); A.closeF();   // immediate atomic write — no data-loss window',
'',
'Bulk save (imports, finalize, approve-all):',
'  // Mutate ST arrays, then call save() — triggers syncCollection on all dirty colls',
'  save(); toast(\'Done\'); render();',
'',
'Dropdown onChange (CHANGE DELEGATION):',
'  syncForm();  // ALWAYS first - preserves typed values',
'  ST.myForm.field = e.target.value;',
'  if(!ST.myForm.rate){ var r=autoRate(...); if(r) ST.myForm.rate=String(r); }',
'  render();',
'',
'---',
'',
'## GOTCHAS',
'',
'1. syncForm() FIRST in every onchange - or typed values are lost on re-render',
'2. H() on ALL user data in template strings',
'3. Only auto-fill rate when empty: if(!ST.ef.rate){ ... }',
'4. Phone: oninput="A.livePhone(\'id\')" - formats in-place, no re-render',
'5. IDs: always uid() for new records',
'6. No external deps - 100% offline, no CDN',
'7. Prefer saveOne/delOne over save() for single-record mutations (atomic, no clear, instant)',
'8. save() is for bulk ops only — still safe (uses syncCollection not clear+putAll)',
'',
'---',
'',
'## USAGE',
'',
'Tell Claude:',
'  "Read CLAUDE_BILLING.md first. Then add [feature] to Billing_Tracker.html."',
'',
'Claude reads this (~3k tokens) instead of the full HTML (~25k tokens).',
'',
'To regenerate this file: open Billing_Tracker.html → Settings (gear) → Download Claude Guide.',
'Line numbers update automatically based on the current file state.',
'',
'---',
'SixMinuteLog.com | Line numbers auto-generated on '+now
    ].join('\n');

    A._dlData(md, 'CLAUDE_BILLING.md', 'text/markdown');
    toast('Claude guide downloaded with live line numbers!');
  },

  // === IT MODE ACTIONS ===
  togITMode: function(on){
    ST.itMode=on;
    if(!ST.firmProfile) ST.firmProfile={firmName:'',appName:ST.prefs.appName||'SixMinuteLog.com',clients:[],matters:[],contacts:[],descPresets:[],users:[],settings:{}};
    save(); render();
  },
  saveITFirm: function(){
    var fn=g('it-firmname').trim();
    var an=g('it-appname').trim();
    if(!ST.firmProfile) ST.firmProfile={};
    ST.firmProfile.firmName=fn;
    ST.firmProfile.appName=an||'SixMinuteLog.com';
    if(an){ ST.prefs.appName=an; savePrefs(); }
    save(); toast('Firm identity saved'); render();
  },
  togITInclude: function(key,val){
    if(!ST.firmProfile) ST.firmProfile={};
    ST.firmProfile[key]=val;
    save(); render();
  },
  openITUser: function(idx){
    if(idx!=null){
      var u=ST.firmProfile.users[idx];
      ST.itf=Object.assign({},u,{editIdx:idx});
    } else {
      ST.itf={name:'',initials:'',role:'attorney',rate:'',ownPct:100};
    }
    ST.modal='ituser'; render();
  },
  editITUser: function(idx){ A.openITUser(idx); },
  delITUser: function(idx){
    if(!confirm('Remove this user from the profile?')) return;
    ST.firmProfile.users.splice(idx,1);
    save(); toast('User removed','warn'); render();
  },
  saveITUser: function(){
    var f=ST.itf||{};
    var name=g('itu-name').trim();
    if(!name){ toast('Name is required','err'); return; }
    var ini=g('itu-ini').trim()||name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,4);
    var role=g('itu-role')||'attorney';
    var rate=fmtCur(g('itu-rate')||'');
    var pct=Number(g('itu-pct')||100);
    var usr={name:name,initials:ini,role:role,rate:rate,ownPct:pct};
    if(!ST.firmProfile) ST.firmProfile={users:[]};
    if(!ST.firmProfile.users) ST.firmProfile.users=[];
    if(f.editIdx!=null){
      ST.firmProfile.users[f.editIdx]=usr;
    } else {
      ST.firmProfile.users.push(usr);
    }
    ST.itf={}; ST.modal='settings'; ST.settingsTab='itadmin';
    save(); toast((f.editIdx!=null?'User updated':'User added')); render();
  },
  closeITUser: function(){
    ST.itf={}; ST.modal='settings'; ST.settingsTab='itadmin'; render();
  },
  exportFirmProfile: function(){
    var fp=ST.firmProfile||{};
    var profile={
      _type:'billing-ledger-firm-profile',
      _version:1,
      firmName:fp.firmName||'',
      appName:fp.appName||ST.prefs.appName||'SixMinuteLog.com',
      users:fp.users||[],
      clients:fp.includeClients?ST.clients:[],
      matters:fp.includeMatters?ST.matters:[],
      contacts:fp.includeContacts?ST.contacts:[],
      descPresets:fp.includePresets?ST.descPresets:[],
      exportedAt:new Date().toISOString()
    };
    var fn=(fp.firmName?fp.firmName.replace(/[^a-z0-9]/gi,'_').toLowerCase():'firm')+'_profile_'+today()+'.json';
    A._dlData(JSON.stringify(profile,null,2),fn,'application/json');
    toast('Firm profile exported: '+fn);
  },
  importFirmProfile: function(inp){
    var file=inp.files[0]; if(!file) return;
    var reader=new FileReader();
    reader.onload=function(ev){
      try{
        var p=JSON.parse(ev.target.result);
        if(!p||p._type!=='billing-ledger-firm-profile'){ toast('Not a valid firm profile file','err'); inp.value=''; return; }
        ST._importedProfile=p;
        // Apply branding immediately
        if(p.appName){ ST.prefs.appName=p.appName; savePrefs(); }
        // If profile has pre-configured users, let user pick one
        if(p.users&&p.users.length>0){
          ST.modal='userSelect';
        } else {
          // Apply data and go to user setup
          A._applyProfileData(p);
          ST._splashMode=true; ST.modal='up';
        }
        inp.value=''; render();
      } catch(e){ toast('Could not read profile file','err'); inp.value=''; }
    };
    reader.readAsText(file);
  },
  _applyProfileData: function(p){
    if(!p) return;
    if(p.clients&&p.clients.length) ST.clients=p.clients;
    if(p.matters&&p.matters.length) ST.matters=p.matters;
    if(p.contacts&&p.contacts.length) ST.contacts=p.contacts;
    if(p.descPresets&&p.descPresets.length) ST.descPresets=p.descPresets;
    save();
    toast('Firm profile applied: '+(p.firmName||p.appName||'Profile'));
  },
  pickITUser: function(idx){
    var p=ST._importedProfile;
    if(!p||!p.users) return;
    var u=p.users[idx];
    // Pre-fill user profile from selected profile user
    ST.user={name:u.name,initials:u.initials||(u.name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,4)),role:u.role||'attorney',rate:u.rate||'',ownPct:u.ownPct!=null?u.ownPct:100};
    Store.setMeta('user',ST.user);
    A._applyProfileData(p);
    ST._importedProfile=null;
    ST._splashMode=false;
    ST.modal=null; render();
    toast('Welcome, '+u.name+' \ud83c\udf89');
  },
  skipProfileImport: function(){
    if(ST._importedProfile){ A._applyProfileData(ST._importedProfile); ST._importedProfile=null; }
    ST._splashMode=true; ST.modal='up'; render();
  },

  // ======== INVOICE ACTIONS ========
  invSetFilter:function(v){ ST.invFilter=v; render(); },

  invNew:function(){
    ST.editId=null;
    // Auto-number: next invoice number
    var nums=(ST.invoices||[]).map(function(i){return parseInt(i.number)||0;}).filter(Boolean);
    var nextNum=nums.length>0?Math.max.apply(null,nums)+1:1001;
    ST.invf={number:String(nextNum),invoiceDate:today(),dueDate:'',status:'draft',clientId:'',matterId:'',
      firmName:ST.firmProfile&&ST.firmProfile.firmName||ST.prefs.appName||'',
      firmAddress:'',firmPhone:'',firmEmail:'',
      paymentTerms:'Net 30',taxPct:'',notes:'',footerNote:'',
      entryIds:[],errs:{}};
    ST.modal='invForm'; render();
  },

  invEdit:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv) return;
    ST.editId=id;
    ST.invf=Object.assign({},inv,{errs:{}});
    ST.modal='invForm'; render();
  },

  invTogEnt:function(eid){
    var f=ST.invf;
    var ids=f.entryIds||[];
    var idx=ids.indexOf(eid);
    if(idx===-1){ f.entryIds=ids.concat([eid]); }
    else { f.entryIds=ids.filter(function(id){return id!==eid;}); }
    render();
  },

  invSave:function(){
    // Sync all fields
    var f=ST.invf;
    f.number=(document.getElementById('inv-num')||{}).value||f.number||'';
    f.invoiceDate=(document.getElementById('inv-date')||{}).value||f.invoiceDate;
    f.dueDate=(document.getElementById('inv-due')||{}).value||'';
    f.status=(document.getElementById('inv-status')||{}).value||'draft';
    f.firmName=(document.getElementById('inv-firm')||{}).value||'';
    f.firmAddress=(document.getElementById('inv-faddr')||{}).value||'';
    f.firmPhone=(document.getElementById('inv-fphone')||{}).value||'';
    f.firmEmail=(document.getElementById('inv-femail')||{}).value||'';
    f.paymentTerms=(document.getElementById('inv-terms')||{}).value||'Net 30';
    f.taxPct=(document.getElementById('inv-tax')||{}).value||'';
    f.notes=(document.getElementById('inv-notes')||{}).value||'';
    f.footerNote=(document.getElementById('inv-footer')||{}).value||'';

    // Sync clientId/matterId from selects
    var clSel=document.getElementById('inv-cl');
    if(clSel) f.clientId=clSel.value;
    var mtSel=document.getElementById('inv-mt');
    if(mtSel) f.matterId=mtSel.value;

    f.errs={};
    if(!f.clientId){ f.errs.clientId='Client is required'; toast('Client is required','err'); render(); return; }

    var now=Date.now();
    var inv=ST.editId
      ?Object.assign({},ST.invoices.find(function(i){return i.id==ST.editId;})||{},f,{id:ST.editId,updatedAt:now})
      :Object.assign({},f,{id:uid(),createdAt:now,updatedAt:now,cuts:{},mergedEntries:[],comments:[]});

    if(ST.editId){
      ST.invoices=ST.invoices.map(function(i){return i.id==ST.editId?inv:i;});
    } else {
      if(!ST.invoices) ST.invoices=[];
      ST.invoices.push(inv);
    }
    saveOne('invoices',inv);
    toast(ST.editId?'Invoice updated':'Invoice created');
    A.closeF();
  },

  invDel:function(id){
    if(!confirm('Delete this invoice?')) return;
    ST.invoices=ST.invoices.filter(function(i){return i.id!=id;});
    delOne('invoices',id); toast('Invoice deleted','warn'); render();
  },

  invPrint:function(id){
    ST.invPrintId=id; ST.modal='invPrint'; render();
  },

  invDoPrint:function(){
    var wrap=document.getElementById('inv-print-wrap');
    if(!wrap){ window.print(); return; }
    var html=wrap.innerHTML;
    var w=window.open('','_blank');
    if(!w){ window.print(); return; }
    w.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Invoice</title>'
      +'<style>body{margin:0;padding:0;font-family:Georgia,serif;color:#222;background:#fff}'
      +'table{width:100%;border-collapse:collapse}'
      +'@page{margin:0.5in}'
      +'@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'
      +'</style></head><body>'+html+'</body></html>');
    w.document.close();
    w.focus();
    setTimeout(function(){ w.print(); },300);
  },

  invOpenReview:function(id){
    var inv=ST.invoices.find(function(i){return i.id==id;});
    if(!inv) return;
    // Initialize review state from saved cuts
    ST.invRev={
      invoiceId:id,
      cuts:Object.assign({},inv.cuts||{}),
      comments:{},
      pendingMerge:[],
      invoiceComment:''
    };
    ST.modal='invReview'; render();
  },

  invRevCut:function(eid,val){
    var rev=ST.invRev;
    var e=ST.entries.find(function(x){return x.id==eid;});
    if(!e) return;
    var h=Math.max(0,Math.min(Number(val)||0,Number(e.hours)));
    rev.cuts[eid]=h;
    // Update the input directly for smooth UX, then re-render totals
    render();
  },

  invRevComment:function(eid,val){
    ST.invRev.comments[eid]=val;
  },

  invRevTogMerge:function(eid){
    var arr=ST.invRev.pendingMerge||[];
    var idx=arr.indexOf(eid);
    if(idx===-1){ ST.invRev.pendingMerge=arr.concat([eid]); }
    else { ST.invRev.pendingMerge=arr.filter(function(id){return id!==eid;}); }
    render();
  },

  invRevCommitMerge:function(){
    var rev=ST.invRev;
    var ids=rev.pendingMerge||[];
    if(ids.length<2){ toast('Select 2+ entries to merge','warn'); return; }
    var descEl=document.getElementById('merge-desc');
    var desc=descEl?descEl.value.trim():'';
    if(!desc){ toast('Enter a description for the merged entry','warn'); return; }
    // Compute merged hours/rate (sum hours, use rate of first entry)
    var totalH=0,rate=0;
    ids.forEach(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;});
      if(!e) return;
      var h=rev.cuts[eid]!=null?Number(rev.cuts[eid]):Number(e.hours);
      totalH+=h;
      if(!rate) rate=Number(e.rate||0);
    });
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    var mg={id:uid(),description:desc,hours:totalH.toFixed(2),rate:rate,entryIds:ids.slice()};
    var newMerged=(inv.mergedEntries||[]).concat([mg]);
    var mergedInv;
    ST.invoices=ST.invoices.map(function(i){if(i.id==rev.invoiceId){mergedInv=Object.assign({},i,{mergedEntries:newMerged});return mergedInv;}return i;});
    if(mergedInv) saveOne('invoices',mergedInv);
    rev.pendingMerge=[];
    toast('Entries merged'); render();
  },

  invRevClearMerge:function(){
    ST.invRev.pendingMerge=[];
    render();
  },

  invRevUnmerge:function(mi){
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return;
    var newMerged=(inv.mergedEntries||[]).filter(function(_,idx){return idx!==mi;});
    var unmergedInv;
    ST.invoices=ST.invoices.map(function(i){if(i.id==rev.invoiceId){unmergedInv=Object.assign({},i,{mergedEntries:newMerged});return unmergedInv;}return i;});
    if(unmergedInv) saveOne('invoices',unmergedInv);
    toast('Unmerged','warn'); render();
  },

  invRevMergeDesc:function(mi,val){
    var inv=ST.invoices.find(function(i){return i.id==ST.invRev.invoiceId;});
    if(!inv||!inv.mergedEntries[mi]) return;
    inv.mergedEntries[mi].description=val;
    saveOne('invoices',inv);
  },

  invRevMergeHours:function(mi,val){
    var inv=ST.invoices.find(function(i){return i.id==ST.invRev.invoiceId;});
    if(!inv||!inv.mergedEntries[mi]) return;
    inv.mergedEntries[mi].hours=String(Math.max(0,Number(val)||0));
    saveOne('invoices',inv); render();
  },

  invRevAddComment:function(){
    var inp=document.getElementById('inv-comment-inp');
    var text=inp?inp.value.trim():'';
    if(!text){ toast('Enter a comment first','warn'); return; }
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return;
    var cmt={id:uid(),by:ST.user?ST.user.name:'Unknown',at:today(),text:text};
    var newComments=(inv.comments||[]).concat([cmt]);
    var commentedInv;
    ST.invoices=ST.invoices.map(function(i){if(i.id==rev.invoiceId){commentedInv=Object.assign({},i,{comments:newComments});return commentedInv;}return i;});
    if(commentedInv) saveOne('invoices',commentedInv);
    toast('Comment added'); render();
  },

  invRevSave:function(andClose){
    var rev=ST.invRev;
    var inv=ST.invoices.find(function(i){return i.id==rev.invoiceId;});
    if(!inv) return false;
    // Apply entry-level comments as invoice comments if any
    var entryComments=Object.keys(rev.comments||{}).filter(function(eid){
      return (rev.comments[eid]||'').trim();
    }).map(function(eid){
      var e=ST.entries.find(function(x){return x.id==eid;});
      return {id:uid(),by:ST.user?ST.user.name:'Reviewer',at:today(),entryId:Number(eid),
        text:'['+$d(e?e.date:'')+'] '+rev.comments[eid],entryRef:true};
    });
    var newComments=(inv.comments||[]).concat(entryComments);
    var savedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==rev.invoiceId){savedInv=Object.assign({},i,{cuts:rev.cuts,comments:newComments,updatedAt:Date.now()});return savedInv;}
      return i;
    });
    if(savedInv) saveOne('invoices',savedInv);
    if(andClose!==false){ toast('Review saved'); A.closeM(); }
    return true;
  },

  invRevApprove:function(){
    // Save cuts/comments without closing, then approve in same pass
    var saved=A.invRevSave(false);
    if(!saved) return;SixMinuteLog.com
    var id=ST.invRev.invoiceId;
    var approvedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){approvedInv=Object.assign({},i,{status:'approved',approvedBy:ST.user?ST.user.name:'',approvedAt:Date.now()});return approvedInv;}
      return i;
    });
    if(approvedInv) saveOne('invoices',approvedInv);
    toast('Invoice approved!','ok');
    ST.modal=null;
    render();
  },

  invRevReject:function(){
    var reason=prompt('Reason for rejection (optional):');
    if(reason===null) return;
    var id=ST.invRev.invoiceId;
    var cmt={id:uid(),by:ST.user?ST.user.name:'Reviewer',at:today(),
      text:'REJECTED'+(reason?' — '+reason:''),type:'rejection'};
    var updatedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){updatedInv=Object.assign({},i,{status:'draft',comments:(i.comments||[]).concat([cmt])});return updatedInv;}
      return i;
    });
    if(updatedInv) saveOne('invoices',updatedInv);
    toast('Invoice returned to draft','warn'); A.closeM();
  },

  invSendForReview:function(id){
    var updatedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){updatedInv=Object.assign({},i,{status:'review',updatedAt:Date.now()});return updatedInv;}
      return i;
    });
    if(updatedInv) saveOne('invoices',updatedInv);
    toast('Invoice sent for partner review','ok'); render();
  },

  invMarkSent:function(id){
    var updatedInv;
    ST.invoices=ST.invoices.map(function(i){
      if(i.id==id){updatedInv=Object.assign({},i,{status:'sent',sentAt:Date.now()});return updatedInv;}
      return i;
    });
    if(updatedInv) saveOne('invoices',updatedInv);
    toast('Invoice marked as sent','ok'); render();
  },

};

function buildEntRow(e,s){
  var cl=ST.clients.find(function(c){return c.id==e.clientId;});
  var mt=ST.matters.find(function(m){return m.id==e.matterId;});
  var ct=ST.contacts.find(function(c){return c.id==e.contactId;});
  var amt=(Number(e.hours)*Number(e.rate)).toFixed(2);
  var vals=[];
  if(s.tc_date)   vals.push(e.date);
  if(s.tc_client) vals.push(cl?cl.name:'');
  if(s.tc_matter) vals.push(mt?mt.name:'General');
  if(s.tc_team)   vals.push(ct?ct.name:'');
  if(s.tc_desc)   vals.push(e.description||'');
  if(s.tc_hours)  vals.push(e.hours);
  if(s.tc_rate)   vals.push(e.rate);
  if(s.tc_amount) vals.push(amt);
  if(s.tc_by)     vals.push(e.createdBy||'');
  return vals;
}

// Timer stop helper
function stopTmr(){
  if(ST.tmrOn){ST.tmrMs+=Date.now()-ST.tmrStart;ST.tmrOn=false;}
  clearInterval(ST.tmrIv);
}

// Value getter
function g(id){var el=document.getElementById(id);return el?el.value:'';}

// ======================================================================
// === WORKFLOW TRANSFER PACKAGES
// ======================================================================
// Transfer packages are versioned JSON files with a _type field indicating
// the workflow step. They carry resolved names (not just IDs) for portability
// across instances, and use smart merge on import (never wipe-replaces).
//
// Package types:
//   'attorney_submission'  Attorney → Billing Staff
//   'billing_review'       Billing Staff → Partner
//   'partner_approval'     Partner → Billing Staff (approved/rejected)
//
// Smart merge rules (importWorkflowPackage):
//   - Clients/matters/contacts: match by name (case-insensitive), add if new
//   - Entries: match by original ID (pkg._entryOrigIds), update status/fields
//     if changed, add if not present. Never delete existing entries.
// ======================================================================

// Build a resolved-names snapshot of entries (for portability across instances)
function _resolveEntries(entries){
  return entries.map(function(e){
    var cl=_lu.cl[e.clientId]||{};
    var mt=_lu.ma[e.matterId]||{};
    var ct=_lu.ct[e.contactId]||{};
    var ma=mt||{};
    return Object.assign({},e,{
      _clientName:cl.name||'',
      _matterName:ma.name||'',
      _matterNumber:ma.matterNumber||'',
      _contactName:ct.name||''
    });
  });
}

// Export a workflow transfer package
// type: 'attorney_submission' | 'billing_review' | 'partner_approval'
// entries: array of entry objects to include (filtered subset)
function _exportWorkflowPackage(type, entries, opts){
  opts=opts||{};
  buildLookups();
  var resolved=_resolveEntries(entries);
  var now=new Date();
  var pad2=function(n){return n<10?'0'+n:String(n);};
  var stamp=now.getFullYear()+'-'+pad2(now.getMonth()+1)+'-'+pad2(now.getDate())+'_'+pad2(now.getHours())+pad2(now.getMinutes());

  // Include only the clients/matters referenced by these entries
  var usedClientIds={};var usedMatterIds={};
  entries.forEach(function(e){
    if(e.clientId) usedClientIds[e.clientId]=true;
    if(e.matterId) usedMatterIds[e.matterId]=true;
  });
  var pkgClients=ST.clients.filter(function(c){return usedClientIds[c.id];});
  var pkgMatters=ST.matters.filter(function(m){return usedMatterIds[m.id];});
  var pkgContacts=[];
  var usedCtIds={};
  entries.forEach(function(e){if(e.contactId) usedCtIds[e.contactId]=true;});
  pkgContacts=ST.contacts.filter(function(c){return usedCtIds[c.id];});

  var typeLabels={
    attorney_submission:'Attorney Timesheet Submission',
    billing_review:'Billing Review Package',
    partner_approval:'Partner Approval Package'
  };
  var pkg={
    _type:type,
    _version:2,
    _label:typeLabels[type]||type,
    _exportedAt:now.toISOString(),
    _fromUser:ST.user?ST.user.name:'Unknown',
    _fromRole:ST.user?ST.user.role:'',
    _fromInitials:ST.user?ST.user.initials:'?',
    _firmName:(ST.firmProfile&&ST.firmProfile.firmName)||ST.prefs.firmName||'',
    _entryCount:entries.length,
    _dateFrom:opts.dateFrom||'',
    _dateTo:opts.dateTo||'',
    _note:opts.note||'',
    clients:pkgClients,
    matters:pkgMatters,
    contacts:pkgContacts,
    entries:resolved
  };
  var json=JSON.stringify(pkg,null,2);
  var shortType={attorney_submission:'atty',billing_review:'bill',partner_approval:'appr'}[type]||type;
  var fname='workflow-'+shortType+'_'+stamp+'.json';
  A._dlData(json, fname, 'application/json');
  return fname;
}

// Smart merge import — merges package data with existing local data
// Returns a summary string for the toast
function _importWorkflowPackage(pkg){
  var added={clients:0,matters:0,contacts:0,entries:0,updated:0};

  // === Merge Clients (by name, case-insensitive) ===
  (pkg.clients||[]).forEach(function(pc){
    var existing=ST.clients.find(function(c){return c.name.toLowerCase()===pc.name.toLowerCase();});
    if(!existing){
      var nc=Object.assign({},pc,{id:uid()});
      ST.clients=ST.clients.concat([nc]);
      saveOne('clients',nc);
      added.clients++;
    }
  });

  // === Merge Matters (by name + client name) ===
  (pkg.matters||[]).forEach(function(pm){
    var cl=ST.clients.find(function(c){return c.name.toLowerCase()===((pm._clientName||pm.clientName||'').toLowerCase());});
    var existing=ST.matters.find(function(m){
      return m.name.toLowerCase()===pm.name.toLowerCase()&&(!cl||m.clientId===(cl?cl.id:m.clientId));
    });
    if(!existing){
      var nm=Object.assign({},pm,{id:uid(),clientId:cl?cl.id:'',matterNumber:pm.matterNumber||pm._matterNumber||''});
      delete nm._clientName;
      ST.matters=ST.matters.concat([nm]);
      saveOne('matters',nm);
      added.matters++;
    } else if(pm.matterNumber&&!existing.matterNumber){
      // Backfill matter number if we learned it from this package
      var updated=Object.assign({},existing,{matterNumber:pm.matterNumber||pm._matterNumber||''});
      ST.matters=ST.matters.map(function(m){return m.id===existing.id?updated:m;});
      saveOne('matters',updated);
    }
  });

  // === Merge Contacts (by name) ===
  (pkg.contacts||[]).forEach(function(pc){
    var existing=ST.contacts.find(function(c){return c.name.toLowerCase()===pc.name.toLowerCase();});
    if(!existing){
      var nc=Object.assign({},pc,{id:uid()});
      ST.contacts=ST.contacts.concat([nc]);
      saveOne('contacts',nc);
      added.contacts++;
    }
  });

  // Rebuild lookups so ID resolution works for entries
  markLuDirty(); buildLookups();

  // === Merge Entries (by original exported ID, then by date+client+desc as fallback) ===
  (pkg.entries||[]).forEach(function(pe){
    // Resolve names → IDs using the now-merged local data
    var cl=ST.clients.find(function(c){return c.name.toLowerCase()===(pe._clientName||'').toLowerCase();});
    var mt=ST.matters.find(function(m){
      return m.name.toLowerCase()===(pe._matterName||'').toLowerCase()&&(!cl||m.clientId===(cl?cl.id:m.clientId));
    });
    var ct=ST.contacts.find(function(c){return c.name.toLowerCase()===(pe._contactName||'').toLowerCase();});
    var clientId=cl?cl.id:(pe.clientId||'');
    var matterId=mt?mt.id:(pe.matterId||'');
    var contactId=ct?ct.id:(pe.contactId||'');

    // Check by original ID
    var existIdx=ST.entries.findIndex(function(e){return String(e.id)===String(pe.id);});
    if(existIdx>=0){
      // Merge: update status, hours, rate, description, abaCode, partnerComment
      var ex=ST.entries[existIdx];
      var mergedFields={
        status:pe.status||ex.status,
        abaCode:pe.abaCode||ex.abaCode||'',
        approvedBy:pe.approvedBy||ex.approvedBy||'',
        approvedAt:pe.approvedAt||ex.approvedAt||'',
        partnerComment:pe.partnerComment||ex.partnerComment||'',
        partnerEdited:pe.partnerEdited||ex.partnerEdited||false,
        showCommentOnInvoice:pe.showCommentOnInvoice||ex.showCommentOnInvoice||false
      };
      // If package is a partner approval, also update hours/rate/description if partner edited
      if(pkg._type==='partner_approval'&&pe.partnerEdited){
        mergedFields.hours=pe.hours;
        mergedFields.rate=pe.rate;
        mergedFields.description=pe.description;
        mergedFields.submittedHours=pe.submittedHours;
      }
      var merged=Object.assign({},ex,mergedFields,{clientId:clientId||ex.clientId,matterId:matterId||ex.matterId,contactId:contactId||ex.contactId});
      ST.entries[existIdx]=merged;
      saveOne('entries',merged);
      added.updated++;
    } else {
      // New entry — add it
      var ne=Object.assign({},pe,{
        id:uid(), // new local ID
        clientId:clientId,
        matterId:matterId,
        contactId:contactId
      });
      delete ne._clientName; delete ne._matterName; delete ne._matterNumber; delete ne._contactName;
      ST.entries=ST.entries.concat([ne]);
      saveOne('entries',ne);
      added.entries++;
    }
  });

  markLuDirty();
  ST._entriesMode='full'; ST._totalEntryCount=ST.entries.length;
  return 'Imported: '+added.clients+' new clients, '+added.matters+' matters, '+added.contacts+' contacts, '+added.entries+' new entries, '+added.updated+' entries updated';
}

// Build modal for previewing a workflow package before importing
function buildWorkflowImportPreview(){
  var pkg=ST._pendingWorkflowPkg;
  if(!pkg) return '';
  var typeColors={attorney_submission:'var(--blue)',billing_review:'var(--amber)',partner_approval:'var(--green)'};
  var typeIcons={attorney_submission:'⚖️',billing_review:'🧾',partner_approval:'✅'};
  var color=typeColors[pkg._type]||'var(--ink2)';
  var icon=typeIcons[pkg._type]||'📦';
  var entryList='';
  if(pkg.entries&&pkg.entries.length<=20){
    entryList='<div style="max-height:220px;overflow-y:auto;border:1px solid var(--brd);border-radius:8px;margin-top:10px">'
      +pkg.entries.map(function(e){
        var st=e.status||'pending';
        var stColor={approved:'var(--green)',pending:'var(--amber)',rejected:'var(--red)'}[st]||'var(--ink3)';
        return '<div style="padding:8px 12px;border-bottom:1px solid var(--brd);font-size:12px;display:flex;justify-content:space-between;align-items:center;gap:10px">'
          +'<div style="flex:1;min-width:0"><strong>'+H(e._clientName||'?')+'</strong>'+(e._matterName?' / '+H(e._matterName):'')
          +(e._matterNumber?' <span style="font-family:monospace;font-size:10px;color:var(--blue)">#'+H(e._matterNumber)+'</span>':'')
          +'<div style="color:var(--ink3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+H(e.description||'—')+(e.abaCode?' <span style="color:var(--blue);font-family:monospace;font-size:10px">'+H(e.abaCode)+'</span>':'')+'</div></div>'
          +'<div style="text-align:right;white-space:nowrap"><strong>'+Number(e.hours||0).toFixed(1)+'h</strong>'
          +'<div style="font-size:11px;color:'+stColor+'">'+H(st)+'</div>'
          +'</div></div>';
      }).join('')
      +'</div>';
  } else if(pkg.entries){
    entryList='<p style="font-size:12px;color:var(--ink3);margin-top:8px">'+pkg.entries.length+' entries (too many to preview individually)</p>';
  }
  return '<div class="ov"><div class="modal modal-md" style="max-height:92vh;display:flex;flex-direction:column">'
    +'<div class="modal-hd"><h2>'+icon+' Review Package &amp; Confirm Import</h2>'
    +'<button class="btn-ic" onclick="A.cancelWorkflowImport()">'+IC.x+'</button></div>'
    +'<div class="modal-bd" style="overflow-y:auto;flex:1">'
    +'<div style="border:2px solid '+color+';border-radius:10px;padding:14px 16px;margin-bottom:14px">'
    +'<div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:'+color+';font-weight:700;margin-bottom:4px">'+H(pkg._label||pkg._type)+'</div>'
    +'<div style="font-size:14px;font-weight:600">From: '+H(pkg._fromUser||'Unknown')+(pkg._fromRole?' <span style="font-size:11px;font-weight:400;color:var(--ink3)">('+H(pkg._fromRole)+')</span>':'')+'</div>'
    +(pkg._firmName?'<div style="font-size:12px;color:var(--ink2);margin-top:2px">'+H(pkg._firmName)+'</div>':'')
    +'<div style="font-size:11px;color:var(--ink3);margin-top:4px">Exported: '+H(new Date(pkg._exportedAt).toLocaleString())+'</div>'
    +(pkg._note?'<div style="margin-top:10px;padding:8px 12px;background:var(--bg2);border-radius:6px;font-size:12px;color:var(--ink2);line-height:1.6"><strong>Note from sender:</strong> '+H(pkg._note)+'</div>':'')
    +'</div>'
    +'<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px">'
    +[['Entries',(pkg.entries||[]).length],['Clients',(pkg.clients||[]).length],['Matters',(pkg.matters||[]).length],['Contacts',(pkg.contacts||[]).length]].map(function(x){
      return '<div style="background:var(--bg);border-radius:8px;padding:10px;text-align:center"><div style="font-size:1.4rem;font-weight:600;color:var(--blue)">'+x[1]+'</div><div style="font-size:11px;color:var(--ink3)">'+x[0]+'</div></div>';
    }).join('')
    +'</div>'
    +(pkg._type==='attorney_submission'?'<div class="note">⚖️ <strong>Attorney Submission:</strong> New entries will be added. Existing entries will have their ABA codes and matter numbers updated. No data will be deleted.</div>':'')
    +(pkg._type==='billing_review'?'<div class="note">🧾 <strong>Billing Review Package:</strong> Contains enriched entries with matter numbers and ABA codes added by billing staff. Existing entries will be updated.</div>':'')
    +(pkg._type==='partner_approval'?'<div class="good">✅ <strong>Partner Approval:</strong> Contains approved/rejected status and any partner edits. Your local entries will be updated with approval decisions.</div>':'')
    +entryList
    +'</div>'
    +'<div class="modal-ft">'
    +'<button class="btn btn-gh" onclick="A.cancelWorkflowImport()">Cancel</button>'
    +'<button class="btn btn-dk" onclick="A.confirmWorkflowImport()">Import Package</button>'
    +'</div></div></div>';
}

// === CHANGE DELEGATION ===
// Sync form state BEFORE any dropdown-triggered re-render so typed values survive
// === CHANGE DELEGATION
document.addEventListener('change',function(e){
  var id=e.target.id;
  // Always sync current form state first
  syncForm();
  if(id==='ef-cl'){
    ST.ef.clientId=e.target.value; ST.ef.matterId='';
    // Only auto-fill rate if the rate field is empty
    if(!ST.ef.rate){var r=autoRate(e.target.value,'',ST.ef.contactId||'');if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='ef-ma'){
    ST.ef.matterId=e.target.value;
    if(!ST.ef.rate){var r=autoRate(ST.ef.clientId||'',e.target.value,ST.ef.contactId||'');if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='ef-ct'){
    ST.ef.contactId=e.target.value;
    if(!ST.ef.rate){var r=autoRate(ST.ef.clientId||'',ST.ef.matterId||'',e.target.value);if(r)ST.ef.rate=String(r);}
    render();
  }
  else if(id==='mf-cl'){
    ST.mf.clientId=e.target.value; ST.mf.linkedClientPeopleIds=[]; render();
  }
  else if(id==='cf-ct'){
    var val=e.target.value;
    if(!val) return;
    syncForm();
    var ids=ST.cf.contactIds||[];
    if(!ids.some(function(x){return x==Number(val);}))ST.cf.contactIds=ids.concat([Number(val)]);
    render();
  }
  // Invoice form: update matter dropdown when client changes
  else if(id==='inv-cl'){
    if(ST.invf) ST.invf.clientId=e.target.value;
    render();
  }
  else if(id==='inv-mt'){
    if(ST.invf) ST.invf.matterId=e.target.value;
    render();
  }
  // Partner review form: checkbox re-render for live highlight
  else if(id==='pref-inv'){
    A.syncPartnerReview();
    render();
  }
});

// Enter key in user prompt
document.addEventListener('keydown',function(e){
  if(e.key==='Enter'&&ST.modal==='up') A.saveUser();
});

// === INIT
(function(){
  // Fast startup: load only current-year entries (covers today/week/month/year filters).
  // "All Time" view and Analytics trigger Store.getAllEntries() on demand.
  var yearStart=new Date().getFullYear()+'-01-01';

  Promise.all([
    Store.getMeta('user'),
    Store.getAll('clients'),
    Store.getAll('matters'),
    Store.getEntriesInRange(yearStart, ''),   // partial load: this year only
    Store.getAll('contacts'),
    Store.getMeta('prefs'),
    Store.getMeta('descpresets'),
    Store.getMeta('mailpresets'),
    Store.getMeta('itmode'),
    Store.getAll('invoices'),
    Store.getMeta('mailplaceholders'),
    Store.countEntries()                       // cheap count — no data transfer
  ]).then(function(res){
    // res values are already parsed native JS objects — no JSON.parse needed
    try{if(res[0])ST.user=res[0];}catch(e){}
    try{if(res[1]&&res[1].length)ST.clients=res[1];}catch(e){}
    // Backfill IDs on existing clientPeople that predate this feature
    ST.clients=ST.clients.map(function(c){
      if(!c.clientPeople||!c.clientPeople.length) return c;
      var needsFix=c.clientPeople.some(function(p){return !p.id;});
      if(!needsFix) return c;
      return Object.assign({},c,{clientPeople:c.clientPeople.map(function(p){return p.id?p:Object.assign({id:uid()},p);})});
    });
    try{if(res[2]&&res[2].length)ST.matters=res[2];}catch(e){}
    // res[3] = partial entries (this year); res[11] = total count from IDB
    try{if(res[3]&&res[3].length)ST.entries=res[3];}catch(e){}
    try{ST._totalEntryCount=Number(res[11])||0;}catch(e){}
    // Mark partial if we didn't load everything
    ST._entriesMode=(ST._totalEntryCount>0&&ST.entries.length<ST._totalEntryCount)?'partial':'full';
    try{if(res[4]&&res[4].length)ST.contacts=res[4];}catch(e){}
    // Ensure the logged-in user appears in contacts
    if(ST.user&&ST.user.name){
      var hasUserCt=ST.contacts.some(function(c){return c.isUser;});
      if(!hasUserCt){
        var ini2=ST.user.initials||ST.user.name.split(' ').map(function(w){return w[0]||'';}).join('').slice(0,3).toUpperCase();
        ST.contacts=ST.contacts.concat([{id:uid(),name:ST.user.name,role:ST.user.role||'',email:ST.user.email||'',phone:ST.user.phone||'',rate:ST.user.rate||'',ownPct:ST.user.ownPct!=null?ST.user.ownPct:100,isUser:true,createdBy:ST.user.name,createdByIni:ini2}]);
      }
    }
    try{if(res[5])ST.prefs=Object.assign({appName:'SixMinuteLog.com',darkMode:null,layout:'comfortable'},res[5]);}catch(e){}
    try{if(res[6])ST.descPresets=res[6];}catch(e){}
    try{if(res[7])ST.mailPresets=res[7];}catch(e){}
    try{if(res[8]){ST.itMode=!!res[8].itMode;if(res[8].firmProfile)ST.firmProfile=res[8].firmProfile;}}catch(e){}
    try{if(res[9]&&res[9].length)ST.invoices=res[9];}catch(e){}
    try{if(res[10]&&res[10].length)ST.mailPlaceholders=res[10];}catch(e){}
    markLuDirty();
    applyPrefs();
    if(!ST.user){
      // First run: show profile import prompt
      ST._splashMode=true; ST.modal='profileImport';
    }
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    render();
  }).catch(function(err){
    console.warn('Init error:',err);
    markLuDirty();
    applyPrefs();
    ST._splashMode=true; ST.modal='profileImport';
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    render();
  });
})();

window.A=A; window.fmtCur=fmtCur;
</script>
</body>
</html>
